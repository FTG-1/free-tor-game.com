<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>C# &#8211; How does persistence fit into a purely functional language &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1073653 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1073653" class="post-1073653 software type-software status-publish hentry category-software tag-architecture tag-c tag-domain-driven-design tag-functional-programming tag-haskell"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">C# &#8211; How does persistence fit into a purely functional language</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">Architecture</span><span class="mr-2 badge badge-info">c</span><span class="mr-2 badge badge-warning">domain-driven-design</span><span class="mr-2 badge badge-primary">functional programming</span><span class="mr-2 badge badge-danger">haskell</span></p><div class="entry-content"><p>How does the pattern of using command handlers to deal with persistence fit into a purely functional language, where we want to make IO-related code as thin as possible?</p><hr/><p>When implementing Domain-Driven Design in an object-oriented language, it&#39;s common to use the <a href="http://en.wikipedia.org/wiki/Command_pattern" rel="noreferrer">Command/Handler pattern</a> to execute state changes. In this design, <em>command handlers</em> sit on top of your domain objects, and are responsible for the boring persistence-related logic like using repositories and publishing domain events. The handlers are the public face of your domain model; application code like the UI calls the handlers when it needs to change domain objects&#39; state.</p><p>A sketch in C#:</p><pre><code>public class DiscardDraftDocumentCommandHandler : CommandHandler&lt;DiscardDraftDocument&gt;
{
    IDraftDocumentRepository _repo;
    IEventPublisher _publisher;

    public DiscardDraftCommandHandler(IDraftDocumentRepository repo, IEventPublisher publisher)
    {
        _repo = repo;
        _publisher = publisher;
    }

    public override void Handle(DiscardDraftDocument command)
    {
        var document = _repo.Get(command.DocumentId);
        document.Discard(command.UserId);
        _publisher.Publish(document.NewEvents);
    }
}
</code></pre><p>The <code>document</code> domain object is responsible for implementing the business rules (like &#34;the user should have permission to discard the document&#34; or &#34;you can&#39;t discard a document that&#39;s already been discarded&#34;) and for generating the domain events we need to publish (<code>document.NewEvents</code> would be an <code>IEnumerable&lt;Event&gt;</code> and would probably contain a <code>DocumentDiscarded</code> event).</p><p>This is a nice design &#8211; it&#39;s easy to extend (you can add new use cases without changing your domain model, by adding new command handlers) and is agnostic as to how objects are persisted (you can easily swap out an NHibernate repository for a Mongo repository, or swap a RabbitMQ publisher for an EventStore publisher) which makes it easy to test using fakes and mocks. It also obeys model/view separation &#8211; the command handler has no idea whether it&#39;s being used by a batch job, a GUI, or a REST API.</p><hr/><p>In a purely-functional language like Haskell, you might model the command handler roughly like this:</p><pre><code>newtype CommandHandler = CommandHandler {handleCommand :: Command -&gt; IO Result)
data Result a = Success a | Failure Reason
type Reason = String

discardDraftDocumentCommandHandler = CommandHandler handle
    where handle (DiscardDraftDocument documentID userID) = do
              document &lt;- loadDocument documentID
              let result = discard document userID :: Result [Event]
              case result of
                   Success events -&gt; publishEvents events &gt;&gt; return result
                   -- in an event-sourced model, there&#39;s no extra step to save the document
                   Failure _ -&gt; return result
          handle _ = return $ Failure &#34;I expected a DiscardDraftDocument command&#34;
</code></pre><p>Here&#39;s the part I&#39;m struggling to understand. Typically, there&#39;ll be some sort of &#39;presentation&#39; code which calls into the command handler, like a GUI or a REST API. So now we have two layers in our program which need to do IO &#8211; the command handler and the view &#8211; which is a big no-no in Haskell.</p><p>As far as I can make out, there are two opposing forces here: one is model/view separation and the other is the need to persist the model. There needs to be IO code to persist the model <em>somewhere</em>, but model/view separation says that we can&#39;t put it in the presentation layer with all the other IO code.</p><p>Of course, in a &#34;normal&#34; language, IO can (and does) happen anywhere. Good design dictates that the different types of IO be kept separate, but the compiler doesn&#39;t enforce it.</p><p>So: how do we reconcile model/view separation with the desire to push IO code to the very edge of the program, when the model needs to be persisted? <em>How do we keep the two different types of IO separate</em>, but still away from all the pure code?</p><hr/><p><strong>Update</strong>: The bounty expires in less than 24 hours. I don&#39;t feel that either of the current answers has addressed my question at all. @Ptharien&#39;s Flame&#39;s comment about <code>acid-state</code> seems promising, but it&#39;s not an answer and it&#39;s lacking in detail. I&#39;d hate for these points to go to waste!</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>The general way to separate components in Haskell is through monad transformer stacks.  I explain this in more detail below.</p><p>Imagine we&#39;re building a system that has several large-scale components:</p><ul><li>a component that talks with the disk or database <strong>(submodel)</strong></li><li>a component that does transformations on our domain <strong>(model)</strong></li><li>a component that interacts with the user <strong>(view)</strong></li><li>a component that describes the connection between view, model, and submodel <strong>(controller)</strong></li><li>a component that kickstarts the whole system <strong>(driver)</strong></li></ul><p>We decide that we need to keep these components loosely coupled in order to maintain good code style.</p><p>Therefore we code each of our components polymorphically, using the various MTL classes to guide us:</p><ul><li>every function in the submodel is of type <code>MonadState DataState m =&gt; Foo -&gt; Bar -&gt; ... -&gt; m Baz</code><ul><li><code>DataState</code> is a pure representation of a snapshot of the state of our database or storage</li></ul></li><li>every function in the model is pure</li><li>every function in the view is of type <code>MonadState UIState m =&gt; Foo -&gt; Bar -&gt; ... -&gt; m Baz</code><ul><li><code>UIState</code> is a pure representation of a snapshot of the state of our user interface</li></ul></li><li>every function in the controller is of type <code>MonadState (DataState, UIState) m =&gt; Foo -&gt; Bar -&gt; ... -&gt; m Baz</code><ul><li>Notice that the controller has access to both the state of the view and the state of the submodel</li></ul></li><li>the driver has only one definition, <code>main :: IO ()</code>,  which does the near-trivial work of combining the other components into one system<ul><li>the view and submodel will need to be lifted into the same state type as the controller using <code>zoom</code> or a similar combinator</li><li>the model is pure, and so can be used without restriction</li><li>in the end, everything lives in (a type compatible with) <code>StateT (DataState, UIState) IO</code>, which is then run with the actual contents of the database or storage to produce <code>IO</code>.</li></ul></li></ul></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../design-command-handling-fail-feedback-with-cqrs/'>Design &#8211; Command handling fail feedback with CQRS</a></li><li class="list-group-item"><a href='../confused-about-commands-domain-events-and-external-events-in-event-sourcing/'>Confused about commands, domain events and external events in event sourcing</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>