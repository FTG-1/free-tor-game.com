<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Should CQRS Command perform a Query &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1069282 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1069282" class="post-1069282 software type-software status-publish hentry category-software tag-cqrs tag-domain-driven-design"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Should CQRS Command perform a Query</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">cqrs</span><span class="mr-2 badge badge-info">domain-driven-design</span></p><div class="entry-content"><p>I have <code>Customer</code>, <code>Order</code>, and <code>Product</code> Aggregate Roots&#8230; When the order is created, it takes in a <code>Customer</code> and a <code>List&lt;Sales.Items&gt;</code>. It looks something like:</p><pre><code>public class Order
{
    public static Order Create(Customer customer, List&lt;Sales.Item&gt; items)
    {
        // Creates the order
        return newOrder;
    }
}
</code></pre><p>Then using CQRS I&#39;ve created <code>OrderCreateHandler</code> which looks something like:</p><pre><code>public class OrderCreateCommandHandler : IRequestHandler&lt;OrderCreateCommand&gt;
{

    public OrderCreateCommandHandler(ECommerceContext db)
    {
        _db = db;
    }

    public async Task&lt;Unit&gt; Handle(OrderCreateCommand request, CancellationToken cancellationToken)
    {
        var customerResult = // Q) Is it okay to execute a CustomerQuery here?

        var customer = new Customer(customerResult.Id, customerResult.FirstName, customerResult.MiddleName,
            customerResult.LastName, customerResult.StreetAddress, customerResult.City, customerResult.State, &#34;United States&#34;,
            customerResult.ZipCode);

         //  blah....

         order = Order.Create(customer, products);
         _db.Orders.Add(order);
     }
}
</code></pre><p>My question is in the command handler, is it okay to perform queries to get the  data to build the aggregate roots I need to then pass? I don&#39;t ever store the aggregate root itself (just a reference if I need), but I don&#39;t want to pass in Ids and primitives everywhere, I want to follow SOLID OO and pass actual objects. Is this a violation of CQRS?</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>Let&#39;s start with a short review of the problem-space here. The fundamental benefit of adopting a CQRS <em>pattern</em> is to solve/simplify your problem domain by reducing the interleaving and leakage that begins to occur when utilizing the same model for your write-side as your read-side. Often, the tension that arises serves as a detriment to both. CQRS seeks to relieve this tension by separating (decoupling logically and possibly physically) the write-side and read-side of your system. With the above in mind it should be clear that neither your commands nor queries should be coupled to a logical entity from the other &#34;side&#34;.</p><p>Given the above, we can now formulate a direct answer to your question: Yes, you can query your data store within a command handler <strong>provided</strong> the query is issued against your command model. Because your <code>OrderCreateCommandHandler</code> is part of the command model of your application, we want to avoid coupling it to any part of your read model. It&#39;s unclear whether or not this is case given the example code (although the name <code>CustomerQuery</code> does raise some suspicions).</p><p>More important than the answer above though is that... there is something else that <em>feels</em> fishy about the example you have provided. Can you feel that too?</p><p>What I see here is quite a bit of coupling. Your handler is retrieving a <code>CustomerResult</code> (VO?), then breaking down all of it&#39;s data into another entity&#39;s constructor (<code>Customer</code>), then passing the <code>Customer</code> to a factory method of yet <em>another</em> entity. We have quite a bit of &#34;asking&#34; happening here. That is, we are passing around a lot of data in way that creates coupling.</p><p>Furthermore, the command handler doesn&#39;t &#34;read&#34; in a very declarative fashion (which is what we want to strive for). What I mean is that it&#39;s kind of hard to &#34;see&#34; what&#39;s happening in your method because there is so much plumbing getting in the way. I think we can come up with a more cohesive/declarative solution.</p><p>Given that the general &#34;flow&#34; of a command handler can be broken down into three simple steps:</p><ol><li>Retrieve all data (domain model) necessary to carryout the use-case</li><li>Coordinate the data to fulfill the use-case</li><li>Persist the data</li></ol><p>Let us see if we can come up with a simpler solution:</p><pre><code>buyer = buyers.Find( cmd.CustomerId );

buyer.PlaceOrder( cmd.Products );

buyers.Save( buyer );
</code></pre><p>Ah ha! Much cleaner (3 simple steps). More importantly though, not only does the code above achieve your same goal, it does so without creating many dependencies between disparate objects as wells as functioning in a more declarative <em>and</em> encapsulated manner (we aren&#39;t &#34;newing&#34; anything or calling any factory methods)! Let&#39;s break this down piece by piece so we can understand &#34;why&#34; the above may be a better solution.</p><p><code>buyer = buyers.Find( cmd.CustomerId );</code></p><p>The first thing I&#39;ve done is introduce a new concept: <code>Buyer</code>. In so doing this, I am partitioning your data <em>vertically</em> according to behavior. Let&#39;s let your <code>Customer</code> entity have responsibility for maintaining <code>Customer</code> information (<code>FirstName</code>, <code>LastName</code>, <code>Email</code>, etc.), and allow a <code>Buyer</code> to be responsible for making purchases. Because some <code>Customer</code> information needs to be recorded when a purchase is made, we will hydrate a <code>Buyer</code> with a &#34;snapshot&#34; of that data (and possibly other data).</p><p><code>buyer.PlaceOrder( cmd.Products );</code></p><p>Next we coordinate the purchase. The above method is where a <code>new Order</code> is created. An <code>Order</code> doesn&#39;t just appear out of nowhere right? <em>Something</em> must place it, so we model accordingly. What does this achieve? Well, the <code>Buyer.PlaceOrder</code> method provides a place <em>in your domain</em> to throw <code>BuyerNotInGoodStanding</code>, <code>OrderExceedsBuyerSpendingLimit</code>, or <code>RepeatOrderDetected</code> exceptions. By only creating an <code>Order</code> in the context of it&#39;s placement, we can enforce how an <code>Order</code> can come about. In your example, either your application-layer command handler or your <code>Order</code> factory method would have to be made responsible for enforcing each invariant. Neither is a good place for checking business rules. Additionally we now have a place to raise our <code>OrderPlaced</code> event (which will be necessary to keep your payment context decoupled), and also we can simplify your <code>Order</code> entity as it now only needs a scalar <code>buyerId</code> to keep reference to it&#39;s owner.</p><p><code>buyers.Save( buyer );</code></p><p>Pretty self-explanatory. A <code>Buyer</code> now contains all of the information you need to persist both an <code>Order</code> and a &#34;snapshot&#34; of <code>Customer</code> data. How you organize that data internally and take it apart for persistence is up to you (hint: A <code>Buyer</code> needn&#39;t be persisted at all, for example. Just the <code>Order</code> it contains).</p><p><strong>EDIT</strong></p><p>The example solution (if we can call it that) that I posted is one meant to get the &#34;gears turning&#34;, and doesn&#39;t <em>necessarily</em> represent the best-possible solution to the problem at hand. That is, <em>your</em> problem. It is totally possible (even likely) that introducing the concept of a <code>Buyer</code> aggregate is over-engineering given that there had been no mention of any sort of rules regarding how an <code>Order</code> can be placed. For example:</p><pre><code>customer = customers.Find( cmd.CustomerId );

order = customer.PlaceOrder( cmd.Products ); // raise OrderPlaced

orders.Save( order );
</code></pre><p>may be a totally valid approach! Just be sure to include all of the necessary information in the <code>CustomerInformationSlip</code> (your &#34;snapshot&#34;) attached to the <code>Order</code> to allow it to enforce any invariant controlling how it can be modified. For example:</p><pre><code>order.ChangeShippingAddress( cmd.Address ); // raise ShippingAddressChanged
</code></pre><p>The above may throw an <code>OrderExceedsCustomerShippingDistance</code> if each <code>Customer</code> has their own rules regarding how far you will ship to them given their account tier.</p><p>Let the rules dictate the design!</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../how-to-avoid-duplication-of-code-related-to-shared-entities-in-the-repository-pattern/'>How to avoid duplication of code related to shared entities in the repository pattern</a></li><li class="list-group-item"><a href='../c-recreating-complex-aggregates-from-a-persistance-source/'>C# &#8211; Recreating complex aggregates from a persistance source</a></li><li class="list-group-item"><a href='../how-exactly-should-a-cqrs-command-be-validated-and-transformed-to-a-domain-object/'>How exactly should a CQRS Command be validated and transformed to a domain object</a></li><li class="list-group-item"><a href='../can-one-aggregate-root-have-multiple-subtypes/'>Can one Aggregate Root have multiple subtypes</a></li><li class="list-group-item"><a href='../cqrs-command-that-needs-to-work-with-multiple-aggregate-roots/'>CQRS command that needs to work with multiple aggregate roots</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>