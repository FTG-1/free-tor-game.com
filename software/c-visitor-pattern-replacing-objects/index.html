<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>C++ &#8211; Visitor Pattern, replacing objects &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1083873 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1083873" class="post-1083873 software type-software status-publish hentry category-software tag-c tag-visitor-pattern"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">C++ &#8211; Visitor Pattern, replacing objects</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">c</span><span class="mr-2 badge badge-info">visitor-pattern</span></p><div class="entry-content"><p>I have a program that translates a DSL to C++, which uses a Visitor pattern on the intermediate representation.</p><p>I quite often need to replace the currently processed node with one of a different type (e.g. replacing the &#34;unresolved type&#34; with the type definition).</p><p>What is a good pattern to do that?</p><p>I&#39;ve tried:</p><ol><li><p>storing a pointer to the place where the current object is referenced from</p><p>This is massively ugly, but keeps a &#34;standard&#34; visitor pattern, where the visitor itself keeps all of its state as member variables, and the <code>visit</code> method does not return a value.</p><p>The difficulty here is that this is fairly error prone &#8212; if I forget to store the pointer before descending in the tree, I may overwrite the wrong reference.</p></li><li><p>returning a replacement object from the visit method</p><p>The next layer up is responsible for replacing the current object with the newly returned object &#8212; deletion is represented by returning a NULL pointer, and no change is represented by returning the old object.</p><p>This is significantly easier to get right, because I can get diagnostics if I accidentally drop a return code, but I think it is still somewhat ugly.</p></li></ol><p>Are there better options?</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>It is just an implementation detail that the <code>visit()</code> method is usually void when described in C++. This is by no means a central part of the visitor Pattern. In the “Design Patterns” book by Gamma, Helm, Johnson, Vlissides, code examples are usually given in C++ and Smalltalk. Smalltalk is a very dynamic language. The example code for the Visitor Pattern in Smalltalk in that book actually returns values! It is a regex evaluator. I&#39;ll translate the code to JavaScript to make it more understandable.</p><blockquote><p>The object structure (regular expressions) is made of four classes, and all of them have an <code>accept()</code> method that takes the visitor as an argument. In class <code>SequenceExpression</code>, the <code>accept</code> method is</p><pre class="lang-js prettyprint-override"><code>function accept(aVisitor) {
  return aVisitor.visitSequence(this);
}
</code></pre><p>[…]</p><p>The ConcreteVisitor class is <code>REMatchingVisitor</code>. […] Its methods […] return the set of streams that the expression would match to identify the current state.</p><pre class="lang-js prettyprint-override"><code>function visitSequence(sequenceExp) {
  this.inputState = sequenceExp.expression1.accept(this);
  return sequenceExp.expression2.accept(this);
}

...

function visitAlternation(alternateExp) {
  var originalState = this.inputState;
  var finalState = alternateExp.alternative1.accept(this);
  this.inputState = originalState;
  finalState.addAll(alternateExp.alternative2.accept(this));
  return finalState;
}

function visitLiteral(literalExp) {
  var finalState = new Set();
  this.inputState.foreach(function (stream) {
    var tStream = stream.copy();
    if (tStream.nextAvailable(literalExp.value.size) == literalExp.value)) {
      finalState.add(tStream);
    }
  });
  return finalState;
}
</code></pre></blockquote><p>So why isn&#39;t this done in C++? Why are all <code>visit()</code> methods void? Because the virtual <code>accept()</code> methods wouldn&#39;t know what to return. Each Visitor may return a different type. While the accept method should just pass that value through, C++ would need the precise type. This can be expressed with templates, but virtual methods can&#39;t be templated methods. (The point of a virtual method is that the implementation only gets resolved at runtime (late binding), whereas templates must be fully evaluated at compile time. Since at compile time it wouldn&#39;t be known which method would be selected, the template wouldn&#39;t be invoked).</p><p>The usual workaround is to store the return value in an instance field of the visitor object. This is awkward, and either requires a default-constructible return value or pointer indirection. While this is semantically equivalent to directly returning a value, this makes using the visitor so awkward that I often create a wrapper function to run the visitor:</p><pre class="lang-js prettyprint-override"><code>class Visitor;

class Base {
public:
  virtual void accept(Visitor&amp;) const = 0;
};

class A;
class B;

class Visitor {
public:
  virtual void visitA(A const&amp;) = 0;
  virtual void visitB(B const&amp;) = 0;
};

class A { … };
class B { … };

class ConcreteVisitor : public Visitor final {
  int mResult;
public:
  ConcreteVisitor() : mResult(0) {}
  void visitA(A const&amp; a) override { mResult = 1; }
  void visitB(B const&amp; a) override { mResult = 2; }
  int result() const { return mResult; }
};

int runConcreteVisitor(Base const&amp; base) {
  ConcreteVisitor v;
  base.accept(v);
  return v.result();
}
</code></pre><p>Each visitor effectively behaves like a (polymorphic) function on the given input hierarchy, or like extension methods. By stuffing additional arguments and return values into member variables, we can model arbitrary function signatures in C++. (Function arguments other than the element to be visited correspond to constructor arguments of the visitor).</p><p>But this is just a workaround. If all your visitors will have an effective signature <code>Expression visitor(Expression const&amp;)</code>, then you can write all your accept methods as</p><pre class="lang-js prettyprint-override"><code> virtual Expression accept(Visitor&amp; v) {
   return v.acceptAddition(*this);
 }
</code></pre><p>For AST operations, this is sometimes all you need. But once you have different “return” types for your visitors, you will need to either duplicate all accept/visit methods for the other type (basically, manual templates), or will have to use the visitor member variable workaround. In that light, it might be sensible to use the workaround from the start. By using <code>runVisitor(…)</code> helpers, this becomes slightly less error prone because you don&#39;t have to remember to retrieve the return value, you are given one directly. If your visitor is recursive, this also means you should avoid unnecessary mutable state directly in your visitor since a new visitor is created for each accept/visit invocation.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../c-is-this-observer-variant-an-improvement/'>C++ &#8211; Is this Observer variant an improvement</a></li><li class="list-group-item"><a href='../c-ast-processing-and-usefulness-of-visitor-pattern/'>C++ &#8211; AST processing and usefulness of visitor pattern</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>