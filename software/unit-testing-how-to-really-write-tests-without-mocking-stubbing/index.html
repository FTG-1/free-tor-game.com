<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Unit-testing &#8211; How to really write tests without mocking/stubbing &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1068226 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1068226" class="post-1068226 software type-software status-publish hentry category-software tag-bdd tag-integration-tests tag-tdd tag-testing tag-unit-testing"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Unit-testing &#8211; How to really write tests without mocking/stubbing</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">bdd</span><span class="mr-2 badge badge-info">integration-tests</span><span class="mr-2 badge badge-warning">tdd</span><span class="mr-2 badge badge-primary">testing</span><span class="mr-2 badge badge-danger">unit testing</span></p><div class="entry-content"><p>I have been using TDD when developing some of my side projects and have been loving it.</p><p>The issue, however, is that stubbing classes for unit tests is a pain and makes you afraid of refactoring.</p><p>I started researching and I see that there is a group of people that advocates for TDD without mocking&#8211;the classicists, if I am not mistaken.</p><p>However, how would I go about writing unit tests for a piece of code that uses one or more dependencies? For instance, if I am testing a <code>UserService</code> class that needs <code>UserRepository</code> (talks to the database) and <code>UserValidator</code> (validates the user), then the only way would be&#8230; to stub them?</p><p>Otherwise, if I use a real <code>UserRepository</code> and <code>UserValidator</code>, wouldn&#39;t that be an integration test and also defeat the purpose of testing <em>only</em> the behavior of <code>UserService</code>?</p><p>Should I be writing only integration tests when there is dependency, and unit tests for pieces of code without any dependency?</p><p>And if so, how would I test the behavior of <code>UserService</code>? (&#34;If <code>UserRepository</code> returns null, then <code>UserService</code> should return false&#34;, etc.)</p><p>Thank you.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>This answer consists of two separate views on the same issue, as this isn&#39;t a &#34;right vs wrong&#34; scenario, but rather a broad spectrum where you can approach it the way it&#39;s most appropriate for your scenario.</p><p>Also note that I&#39;m not focusing on the distinction between a fake, mock and stub. That&#39;s a test implementation detail unrelated to the purpose of your testing strategy.</p><hr/><h2>My company&#39;s view</h2><blockquote><p>Otherwise, if I use a real UserRepository and UserValidator, wouldn&#39;t that be an integration test and also defeat the purpose of testing only the behavior of UserService?</p></blockquote><p>I want to answer this from the point of view of the company I currently work at. This isn&#39;t actually something I agree with, but I understand their reasoning.</p><p>They don&#39;t unit test single classes, instead they test single <strong>layers</strong>. I call that an integration test, but to be honest it&#39;s somewhere in the middle, since it still mocks/stubs classes, just not <em>all</em> of a class&#39; dependencies.</p><p>For example, if <code>UserService</code> (BLL) has a <code>GetUsers</code> method, which:</p><ul><li>Checks with the <code>UserAuthorizationService</code> (BLL) if the current user is allowed to fetch lists of users.<ul><li>The <code>UserAuthorizationService</code> (BLL) in turn depends on the <code>AuthorizationRepository</code> (DAL) to find the configured rights for this user.</li></ul></li><li>Fetches the users from the <code>UserRepository</code> (DAL)</li><li>Check with the <code>UserPrivacyService</code> (BLL) if some of these users have asked to not be included in search results - if they have, they will be filtered out<ul><li>The <code>UserPrivacyService</code> (BLL) in turn depends on the <code>PrivacyRepository</code> (DAL) to find out if a user asked for privacy</li></ul></li></ul><p>This is just a basic example. When unit testing the BLL, my company builds its tests in a way that <strong>all (BLL) objects are real</strong> and all others (DAL in this case) are mocked/stubbed. During a test, they set up particular data states as mocks, and then expect the entirety of the BLL (all references/depended BLL classes, at least) to work together in returning the correct result.</p><p>I didn&#39;t quite agree with this, so I asked around to figure out how they came to that conclusion. There were a few understandable bullet points to that decision:</p><ul><li>The problem domain of the application is liable to constant business refactoring, where the business layer itself may subdivide into more niche classes without changing the public contract. By not testing every BLL class individually, tests need to be rewritten much less often since a test doesn&#39;t need to know the exact dependency graph of the class it&#39;s testing.</li><li>Access logic is very pervasive over the domain, but its implementation and structure changes with the modern times. By not having to rewrite tests whenever the access logic changes, the company intends to lower the threshold for developers being open to innovating the access logic. No one wants to take on a rewrite of &gt;25000 tests.</li><li>Setting up a mocked situation is quite complex (cognitively), and it&#39;s easier for developers to understand how to set the data state (which is just an event store) instead of mocking all manner of complex BLL dependencies who essentially just extract information from that data store in their own unique way.</li><li>Since the interface between the BLL classes is so specific, you often don&#39;t need to know exactly which BLL class failed, since the odds are reasonably big that the contract between the failed class and its dependency (or vice versa) is part of the problem that needs to be adjusted. Almost always, the BLL call stack needs to be investigated in its entirety as some responsibilities may shift due to uncovered bugs (cfr the first bullet point).</li></ul><p>I wanted to add this viewpoint because this company is quite large, and in my opinion is one of the healthiest development environments I&#39;ve encountered (and as a consultant, I&#39;ve encountered many).</p><p>While I still dislike the lack of true unit testing, I do also see that there are few to no problems arising from doing this kind of &#34;layer integration&#34; test for the business logic.</p><p>I can&#39;t delve into the specifics of what kind of software this company writes but suffice it to say that they work a field that is rife with arbitrarily decided business logic (from customers) who are unwilling to change their arbitrary rules even when proven to be wrong. My company&#39;s codebase accommodates a shared code library between tenanted endpoints with wildly different business rules.</p><p>In other words, this is a high pressure, high stakes environment, and the test suite holds up as well as any &#34;true unit test&#34; suite that I&#39;ve encountered.</p><hr/><p>One thing to mention though: the testing fixture of the mocked data store is quite big and bulky. It&#39;s actually quite comfortable to use but it&#39;s custom built so it took some time to get it up and running.<br/> This complicated fixture only started paying dividends when the domain grew large enough that custom-defining stubs/mocks for each individual class unit test would cost more effort than having one admittedly giant <strong>but reusable</strong> fixture with all mocked data stores in it.</p><hr/><h2>My view</h2><blockquote><p>Should I be writing only integration tests when there is dependency, and unit tests for pieces of code without any dependency?</p></blockquote><p>That&#39;s not what separate unit and integration tests. A simple example is this:</p><ul><li>Can Timmy throw a ball when he has one?</li><li>Can Tommy catch a ball when it approaches him?</li></ul><p>These are unit tests. They test a single class&#39; ability to perform a task in the way you expect it to be performed.</p><ul><li>Can Timmy throw a ball to Tommy and have him catch it?</li></ul><p>This is an integration test. It focuses on the interaction between several classes and catches any issues that happen <em>between</em> these classes (in the interaction), not <em>in</em> them.</p><p>So why would we do both? Let&#39;s look at the alternatives:</p><p><strong>If you only do integration tests</strong>, then a test failure doesn&#39;t really tell you much. Suppose our test tells use that Timmy can&#39;t throw a ball at Tommy and have him catch it. There are many possible reason for that:</p><ul><li>Timmy&#39;s arms are broken. (= Timmy is defective)</li><li>Tommy&#39;s arms are broken. (= Tommy is defective)</li><li>The ball cannot travel in a throwing arc, e.g. because it is not inflated. (= Timmy and Tommy are fine but a third dependency is broken)</li></ul><p>But the test doesn&#39;t help you narrow your search down. Therefore, you&#39;re still going to have to go on a bug hunt in multiple classes, and you need to keep track of the interaction between them to understand what is going on and what might be going wrong.</p><p>This is still better than not having any tests, but it&#39;s not as helpful as it could be.</p><p><strong>Suppose we only had unit tests</strong>, then these defective classes would&#39;ve been pointed out to us. For each of the listed reasons, a unit test of that defective class would&#39;ve raised a flag during your test run, giving you the precise information on <em>which</em> class is failing to do its job properly.</p><p>This narrows down your bug hunt significantly. You only have to look in one class, and you don&#39;t even care about their interaction with other classes since the faulty class already can&#39;t satisfy its own public contract.</p><p><strong>However</strong>, I&#39;ve been a bit sneaky here. I&#39;ve only mentioned ways in which the integration test can fail that can be answered better by a unit test. There are also other possible failures that a unit test could never catch:</p><ul><li>Timmy refuses to throw a ball at Tommy because he (quote) &#34;hates his stupid face&#34;. Timmy can (and is willing to) throw balls at anyone else.</li><li>Timmy is in Australia, Tommy is in Canada (= Timmy and Tommy and the ball are fine, but their relative distance is the problem).</li><li>We&#39;re in the middle of a hurricane (= temporary environmental &#34;outage&#34; similar to a network failure)</li></ul><p>In all of these situations, Timmy, Tommy and the ball are all <em>individually</em> operational. Timmy could be the best pitcher in the world, Tommy could be the best catcher.</p><p>But the environment they find themselves in is causing issues. If we don&#39;t have an integration test, we would never catch these issues until we&#39;d encounter them in production, which is the antithesis of TDD.<br/> But without a unit test, we wouldn&#39;t have been able to distinguish individual component failures from environmental failures, which leaves us guessing as to what is actually going wrong.</p><p>So we come to the <strong>final conclusion</strong>:</p><ul><li>Unit tests test uncover issues that render a specific component defective</li><li>Integration tests uncover issues with individually operational components that fail to work together in a particular composition.</li><li>Integration tests can usually catch all of the unit test failures, but it cannot accurately pinpoint the failure, which significantly detracts from the developer&#39;s quality of life.</li><li>When an integration tests fails but all dependent unit tests pass, you know that it&#39;s an environmental issue.</li></ul><hr/><blockquote><p>And if so, how would I test the behavior of UserService? (&#34;If UserRepository returns null, then UserService should return false&#34;)</p></blockquote><p>Be very careful of being overly specific. &#34;returning null&#34; is an implementation detail. Suppose your repository were a networked microservice, then you&#39;d be getting a 404 response, not null.</p><p>What matters is that <strong>the user doesn&#39;t exist in the repository</strong>. How the repository communicates that non-existence to you (null, exception, 404, result class) is irrelevant to describing the purpose of your test.</p><p>Of course, when you mock your repository, you&#39;re going to have to implement its mocked behavior, which requires you to know exactly how to do it (null, exception, 404, result class) but that doesn&#39;t mean that the test&#39;s purpose needs to contain that implementation detail as well.</p><p>In general, you really need to separate the contract from the implementation, and the same principle applies to describing your test versus implementing it.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../unit-testing-does-a-project-using-proper-tdd-have-a-lot-of-code-without-tests/'>Unit-testing &#8211; Does a project using proper TDD have a lot of code without tests</a></li><li class="list-group-item"><a href='../when-should-i-write-integration-tests/'>When should I write integration tests</a></li><li class="list-group-item"><a href='../unit-testing-sense-of-unit-tests-without-tdd/'>Unit-testing &#8211; Sense of unit tests without TDD</a></li><li class="list-group-item"><a href='../unit-testing-are-integration-tests-meant-to-be-redundant/'>Unit-testing &#8211; Are Integration Tests Meant to be Redundant</a></li><li class="list-group-item"><a href='../unit-testing-how-exactly-should-unit-tests-be-written-without-mocking-extensively/'>Unit-testing &#8211; How exactly should unit tests be written without mocking extensively</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>