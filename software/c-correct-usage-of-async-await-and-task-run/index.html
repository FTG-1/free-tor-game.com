<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>C# &#8211; Correct usage of async/await and Task.Run() &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1064710 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1064710" class="post-1064710 software type-software status-publish hentry category-software tag-async tag-asynchronous-programming tag-c tag-concurrency tag-multithreading"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">C# &#8211; Correct usage of async/await and Task.Run()</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">async</span><span class="mr-2 badge badge-info">asynchronous-programming</span><span class="mr-2 badge badge-warning">c</span><span class="mr-2 badge badge-primary">concurrency</span><span class="mr-2 badge badge-danger">multithreading</span></p><div class="entry-content"><p>I am developing an application that will read excel files from disk and then process tests based on the data in the files.  In order to keep the user interface from locking up when loading files and running tests, I have implemented the async/await with Task.Run() to handle the loads and tests running.  Right now I only have one test and three input files, but I want to make sure that this application will scale as the number of files &amp; tests increase. My other concerns are not taking up too much processing power by having too many threads and being able to report the progress of the file loads and tests.  Have I correctly implemented async/await/Task.Run in order to satisfy these concerns?</p><pre><code>private async void ProcessTestsAsync()
        {
            try
            {
                //TestFactory testFact = new TestFactory();

                if (WorkingDirectory != null &amp;&amp; (from f in Files where f.Location == &#34;&#34; select f).FirstOrDefault() == null)
                {
                    // Load Files
                    var loadResults = await LoadFilesAsync();

                    // Run Tests
                    if (loadResults)
                    {
                        var testResults = await RunTestsAsync();
                        if (testResults)
                        {
                            MessageBox.Show(&#34;Success&#34;);
                        }
                        else
                        {
                            MessageBox.Show(&#34;Failure&#34;);
                        }
                    }
                    else
                    {
                        MessageBox.Show(&#34;File Load Failed.  Please check your files and try again.&#34;);
                    }
                }
                else
                {
                    MessageBox.Show(&#34;One or more files has not been selected.  Please choose any missing files and try again.&#34;);
                }
            }
            catch (Exception err)
            {
                MessageBox.Show(&#34;Tests failed.  Please try again.  Error: &#34; + err.Message);
            }
        }

private async Task&lt;bool&gt; RunTestsAsync()
        {
            try
            {
                using (var sem = new SemaphoreSlim(MAX_THREADS))    // Limit the number of threads that can run at a time
                {
                    TestFactory testFact = new TestFactory();
                    var tasks = new List&lt;Task&gt;();

                    foreach (Model.Test test in IncludedTests)
                    {

                        await sem.WaitAsync();
                        tasks.Add(Task.Run(() =&gt;
                        {
                            SortedList&lt;Enums.FileType, DataTable&gt; sources = new SortedList&lt;Enums.FileType, DataTable&gt;();
                            foreach (Enums.FileType fileType in test.ExpectedSources)
                            {
                                sources.Add(fileType, _files[fileType]);
                            }

                            test.Progress = 25;

                            TestBase t = testFact.getTest(test.Type);

                            if (t.SetWorkingDirectory(WorkingDirectory)) 
                            {
                                test.Progress = 50;
                                if (t.SetSources(sources))
                                {
                                    test.Progress = 75;
                                    if (t.RunTest())
                                    {
                                        test.Progress = 100;
                                    }
                                }                                                              
                            }
                            else
                            {
                                MessageBox.Show(&#34;Test Failed.&#34;);
                            }
                        }));                        
                    }
                    await Task.WhenAll(tasks);
                }
                    return true;
            }
            catch (Exception)
            {
                return false;
            }
        }

        private async Task&lt;bool&gt; LoadFilesAsync()
        {
            try
            {
                _files.Clear();
                using (var sem = new SemaphoreSlim(MAX_THREADS))
                {
                    var tasks = new List&lt;Task&gt;();

                    foreach (var file in Files)
                    {
                        await sem.WaitAsync();  // Limit the number of threads that can run at a time
                        tasks.Add(Task.Run(() =&gt;
                        {
                            file.FileLoadStatus = Enums.FileLoadStatus.InProgress;
                            _files.Add(file.Type, file.Source.LoadRecords(file));
                            file.FileLoadStatus = Enums.FileLoadStatus.Completed;
                        }));

                    }

                    await Task.WhenAll(tasks);
                }
                return true;
            }
            catch (Exception)
            {
                return false;
            }            
        }
</code></pre></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>At first glance, I would say the <code>async</code>/<code>await</code> code looks OK.  However, there are a few things to consider.</p><ul><li>Don&#39;t change global or class state in a task.  Have the task be a true function (i.e. does not use or alter global or class state).  Example in <code>LoadFilesAsync()</code></li><li>When the code to run is small enough, the task overhead is worse than just running the code in place (example in <code>LoadFilesAsync()</code>).</li><li>I assume this is temporary, but <code>MessageBox.ShowMessage()</code> isn&#39;t a good idea deep in your tasks (example in <code>RunTestsAsync()</code> when the handling class also does the same thing)</li></ul><p>In your <code>LoadFilesAsync()</code> method I would restructure it like this:</p><pre><code>private async Task&lt;IEnumerable&lt;MyFile&gt;&gt; LoadFilesAsync()
{
    // Multiple tasks clearing state can step on each other&#39;s toes.
    // It&#39;s better to return the set of files and then have the receiver
    // code merge them or do work with it directly.
    List&lt;MyFile&gt; files = new List&lt;MyFile&gt;();

    foreach (var file in Files)
    {
        file.FileLoadStatus = Enums.FileLoadStatus.InProgress;
        // Just await the load here.
        // Since I don&#39;t know the type of your _files object
        // this code won&#39;t compile since List.Add() only takes one argument
        files.Add(file.Type, await file.Source.LoadRecords(file));
        file.FileLoadStatus = Enums.FileLoadStatus.Completed;
    }

    return files;
}
</code></pre></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../c-asyncawait-sync/'>C# &#8211; async+await == sync</a></li><li class="list-group-item"><a href='../c-backgroundworker-vs-async-await/'>C# &#8211; BackgroundWorker vs. Async/Await</a></li><li class="list-group-item"><a href='../c-async-await-pedantry-vs-the-debugger/'>C# async/await: Pedantry vs. the Debugger</a></li><li class="list-group-item"><a href='../c-await-state-async/'>C# &#8211; Await state async</a></li><li class="list-group-item"><a href='../c-http-async-await-task-avoid-flooding-server-with-requests/'>C# &#8211; HTTP Async/Await Task: avoid flooding server with requests</a></li><li class="list-group-item"><a href='../c-who-did-async-await-first/'>C# &#8211; Who did async/await first</a></li><li class="list-group-item"><a href='../c-arent-the-guidelines-of-async-await-usage-in-c-contradicting-the-concepts-of-good-architecture-and-abstraction-layering/'>C# &#8211; Aren&#8217;t the guidelines of async/await usage in C# contradicting the concepts of good architecture and abstraction layering</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>