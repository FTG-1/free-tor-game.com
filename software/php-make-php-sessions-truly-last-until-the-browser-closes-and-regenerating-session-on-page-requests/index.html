<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Php &#8211; Make PHP sessions truly last until the browser closes, and regenerating session on page requests &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1075613 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1075613" class="post-1075613 software type-software status-publish hentry category-software tag-cookies tag-garbage-collection tag-php tag-session"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Php &#8211; Make PHP sessions truly last until the browser closes, and regenerating session on page requests</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">cookies</span><span class="mr-2 badge badge-info">garbage-collection</span><span class="mr-2 badge badge-warning">PHP</span><span class="mr-2 badge badge-primary">session</span></p><div class="entry-content"><p>We have an issue where sessions are ending after a short time, 1440 seconds according to gc_maxlifetime settings which seems consistent with the issue. The PHPSESSID says it will expire when the session ends &#8211; I guess when the browser closes? I suppose before then though the GC is cleaning out expired sessions so the PHPSESSID, which outlives the session on the server, matches no session. Is that right? I guess a new PHPSESSID cookie is issued when the session is re-created?</p><p>Extending the sessiongc.maxlifetime is one option, we need to consider how the live site will handle the additional session data on the server. Moving sessions to Redis is an option here too.</p><p>Alternatively, in addition, is it possible to regenerate the session without losing session data? For example, each time the user opens a page we&#39;ll assume they are still active &#8211; so regenerate the session thus extending it&#39;s lifetime again to the 1440 seconds (or whatever we extend to). So, even if we have a short duration session the session is only destroyed when the user remains inactive (makes no more page loads) for that duration of time &#8211; so if I continue to click every 10 minutes even I&#39;ll never be signed out.</p><p>I&#39;d also like to note we have millions of page views, and a few thousand authenticated users at any given time. So simple extending gc_maxlifetime is something we have to tread carefully with I think.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p><strong>We run an AJAX call on our site which sends a heartbeat to the server once every couple minutes, keeping the session alive as long as the page is open on the browser.</strong> Once the page is closed, the session expires on its own.</p><p>Here&#39;s a snippet of the code I wrote to accomplish this. Please excuse all the cardiac terminology :)</p><pre><code>/**
 * Heartbeat singleton
 */
var Heart = {
    url:         &#39;https://my.domain.tld/EKG&#39;, // server script to hit
    logging:     false, // log to console for debugging
    pulse:       300, // heartbeat interval in seconds
    maxTimeouts: 3, // max timeouts before &#34;heart attack&#34; (stop)
    sessionName: &#39;PHPSESSID&#39;, // session cookie name

    // leave these alone
    timeouts:    0,
    timer:       null,
    sessionId:   null,

    /**
     * Begin heartbeats
     */
    start: function() {
        Heart.getSessionId();
        Heart.timer = setInterval(Heart.beat, Heart.pulse * 1000);
    },

    /**
     * Stop heartbeats
     */
    stop: function() {
        clearInterval(Heart.timer);
    },

    /**
     * Send single heartbeat
     */
    beat: function() {
        $.ajax({
            url:     Heart.url,
            headers: {
                &#39;X-Heartbeat-Session&#39;: Heart.sessionId
            },
            success:  Heart.thump,
            timeout:  Heart.arrhythmia,
            error:    Heart.infarction
        });
    },

    /**
     * Successful heartbeat handler
     */
    thump: function() {
        Heart.log(&#39;thump thump&#39;);
        if (Heart.timeouts &gt; 0)
            Heart.timeouts = 0;
    },

    /**
     * Heartbeat timeout handler
     */
    arrhythmia: function() {
        if (++Heart.timeouts &gt;= Heart.maxTimeouts)
            Heart.infarction();
        else
            Heart.log(&#39;skipped beat&#39;)
                 .beat();
    },

    /**
     * Heartbeat failure handler
     */
    infarction: function() {
        Heart.log(&#39;CODE BLUE!! GET THE CRASH CART!!&#39;)
             .stop();
    },

    /**
     * Log to console if Heart.logging == true
     */
    log: function(msg) {
        if (Heart.logging)
            console.log(msg);

        return Heart;
    },

    /**
     * Parse cookie string and retrieve PHP session ID
     */
    getSessionId: function() {
        var name    = Heart.sessionName + &#39;=&#39;,
            cookies = document.cookie.split(&#39;;&#39;);

        for (var i = 0; i &lt; cookies.length; i++) {
            var cookie = cookies[i];

            while (cookie.charAt(0) == &#39; &#39;)
                cookie = cookie.substr(1);

            if (cookie.indexOf(name) == 0) {
                Heart.sessionId = cookie.substr(name.length, cookie.length);
                break;
            }
        }
    }
};

// Start the heart!
Heart.start();
</code></pre><blockquote><p><strong>NOTE: This script requires jQuery &gt;= 1.5</strong> Also, if the script you&#39;re calling is on a different domain (even a different subdomain)
 then you need to either change the AJAX call to JSONP or add an <code>Access-Control-Allow-Origin: *</code> header to the response. See <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Access_control_CORS" rel="nofollow">HTTP
 access control (CORS)</a> for more info.</p></blockquote></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../php-parallel-requests-and-session-stability/'>PHP Parallel Requests and Session Stability</a></li><li class="list-group-item"><a href='../web-development-user-session-timeout-handling-in-saas-apps-discussing-several-approaches/'>Web-development &#8211; User session timeout handling in SaaS apps &#8211; discussing several approaches</a></li><li class="list-group-item"><a href='../php-set-authenticated-users-session-cookies-to-long-term-but-others-to-short-term/'>Php &#8211; Set authenticated users session cookie&#8217;s to long term, but others to short term</a></li><li class="list-group-item"><a href='../asp-session-between-iframe-and-page/'>ASP session between iframe and page</a></li><li class="list-group-item"><a href='../javascript-managing-session-timeouts-with-regards-to-user-activity-in-the-page/'>Javascript &#8211; Managing session timeouts with regards to user activity in the page</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>