<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Architecture &#8211; How to you make a cluster run a task only once &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1068309 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1068309" class="post-1068309 software type-software status-publish hentry category-software tag-architecture tag-language-agnostic tag-scheduling"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Architecture &#8211; How to you make a cluster run a task only once</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">Architecture</span><span class="mr-2 badge badge-info">language-agnostic</span><span class="mr-2 badge badge-warning">scheduling</span></p><div class="entry-content"><p>If you had a task that you wanted to run only once on a cluster of servers, at a regular interval what would be the best way of achieving this? <em>The definition of cluster in this case is 2 or more identical servers with distributed sessions sitting behind a load balancer.</em></p><p><strong>Use Case:</strong> You have a task that is expensive to run that should only be run once per X hours. This job could for instance iterates over a bunch of records and updates their status.</p><ul><li>Worst case scenario is that having the job run twice invalidates your data.</li><li>Best case scenario is that the job utilises resources on all your servers.</li></ul><p><strong>Requirements Summary:</strong></p><ol><li>The job must still run even if one of the nodes are down.</li><li>The job must only be run once per schedule.</li><li>If multiple jobs are scheduled at the same time or at overlapping times that the number of running jobs is distributed equally between the servers.</li><li>The machines must have the same code base and be synchronised via NTP.</li><li>The configuration may differ between node and node, by environment variables.</li><li>The job has to start on time or within a given interval of the assigned time. (say 5 minutes for example)</li></ol><p><strong>Possible solutions</strong></p><ul><li>Set one node as the master node, this doesn&#39;t work as it violates 1 above.</li><li>Make a request that the load balancer balances to kick off the job. Unfortunatly this has the side effect that if you have multiple jobs running at the same time they may all be run by the same machine.</li></ul><p>This would have to run in Java, in a servlet container. However it isn&#39;t coding the jobs I&#39;m looking for.</p><p>Surely this is a solved problem with known best solution.</p><hr/><p><strong>Related question.</strong><br /> <a href="https://stackoverflow.com/questions/5949038/schedule-job-executes-twice-on-cluster">https://stackoverflow.com/questions/5949038/schedule-job-executes-twice-on-cluster</a></p><p>This isn&#39;t a duplicate as the solution is insufficient as per those 5 requirements given above. The most upvoted solution suffers from a race problem, and the second solution violates requirement 3</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>Do you have a shared database? I&#39;ve done this using a database as the arbiter in the past.</p><p>Basically, each &#34;job&#34; is represented as a row in the database. You schedule a job by adding a row to the database with the time you want it to run then each server does:</p><pre><code>SELECT TOP 1 *
FROM jobs
WHERE state = &#39;NotRun&#39;
ORDER BY run_time ASC
</code></pre><p>That way, they&#39;ll all pick the job that is scheduled to run <em>next</em>. They all sleep so that they wake up when the job is actually supposed to run. Then, they all do this:</p><pre><code>UPDATE jobs
SET state = &#39;Running&#39;
WHERE job_id = :id
  AND state = &#39;NotRun&#39;
</code></pre><p>Where <code>:id</code> is the identifier of the job you got in the step above. Because the update is atomic, only one of the servers will actually update the row, you can check the database&#39;s &#34;number of rows updates&#34; status code to determine whether <em>you</em> were the server that actually updated the row, and therefore whether <em>you</em> are the server that gets to run the job.</p><p>If you didn&#39;t &#34;win&#34; and you&#39;re not running the job, just go back to step 1 immediately. If you did &#34;win&#34;, schedule the job to execute in another thread, then wait a couple of seconds before going back to step 1. That way, servers that didn&#39;t get the job this time are more likely to pick up a job that&#39;s scheduled to run immediately.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../why-is-it-optimal-to-schedule-shorter-jobs-first-on-a-uniprocessor/'>Why is it optimal to schedule shorter jobs first on a uniprocessor</a></li><li class="list-group-item"><a href='../java-what-to-consider-when-designing-a-web-application-that-will-be-deployed-under-a-load-balancer/'>Java &#8211; What to consider when designing a web application that will be deployed under a load balancer</a></li><li class="list-group-item"><a href='../java-converting-cron-schedule-to-time-intervals/'>Java &#8211; Converting cron schedule to time intervals</a></li><li class="list-group-item"><a href='../scheduling-notifications-reminders-for-users/'>Scheduling notifications reminders for users</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>