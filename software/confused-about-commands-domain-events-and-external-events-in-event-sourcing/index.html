<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Confused about commands, domain events and external events in event sourcing &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1076478 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1076478" class="post-1076478 software type-software status-publish hentry category-software tag-aggregate tag-domain-driven-design tag-event-sourcing tag-microservices"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Confused about commands, domain events and external events in event sourcing</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">aggregate</span><span class="mr-2 badge badge-info">domain-driven-design</span><span class="mr-2 badge badge-warning">event-sourcing</span><span class="mr-2 badge badge-primary">microservices</span></p><div class="entry-content"><p>I&#39;m a little confused about</p><ul><li>commands role in event sourcing</li><li>distinction between domain and external events</li></ul><p>If my understanding is right</p><ul><li>a command represents an action initiated by an actor in terms of the domain</li><li>a domain event is an event can be consumed and produced by aggregate roots</li><li>an external event is just like a DTO &#8211; a data contract and it needs to be translated to either a domain event or a command</li></ul><h1>Example</h1><p>I have a <code>Product</code> aggregate root. A product can have multiple active special offers. In order to manage it&#39;s <code>SpecialOffer</code>s, the product accepts 2 domain events:</p><ul><li>SpecialOfferActivated</li><li>SpecialOfferDeactivated</li></ul><p>So it&#39;s public interface is just 2 overloaded <code>Apply</code> methods:</p><pre><code>class Product{
    ...
    Apply(SpecialOfferActivated){...}
    Apply(SpecialOfferDeactivated){...}
}
</code></pre><h1>1st case: The request comes form front-end to the api</h1><p>So a <code>Controller</code> is first in the line. It basically translates caller intention from data contract (DTO) to the domain language (command):</p><pre><code>class ProductController{
    Post(SpecialOfferDto dto){
        ActivateSpecialOfferCommand command = Map(dto)
        _commandBus.Send(command)
    }
}
</code></pre><p>Command sent, now we need a command handler</p><pre><code>class ActivateSpecialOfferCommandHandler{
    Handle(ActivateSpecialOfferCommand command){
        SpecialOfferActivated domainEvent = Map(command)
        _eventBus.Publish(domainEvent)
    }
}
</code></pre><p>Event published, now time for the event handler</p><pre><code>class SpecialOfferActivatedDomainEventHandler{
    Handle(SpecialOfferActivated domainEvent){
        var product = GetFromDatabase()
        product.Apply(domainEvent)
        Save(product)
    }
}
</code></pre><p>Done.</p><h1>2nd case: The process is initiated by an <strong>external</strong> event published to the service bus.</h1><p>This time <code>NewPromotionExternalEvent</code> is the data contract (<code>ExternalEvent</code>) and again we need to translate it to the domain language (<code>Command</code>)</p><pre><code>class NewPromotionExternalEventHandler{
    Handle(NewPromotionExternalEvent extenalEvent){
        ActivateSpecialOfferCommand command = Map(extenalEvent)
        _commandBus.Send(command)
    }
}
</code></pre><p>And then it falls back to the <code>ActivateSpecialOfferCommandHandler</code> from the fist case. So it&#39;s the same case as the first one basically.</p><h1>3rd case: Skip the domain events layer (variation of either the 1st or the 2nd case)</h1><p>So either by an api or an external event a command was produced. We simply create a domain event in order to apply it to the aggregate root. We do <strong>not</strong> publish the event to the service bus.</p><pre><code>class ActivateSpecialOfferCommandHandler{
    Handle(ActivateSpecialOfferCommand command){
        SpecialOfferActivated domainEvent = Map(command)

        var product = GetFromDatabase()
        product.Apply(domainEvent )
        Save(product)
    }
}
</code></pre><p>Done.</p><h1>4th case: Skip the commands layer (variation of the 1st case)</h1><p>We can easily skip the commands layer</p><pre><code>class ProductController{
    Post(SpecialOfferDto dto){
        SpecialOfferActivated domainEvent = Map(dto)
        _eventBus.Publish(domainEvent)
    }
}
</code></pre><p>and fallback to the <code>SpecialOfferActivatedDomainEventHandler</code></p><h1>5th case: Aggregate root creation.</h1><p>So either by an api or an external event a command <code>CreateNewProductCommand</code> was produced. And we need another handler:</p><pre><code>CreateNewProductCommandHandler{
    Handle(CreateNewProductCommand command){
        var product = Map(command)
        SaveToDatabase(product)

        NewProductCreated domainEvent = Map(product)
        _eventBus.Publish(domainEvent) // in case somebody is interested
    }
}
</code></pre><p>In this case there&#39;s really no place to stick the domain events layer.</p><h1>6th case: Domain event produced by Product (aggregate root)</h1><pre><code>class Product{
    Apply(SpecialOfferActivated domainEvent){
        var specialOffer = Map(domainEvent)
        _specialOffers.Add(specialOffer)
        if(...){
            // For simplicity sake, assume the aggregate root can access _eventBus
            _eventBus.Publish(new ProductReceivedTooManySpromotionsDomainEvent(this.Id))
        }
    }
}
</code></pre><h1>Questions</h1><ol><li>The events layer is cool, it allows us to distribute jobs across multiple instances or other microservices. However, what&#39;s the point of the command layer? I could easily produce domain events right away (in a controller or external an event handler &#8211; 4th case).</li><li>Is 3rd case legit (create a domain event just to apply it to the aggregate root, without publishing it)?</li><li>Does command layer only make sense in 5th case where it gives us the benefit of delegating product creation to another microservice while domain events layer is not applicable?</li><li>Where is the line between external and domain events? Is <code>NewPromotionExternalEvent</code> from the 2nd really an external event or is it rather a domain event?</li><li>Who can produce <strong>domain</strong> events? Aggregate root? Command handler? Domain event handler? External event handler? Another microservice? All of them?</li><li>Can <strong>domain</strong> events be dispatched to another micro-service or would it become an <strong>external</strong> event then?</li><li>What is the proper way of handling <strong>product creation</strong> and <strong>special offer activation</strong> when it the request comes form <strong>controller</strong> or <strong>external event</strong>?</li></ol></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><blockquote><p>I&#39;m a little confused about</p></blockquote><p>That&#39;s not your fault.  The literature sucks.</p><p>What people are really talking about is the way that information flows around our &#34;domain model&#34;.</p><ul><li>Commands carry new information <em>toward</em> our domain model</li><li>&#34;Domain Events&#34; describe changes to the state of the model</li><li>&#34;External events&#34; carry information <em>away</em> from the model.</li></ul><p>The first and last of these are really about <em>messaging</em>.</p><p>But the spelling &#34;domain events&#34; is kind of a mess - they are both floor wax and dessert topping.  Within the context of &#34;event sourcing&#34;, they are really about <em>persistence</em>.  However, the phrase &#34;domain events&#34; are also used to describe messages used to share information between aggregates in the same model.</p><blockquote><p>what&#39;s the point of the command layer?</p></blockquote><p>Mostly, it gives you a way to decouple application concerns (ensuring the message is delivered to the correct aggregate, dealing with transactions), from controller concerns.  It also gives you an easy way to apply certain cross cutting concerns (timing, for example) before the domain model goes to work.</p><blockquote><p>create a domain event just to apply it to the aggregate root, without publishing it</p></blockquote><p>Yes, but I would spell it somewhat differently - we don&#39;t normally <em>create</em> events outside of the aggregate; the aggregate owns the business logic that determines how it changes state (as opposed to being a dumb bag of data).  But it is perfectly normal for an aggregate to change state without notifying the world that it happened.</p><blockquote><p>Where is the line between external and domain events?</p></blockquote><p>&#34;External events&#34; are usually a lot thinner than domain events - we don&#39;t usually want to be sharing the private information of a service everywhere, in much the same way that we don&#39;t normally make all of our internal implementation details public.  Also, external events are part of the contract between services - the strategies for changing that contract need to satisfy more stake holders.  But data maintained within a single service is less expensive to change.</p><blockquote><p>Who can produce domain events?</p></blockquote><p>Aggregate root.  In theory, also other entities contained within the same aggregate.</p><blockquote><p>What is the proper way of handling product creation and special offer activation when it the request comes form controller or external event?</p></blockquote><p>Information coming in -&gt; you load the appropriate part of the domain model into memory, and pass the information to it so that the changes can be calculated.</p><blockquote><p>If Aggregate root is the only one producing domain events, we&#39;ve got a problem. The only way interact with an aggregate (and let it produce its own domain events) is by applying a domain event to it.</p></blockquote><p>Normally, the way you interact with an aggregate root is by transmitting information to it via a <em>command</em>.</p><p>For instance, take a look at <a href="https://github.com/citerus/dddsample-core" rel="nofollow noreferrer">the DDD sample app</a>.  In particular, pay attention to how little business logic is done by <a href="https://github.com/citerus/dddsample-core/blob/master/src/main/java/se/citerus/dddsample/application/impl/BookingServiceImpl.java#L65" rel="nofollow noreferrer">the application layer</a> vs the domain model (<a href="https://github.com/citerus/dddsample-core/blob/master/src/main/java/se/citerus/dddsample/domain/model/cargo/Cargo.java#L124" rel="nofollow noreferrer">here</a> and <a href="https://github.com/citerus/dddsample-core/blob/master/src/main/java/se/citerus/dddsample/domain/model/cargo/Delivery.java#L79" rel="nofollow noreferrer">here</a>).</p><blockquote><p>Also you mentioned that domain events are useful to talk to other aggregates within the same domain model. I would say, a domain model is not restricted to a single microservice.</p></blockquote><p>Historically, domain events were being used to talk to other aggregates <em>participating in the same transaction</em>.  It follows that if they are participating in the same transaction, they are part of the same microservice.</p><p>Sharing information across transaction boundaries has different design considerations from sharing information within a transaction.</p><p>I think these days you are a lot more likely to hear that people are aligning their microservice boundaries with their bounded contexts, which means that the models are not shared (which should make sense -- part of the point of microservices is that they should be able to evolve independently).</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../cqrs-event-sourcing-is-it-correct-that-commands-are-generally-communicated-point-to-point-while-domain-events-are-communicated-through-pub-sub/'>CQRS + Event Sourcing: (is it correct that) Commands are generally communicated point-to-point, while Domain Events are communicated through pub/sub</a></li><li class="list-group-item"><a href='../inheritance-commands-and-event-sourcing/'>Inheritance, commands and event sourcing</a></li><li class="list-group-item"><a href='../rest-event-sourcing-and-rest/'>Rest &#8211; Event sourcing and REST</a></li><li class="list-group-item"><a href='../can-an-aggregate-only-ever-consume-commands-and-produce-events/'>Can an aggregate only ever consume commands and produce events</a></li><li class="list-group-item"><a href='../domain-events-cqrs-and-dependency-resolution-in-handlers/'>Domain Events, CQRS, and dependency resolution in handlers</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>