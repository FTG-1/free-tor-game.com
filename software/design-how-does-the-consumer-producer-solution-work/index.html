<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Design &#8211; How does the consumer-producer solution work &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1084280 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1084280" class="post-1084280 software type-software status-publish hentry category-software tag-design tag-design-patterns tag-multithreading tag-ruby"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Design &#8211; How does the consumer-producer solution work</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">design</span><span class="mr-2 badge badge-info">design-patterns</span><span class="mr-2 badge badge-warning">multithreading</span><span class="mr-2 badge badge-primary">ruby</span></p><div class="entry-content"><p>I&#39;m only a beginner, and my book doesn&#39;t cover this subject. I have researched my problem and found that an implementation of the consumer-producer pattern is the ideal solution, and have Googled it, read what I could, tried to enact examples&#8230; but haven&#39;t been lucky. I would really appreciate a bit of guidance.</p><p>I am writing in Ruby, if that makes a difference.</p><h3>Background</h3><p>I am writing a script that scrobbles my music library backlog to Last.FM. For anyone who isn&#39;t familiar with that service, that simply means that I am making lots of POST requests to a HTTP API.</p><p>I start with an array, each element is a hash/dictionary like <code>{artist: &#34;The Cure&#34;, track: &#34;Siamese Twins&#34;}</code>. I make the calls by iterating over the array and issuing the simple method call <code>lastfm.track.scrobble artist: song[:artist], track: song[:track]</code>.</p><h3>Problem</h3><p>Doing this in a straightforward one-at-a-time blocking style works perfectly, but is very very slow, because I&#39;m waiting ~2 seconds for each HTTP request to travel the world and return. I could finish 5 times faster if I sent 5 HTTP requests simultaneously.</p><p>I asked on Stack Overflow what the best solution would be. Split the array into five parts, and give part a thread running one request at a time? Something like JavaScript&#39;s <code>XMLHttpRequest</code> which has an event loop and a callback function? They told me that this qusetion would be better suited to Programmers SE, and that I probably want the consumer-producer pattern. I looked it up, and it does sound like the kind of thing I need.</p><h3>My Attempt in Ruby, based off a StackOverflow post</h3><pre><code># &#34;lastfm&#34; is an object representing my Last.FM profile, 
# its .track.scrobble method handles a POST request and waits until it returns
# &#34;songs&#34; is an array of hashes like {artist: &#34;The Cure&#34;, track: &#34;One Hundred Years&#34;}

queue = SizedQueue.new(10) # this will only allow 10 items on the queue at once

p1 = Thread.new do 
  songs.each do |song|
      scrobble = lastfm.track.scrobble artist: song[:artist], track: song[:track]
      puts &#34;Scrobbled #{song[:track]} by #{song[:artist]}.&#34;
      queue &lt;&lt; scrobble
  end
  queue &lt;&lt; &#34;done&#34;
end

consumer = Thread.new do
  blocker = queue.pop(true) # don&#39;t block when zero items are in queue
  Thread.exit if blocker == &#34;done&#34;
  process(blocker)
end

# wait for the consumer to finish
consumer.join
</code></pre><h3>My Error</h3><p>Failure on the &#34;pop&#34; method call with error &#34;queue empty&#34;.</p><p>I don&#39;t know enough about this stuff to really understand what&#39;s happening. It looks like one thread is filling a queue with API calls to make, never more than 10 at a time, while another thread is consuming from that queue and performing them. But why pop? Where is it ever actually executed? Why am I appending &#34;done&#34; to the queue?</p><p>I&#39;m concerned about the line <code>scrobble = lastfm.track.scrobble artist: song[:artist], track: song[:track]</code>. Won&#39;t this call the lastfm.track.scrobble method outright, and store its return value as <code>scrobble</code>? Should I be using a proc or lambda instead, and calling that proc/lambda in the consumer?</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>The answer by scriptin is giving a reasonable solution, but doesn&#39;t answer your questions about the failure of the implementation you had.</p><ul><li>You get a &#39;queue empty&#39; error when you call <code>pop</code> on a Ruby queue in non-blocking mode (<code>true</code> passed) and there are no items on the queue.</li><li>Your &#34;producer&#34; thread is created and your &#34;consumer&#34; thread is created, but they&#39;ll run independently and start executing whenever Ruby feels like it.</li><li>If your &#34;consumer&#34; runs before the &#34;producer&#34; has pushed anything onto the queue, then obviously the &#34;consumer&#34; will pop an empty queue and throw an exception.</li></ul><p>The solution to this one is easy; the consumer shouldn&#39;t use non-blocking mode. Don&#39;t pass <code>true</code>, just call <code>pop()</code>. The <em>whole point</em> of the consumer thread is that it can block on a queue waiting for the producer, without the rest of the application halting.</p><p>As for calling <code>lastfm.track.scrobble</code> - yes, this is executing that method immediately and pushing the <em>result</em> on the queue, which is exactly not what you want :-D and is in fact the reason why &#34;reliably&#34; your consumer thread gets to pop its queue before the producer ever has a chance to push anything (even if the producer thread runs first, it hits a slow &#39;scrobble&#39; call and sits waiting for HTTP requests/responses to complete; so the consumer thread executes and tries to read from the empty queue).</p><p>You want to push the <em>parameters</em> to <code>scrobble</code> onto the queue, then have the consumer thread do the scrobbling. It&#39;s &#34;nicer&#34;/more structured to make little classes encapsulating the work and push instances of those onto your queue, but a cheap-and-nasty solution just uses the Hash which <code>scrobble</code> takes as input. We also need to remember to <em>loop over the queue entries</em> inside the consumer, instead of only processing one! Thus (<em>UNTESTED</em>) we might have:</p><pre><code>queue = SizedQueue.new(10)

Thread.new do 
  songs.each do |song|
      queue &lt;&lt; { artist: song[:artist], track: song[:track] }
  end
  queue &lt;&lt; &#34;done&#34;
end

consumer = Thread.new do
  loop do
    scrobble_args = queue.pop()
    Thread.exit if scrobble_args == &#34;done&#34;
    lastfm.track.scrobble(scrobble_args)
    puts &#34;Scrobbled #{scrobble_args[:track] by scrobble_args[:artist]}.&#34;
  end
end

consumer.join
</code></pre><p>This should technically <em>work</em> but is totally pointless, because that one lonely consumer thread is just processing the queue in serial. So let&#39;s simplify this. Really, you just want to dump all of &#39;songs&#39; into the queue and have the consumer thread do the work. Since we want to run in parallel, we&#39;ll make an array of threads.</p><pre><code># I&#39;m not bothering with the producer thread here so the queue size is unlimited.
# You could just as well put the &#39;songs.each&#39; inside a producer thread with a
# a sized queue, as per your original code, if you wanted.
#
queue = Queue.new
songs.each do | song |
  queue &lt;&lt; song
end

consumers = []

1.upto( 10 ) do
  consumers &lt;&lt; Thread.new do

    # Keep looping until asked to exit
    #
    loop do
      song = queue.pop()
      Thread.exit if song == &#39;done&#39;
      lastfm.track.scrobble( artist: song[ :artist ], track: song[ :track ] )
      puts &#34;Scrobbled #{ song[ :track ] } by #{ song[ :artist ] }.&#34;
    end
  end

  # Push one &#39;done&#39; exit instruction for each consumer
  #
  queue &lt;&lt; &#39;done&#39;
end

# Wait for all consumer threads to complete
#
consumers.each do | consumer |
  consumer.join()
end
</code></pre><p>...and that should do the trick. The &#34;Parallel&#34; gem will probably be doing much the same sort of thing under the hood.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../producer-consumer-pattern-with-consumer-restrictions/'>Producer-consumer pattern with consumer restrictions</a></li><li class="list-group-item"><a href='../timers-with-threads-on-queue/'>Timers with threads on queue</a></li><li class="list-group-item"><a href='../java-threaded-batching-algorithm/'>Java &#8211; Threaded batching algorithm</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>