<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Implementing naive register allocation for x86 machines &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1086922 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1086922" class="post-1086922 software type-software status-publish hentry category-software tag-compiler"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Implementing naive register allocation for x86 machines</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">compiler</span></p><div class="entry-content"><p>I&#39;m writing a toy compiler targeting on <code>x86-64</code> machines. But I confront several problems when implementing register allocation with linear intermediate representation. I use NASM and GCC to generating executable file.</p><p>In intermediate representation of the origin code, we assume there are infinite registers(memory is regarded as a kind of virtual register). I divided them into two types:</p><ul><li><p>Single registers: This kind of virtual register represent a typical variable.</p></li><li><p>Offset registers: This kind of virtual register is used to represent the access to an element of an array or a member of a struct. For example, when translating instructions such like <code>a.x = 3</code> and <code>b[i] = 3</code> into intermediate representation, we may represent it as <code>mov [$a + 0], 3</code> and <code>mov [$b + $i * 4], 3</code>(<code>4</code> is the size of an integer), where <code>$a</code>, <code>$b</code> and <code>$i</code> are single registers and <code>[$a + 0]</code> and <code>[$b + $i * 4]</code> are offset registers.</p></li></ul><p>However, in <code>x86-64</code> machine, memory access can only be represented as <code>[$reg1 + $reg2 * imm1 + imm2]</code>, where <code>$reg1</code> and <code>$reg2</code> are physical registers and <code>imm1</code> and <code>imm2</code> are immediate number. I cannot understand how register allocation algorithms deal with the case that the algorithm marks <code>$va</code> and <code>$vb</code> as spilled node with instruction <code>mov [$va + $vb * 4], 3</code>. In other words, <code>$va</code> and <code>$vb</code> must be a physical register rather than memory access, but if a virtual register is marked as spilled node, it will be regarded as a memory access to the stack frame.</p><p>For example, I get the following origin C-like code:</p><pre><code>int main() {
    int [] a = new int[10];
    int i = 3;
    a[i] = 4;
}
</code></pre><p>And I translate it into following intermediate representation:</p><pre><code>call malloc, 10
mov $a, $retval       ; $retval is the return value of malloc
mov $i, 3
mov [$a + $i * 4], 4
</code></pre><p>However, after I have allocated registers, I find the final code becomes:</p><pre><code>push rbp
mov rbp, rsp
sub rsp, 16
mov rdi, 10
call malloc
mov qword [rbp-8], rax
mov qword [rbp-16], 3
mov [qword [rbp-8] + qword [rbp-16] * 4], 3  &lt;- Compliation error occurs here
</code></pre><p>I wonder if there is a nice implementation to solve this problem. Thanks in advance.</p><p><strong>UPD:</strong> Basile-Starynkevitch gave me a paper showing how GCC solve this problem. And I&#39;m looking for some (probably) simpler methods.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>The primary problem with your approach is that by lowering your code to the level of assembly instructions <em>before</em> you&#39;ve allocated values to registers, you lose the ability to vary the assembly you need to produce on the basis of where a value needs to come from.  If, however, you defined a more abstract representation that could then be translated down to assembly language after register allocation, that would make matters easier.</p><p>Consider a toy expression-calculation language, and the expression <code>a + 2*b + c[a+d]</code>.  This might be reduced to an intermediate representation that looks something like this:</p><pre><code>v1 &lt;= int32[a]       ; meaning: load the 32-bit int value at address &#34;a&#34;
v2 &lt;= int32[b]
v3 &lt;= 2*v2  (~v2)    ; (~nnn) means we no longer need to track this value. we could
                     ; determine this automatically, but for simplicity it&#39;s
                     ; easier to have it defined statically
v4 &lt;= v1 + v3 (~v1,v3)
v5 &lt;= int32[a]
v6 &lt;= int32[d]
v7 &lt;= v5 + v6 (~v5,v6)
v8 &lt;= int32[c + 4*v7] (~v7)
v9 &lt;= v4 + v8 (~v4,v8)
</code></pre><p>Using a very simple (and somewhat naive) register allocator that can only allocate two registers, EAX and EBX (a restriction put in place so that we can show what happens when you run out of registers), you may start by annotating the locations of each live value:</p><pre><code>v1 &lt;= int32[a]              [EAX=v1, EBX=-]
v2 &lt;= int32[b]              [EAX=v1, EBX=v2]
v3 &lt;= 2*v2  (~v2)           [EAX=v1, EBX=v3]
v4 &lt;= v1 + v3 (~v1,v3)      [EAX=v4, EBX=-]
v5 &lt;= int32[a]              [EAX=v4, EBX=v5]
v6 &lt;= int32[d]
</code></pre><p>... OK, so we don&#39;t have a register available here.  So we need to temporarily store a value.  Because this register allocator is hopelessly naive, it doesn&#39;t realise that there are better ways than storing a value that came directly from memory into a temporary memory location.  It just picks the value that will not be needed for the longest and adds an extra instruction that stores that into temporary storage:</p><pre><code>t1 &lt;= v4                     [EAX=-, EBX=v5, t1=v4] 
v6 &lt;= int32[d]               [EAX=v6, EBX=v5, t1=v4]
v7 &lt;= v5 + v6 (~v5,v6)       [EAX=v7, EBX=-, t1=v4]
v8 &lt;= int32[c + 4*v7] (~v7)  [EAX=v8, EBX=-, t1=v4]
v9 &lt;= v4 + v8 (~v4,v8)
</code></pre><p>So now it needs to use a value from temporary storage, so it inserts another instruction to pull it back in:</p><pre><code>v4 &lt;= t1                     [EAX=v8, EBX=v4, t1=v4]
v9 &lt;= v4 + v8 (~v4,v8)       [EAX=v9]
</code></pre><p>So now the registers are allocated, we translate the intermediate code into assembly language:</p><pre><code>; local variables: a = [ebp+4], b=[ebp+8], c=[ebp+12], d=[ebp+40]
; temporary storage available at [ebp-8]
;v1 &lt;= int32[a]              [EAX=v1, EBX=-]
mov eax, dword [ebp+4]
;v2 &lt;= int32[b]              [EAX=v1, EBX=v2]
mov ebx, dword [ebp+8]
;v3 &lt;= 2*v2  (~v2)           [EAX=v1, EBX=v3]
shl ebx, 1
;v4 &lt;= v1 + v3 (~v1,v3)      [EAX=v4, EBX=-]
add eax, ebx
;v5 &lt;= int32[a]              [EAX=v4, EBX=v5]
mov ebx, dword [ebp + 4]
;t1 &lt;= v4                     [EAX=-, EBX=v5, t1=v4] 
mov dword [ebp-8], eax    
;v6 &lt;= int32[d]               [EAX=v6, EBX=v5, t1=v4]
mov eax, dword [ebp + 40]
;v7 &lt;= v5 + v6 (~v5,v6)       [EAX=v7, EBX=-, t1=v4]
add eax, ebx
;v8 &lt;= int32[c + 4*v7] (~v7)  [EAX=v8, EBX=-, t1=v4]
mov eax, dword [ebp + eax*4 + 12] 
;v4 &lt;= t1                     [EAX=v8, EBX=v4, t1=v4]
mov ebx, dword [ebp-8]
;v9 &lt;= v4 + v8 (~v4,v8)       [EAX=v9]
add eax, ebx
</code></pre><p>The one remaining question is what would happen if the operation for calculating <code>v8</code> were instead:</p><pre><code>v8 &lt;= int32[c + 33*v7 + 4] (~v7)  [EAX=v8, EBX=-, t1=v4]
</code></pre><p>Then, we&#39;d need to generate a series of instructions, but that wouldn&#39;t be a problem.  We know that EAX is available, because it&#39;s being clobbered by the result of this computation, so we can use it as temporary storage without needing to go through allocation:</p><pre><code>imul eax, 33
mov eax, dword [ebp + eax + 16]
</code></pre></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   </div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>