<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>C++ &#8211; Implementing copy-on-write &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1078347 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1078347" class="post-1078347 software type-software status-publish hentry category-software tag-c tag-design"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">C++ &#8211; Implementing copy-on-write</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">c</span><span class="mr-2 badge badge-info">design</span></p><div class="entry-content"><p>I have a rather large class that contains a number of related member variables. These member variables can be grouped into related sections. We&#39;ve noticed that the pattern of use of the class is to make a copy of an existing instance, change only a few of the member variables, and then do work with the resulting instance. There are 2 problems we&#39;ve hit.</p><ol><li>Instances of the class are large and often on the stack, so it would be nice to reduce its size</li><li>Copying all the member variables is somewhat slow.</li></ol><p>So one idea we had was to group related member variables into their own objects. This is just a good idea for making the code easier to understand. But if we did this and had each of these objects be merely a shared pointer to an existing instance, it would reduce the size of the main class as several member variables would be replaced with a single shared pointer. It would also speed up copying, as the copy would just be creating a new shared pointer pointing to the existing instance.</p><p>The problem is that now whenever we have to write to anything in one of these shared objects, we need to make a copy of it on first write. (And we need to check on every write whether it needs to be copied or not.) We don&#39;t write very often, so I don&#39;t think it will be a performance hit. But implementing this seems problematic.</p><p>Is there a way to make a class be copy-on-write when one of its member variables needs to be changed? The class itself is written in C++, though I could also use C or Objective-C to implement this. I don&#39;t want to have to manually write the check of the shared pointer&#39;s reference count in every setter, for example. Is there any way to avoid that?</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>C++ does not have built-in copy on write semantics. You can implement such semantics with a smart pointer class, or can choose a design-level approach that makes copies unnecessary, e.g. by using the <em>decorator pattern</em>. However, you may find that these optimizations are not worth their effort.</p><h2>Copy on Write Smart Pointer</h2><p>The idea is that your members are stored in a smart pointer that manages their ownership. When the smart pointer is copied, it will not copy the managed object. However, once write-access is required, a copy is made.</p><p>This is not entirely trivial to get right, especially if there may be other pointers into the managed object. Some CoW implementations trigger only when a copy wants to write to the object, other implementations also perform a copy when the original owner writes to the (shared) object.</p><p>You will therefore have to write your own smart pointer that implements your desired semantics. Likely, this can be implemented with moderate effort on top of <code>std::shared_ptr</code>.</p><p>A significant drawback of CoW is that these lazy copies can make your code much harder to debug. Copying a C++ object may have observable side effects, but may now happen at unexpected times. Also, every write access must first check the state of the smart pointer and must possibly dereference multiple pointers.</p><h2>Decorator Pattern</h2><p>The decorator pattern can be used to overlay parts of an object with a different implementation. For example, you might want to overlay parts of a <code>struct { A a; B b; C c; }</code>. First, we need to define an interface so that we can combine our Decorators:</p><pre><code>class Data {
public:
  virtual A&amp; get_a() = 0;
  virtual B&amp; get_b() = 0;
  virtual C&amp; get_c() = 0;
};
</code></pre><p>Now we can implement this interface with a base storage class:</p><pre><code>class BaseStorage : public Data {
  A a; B b; C c;
public:
  BaseStorage(A const&amp; a, B const&amp; b, C const&amp; c) : a(a), b(b), c(c) {}
  A&amp; get_a() override { return a; }
  B&amp; get_b() override { return b; }
  C&amp; get_c() override { return c; }
};
</code></pre><p>If we want to overlay the value of <code>A</code>, we can define a class that delegates all calls to a base object, except for requests of the <code>A</code> data:</p><pre><code>class OverlayA : public Data {
  Data&amp; base;
  A a;
public:
  OverlayA(Data&amp; base, A&amp;&amp; a) : base(base), a(std::move(a)) {}
  A&amp; get_a() override { return a; }
  B&amp; get_b() override { return base.get_b(); }
  C&amp; get_c() override { return base.get_c(); }
};
</code></pre><p>Instead of performing a copy of some <code>Data</code>, we can now overlay the part of it we are going to change:</p><pre><code>Data&amp; orig = ...;
// call a function with a copied A
will_change_a(OverlayA(orig, A(orig.get_a())));
</code></pre><p>Unfortunately, these decorators make it really really difficult to write const-correct code – you may want the <code>Data&amp; base</code> to be a const reference in order to prevent writes to the base storage, but the interface may also describe overlaid data where writes are necessary. This could possibly be expressed through templates.</p><p>If behaviour of any <code>Data</code> interface implementation changes the private fields directly rather than going through the virtual methods, that may not write to the overlaid data. Therefore, the <code>Data</code> interface should not contain extra behaviour. You can implement such behaviour in a separate class that wraps a <code>Data&amp;</code>.</p><p>This technique requires you to know in advance which parts of the object must be overlaid with copied data. As such, it is potentially error-prone.</p><p>The decorator pattern constructs a linked list of overlays. If the list grows many levels deep, this pointer chasing may hurt performance.</p><h2>Copies are good</h2><p>In many cases, creating a copy is preferable to cleverness like CoW. In particular, if the objects in question are not very large and are trivially copyable, then doing a copy each time may turn out to be cheaper than the alternatives. Because of caching, chasing pointers tends to be expensive compared to operations on contiguous objects. Both CoW and Decorators have continuous per-read overhead, whereas copies only have a predictable per-copy overhead.</p><p>If your profiling determines that the copies are a performance problem, then it may be sensible to try out one of these approaches or a combination of them (e.g. performing a copy but using CoW for expensive to copy members like vectors might be sensible). Where possible, avoid ownership of expensive to copy data in your object.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../c-the-term-interface-in-c/'>C++ &#8211; The term &#8220;interface&#8221; in C++</a></li><li class="list-group-item"><a href='../python-how-to-refactor-a-python-god-class/'>Python &#8211; How to refactor a Python “god class”</a></li><li class="list-group-item"><a href='../c-possible-alternatives-to-copy-constructors/'>C++ &#8211; Possible alternatives to copy constructors</a></li><li class="list-group-item"><a href='../c-returning-persistent-objects/'>C++ returning persistent objects</a></li><li class="list-group-item"><a href='../c-how-to-facilitate-thread-safe-access-to-large-set-of-shared-variables/'>C++ &#8211; How to facilitate thread-safe access to large set of shared variables</a></li><li class="list-group-item"><a href='../c-is-it-bad-practice-to-write-code-that-relies-on-compiler-optimizations/'>C++ &#8211; Is it bad practice to write code that relies on compiler optimizations</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>