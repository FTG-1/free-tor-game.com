<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Event sourcing, one event, state of two aggregates changed &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1076402 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1076402" class="post-1076402 software type-software status-publish hentry category-software tag-domain-driven-design tag-event-sourcing"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Event sourcing, one event, state of two aggregates changed</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">domain-driven-design</span><span class="mr-2 badge badge-info">event-sourcing</span></p><div class="entry-content"><p>I am trying to learn ways of DDD and related subjects. I came up with an idea of simple bounded context to implement &#34;bank&#34;: there are accounts, money can be deposited, withdrawn and transferred between them. It is also important to keep history of changes.</p><p>I identified <strong>Account</strong> entity and that event sourcing would be good to keep track of changes in it. Other entities or value objects are irrelevant to the problem, so I won&#39;t mention them.</p><p>When considering deposits and withdrawals &#8211; it&#39;s relatively simple, because there is only one aggregate modified.</p><p>When transferring it&#39;s different &#8211; two aggregates must be modified by one <strong>MoneyTransferred</strong> event. DDD deprecates modifying multiple aggregates in one transaction. On the other hand event sourcing&#39;s rule is to apply events to entities and modify state based on them. If event could be stored simply in database, there would be no problem. But to prevent concurrent modification of event sourced entities we must implement something versioning the event stream of each aggregate (to keep their transaction bounds). With versioning comes another problem &#8211; I cannot use simple structures to store events and read them back to apply them to aggregate.</p><p>My question is &#8211; how can I bring together those three principles: &#34;one aggregate one transaction&#34;, &#34;event-&gt;change in aggregate&#34; and &#34;concurrent modification prevention&#34;?</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><blockquote><p>When transferring it&#39;s different - two aggregates must be modified by one MoneyTransferred event.</p></blockquote><p>Transferring money is a separate act from updating the ledgers.</p><pre><code>MoneyTransferred
AccountCredited
AccountDebited
</code></pre><p>The exercise that finally broke this loose for me was realizing that <code>AccountOverdrawn</code> is an event, it describes the state of the account without regard to the other participants in this exchange, so there must be a command run against an account that produces it.</p><p>You can&#39;t reasonably derive state like <code>AccountOverdrawn</code> from the read model, because you can&#39;t possibly know if you have seen all of the events yet -- only the aggregate itself has a full view of the history at any given moment.</p><p>The answer, of course, is right there in the ubiquitous language -- accounts are credited or debited to reflect the bank&#39;s obligations to its customers.</p><blockquote><p>Allright, but it means I should use AccountCredited and AccountDebited events for deposits and withdrawals as well, so I only register not the cause of change, but the change caused by some other action. If I would like to reverse the action I couldn&#39;t, because not all of the events are registered.</p></blockquote><p>I&#39;m not entirely certain that follows, because you do have (for cases like this one) a natural correlation identifier, which is the transaction id itself.</p><blockquote><p>Second thing - it means i need to use something like saga.</p></blockquote><p>Slightly different spelling: you need something like a <a href="https://abdullin.com/post/ddd-evolving-business-processes-a-la-lokad/" rel="noreferrer">human being dispatching the right commands</a>.</p><p>There are at least two ways you could do it.  One would be to have a subscriber listening for <code>MoneyTransferred</code>, and dispatching the two commands to the ledgers.</p><p>Another alternative would be to track the processing of the transaction as a separate aggregate -- think of it as a checklist of all the things that need to get done since a transaction occurred.  So a <code>MoneyTransferred</code> event handler dispatches ProcessTransaction, which schedules work to be done and checks off what work has been completed.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../event-sourcing-updates-to-multiple-aggregates/'>Event Sourcing + Updates to multiple aggregates</a></li><li class="list-group-item"><a href='../cqrs-event-sourcing-and-near-real-time-reporting/'>CQRS, Event Sourcing and (near) Real Time Reporting</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>