<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>DDD CQRS &#8211; per-query and per-command authorization &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1071341 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1071341" class="post-1071341 software type-software status-publish hentry category-software tag-cqrs tag-domain-driven-design"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">DDD CQRS &#8211; per-query and per-command authorization</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">cqrs</span><span class="mr-2 badge badge-info">domain-driven-design</span></p><div class="entry-content"><h3>Summary</h3><p><strong>Should authorization in CQRS/DDD be implemented per-command/query or not?</strong></p><p>I am developing for the first time an online application using more or less strictly the DDD CQRS pattern. I bumped into some problem, which I can&#39;t really get my head around.</p><p>The application I am building is a ledger application allowing people to create ledgers, as well as allowing other people to view/edit/delete them, such as employees. The creator of a ledger should be able to edit the access rights of the ledger he created. Could even change ownership. The domain has two aggregates <strong>TLedger</strong> and <strong>TUser</strong>.</p><p>I read a lot of posts with the DDD / CQRS keyword concerning security, authorization, etc. Most of them stated that authorization was a <strong>Generic Subdomain</strong>, unless one was building a security application.</p><p>In this case, the <strong>core domain</strong> is a certainly an <strong>accounting domain</strong> interested with transactions, balancing and accounts. But the functionality of being able to manage fine grained access to the ledgers is also required. I&#39;m wondering how to design this in DDD/CQRS terms.</p><p>It&#39;s stated in the DDD tutorials all around the place that the commands are part of the ubiquitous language. They&#39;re meaningful. They&#39;re concrete actions that represent the &#34;real thing&#34;.</p><p>Because all those commands and queries are actual actions that users would execute in &#34;real life&#34;, should the implementation of the authorization be coupled with all these &#34;commands&#34; and &#34;queries&#34; ? A user would have authorization to execute TLedger.addTransaction() but not TLedger.removeTransaction() for example. Or, a user would be allowed to execute the query &#34;getSummaries()&#34; but not &#34;getTransactions()&#34;.</p><p>A tri-dimensional mapping would exist in the form of user-ledger-command or user-ledger-query to determine the access rights.</p><p>Or, in a decoupled way, named &#34;permissions&#34; would be registered for a user. Permissions that would then be mapped for specific commands. For example, permission &#34;ManageTransactions&#34; would allow a user to execute &#34;AddTransaction()&#34;, &#34;RemoveTransaction()&#34;, etc.</p><ol><li><p>Permissions mapping <strong>user -&gt; ledger -&gt; command/query</strong></p></li><li><p>Permissions mapping <strong>user -&gt; ledger -&gt; permission -&gt; command/query</strong></p></li></ol><h3>That&#39;s the first part of the question. Or in brief, should authorization in CQRS/DDD be implemented per-command or per-query? Or, should authorization be decoupled from the commands?</h3><p>Secondly, concerning authorization based on permissions. A User should be able to manage the permissions on his Ledgers or on the Ledgers he&#39;s been allowed to manage.</p><ol><li>Authorization management commands happens in the Ledger</li></ol><p>I thought of adding the events/commands/handlers into the <strong>Ledger</strong> aggregate, such as grantPermission(), revokePermission(), etc. In this case, enforcing those rules would happen into the command handlers. But this would require all commands to include the id of the user who issued that command. Then I would check into the TLedger if the permission exists for that user to execute that command.</p><p>For example :</p><pre><code>class TLedger{ 
    function addTransactionCmdHandler(cmd){
        if (!this.permissions.exist(user, &#39;addTransaction&#39;)
            throw new Error(&#39;Not Authorized&#39;);
    }
}
</code></pre><ol start="2"><li>Authorization management commands in the User</li></ol><p>The other way around would be to include the permissions into the TUser. A TUser would have a set of permissions. Then, in the TLedger command handlers, I would retrieve the user and check if he has permission to execute the command. But this would require me to fetch the TUser aggregate for every TLedger command.</p><pre><code>class TAddTransactionCmdHandler(cmd) {
    this.userRepository.find(cmd.userId)
    .then(function(user){
        if (!user.can(cmd)){
            throw new Error(&#39;Not authorized&#39;);
        }
        return this.ledgerRepository.find(cmd.ledgerId);
    })
    .then(function(ledger){
        ledger.addTransaction(cmd);
    })

}
</code></pre><ol start="3"><li>Another domain with service</li></ol><p>Another possibility would be to model another authorization domain completely. This domain would be interested in access rights, authorization etc. The accounting subdomain would then use a service to access this authorization domain in the form of <code>AuthorizationService.isAuthorized(user, command)</code>.</p><pre><code>class TAddTransactionCmdHandler(cmd) {
    authService.isAuthorized(cmd)
    .then(function(authorized){
        if (!authorized) throw new Error(&#39;Not authorized&#39;);
        return this.ledgerRepository.find(cmd.ledgerId)
    })
    .then(function(){
        ledger.addTransaction(cmd);
    })

}
</code></pre><p>What decision would be the most &#34;DDD/CQRS&#34; way?</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>For the first question I&#39;ve been struggling with something similar.  More and more I&#39;m leaning towards a three-phased authorization scheme:</p><p>1) Authorization at the command/query level of &#34;does this user <em>ever</em> have permission to execute this command?&#34;  In an MVC app this could probably be handled at the controller level, but I&#39;m opting for a generic pre-handler that will query the permissions store based on the current user and the executing command.</p><p>2) Authorization inside the application service of &#34;does this user &#34;ever* has permission to access this entity?&#34;  In my case this will probably end up being an implicit check simply by means of filters on the repository -- in my domain this is basically a TenantId with a little more granularity of OrganizationId.</p><p>3) Authorization that relies on a transient properties of your entities (such as Status) would be handled inside of the domain.  (Ex. &#34;Only certain people can modify a closed ledger.&#34;)  I&#39;m opting to put that inside the domain because it it relies heavily on the domain and business logic and I&#39;m not really comfortable exposing that in other places.</p><p>I&#39;d love to hear others&#39; responses to this idea -- tear it to shreds if you want (just provide some alternatives if you do :) )</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../c-command-handlers-and-ddd/'>C# &#8211; Command handlers and DDD</a></li><li class="list-group-item"><a href='../c-dealing-with-property-level-permissions-in-ddd-and-should-ui-or-authorization-influence-the-domain-model/'>C# &#8211; Dealing with property-level permissions in DDD and should UI or authorization influence the domain model</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>