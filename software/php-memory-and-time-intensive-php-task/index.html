<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Php &#8211; memory and time intensive php task &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1071044 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1071044" class="post-1071044 software type-software status-publish hentry category-software tag-linux tag-performance tag-php"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Php &#8211; memory and time intensive php task</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">linux</span><span class="mr-2 badge badge-info">performance</span><span class="mr-2 badge badge-warning">PHP</span></p><div class="entry-content"><p>Sorry if this question has been asked before, but I couldn&#39;t find anything usable.</p><p>I&#39;m working on a project for a client and currently I have to loop through the users table which is about 3000 records and still growing.</p><p>I have to do some calculations on a nightly basis which I am going to be using cron/php.  The calculations script uses about 3.5mb of memory and takes about 1 second to run.</p><p>When loading individual users my current php setup handles this fine, but if I try and loop through the user list my php script execution time runs out.</p><p>I&#39;ve read after doing some searching that I can make the page reload itself after each user calculation and just keep my previous place in the loop and this sounds like a good idea, but I wanted to hear some opinions from others that have handled similar situations and how you handled these types of tasks.</p><p>Thanks.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>If you really expect your table to grow, you should start thinking about batching the process, do your calculations in steps. The simplest way would be to have a secondary table that would hold the user id and the timestamp of when the user was last processed, and limit your cron script to loop through, for example, 500 users per time. The exact numbers will depend on what exactly you are doing, it&#39;ll be a bit of a trial and error.</p><p>If you do decide to batch the process, you&#39;ll obviously need to run the cron script more than once, that&#39;s easy enough, only process users that weren&#39;t recently processed (by checking the timestamp) and, of course, logging them as processed afterwards. If your user ids are sequential, you could save yourself the trouble of logging each processed user id and just log the last one of the batch, however if something goes wrong in the middle of the batch, you wouldn&#39;t have any idea of where it stopped. Your choice ;)</p><p>Next you need to optimize the hell out of your loop. Start with the simple stuff, are you using for or foreach? There&#39;s an abundance of references claiming one being faster than the other, but the truth is you&#39;ll have to test them and find out which one is faster (if there&#39;s actually a difference) for you. Depends on your php version, os, and the structures you&#39;re looping (if you are looping iterable objects, for example), and obviously you should run your test on the server where your script will live, especially if the environment is different from your local development one.</p><p>Then, it&#39;s time to profile and optimize your calculations. You aren&#39;t telling us what you are doing, but 3.5mb of memory sounds a bit much for a single iteration. It could be that your calculations are so intensive and you&#39;ve done your best, or there might be something obvious you&#39;re missing, in any case that&#39;s something only a profiler can tell you.</p><p>Although <code>max_execution_time</code> is hardcoded to 0 (no limit) for the CLI SAPI, you might want to limit the execution time through <a href="http://php.net/manual/en/function.set-time-limit.php" rel="nofollow">set_time_limit</a> or <a href="http://php.net/manual/en/function.ini-set.php" rel="nofollow">ini_set(&#39;max_execution_time&#39;)</a> (same thing) for two reasons:</p><ol><li>It will help testing the script via the browser, where there is a limit (in php.ini). It wouldn&#39;t be advisable to allow browser access to the production script, but during development it wouldn&#39;t make sense to setup cron just to test your script.</li><li>Although there&#39;s no limit for CLI scripts, it wouldn&#39;t hurt to impose the limit just in case something awry happens. Database servers do hiccup once in a while, and you don&#39;t really want your script to run ad infinitum (== until it runs out of memory).</li></ol><p>If you are having memory problems, then it&#39;s time to do some <a href="http://us.php.net/manual/en/features.gc.php" rel="nofollow">garbage collecting</a>. The naive approach would be to call <a href="http://us.php.net/manual/en/function.gc-collect-cycles.php" rel="nofollow">gc_collect_cycles</a> at the end of your script, forcing the garbage collection of any existing cycles at that time. It wouldn&#39;t hurt if you&#39;ve <a href="http://php.net/manual/en/function.unset.php" rel="nofollow">unset()</a> any memory hungry resources before hand. Remember that php loops don&#39;t create their own scope, for example:</p><pre><code>&lt;?php

foreach($array as $key =&gt; $value) {
   doSomething($value);
}

var_dump($key, $value);

?&gt;
</code></pre><p>will work, dumping the last <code>$key</code> and <code>$value</code> of the loop, which means that at the end of the loop you don&#39;t have one (<code>$array</code>) but three unused variables, that will be collected when php decides it&#39;s a good time to collect garbage. To force it, do something like:</p><pre><code>&lt;?php

foreach($array as $key =&gt; $value) {
   doSomething($value);
}

unset($array, $key, $value);
gc_collect_cycles();

?&gt;
</code></pre><p>I&#39;m 99% certain that <code>unset($array, $key, $value);</code> is unnecessary here, however it&#39;s a favourite hack of the &lt; php 5.3 days, and I&#39;m sticking with it (at least until I fully understand how garbage collection works in php ;).</p><p>For anything more than that, you really need to give us the specifics of your calculations, and show us your code.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../object-oriented-php-internal-apis-libraries-what-makes-sense/'>Object-oriented &#8211; PHP &#8211; Internal APIs/Libraries &#8211; What makes sense</a></li><li class="list-group-item"><a href='../php-file_put_contents-file-locking/'>PHP file_put_contents File Locking</a></li><li class="list-group-item"><a href='../php-xmpp-openfire-php-and-python-web-service/'>Php &#8211; XMPP— openfire, PHP and python web service</a></li><li class="list-group-item"><a href='../php-web-application-structure-review/'>Php &#8211; Web application structure review</a></li><li class="list-group-item"><a href='../php-alternatives-to-cron-jobs-or-other-ways-of-improving-scheduled-task-performance/'>Php &#8211; Alternatives to cron jobs or other ways of improving scheduled task performance</a></li><li class="list-group-item"><a href='../php-synchronize-database-with-external-api/'>Php &#8211; Synchronize database with external API</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>