<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>How to test code that depends on complex APIs (Amazon S3 for instance) &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1065907 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1065907" class="post-1065907 software type-software status-publish hentry category-software tag-mocking tag-testing"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">How to test code that depends on complex APIs (Amazon S3 for instance)</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">mocking</span><span class="mr-2 badge badge-info">testing</span></p><div class="entry-content"><p>I am struggling with testing a method that uploads documents to Amazon S3, but I think this question applies to any non-trivial API/external dependecy. I&#39;ve only come up with three potential solutions but none seem satisfactory:</p><ol><li><p>Do run the code, actually upload the document, check with AWS&#39;s API that it has been uploaded and delete it at the end of the test. This will make the test very slow, will cost money every time the test is run and won&#39;t alway return the same result.</p></li><li><p>Mock S3. This is super hairy because I have no idea about that object&#39;s internals and it feels wrong because it&#39;s way too complicated.</p></li><li><p>Just make sure that MyObject.upload() is called with the right arguments and trust that I am using the S3 object correctly. This bothers me because there is no way to know for sure I used the S3 API correctly from the tests alone.</p></li></ol><p>I checked how Amazon tests their own SDK and they do mock everything. They have a 200 lines helper that does the mocking. I don&#39;t feel it&#39;s practical for me to do the same.</p><p>How do I solve this?</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>There are two issues we have to look at here.</p><p>The first is that you seem to be looking at all of your tests from the unit test perspective. Unit tests are extremely valuable, but are not the only kinds of tests. Tests can actually be divided into several different layers, from very fast <a href="https://en.wikipedia.org/wiki/Unit_testing">unit tests</a> to less fast <a href="https://en.wikipedia.org/wiki/Integration_testing">integration tests</a> to even slower <a href="https://en.wikipedia.org/wiki/Acceptance_testing">acceptance tests</a>. (There can be even more layers broken out, like <a href="https://en.wikipedia.org/wiki/Functional_testing">functional tests</a>.)</p><p>The second is that you are mixing together calls to third-party code with your business logic, creating testing challenges and possibly making your code more brittle.</p><p>Unit tests should be fast and should be run often. Mocking dependencies helps to keep these tests running fast, but can potentially introduce holes in coverage if the dependency changes and the mock doesn&#39;t. Your code could be broken while your tests still run green. Some mocking libraries will alert you if the dependency&#39;s interface changes, others cannot.</p><p>Integration tests, on the other hand, are designed to test the interactions between components, including third-party libraries. Mocks should not be used at this level of testing because we want to see how the actual object interact together. Because we are using real objects, these tests will be slower, and we will not run them nearly as often as our unit tests.</p><p>Acceptance tests look at an even higher level, testing that the requirements for the software are met. These tests run against the entire, complete system that would get deployed. Once again, no mocking should be used.</p><p>One guideline people have found valuable regarding mocks is to <a href="http://www.davesquared.net/2011/04/dont-mock-types-you-dont-own.html">not mock types you don&#39;t own</a>. Amazon owns the API to S3 so they can make sure it doesn&#39;t change beneath them. You, on the other hand, do not have these assurances. Therefore, if you mock out the S3 API in your tests, it could change and break your code, while your tests all show green. So how do we unit test code that uses third-party libraries?</p><p>Well, we don&#39;t. If we follow the guideline, we can&#39;t mock objects we don&#39;t own. <strong><em>Butâ€¦</em></strong> if we own our direct dependencies, we can mock them out. But how? We create our own wrapper for the S3 API. We can make it look a lot like the S3 API, or we can make it fit our needs more closely (preferred). We can even make it a little more abstract, say a <code>PersistenceService</code> rather than an <code>AmazonS3Bucket</code>. <code>PersistenceService</code> would be an interface with methods like <code>#save(Thing)</code> and <code>#fetch(ThingId)</code>, the types of methods we might like to see (these are examples, you might actually want different methods). We can now implement a <code>PersistenceService</code> around the S3 API (say a <code>S3PersistenceService</code>), encapsulating it away from our calling code.</p><p>Now to the code that calls the S3 API. We need to replace those calls with calls to a <code>PersistenceService</code> object. We use <a href="https://en.wikipedia.org/wiki/Dependency_injection">dependency injection</a> to pass our <code>PersistenceService</code> into the object. It&#39;s important <strong>not</strong> to ask for a <code>S3PersistenceService</code>, but to ask for a <code>PersistenceService</code>. This allows us to swap out the implementation during our tests.</p><p>All the code that used to use the S3 API directly now uses our <code>PersistenceService</code>, and our <code>S3PersistenceService</code> now makes all the calls to the S3 API. In our tests, we can mock out <code>PersistenceService</code>, since we own it, and use the mock to make sure that our code makes the correct calls. But now that leaves how to test <code>S3PersistenceService</code>. It has the same problem as before: we can&#39;t unit test it without calling to the external service. Soâ€¦ we don&#39;t unit test it. We <em>could</em> mock out the S3 API dependencies, but this would give us little-to-no additional confidence. Instead, we have to test it at a higher level: integration tests.</p><p>This may sound a little troubling saying that we shouldn&#39;t unit test a part of our code, but let&#39;s look at what we accomplished. We had a bunch of code all over the place we couldn&#39;t unit test that now can be unit tested through the <code>PersistenceService</code>. We have our third-party library mess confined to a single implementation class. That class should provide the necessary functionality to use the API, but does not have any external business logic attached to it. Therefore, once it is written, it should be very stable and should not change very much. We can rely on slower tests that we don&#39;t run that often because the code is stable.</p><p>The next step is to write the integration tests for <code>S3PersistenceService</code>. These should be separated out by name or folder so we can run them separately from our fast unit tests. Integration tests can often use the same testing frameworks as unit tests if the code is sufficiently informative, so we don&#39;t need to learn a new tool. The actual code to the integration test is what you would write for your Option 1.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../python-how-to-populate-a-private-container-for-unit-test/'>Python &#8211; How to populate a private container for unit test</a></li><li class="list-group-item"><a href='../unit-testing-how-should-i-test-the-test-code/'>Unit-testing &#8211; How should I test the TEST code</a></li><li class="list-group-item"><a href='../unit-testing-unit-testing-in-django/'>Unit-testing &#8211; Unit testing in Django</a></li><li class="list-group-item"><a href='../unit-testing-unit-testing-an-api-client-and-wrappers/'>Unit-testing &#8211; Unit testing an API client and wrappers</a></li><li class="list-group-item"><a href='../unit-testing-how-should-i-unit-test-a-function-that-uses-setters/'>Unit-testing &#8211; How should I unit test a function that uses setters</a></li><li class="list-group-item"><a href='../unit-testing-how-to-write-unit-tests-for-legacy-code-that-i-dont-understand/'>Unit-testing &#8211; How to write unit tests for legacy code (that I don&#8217;t understand)</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>