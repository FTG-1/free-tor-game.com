<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Php &#8211; Persisting Large/Complex Entities with the Command Pattern &#8212; Am I doing it right &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1083575 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1083575" class="post-1083575 software type-software status-publish hentry category-software tag-design-patterns tag-domain-driven-design tag-php tag-software-as-a-service"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Php &#8211; Persisting Large/Complex Entities with the Command Pattern &#8212; Am I doing it right</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">design-patterns</span><span class="mr-2 badge badge-info">domain-driven-design</span><span class="mr-2 badge badge-warning">PHP</span><span class="mr-2 badge badge-primary">software-as-a-service</span></p><div class="entry-content"><p>I am in the process of designing and building a large-scale inventory management software-as-a-service that will, hopefully, live a long and fruitful life. Therefore I am exerting a lot of effort up-front to ensure the application will be maintainable and horizontally scabale. I really enjoyed <a href="http://verraes.net/2014/09/decoupling-model-framework/" rel="nofollow">this talk by Mathias Verraes on decoupling</a> which inspired to try out the Command Pattern as it lends itself to highly decoupled and very explicit code.</p><p>In terms of technology, I&#39;m using Laravel 5 and Doctrine 2 backed by a MySQL database.</p><p>Although Mathias speaks on the subject of &#34;getting out of the CRUD mindset&#34;, I think we can all agree that many situations exist where the business language does in fact reflect CRUD. For example, the logistics manager says &#34;I need to CREATE a Purchase Order which I will then SUBMIT to the Supplier&#34;. The &#34;SUBMIT&#34; portion lights up as a great use-case for a Command, but not so much the CREATE part.</p><p>Let me explain my position in hopes someone can agree/disagree and maybe point me in a better direction.</p><p>I <em>feel</em> as though the Command Pattern is not particularly well-suited for the act of handling a CREATE request for a complex object, like a Purchase Order. In my domain, the Purchase Order holds information such as:</p><ul><li>User-defined Order Number / Identifier (e.g., PO1234)</li><li>Supplier for which the Order will be submitted to</li><li>The Ship To Address</li><li>The Bill To Address</li><li>The Requested Shipping Method and Courier</li><li>NET Terms</li><li>The Monetary Currency</li><li>A Sale Order and Customer if the order is to be Drop Shipped</li><li>One or more Line Items</li></ul><p>If I understand correctly, the Command Object should essentially be a <em>relatively simple</em> DTO that provides a contract to the outside world to interact with the application. <em>&#34;If you want to CREATE a new Purchase Order, populate this object with data and send it down the bus&#34;</em>. As a developer, it is beautifully explicit to issue a <code>CreatePurchaseOrderCommand</code> to the application&#8211; I like how that sounds, but when it comes to execution it just feels clumsy.</p><p>By clumsy, I mean it seems awkward to extrapolate all of the above data from the Request object and new-up a <code>CreatePurchaseOrderCommand</code> with no fewer than <strong>9 arguments</strong>, some of which would be arrays, maybe a ValueObject or two (or would that introduce coupling??).</p><p>I&#39;ve mocked up some code that looks like this:</p><p><strong>EDIT</strong> I&#39;ve updated the OrderController to reflect my needs of outputting a JSON encoded object after a successful CREATE in order to satisfy the needs of my client-side framework. Is this considered a good approach? I have no issue with injecting the repository into the Controller as it will almost certainly be needed for other read methods.</p><p><strong>OrderController.php</strong></p><pre><code>public function __construct(ValidatingCommandBus $commandBus, OrderRepositoryInterface $repository) { .. }
public function create(CreateOrderRequest $request){
     $uuid = UUID::generate();
     $command = new CreatePurchaseOrderCommand($uuid, $request-&gt;all());

     try
     {
         $this-&gt;commandBus-&gt;execute($command);
         $order = $this-&gt;repository-&gt;findByUuid($uuid);
         return $this-&gt;response()-&gt;json([
             &#39;success&#39; =&gt; true,
             &#39;data&#39;    =&gt; $order-&gt;jsonSerialize()
         ]);
     }catch(OrderValidationException $e)
     {
         return $this-&gt;response()-&gt;json([
             &#39;success&#39; =&gt; false,
             &#39;message&#39; =&gt; $e-&gt;getMessage()
         ]);
     }
}
</code></pre><p><strong>ValidatingCommandBus.php</strong> <em>(decorates BaseCommandBus)</em></p><pre><code>public function __construct(BaseCommandBus $baseCommandBus, IoC $container, CommandTranslator $translator) { .. }
public function execute(Command $command){
    // string manipulation to CreatePurchaseOrderValidator
    $validator = $this-&gt;translator-&gt;toValidator($command);

    // build validator class from IOC container
    // validates the command&#39;s data, might throw exception
    // does *not* validate set constraints e.g., uniqueness of order number
    // this is answering &#34;does this look like a valid command?&#34;
    $this-&gt;container-&gt;make($validator)-&gt;validate($command) 

    // pass off to the base command bus to execute
    // invokes CreatePurchaseOrderCommandHandler-&gt;handle($command)
    $this-&gt;baseCommandBus-&gt;execute($command)
}
</code></pre><p><strong>CreatePurchaseOrderCommandHandler.php</strong></p><pre><code>public function __construct(PurchaseOrderBuilderService $builder, PurchaseOrderRepositoryInterface $repository){ .. }
public function handle(CreatePurchaseOrderCommand $command){

    // this again? i&#39;m pulling the same data as I pulled from the
    // Request object back in the Controller, now I&#39;m just getting
    // the same data out of the Command object. Seems repetitive...
    $order = $this-&gt;builder-&gt;build([
       $command-&gt;order_number,
       $command-&gt;supplier_id,
    ]);

    // now maybe I should handle set constraints?
    // ensure order number is unique, order is not stale... etc.
    $orderNumberIsUnique = new OrderNumberIsUniqueSpecification($this-&gt;repository);
    if ( ! $orderNumberIsUnique-&gt;isSatisfiedBy($order) ){
        throw new \ValidationException(&#34;The Order Number is not unique&#34;);
    }

    // ok now I can persist the entity...
    try
    {
        // start a transaction
        $this-&gt;repository-&gt;persist($order);
    }catch(SomeDbException $e)
    {
        // roll back transaction
        // cant return anything so i&#39;ll throw another exception?
        throw new ErrorException(&#39;Something went wrong&#39;, $e);
    }

    // no return here as that breaks the CommandBus pattern :|
}
</code></pre><p>From a code perspective I think that seems like the logical way to go about things in terms of placement of validation and such. But, at the end of the day, it doesn&#39;t feel like the right solution.</p><p>I also don&#39;t like that I can&#39;t return a value from the Command Bus which leaves me with the choice of switching to generating a UUID before persisting (currently relying on <code>AUTO INC</code> from MySQL) or performing a lookup on the <em>other</em> unique identifier (the order number) which may not work for all entities (i.e., not every entity/aggregate will have some other form of unique identifier besides the database ID).</p><p>Am I using and understanding the Command Pattern correctly? Are my concerns valid (see comments in code examples). Am I missing something about the Command Pattern? Any input would be great!!</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p><strong>Keep your DTO&#39;s simple</strong></p><p>You are right that having a command with 9 arguments in the constructor is ugly. But do you really HAVE to put those things into the constructor? Make your fields public, create your command with an empty constructor and just assign to the fields. The point of constructor arguments is to have guaranteed valid entities, since you are just using a DTO and validation will be performed by another entity there is not much point in hiding data or having complicated constructors. Public fields all the way for commands.</p><p><strong>Nothing wrong with value-DTO&#39;s</strong></p><p>If you have a Command that is composed of a set of fields that belong together, feel free to map these into a value object that belongs to your DTO. There is no hard rule that says you shouldn&#39;t do this.</p><p><strong>Commands do not return anything</strong></p><p>A command is a change to objects in your domain. You should have no need to return anything from your commandbus. Why would you need to return the id? You created the order, as requested by the command, and that&#39;s it.
There is one exception you might consider however and that is...</p><p><strong>Validation</strong></p><p>Simple validation such as not null/not empty, valid dates, regex-for-email all belongs in a validator. The call to this validator is chained before the call to your commandhandler to the handler is guaranteed to be receiving a valid command.</p><p>For complex validation, there are different opinions you can look into. Some people say that even complex validation that requires you do touch the database (&#39;username already taken&#39;) should not belong on the validator, some prefer to have all this validation on the validator (which requires repositories) and perform no validation on the command whatsoever. In the end, you have to decide on a strategy to handle failures to validate commands.</p><p>Depending on your preference, this might lead you to ValidationResults being returned from your commandbus, trapping and displaying CommandValidationExceptions when you call the commandbus...</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../rest-implementing-the-command-pattern-in-a-restful-api/'>Rest &#8211; Implementing the command pattern in a RESTful API</a></li><li class="list-group-item"><a href='../php-dtos-vs-domain-models-and-invoking-command-handlers-directly/'>Php &#8211; DTOs vs Domain Models and invoking Command Handlers directly</a></li><li class="list-group-item"><a href='../is-the-command-design-pattern-a-good-way-to-reduce-the-number-of-dependencies-in-the-class/'>Is the command design pattern a good way to reduce the number of dependencies in the class</a></li><li class="list-group-item"><a href='../java-passing-context-to-the-execute-method-in-command-design-pattern/'>Java &#8211; Passing context to the execute method in command design pattern</a></li><li class="list-group-item"><a href='../ddd-with-web-api-validation-in-domain-or-application-layer/'>DDD with web api, validation in domain or application layer</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>