<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>SQL queries in integration tests &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1087038 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1087038" class="post-1087038 software type-software status-publish hentry category-software tag-integration-tests"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">SQL queries in integration tests</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">integration-tests</span></p><div class="entry-content"><p><strong>Current situation</strong></p><p>I have a situation that I find frustrating: the integration tests in my project (a RESTful API) contain both API HTTP calls and SQL queries. Whenever an API call is made that writes something to the DB (a POST, PUT or PATCH request), a hand-written SQL query is launched to compare the API response with the DB. So:</p><ol><li>Send POST request, receive response</li><li>Send SQL query, receive response</li><li>Compare the two responses</li></ol><p>The integration tests live in a separate project, so it&#39;s impossible to just use the main project&#39;s ORM and unmarshal the DB responses into the business objects that we are using.</p><p><strong>Issue</strong></p><p>I have an issue with the hard dependency between the DB structure and the integration tests.</p><p>The project is young and the database structure is constantly changing. Whenever a change in the DB occurs, SQL queries in all affected integration tests go out of sync and must be manually updated. When the change is small, it&#39;s usually not a big deal, but whenever e.g. a column is changed to a foreign key, all the affected queries suddenly start to require a join, the selected columns need table aliases to avoid ambiguous column names.</p><p>That becomes an issue especially when the tests themselves build the SQL queries from smaller building blocks: a <code>WHERE</code> clause might be passed as an argument to a method that outputs the SQL or maybe a second query might be build based on some parametres used in the first one.</p><p>Finally, whenever a collection is contained in the API response, that&#39;s usually a join in the SQL that needs some additional processing (change <code>n</code> selected rows into a single row with a collection in one of the columns).</p><p>Atop of that, given the fact that the integration tests take a few hours to complete, there&#39;s no immediate feedback that there is an issue, which prolongs the time needed to fix any issues.</p><p><strong>In short, a small change in the DB structure often results in several man days wasted on updating the SQL and the SQL building logic in the integration tests</strong>.</p><p><strong>Rationale</strong></p><p>The rationale for having SQL queries in the integration tests seems to be that the team has encountered issues with the DB structure: the fetched data was correct, but it was saved incorrectly in the database.</p><p>That&#39;s the explanation given to me when I raised the issue. <strong>I don&#39;t buy it.</strong></p><p><strong>Solution</strong></p><p>So what&#39;s the best approach?</p><p>I believe that if we&#39;re testing the API, we should rely on the API calls exclusively to compare the responses and eliminate the SQL altogether, so:</p><ol><li>Send POST request, receive response</li><li>Send GET request for the affected entity, receive response</li><li>Compare the two</li></ol><p>However, if the team states that the database structure must be verified, I do not know what solution to offer them instead of what we have currently.</p><p>I would appreciate any insight, suggestions or links to (preferably short) articles that tackle this issue.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>Sounds like a right convoluted codebase that is a nightmare. Is this a new thing, or a massive legacy piece of poop that you&#39;re maintaining? If the former - you got other problems.</p><p>However. There&#39;s nothing wrong with verifying the data store to see it contains what is expected. It is a kind of short-cut to verify future API calls will be correct (ie you say the correct data was returned from the API but the data stored was wrong - that suggests the wrong data will be returned eventually, possibly after the server is restarted and cache is cleared and re-populated with bad data that should have been saved correctly in the first place. Good luck finding that kind of error quickly, but if you check the DB, then it&#39;ll be obvious what has gone wrong straight away. Remember data in the DB is the golden data, everything else is secondary).</p><p>So you have issues creating the integration tests. You could make the codebase easier to generate these, so anyone making a DB schema change or code change then knows which integration tests to update. Someone always has to update tests when code changes, make sure its the person changing the code that is responsible for updating the tests.</p><p>I would try desperately to reduce the coupling inside the codebase though, if 1 table is handled by 1 module and that module only, it makes it much easier to know which tests are involved.</p><p>The next thing to do is to split the integration tests into smaller pieces that can be run immediately, like unit tests. Then you&#39;ll at least have some quicker feedback.</p><p>The 3rd option is not to check the results from the APIs but to have fixed data that runs against a fixed set of DB data, then you can simply check the DB against itself, rather than the returned API response.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../c-unit-testing-c-what-to-test/'>C++ &#8211; Unit testing C++: What to test</a></li><li class="list-group-item"><a href='../unit-testing-where-should-i-draw-the-line-between-unit-tests-and-integration-tests-should-they-be-separate/'>Unit-testing &#8211; Where should I draw the line between unit tests and integration tests? Should they be separate</a></li><li class="list-group-item"><a href='../integration-vs-functional-testing/'>Integration vs Functional Testing</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>