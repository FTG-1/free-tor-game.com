<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="https://free-tor-game.com/wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>TDD with repository pattern &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.min.js?ver=11.2.0' id='highlight-js'></script>     <script>( function( w, d, s, l, i ) {
				w[l] = w[l] || [];
				w[l].push( {'gtm.start': new Date().getTime(), event: 'gtm.js'} );
				var f = d.getElementsByTagName( s )[0],
					j = d.createElement( s ), dl = l != 'dataLayer' ? '&l=' + l : '';
				j.async = true;
				j.src = 'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
				f.parentNode.insertBefore( j, f );
			} )( window, document, 'script', 'dataLayer', ' ' );</script>      <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1069227 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="https://free-tor-game.com/3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="https://free-tor-game.com/contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1069227" class="post-1069227 software type-software status-publish hentry category-software tag-patterns-and-practices tag-repository tag-tdd"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">TDD with repository pattern</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">patterns-and-practices</span><span class="mr-2 badge badge-info">repository</span><span class="mr-2 badge badge-warning">tdd</span></p><div class="entry-content"><p>In my new project, I decided to try with TDD. And in very beginning I encountered a problem. First thing that I want to do in my application is to give ability to read data from data source. For this purpose, I want to use repository pattern.<br /> And now:</p><ul><li>If test are for real implementation of repository interface, I will be testing class that has access to database, and I know that I should avoid that.</li><li>If test are for not real implementation of repository pattern, I Will be testing well&#8230; just mock. There will be no any piece of production code tested in those unit tests.</li></ul><p>I&#39;m thinking about this from two days and still cannot come up with any reasonable solution. What I should do?</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>What a repository does is translate from your domain onto your DAL framework, such as NHibernate or Doctrine, or your SQL-executing classes. This means that your repository will call methods on said framework to perform its duties: your repository constructs the queries needed to fetch the data. If you&#39;re not using an ORM-framework (I hope your are...), the repository would be the place where raw SQL-statements are built.</p><p>The most basic of these methods is the save: in most cases this will simply pass the object from the repository onto the unit of work (or the session).</p><pre><code>public void Save(Car car)
{
    session.Save(car);
}
</code></pre><p>But let&#39;s look at another example, for example fetching a car by its ID. It might look like</p><pre><code>public function GetCarWithId(String id)
{
    return Session.QueryOver&lt;Car&gt;()
                    .Where(x =&gt; x.Id == id)
                    .SingleOrDefault();
}
</code></pre><p>Still not too complex, but you can imagine with multiple conditions (get me all the cars made after 2010 for all brands in the &#39;Volkswagen&#39; group) this gets tricky. So in true TDD fashion you need to test this. There are several ways to do this.</p><p><strong>Option 1: Mock the calls made to the ORM framework</strong></p><p>Sure, you can mock the Session-object and simply assert that the right calls are made. While this tests the repository, it is not really test-<em>driven</em> because you are just testing that the repository internally looks the way you want it to. The test basically says &#39;the code should look like this&#39;. Still, it is a valid approach but it feels like this kind of test has very little value.</p><p><strong>Option 2: (Re)build the database from the tests</strong></p><p>Some DAL-frameworks give you the ability to build the complete structure of the database based on the mapping files you create to map the domain onto the tables. For these frameworks the way to test repositories is often to create the database with an in-memory database in the first step of the test and add objects using the DAL-framework to the in-memory database. After this, you can use the repository on the in-memory database to test if the methods work. These tests are slower, but very valid and drive your tests. It does require some cooperation from your DAL-framework.</p><p><strong>Option 3: Test on an actual database</strong></p><p>Another approach is to test on an actual database and isolate the unittest. You can do this in several ways: surround your tests with a transaction, clean up manually (would not recommend as very hard to maintain), completely rebuild the database after each step... Depending on the application you are building this may or may not be feasible. In my applications I can completely build a local development database from source control and my unittests on repositories use transactions to fully isolate the tests from each other (open transaction, insert data, test repository, rollback transaction).  Every build first sets up the local development database and then performs transaction-isolated unittests for the repositories on that local development database. It&#39;s a little slower then a pure Unittest but the tests are extremely valuable and catch a lot of issues.</p><p><strong>Don&#39;t test the DAL</strong></p><p>If you are using a DAL framework such as NHibernate, avoid the need to test that framework. You could test your mapping files by saving, retrieving and then comparing a domain object to make sure everything is okay (be sure to disable any sort of caching) but it&#39;s not as required as a lot of other tests you should be writing. I tend to do this mostly for collections on parents with conditions on the children.</p><p>When testing the return of your repositories you could simply check to see if some identifying property on your domain object matches. This can be an id but in tests it&#39;s often more beneficial to check a human readable property. In the &#39;get me all the cars made after 2010....&#39; this could simply check that five cars are returned and the license plates are &#39;insert list here&#39;. Added benefit is that it forces you to think about sorting AND your test automatically forces the sorting. You&#39;d be surprised how many applications either sort multiple times (return sorted from the database, sort before creating a view object and then sort the view object, all on the same property <em>just in case</em>) or implicitly assume the repository sorts and accidentally remove that somehwere along the way, breaking the UI.</p><p><strong>&#39;Unit test&#39; is just a name</strong></p><p>In my opinion, unit tests should <em>mostly</em> not hit the database. You build an application so that every piece of code that needs data from a source does this with a repository, and that repository is injected as a dependency. This allows for easy mocking and all the TDD-goodness you want. But in the end you want to make sure that your repositories perform their duties and if the easiest way to do that is hit a database, well, so be it. I&#39;ve long let go of the notion that &#39;unit tests should not touch the database&#39; and learned that there are very real reasons to do this. But only if you can do this automatically and repeatedly. And weather we call such a test a &#39;unit test&#39; or an &#39;integration test&#39; is moot.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='https://free-tor-game.com/software/does-tdd-really-work-for-complex-projects/'>Does TDD really work for complex projects</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/unit-testing-how-should-you-tdd-a-yahtzee-game/'>Unit-testing &#8211; How should you TDD a Yahtzee game</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/a-weakness-of-the-tdd-method/'>A weakness of the TDD method</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/unit-testing-tdd-mock-call-verification-is-it-an-anti-pattern/'>Unit-testing &#8211; TDD Mock call verification &#8211; is it an anti-pattern</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/c-repository-pattern-exposing-data-context-to-underlying-layers/'>C# &#8211; Repository Pattern: Exposing Data Context to Underlying Layers</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/unit-testing-mockrepository-vs-test-database-for-unit-testing/'>Unit-testing &#8211; MockRepository vs Test Database for Unit Testing</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/tdd-red-green-refactor-and-if-how-to-test-methods-that-become-private/'>TDD Red-Green-Refactor and if/how to test methods that become private</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='http://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="https://free-tor-game.com/wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>