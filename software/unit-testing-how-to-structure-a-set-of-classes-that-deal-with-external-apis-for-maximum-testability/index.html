<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Unit-testing &#8211; How to structure a set of classes that deal with external APIs for maximum testability &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1086122 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1086122" class="post-1086122 software type-software status-publish hentry category-software tag-api tag-architecture tag-interfaces tag-unit-testing"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Unit-testing &#8211; How to structure a set of classes that deal with external APIs for maximum testability</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">api</span><span class="mr-2 badge badge-info">Architecture</span><span class="mr-2 badge badge-warning">interfaces</span><span class="mr-2 badge badge-primary">unit testing</span></p><div class="entry-content"><p>I&#39;m developing a set of classes designed to communicate with external APIs, and I&#39;m running into trouble with how to properly structure everything for proper loose coupling and unit testing.</p><p>Currently, each API we need to talk to has a distinct class, which implements an interface a bit like this:</p><pre><code>public interface IApiIntegration
{
    Task&lt;string&gt; SearchApi (List&lt;string&gt; searchValues);
    Task&lt;string&gt; GetFromApi(string idToGet);
    Task&lt;bool&gt; PostToApi(PostObject api);
}
</code></pre><p>Each api class inherits from a base abstract with implements this interface. That class also contains a number of helper functions which are only relevant to handling data coming to and from Apis.</p><p>Beneath the public <code>PostToApi</code> method of each class there are also a bunch of helper functions to build the object to be posted. These are often quite complicated, and could really do with testing. However, they&#39;re specific to the class in question and are thus private.</p><p>Inside every public function on IApiIntegration there is also, of course, a call to an external Api. For example it might look something like:</p><pre><code>public override async Task&lt;string&gt; GetFromApi(string id)
{
    string result = &#34;&#34;;
    string path = $&#34;{integration.RootUrl}items/{id}?username={integration.Username}&amp;key={integration.Password}&#34;;

    // client is a static instance of HttpClient
    HttpResponseMessage response = await client.GetAsync(path);
    if (response.IsSuccessStatusCode)
    {
        result = await response.Content.ReadAsStringAsync();
    }

    return result;
}
</code></pre><p>This leaves me with two problems:</p><p>1) It feels right that the helper methods in the base class and the individual classes should be open to unit testing, but also that they should be protected/private. Something, therefore, is clearly wrong with the structure.</p><p>2) It&#39;s obviously wrong to be testing external APIs so I need somehow to bypass or mock out those dependencies. But that&#39;s not possible in this structure.</p><p>How can I refactor and restructure this to ensure everything is open for unit tests?</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><blockquote><p>... there are also a bunch of helper functions to build the object to be posted. These are often quite complicated, and could really do with testing.</p></blockquote><p>Building an object, especially a complicated one, is logic which should not be hidden from the testing harness. A public function should exist that can build and return the object. It is effectively a constructor and likely should be a pure function (dependent only on input parameters and doesn&#39;t change any state.)</p><p>Similarly, processing API data is logic that should not be hidden. Again, a publicly available function that takes the kind of data you expect the API to emit and returns objects after processing the data is the best way to go.</p><p>Then your <code>getFromAPI</code> function will merely call the object builder to make the proper input and then call the data processor to create the correct objects. This function will end up being so simple that you shouldn&#39;t feel the need to test it (IMHO.)</p><p>The key point is that you should <em>not</em> feel the need to test the API functions. If you are feeling especially cautious, you might want to test that they are called by using a test double/mock, but that&#39;s about it. All <em>you</em> need to test is that you are creating valid object to pass into the API and that when the API returns valid data, you are processing that data correctly.</p><p>Some good videos on the subject:</p><ul><li><a href="https://www.youtube.com/watch?v=7AGQ9dhWCX0" rel="nofollow noreferrer">Test Doubles Are A Scam â€“ Matt Diephouse</a></li><li><a href="https://www.destroyallsoftware.com/talks/boundaries" rel="nofollow noreferrer">Boundries</a></li><li><a href="https://www.youtube.com/watch?v=VDfX44fZoMc" rel="nofollow noreferrer">J B Rainsberger Integrated Tests Are A Scam</a></li></ul></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../unit-testing-are-parsers-a-special-case-in-unit-testing/'>Unit-testing &#8211; Are parsers a special case in unit testing</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>