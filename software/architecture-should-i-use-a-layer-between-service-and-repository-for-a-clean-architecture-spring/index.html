<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Architecture &#8211; Should I use a layer between service and repository for a clean architecture &#8211; Spring &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1067238 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1067238" class="post-1067238 software type-software status-publish hentry category-software tag-architecture tag-persistence tag-services"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Architecture &#8211; Should I use a layer between service and repository for a clean architecture &#8211; Spring</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">Architecture</span><span class="mr-2 badge badge-info">persistence</span><span class="mr-2 badge badge-warning">services</span></p><div class="entry-content"><p>I&#39;m working in an architecture, it is going to offer a rest api for web client and mobile apps. I&#39;m using Spring(spring mvc, spring data jpa, &#8230;etc). The domain model is coded with JPA specification.</p><p>I&#39;m trying to apply some concepts of clean architecture (<a href="https://8thlight.com/blog/uncle-bob/2012/08/13/the-clean-architecture.html" rel="noreferrer">https://8thlight.com/blog/uncle-bob/2012/08/13/the-clean-architecture.html</a>). Not all, because I&#39;m going to keep the jpa domain model.</p><p>The actual flow through the layers is this:</p><p><em>Front end</em> &lt;&#8211;&gt; <em>API Service</em> -&gt; <em>Service</em> -&gt; <em>Repository</em> -&gt; <em>DB</em></p><ul><li><em>Front end</em>: web client, mobile apps</li><li><em>API Service</em>: Rest Controllers, here I use converters and dto&#39;s and call services</li><li><em>Service</em>: Interfaces with implementations and they contain business logic</li><li><em>Repository</em>: Repository interfaces with automatically implementations(done by spring data jpa) which contatin CRUD operations and maybe some sql queries</li></ul><p>My doubt: Should I use an extra layer between service and repository?</p><p>I&#39;m planning this new flow:</p><p><em>Front end</em> &lt;&#8211;&gt; <em>API Service</em> -&gt; <em>Service</em> -&gt; <em>Persistence</em> -&gt; <em>Repository</em> -&gt; <em>DB</em></p><p>Why to use this persistence layer? As it says in the clean architecture article I would like to have a service implementation(business logic or use case) that access an agnostic persistence layer. And not changes will be needed if I decide to use another &#34;data access&#34; pattern, for example if I decide to stop using repository.</p><pre><code>class ProductServiceImpl implements ProductService {
    ProductRepository productRepository;
    void save(Product product) {
        // do business logic
        productRepository.save(product)
    }
}
</code></pre><p>So I&#39;m thinking use a persistence layer like this:</p><pre><code>class ProductServiceImpl implements ProductService {
    ProductPersistence productPersistence;
    void save(Product product) {
        // do business logic
        productPersistence.save(product)
    }
}
</code></pre><p>and implementation of the persistence layer like this:</p><pre><code>class ProductPersistenceImpl implements ProductPersistence {
    ProductRepository productRepository;
    void save(Product product) {
        productRepository.save(product)
    }
}
</code></pre><p>So I only need to change the implementations of persistence layer, left the service without changes.Coupled with the fact that the Repository is related with the framework.</p><p>What do you think? Thanks.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><blockquote><p>Front end &lt;--&gt; API Service -&gt; Service -&gt; Repository -&gt; DB</p></blockquote><p>Right. This&#39;s, essentially, the design by layers proposed by Spring Framework. So you are in the &#34;<em>Spring&#39;s right way</em>&#34;.</p><p>Despite <em>Repositories</em>, these are frequently used as DAOs, the truth is that Spring developers took the notion of <em>Repository</em> from Eric Evans&#39; DDD. Repository interfaces will look often very similar to DAOs because of the CRUD methods and because many developers strive to make repositories&#39; interfaces so generics that, in the end, they have no difference with the <em>EntityManager</em> (the true DAO here)<sup>1</sup>. Repositories tho add other abstractions like <em>queries</em> or <em>criteria</em> to enhance the data access.</p><p>Translated into Spring components, your design is similar to</p><pre><code>@RestController &gt; @Service &gt; @Repository &gt;  EntityManager
</code></pre><p>The <em>Repository</em> is already an abstraction in between services and data stores. When we extend Spring Data JPA repository interfaces, we are implementing this design implicitly. When we do this, we are paying a tax: a tight coupling with Spring&#39;s components. Additionally, we break LoD and YAGNI by inheriting several methods we might not need or wish not to have. Moreover, we are (implicitly) assuming that the persistence data model is also the domain data model. This is quite the endemic of Spring, after many years working with Spring frameworks, you end up making everything data-centric.</p><p>That said, extending Spring Data JPA repositories is not mandatory. We implement a more plain and custom hierarchy of classes.</p><pre class="lang-java prettyprint-override"><code>    @Repository
    public class DBRepository implements MyRepository{
        private EntityManager em;
        
        @Autowire
        public MyRepository (EntityManager em){    
             this.em = em;
        }

        //Interface implentation
        //...
    }
</code></pre><p>Changing the data source now just takes a new implementation which replaces the <em>EntityManager</em> with a different <em>data source</em>.</p><pre class="lang-java prettyprint-override"><code>    //@RestController &gt; @Service &gt; @Repository &gt;  RestTemplate

    @Repository
    public class WebRepository implements MyRepository{
        private RestTemplate rt;
    
        @Autowire 
        public WebRepository (RestTemplate rt){    
             this.rt = rt;
        }

        //Interface implentation
        //...
    }
</code></pre><pre class="lang-java prettyprint-override"><code>    //@RestController &gt; @Service &gt; @Repository &gt;  File

    @Repository
    public class FileRepository implements MyRepository{
       
        private File file; 
        public FileRepository (File file){    
            this.file = file;
        }

        //Interface implentation
        //...
    }
</code></pre><pre class="lang-java prettyprint-override"><code>    //@RestController &gt; @Service &gt; @Repository &gt;  SoapWSClient

    @Repository
    public class WSRepository implements MyRepository{
       
        private MyWebServiceClient wsClient; 

        @Autowire
        public WSRepository (MyWebServiceClient  wsClient){    
               this.wsClient = wsClient;
        }

        //Interface implentation
        //...
    }
</code></pre><p>and so on.<sup>2</sup></p><p>Back to the question, I don&#39;t think you need more layers. The layer you propose is going to end up as a proxy in between <em>services</em> and <em>repositories</em> or as a <em>pseudo-service-repository</em> where to place code you are not sure whether it belongs to the business or to the persistence.</p><hr/><p><sup>1: Unlike many developers think, repository interfaces can be totally different from each other because each repository serves different domain needs. In Spring Data JPA, the role <em>DAO</em> is played by the <em>EntityManager</em>. It manages the sessions, the access to the <em>DataSource</em>, <em>mappings</em>, etc.</sup></p><p><sup>2: A similar solution is enhancing Spring&#39;s repository interfaces mixing them up with custom interfaces. For more info, look for <em>BaseRepositoryFactoryBean</em> and <em>@NoRepositoryBean</em>. However, I have found this approach cumbersome and confusing. </sup></p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../architecture-hooking-up-a-business-layer-and-repository-using-unit-of-work-pattern/'>Architecture &#8211; Hooking up a Business Layer and Repository using Unit of Work Pattern</a></li><li class="list-group-item"><a href='../architecture-repository-pattern-with-service-layer-too-much-separation/'>Architecture &#8211; Repository pattern with service layer &#8211; too much separation</a></li><li class="list-group-item"><a href='../mvc-application-service-layer-calling-database-functions-bad-architecture/'>Mvc &#8211; Application service layer calling database functions. Bad architecture</a></li><li class="list-group-item"><a href='../architecture-calling-service-and-repository-layer-from-controller/'>Architecture &#8211; Calling service and repository layer from controller</a></li><li class="list-group-item"><a href='../architecture-clean-architecture-gateway-layer-depends-on-outer-layer/'>Architecture &#8211; Clean Architecture Gateway layer depends on outer layer</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>