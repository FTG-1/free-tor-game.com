<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Design &#8211; System Design: Scalable Chat Server &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1067926 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1067926" class="post-1067926 software type-software status-publish hentry category-software tag-architecture tag-chat tag-design tag-scalability"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Design &#8211; System Design: Scalable Chat Server</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">Architecture</span><span class="mr-2 badge badge-info">chat</span><span class="mr-2 badge badge-warning">design</span><span class="mr-2 badge badge-primary">scalability</span></p><div class="entry-content"><p>Suppose you were asked to design a scalable chat server with the following requirements:</p><ol><li>The main use case is: player A sees B online, A sends a message to B, B receives it.</li><li>The secondary use case is: player A sees B <em>offline</em>, A sends a message to B. When B comes back online, B receives the message. (No push notifications).</li><li>The goal is to minimize latency. Speed matters.</li><li>The messages should arrive in order. We cannot lose messages but receiving duplicates once in a while is fine.</li><li>Just text data, no binary data.</li><li>No need to store chat history. Once sent, the messages can be destroyed.</li></ol><p>I&#39;ve been reading this article: <a href="http://highscalability.com/blog/2014/10/13/how-league-of-legends-scaled-chat-to-70-million-players-it-t.html" rel="noreferrer">How League Of Legends Scaled Chat To 70 Million Players</a> and I think I missed the core architecture they used in the game. But anyway here is my &#34;thought process&#34;. Can someone have a look at it?</p><ul><li>If the secondary use case didn&#39;t exist, I wouldn&#39;t have to store anything. I think I could use a p2p network, wherein a user regularly sends a ping message &#34;i&#39;m online&#34; to all his friends to notify of presence.</li><li>But since I have to store messages to be able to deliver them later, I need my own servers that store user presence, user friendship lists, and messages.</li><li>The goal of minimized latency can be achieved by placing servers close to the users. This means that there will be more than one server so they need to stay in sync. Also, we need to load balance them so that one server does not store everything.</li><li>I&#39;ve read somewhere on the Internet that a way to load balance the servers is to assign a server to each user. So for example server 1 gets assigned everything related to user A, and server 2 gets assigned everything related to user B. We could decide this by proximity.</li><li>When A sends something to B, there has to be a way to dispatch the message to server 2. Maybe use a service bus to communicate servers.</li><li><p>So the flow would be something like this:</p><ol><li>A writes message &#34;Hi B!&#34;</li><li>Server 1 receives message and B. Since it does not find B in his user base, he forwards the message to the service bus. He stores a copy of the message.</li><li>The service bus requests all servers to look for user B.</li><li>Server 2 replies that he has B in his user base.</li><li>Server 2 receives the message and stores it.</li><li>Server 2 sends message to user B.</li><li>Server 2 signals to the service bus that the message was sent. He destroys the message.</li><li>Server 1 destroys his copy of the message.</li></ol></li><li><p>If B were offline, everything up to step 5 would stay the same. The difference is that server 1 can destroy his copy of the message but server 2 cannot.</p></li><li>Now, storage&#8230; My guess is that each server should have their own persistent storage, but I&#39;ve no idea what should be optimized here (speed of reads? speed of writes?). Also I&#39;m not sure if a MySQL store or a NoSQL store would be better. Since NoSQL is optimized to be partitioned and there&#39;s no need here I guess MySQL would be enough.</li><li>If a server crashes we need a way to failover quickly. I suppose we could place like a &#34;primary&#34; and &#34;secondary&#34; server in each location, the primary would be connected to primary storage and the secondary to replicated data.</li></ul><p>So the overall architecture would look like this:</p><p><a href="../../../i.stack.imgur.com/0YrV6.png" rel="noreferrer"><img src="../../../i.stack.imgur.com/0YrV6.png" alt="architecture"/></a></p><p>I realize I am missing many many things here, did I miss something obvious? Is there any part of my thought process just plain wrong?</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>You <em>can</em> use a P2P network, but it&#39;s architecturally interesting.</p><p>Using something like Kademlia as a DHT for peer discovery means talking to a limited number of nodes before reaching your target. If you stored your message at each of these hops, you&#39;d have redundancy for your message store that may be reliable enough for your requirements. Offline delivery would mean periodic forwarding attempts for each buffered message. That would guarantee fairly low latency in terms of <em>peer discovery</em>, which is probably the most costly part of the problem.</p><p>Once a direct P2P connection is established, you&#39;re clearly in online mode and can skip offline storage (or not).</p><p>You can also run nodes that persistently store messages, but otherwise act as regular DHT participants. That would give more reliability, at the cost of only running a handful of nodes.</p><p>As @aridlehoover writes, though, there are so many possible answers that you can&#39;t really provide a final one.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../design-ios-chat-application-design-sending-relaying-the-message-over-to-the-end-user/'>Design &#8211; iOS chat application design, sending/relaying the message over to the end user</a></li><li class="list-group-item"><a href='../c-push-response-to-the-user-for-which-the-request-is-created-in-asp-net-chat-server/'>C# &#8211; Push response to the user for which the request is created in Asp.Net (Chat Server)</a></li><li class="list-group-item"><a href='../web-development-chat-service-database-design/'>Web-development &#8211; Chat-service database design</a></li><li class="list-group-item"><a href='../php-the-best-way-to-create-a-php-chat-system/'>Php &#8211; The best way to create a PHP chat system</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>