<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>C# &#8211; What am I missing in the (mis)understanding of IoC/DI/Castle Windsor &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1066843 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1066843" class="post-1066843 software type-software status-publish hentry category-software tag-asp-net-mvc-web-api tag-c tag-dependency-injection tag-inversion-of-control"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">C# &#8211; What am I missing in the (mis)understanding of IoC/DI/Castle Windsor</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">asp.net-mvc-web-api</span><span class="mr-2 badge badge-info">c</span><span class="mr-2 badge badge-warning">dependency-injection</span><span class="mr-2 badge badge-primary">inversion-of-control</span></p><div class="entry-content"><p>Okay, so here&#39;s how I understand IoC and DI in Web API to work when using Castle Windsor.</p><p>Note, though, that my confidence that I understand it as I should, though, falls somewhere between my confidence I could best Dennis Rodman in a one-on-one basketball game and my confidence in his sanity.</p><p>Another way to put it is to say that I have spent the last several days reading up on IoC/DI/Castle Windsor with Web API and experimenting with it, but I still feel like wearily responding, &#34;All down but nine, pard; set &#39;em up on the other alley.&#34;</p><p>I have several more specific questions on Stack Overflow about it, such as <a href="https://stackoverflow.com/questions/20914635/how-do-i-connect-the-various-pieces-of-my-web-api-castle-windsor-di-code">this one</a>, but am not yet much clearer about it.</p><p>So I&#39;m going to &#34;talk out loud&#34; and hope that somebody responds with something that will refine my understanding, shed some light on this opaque (to me) subject, or help unravel this Gordian knot.</p><p>Point: The basis of IoC/DI lies in passing interfaces to constructors, so that the class with the constructor does not have to instantiate its own objects; in fact, has no need to know the concrete component/class.</p><p>Point: To set this up, you need code like so in your Controllers:</p><pre><code>private readonly IDepartmentRepository _deptsRepository;

public DepartmentsController(IDepartmentRepository deptsRepository)
{
    if (deptsRepository == null)
    {
        throw new ArgumentNullException(&#34;deptsRepository is null&#34;);
    }
    _deptsRepository = deptsRepository;
}
</code></pre><p>Point: Some class that implements IDepartmentRepository is passed to the DepartmentsController constructor</p><p>Point: The coder doesn&#39;t do that explicitly &#8211; the IOC container (Castle Windsor, in this case) does that &#34;automatically&#34; by intercepting the Web API routing mechanism with its own, as with code like this, in global.asax.cs:</p><pre><code>GlobalConfiguration.Configuration.Services.Replace(
                typeof(IHttpControllerActivator), new WindsorCompositionRoot(_container));
</code></pre><p>Point: global.asax.cs&#39; Application_Start() gets the ball rolling and calls the Installer/Registrar with code such as:</p><pre><code>protected void Application_Start()
{            
    AreaRegistration.RegisterAllAreas();

    WebApiConfig.Register(GlobalConfiguration.Configuration);
    FilterConfig.RegisterGlobalFilters(GlobalFilters.Filters);
    RouteConfig.RegisterRoutes(RouteTable.Routes);
    BundleConfig.RegisterBundles(BundleTable.Bundles);

    ConfigureWindsor(GlobalConfiguration.Configuration);
}

public static void ConfigureWindsor(HttpConfiguration configuration)
{
    _container = new WindsorContainer();
    _container.Install(FromAssembly.This());
    _container.Kernel.Resolver.AddSubResolver(new CollectionResolver(_container.Kernel, true));
    var dependencyResolver = new WindsorDependencyResolver(_container);
    configuration.DependencyResolver = dependencyResolver;
}   
</code></pre><p>Point: Lots of other Castle Windsor scaffolding has to be set up for this. Specifically, classes need to be &#34;installed&#34; (registered &#8211; I think registered would have been a better/more easily grokkable term for it).</p><p>This is one of my major &#34;say what?&#34;/headscratching areas. I don&#39;t know if that registration code should look like this:</p><pre><code>public object GetService(Type serviceType)
{
    return _container.Kernel.HasComponent(serviceType) ? _container.Resolve(serviceType) : null;
}

public IEnumerable&lt;object&gt; GetServices(Type serviceType)
{
    if (!_container.Kernel.HasComponent(serviceType))
    {
        return new object[0];
    }

    return _container.ResolveAll(serviceType).Cast&lt;object&gt;();
}
</code></pre><p>&#8230;or like this:</p><pre><code>public class ApiControllersInstaller : IWindsorInstaller
{
    public void Install(Castle.Windsor.IWindsorContainer container, Castle.MicroKernel.SubSystems.Configuration.IConfigurationStore store)
    {
        container.Register(Classes.FromThisAssembly() // should it be Types instead of Classes?
         .BasedOn&lt;ApiController&gt;()
         .LifestylePerWebRequest());
    }
}
</code></pre><p>&#8230;or like this:</p><pre><code>public class ServiceInstaller : IWindsorInstaller
{
    public void Install(IWindsorContainer container, IConfigurationStore store)
    {
        container.Register(
            Component.For&lt;IDeliveryItemRepository&gt;().ImplementedBy&lt;DeliveryItemRepository&gt;().LifestylePerWebRequest(),
            Component.For&lt;IDeliveryRepository&gt;().ImplementedBy&lt;DeliveryRepository&gt;().LifestylePerWebRequest(),
            Component.For&lt;IDepartmentRepository&gt;().ImplementedBy&lt;DepartmentRepository&gt;().LifestylePerWebRequest(),
            Component.For&lt;IExpenseRepository&gt;().ImplementedBy&lt;ExpenseRepository&gt;().LifestylePerWebRequest(),
            Component.For&lt;IInventoryItemRepository&gt;().ImplementedBy&lt;InventoryItemRepository&gt;().LifestylePerWebRequest(),
            Component.For&lt;IInventoryRepository&gt;().ImplementedBy&lt;InventoryRepository&gt;().LifestylePerWebRequest(),
            Component.For&lt;IItemGroupRepository&gt;().ImplementedBy&lt;ItemGroupRepository&gt;().LifestylePerWebRequest());
    }
}
</code></pre><p>&#8230;or elsewise&#8230;</p><p>Point: Once all this is set up, and the Controllers (and Repositories? Is there more that do I have to about them, to make them safe for CW?) have been registered by the Castle Windsor routing engine, a call to my Web API app like:</p><pre><code>http://platypus:28642/api/Departments
</code></pre><p>&#8230;will be resolved to a &#34;component&#34; (concrete class) that implements IDepartmentRepository. CW will be able to figure that out, as long as I have one class that implements IDepartmentRepository, that that is the one to silently pass to the Controller&#39;s constructor which takes an arg for a class that implements IDepartmentRepository.</p><p>But&#8230;what if there are are N classes that implement IDepartmentRepository? How does CW know which one to pass to the Controller&#39;s constructor? How can I, the lowly human in this meeting of silicon and pink squishy stuff, designate which of the N I want CW to pass to the constructor?</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>I have experience with Ninject, not Castle Windsor, but the principles should be the same.</p><p>To understand dependency injection, it helps to recall how you wrote code without it. Typically, the <code>DepartmentsController</code> constructor would look like something like this:</p><pre><code>public DepartmentsController()
{
    _repository = new DepartmentRepository();
}
</code></pre><p>The controller depends on the repository, and by placing it in the constructor we ensure that every <code>DepartmentsController</code> is instantiated with a repository and begins its life in a valid state. By doing this, however, we make it more difficult to later swap one implementation of <code>DepartmentRepository</code> for another. In particular, if we want to isolate the <code>DepartmentsController</code> and test it independently, we&#39;re in trouble. How do we test this class without invoking actual calls to the database through <code>DepartmentRepository</code>?</p><p>Your first example improves on this scenario by creating a &#34;seam&#34; between the objects: a point where the two are glued or stitched together that can be separated easily, especially for tests. Instead of creating the <code>DepartmentRepository</code> itself, your controller can ask for it:</p><pre><code>public object GetService(Type serviceType)
{
    return _container.Kernel.HasComponent(serviceType) ? _container.Resolve(serviceType) : null;
}
</code></pre><p>This is called the Service Locator pattern, and some consider it bad practice. By exposing Castle Windsor in this way, you have actually lost some of its benefits. In particular, your <code>DepartmentsController</code> now depends on the Service Locator and its <code>GetService</code> method. I won&#39;t cover all of the supposed disadvantages of Service Locators, but consider what happens when your application grows and you now have numerous classes (potentially all of them) dependent upon this single class.</p><p>Your third example improves upon the Service Locator pattern by making the container invisible to your class:</p><pre><code>public DepartmentsController(IDepartmentRepository repository)
{
    if (repository == null)
        throw new ArgumentNullException(&#34;repository&#34;);

    _repository = repository;
}
</code></pre><p>Notice how this version has no knowledge of the kernel / container or a service locator. Instead, we have made its true dependencies explicit in the constructor rather than the means to those dependencies. In fact, by writing your classes this way, you can construct entire class libraries that are ignorant of Castle Windsor and will work perfectly fine with Ninject, another DI framework, or no container at all, without modifying the code.</p><p>How you actually register your components (the difference between examples two and three) is partly a matter of scale.</p><pre><code>container.Register(
        Component.For&lt;IDeliveryItemRepository&gt;().ImplementedBy&lt;DeliveryItemRepository&gt;().LifestylePerWebRequest(),
        Component.For&lt;IDeliveryRepository&gt;().ImplementedBy&lt;DeliveryRepository&gt;().LifestylePerWebRequest(),
        Component.For&lt;IDepartmentRepository&gt;().ImplementedBy&lt;DepartmentRepository&gt;().LifestylePerWebRequest(),
...
</code></pre><p>is fine for a smaller application. If the number of classes grows, you have to stomach a never ending list of bindings or find a better method. One improvement is to favor convention over configuration: if Castle Windor assumes every <code>IDeliverItemRepository</code> has a <code>DeliveryItemRepository</code> implementation, the bindings above can be skipped. However, you haven&#39;t solved anything if most of your classes require exceptional configuration; you still have a long, omniscient kernel / container registration method.</p><p>Instead, you should probably explore something like your second example. This way, your <code>ConfigureWindsor</code> method can use reflection to find any <code>IWindsorInstaller</code>s present in your application without knowing about specific interfaces or implementations. You can break all of your bindings into separate modules (Ninject&#39;s name for this concept) that are discovered at runtime.</p><p>To address your last question: Castle Windsor won&#39;t know which of your <code>N</code> implementations to choose without you telling it. You can accomplish this through a mixture of the concepts discussed above: primarily by convention, but with <code>IWindsorInstaller</code>s when needed to specify important details like lifecycle and <a href="http://docs.castleproject.org/Windsor.Conditional-component-registration.ashx">conditional bindings</a>.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../architecture-understanding-the-dip-di-ioc-theory/'>Architecture &#8211; Understanding the DIP, DI, IoC theory</a></li><li class="list-group-item"><a href='../object-oriented-when-to-use-interfaces-unit-testing-ioc/'>Object-oriented &#8211; When to use interfaces (unit testing, IoC?)</a></li><li class="list-group-item"><a href='../object-oriented-best-practice-in-helper-util-methods-ioc-container-or-static-methods/'>Object-oriented &#8211; Best practice in helper/util methods: IoC container or static methods</a></li><li class="list-group-item"><a href='../c-dependency-injection-for-a-library-with-internal-dependencies/'>C# &#8211; Dependency injection for a library with internal dependencies</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>