<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Design &#8211; How to architect P2P discovery &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1086935 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1086935" class="post-1086935 software type-software status-publish hentry category-software tag-design tag-networks tag-p2p"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Design &#8211; How to architect P2P discovery</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">design</span><span class="mr-2 badge badge-info">networks</span><span class="mr-2 badge badge-warning">p2p</span></p><div class="entry-content"><p>I&#39;ve never really done network programming so this is all new to me. What I&#39;m attempting to make is a Peer to Peer &#34;chat&#34; client. The idea is that anyone can connect to someone whose IP they know. All chat messages are to be distributed to everyone.</p><p>What I&#39;m getting stuck on is the peer discovery. What I&#39;ve done so far is:</p><ol><li>App has an IP of a known person (user provided)</li><li>Connects to known IP</li><li>Known IP provides it&#39;s list of known Peers; we store it in <code>peer list</code></li><li>Discovery loop:<ol><li>Make a local copy of <code>peer list</code></li><li>For each Peer in <code>local peer list</code><ol><li>Request Peer list (i.e. step 2 + 3)<ul><li>If error, remove this peer from original <code>peer list</code></li><li>Otherwise, add new peers to original <code>peer list</code></li></ul></li></ol></li><li>Queue another Discovery Loop in 1min</li></ol></li></ol><p>The listening for connections in step 3 and the discovery loop are asynchronous.</p><p>The reason a copy is made in the first place is due to some other design decisions for down the road.</p><p>The problem is that if I introduce a client with a bad peer on it&#39;s <code>peer list</code>, i.e. you can&#39;t connect to it, what happens is that this Peer is passed via step 3 when serving the known <code>peer list</code> and then other clients have it in theirs. They propagate this bad peer and later on, during the Discover Loop, remove that peer. But then, they will do another Discover Loop and will receive that Peer from someone else again.</p><p>The end result is that bad peer never leaves the network.</p><p>One option I can think of is a vague idea of having Peer &#34;health&#34; that each client keeps track of separately so that they can ignore peers provided on someone elses list. However, this would, I think, need to be somewhat &#34;timed&#34; so that when someone disconnects they aren&#39;t shut out of the network forever.</p><p>The other idea I had was for a broadcast message to all known peers when a bad peer is encountered. However, I didn&#39;t like this idea because it leaves it open for someone to make a different client that&#39;s job is to poison the network by insisting peers are bad. This would then require me to have peers check that a remove request is genuine by also attempting to connect to his peer immediately.</p><p>I&#39;m looking for opinions on the two options above.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>I&#39;d be worried about the overhead in transmitting the whole list of peers each time.  If you have <code>N</code> users, and during each &#39;discovery loop&#39; each peer connects to the rest of the <code>N</code> peers and downloads a list of <code>N</code> peers, then the bandwidth dedicated to synchronizing the peers list grows like <code>O(N^3)</code>!  By using some tricks to only transmit the peers that differ between the two you can get it down to <code>O(N^2 log N)</code> or <code>O(N^2)</code>, but that&#39;s still pretty steep.</p><hr/><p>I heard some time ago of a synchronization model designed to avoid this problem.  I don&#39;t remember the name so I&#39;ll call it &#34;rumor mill synchronization.&#34;</p><p>Your client maintains three lists of peers:</p><ul><li><p><strong>Known good</strong> peers.</p></li><li><p><strong>Recently changed</strong> peers.  Each peer in this list is associated with a boolean &#39;added/removed&#39; flag and a (local) time.</p></li><li><p><strong>Possibly changed</strong> peers.  Each peer is this list also has the &#39;added/removed&#39; flag, and also has an associated counter.</p></li></ul><p>You also choose a length of time for changes to be considered &#39;new,&#39; and a required number of &#39;votes&#39; before you commit a change (<code>K</code>).  I would suggest that the former is fixed (based on your testing) and the latter is user-configurable (so they can set how trusting they are of the network).  Here is the procedure:</p><ol><li><p>You start off with the addresses of a few peers that you think are good; these might be your servers&#39; addresses preloaded into the app, or a set of peers that the user chooses.  Query a number of them, asking to download their entire list of <em>known good</em> peers.  Check them against each other so that an attacker will have a more difficult time adding malicious addresses.  (This takes <code>O(KN)</code> bandwidth.)</p><p>Assuming that you trust most of the peers you just talked to, you can add peers that are in a majority of their lists to <em>your</em> list of <em>known good</em> peers.  Now we start the discovery loop.</p></li><li><p>Each cycle, you connect to a new peer from your <em>known good</em> list, and ask for their <em>recently changed</em> list.  (If the network is relatively static, this list should be less than <code>O(N)</code>.)  If the network is large you can choose a random peer for this step, otherwise you should loop through the (randomly ordered) list.  The goal is to talk to as many <em>different</em> peers as possible without biasing towards a certain subset.</p><ul><li><p>If they don&#39;t respond, remove them from your <em>known good</em> list and add them to your <em>recently changed</em> list as &#39;removed&#39; (overwriting an &#39;added&#39; entry for that peer if it exists; don&#39;t forget to update the time too).</p></li><li><p>Otherwise, go through the received peers one by one.</p><ul><li><p>If they&#39;re in your <em>known good</em> list, there&#39;s nothing to do.</p></li><li><p>If they&#39;re in your <em>possible changes</em> list, increment their counter; otherwise, add them to the list with their counter at one.</p></li></ul></li></ul></li><li><p>Check the list of <em>possible changes</em> to see if any have surpassed <code>K</code> votes; if so, add them to your list of <em>recently changed</em>, <em>and</em> add or remove them from your <em>known good</em> list as appropriate.</p></li><li><p>Check the list of <em>recent changes</em> to see if any changes on this list are &#39;stale,&#39; i.e. older than your time threshold.  If so, remove them.</p></li><li><p>Wait for a little, then go back to step 2.  You should also repeat step 1 occasionally with random peers from your &#39;known good&#39; list; treat this like step 2 but download their list of <em>known good</em> peers, not <em>recently changed</em> peers.</p></li><li><p>If you <em>receive</em> a connection from an unknown peer, treat this as in step 3, adding them to your <em>recently changed</em> and <em>known good</em> peers.</p></li></ol><p>Note that this approach only works if the network is relatively static, otherwise the list of recent changes will encompass almost all the clients.</p><p>The implementation details might be a bit off (it was a long time ago that I read about this) but the idea is there; basically you ring up as many peers as you can and ask, &#39;hear about any new people?&#39;</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../architecture-how-to-architect-a-p2p-application/'>Architecture &#8211; How to architect a P2P application</a></li><li class="list-group-item"><a href='../c-how-does-a-pure-p2p-node-connect-to-other-nodes/'>C# &#8211; How does a pure P2P node connect to other nodes</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>