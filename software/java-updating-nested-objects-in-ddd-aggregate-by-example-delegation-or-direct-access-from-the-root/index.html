<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Java &#8211; Updating nested objects in DDD Aggregate by example: delegation or direct access from the root &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1074907 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1074907" class="post-1074907 software type-software status-publish hentry category-software tag-aggregate tag-architecture tag-domain-driven-design tag-java tag-object-oriented-design"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Java &#8211; Updating nested objects in DDD Aggregate by example: delegation or direct access from the root</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">aggregate</span><span class="mr-2 badge badge-info">Architecture</span><span class="mr-2 badge badge-warning">domain-driven-design</span><span class="mr-2 badge badge-primary">java</span><span class="mr-2 badge badge-danger">object-oriented-design</span></p><div class="entry-content"><h2>The example domain problem</h2><p><a href="../../../i.stack.imgur.com/M93TN.png" rel="nofollow noreferrer"><img src="../../../i.stack.imgur.com/M93TN.png" alt="ddd-domain-problem"/></a></p><p>There is a student attendance tracking system that keeps records of student attendances of <code>ExerciseGroup</code>s.</p><ul><li><code>Course</code> is a top-level component, AR, describes a generic info about the learning course (name, description)</li><li>Every <code>Course</code> has <code>ExerciseGroup</code>s that describe groups where students can practice. <code>ExerciseGroup</code> holds the name of the group and list of signed-up students and tutors. <code>ExerciseGroup</code> has no sense outside the <code>Course</code> (from the domain), therefore it&#39;s under the <code>Course</code> AR.</li><li>Every <code>ExerciseGroup</code> contains a list of <code>Sessions</code> that describe occurrings of the <code>ExerciseGroup</code> a <code>User</code> can attend. Is defined by (datetimeBegins, datetimeEnds and a set of <code>Attendance</code> objects).</li><li><code>Attendance</code> is a VO record that holds info about student attendings. Contains a reference to the <code>User</code> (via Id) and some statistical data.</li></ul><h2>What approaches I&#39;ve used so far:</h2><p>1. Reference by identity outside the AR.</p><pre><code>class Group {
    // ...
    Set&lt;UserId&gt; studentIds;
    Set&lt;UserId&gt; tutorIds;
}
</code></pre><p>2. Direct references inside the AR.</p><pre><code>class Course {
    // ....
    List&lt;Group&gt; groups;
}
</code></pre><p>3. <code>ExerciseGroup</code>/<code>Session</code> mutable operations done only by <code>Course</code> AR.</p><p>Following the idea that:</p><blockquote><p>aggregate roots exist to protect the data within them&#8230; [you must not]<br /> tear the aggregate roots internal structures and do operations on the<br /> internals directly without incorporating the aggregate root, [since] the<br /> aggregate root can no longer validate the operation is valid.</p><p>@david-packer (<a href="https://softwareengineering.stackexchange.com/a/354667/169341">https://softwareengineering.stackexchange.com/a/354667/169341</a>)</p></blockquote><p>I have the following mutable operations in AR:</p><pre><code>class Course {
    ExerciseGroup addExerciseGroup(String exGroupName...);
    void removeExerciseGroup(ExerciseGroupId exGroupId);
    void attendExerciseGroupSession(ExerciseGroupId exGroupId, SessionId sessionId, UserId userId...);
    // etc
}
</code></pre><p>While still having read-only access to the underling entities:</p><pre><code>class Course {
    List&lt;ExerciseGroup&gt; exerciseGroups() {
        // save because all mutable operators in ExerciseGroup 
        // are `protected` and available nobody but Course AR.
        return unmodifiableList(this.exerciseGroups); 
    }
    // etc
}
</code></pre><h2>The problems and questions</h2><ol><li>What is your overall personal feeling about the chosen domain model? Does it make sense for you? Isn&#39;t it too fat?</li><li><p>Should I delegate underlying entities of the AR to mutate its children or put the whole logic in the AR?<br /> For example, I can delegate <code>ExerciseGroup</code> to ask <code>Session</code> to create <code>Attendance</code>:</p><pre><code>class Course {
    void attendExerciseGroupSession(ExerciseGroupId gId, SessionId sId, UserId uId) {
        this.eGroups.getById(gId).attendSession(sId, uId);
    }
}

class ExerciseGroup {
    void attendSession(SessionId sessionId, UserId userId) {
        this.sessions.getById(sessionId).attend(userId);
    }
}

class Session {
    void attend(UserId userId) {
        this.attendances.add(new Attendance(userId, LocalDateTime.now()));
    }
}
</code></pre><p>Or I can create Attendance directly in <code>Course</code> AR.</p><pre><code>class Course {
    void attendExerciseGroupSession(ExerciseGroupId exGroupId, SessionId sessionId, UserId userId) {
        this.exerciseGroups.getById(exGroupId)
            .sessions().getById(sessionId)
                .attendances().add(new Attendance(userId, LocalDateTime.now()));
    }
}
</code></pre></li></ol><p>While the first approach does make more sense for me, it became extremely complicated to not forget to &#34;propagate&#34; some methods to the top AR. One change in the <code>Session</code> (e.g. change void in <code>attend(.)</code> to <code>Attendance</code>) requires changes in all top-level classes.</p><ol start="3"><li>How to cope with deep nested objects in terms of AR method complexity? Let&#39;s say there will appear one more object btw <code>Session</code> and <code>Attendance</code> &#8211; <code>Meeting</code>, then method in <code>Course</code> may become <code>addExerciseGroupSessionMeetingAttendance(ExerciseGroup gId, SessionId sId, MeetingId mId, AttendanceParams.. o)</code> that is extremely long to me and unclear in terms of (2)</li><li>Should <code>addAREntity(EntityParam1,EntityParam1N)</code> return <code>EntityId</code> or it&#39;s valid to return the whole <code>Entity</code> (if it can be assured it is unmodifiable outside of the domain e.g. all mutable methods are <code>protected</code>)?<br /> The problem with returning just <code>EntityId</code> is that usually you&#39;ll require the while object right after creating the object.</li></ol><p>For example, an endpoint <code>POST /courses/{courseId}/groups/{groupId}/sessions/</code> is very likely should return a complete <code>Session</code> object (e.g. to get all autogenerated data [id?] not included in DTO given to the endpoint). Receiving a <code>SessionId</code> from <code>Course#addGroupSession(dto.param1(),..)</code> means I need <code>course.group(groupId).session(sessionId)</code> fulfill this requirement.</p><ol start="5"><li>Will it be ok to return AR&#39;s users nested entities if we are sure they are immutable from outside (e.g. all mutable methods are protected).</li></ol><p>In other words, is it okay to do <code>course.getGroup(groupId).getSession()(sessionId)</code> from the example above (assuming <code>.group(groupId)</code> and <code>.session(sessionId)</code> return unmodifiable objects), or it&#39;s better to have <code>course.getGroupSession(groupId, sessionId)</code>?</p><p>Thank you.</p><h1>A day after (update)</h1><p>I revisited my model and found it very fat, hard to maintain and designed with false invariants in mind that caused transactional failures. Nothing about creating a new session item should logically interfere with editing a course for example.</p><p>What I came up with after deeper transactional analysis is the following model (clickable):<br /> <a href="../../../i.stack.imgur.com/ODGU6.png" rel="nofollow noreferrer"><img src="../../../i.stack.imgur.com/ODGU6.png" alt="enter image description here"/></a></p><p>The question I was using to separate boundary context is: can/should this and that in the same transaction? When you Session#attend, should it be done in the same transaction with Course [blocked]? Definitely it&#39;s not etc.</p><p>To fulfil the condition that session should not be outside the Group, I just put GroupId to the Session&#39;s controller and hope for eventual consistency ðŸ™‚</p><h2>Questions left</h2><ol><li><p>Will it be ok to return nested entities from an AR if we are sure they are immutable from outside directly (e.g. all mutable methods are protected) [not by AR, the owner of the entity].<br /> In other words, is ok to do this:</p><pre><code>class Course {
   List&lt;Group&gt; groups;
   List&lt;Group&gt; getGroups() {return Collections.unmodifiableList(groups);}
   public setGroupName(GroupId gi, String name) {
      this.findGroup(gi).setName(name);
   }
}

class Group {
   String name;
   // Protected so Course#getGroups users won&#39;t be able to mutate Group
   protected setName(String name) {
      this.name = name;
   }
}
</code></pre></li><li><p>Should I delegate underlying entities of the AR to mutate its children or put the whole logic in the AR? (see details above, #2 in <strong>The problems and questions</strong>)</p></li></ol></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>I would turn the model upside down to make the most interesting / behavioral bits your AR.</p><p>Based on the info you provided, this is what I would do:</p><ul><li>Course is a reference entity (not an AR)</li><li>User is an reference entity</li><li>Exercise Group is a reference entity (can also record a link between Course and User)</li><li>Session and/or Attendance are the only concepts with potentially interesting behavior<ul><li>All other entities are only interesting because of their interaction within a Session or Attendance</li></ul></li></ul><p>Attendance would contain references (ids) of Session and User, and maybe other stats. You can discover which course the users attended by following the session -&gt; exercise group -&gt; course relationship.</p><p>Domain question: Is it necessary that Users only attend sessions for which they were in the exercise group? Would the people in the session turn away a person that showed up, even though they were not in the exercise group?</p><p>You could say that certain configuration changes such as joining and leaving groups could be interesting behavior. It depends on what the goals are.</p><p>Also keep in mind that your domain (write-side) model does not have to be the same as your read model. Trying to mix query and domain concerns can have you running in circles. As much as possible, let the domain just be concerned with modeling the business problem. If necessary copy the domain data into other forms that are easier to query against. E.g. database triggers, ETL jobs, code that runs on save, etc.</p><p>Many of the questions you posted would not really apply with what I said above, so I didn&#39;t answer them directly. Feel free to ask any other questions you have about my answer in comments.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../should-internal-entities-in-an-aggregate-respond-to-domain-events-directly/'>Should internal entities in an aggregate respond to domain events directly</a></li><li class="list-group-item"><a href='../updating-deep-child-objects-on-an-aggregate-root/'>Updating deep child objects on an Aggregate Root</a></li><li class="list-group-item"><a href='../find-the-ddd-aggregate-root/'>Find the DDD Aggregate Root</a></li><li class="list-group-item"><a href='../architecture-balance-between-aggregate-boundaries-and-domain-consistency-in-ddd/'>Architecture &#8211; Balance between aggregate boundaries and domain consistency in DDD</a></li><li class="list-group-item"><a href='../c-ddd-identifying-aggregate-root-in-a-simple-example-application-domain/'>C# &#8211; DDD: Identifying aggregate root in a simple example application domain</a></li><li class="list-group-item"><a href='../ddd-aggregate-root-get-reference-to-another-aggregate-root/'>DDD &#8211; Aggregate Root get reference to another Aggregate Root</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>