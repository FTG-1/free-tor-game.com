<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>C++ &#8211; Plagued by multithreaded bugs &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1074762 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1074762" class="post-1074762 software type-software status-publish hentry category-software tag-architecture tag-c tag-design tag-multithreading"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">C++ &#8211; Plagued by multithreaded bugs</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">Architecture</span><span class="mr-2 badge badge-info">c</span><span class="mr-2 badge badge-warning">design</span><span class="mr-2 badge badge-primary">multithreading</span></p><div class="entry-content"><p>On my new team that I manage, the majority of our code is platform, TCP socket, and http networking code. All C++.  Most of it originated from other developers that have left the team. The current developers on the team are very smart, but mostly junior in terms of experience.</p><p>Our biggest problem: multi-threaded concurrency bugs. Most of our class libraries are written to be asynchronous by use of some thread pool classes. Methods on the class libraries often enqueue long running taks onto the thread pool from one thread and then the callback methods of that class get invoked on a different thread. As a result, we have a lot of edge case bugs involving incorrect threading assumptions.  This results in subtle bugs that go beyond just having critical sections and locks to guard against concurrency issues.</p><p>What makes these problems even harder is that the attempts to fix are often incorrect. Some mistakes I&#39;ve observed the team attempting (or within the legacy code itself) includes something like the following:</p><p><strong>Common mistake #1</strong> &#8211; Fixing concurrency issue by just put a lock around the shared data, but forgetting about what happens when methods don&#39;t get called in an expected order.  Here&#39;s a very simple example:</p><pre><code>void Foo::OnHttpRequestComplete(statuscode status)
{
    m_pBar-&gt;DoSomethingImportant(status);
}

void Foo::Shutdown()
{
    m_pBar-&gt;Cleanup();
    delete m_pBar;
    m_pBar=nullptr;
}
</code></pre><p>So now we have a bug in which Shutdown could get called while OnHttpNetworkRequestComplete is occuring on. A tester finds the bug, captures the crash dump, and assigns the bug to a developer. He in turn fixes the bug like this.</p><pre><code>void Foo::OnHttpRequestComplete(statuscode status)
{
    AutoLock lock(m_cs);
    m_pBar-&gt;DoSomethingImportant(status);
}

void Foo::Shutdown()
{
    AutoLock lock(m_cs);
    m_pBar-&gt;Cleanup();
    delete m_pBar;
    m_pBar=nullptr;
}
</code></pre><p>The above fix looks good until you realize there&#39;s an even more subtle edge case. What happens if Shutdown gets called <em>before</em> OnHttpRequestComplete gets called back? The real world examples my team has are even more complex, and the edge cases are even harder to spot during the code review process.</p><p><strong>Common Mistake #2</strong> &#8211; fixing deadlock issues by blindly exiting the lock, wait for the other thread to finish, then re-enter the lock &#8211; but without handling the case that the object just got updated by the other thread!</p><p><strong>Common Mistake #3</strong> &#8211; Even though the objects are reference counted, the shutdown sequence &#34;releases&#34; it&#39;s pointer. But forgets to wait for the thread that is still running to release it&#39;s instance. As such, components are shutdown cleanly, then spurious or late callbacks are invoked on an object in an state not expecting any more calls.</p><p>There are other edge cases, but the bottom line is this:</p><p><strong>Multithreaded programming is just plain hard, even for smart people.</strong></p><p>As I catch these mistakes, I spend time discussing the errors with each developer on developing a more appropriate fix. But I suspect they are often confused on how to solve each issue because of the enormous amount of legacy code that the &#34;right&#34; fix will involve touching.</p><p>We&#39;re going to be shipping soon, and I&#39;m sure the patches we&#39;re applying will hold for the upcoming release. Afterwards, we&#39;re going to have some time to improve the code base and refactor where needed. We won&#39;t have time to just re-write everything. And the majority of the code isn&#39;t all that bad. But I&#39;m looking to refactor code such that threading issues can be avoided altogether.</p><p>One approach I am considering is this. For each significant platform feature, have a dedicated single thread where all events and network callbacks get marshalled onto. Similar to COM apartment threading in Windows with use of a message loop. Long blocking operations could still get dispatched to a work pool thread, but the completion callback is invoked on on the component&#39;s thread. Components could possibly even share the same thread. Then all the class libraries running inside the thread can be written under the assumption of a single threaded world.</p><p>Before I go down that path, I am also very interested if there are other standard techniques or design patterns for dealing with multithreaded issues.  And I have to emphasize &#8211; something beyond a book that describes the basics of mutexes and semaphores. What do you think?</p><p>I am also interested in any other approaches to take towards a refactoring process.  Including any of the following:</p><ol><li><p>Literature or papers on design patterns around threads. Something beyond an introduction to mutexes and semaphores. We don&#39;t need massive parallelism either, just ways to design an object model so as to handle asynchronous events from other threads <strong>correctly</strong>.</p></li><li><p>Ways to diagram the threading of various components, so that it will be easy to study and evolve solutions for. (That is, a UML equivalent for discussing threads across objects and classes)</p></li><li><p>Educating your development team on the issues with multithreaded code.</p></li><li><p><strong>What would you do?</strong></p></li></ol></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>Your code has significant <em>other</em> issues apart from just that. Manually deleting a pointer? Calling a <code>cleanup</code> function? Owch. Also, as accurately pointed out in the question comment, you don&#39;t use RAII for your lock, which is another fairly epic fail and guarantees that when <code>DoSomethingImportant</code> throws an exception, terrible things happen.</p><p>The fact that this multithreaded bug is occurring is just a symptom of the core problem- your code has <em>extremely bad</em> semantics in <em>any</em> threading situation and you&#39;re using completely unreliable tools and ex-idioms. If I were you, I&#39;d be amazed that it functions with a single thread, let alone more.</p><blockquote><p>Common Mistake #3 - Even though the objects are reference counted, the
 shutdown sequence &#34;releases&#34; it&#39;s pointer. But forgets to wait for the
 thread that is still running to release it&#39;s instance. As such,
 components are shutdown cleanly, then spurious or late callbacks are
 invoked on an object in an state not expecting any more calls.</p></blockquote><p>The whole point of reference counting is that <em>the thread has already released it&#39;s instance</em>. Because if not, then it cannot be destroyed because the thread still has a reference.</p><p>Use <code>std::shared_ptr</code>. When all threads have released (and <em>nobody</em>, therefore, can be calling the function, as they have no pointer to it), <em>then</em> the destructor is called. This is guaranteed safe.</p><p>Secondly, use a real threading library, like Intel&#39;s Thread Building Blocks or Microsoft&#39;s Parallel Patterns Library. Writing your own is time-consuming and unreliable and your code is full of threading details which it doesn&#39;t need. Doing your own locks is just as bad as doing your own memory management. They have already implemented many general-purpose very useful threading idioms which work correctly for your use.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../c-design-choices-when-doing-multithreading-in-c/'>C++ &#8211; Design choices when doing multithreading in C++</a></li><li class="list-group-item"><a href='../are-there-deprecated-practices-for-multithread-and-multiprocessor-programming-that-i-should-no-longer-use/'>Are there deprecated practices for multithread and multiprocessor programming that I should no longer use</a></li><li class="list-group-item"><a href='../is-it-safe-to-rely-on-static-analysis-to-reproduce-concurrency-bugs-reliably/'>Is it safe to rely on static analysis to &#8220;reproduce&#8221; concurrency bugs reliably</a></li><li class="list-group-item"><a href='../architecture-error-handling-strategies-in-multithreaded-environments/'>Architecture &#8211; Error Handling Strategies in Multithreaded Environments</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>