<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Handling disposables with dependency injection &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1086699 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1086699" class="post-1086699 software type-software status-publish hentry category-software tag-dependency-injection tag-patterns-and-practices tag-repository-pattern"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Handling disposables with dependency injection</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">dependency-injection</span><span class="mr-2 badge badge-info">patterns-and-practices</span><span class="mr-2 badge badge-warning">repository-pattern</span></p><div class="entry-content"><p>I&#39;m struggling to implement disposable objects via dependency injection, as the dependencies are injected in the constructor (and live as long as their containing object does), whereas I want the disposable to only live in scope of a single method.</p><h2><strong>Brief summary</strong></h2><ul><li>NInject is being used for dependency injection.</li><li>There are no unit/integration/regression tests whatsoever. While I am tasked with improving the code quality, I&#39;m not able to change that lack of testing for this project.</li><li>I&#39;m having issues selling the idea of a unit of work. Since we don&#39;t need transactional behavior, I think we can skip the unit of work pattern if we can live with not having transations.</li><li>Database layer: EF6 code first + repositories (<code>FooRepository</code>)</li><li>Business layer (<code>FooManager</code>)</li><li>API layer (<code>FooController</code>)</li><li>API will be consumed by a mobile application and a web application.</li><li>There is a possibility of a Windows Service being created later, which would directly depend on the Business layer.</li></ul><h2><strong>Explanation</strong></h2><p>The repositories have been designed to be disposable (the DbContext lives from repository creation to repository dispose to enable things like bulk uploading of entities &#8211; which can&#39;t happen in a single call for reasons I won&#39;t go into here).</p><p>The idea is that the <code>FooManager</code> class (business logic) uses the repository with a <code>using</code> statement:</p><pre><code>public class FooManager
{
    public IEnumerable&lt;Foo&gt; GetBarryFoos()
    {
        using(var repo = new FooRepository())
        {
            return repo.GetBarryFoos();
        }
    }
}
</code></pre><p>This works, but it doesn&#39;t play nice with the dependency injection which is not being put over the application:</p><pre><code>public class FooManager
{
    IFooRepository _iFooRepository;

    public FooManager(IFooRepository iFooRepository)
    {
        _iFooRepository = iFooRepository
    }

    public IEnumerable&lt;Foo&gt; GetBarryFoos()
    {
        //no using statement possible?
    }
}
</code></pre><h2><strong>Why I think this is a problem</strong></h2><p>Currently, it isn&#39;t. The manager/repository/dbcontext objects are only kept alive in scope of a single request, which is fine. But it&#39;s a problem waiting to happen.</p><p>However, a recent project of this company ended up with a bug that caused several manweeks of work to even find the issue. What had happened is that after the application had grown to massive proportions, a decision was made to create a secondary Windows service which would automate some of the work.</p><p>In short, it was a ticketing application that was handled manually. But a subset of tickets could be synchronized between services (A opens its ticket =&gt; B opens a related ticket. B resolves its ticket =&gt; A resolves the related ticket). So they created a Windows service to handle this.</p><p>The issue was that a Windows service does not live in scope of a single request. And this caused ghost data to appear.</p><ul><li>Step 1 =&gt; Automatically creating a ticket in B. The ticket in A is updated with a reference to B&#39;s ticket.</li><li>Step 2 =&gt; Days later, B resolves its ticket. The service then updates the A ticket to set it to resolved.</li></ul><p>During step 2, which occurred in the same dbcontext that was days old, the update query entered all the old data (that was cached by the db context) and effectively deleted any changes that were made during the ticket in the meanwhile.</p><p>Now, I&#39;m aware that this is a combination of circumstances. Blindly attaching entities to a context, not disposing of resources properly, spaghetti code that had no logging and no documented behavior, &#8230; Many thing contributed.</p><p>But now, I want to prevent that from happening. And I think a first good step here is to <strong>limit a context to a single business method</strong>. Once the method is returned, the context is disposed of. Regardless of whether it&#39;s a web request or part of a Windows service.</p><p>I think that if your Business layer <em>requires</em> you to use it in a web context, then you&#39;re creating a dependency that defeats the purpose of separating the business layer from the API layer.</p><h2>What I have tried</h2><p><strong>1. Requesting an injected object</strong></p><p>Pseudocode example:</p><pre><code>public IEnumerable&lt;Foo&gt; GetBarryFoos()
{
    using(var repo = NInject.Get&lt;IFooRespository&gt;())
    {
        return repo.GetBarryFoos();
    }
}
</code></pre><p>The issue here is that the NInject project (a wrapper we made, which registers the dependencies) depends on the Business project (to register the <code>FooManager</code> dependency). Because of that, I can&#39;t have the Business project depend on the NInject wrapper, as that would create a circular reference.</p><p><strong>2. Injecting a repository factory</strong></p><p>Pseudocode example:</p><pre><code>public class FooManager
{
    IFooRepositoryFactory _iFooRepositoryFactory;

    public FooManager(IFooRepositoryFactory iFooRepositoryFactory)
    {
        _iFooRepositoryFactory = iFooRepositoryFactory;
    }

    public IEnumerable&lt;Foo&gt; GetBarryFoos()
    {
        using(var repo = iFooRepositoryFactory.CreateNew())
        {
            return repo.GetBarryFoos();
        }
    }
}
</code></pre><p>This was the first thing I thought of. However, it sort of defeats the purpose of dependency injection.</p><p>The factory would have to call <code>new FooRepository()</code> to create a new instance. This does not use dependency injection. And I can&#39;t use dependency injection here, because it runs into the same issue as point 1 : it would create a circular dependency.</p><p>Also, if I were to somehow accept that the factory is dependency-injection-friendly, but the repository isn&#39;t, then I don&#39;t need to factor to begin with. Which brings me to the third option:</p><p><strong>3. Remove dependency injection on the repository level</strong>.</p><p>If I remove the injection of repositories into managers (all other injections can stay), then I can have using statement exactly as I wanted to in the beginning:</p><pre><code>public IEnumerable&lt;Foo&gt; GetBarryFoos()
{
    using(var repo = new FooRepository())
    {
        return repo.GetBarryFoos();
    }
}
</code></pre><p>But it&#39;s counterintuitive to remove dependency injection to improve the codebase. Plus, it would make any future testing (if it happens) impossible.</p><p><strong>4. Cheaty hack &#8211; have repositories act as their own factories</strong></p><p>In other words:</p><pre><code>public class FooRepository : IFooRepository
{
    public IFooRepository CreateNew()
    {
        return new FooRepository();
    }
}
</code></pre><p>It&#39;s technically not violating a dependency, since I&#39;m only calling <code>new FooRepository()</code> from inside <code>FooRepository</code> itself. However, this is really just a dirty hack to get everything to work. It would also mean that the injected <code>IFooRepository</code> is only really used for its type, not its particular object. The injected repository (and its context) is wasted.</p><p>It works, but it certainly can&#39;t be good practice.</p><hr/><h2>And this is where I&#39;m stuck&#8230;</h2><p>To me, it seems like I have to choose between dependency injection and disposable repositories. And that&#39;s a bad choice either way.</p><p>I&#39;ve seen issue arise from failing to dispose of repositories/contexts by the same team, in the same environment. So the reoccurrence of the same issue is a realistic expectation.</p><p>Is there a middle ground here which allows me to keep both dependency injection and disposables? If not, should I be prioritizing the disposables because they fix a real life issue, or dependency injection because it enables the possibility of future testing (which is not guaranteed to happen &#8211; I&#39;d say chances are slim to none).</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>Factor does not in fact defeat the purpose. If implemented correctly. Think of the factory as part of the dependency injection. Actually, some advanced DI frameworks allow injecting <code>Func&lt;IFooRepository&gt;</code>, which works like normal factory.</p><p>If you want to implement it yourself, you would inject the container itself into the factory and use the container to resolve the dependency. This is perfectly fine if you think of the factory as part of the dependency injection, not part of your business code. In which case, factory referencing the container is perfectly fine.</p><p>If you want solution specific to NInject, then there is <a href="https://github.com/ninject/Ninject.Extensions.Factory/wiki" rel="nofollow noreferrer">Ninject.Extension.Factory</a> with either <a href="https://github.com/ninject/Ninject.Extensions.Factory/wiki/Factory-interface" rel="nofollow noreferrer">interface</a> or <a href="https://github.com/ninject/Ninject.Extensions.Factory/wiki/Func" rel="nofollow noreferrer">func</a>.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../unit-testing-whats-the-best-way-to-build-a-factory-using-ninject/'>Unit-testing &#8211; What&#8217;s the best way to build a factory using NInject</a></li><li class="list-group-item"><a href='../c-dependency-injection-with-n-tier-entity-framework-solution/'>C# &#8211; Dependency injection with n-tier Entity Framework solution</a></li><li class="list-group-item"><a href='../design-desktop-application-dependency-injection/'>Design &#8211; Desktop application, dependency injection</a></li><li class="list-group-item"><a href='../dependency-injection-dependency-chain-pattern/'>Dependency Injection &#8211; Dependency Chain Pattern</a></li><li class="list-group-item"><a href='../how-many-injections-is-acceptable-in-one-class-when-using-dependency-injection/'>How many injections is acceptable in one class when using dependency injection</a></li><li class="list-group-item"><a href='../c-dependency-injection-for-a-library-with-internal-dependencies/'>C# &#8211; Dependency injection for a library with internal dependencies</a></li><li class="list-group-item"><a href='../unit-of-work-repository-pattern-dependency-injection/'>Unit of work + repository pattern + dependency injection</a></li><li class="list-group-item"><a href='../avoiding-repository-pattern-implementing-onion-architecture-with-dbcontext-only/'>Avoiding Repository pattern &#8211; implementing Onion Architecture with DbContext only</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>