<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>May Domain Events handlers lead to new events &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1081792 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1081792" class="post-1081792 software type-software status-publish hentry category-software tag-domain-driven-design"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">May Domain Events handlers lead to new events</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">domain-driven-design</span></p><div class="entry-content"><p><strong>I want to understand the consequences of allowing handlers to be direct or indirect source of new domain events.</strong></p><p>In all examples I see in the literature Domain Events are usually published by Aggregate Roots. Actually, events may be just returned and then later be published before or/and after transaction is committed.</p><p>Let&#39;s consider the flow:</p><p><code>AR returns event</code> -&gt; <code>event is published</code> -&gt; <code>handler modifies another AR which belongs to same Bounded Context</code> -&gt; <code>modified AR produces another event</code> -&gt; <code>event is published/persisted</code> -&gt; <code>...</code> -&gt; <code>commit (all or nothing)</code>.</p><p>Event dispatching and processing continues until no new events occur. (It somewhat reminds me database triggers behaviour; and triggers are hated for cascades of state changes, but to be honest, I find eventual consistency with all these event and message flows to be not that easier to reason about.)</p><p>Ok, you may say:<br /> <em>&#34;Changing multiple AR&#39;s in same transaction is an indication of broken AR design as its main task is to be a transaction boundary.&#34;</em></p><p>I may agree and suggest another scenario:</p><p>Imagine two requirements:</p><ul><li>Client address must be unique.</li><li>(recently introduced req.) Some addresses (not only client&#39;s) must be automatically substituted with another address.</li></ul><p>We have multiple ARs and thus multiple workflows where address is set. Address is modelled as a value object, it is validated and created by <code>Address IAddressService.New(string address)</code>.</p><p>The logic of substitution partially depends on AR&#39;s state and some external state.</p><p>Option1.<br /> Create a set of address services each working with particular AR type and returning coerced address. Unfortunately, some ARs require an Address to be provided as a process of their creation. It means service has to work with &#39;raw&#39; data. This would be a possible solution, unless we needed to create an event about address substitution and reference AR in this event. It is impossible, if AR&#39;s <code>Id</code> is generated by the store.</p><p>Option 2.<br /> Adopt eventual consistency. Save AR as is, run address substitution after commit, maybe fail if unique constraint is broken.<br /> Personally, I have no idea how to notify downstream Bounded Context about the failure when this BC belongs to third party &#8211; they just make a call to HTTP endpoint and expect either success or failure.</p><p>Option 3.<br /> Let handler change address in AR. The whole flow is:</p><p><code>AR is created</code> -&gt; <code>event is handled by the handler which checks for uniqueness of address</code>, then <code>same event is handled by new handler, and it changes AR&#39;s address</code>+<code>emits new event AddressSubstituted about performed substitution</code> -&gt; <code>AR emits a regular AddressChanged event</code> -&gt; <code>check for uniqueness is done once again</code>, <code>but no need for substitution this time</code> -&gt; <code>no new events are emitted</code> -&gt; <code>commit</code> -&gt; <code>Id is assigned to AR</code> -&gt; <code>publish/persist AddressSubstituted event</code> (this event has a reference to AR, thus when publishing/persisting, Id is already has a valid value).</p><p>Note that all critical parts run inside same transaction. Handler produces one event itself <code>AddressSubstituted</code>, and leads to another event indirectly &#8211; <code>AddressChanged</code>.</p><p><code>AddressSubstituted</code> is published outside transaction, however it is still possible to save everything within same transaction. EF core is quite a clever beast. In case of configured relationships it will figure out the order of persistence, and will first save AR, then use its <code>Id</code> for saving. EF can also generate <code>Guid</code> automatically when AR is added to DbContext (but still after AR is created).</p><p>It&#39;s worth mentioning that order of execution of event handlers may or may not be important, but it is a separate subject for discussion.</p><p>Pros of this solution:<br /> &#8211; Old code is almost not touched, just develop new handlers.<br /> &#8211; Atomicity. Caller is immediately notified about the status of operation.<br /> &#8211; Intent of the change is captured.</p><p>Cons:<br /> &#8211; Extremely hard to reason about the flow (as with any event driven solution, I assume.)<br /> &#8211; Event generation may never end because of some weird nonbreaking loop created by handler.<br /> &#8211; <code>&lt;your items here&gt;</code></p><p>I find this approach to be legit, but I may be missing something very important here. As I never met this &#8211; let&#39;s call it &#8211; <code>exhaustive event dispatching</code> before, I am in doubt.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>DDD is a <em>design</em> methodology and has nothing to say about transaction management outside the domain. In DDD terms, the &#34;transactional boundary&#34; is meant to mean that an Entity is the sole, authoritative, and unambiguous representation of its state. This simply means that an Entity &#34;owns&#34; its data, and really has nothing to do with database transactions.</p><p>The reason many argue for only changing one Aggregate per <em>database transaction</em> has to do with scaling. Of course, like any other design decision, this comes with trade-offs. Modifying multiple Aggregates in a single database transaction means you don&#39;t have to deal with eventual consistency at the cost of not being able to shard your system. Whether or not that benefit is worth the cost is a function of your system&#39;s requirements, and should be considered carefully by your stakeholders. This does not have to be an &#34;all or nothing&#34; decision.</p><p>As far as Domain Events are concerned, again, they represent a trade-off. One of the main objectives of DDD is to &#34;make the implicit explicit&#34;. Domain Events work <em>against</em> this idea by introducing implicit coupling. This can result in quite a bit of added complexity as well as to reduce the cohesiveness of a system. Put another way, I often see Domain Events introduced into a system to make up for poor design. That is, instead of taking the care to model the domain according to behavior and vectors of change, a complex web of Domain Events are rigged together ad-hoc in order to meet business requirements. As you astutely point out, the entire purpose of modelling Aggregates is to bring together data that changes together. If this isn&#39;t happening, we can look at another principal of DDD to help guide us: continuous refactoring.</p><p>Domain Events are best-used to trigger orthogonal (async) processes like sending an email when a <code>CustomerRegistered</code> event is raised, NOT simply keeping state in sync. In this way, they are not like database triggers. I wouldn&#39;t go so far as to say there is no situation where Domain Events should be used to keep state in sync, but it&#39;s important to understand the trade-offs and to always be on the lookout for an alternative approach.</p><p>As for your example problem. It&#39;s a bit too vague and convoluted to address (I had to). It reads like a problem contrived backwards given a faulty premise. Of course, starting with a poor design or not changing your design to accommodate &#34;recently introduced requirements&#34; will create problems down the road. You mention a number of Services/Aggregates in your explanation that only seem to create the problem you are outlining. Why design a system that has a problem? Start with the requirements. THEN model the system around them.</p><p>Systems are not designed to meet future requirements. They are designed to meet the current requirements and, hopefully, are designed according to principals that make them easy to change so that <strong>when</strong> new requirements crop up, they can be quickly integrated into the system. This is the entire purpose of DDD!</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../c-fire-domain-events-after-transaction-completes/'>C# &#8211; Fire domain events after transaction completes</a></li><li class="list-group-item"><a href='../design-command-handling-fail-feedback-with-cqrs/'>Design &#8211; Command handling fail feedback with CQRS</a></li><li class="list-group-item"><a href='../domain-events-cqrs-and-dependency-resolution-in-handlers/'>Domain Events, CQRS, and dependency resolution in handlers</a></li><li class="list-group-item"><a href='../confused-about-commands-domain-events-and-external-events-in-event-sourcing/'>Confused about commands, domain events and external events in event sourcing</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>