<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>How do event sourced systems make sure the read model is only updated once &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1074731 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1074731" class="post-1074731 software type-software status-publish hentry category-software tag-event-handling tag-event-sourcing tag-microservices tag-read-model"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">How do event sourced systems make sure the read model is only updated once</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">event handling</span><span class="mr-2 badge badge-info">event-sourcing</span><span class="mr-2 badge badge-warning">microservices</span><span class="mr-2 badge badge-primary">read-model</span></p><div class="entry-content"><p>Currently looking into Event Sourcing in a Microservices architecture and I&#39;ve found <a href="https://initiate.andela.com/event-sourcing-and-cqrs-a-look-at-kafka-e0c1b90d17d8" rel="nofollow noreferrer">this article</a>. It describes a possible implementation of CQRS and event sourcing.<br /> If the logic dealing with updating the read model and creating the events are both implemented in the same (scalable) service, how does this architecture make sure that an event changing the read model is only handled once?</p><p>To clarify with the example used in the article: <a href="../../../i.stack.imgur.com/YEZRa.png" rel="nofollow noreferrer"><img src="../../../i.stack.imgur.com/YEZRa.png" alt="https://cdn-images-1.medium.com/max/900/1*kyDtZ3pq6ht3Zp5C5ksTvQ.png"/></a><br /> If the User Management Service is scaling, leading to multiple instances running at the same time, how can it be ensured that the logic doesn&#39;t add the same user twice?</p><p>One solution I can think of is completely splitting every Microservice into one read- and one write-service and only scaling the read service, but that doesn&#39;t sound optimal.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><blockquote><p>If the User Management Service is scaling, leading to multiple instances running at the same time, how can it be ensured that the logic doesn&#39;t add the same user twice?</p></blockquote><p>There are a couple of different answers here.</p><p>A good starting point would be Marc de Graauw&#39;s <a href="https://www.infoq.com/articles/no-reliable-messaging" rel="noreferrer">Nobody Needs Reliable Messaging</a>.  The basic idea is that the multiple messages have the same business semantics, and therefore consumers can reject duplicates themselves.</p><p>That in turn means pushing backwards through your protocol; if we have two copies of an HTTP Request, possibly separated in time, that attempt to create the &#34;same&#34; user, then two instances of the User Management Service handling those requests should end up trying to add semantically equivalent events to the store.</p><p>With that property in place, any given consumer can use the semantics of the message to eliminate duplicates.</p><p>Event store implementations can help with <a href="https://cwiki.apache.org/confluence/display/KAFKA/KIP-27+-+Conditional+Publish" rel="noreferrer">Conditional Publish</a>.  For example, <a href="http://eventstore.org/" rel="noreferrer">Event Store</a> achieves this by supporting an <a href="https://eventstore.org/docs/dotnet-api/4.0.0/writing-to-a-stream/" rel="noreferrer">expected version</a> parameter in the write command.</p><p>In a race between competing producers, the two writers will be competing to write to the same expected version of the stream; one producer will succeed, and the second will fail -- the second producer then knows that its locally cached representation of the stream is out of date.  It can then refresh its cache, and try processing the message again.</p><p>In other words, writes to the event collections are achieved by <a href="https://en.wikipedia.org/wiki/Compare-and-swap" rel="noreferrer">compare and swap</a> of the tail reference, rather than by &#34;append&#34;.</p><p>As far as I can tell, in 2017 Kafka doesn&#39;t support conditional publish.  The <a href="https://cwiki.apache.org/confluence/display/KAFKA/KIP-98+-+Exactly+Once+Delivery+and+Transactional+Messaging" rel="noreferrer">exactly once delivery</a> feature in <a href="http://mirror.reverse.net/pub/apache//kafka/0.11.0.0/RELEASE_NOTES.html" rel="noreferrer">0.11</a> doesn&#39;t appear to handle that case.</p><p>Multiple processes writing to the same event partition may not be what you want.  Reasoning about the behavior of a single authority is so much easier.  Instead of having multiple instances of the User Management Service sharing the authority to write to a single stream, you might be better served by creating multiple streams, each with a single authority (essentially, each distinct stream has its own <a href="https://en.wikipedia.org/wiki/Leader_election" rel="noreferrer">leader election</a>).</p><blockquote><p>I don&#39;t think I understood the last part 100%, though; would that look somewhat like this: i.imgur.com/b0C2xNV.png?</p></blockquote><p>Yes, in the sense that each user service has its own topic (book of record) for output events.  But also, you want to be sure that all events related to a specific entity in your model get written to the same topic.  So there would be a piece of logic responsible for ensuring that each command gets handled by the authoritative instance of the user service for that entity.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../cqrs-and-microservices-passing-information-from-one-service-to-another/'>CQRS and microservices: passing information from one service to another</a></li><li class="list-group-item"><a href='../cqrs-event-sourcing-how-to-process-events-in-the-expected-order-inside-the-read-model/'>CQRS-Event Sourcing: how to process events in the expected order inside the read model</a></li><li class="list-group-item"><a href='../how-to-model-domain-events-so-that-the-denormalizers-can-fill-highly-denormalized-read-models/'>How to model domain events so that the denormalizers can fill highly denormalized read models</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>