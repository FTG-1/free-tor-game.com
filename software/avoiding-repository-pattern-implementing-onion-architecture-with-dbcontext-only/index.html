<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Avoiding Repository pattern &#8211; implementing Onion Architecture with DbContext only &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1075702 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1075702" class="post-1075702 software type-software status-publish hentry category-software tag-domain-driven-design tag-entity-framework tag-onion-architecture tag-repository-pattern tag-unit-of-work"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Avoiding Repository pattern &#8211; implementing Onion Architecture with DbContext only</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">domain-driven-design</span><span class="mr-2 badge badge-info">entity-framework</span><span class="mr-2 badge badge-warning">onion-architecture</span><span class="mr-2 badge badge-primary">repository-pattern</span><span class="mr-2 badge badge-danger">unit-of-work</span></p><div class="entry-content"><p>I am trying to follow the <a href="https://jeffreypalermo.com/2008/07/the-onion-architecture-part-1/" rel="noreferrer">Onion Architecture</a> to design my application where I have the following layers &#8211;</p><ul><li>Domain Layer: is the inner-most layer and defines repository interfaces</li><li>Infrastructure Layer: forms the outer-most layer peered with the Web/UI layer and implements the repository interfaces</li><li>Service Layer: is the middle layer where business logic resides and repository interfaces are injected</li><li>Web/UI Layer: forms the outer-most layer peered with the Infrastructure layer and handles DI configurations</li></ul><p>Things are working. No issues so far.</p><p>I&#39;ve come across several Stack Overflow answers and online articles that recommend not to implement Repository pattern when using Entity Framework and Entity Framework Core, because the <code>DbContext</code> itself is implemented to provide the functionality of the Unit of Work pattern while the each <code>IDbSet&lt;T&gt;</code> acts as a repository. I do understand the point and that’s very good. Because, less code to write. So, I thought let’s see if I can find a way to structure my application avoiding the repositories and using the <code>DbContext</code> only.</p><p>Some recommendations I&#39;ve found suggests use of the <code>DbContext</code> directly in my Controllers, which I didn’t like. I don’t want my Controller code to get all messy with queries. I prefer them slim, and delegate the business processing and database operations to somebody else, like I currently do with the Service classes.</p><p>I&#39;ve read this article <a href="https://lostechies.com/derekgreer/2018/02/20/ditch-the-repository-pattern-already/" rel="noreferrer">Ditch the Repository Pattern Already</a> and in the comment section in response to one comment the writer said he uses Onion Architecture and &#8211;</p><blockquote><p>If an Application Layer exists as a discrete layer then it is injected<br /> with the DbContext and possibly other dependencies. For a Web<br /> application, a UI layer sets up all the DI, translates request to<br /> calls to the Application layer, and maps responses onto view models to<br /> be sent back to the browser. Other infrastructure layers like the<br /> persistence layer I define the DbContext in sit at the outside layer<br /> with the UI layer as &#34;peer&#34; layers.</p></blockquote><p>Since according to Onion Architecture the dependency should only go inward what I really don&#39;t understand is how can you get a reference of <code>DbContext</code> (defined in Infrastructure Layer) in Application Layer through DI.</p><p>For those who prefer not to implement Repository and Unit of Work patterns with EF/EF Core could you suggest how can I do the same and still structure my application using Onion Architecture?</p><p><strong>EDIT &#8211; Feb 03 2020</strong></p><p>Thanks to <a href="https://softwareengineering.stackexchange.com/users/106566/flater">Flater</a> for his answer. I&#39;ve gone through each and every link everyone provided. Thanks to all.</p><p>But it seems I failed to properly express my problem. I&#39;ll try once again. My application can be represented with the following diagram of <code>Onion Architecture</code> &#8211;</p><p><a href="../../../i.stack.imgur.com/4q40m.png" rel="noreferrer"><img src="../../../i.stack.imgur.com/4q40m.png" alt="Onion Architecture with no Application Layer"/></a></p><p>Each layer is implemented as a separate project for convenience. Since <code>Onion Architecture</code> dictates that dependencies go <strong>only</strong> inward &#8211;</p><p><strong>Domain</strong> &#8211; has no dependency on any other project. Defines models and interfaces.</p><p><strong>Service</strong> &#8211; has dependency only on Domain. Contains the Service classes which implements the Service interfaces. Service classes are injected with Repository interfaces.</p><p><strong>Infrastructure</strong> &#8211; has dependency on Domain. It defines the DbContext. It contains the Repository classes which implements the Repository interfaces. Repository classes are injected with the DbContext.</p><p><strong>Web/UI</strong> &#8211; has dependency on Service and Domain. It contains the Controller classes which are injected with Service interfaces and/or Repository interfaces. (This project also has a dependency on Infrastructure, but that is solely for DI configuration purpose).</p><p><code>Onion Architecture</code> puts persistence operations at the outer most layer as part of Infrastructure and use Dependency Inversion to access them. This results in a loosely coupled design where the Application Core (comprised of Application + Services + Domain Layer) doesn&#39;t have any dependency on data access layer/technologies.</p><p>When I said &#8211;</p><blockquote><p>what I really don&#39;t understand is how can you get a reference of<br /> DbContext (defined in Infrastructure Layer) in Application Layer<br /> through DI.</p></blockquote><p>what I meant is, if I&#39;m to discard the Repositories and use DbContext only, then I must use the DbContext from my Service classes, but DbContext is defined in Infrastructure and Service doesn&#39;t have a reference to Infrastructure.</p><p>To use the DbContext, the Service Layer it needs a direct reference to Infrastructure. Adding this reference violates the most fundamental concept required by <code>Onion Architecture</code> &#8211; dependencies should always go inward.<br /> This requirement forces us to use DIP to resolve outward dependency and thus achieve the loose coupling.</p><p>So, if Service Layer have a reference to the Infrastructure, the Application Core is directly dependent on the Data Access Layer, and I don&#39;t think we can call it an <code>Onion</code> anymore.</p><p>That&#39;s where my question comes &#8211; how can I avoid the Repositories, use DbContext only but still adhere to <code>Onion Architecture</code>?</p><p>I&#39;m just trying to implement something that I can use with smaller applications, because clearly Repo/UoW approach is overkill for some scenarios and not to mention more code to write.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>The core argument for using repositories is to prevent leaking EF dependent code into your domain. That argument is not wrong, it just comes with a steep cost, i.e. a high-complexity uow/repo layer, which is now being regarded (by some, at least) as too high a price to pay for what it gives back.</p><p>By not using that uow/repo layer, you do actually let your domain depend on EF (the context and db sets). That much is unavoidable.</p><p>I once wrote <a href="https://softwareengineering.stackexchange.com/questions/387135/should-entity-framework-6-not-be-used-with-repository-pattern/387178#387178">a lengthy answer on repositories with EF</a>. Summarizing my anti-repository conclusion: this is why it is called Entity <strong>Framework</strong>, not Entity Library. Frameworks are something you cannot reasonably abstract without effectively needing to duplicate the entire framework&#39;s structures (which negates the benefits of having said framework).</p><blockquote><p>what I really don&#39;t understand is how can you get a reference of DbContext (defined in Infrastructure Layer) in Application Layer through DI</p></blockquote><p>It is, in essence, no different from how you would get a reference to your self-built UOW if you had implemented an UOW/repo layer. You register your db context in your DI framework and then your service layer is able to have this context injected.</p><p>Here&#39;s a .Net Core example from one of my projects:</p><pre><code>services.AddDbContext&lt;MyDbContext&gt;(options =&gt; options.UseSqlServer(connString));
</code></pre><p>It&#39;s possible to use an interface rather than the direct db context class, but I haven&#39;t really dealt with projects where that became a necessity. Use it where appropriate.</p><p>Note that this registration doesn&#39;t have to live in the top level project (as that would violate your onion layering). I actually perform this registration in my persistence project. Something along the lines of:</p><pre><code>// In Persistence

public static class DependencyRegistration
{
    public static void Register(IServiceCollection services, string connString)
    {
        services.AddDbContext&lt;MyDbContext&gt;(options =&gt; options.UseSqlServer(connString));
    }
}

// In top-level Startup.cs

public void ConfigureServices(IServiceCollection services)
{
    Persistence.DependencyRegistration.Register(services, &#34;myConnString&#34;);
}
</code></pre><p>This way, your top-level project actually doesn&#39;t need to depend on the EF dll (since it doesn&#39;t refer to anything from EF), but it still has the authority to decide the connectionstring (from its own configuration) and still directs the persistence layer to set up the necessary EF-related DI registrations.</p><p><em>Note: for a pure onion architecture, the top layer project should not tell persistence to register its dependencies; but rather the top layer project tells the service/application layer to do their registration, and the service/application layer tells the persistence layer to do their registration.</em><br/> <em>My example isn&#39;t full onion but I kept it for simplicity&#39;s sake. Setting up the call chain layer-by-layer isn&#39;t complicated to set up but would needlessly lengthen my example.</em></p><blockquote><p>Other infrastructure layers like the persistence layer I define the DbContext in sit at the outside layer with the UI layer as &#34;peer&#34; layers.</p></blockquote><p>I don&#39;t really get what they mean here. This description of persistence and UI being &#34;peer layers&#34; sounds like it&#39;s at odds with what an actual onion architecture should be.</p><hr/><p>For a bigger example, check out the <a href="https://github.com/JasonGT/NorthwindTraders" rel="noreferrer">NorthwindTraders</a> github repository. The author of this repo also has <a href="https://www.youtube.com/watch?v=RQve_bD8X_M" rel="noreferrer">presentations on Youtube</a> where he elaborates on the how (and why).</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../architecture-how-to-structure-a-domain-driven-design-in-an-onion-architecture/'>Architecture &#8211; How to structure a Domain Driven Design in an Onion Architecture</a></li><li class="list-group-item"><a href='../c-domain-driven-design-in-an-onion-architecture/'>C# &#8211; Domain Driven Design in an Onion Architecture</a></li><li class="list-group-item"><a href='../c-onion-architecture-layer-placement-of-business-logic/'>C# &#8211; Onion architecture: layer placement of business logic</a></li><li class="list-group-item"><a href='../java-what-are-application-and-domain-services-in-onion-architecture/'>Java &#8211; What are application and domain services in onion architecture</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>