<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Python &#8211; Caching factory design &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1072565 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1072565" class="post-1072565 software type-software status-publish hentry category-software tag-caching tag-design tag-design-patterns tag-persistence tag-python"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Python &#8211; Caching factory design</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">caching</span><span class="mr-2 badge badge-info">design</span><span class="mr-2 badge badge-warning">design-patterns</span><span class="mr-2 badge badge-primary">persistence</span><span class="mr-2 badge badge-danger">python</span></p><div class="entry-content"><p>I have a factory <code>class XFactory</code> that creates objects of <code>class X</code>. Instances of <code>X</code> are very large, so the main purpose of the factory is to cache them, as transparently to the client code as possible. Objects of <code>class X</code> are immutable, so the following code seems reasonable:</p><pre><code># module xfactory.py
import x
class XFactory:
  _registry = {}

  def get_x(self, arg1, arg2, use_cache = True):
    if use_cache:
      hash_id = hash((arg1, arg2))
      if hash_id in _registry:
        return _registry[hash_id]
    obj = x.X(arg1, arg2)
    _registry[hash_id] = obj
    return obj

# module x.py
class X:
  # ...
</code></pre><p>Is it a good pattern? (I know it&#39;s not the actual Factory Pattern.) Is there anything I should change?</p><p>Now, I find that sometimes I want to cache <code>X</code> objects to disk. I&#39;ll use <code>pickle</code> for that purpose, and store as values in the <code>_registry</code> the filenames of the pickled objects instead of references to the objects. Of course, <code>_registry</code> itself would have to be stored persistently (perhaps in a pickle file of its own, in a text file, in a database, or simply by giving pickle files the filenames that contain <code>hash_id</code>).</p><p>Except now the validity of the cached object depends not only on the parameters passed to <code>get_x()</code>, but also on the version of the code that created these objects.</p><p>Strictly speaking, even a memory-cached object could become invalid if someone modifies <code>x.py</code> or any of its dependencies, and reloads it while the program is running. So far I ignored this danger since it seems unlikely for my application. But I certainly cannot ignore it when my objects are cached to persistent storage.</p><p>What can I do? I suppose I could make the <code>hash_id</code> more robust by calculating hash of a tuple that contains arguments <code>arg1</code> and <code>arg2</code>, as well as the filename and last modified date for <code>x.py</code> and every module and data file that it (recursively) depends on. To help delete cache files that won&#39;t ever be useful again,  I&#39;d add to the <code>_registry</code> the unhashed representation of the modified dates for each record.</p><p>But even this solution isn&#39;t 100% safe since theoretically someone might load a module dynamically, and I wouldn&#39;t know about it from statically analyzing the source code. If I go all out and assume every file in the project is a dependency, the mechanism will still break if some module grabs data from an external website, etc.).</p><p>In addition, the frequency of changes in <code>x.py</code> and its dependencies is quite high, leading to heavy cache invalidation.</p><p>Thus, I figured I might as well give up some safety, and only invalidate the cache only when there is an obvious mismatch. This means that <code>class X</code> would have a class-level cache validation identifier that should be changed whenever the developer believes a change happened that should invalidate the cache. (With multiple developers, a separate invalidation identifier is required for each.) This identifier is hashed along with <code>arg1</code> and <code>arg2</code> and becomes part of the hash keys stored in <code>_registry</code>.</p><p>Since developers may forget to update the validation identifier or not realize that they invalidated existing cache, it would seem better to add another validation mechanism: <code>class X</code> can have a method that returns all the known &#34;traits&#34; of <code>X</code>. For instance, if <code>X</code> is a table, I might add the names of all the columns. The hash calculation will include the traits as well.</p><p>I can write this code, but I am afraid that I&#39;m missing something important; and I&#39;m also wondering if perhaps there&#39;s a framework or package that can do all of this stuff already. Ideally, I&#39;d like to combine in-memory and disk-based caching.</p><p>EDIT:</p><p>It may seem that my needs can be served well by a pool pattern. On further investigation, however, it’s not the case. I thought I&#39;d list the differences:</p><ol><li><p>Can an object be used by multiple clients?</p><ul><li>Pool: No, each object needs to be checked out and then checked in when no longer needed. The precise mechanism may be complicated.</li><li>XFactory: Yes. Objects are immutable, and can be used by infinitely many clients at once. There’s never a need to create a second copy of the same object.</li></ul></li><li><p>Does pool size need to be controlled?</p><ul><li>Pool: Often, yes. If so, the strategy to do so may be quite complicated.</li><li>XFactory: No. An object must be delivered on demand to the client, and if an existing object is unsuitable, a new one needs to be created.</li></ul></li><li><p>Are all objects freely substitutable?</p><ul><li>Pool: Yes, the objects are typically freely substitutable (or if not, it’s trivial to check which object the client needs).</li><li>XFactory: Absolutely not, and it’s very hard to find out if a given object can service a given client request. It depends on whether an existing object is available that was created with (a) the same arguments and (b) the same version of the source code. Part (b) cannot be verified by XFactory, so it asks the client to help. The client fulfills this responsibility in two ways. First, the client may increment any of its several designated internal version counters (one per developer). This cannot happen in runtime, only a developer may change these counters when he believes that the source code change makes existing objects unusable. Second, a client will return some invariants about the objects that it needs, and XFactory will verify that these invariants are not violated before serving the object to the client. If any of these checks fail, XFactory will create and deliver a new object.</li></ul></li><li><p>Does performance impact need careful analysis?</p><ul><li>Pool: Yes, in some cases a pool actually hurts performance if the overhead of object management is greater than the overhead of object creation/destruction.</li><li>XFactory: No. The computation costs of the objects in question is known to be very high, and loading them from memory or from disk is without doubt superior than recalculating them from scratch.</li></ul></li><li><p>When are objects destroyed?</p><ul><li>Pool: When the pool is shut down. Perhaps it might also destroy objects if told to (partially) release resources or if certain objects have not been used for a while.</li><li>XFactory: Whenever an object was created with the version of the source code that is no longer current, as evidenced by either invariant violation or counter mismatch. The process of locating and destroying such objects at the right time is quite complicated. In addition, time-based invalidation of all objects may be implemented to reduce the accumulated risks of using invalid objects. Since XFactory is never certain that it is the sole owner of an object, such invalidation is best achieved by an additional “version counter” in the client objects, which is incremented programmatically on a periodic basis, rather than by a developer.</li></ul></li><li><p>What special considerations exist for multithreaded environment?</p><ul><li>Pool: Has to avoid collisions in object checking out / checking in (don’t want to check out an object to two clients)</li><li>XFactory: Has to avoid collision in object creation (don’t want to create two objects based on two identical requests)</li></ul></li><li><p>What needs to be done if client does not release an object?</p><ul><li>Pool: It may want to make the object available to others after waiting for some time.</li><li>XFactory: Not applicable. Clients do not notify XFactory about when they are done with the object.</li></ul></li><li><p>Do objects need to be modified?</p><ul><li>Pool: May have to be reset to the default state before being reused.</li><li>XFactory: No, the objects are immutable.</li></ul></li><li><p>Are there any special considerations related to persistence of objects?</p><ul><li>Pool: Typically not. A pool is about saving the cost of object creation, so all the objects are kept in memory (reading from disk would defeat the purpose).</li><li>XFactory: Yes, XFactory is about saving the cost of performing complex calculations, so storing pre-calculated objects on disk makes sense.  As a result XFactory needs to deal with the typical problems of persistent storage; e.g. at initialization, it needs to connect to persistent storage, obtain from it the metadata about which objects are currently available there, and be ready to load them into memory if requested. And object may be in one of three states: “doesn’t exist”, “exists on disk”, “exists in memory”. While XFactory is running, the state may change only in one direction (to the right in this sequence).</li></ul></li></ol><p>In summary, the pool&#39;s complexity is in items 1, 2, 4, 6, and possibly 5, 7, 8. The XFactory complexity is in items 3, 6, 9. The only overlap is item 6, and it’s really not the core function of either pool or XFactory, but rather a constraint on the design that is common to any pattern that needs to work in a multithreaded environment.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>Your concerns are very much valid and they tell me your original easy caching solution is eventually becoming part of your architecture which naturally brings a new level of issues as you described yourself.</p><p>A good architectural solution to caching is to use annotations combined with IoC which solves several problems you described. For example:</p><ul><li>Allow you to better control the life-cycle of your cached objects</li><li>Allow you to replace the caching behavior easily by changing the annotations (instead of changing the implementation)</li><li>Let you easily configure a multi-layered cache where you could be storing in memory then disk cache for example</li><li>Let you define the key (hash) for each method in the annotation itself</li></ul><p>In my projects (Java or C#) I use Spring caching annotations. You can find a brief description <a href="http://static.springsource.org/spring/docs/3.1.0.M1/spring-framework-reference/html/cache.html" rel="nofollow">here</a>.</p><p><a href="http://static.springsource.org/spring/docs/2.0.x/reference/beans.html" rel="nofollow">IoC</a> is a key concept in this solution because it allows you to configure your caching system anyway you want.</p><p>In order to implement a similar solution in Python you have to find how to use annotations and search for a IoC container that allows you to build proxies. That&#39;s how the annotations work in order to intercept all method calls and provide you this particular solution for caching.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../api-caching-layer/'>API Caching Layer</a></li><li class="list-group-item"><a href='../factory-method-vs-factory-method-design-pattern/'>Factory Method vs. Factory Method design pattern</a></li><li class="list-group-item"><a href='../use-a-timestamp-parameter-for-cache-invalidation/'>Use a timestamp parameter for cache invalidation</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>