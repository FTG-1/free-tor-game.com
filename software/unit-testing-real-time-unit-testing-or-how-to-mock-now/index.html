<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Unit-testing &#8211; Real time unit testing &#8211; or &#8220;how to mock now&#8221; &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1064896 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1064896" class="post-1064896 software type-software status-publish hentry category-software tag-real-time tag-unit-testing"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Unit-testing &#8211; Real time unit testing &#8211; or &#8220;how to mock now&#8221;</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">real time</span><span class="mr-2 badge badge-info">unit testing</span></p><div class="entry-content"><p>When you are working on a feature that depends on time&#8230; How do you organize unit testing ? When your unit tests scenarios depend on the way your program interprets &#34;now&#34;, how do you set them up ?</p><p><strong>Second Edit: After a Couple of days reading your experience</strong></p><p>I can see that the techniques to deal with this situation usually revolve around one of these three principles:</p><ul><li> Add (hardcode) a dependency: add a small layer over the time function/object, and always call your datetime function through this layer. This way, you can get control of time during the test cases.</li><li> Use mocks: your code stays exactly the same. In your tests, you replace the time object by a fake time object. Sometimes, the solution involves modifying the genuine time object that is provided by your programming language.</li><li> Use dependency injection: Build your code so that any time reference is passed as a parameter. Then, you have control of the parameters during the tests.</li></ul><p>Techniques (or libraries) specific to a language are very welcome, and will be enhanced if an illustrative piece of code comes along. Then, most interesting is how similar principles may be applied on any platform.<br /> And yes&#8230; If I can apply it straight away in PHP, better than better ðŸ˜‰</p><p><strong>Let&#39;s start with a simple example: a basic booking application.</strong></p><p>Let&#39;s say we have JSON API and two messages: a request message, and a confirmation message.<br /> A standard scenario goes like this:</p><ol><li>You make a request. You get a response with a token. The resource that is needed to fulfill that request is blocked by the system for 5 minutes.</li><li>You confirm a request, identified by the token. If token was issued within 5 minutes, it will be accepted (the resource is still available). If more than 5 minutes have passed, you have to make a new request (the resource was freed. You need to check for its availability again).</li></ol><p><strong>Here come the corresponding test scenario:</strong></p><ol><li><p>I make a request. I confirm (immediately) with the token I received. My confirmation is accepted.</p></li><li><p>I make a request. I wait 3 minutes. I confirm with the token I received. My confirmation is accepted.</p></li><li><p>I make a request. I wait 6 minutes. I confirm with the token I received. My confirmation is rejected.</p></li></ol><p>How can we get to program these unit tests ? What architecture should we use so that these functionalities remain testable ?</p><p><strong>Edit</strong> Note: When we shoot a request, the time is stored in a database in a format that looses any information about milliseconds.</p><p><strong>EXTRA &#8211; but maybe a bit verbose: Here come details about what I found out doing my &#34;homework&#34;:</strong></p><ol><li><p>I Built my feature with a dependency on a time function of my own. My function VirtualDateTime has a static method get_time() that I call where I used to call new DateTime(). This time function allows me to simulate and control what time is &#34;now&#34;, so that I can build tests like: &#34;Set now to 21st jan 2014 16h15. Make a request. Move ahead 3 minutes. Make confirmation.&#34;. This works fine, at the cost of the dependency, and &#34;not so pretty code&#34;.</p></li><li><p>A little more integrated solution would be to build a myDateTime function of my own that extends DateTime with additional &#34;virtual time&#34; functionnalities (most importantly, set now to what I want). This is making the first solution&#39;s code slightly more elegant (use of new myDateTime instead of new DateTime), but ends up to be very similar: I have to build my feature using my own class, thus creating a dependency.</p></li><li><p>I have though about hacking the DateTime function, to make it work with my dependency when I need it. Is there any simple and neat way to replace a class by another, though ? (I think I got an answer to that: See namespace below).</p></li><li><p>In a PHP environment, I read &#34;Runkit&#34; may allow me to do this (hack the DateTime function) dynamically. What is nice is that I would be able to check I am running in test environment before modifying anything about DateTime, and leave it untouched in production <a href="https://stackoverflow.com/questions/3271735/simulate-different-server-datetimes-in-php">[1]</a>. This sounds much safer and cleaner than any manual DateTime hack.</p></li><li><p>Dependency injection of a clock function in each class that uses time <a href="https://stackoverflow.com/questions/4221480/how-to-change-current-time-for-unit-testing-date-functions-in-php">[2]</a>. Is this not overkill ? I see that in some environments it gets very usefull <a href="https://softwareengineering.stackexchange.com/questions/156130/unit-testing-time-bound-code">[5]</a>. In this case, I do not like it so much, though.</p></li><li><p>Remove dependency of time in all the functions <a href="https://stackoverflow.com/questions/4221480/how-to-change-current-time-for-unit-testing-date-functions-in-php">[2]</a>. Is this always feasible ? (See more examples below)</p></li><li><p>Using namespaces <a href="https://stackoverflow.com/questions/4221480/how-to-change-current-time-for-unit-testing-date-functions-in-php">[2]</a><a href="http://www.schmengler-se.de/en/2011/03/php-mocking-built-in-functions-like-time-in-unit-tests/" rel="noreferrer">[3]</a> ? This looks quite good. I could mock DateTime with my own DateTime function that extends \DateTime&#8230; Use DateTime::setNow(&#34;2014-01-21 16:15:00&#34;), and DateTime::wait(&#34;+3 minutes&#34;). This covers pretty much what I need. What if we use the time() function though ? Or other time functions ? I still have to avoid their use in my original code. Or I would need to make sure any PHP time function I use in my code is overridden in my tests&#8230; Is there any library available that would do just this ?</p></li><li><p>I have been looking for a way to change the system time just for a thread. It seems that there is none <a href="https://stackoverflow.com/questions/3923848/change-todays-date-and-time-in-php">[4]</a>. This is a pity: a &#34;simple&#34; PHP function to &#34;Set time to 21st jan 2014 16h15 for this thread&#34; would be a great feature for this kind of tests.</p></li><li><p>Change the system date and time for the test, using exec(). This can work out if you are not afraid to mess up with other things on the server. And you need to set back the system time after you ran your test. It can do the trick in some situations, but feels quite &#34;hacky&#34;.</p></li></ol><p>This looks like a very standard problem to me. However, I still miss a simple an generic way to deal with it. Maybe I missed something ?<br /> Please share your experience !</p><p><strong>NOTE: Here are some other situations where we may have similar testing needs.</strong></p><ul><li><p>Any feature that works with some kind of timeout (e.g. chess game ?)</p></li><li><p>processing a queue that triggers events at a given time (in the above scenario we could keep going like this: one day before the reservation starts, I want to send a mail to the user with all the details. Test scenario&#8230;)</p></li><li><p>You want to set up a test environment with data collected in the past &#8211; you would like to see it like if it was now. <a href="https://stackoverflow.com/questions/3271735/simulate-different-server-datetimes-in-php">[1]</a></p></li></ul><p><a href="https://stackoverflow.com/questions/3271735/simulate-different-server-datetimes-in-php">1</a> <a href="https://stackoverflow.com/questions/3271735/simulate-different-server-datetimes-in-php">https://stackoverflow.com/questions/3271735/simulate-different-server-datetimes-in-php</a></p><p><a href="https://stackoverflow.com/questions/4221480/how-to-change-current-time-for-unit-testing-date-functions-in-php">2</a> <a href="https://stackoverflow.com/questions/4221480/how-to-change-current-time-for-unit-testing-date-functions-in-php">https://stackoverflow.com/questions/4221480/how-to-change-current-time-for-unit-testing-date-functions-in-php</a></p><p><a href="https://softwareengineering.stackexchange.com/questions/156130/unit-testing-time-bound-code">3</a> <a href="http://www.schmengler-se.de/en/2011/03/php-mocking-built-in-functions-like-time-in-unit-tests/" rel="noreferrer">http://www.schmengler-se.de/en/2011/03/php-mocking-built-in-functions-like-time-in-unit-tests/</a></p><p><a href="https://stackoverflow.com/questions/4221480/how-to-change-current-time-for-unit-testing-date-functions-in-php">4</a> <a href="https://stackoverflow.com/questions/3923848/change-todays-date-and-time-in-php">https://stackoverflow.com/questions/3923848/change-todays-date-and-time-in-php</a></p><p><a href="https://stackoverflow.com/questions/4221480/how-to-change-current-time-for-unit-testing-date-functions-in-php">5</a> <a href="https://softwareengineering.stackexchange.com/questions/156130/unit-testing-time-bound-code">Unit testing time-bound code</a></p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>I&#39;m going to use Python-like pseudocode based around your test cases to (hopefully) help explain this answer a little, rather than just expositing.  But in short:  This answer is basically just an example of small, single-function-level <a href="http://en.wikipedia.org/wiki/Dependency_injection">dependency injection</a> / <a href="http://en.wikipedia.org/wiki/Dependency_inversion_principle">dependency inversion</a>, instead of applying the principle to an entire class/object.</p><p>Right now, it sounds like your tests are structured as such:</p><pre><code>def test_3_minute_confirm():
    req = make_request()
    sleep(3 * 60)  # Baaaad
    assertTrue(confirm_request(req))
</code></pre><p>With implementations something along the lines of:</p><pre><code>def make_request():
    return { &#39;request_time&#39;: datetime.now(), }

def confirm_request(req):
    return req[&#39;request_time&#39;] &gt;= (datetime.now() - timedelta(minutes=5))
</code></pre><p>Instead, try forgetting about &#34;now&#34; and tell both functions what time to use.  If it&#39;s most of the time going to be &#34;now&#34;, you can do one of two main things to keep the calling code simple:</p><ul><li>Make time an optional argument that defaults to &#34;now&#34;.  In Python (and PHP, now that I reread the question) this is simple - default &#34;time&#34; to <code>None</code> (<code>null</code> in PHP) and set it to &#34;now&#34; if no value was given.</li><li>In other languages without default arguments (or in PHP if it becomes unwieldy), it might be easier to pull the guts of the functions out into a helper that does get tested.</li></ul><p>For example, the two functions above rewritten in the second version might look like this:</p><pre><code>def make_request():
    return make_request_at(datetime.now())

def make_request_at(when):
    return { &#39;request_time&#39;: when, }

def confirm_request(req):
    return confirm_request_at(req, datetime.now())

def confirm_request_at(req, check_time):
    return req[&#39;request_time&#39;] &gt;= (check_time - timedelta(minutes=5))
</code></pre><p>This way, existing parts of the code don&#39;t need to be modified to pass in &#34;now&#34;, while the parts you actually <em>want</em> to test can be tested much more easily:</p><pre><code>def test_3_minute_confirm():
    current_time = datetime.now()
    later_time = current_time + timedelta(minutes=3)

    req = make_request_at(current_time)
    assertTrue(confirm_request_at(req, later_time))
</code></pre><p>It also creates additional flexibility in the future, so less needs to change if the important parts need to be reused.  For two examples that pop into mind:  A queue where requests might need to be created moments too late but still use the correct time, or confirmations have to happen to past requests as part of data sanity checks.</p><p>Technically, thinking ahead like this <em>might</em> violate <a href="http://en.wikipedia.org/wiki/YAGNI">YAGNI</a>, but we&#39;re not actually building <em>for</em> those theoretical cases - this change would just be for easier testing, that just happens to support those theoretical cases.</p><hr/><blockquote><p>Is there any reason you would recommend one of these solutions over another?</p></blockquote><p>Personally, I try to avoid any sort of mocking as much as possible, and prefer <a href="http://en.wikipedia.org/wiki/Pure_function">pure functions</a> as above.  This way, the code being tested is identical to the code being run outside of tests, instead of having important parts replaced with mocks.</p><p>We&#39;ve had one or two regressions that no one noticed for a good month because that particular part of the code was not often tested in development (we weren&#39;t actively working on it), was released slightly broken (so there were no bug reports), and the mocks used were hiding a bug in the interaction between helper functions.  A few slight modifications so mocks weren&#39;t necessary and a whole lot more could be easily tested, including fixing the tests around that regression.</p><blockquote><p>Change the system date and time for the test, using exec(). This can work out if you are not afraid to mess up with other things on the server.</p></blockquote><p>This is the one that should be avoided at all costs for unit testing.  There&#39;s really no way of knowing what kinds of inconsistencies or race conditions might be introduced to cause intermittent failures (for unrelated applications, or co-workers on the same development box), and a failed/errored test might not set the clock back correctly.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../php-unit-testing-for-different-environments/'>Php &#8211; Unit Testing For Different Environments</a></li><li class="list-group-item"><a href='../java-on-the-effectiveness-of-unit-testing/'>Java &#8211; On the effectiveness of unit testing</a></li><li class="list-group-item"><a href='../unit-testing-using-mock-for-event-listeners-in-unit-testing/'>Unit-testing &#8211; Using Mock for event listeners in unit-testing</a></li><li class="list-group-item"><a href='../database-unit-testing-databaseopenhelper-class-in-android/'>Database &#8211; Unit Testing DatabaseOpenHelper class in Android</a></li><li class="list-group-item"><a href='../php-how-to-pass-a-mock-object-into-a-class-for-unit-tests/'>Php &#8211; How to pass a mock object into a class for unit tests</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>