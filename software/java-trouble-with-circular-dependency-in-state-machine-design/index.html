<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Java &#8211; Trouble with circular dependency in state machine design &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1084096 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1084096" class="post-1084096 software type-software status-publish hentry category-software tag-design-patterns tag-finite-state-machine tag-java tag-object-oriented tag-object-oriented-design"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Java &#8211; Trouble with circular dependency in state machine design</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">design-patterns</span><span class="mr-2 badge badge-info">finite-state machine</span><span class="mr-2 badge badge-warning">java</span><span class="mr-2 badge badge-primary">object-oriented</span><span class="mr-2 badge badge-danger">object-oriented-design</span></p><div class="entry-content"><p>I am trying to develop the structure for a basic state machine that can also take in input and produce output.  I&#39;ve hit a bit of a mental block in trying to figure out how to model the relationship between states and transitions, where my design won&#39;t support the state machine having a cycle.</p><p>Here are a couple of the interfaces that should describe what I have and why it&#39;s a problem (ignore the parts that deal with how the context is stored and I/O is handled, this is a simplification):</p><pre><code>public interface State&lt;T extends StateInput&gt; {
    int id();
    ContextAndOutput goContinuing(StorableContext context, Input input);
    ContextAndOutput render(T stateInput, Input input);
}

public interface InitialState&lt;T extends StateInput&gt; extends State&lt;T&gt; {
    ContextAndOutput buildInitial(Input input);
}

public interface Transition&lt;T extends Context&gt; {
    boolean canBeFollowed(T context, Input request);
    ContextAndOutput transition(T context, Input request);
}

public interface Context {
    StorableContext storable();
}

public class ContextAndOutput {
    private final StorableContext context;
    private final Output output;
}

public class StorableContext {
    private final int stateId;
    private final Object data;
}

public class Output {
    private final String raw;
}

public class Input {
    private final String raw;
}
</code></pre><p>And some example implementations to show how I&#39;m envisioning them getting constructed (note this is in-progress):</p><pre><code>public class Context0 implements Context {

    private final int stateId;
    private final String sampleContextData;

    @Override
    public StorableContext storable() {
        return new StorableContext(stateId, this);
    }
}
</code></pre><p> </p><pre><code>public class State0 implements InitialState&lt;State0Input&gt; {

    private final List&lt;Transition&lt;Context0&gt;&gt; transitions;

    @Override
    public ContextAndOutput buildInitial(Input input) {
        System.out.println(stateName() + &#34;: building initial&#34;);
        Context0 initial = new Context0(id(), input.getRaw());
        return new ContextAndOutput(initial.storable(), 
                                    new Output(&#34;What would you like to buy?&#34;));
    }

    @Override
    public int id() {
        return 0;
    }

    @Override
    public String stateName() {
        return this.getClass().getSimpleName();
    }

    @Override
    public ContextAndOutput goContinuing(StorableContext context, Input input) {
        System.out.println(stateName() + &#34;: go continuing&#34;);

        // XXX here is the only place we go StorableContext-&gt;Context 
        // in a non type safe way, can we do something else?
        Context0 typedContext = (Context0) context.getData(); 
        System.out.println(String.format(
                &#34;I know that the current user query is &#39;%s&#39; &#34; + 
                &#34;but the original one (from context) is &#39;%s&#39;&#34;,
                input.getRaw(),
                typedContext.getInitiateConversationQuery()));
        // XXX do something smarter
        Transition&lt;Context0&gt; bestFitTransition = transitions.iterator().next(); 
        return bestFitTransition.transition(typedContext, input);
    }

    @Override
    public ContextAndOutput render(State0Input stateInput, Input input) {
        System.out.println(stateName() + &#34;: rendering&#34;);
        System.out.println(stateName() + &#34;: building initial&#34;);
        Context0 initial = new Context0(
                               id(),
                               stateInput.getInitiateConversationQuery());

        return new ContextAndOutput(initial.storable(), new Output(&#34;Hello!&#34;));
    }
}
</code></pre><p> </p><pre><code>public class OneToZero implements Transition&lt;Context1&gt; {

    private final State0 destination;

    @Override
    public boolean canBeFollowed(Context1 context, Input request) {
        return true;
    }

    @Override
    public ContextAndOutput transition(Context1 context, Input request) {
        // Build StateInput for State1 from context
        State0Input stateInput = null; // TODO
        return destination.render(stateInput, request);
    }
}
</code></pre><p> </p><pre><code>public class StateMachine {

    private final InitialState initialState;
    private final Map&lt;Integer, State&gt; everyStateIdToState;

    public StateMachine(
               InitialState initialState, 
               Set&lt;ContinuingState&gt; continuingStates) {

        this.initialState = initialState;
        this.everyStateIdToState = buildStateIdToState(initialState, continuingStates);
    }

    private Map&lt;Integer, State&gt; buildStateIdToState(
                                    InitialState state, 
                                    Set&lt;ContinuingState&gt; continuingStates) {

        Set&lt;State&gt; allStates = new HashSet&lt;&gt;(continuingStates.size() + 1);
        allStates.add(state);
        allStates.addAll(continuingStates);
        return allStates.stream()
                .collect(Collectors.toMap(
                        State::id,
                        Function.identity()));
    }

    public ContextAndOutput initiate(Input input) {
        return initialState.buildInitial(input);
    }

    public ContextAndOutput continuing(StorableContext context, Input input) {
        State currentState = everyStateIdToState.get(context.getStateId());
        return currentState.goContinuing(context, input);
    }
}
</code></pre><p>So, if a Transition is unique to a source and destination State, I have it parameterized on the type of the source State&#39;s context, so that it can do the transition of type from source State&#39;s context to destination State&#39;s input.</p><p><strong>Here is the issue: in this way, the Transition has to have the destination State as part of the constructor such that it knows what object to call to provide input to.  However, State also has to have Transition as part of its constructor so that it can determine which one to follow next.  If it matters, I&#39;d also like the ability to create &#39;global&#39; Transitions that can be taken from any state, that will do some work and then drop back into the existing state.</strong></p><p>The issue is demonstrated if I try to have two States and two Transitions, one for each direction:</p><pre><code>// Can&#39;t give this a Transition back to State0
State1 state1 = new State1(Collections.emptyList()); 

List&lt;Transition&lt;Context0&gt;&gt; zerosOutboundTransitions = 
    Collections.singletonList(new ZeroToOne(state1));

//List&lt;Transition&lt;Context0&gt;&gt; onesOutboundTransitions =   
    Collections.singletonList(new OneToZero(state0));

Set&lt;ContinuingState&gt; continuingStates = ImmutableSet.of(state1);

InitialState initialState = new State0(zerosOutboundTransitions);
</code></pre><p>I&#39;m looking for some help in either a design pattern or strategy for avoiding or handling this circular dependency, or how I should go about thinking about this design.  I have taken a few attempts at different strategies here and am at a bit of a loss.  I&#39;d like to enforce as much structure through type safety as I can without losing much flexibility and am struggling to find a &#34;great&#34; solution.  Thanks!</p><p><strong>Edit: I understand that I COULD force a circular dependency like this, but I&#39;m trying to figure out how I could change the design to not require this circular dependency, as they have quite a few downsides:</strong></p><pre><code>// Define the states
State0 initialState = new State0();
State1 state1 = new State1();

// Define the transitions
List&lt;Transition&lt;Context0&gt;&gt; zerosOutboundTransitions = 
    Collections.singletonList(new ZeroToOne(state1));

List&lt;Transition&lt;Context1&gt;&gt; onesOutboundTransitions = 
    Collections.singletonList(new OneToZero(initialState));

// Inform the states of the transitions they may use
initialState.setTransitions(zerosOutboundTransitions);
state1.setTransitions(onesOutboundTransitions);
</code></pre></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><blockquote><p>... my question is more around how I should change the design to avoid needing this circular dependency. – Jordan</p></blockquote><p>One method I&#39;ve seen is to have each state construct the next state.  That works but feels like it&#39;s abusing the garbage collector.  Here&#39;s a method that lets you bounce back and forth from two immutable states.</p><pre><code>interface State {
    boolean process(Context context);
}
</code></pre><p> </p><pre><code>enum States implements State {
    A {
        public boolean process(Context context) {
            System.out.println(States.A);
            context.setState(States.B);
            return true;
        }
    }, B {
        public boolean process(Context context) {
            System.out.println(States.B);
            context.setState(States.A);
            return true;
        }
    }
}
</code></pre><p> </p><pre><code>class Context{
    State state;

    public Context(State state) {
        this.state = state;
    }

    public State getState() {
        return state;
    }

    public void setState(State state) {
        this.state = state;
    }
}
</code></pre><p> </p><pre><code>class Processor {

    public void process(Context context) {
        while(context.getState().process(context));
    }
}
</code></pre><p> </p><pre><code>public class EntryPoint {
    public static void main(String[] args) {
        Processor p = new Processor();
        Context cd = new Context(States.A);
        p.process(cd);
    }
}
</code></pre><p>Inspired by <a href="http://vanillajava.blogspot.com/2011/06/java-secret-using-enum-as-state-machine.html" rel="nofollow">this</a></p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../c-passing-data-between-concrete-states/'>C# &#8211; Passing data between concrete states</a></li><li class="list-group-item"><a href='../object-oriented-finite-state-machine-menu-design/'>Object-oriented &#8211; Finite state machine menu design</a></li><li class="list-group-item"><a href='../state-machine-with-additional-variable/'>State machine with additional variable</a></li><li class="list-group-item"><a href='../state-machine-with-database-records/'>State machine with database records</a></li><li class="list-group-item"><a href='../so-what-exactly-is-a-final-state-of-a-finite-state-machine/'>So what exactly is a final state of a finite state machine</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>