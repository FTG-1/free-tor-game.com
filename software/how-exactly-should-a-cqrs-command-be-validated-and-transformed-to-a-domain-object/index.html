<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>How exactly should a CQRS Command be validated and transformed to a domain object &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1067195 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1067195" class="post-1067195 software type-software status-publish hentry category-software tag-business-logic tag-cqrs tag-domain-driven-design"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">How exactly should a CQRS Command be validated and transformed to a domain object</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">business-logic</span><span class="mr-2 badge badge-info">cqrs</span><span class="mr-2 badge badge-warning">domain-driven-design</span></p><div class="entry-content"><p>I have been adapting poor-man&#39;s <a href="https://martinfowler.com/bliki/CQRS.html" rel="noreferrer">CQRS</a><sup>1</sup> for quite some time now because I love its flexibility to have granular data in one data store, providing great possibilities for analysis and thus increasing business value and when needed another for reads containing denormalized data for increased performance.</p><p>But unfortunately pretty much from the beginning I have been struggling with the problem where exactly I should place business logic in this type of architecture.</p><p>From what I understand, a command is a mean to communicate intent and does not have ties to a domain by itself. They are basically data (dumb &#8211; if you wish) transfer objects. This is to make commands easily transferable between different technologies. Same applies to events as responses to successfully completed events.</p><p>In a typical DDD application the business logic resides within entities, value objects, aggregate roots, they are rich in both data as well as behavior. But a command is not a domain object thus it should not be limited to domain representations of data, because that puts too much strain on them.</p><p>So the real question is: <em>Where exactly is the logic?</em></p><p>I have found out I tend to face this struggle most often when trying to construct a quite complicated aggregate which sets some rules about combinations of its values. Also, when modeling domain objects I like to follow the <a href="https://en.wikipedia.org/wiki/Fail-fast" rel="noreferrer">fail-fast</a> paradigm, knowing when an object reaches a method it&#39;s in a valid state.</p><p>Let&#39;s say an aggregate <code>Car</code> uses two components:</p><ul><li><code>Transmission</code>,</li><li><code>Engine</code>.</li></ul><p>Both <code>Transmission</code> and <code>Engine</code> value objects are represented as super types and have according sub types, <code>Automatic</code> and <code>Manual</code> transmissions, or <code>Petrol</code> and <code>Electric</code> engines respectively.</p><p>In this domain, living on its own a successfully created <code>Transmission</code>, be it <code>Automatic</code> or <code>Manual</code>, or either type of an <code>Engine</code> is completely fine. But the <code>Car</code> aggregate introduces a few new rules, applicable only when <code>Transmission</code> and <code>Engine</code> objects are used in the same context. Namely:</p><ul><li>When a car uses <code>Electric</code> engine the only allowed transmission type is <code>Automatic</code>.</li><li>When a car uses <code>Petrol</code> engine it may have either type of <code>Transmission</code>.</li></ul><p>I could catch this component combination violation at the level of creating a command, but as I have stated before, from what I understand that should not be done because the command would then contain business logic which should be limited to the domain layer.</p><p>One of the options is to move this business logic validation to command validator itself, but this does not seem to be right either. It feels like I would be deconstructing the command, checking its properties retrieved using getters and comparing them within the validator and inspecting results. That screams like a violation of the <a href="https://en.wikipedia.org/wiki/Law_of_Demeter" rel="noreferrer">law of Demeter</a> to me.</p><p>Discarding the mentioned validation option because it does not seem viable, it seems like one should use the command and construct the aggregate from it. But where should this logic exist? Should it be within the command handler responsible for handling a concrete command? Or should it perhaps be within the command validator (I don&#39;t like this approach either)?</p><p>I am currently using a command and create an aggregate from it within the responsible command handler. But when I do this, should I have a command validator it would not contain anything at all, because should the <code>CreateCar</code> command exist it would then contain components which I know are valid on separate cases but the aggregate might say different.</p><hr/><p>Let&#39;s imagine a different scenario mixing different validation processes &#8211; creating a new user using a <code>CreateUser</code> command.</p><p>The command contains an <code>Id</code> of a users which will have been created and their <code>Email</code>.</p><p>The system states the following rules for user&#39;s email address:</p><ul><li>must be unique,</li><li>must not be empty,</li><li>must have at most 100 characters (max length of a db column).</li></ul><p>In this case, even though having a unique email is a business rule, checking it in an aggregate makes very little sense, because I would need to load the entire set of current emails in the system to a memory and check the email in the command against the aggregate (<strong>Eeeek!</strong> Something, something, performance.). Because of that, I would move this check to the command validator, which would take <code>UserRepository</code> as a dependency and use the repository to check whether a user with the email present in the command already exists.</p><p>When it comes to this it suddenly makes sense to put the other two email rules in the command validator as well. But I have a feeling the rules should be really present within a <code>User</code> aggregate and that the command validator should only check about the uniqueness and if validation succeeds I should proceed to create the <code>User</code> aggregate in the <code>CreateUserCommandHandler</code> and pass it to a repository to be saved.</p><p>I feel like this because the repository&#39;s save method is likely to accept an aggregate which ensures that once the aggregate is passed all invariants are fulfilled. When the logic (e.g. the non-emptiness) is only present within the command validation itself another programmer could completely skip this validation and call the save method in the <code>UserRepository</code> with a <code>User</code> object directly which could lead to a fatal database error, because the email might have been too long.</p><p>How do you personally handle these complex validations and transformations? I am mostly happy with my solution, but I feel like I need affirmation that my ideas and approaches are not completely stupid to be pretty happy with the choices. I am entirely open to completely different approaches. If you have something you have personally tried and worked very well for you I would love to see your solution.</p><hr/><p><sup>1</sup> Working as a PHP developer responsible for creating RESTful systems my interpretation of CQRS deviates a little from the standard <em>async-command-processing</em> approach, such as sometimes returning results from commands due to the need of processing commands synchronously.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>The following answer is in the context of the CQRS style promoted by the <a href="http://cqrs.nu/" rel="noreferrer">cqrs.nu</a> in which commands arrive directly on the aggregates. In this architectural style the application services are being replaced by an infrastructure component (the <a href="https://github.com/xprt64/dudulina/blob/master/src/Dudulina/Command/CommandDispatcher.php" rel="noreferrer">CommandDispatcher</a>) that identifies the aggregate, loads it, sends it the command and then persists the aggregate (as a series of events if Event sourcing is used).</p><blockquote><p>So the real question is: Where exactly is the logic?</p></blockquote><p>There are multiple kinds of (validation) logic. The general idea is to execute the logic as early as possible - fail fast if you want. So, the situations are as follows:</p><ul><li>the structure of the command object itself; the command&#39;s constructor has some required fields that must be present for the command to be created; this is the first and fastest validation; this is obviously contained in the command.</li><li>low level field validation, like the non-emptiness of some fields (like the username) or the format (a valid email address). This kind of validation should be contained inside the command itself, in the constructor. There is another style of having an <code>isValid</code> method but this seems pointless to me as someone would have to remember to call this method when in fact successful command instantiation should suffice.</li><li>separate <code>command validators</code>, classes that have the responsibility to validated a command. I use this kind of validation when I need to check information from multiple aggregates or external sources. You could use this to check the uniqueness of an username. <code>Command validators</code> could have any dependencies injected, like repositories. Keep in mind that this validation is eventually consistent with the aggregate (i.e. when the user gets created, another user with the same username could be created in the meantime)! Also, do not try to put here logic that should reside inside the aggregate! Command validators are different from the Sagas/Process managers which generate commands based on events.</li><li>the aggregate methods that receive and process the commands. This is the last (kind of) validation that occurs. The aggregate extract the data from the command and using some core business logic it accepts (it performs changes to it&#39;s state) or rejects it. This logic is checked in a strong consistent manner. This is the last line of defense. In your example, the rule <code>When a car uses Electric engine the only allowed transmission type is Automatic</code> should be checked here.</li></ul><blockquote><p>I feel like this because the repository&#39;s save method is likely to accept an aggregate which ensures that once the aggregate is passed all invariants are fulfilled. When the logic (e.g. the non-emptiness) is only present within the command validation itself another programmer could completely skip this validation and call the save method in the UserRepository with a User object directly which could lead to a fatal database error, because the email might have been too long.</p></blockquote><p>Using the above techniques nobody can create <em>invalid</em> commands or bypass the logic inside the aggregates. Command validators are automatically loaded+called by the <code>CommandDispatcher</code> so nobody can send a command directly to the aggregate. One could call a method on the aggregate passing a command but could not persist the changes so it would be pointless/harmless to do so.</p><blockquote><p>Working as a PHP developer responsible for creating RESTful systems my interpretation of CQRS deviates a little from the standard async-command-processing approach, such as sometimes returning results from commands due to the need of processing commands synchronously.</p></blockquote><p>I&#39;m also a PHP programmer and I don&#39;t return anything from my command handlers (aggregate methods in the form <code>handleSomeCommand</code>). I do, however, quite often, return information to the client/browser in the <code>HTTP response</code>, for example the ID of the newly created aggregate root or something from a read-model but I never return (really <em>never</em>) anything from my aggregate command methods. The simple fact that the command was accepted (and processed - we are talking about synchronous PHP processing, right?!) is sufficient.</p><p>We return something to the browser (and still doing CQRS by the book) because <a href="https://www.infoq.com/news/2016/04/event-sourcing-anti-pattern" rel="noreferrer">CQRS is not a high level architecture</a>.</p><p>An example of how command validators work:</p><p><a href="../../../i.stack.imgur.com/LArZv.jpg" rel="noreferrer"><img src="../../../i.stack.imgur.com/LArZv.jpg" alt="Command&#39;s path through command validators on its way to the Aggregate"/></a></p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../should-i-use-the-repository-in-the-domain-object-or-push-the-domain-object-back-to-the-service-layer/'>Should I use the repository in the Domain Object or push the Domain Object back to the Service Layer</a></li><li class="list-group-item"><a href='../ddd-cqrs-per-query-and-per-command-authorization/'>DDD CQRS &#8211; per-query and per-command authorization</a></li><li class="list-group-item"><a href='../when-using-ddd-and-crqs-should-be-exactly-one-event-per-command/'>When using DDD and CRQS, should be exactly one event per command</a></li><li class="list-group-item"><a href='../should-cqrs-command-perform-a-query/'>Should CQRS Command perform a Query</a></li><li class="list-group-item"><a href='../c-dealing-with-property-level-permissions-in-ddd-and-should-ui-or-authorization-influence-the-domain-model/'>C# &#8211; Dealing with property-level permissions in DDD and should UI or authorization influence the domain model</a></li><li class="list-group-item"><a href='../ddd-and-mediatr-where-the-validation-and-business-logic-go/'>DDD and MediatR &#8211; where the Validation and Business Logic go</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>