<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="https://free-tor-game.com/wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>C# &#8211; Race condition allowing multiple transactions; will locking on objects in a dictionary cause issues &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.min.js?ver=11.2.0' id='highlight-js'></script>     <script>( function( w, d, s, l, i ) {
				w[l] = w[l] || [];
				w[l].push( {'gtm.start': new Date().getTime(), event: 'gtm.js'} );
				var f = d.getElementsByTagName( s )[0],
					j = d.createElement( s ), dl = l != 'dataLayer' ? '&l=' + l : '';
				j.async = true;
				j.src = 'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
				f.parentNode.insertBefore( j, f );
			} )( window, document, 'script', 'dataLayer', ' ' );</script>      <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1085731 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="https://free-tor-game.com/3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="https://free-tor-game.com/contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1085731" class="post-1085731 software type-software status-publish hentry category-software tag-c tag-data-structures tag-locks"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">C# &#8211; Race condition allowing multiple transactions; will locking on objects in a dictionary cause issues</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">c</span><span class="mr-2 badge badge-info">data structures</span><span class="mr-2 badge badge-warning">locks</span></p><div class="entry-content"><p>We have a MVC Web API that is called to write transactions for a specific amount, where the amount is debited or credited to a user&#39;s balance. This records the balance pre-transaction (PreAmount), the amount, and the balance post-transaction (PostAmount). We noticed from a simple query using SQL Server&#39;s <code>LAG</code> and <code>LEAD</code> functions that there were instances of transactions being added from the API were being &#39;entered too fast&#39; (partially due to the lack of resources put towards buying good hardware for the server, and IIS and SQL running on the same box). We have a mechanism to prevent the transaction from being entered if it exists, but it seems that the method call is being called really quickly, which results in the record being added multiple times due to a race condition.</p><p>The way I am going to try to fix this is by using a <code>Dictionary&lt;long, object&gt;</code>. The assumption here is that, we want transactions for a customer to be entered sequentially at all times, but <em>I don&#39;t want to lock concurrent requests for multiple customers</em>. The dictionary would contain a customer ID # and the value would be an object I can lock on. When a transaction is about to be entered, I will check to see if there is a customer ID # entry, and if not, enter it in there):</p><pre><code>private static Dictionary&lt;long, object&gt; customerLocker = new Dictionary&lt;long, object&gt;();
private static object dictLocker = new object();
</code></pre><p>Then, when a request to check a balance, or to enter a transaction is requested, I would then lock on that object, and perform the work needed:</p><pre><code>lock (dictLocker)
{
    if (!customerLocker.ContainsKey(customerID))
        customerLocker.Add(customerID, new object());
}
lock (customerLocker[customerID])
{
    // ... do the work needed for this customer
}
</code></pre><p>Is this a good solution to the issue I am having? <strong>Will locking on elements inside of a dictionary cause issues?</strong> I&#39;m going to try it, but while I&#39;m putting this together, I&#39;d like to see input from others on this scenario.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>It&#39;s not safe for you to be searching through the dictionary outside of a <code>lock</code>, because by doing so another dictionary could be writing to it at the same time, so your read could end up being corrupted.  You need to fetch the value for the key <em>inside</em> of the <code>lock</code>.</p><p>Alternatively, you could just use a <code>ConcurrentDictionary</code> to store the objects for each customer instead of locking around access to a <code>Dictionary</code>.  This would let you write:</p><pre><code>private static ConcurrentDictionary&lt;long, object&gt; customerLocker = 
    new ConcurrentDictionary&lt;long, object&gt;();
</code></pre><pre><code>lock (customerLocker.GetOrAdd(customerID, () =&gt; new object()))
{
    // ... do the work needed for this customer
}
</code></pre></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='https://free-tor-game.com/software/c-best-practice-modelling-an-active-record-entity-using-linq-to-sql-as-dal/'>C# &#8211; Best practice modelling an active record entity using Linq-To-SQL as DAL</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/c-efficient-methods-for-storing-tens-of-millions-of-objects-for-querying-with-a-high-number-of-inserts-per-second/'>C# &#8211; Efficient methods for storing tens of millions of objects for querying, with a high number of inserts per second</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/c-how-far-should-an-entity-take-care-of-its-properties-values-by-itself/'>C# &#8211; How far should an entity take care of its properties values by itself</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/c-application-to-read-xml-files-parsing-them-storing-locally-in-data-structure-and-writing-to-csv/'>C# application to read xml files, parsing them, storing locally in data structure and writing to csv</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/c-does-readerwriterlockslim-provide-thread-safety-and-speed-efficiency-compared-to-a-traditional-lock-when-using-a-list/'>C# &#8211; Does ReaderWriterLockSlim provide thread safety and speed efficiency (compared to a traditional lock) when using a List</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/c-how-to-check-whether-existing-code-base-can-deadlock/'>C++ &#8211; How to check whether existing code base can deadlock</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='http://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="https://free-tor-game.com/wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>