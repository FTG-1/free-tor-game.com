<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>C# &#8211; Looking for a distributed locking pattern &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1066483 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1066483" class="post-1066483 software type-software status-publish hentry category-software tag-c tag-concurrency tag-distributed-development tag-multithreading"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">C# &#8211; Looking for a distributed locking pattern</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">c</span><span class="mr-2 badge badge-info">concurrency</span><span class="mr-2 badge badge-warning">distributed-development</span><span class="mr-2 badge badge-primary">multithreading</span></p><div class="entry-content"><p>I need to come up with a custom recursive object locking mechanism\pattern for a distributed system in C#. Essentially, I have a multi-node system. Each node has <strong>exclusive write</strong> permissions over <em>n</em>-number pieces of state. The same state is also  available in <strong>read-only</strong> form on <em>at least one</em> other node. Some writes/updates must be atomic across all nodes, while other updates will eventually become consistent thru background replication processes, queues, etc&#8230;</p><p>For the atomic updates I&#39;m looking for a pattern or samples that efficiently allow me to mark an object as locked for <strong>writes</strong> which I can then distribute, commit, rollback, etc&#8230; Since the system has high-levels of concurrency, I&#39;m assuming I&#39;ll need to be able to stack-up locks which will either timeout or be unrolled once the locks are released.</p><p>The transaction or messaging pieces are not the focus of this question, but I&#39;ve provided them for some extra context. With that said, feel free to articulate what messages you think would be needed if you like.</p><p>Here is a vague sample of what I was envisioning although I&#39;m open to any new ideas aside from implementing whole new products</p><pre><code>thing.AquireLock(LockLevel.Write);

//Do work

thing.ReleaseLock();
</code></pre><p>I was thinking of using extension methods, which might look something like this</p><pre><code>public static void AquireLock(this IThing instance, TupleLockLevel lockLevel)
{ 
    //TODO: Add aquisition wait, retry, recursion count, timeout support, etc...  
    //TODO: Disallow read lock requests if the &#39;thing&#39; is already write locked
    //TODO: Throw exception when aquisition fails
    instance.Lock = lockLevel;
}

public static void ReleaseLock(this IThing instance)
{
    instance.Lock = TupleLockLevel.None;
}
</code></pre><p>To clarify a couple details&#8230;</p><ul><li>All communications are TCP/IP using a binary request/response protocol</li><li>There are no intermediary technologies such as queues or databases</li><li>There is no central master node. In this case, the locking arrangement is defined by the initiator of the lock and the partner which will honour the request with some form of timeout to govern its behaviour</li></ul><p>Anyone have any suggestions?</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>Thanks for the clarifications.</p><p>In that case, what I&#39;d recommend is using a publish / subscribe model.  Google&#39;s <a href="http://en.wikipedia.org/wiki/Distributed_lock_manager" rel="nofollow noreferrer">Chubby distributed locking protocol</a> ( an implementation of <a href="http://en.wikipedia.org/wiki/Paxos_(computer_science)" rel="nofollow noreferrer">Paxos</a>)</p><p>I&#39;ve never used Paxos (or Chubby), but there seems to be an open source implementation <a href="http://libpaxos.sourceforge.net/" rel="nofollow noreferrer">here</a>.</p><p>If that doesn&#39;t work, you could implement your own version of Paxos using, for example, one of the usual suspects in terms of messaging libraries : the <a href="http://www.zeromq.org/" rel="nofollow noreferrer">zero message queue library</a>, <a href="http://www.rabbitmq.com/" rel="nofollow noreferrer">RabbitMQ</a>, or <a href="http://activemq.apache.org/" rel="nofollow noreferrer">ActiveMQ</a>.</p><hr/><p><em>Previous Answer:</em></p><p>Most of the suggestions on SO (<a href="https://stackoverflow.com/questions/2176231/mutex-across-network-c-net">[A]</a>, <a href="https://stackoverflow.com/questions/1682699/how-to-mutex-across-a-network">[B]</a>) go for use of a message queue to achieve cross-machine locking.</p><p>Your <code>AcquireLock</code> method would push something identifying the lock object into the queue, checking for previous instances of locks before success.  Your <code>ReleaseLock</code> method would remove the lock object from the queue.</p><p>SO user <a href="https://stackoverflow.com/users/174926/atlantis">atlantis</a> suggests, <a href="https://stackoverflow.com/a/2189554/12570">in this post</a>, <a href="http://weblogs.asp.net/jkey/archive/2004/05/12/130922.aspx" rel="nofollow noreferrer">Jeff Key&#39;s post</a> for some of the detail.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../is-using-locking-unlocking-in-version-control-an-anti-pattern/'>Is Using Locking/Unlocking in Version Control an Anti-Pattern</a></li><li class="list-group-item"><a href='../java-how-to-concurrently-write-data-in-java-without-locking/'>Java &#8211; How to concurrently write data in Java without locking</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>