<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Are we queueing and serializing properly &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1080438 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1080438" class="post-1080438 software type-software status-publish hentry category-software tag-queueing tag-serialization"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Are we queueing and serializing properly</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">queueing</span><span class="mr-2 badge badge-info">serialization</span></p><div class="entry-content"><p>We process messages through a variety of services (one message will touch probably 9 services before it&#39;s done, each doing a specific IO-related function).  Right now we have a combination of the worst-case (XML data contract serialization) and best-case (in-memory MSMQ) for performance.</p><p>The nature of the message means that our serialized data ends up about 12-15 kilobytes, and we process about 4 million messages per week.  Persistent messages in MSMQ were too slow for us, and as the data grows we are feeling the pressure from MSMQ&#39;s memory-mapped files. <em>The server is at 16GB of memory usage and growing, just for queueing.</em> Performance also suffers when the memory usage is high, as the machine starts swapping.  We&#39;re already doing the MSMQ self-cleanup behavior.</p><p>I feel like there&#39;s a part we&#39;re doing wrong here.  I tried using RavenDB to persist the messages and just queueing an identifier, but the performance there was very slow (1000 messages per minute, at best).  I&#39;m not sure if that&#39;s a result of using the development version or what, but we definitely need a higher throughput[1].  The concept worked very well in theory but performance was not up to the task.</p><p>The usage pattern has one service acting as a router, which does all reads.  The other services will attach information based on their 3rd party hook, and forward back to the router.  Most objects are touched 9-12 times, although about 10% are forced to loop around in this system for awhile until the 3rd parties respond appropriately.  The services right now account for this and have appropriate sleeping behaviors, as we utilize the priority field of the message for this reason.</p><p><strong>So, my question, is what is an ideal stack for message passing between discrete-but-LAN&#39;ed machines in a C#/Windows environment?</strong> I would normally start with BinaryFormatter instead of XML serialization, but that&#39;s a rabbit hole if a better way is to offload serialization to a document store.  Hence, my question.</p><p>[1]: The nature of our business means the sooner we process messages, the more money we make.  We&#39;ve empirically proven that processing a message later in the week means we are less likely to make that money.  While performance of &#34;1000 per minute&#34; sounds plenty fast, we really need that number upwards of 10k/minute.  Just because I&#39;m giving numbers in messages per week doesn&#39;t mean we have a whole week to process those messages.</p><p>=============== edit:</p><h2>Additional information</h2><p>Based on the comments, I&#39;ll add some clarification:</p><ul><li><p>I&#39;m not sure serialization is our bottleneck.  I&#39;ve benchmarked the application, and while serialization does show up in the heat graph, it&#39;s only responsible for maybe 2.5-3% of the service&#39;s CPU utilization.</p></li><li><p>I&#39;m mostly concerned about the permanence of our messages and potential misuse of MSMQ.  We are using non-transactional, non-persistent messages so we can keep queueing performance up, and I would really like to have at least persistent messages so they survive a reboot.</p></li><li><p>Adding more RAM is a stopgap measure.  The machine has already gone from 4GB -&gt; 16GB of RAM and it&#39;s getting harder and harder to take it down to continue adding more.</p></li><li><p>Because of the star routing pattern of the application, half the time an object is popped then pushed to a queue it doesn&#39;t change at all.  This lends itself again (IMO) to storing it in some kind of key-value store elsewhere and simply passing message identifiers.</p></li><li><p>The star routing pattern is integral to the application and will not change.  We can&#39;t application-centipede it because every piece along the way operates asynchronously (in a polling fashion) and we want to centralize the retry behavior in one place.</p></li><li><p>The application logic is written in C#, the objects are immutable POCOs, the target deployment environment is Windows Server 2012, and we are allowed to stand up additional machines if a particular piece of software is only supported in Linux.</p></li><li><p>My goals are to maintain current throughput while reducing memory footprint and increasing fault tolerance with a minimum outlay of capital.</p></li></ul></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p><a href="http://mikehadlow.blogspot.co.uk/2011/04/message-queue-shootout.html" rel="nofollow">Here are some queue benchmarks you might be interested in.</a> MSMQ should be capable of handling 10K messages per second. Could it be a configuration issue or perhaps the clients aren&#39;t keeping up with reading the queue?  Also note how blazingly fast ZeroMQ is in those benchmarks(around 100K messages per second), it doesn&#39;t offer a persistence option but it should get you to where you want to be performance wise.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../validating-objects-with-xsds-is-re-serializing-redundant-or-negligible/'>Validating Objects With XSDs: Is Re-Serializing Redundant or Negligible</a></li><li class="list-group-item"><a href='../object-oriented-serializing-an-object-in-different-ways/'>Object-oriented &#8211; Serializing an object in different ways</a></li><li class="list-group-item"><a href='../c-best-practices-for-serializing-persisting-string-object-dictionary-entities/'>C# &#8211; Best Practices for serializing/persisting String Object Dictionary entities</a></li><li class="list-group-item"><a href='../c-xelement-parse-and-querying-versus-serialization-strongly-typed-objects/'>C# &#8211; XElement.Parse and querying versus serialization (strongly typed objects)</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>