<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Unit-testing &#8211; How to handle unit tests with collaborators and side effects &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1085821 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1085821" class="post-1085821 software type-software status-publish hentry category-software tag-unit-testing"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Unit-testing &#8211; How to handle unit tests with collaborators and side effects</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">unit testing</span></p><div class="entry-content"><p>We&#39;re in a project that has quite a lot of code and while in general we have a good test coverage and things work out pretty well, I noticed that our tests grew more and more complex over time up to a point where the tests are more complex than the code they test.</p><p>As a bit of background we&#39;re using Spock for testing and make ample use of it&#39;s mocking and interaction testing features &#8211; which may be part of the problem. In general we opted for white-box testing, so our test code mostly knows about the internal workings of the classes under test (which may be another contributing factor to the problem).</p><p>Let me give you a simplified example of a less than stellar test on this method:</p><pre><code>class SomeServiceImpl {
    SomeDao someDao;

    public void store(SomeInputForm form) {
        // some checks of the form here.
        SomeEntity entity = new SomeEntity();
        // copy data from form to entity here.
        someDao.store(someEntity);
    }
}
</code></pre><p>And the test:</p><pre><code>SomeServiceImpl underTest
SomeDao someDao

def setup() {
    underTest = new SomeServiceImpl()
    someDao = Mock(SomeDao)
    underTest.someDao = someDao
}

def &#34;storing something yields that stuff ends up in the database&#34;() {
    setup:
    def form = new SomeInputForm(... with some data ...)
    SomeEntity result = null        

    when:
    underTest.store( form )

    then:
    1 * someDao.store( { result = it } _ as SomeEntity )
    // additional checks to verify that the entity has the same data as the form
    result.someProperty == form
}
</code></pre><p>The intention of this test is to verify that some data that comes in via a form is stored inside the database. We mock out the DAO so we don&#39;t need a real DB here. While the test certainly works it has several problems:</p><ul><li>It knows very well how the service works internally. As soon as you change the implementation of the service you have to change the implementation of the test, even if the end result would be the same.</li><li>It&#39;s hard to detect the side effect of the store method (see the complicated code for extracting the generated entity).</li><li>If you have multiple collaborators you will have to do a lot of mocking and stacking them all together.</li><li>The test basically repeats the code of the service in the <code>then</code> section.</li></ul><p>I&#39;m currently experimenting with a more functional way of things  where you have just functions getting input and producing output, e.g. like this:</p><pre><code>class SomeServiceImpl {

      void verify(SomeInputForm form) {
          // verify and throw exception if a problem is there
      }

      SomeEntity createEntityFromForm(SomeInputForm form) {
         // do the conversion here
      }


      void store(SomeEntity entity) {
         dao.store(entity);
      }
}
</code></pre><p>While this solves part of the testing problem, because now I can test the <code>verify</code> and <code>createEntityFromForm</code> methods without any collaborators and without knowing about the actual implementation, there still has to be a place where these three methods are called in the correct order:</p><pre><code>   service.verify(form);
   Entity en = service.createEntityFromForm(form);
   service.store(form);
</code></pre><p>Which effectively just moves the problem somewhere else (and introduces a lot of margin for error as you need to call methods in the correct order now).</p><p>So I wonder whether there is a better way of organising the code differently to make the tests less brittle and less whitebox while still detecting the side effects (or even a way where you wouldn&#39;t need to detect the side effect but still know stuff is properly saved to the database).</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>To your first bullet point and last bullet point are pretty much the same thing and I&#39;ll address those last.</p><p>To your second bullet point, it is not this tests job to detect side effects of the SomeDao&#39;s store method. This test is testing SomeServiceImpl, not SomeDao, it doesn&#39;t matter what SomeDao does. Another test fixture should be testing that. The only thing that this test should be checking was whether store was called. Otherwise this is an integration test.</p><p>Third bullet point - yes, this is an unfortunate drawback of unit testing but the more complicated a system gets the more considerations we must make. But this isn&#39;t entirely a bad thing. It forces us to think about how one piece of code interacts with other pieces. It gives us a sharp glimpse of the point of interaction between them and let&#39;s us evaluate how we expect things to work.</p><p>Now the real meat. While I don&#39;t know that I&#39;d consider expectations &#34;repeating&#34; code, but this is probably the biggest legitimate criticism to unit tests and mocking frameworks; the knowledge the tests often have to have about the specific method they&#39;re testing.</p><p>But that&#39;s not the end of the world. Yes if you completely change how you do data access the unit test will have to drastically change too, but that&#39;s unlikely. If your DAO has a proper interface on it and respects the open/closed principle this is an unlikely scenario. So you probably will only catch regressions or have to write more tests for new functionality rather than have to refactor for changed functionality.</p><p>So I&#39;d say just make sure your service dependencies are well abstracted, try your best to make them closed for modification (+open for extension) and you will be in about as good a shape as you can be.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../c-interfacing-application-code-with-unit-tests/'>C++ &#8211; Interfacing application code with unit tests</a></li><li class="list-group-item"><a href='../unit-testing-unit-testing-its-a-code-smell-if-youre-refactoring-and-there-are-no-collaborators/'>Unit-testing &#8211; Unit Testing: &#8220;It&#8217;s a code smell if you&#8217;re refactoring and there are no collaborators&#8221;</a></li><li class="list-group-item"><a href='../c-brittle-unit-tests-due-to-need-for-excessive-mocking/'>C# &#8211; Brittle unit tests due to need for excessive mocking</a></li><li class="list-group-item"><a href='../c-unit-testing-side-effect-heavy-code/'>C++ &#8211; Unit testing side effect-heavy code</a></li><li class="list-group-item"><a href='../unit-testing-unit-testing-an-api-client-and-wrappers/'>Unit-testing &#8211; Unit testing an API client and wrappers</a></li><li class="list-group-item"><a href='../unit-testing-how-to-detect-dependency-problems-with-unit-tests-when-you-use-mock-objects/'>Unit-testing &#8211; How to detect dependency problems with unit tests when you use mock objects</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>