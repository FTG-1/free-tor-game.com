<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Php &#8211; How to use DI and DI containers &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1087374 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1087374" class="post-1087374 software type-software status-publish hentry category-software tag-dependency-injection tag-design tag-design-patterns tag-php"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Php &#8211; How to use DI and DI containers</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">dependency-injection</span><span class="mr-2 badge badge-info">design</span><span class="mr-2 badge badge-warning">design-patterns</span><span class="mr-2 badge badge-primary">PHP</span></p><div class="entry-content"><p>I am building a small PHP mvc framework (yes, yet another one), mostly for learning purposes, and I am trying to do it the right way, so I&#39;d like to use a DI container, but I am not asking which one to use but rather how to use one.</p><p>Without going into too much detail, the mvc is divided into modules which have controllers which render views for actions. This is how a request is processed:</p><ul><li>a Main object instantiates a Request object, and a Router, and injects the Request into the Router to figure out which module was called.</li><li>then it instantiates the Module object and sends the Request to that</li><li>the Module creates a ModuleRouter and sends the Request to figure out the controller and action</li><li>it then creates the Controller and the ViewRenderer, and injects the ViewRenderer into the Controller (so that the controller can send data to the view)</li><li>the ViewRenderer needs to know which module, controller and action were called to figure out the path to the view scripts, so the Module has to figure out this and inject it to the ViewRenderer</li><li>the Module then calls the action method on the controller and calls the render method on the ViewRenderer</li></ul><p>For now, I do not have any DI container set up, but what I do have are a bunch of initX() methods that create the required component if it is not already there.<br /> For instance, the Module has the initViewRenderer() method.<br /> These init methods get called right before that component is needed, not before, and if the component was already set it will not initialize it. This allows for the components to be switched, but it does not require manually setting them if they are not there.</p><p>Now, I&#39;d like to do this by implementing a DI container, but still keep the manual configuration to a bare minimum, so if the directory structure and naming convention is followed, everything should work, without even touching the config.</p><p>If I use the DI container, do I then inject it into everything (the container would inject itself when creating a component), so that other components can use it?<br /> When do I register components with the DI?<br /> Can a component register other components with the DI during run-time?<br /> Do I create a &#39;common&#39; config and use that?<br /> How do I then figure out on the fly which components I need and how they need to be set up?</p><p>If Main uses Router which uses Request,<br /> Main then needs to use the container to get Module (or does the module need to be found and set beforehand? How?)<br /> Module uses Router but needs to figure out the settings for the ViewRenderer and the Controller on the fly, not in advance, so my DI container can&#39;t be setting those on the Module before the module figures out the controller and action&#8230;</p><p>What if the controller needs some other service? Do I inject the container into every controller? If I start doing that, I might just inject it into everything&#8230;</p><p>Basically I am looking for the best practices when dealing with stuff like this. I know what DI is and what DI containers do, but I am looking for guidance to using them in real life, and not some isolated examples on the net.</p><p>Sorry for the lengthy post and many thanks in advance.</p><p>EDIT: after reading a bit more, it seems that injection the container itself into objects and making them use the container to find stuff is actually service location, not dependency injection. So my latest idea is to use factories for the stuff that should be dynamically acquired based on something (like getting controllers based on what the router says), and the container would be injected into the factories where it would be used more like a service locator. The non dynamic components would be registered beforehand, and those components would be built by the container and returned fully operational, with all their dependencies filled.</p><p>So the flow would look like this:</p><ul><li>get Main from the container, Main is injected with Request, Router and ModuleFactory which uses the container to find modules. This is all pre-configured</li><li>Main uses ModuleFactory to create the Module, injected with ModuleRouter, Request, ControllerFactory and ViewRenderer.</li><li>Module uses ControllerFactory to create a Controller, injected with any service that it depends on, and then the Module calls the action on the controller, and sends the result to the ViewRenderer to render the view.</li></ul><p>Am I getting anywhere with this?</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>As there is no right or wrong in this question, I could give an example about how I like to use Dependency Injection in PHP.</p><p>I&#39;m using the Dependency Injection Component from <a href="https://github.com/symfony/DependencyInjection" rel="nofollow noreferrer">Symfony</a> with the <a href="https://github.com/loicfrering/LosoDiAnnotationsBundle" rel="nofollow noreferrer">LosoDiAnnotationsBundle</a> and extracted everything from the Bundle to use it as standalone as the Dependency Injection Component. I&#39;m not using the rest of the Symfony Framework.</p><p>There are two functions in my system which use the Dependency Injection Container. The main function and the dispatcher. The main function (application entry point) retrieves the configured Dispatcher like this:</p><pre><code>$dispatcher = $service_container-&gt;get(&#39;Dispatcher&#39;);
$response = $dispatcher-&gt;route( $request );
</code></pre><p>The service called &#34;Dispatcher&#34; is either defined in the global dependency config or annotated in the class itself like this:</p><pre><code> /*
 * @Service
 */
 class Dispatcher {
    /**
     * @Inject({&#34;@service_container&#34;})
     */
    public function __construct($serviceContainer) {
        $this-&gt;serviceContainer  = $serviceContainer;
    }
 }
</code></pre><p>The Dispatcher needs this service locator because thats how my routing works. If you use some extra mapping between routes and called methods, you could avoid this.</p><p>To inject something into other services I use the <code>@inject</code> annotation:</p><pre><code>/** @Inject({&#34;@SomeLogic&#34;, &#34;@SomeGateway&#34;}) */
public function setDependencies(SomeLogic $someLogic, SomeGateway $someGateway) {
    $this-&gt;someLogic = $someLogic;
    $this-&gt;someGateway = $someGateway;
}
</code></pre><p>I like this approach because the configuration of a Service Class is done in the class itself and not in a separate file. Refactoring doesn&#39;t involve messing around with lengthy XML or YAML files.</p><p>To not harm the performance I run a script everytime I change some annotations and at build time (or in general on every vagrant up). It uses Symfony&#39;s ContainerBuilder and PHP Dumper to generate a PHP Lookup file which extends the Base ServiceContainer Class.</p><p>The lookup for the example dispatcher would look like this:</p><pre><code>protected function getDispatcherService()
{
    return $this-&gt;services[&#39;dispatcher&#39;] = new \Some\Dispatcher($this);
}
</code></pre><p>This looks like a lot of work upfront, but it clearly separates concerns later on, especially in bigger projects. Classes do what they are supposed to do and need little to no non-domain-logic code at all.</p><p>And I try to keep factories to an absolutely minimum. The DI Container itself is one big factory and repository but it is not manually maintained.</p><p>EDIT:</p><p>My Routing Function looks like this, request_uri is something like <code>Controller/action/...</code></p><pre><code>    $path = explode( self::ACTION_SEPARATOR, $request_uri );

    if( empty( $path[1] ))
        throw new RoutingException( &#39;Invalid Action&#39; );

    $method = ucfirst( $path[1] );
    $className = $path[0].&#39;Controller&#39;;
    $qualifiedClassName = &#39;Some\\Namespace\\&#39;.$className;

    if( !class_exists( $qualifiedClassName ))
        throw new RoutingException(sprintf(&#39;Invalid controller &#34;%s&#34; for route &#34;%s&#34;&#39;, $qualifiedClassName, $route));
    if( !is_callable( array( $qualifiedClassName, $method ) ))
        throw new RoutingException(sprintf(&#39;Invalid Action &#34;%s&#34;&#39;, $method));


    $controller = $this-&gt;serviceContainer-&gt;get( $className );
    call_user_func( array( $controller, $method ), $message );
</code></pre></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../is-it-a-good-idea-to-register-views-and-view-models-as-singletons-in-an-ioc-container/'>Is it a good idea to register views and view models as singletons in an IOC container</a></li><li class="list-group-item"><a href='../java-how-to-use-guice-to-replace-code-dependent-on-service-locator-implementation/'>Java &#8211; How to use guice to replace code dependent on service locator implementation</a></li><li class="list-group-item"><a href='../c-dependency-injection-with-adapter-pattern/'>C# Dependency Injection with Adapter Pattern</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>