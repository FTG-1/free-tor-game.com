<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>C++ &#8211; GO &#8211; Goroutine and Concurrency &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1079803 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1079803" class="post-1079803 software type-software status-publish hentry category-software tag-c tag-concurrency tag-go tag-operating-systems tag-scheduling"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">C++ &#8211; GO &#8211; Goroutine and Concurrency</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">c</span><span class="mr-2 badge badge-info">concurrency</span><span class="mr-2 badge badge-warning">go</span><span class="mr-2 badge badge-primary">operating systems</span><span class="mr-2 badge badge-danger">scheduling</span></p><div class="entry-content"><p>Background:</p><blockquote><p><strong>pthreads</strong> follow pre-emptive scheduling, whereas <strong>C++ fibers</strong> follow cooperative scheduling.</p><p><strong>With Pthreads</strong>: the current execution path may be interrupted or preempted at any time This means that for threads, data integrity is a big issue because one thread may be stopped in the middle of updating a chunk of data, leaving the integrity of the data in a bad or incomplete state. This also means that the operating system can take advantage of multiple CPUs and CPU cores by running more than one thread at the same time and leaving it up to the developer to guard data access.</p><p>Using C,</p><pre><code>int pthread_create(pthread_t *thread, const pthread_attr_t *attr,
                          void *(*start_routine) (void *), void *arg);
</code></pre><p><strong>Using threads</strong>, application may have Concurrency,</p><p>Properties of Concurrency:</p><p>1) Multiple actors</p><p>2) Shared resource</p><p>3) Rules to access(Atomic/Conditional synchronization)</p></blockquote><hr/><blockquote><p><strong>With C++ fibers</strong>: the current execution path is only interrupted when the fiber yields execution This means that fibers always start and stop in well-defined places, so data integrity is much less of an issue. Also, because fibers are often managed in the user space, expensive context switches and CPU state changes need not be made, making changing from one fiber to the next extremely efficient. On the other hand, since no two fibers can run at exactly the same time, just using fibers alone will not take advantage of multiple CPUs or multiple CPU cores.</p><p>In Win32, a <strong>fiber</strong> is a sort of user-managed thread. A fiber has its own stack and its own instruction pointer etc., but fibers are not scheduled by the OS: you have to call SwitchToFiber explicitly. Threads, by contrast, are pre-emptively scheduled by the operation system.</p><p>So roughly speaking a fiber is a thread that is managed at the application/runti me level rather than being a true OS thread.</p><p>Using C,</p><pre><code>void __stdcall MyScheduler(void *param){
  ....
}

LPVOID *FiberScheduler = CreateFiber(0, MyScheduler, NULL);
</code></pre></blockquote><hr/><blockquote><p>Why C++ fibers?</p><p>OS <strong>threads</strong> give us everything we want, but for a heavy performance penalty: switching between threads involves jumping back and forth from user to kernel mode, possibly even across address space boundaries. These are expensive operations partly because they cause <strong>TLB flushes</strong>, <strong>cache misses</strong> and <strong>CPU pipelining havoc</strong>: that’s also why traps and syscalls can be orders of magnitude slower than regular procedure calls.</p><p>In addition, the kernel schedules threads (i.e. assigns their continuation to a CPU core) using a general-purpose scheduling algorithm, which might take into account all kinds of threads, from those serving a single transaction to those playing an entire video.</p><p><strong>Fibers</strong>, because they are scheduled at the application layer, can use a scheduler that is more appropriate for their use-case. As most fibers are used to <strong>serve transactions</strong>, they are usually active for very short periods of time and block very often. Their behavior is often to be awakened by IO or another fiber, run a short processing cycle, and then transfer control to another fiber (using a queue or another synchronization mechanism).Such behavior is best served by a scheduler employing an algorithm called <strong>“work-stealing”</strong>;When fibers behave this way, <strong>work-stealing</strong> ensures <strong>minimal cache misses</strong> when <strong>switching between fibers</strong>.</p></blockquote><hr/><p>Fiber does not exploit the power of multiple core, because what OS knows is, single threaded process.</p><p>In GO, we invoke goroutines using <code>go</code> keyword</p><pre><code>func main(){
  go f() // f runs as new go routine
  f()
}
</code></pre><hr/><p>Question:</p><p>1) Is GO routine(<code>f</code>) a <em>fiber</em> that is non-preemptively scheduled by GO runtime, in user space?</p><p>2) If yes, Does Concurrency situation arise in GO environment?</p><p>3) Does GO support api for OS level thread?</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>Question #1: <strong>Not really</strong></p><p>Goroutines are a bit weird. They are somewhat similar to fibers, but also somewhat similar to threads.</p><ul><li>They might be preempted.</li><li>They might be concurrent.</li><li>They might share resources.</li><li>They often block on a queue (channel).</li><li>They have their own stacks.</li><li>They are not directly scheduled by the OS, but by the golang runtime.</li></ul><p>The golang runtime usually starts up to <code>GOMAXPROCS</code> threads by default and schedules your goroutines among them.
On any given thread, a goroutine will run until completion or until it blocks on a channel.</p><p>That means you can think of goroutines as fibers shared among threads.</p><p>This means that you can think of goroutines that don&#39;t access global state like you would think of fibers. But for goroutines that do access global state, you need to treat of them like threads.</p><p>Question #2: <strong>Yes</strong></p><p>You need to be mindful when accessing global state!</p><p>However, the default communication mechanism, channels, synchronizes access to shared resources, which eases concurrent programming in Go by a lot.</p><p>Question #3: <strong>Not in the standard library</strong></p><p>If you really want to, you could start threads by writing a library in C for Go that gives you access to the underlying OS thread functions (like <code>pthread_create</code>).</p><p>However, I strongly doubt you could use goroutines and channels on threads created in this way, as the golang runtime scheduler has no knowledge of them.</p><p>This might also cause problems with calls to other libraries (like the standard library!) that assume access to goroutines and channels.</p><p>In conclusion, <strong>I don&#39;t think directly creating and managing threads in Go is a good idea.</strong></p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../parallelism-implies-concurrency-but-not-the-other-way-round-right/'>Parallelism implies concurrency but not the other way round right</a></li><li class="list-group-item"><a href='../why-is-multithreading-often-preferred-for-improving-performance/'>Why is multithreading often preferred for improving performance</a></li><li class="list-group-item"><a href='../should-multi-threading-be-used-for-tasks-which-does-not-involve-io-operation/'>Should multi-threading be used for tasks which does not involve IO operation</a></li><li class="list-group-item"><a href='../java-how-to-make-a-universal-construction-more-efficient/'>Java &#8211; How to make a universal construction more efficient</a></li><li class="list-group-item"><a href='../c-accessing-shared-data-without-blocking-in-tpl/'>C# &#8211; Accessing shared data without blocking in TPL</a></li><li class="list-group-item"><a href='../c-one-process-using-stdthread-2-physical-cpus-4-cores-each-parallelism-level/'>C++ &#8211; One process using std::thread, 2 physical CPUs, 4 cores each, parallelism level</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>