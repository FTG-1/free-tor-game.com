<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>C# &#8211; Iterating through IQueryable with lazyloading results in multiple open DataReaders &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1075484 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1075484" class="post-1075484 software type-software status-publish hentry category-software tag-asp-net tag-c"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">C# &#8211; Iterating through IQueryable with lazyloading results in multiple open DataReaders</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">asp.net</span><span class="mr-2 badge badge-info">c</span></p><div class="entry-content"><p>I got a problem with lazy loading in combination with a foreach loop.</p><p>I&#39;m working on a code first asp.net backend for a website, and sometimes I want to gather information spanning multiple tables/models.</p><p>For example, take this:</p><pre><code>public class Foo
{
    [Key]
    public Int32 Id { get; set; }
    public virtual Bar Bar { get; set; }
    public Int32 someInt { get; set; }
}

public class Bar
{
    [Key]
    public Int32 FooId { get; set; }

    [ForeignKey(&#34;FooId&#34;)]
    public virtual Foo Foo { get; set; }

    public String someString { get; set; }
}

public async Task&lt;IHttpActionResult&gt; getSomeInformation
{
    using(WhateverContext context = new WhateverContext())
    {
        var Foos = context.Foos;

        List&lt;FrontendFriendlyModel&gt; ForTheFrontend = new List&lt;FrontendFriendlyModel&gt;();

        foreach (var Foo in Foos)
        {
            var entry = new FrontendFriendlyModel();
            entry.Id = Foo.Id; //Works fine
            entry.someInt = Foo.someInt; //Works also fine
            entry.someString = Foo.Bar.someString; //Crashes, &#34;There is already an open DataReader associated with this Command&#34;

            ForTheFrontend.Add(entry);
        }

        return Ok(ForTheFrontend); //I convert it to a Json String with Json.net, but thats not relevant I guess
    }
}
</code></pre><p>I know I could activate MARS in my connection String.</p><p>I could also eager load Bar on the spot, and prevent the problem.</p><pre><code>var Foos = context.Foos.Include(f =&gt; f.Bar);
</code></pre><p>From everything I gathered, using MARS is generally not considered good practice, and I don&#39;t like that I have to eager load everything in the at the start .</p><p>Things I could find on google about this, don&#39;t really help me here (Maybe I just suck at googling), and I feel like I&#39;m missing something really basic.</p><p>So I&#39;m wondering, whats the correct way here. Activating MARS? Eager Load everything I need? Cast the IQueryable to a List?</p><pre><code>        var Foos = context.Foos.ToList();
        foreach (var Foo in Foos)
        {
            var entry = new FrontendFriendlyModel();
            entry.Id = Foo.Id; //Works fine
            entry.someInt = Foo.someInt; //Works also fine                
            entry.someString = Foo.Bar.someString; //Now that works, but I don&#39;t get why it doesnt work as IQueryable.
            ForTheFrontend.Add(entry);
        }
</code></pre><p>I don&#39;t understand why I can&#39;t work with an IQueryable here, so maybe someone can enlighten me.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>You have two choices:</p><ol><li>You can eager load, or</li><li>You can enable <a href="https://msdn.microsoft.com/en-us/library/cfa084cz(v=vs.110).aspx" rel="nofollow noreferrer">MARS</a>.</li></ol><p>Presumably, you want to use an <code>IQueryable</code> to obtain deferred execution.  I assume you want to call <code>getSomeInformation()</code> with <code>await</code>.  If you want deferred lookup from the database, you must use MARS; you don&#39;t have a choice.</p><p>However, note that you can still get most of the benefits of deferred execution by eager-loading the related entity.  Your method will still be <code>async</code>.  The only real difference will be that you are pre-loading the entity into memory instead of retrieving it from the database on-demand later on, which is probably what you want anyway.</p><p>As to whether or not the use of MARS is a &#34;good&#34; or &#34;bad&#34; practice, I think it comes down to understanding how to use it properly.  It&#39;s easy to do eager loading correctly; it&#39;s a bit harder with MARS.  Consider these errors that can occur with MARS:</p><blockquote><p>The transaction operation cannot be performed because there are pending requests working on this transaction.</p><p>The server failed to resume the transaction. The transaction active in this session has been committed or aborted by another session.</p><p>The underlying provider failed on Open. The connection was not closed. The connection&#39;s current state is &#34;connecting.&#34;</p><p>ExecuteNonQuery requires the command to have a transaction when the connection assigned to the command is in a pending local transaction. The Transaction property of the command has not been initialized.</p><p>The server failed to resume the transaction.</p></blockquote><p>All of these errors demonstrate fundamental misunderstandings about how MARS works, and how the underlying connection and transaction model should be used.  Microsoft has adequate guidance (linked below) for using MARS in ways that won&#39;t cause these errors.</p><p><strong>Further Reading</strong><br/> <a href="https://technet.microsoft.com/en-us/library/ms131686.aspx" rel="nofollow noreferrer">Using Multiple Active Result Sets</a><br/> <a href="https://msdn.microsoft.com/en-us/library/h32h3abf(v=vs.110).aspx" rel="nofollow noreferrer">Enabling Multiple Active Result Sets</a><br/> <a href="http://www.designlimbo.com/multi-threading-entity-framework-and-mars/" rel="nofollow noreferrer">Exceptions when Using MARS</a></p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../google-analytics-with-multiple-environments/'>Google Analytics with multiple environments</a></li><li class="list-group-item"><a href='../c-how-to-add-properties-to-subclasses-and-access-them-without-casting-from-a-superclass/'>C# &#8211; How to add properties to subclasses and access them without casting from a superclass</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>