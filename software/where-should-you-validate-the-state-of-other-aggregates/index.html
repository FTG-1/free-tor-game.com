<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Where should you validate the state of &#8220;other&#8221; aggregates &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1077966 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1077966" class="post-1077966 software type-software status-publish hentry category-software tag-command-message tag-cqrs tag-domain-driven-design tag-onion-architecture tag-validation"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Where should you validate the state of &#8220;other&#8221; aggregates</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">command-message</span><span class="mr-2 badge badge-info">cqrs</span><span class="mr-2 badge badge-warning">domain-driven-design</span><span class="mr-2 badge badge-primary">onion-architecture</span><span class="mr-2 badge badge-danger">validation</span></p><div class="entry-content"><p>Scenario:</p><p>A customer places an order, then, after receiving the<br /> product, provides feedback on the order process.</p><p>Assume the following aggregate roots:</p><ul><li>Customer</li><li>Order</li><li>Feedback</li></ul><p>Here are the business rules:</p><ol><li>A customer can only provide feedback on their own order, not someone else&#39;s.</li><li><p>A customer can only provide feedback if the order has been paid for.</p><pre><code>class Feedback {
    public function __construct($feedbackId,
                                Customer $customer,
                                Order $order,
                                $content) {
        if ($customer-&gt;customerId() != $order-&gt;customerId()) {
            // Error
        }
        if (!$order-&gt;isPaid()) {
            // Error
        }
        $this-&gt;feedbackId = $feedbackId;
        $this-&gt;customerId = $customerId;
        $this-&gt;orderId = $orderId;
        $this-&gt;content = $content;
    }
}
</code></pre></li></ol><p>Now, assume the business wants a new rule:</p><ol start="3"><li><p>A customer can only provide feedback if the <code>Supplier</code> of the order&#39;s<br /> goods is still operating.</p><pre><code>class Feedback {
    public function __construct($feedbackId,
                                Customer $customer,
                                Order $order,
                                Supplier $supplier,
                                $content) {
        if ($customer-&gt;customerId() != $order-&gt;customerId()) {
            // Error
        }
        if (!$order-&gt;isPaid()) {
            // Error
        }
        // NEW RULE HERE
        if (!$supplier-&gt;isOperating()) {
            // Error
        }
        $this-&gt;feedbackId = $feedbackId;
        $this-&gt;customerId = $customerId;
        $this-&gt;orderId = $orderId;
        $this-&gt;content = $content;
    }
}
</code></pre></li></ol><hr/><p>I&#39;ve placed the implementation of the first two rules within the <code>Feedback</code><br /> aggregate itself. I feel comfortable doing this, especially given that the<br /> <code>Feedback</code> aggregate references all of the other aggregates by identity. E.g.,<br /> the properties of the <code>Feedback</code> component indicate that it knows of the<br /> <em>existance</em> of the other aggregates, so I feel comfortable having it know of<br /> the <em>read only state</em> of these aggregates as well.</p><p>However, based on it&#39;s properties, the <code>Feedback</code> aggregate has no knowledge of the <em>existance</em> of the<br /> <code>Supplier</code> aggregate, so should it have knowledge of the <em>read only state</em> of<br /> this aggregate?</p><p>The alternative solution to implementing rule 3 is to move this logic to the<br /> appropriate <code>CommandHandler</code>. However, this feels like it&#39;s moving domain logic<br /> away from the &#34;center&#34; of my onion-based architecture.</p><p><a href="../../../i.stack.imgur.com/GZ6Mh.png" rel="noreferrer"><img src="../../../i.stack.imgur.com/GZ6Mh.png" alt="Overview of my onion architecture"/></a></p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>If transactional correctness requires one aggregate knowing about the current state of another aggregate, then your model is wrong.</p><p><em>In most cases, transactional correctness is not required</em>.  Businesses tend to have tolerance around latency and stale data.  This is especially true of inconsistencies that are easy to detect and easy to remedy.</p><p>So the command is going to be run by the aggregate that changes state.  To perform the not necessarily correct check, it needs a not necessarily the latest <em>copy</em> of the <em>state</em> of the other aggregate.</p><p>For commands on an existing aggregate, the usual pattern is to pass a Repository to the aggregate, and the aggregate will pass its state to the repository, which provides a query that returns an immutable state/projection of the other aggregate</p><pre><code>class Feedback {
    void downvote(Repository&lt;Supplier.State&gt; query) {
        Supplier.State supplier = query.getById(this-&gt;supplierId);
        boolean isOperating = state.isOperating();
        ....
    }
}
</code></pre><p>But construction patterns are weird - when you are creating the object, the caller already knows the internal state, because it is providing it.  The same pattern works, it just looks pointless</p><pre><code>class Feedback {
    __construct(SupplierId supplierId, SupplierOperatingQuery query ...) {
        Supplier.State supplier = query.getById(this-&gt;supplierId);
        boolean isOperating = state.isOperating();
        ....
    }
}
</code></pre><p>We&#39;re following the rules by keeping all the domain logic in the domain objects, but we aren&#39;t really protecting the business invariant in any useful way by doing so (because all of the same information is available to the application component).  For the creation pattern, it would be just as good to write</p><pre><code>class Feedback {
    __construct(Supplier.State supplier, ...) {
        boolean isOperating = state.isOperating();
        ....
    }
}
</code></pre></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../can-clients-call-methods-on-entities-other-than-the-aggregate-root/'>Can clients call methods on entities other than the aggregate root</a></li><li class="list-group-item"><a href='../find-the-ddd-aggregate-root/'>Find the DDD Aggregate Root</a></li><li class="list-group-item"><a href='../applying-ddd-is-having-multiple-aggregates-representing-the-same-concept-from-a-different-view-a-good-idea/'>Applying DDD, is having multiple aggregates representing the same concept from a different view a good idea</a></li><li class="list-group-item"><a href='../object-oriented-ddd-oop-saving-aggregates-without-orm-public-getter-reflection-or-injecting-repository/'>Object-oriented &#8211; DDD/OOP &#8211; saving Aggregates without ORM. Public getter, reflection, or injecting repository</a></li><li class="list-group-item"><a href='../cqrs-command-that-needs-to-work-with-multiple-aggregate-roots/'>CQRS command that needs to work with multiple aggregate roots</a></li><li class="list-group-item"><a href='../c-domain-driven-design-navigation-properties-and-aggregate/'>C# &#8211; Domain Driven Design // Navigation Properties and Aggregate</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>