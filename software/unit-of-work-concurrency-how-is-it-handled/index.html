<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="https://free-tor-game.com/wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Unit of Work Concurrency, how is it handled &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.min.js?ver=11.2.0' id='highlight-js'></script>     <script>( function( w, d, s, l, i ) {
				w[l] = w[l] || [];
				w[l].push( {'gtm.start': new Date().getTime(), event: 'gtm.js'} );
				var f = d.getElementsByTagName( s )[0],
					j = d.createElement( s ), dl = l != 'dataLayer' ? '&l=' + l : '';
				j.async = true;
				j.src = 'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
				f.parentNode.insertBefore( j, f );
			} )( window, document, 'script', 'dataLayer', ' ' );</script>      <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1072142 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="https://free-tor-game.com/3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="https://free-tor-game.com/contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1072142" class="post-1072142 software type-software status-publish hentry category-software tag-unit-of-work"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Unit of Work Concurrency, how is it handled</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">unit-of-work</span></p><div class="entry-content"><p>I am reading some information about the Unit of Work pattern. There is one thing that is not very clear for me: what will happen when you request a couple of records on a thread (1) and another thread (2) removes one of those records an commit the change?</p><p>Is the removed record on the first thread given a “removed” state? The problem with this approach is that the program has to check every time he want to use a record when it still exists. He also has to lock the record when he wants to use it.</p><p>I cannot think of  any other approach, how is this problem solved in practice?</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>In general a unit of work corresponds with a database transaction.  So from that perspective:</p><pre><code>BEGIN TRANSACTION

-- do stuff

COMMIT TRANSACTION
</code></pre><p>Databases are very advanced with how they handle this.  Any data you read after the <code>BEGIN TRANSACTION</code> statement is &#34;locked&#34; to any other thread (note that you can override this behavior in your <code>SELECT</code> statement with some explicit locking options, but I am ignoring that here).  All other threads that want to access the same data will block until this transaction gets committed or rolled back.  That&#39;s why it&#39;s important to make the work done inside the transaction as short as possible.</p><p>In practice, in an application using the repository pattern, there are two typical scenarios:</p><ol><li>Read-modify-write all within a transaction</li><li>Read in a read-only transaction, modify-write in a later read-write transaction</li></ol><p>For scenario 1, imagine you had a button called &#34;Delete old records&#34;.  The button would (roughly) do this:</p><pre><code>using(var uow = GetUnitOfWork())
{
    var repository = uow.GetRepository&lt;MyRecord&gt;();
    var oldRecords = repository.Entities
        .Where(x =&gt; x.Old)
        .ToList();
    foreach(var record in oldRecords)
    {
        repository.Delete(record);
    }
    uow.Commit(); // sometimes this is optional (default behavior could be to commit)
}
</code></pre><p>Since all of the reading/writing is done inside of a unit of work, which is inside of a database transaction, then if two people clicked this button at the same time, there&#39;s no concurrency issue because the database will serialize the requests.</p><p>Scenario 2 is much more common, and trickier.  Imagine you have an edit screen, like &#34;edit employee&#34;.  You typically don&#39;t want to keep a transaction open the whole time the user has the edit screen open, so first you get the employee information and render it to the screen.  Then the user makes changes and clicks the &#34;Save&#34; button.  It&#39;s reasonable to assume someone else was also editing that employee at the same time, so both started with the same copy of the employee, made 2 different changes, and then they click &#34;Save&#34; (one of them will click first).</p><p>If, inside the save routine, you <em>reload</em> the employee data, modify <em>only the data that changed</em>, and then commit it, then as long as the two users changed something different (user 1 changed the first name and user 2 change the last name) then it&#39;s possible that both changes will be made.  However, if you write your save routine such that you copy all the data from your edit screen back into your employee entity and save it, then user 2&#39;s changes will overwrite user 1&#39;s changes (because user 2 still has the original first name in their screen).  Furthermore, if both user 1 and user 2 changed the same field, then user 2&#39;s change will always overwrite user 1&#39;s change.  This is not the right way to go about it.</p><p>In practice, using something like Entity Framework or NHibernate, there are two concepts: a session and a transaction.  When your edit screen is created, you also create a session.  The session keeps track of all data loaded from the database during that session (including what the original values were).  The session is disposed of when the screen is closed (I&#39;m considering a desktop application here, not a web application).  When you click save, then it starts a transaction, but instead of reloading the data from the database, you just change the original employee entity that you loaded from the database, and then commit the transaction.  The framework then does an <code>UPDATE</code> statement like this (assume the employee table only has 3 columns: &#34;id&#34;, &#34;first_name&#34;, &#34;last_name&#34;):</p><pre><code>BEGIN TRANSACTION

UPDATE Employee
SET first_name = &#39;new first name&#39;
WHERE id = 123
    AND first_name = &#39;old first name&#39;
    AND last_name = &#39;last name&#39;

COMMIT TRANSACTION
</code></pre><p>This is called optimistic concurrency.  What that means is if someone else changed that record between when you loaded the edit screen and when you clicked save, then the update will fail (and the database will indicate this by saying &#34;0 records updated&#34; instead of &#34;1 record updated&#34;).  The framework will detect this error and typically throw an exception (NHibernate throws a <code>StaleObjectStateException</code>).  It&#39;s up to you to handle this exception.  Honestly I just show a message like &#34;someone else edited this record at the same time, so you&#39;ll have to close this screen and try again.&#34;</p><p>Note that there is an optimization you can do.  You can add a new column to your table named <code>VERSION</code>.  Then you can configure your framework to use that column instead of checking every single column in the table to see if they&#39;re changed, so the update would look like this:</p><pre><code>BEGIN TRANSACTION

UPDATE Employee
SET first_name = &#39;new first name&#39;, 
    version = 2
WHERE id = 123
    AND version = 1

COMMIT TRANSACTION
</code></pre><p>So, you&#39;re relying on the database to make sure changes are atomic (indivisible) but you have to do some extra work to handle the human element, since people need to get a copy of the data, think about it for a while and make a change, and the data might have changed during that time.  It&#39;s up to you as a programmer how you want to handle conflicts like that.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='https://free-tor-game.com/software/architecture-how-to-use-the-unit-of-work-and-repository-patterns-in-a-service-oriented-enviroment/'>Architecture &#8211; How to use the unit of work and repository patterns in a service oriented enviroment</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/unit-of-work-repository-pattern-with-dependency-injection-advice/'>Unit of work/repository pattern with dependency injection advice</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/unit-of-work-pattern/'>Unit of Work pattern</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/unit-of-work-repository-pattern-dependency-injection/'>Unit of work + repository pattern + dependency injection</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/avoiding-repository-pattern-implementing-onion-architecture-with-dbcontext-only/'>Avoiding Repository pattern &#8211; implementing Onion Architecture with DbContext only</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='http://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="https://free-tor-game.com/wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>