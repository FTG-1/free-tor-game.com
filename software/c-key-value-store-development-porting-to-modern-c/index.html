<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>C++ &#8211; Key / Value store development porting to modern C++ &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1078103 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1078103" class="post-1078103 software type-software status-publish hentry category-software tag-c tag-c11 tag-pointers tag-smart-pointer"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">C++ &#8211; Key / Value store development porting to modern C++</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">c</span><span class="mr-2 badge badge-info">c++11</span><span class="mr-2 badge badge-warning">pointers</span><span class="mr-2 badge badge-primary">smart-pointer</span></p><div class="entry-content"><p>I am developing a database server similar to Cassandra.</p><p>Development were started in C, but things became very complicated without classes.</p><p>Currently I ported everything in C++11, but I am still learning &#34;modern&#34; C++ and have doubts about lot of things.</p><p>Database will work with Key / Value pairs. Every pair have some more information &#8211; when is created also when it will expire (0 if not expires). Each Pair is immutable.</p><p>Key is C string, Value is void *, but at least for the moment I am operating with the value as C string as well.</p><p>There are abstract <code>IList</code> class. It is inherited from three classes</p><ul><li><code>VectorList</code> &#8211; C dynamic array &#8211; similar to std::vector, but uses <code>realloc</code></li><li><code>LinkList</code> &#8211; made for checks and performance comparison</li><li><code>SkipList</code> &#8211; the class that finally will be used.</li></ul><p>In the future I might do <code>Red Black</code> tree as well.</p><p>Each <code>IList</code> contains zero or more <strong>pointers</strong> to pairs, sorted by key.</p><p>If <code>IList</code> became too long, it can be saved on the disk in a special file. This special file is kind of <code>read only list</code>.</p><p>If you need to search for a key,</p><ul><li>first in memory <code>IList</code> is searched (<code>SkipList</code>, <code>SkipList</code> or <code>LinkList</code>).</li><li>Then search is send to the files sorted by date<br /> (newest file first, oldest file &#8211; last).<br /> All these files are mmap-ed in memory.</li><li>If nothing found, then key is not found.</li></ul><p>I have no doubts about the implementation of the <code>IList</code> things.</p><hr/><p>What is currently puzzling me is following:</p><p>The pairs are with <strong>different</strong> size, they are allocated by <code>new()</code> and they have <code>std::shared_ptr</code> pointed to them.</p><pre><code>class Pair{
public:
    // several methods...
private:
    struct Blob;

    std::shared_ptr&lt;const Blob&gt; _blob;
};

struct Pair::Blob{
    uint64_t    created;
    uint32_t    expires;
    uint32_t    vallen;
    uint16_t    keylen;
    uint8_t     checksum;
    char        buffer[2];
};
</code></pre><p>&#34;buffer&#34; member variable is the one with different size. It stores the key + value.<br /> E.g. if key is 10 characters, and value is another 10 bytes, the whole object will be <code>sizeof(Pair::Blob) + 20</code> (buffer have initial size of 2, because of two null terminating bytes)</p><p>This same layout is used on the disk as well, so I can do something like this:</p><pre><code>// get the blob
Pair::Blob *blob = (Pair::Blob *) &amp; mmaped_array[pos];

// create the pair, true makes std::shared_ptr not to delete the memory,
// since it does not own it.
Pair p = Pair(blob, true);

// however if I want the Pair to own the memory,
// I can copy it, but this is slower operation.
Pair p2 = Pair(blob);
</code></pre><p>However this different size is a problem on lots of places with C++ code.</p><p>For example I can not use <code>std::make_shared()</code>. This is important for me, because if I have 1M Pairs, I would have 2M allocations.</p><p>From the other side, If I do &#34;buffer&#34; to dynamic array (e.g. new char[123]), I will lose mmap &#34;trick&#34;, I will have do two dereferences if I want to check the key and I will add single pointer &#8211; 8 bytes to the class.</p><p>I also tried to &#34;pull&#34; all members from <code>Pair::Blob</code> into <code>Pair</code>, so <code>Pair::Blob</code> to be just the buffer, but when I tested it, it was quite slow, probably because of copying the object data around.</p><p>Another change I am also thinking is to remove <code>Pair</code> class and replace it with <code>std::shared_ptr</code> and to &#34;push&#34; all methods back to <code>Pair::Blob</code>, but this will not help me with variable size <code>Pair::Blob</code> class.</p><h2>I am wondering how I can improve on the object design in order to be more C++ friendly.</h2><hr/><p>The full source code is here:<br /> <a href="https://github.com/nmmmnu/HM3">https://github.com/nmmmnu/HM3</a></p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>The approach I would recommend is to focus on the interface of your key-value store, so as to make it as clean as possible and as nonrestrictive as possible, meaning that it should allow maximum freedom to the callers, but also maximum freedom for choosing how to implement it.</p><p>Then, I would recommend that you provide an as bare as possible, and as clean as possible implementation, without any performance concerns whatsoever.  To me it seems like <code>unordered_map</code> should be your first choice, or perhaps <code>map</code> if some kind of ordering of keys must be exposed by the interface.</p><p>So, first get it to work cleanly and minimally; then, put it to use in a real application; in doing so, you will find what issues you need to address on the interface; then, go ahead and address them.  Most chances are that as a result of changing the interface, you will need to rewrite big parts of the implementation, so any time you have already invested on the first iteration of the implementation beyond the bare minimum amount of time necessary to get it to just barely work is time wasted.</p><p>Then, profile it, and see what needs to be improved in the implementation, without altering the interface.  Or you may have your own ideas about how to improve the implementation, before you even profile.  That&#39;s fine, but it is <em>still</em> no reason to work on these ideas at any earlier point in time.</p><p>You say you hope to do better than <code>map</code>; there are two things that can be said about that:</p><p>a) you probably won&#39;t;</p><p>b) avoid premature optimization at all costs.</p><p>With respect to the implementation, your main issue appears to be memory allocation, since you seem to be concerned with how to structure your design in order to work around problems that you foresee that you are going to have with respect to memory allocation. The best way to address memory allocation concerns in C++ is by implementing a suitable memory allocation management, not by twisting and bending the design around them.  You should consider yourself lucky that you are using C++, which allows you to do your own memory allocation management, as opposed to languages like Java and C#, where you are pretty much stuck with what the language runtime has to offer.</p><p>There are various ways of going about memory management in C++, and the ability to overload the <code>new</code> operator may come in handy. A simplistic memory allocator for your project would preallocate a huge array of bytes and use it as a heap.  (<code>byte* heap</code>.) You would have a <code>firstFreeByte</code> index, initialized to zero, which indicates the first free byte in the heap.  When a request for <code>N</code> bytes comes in, you return the address <code>heap + firstFreeByte</code> and you add <code>N</code> to <code>firstFreeByte</code>.  So, memory allocation becomes so fast and efficient that it becomes virtually no issue.</p><p>Of course, preallocating all of your memory may not be a good idea, so you may have to break your heap into banks which are allocated on demand, and keep serving allocation requests from the at-any-given-moment-newest bank.</p><p>Since your data are immutable, this is a good solution.  It allows you to abandon the idea of variable length objects, and to have each <code>Pair</code> contain a pointer to its data as it should, since the extra memory allocation for the data costs virtually nothing.</p><p>If you want to be able to discard objects from the heap, so as to be able to reclaim their memory, then things become more complicated: you will need to be using not pointers, but pointers to pointers, so that you can always move objects around in the heaps so as to reclaim the space of deleted objects.  Everything becomes a bit slower due to the extra indirection, but everything is still lightning fast compared to using standard runtime library memory allocation routines.</p><p>But all this is of course really useless to be concerned with if you don&#39;t first build a straightforward, bare-minimal, working version of your database, and put it to use in a real application.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../c-debugging-memory-corruption/'>C++ &#8211; Debugging memory corruption</a></li><li class="list-group-item"><a href='../c-2d-linked-list-vs-multidimensional-array-vector/'>C++ &#8211; 2D linked list vs. multidimensional array/vector</a></li><li class="list-group-item"><a href='../c-what-are-r-value-references-used-for/'>C++ &#8211; What are R-value references used for</a></li><li class="list-group-item"><a href='../c-how-to-store-various-sized-values-in-a-vector/'>C++ &#8211; How to store various sized values in a vector</a></li><li class="list-group-item"><a href='../c-handling-errors-for-non-exceptional-cases-in-modern-c/'>C++ &#8211; Handling errors for non-exceptional cases in modern C++</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>