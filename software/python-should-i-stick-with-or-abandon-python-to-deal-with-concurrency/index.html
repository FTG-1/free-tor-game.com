<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Python &#8211; Should I stick with or abandon Python to deal with concurrency &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1066595 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1066595" class="post-1066595 software type-software status-publish hentry category-software tag-concurrency tag-python"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Python &#8211; Should I stick with or abandon Python to deal with concurrency</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">concurrency</span><span class="mr-2 badge badge-info">python</span></p><div class="entry-content"><p>I have a 10K <a href="http://en.wikipedia.org/wiki/Source_lines_of_code">LOC</a> project written in <a href="http://en.wikipedia.org/wiki/Django_(web_framework)">Django</a> with quite a deal of <a href="https://en.wikipedia.org/wiki/Celery_Task_Queue">Celery</a> (<a href="https://en.wikipedia.org/wiki/RabbitMQ">RabbitMQ</a>) for asynchronicity and background jobs where needed, and have come to the conclusion that parts of the system would benefit from being rewritten in <em>something</em> other than Django for better concurrency. Reasons include:</p><ul><li><a href="https://docs.djangoproject.com/en/1.3/topics/signals/">Signals</a> handling and mutable objects. Especially when one signal triggers another, handling them in Django using the <a href="http://en.wikipedia.org/wiki/Object-relational_mapping">ORM</a> can be surprising when instances change or disappear. I want to use some messaging approach where the data passed along doesn&#39;t change in a handler (<a href="http://en.wikipedia.org/wiki/Clojure">Clojure&#39;s</a> copy-on-write approach seems nice, if I got it right).</li><li>Parts of the system are not web-based, and need better support for performing tasks concurrently. For example, the system reads <a href="http://en.wikipedia.org/wiki/Near_field_communication">NFC</a> tags, and when one is read an LED goes on for a few seconds (Celery task), a sound is played (other Celery task), and the database is queried (other task). This is implemented as a Django management command, but Django and its ORM being synchronous by nature and sharing memory is limiting (we are thinking of adding more NFC readers, and I don&#39;t think that the Django+Celery approach will work any longer, I&#39;d like to see better message-passing capabilities).</li></ul><p>What are the pros and cons of using something like <a href="https://en.wikipedia.org/wiki/Twisted_(software)">Twisted</a> or <a href="https://en.wikipedia.org/wiki/Tornado_(web_server)">Tornado</a> compared with going for a language such as <a href="http://en.wikipedia.org/wiki/Erlang_(programming_language)">Erlang</a> or <a href="http://en.wikipedia.org/wiki/Clojure">Clojure</a>? I am interested in practical benefits and detriments.</p><blockquote><p>How did you come to the conclusion that some parts of the system would fare better in another language? Are you suffering performance problems? How severe are those problems? If it can be faster, is it essential that it is faster?</p></blockquote><p><strong>Example 1:</strong> Django at work outside an HTTP request:</p><ol><li>An NFC tag is read.</li><li>The database (and possibly LDAP) is queried, and we want to do something when data becomes available (red or green light, play a sound). This blocks using the Django ORM, but as long as there are Celery workers available it doesn&#39;t matter. May be a problem with more stations.</li></ol><p><strong>Example 2:</strong> “message-passing” using Django signals:</p><ol><li>A <code>post_delete</code> event is  handled, other objects may be altered or deleted because of this.</li><li>At the end, notifications should be sent to users. Here, it would be nice if arguments passed to the notification handler were copies of deleted or to-be-deleted objects and guaranteed not to change in the handler. (It could be done manually simply by not passing objects managed by the ORM to handlers, of course.)</li></ol></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><h1>Opening Thoughts</h1><p>How did you come to the conclusion that some parts of the system would fare better in another language? Are you suffering performance problems? How severe are those problems? If it can be faster, is it essential that it is faster?</p><h2>Single-Thread Asynchrony</h2><p>There are several questions and other web resources that already deal with the differences, pros, and cons of single-thread asynchrony vs. multi-thread concurrency. It’s interesting to read about how <a href="http://blog.mixu.net/2011/02/01/understanding-the-node-js-event-loop/">Node.js&#39;s</a> single-thread asynchronous model performs when I/O is the major bottleneck, and there are many many requests being serviced at once.</p><p>Twisted, Tornado, and other asynchronous models make excellent use of a single-thread. Since a lot of web programming has lots of I/O (network, database, etc.), the time spent waiting on remote calls adds up significantly. That is time that could be spent doing other things—like kicking off other database calls, rendering pages, and generating data. The utilisation of that single-thread is extremely high.</p><p>One of the greatest benefits of single-thread asynchrony is that it uses <em>much</em> less memory. In multi-thread execution, each thread requires a certain amount of reserved memory. As the number of threads increases, so does the amount of memory required just for the threads to exist. Since memory is finite, it means there are bounds on the number of threads that can be created at any one time.</p><hr/><h3>Example</h3><p>In the case of a web server, pretend each request is given its very own thread. Say 1MB of memory is required for each thread, and the web server has 2GB of RAM. This web server would be capable of processing (approximately) 2000 requests at any point in time before there just isn&#39;t enough memory to process any more.</p><p>If your load is significantly higher than this, requests are going to take a very long time (when waiting for older requests to complete), or you’re going to have to throw more servers into the cluster to expand the number of concurrent requests possible.</p><hr/><h2>Multi-thread Concurrency</h2><p>Multi-thread concurrency instead relies on executing several tasks at the same time. That means that if a thread is blocked waiting on a database call to return, other requests can be processed at the same time. Thread utilisation is lower, but the number of threads executing is much larger.</p><p>Multi-thread code is also much harder to reason about. There are issues with locking, synchronisation, and other fun concurrency problems. Single-thread asynchrony doesn&#39;t suffer from the same problems.</p><p>Multi-thread code is much more performant for <strong>CPU intensive</strong> tasks, however. If there exists no opportunities for a thread to “yield”—such as a network call that would normally block—a single-thread model just isn&#39;t going to have any concurrency whatsoever.</p><h2>Both May Coexist</h2><p>There&#39;s of course overlap between the two; they are not mutually exclusive. For instance, multi-thread code can be written in a non-blocking way, to better utilise each thread.</p><p><br/></p><h1>The Bottom Line</h1><p>There are many other issues to consider, but I like to think about the two like this:</p><ul><li>If your program is <strong>I/O bound</strong>, then single-thread asynchrony is probably going to work quite well.</li><li>If your program is <strong>CPU bound</strong>, then a multi-thread system will probably be best.</li></ul><p>In your particular case, you need to determine what kind of asynchronous work is being completed, and how often those tasks arise.</p><ul><li><strong>Do they occur on every request?</strong> If so, memory is probably going to become an issue as the number of requests rise.</li><li><strong>Are these tasks ordered?</strong> If so, you’re going to have to consider synchronisation if using multiple threads.</li><li><strong>Are these tasks CPU intensive?</strong> If so, is a single-thread able to keep up with the load?</li></ul><p>There&#39;s no simple answer. You must consider what your use cases are, and design accordingly. Sometimes an asynchronous single-thread model is better. Other times, using a number of threads to achieve massive parallel processing is required.</p><h2>Other Considerations</h2><p>There are other issues you need to consider also, rather than just the concurrency model you choose. Do you know Erlang or Clojure? Do you think you&#39;d be capable of writing safe multi-thread code in one of these languages such that you improve the performance of your application? Is it going to take a long time to get up to speed in one of these languages, and will the language you learn benefit you in the future?</p><p>How about the difficulties associated with communication between these two systems? Will it be overly complex maintaining two separate systems in parallel? How will the Erlang system receive tasks from Django? How will Erlang communicate those results back to Django? Is performance significant enough a problem that the added complexity is worth it?</p><p><br/></p><h1>Final Thoughts</h1><p>I&#39;ve always found Django to be quick enough, and it is used by some very heavily trafficked sites. There are several performance optimisations you can make to increase the number of concurrent requests and response time. Admittedly, I haven’t done anything with Celery thus far, so the usual performance optimisations are probably not going to solve any issues you may be having with these asynchronous tasks.</p><p>Of course, there’s always the suggestion of throwing more hardware at the problem. Is the cost of provisioning a new server cheaper than the development and maintenance cost of an entirely new subsystem?</p><p>I&#39;ve asked far too many questions at this point, but that was my intention. The answer is not going to be easy without analysis and further detail. Being able to analyse the problems comes down to knowing the questions to ask, though…so hopefully I&#39;ve helped on that front.</p><p>My gut feeling says that a rewrite in another language is unnecessary. The complexity and cost will probably be too great.</p><hr/><p><strong>Edit</strong></p><h1>Response to Follow-Up</h1><p>Your follow-up presents some very interesting use cases.</p><p><br/></p><h2>1. Django working outside HTTP requests</h2><p>Your first example involved reading NFC tags, then querying the database. I don’t think that writing this part in another language will be that useful to you, simply because querying the database or an LDAP server is going to be bound by network I/O (and potentially database performance). On the other hand, the number of concurrent requests will be bound by the server itself, since each management command will be run as its own process. There will be setup and teardown time that impacts performance, since you aren&#39;t sending messages to an already running process. You will, however, be able to send multiple requests at the same time, since each will be an isolated process.</p><p>For this case, I see two avenues you can investigate:</p><ol><li>Ensure that your database is capable of handling multiple queries at once with connection pooling. (Oracle, for example, requires that you configure Django accordingly <code>&#39;OPTIONS&#39;: {&#39;threaded&#39;:True}</code>.) There may be similar configuration options at the database level or Django level that you can tweak for your own database. No matter what language you write your database queries in, you will have to wait for this data to return before you can light up the LEDs. The performance of the querying code <em>can</em> make a difference though, and the Django ORM isn&#39;t lightning fast (<em>but</em>, usually fast enough).</li><li>Minimise setup/teardown time. Have a constantly running process, and send messages to it. (Correct me if I’m wrong, but this is what your original question is actually focusing on.) Whether this process is written in Python/Django or another language/framework is covered above. I don’t like the idea of using management commands so frequently. Is it possible to have a small piece of code running constantly, that pushes messages from the NFC readers onto the message queue, which Celery then reads and forwards to Django? The setup and teardown of a small program, even if it’s written in Python (but not Django!), should be better than starting and stopping a Django program (with all of its subsystems).</li></ol><p>I’m unsure what web server you’re using for Django. <code>mod_wsgi</code> for Apache lets you configure the number of processes and threads within the processes that service requests. Be sure to tweak the relevant configuration of your web server to optimise the number of serviceable requests.</p><p><br/></p><h2>2. “Message-passing” with Django signals</h2><p>Your second use case is also fairly interesting; I’m not sure if I have the answers for that. If you’re deleting model instances, and wish to operate on them later, it might be possible to serialize them <code>JSON.dumps</code> and then deserialize <code>JSON.loads</code>. It’ll be impossible to fully recreate the object graph later on (querying related models), since related fields are lazy loaded from the database, and that link will no longer exist.</p><p>The other option would be to somehow <em>mark</em> an object for deletion, and only delete it at the end of the request/response cycle (after all signals have been serviced). It might require a custom signal to implement this, rather than relying on <code>post_delete</code>.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../python-strategy-for-keeping-up-with-python-language-changes/'>Python &#8211; Strategy for keeping up with (Python) language changes</a></li><li class="list-group-item"><a href='../database-making-api-calls-with-celery/'>Database &#8211; Making API calls with celery</a></li><li class="list-group-item"><a href='../python-how-to-pass-complex-orm-objects-to-background-workers/'>Python &#8211; How to pass complex ORM objects to background workers</a></li><li class="list-group-item"><a href='../python-how-to-properly-handle-global-parameters-for-unit-testing-in-python/'>Python &#8211; How to properly handle global parameters for unit testing in python</a></li><li class="list-group-item"><a href='../possible-concurrency-issues-with-database-read-writes/'>Possible concurrency issues with database read/writes</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>