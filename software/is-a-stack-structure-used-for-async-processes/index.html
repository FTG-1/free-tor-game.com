<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="https://free-tor-game.com/wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Is a stack structure used for async processes &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.min.js?ver=11.2.0' id='highlight-js'></script>     <script>( function( w, d, s, l, i ) {
				w[l] = w[l] || [];
				w[l].push( {'gtm.start': new Date().getTime(), event: 'gtm.js'} );
				var f = d.getElementsByTagName( s )[0],
					j = d.createElement( s ), dl = l != 'dataLayer' ? '&l=' + l : '';
				j.async = true;
				j.src = 'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
				f.parentNode.insertBefore( j, f );
			} )( window, document, 'script', 'dataLayer', ' ' );</script>      <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1081016 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="https://free-tor-game.com/3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="https://free-tor-game.com/contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1081016" class="post-1081016 software type-software status-publish hentry category-software tag-stack"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Is a stack structure used for async processes</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">stack</span></p><div class="entry-content"><p><a href="https://softwareengineering.stackexchange.com/questions/304244/i-understand-what-a-stack-pointer-is-but-what-is-it-used-for">This question</a> has an excellent answer by Eric Lippert describing what the stack is used for.  For year&#39;s I&#39;ve known &#8211; generally speaking &#8211; what the stack is and how it&#39;s used, but parts of his answers make me wonder if this stack structure is less-used today where async programming is the norm.</p><p>From his answer:</p><blockquote><p><em>the stack is part of the reification of continuation in a language without coroutines.</em></p></blockquote><p>Specifically, the <em>without coroutines</em> portion of this has me wondering.</p><p>He explains a bit more here:</p><blockquote><p>Coroutines are functions that can remember where they were, yield control to another coroutine for a while, and then resume where they left off later, but not necessarily immediately after the just-called coroutine yields. Think of &#34;yield return&#34; or &#34;await&#34; in C#, which must remember where they were when the next item is requested or the asynchronous operation completes. Languages with coroutines or similar language features require more advanced data structures than a stack in order to implement continuation.</p></blockquote><p>This is excellent in regards to the stack, but leaves me with an unanswered question about what structure is used when a stack is too simple to handle these language features that require more advanced data structures?</p><p>Is the stack going away as technology progresses?  What replaces it?  Is it a hybrid type of thing? (e.g., does my .NET program use a stack until it hits an async call then switches over to some other structure until completed, at which point the stack is unwound back to a state where it can be sure of the next items, etc?)</p><p>That these scenarios are too advanced for a stack makes perfect sense, but what replaces the stack?  When I had learned about this years ago, the stack was there because it was lightning fast and lightweight, a piece of memory allocated at application away from the heap because it supported highly efficient management for the task at hand (pun intended?).  What&#39;s changed?</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><blockquote><p>Is it a hybrid type of thing? (e.g., does my .NET program use a stack until it hits an async call then switches over to some other structure until completed, at which point the stack is unwound back to a state where it can be sure of the next items, etc?)</p></blockquote><p>Basically yes.</p><p>Suppose we have</p><pre><code>async void MyButton_OnClick() { await Foo(); Bar(); }
async Task Foo() { await Task.Delay(123); Blah(); }
</code></pre><p>Here&#39;s an <em>extremely simplified</em> explanation of how the continuations are reified. The real code is considerably more complex, but this gets the idea across.</p><p>You click the button.  A message is queued up. The message loop processes the message and calls the click handler, putting the return address of the message queue on the stack. That is, the thing that happens <em>after</em> the handler is done is that the message loop has to keep running. So the continuation of the handler is the loop.</p><p>The click handler calls Foo(), putting the return address of itself on the stack. That is, the continuation of Foo is the remainder of the click handler.</p><p>Foo calls Task.Delay, putting the return address of itself on the stack.</p><p>Task.Delay does whatever magic it needs to do to immediately return a Task.  The stack is popped and we&#39;re back in Foo.</p><p>Foo checks the returned task to see if its completed. It is not. The <em>continuation</em> of the <em>await</em> is to call Blah(), so Foo creates a delegate which calls Blah(), and signs that delegate up as the continuation of the task. (I just made a slight mis-statement; did you catch it? If not, we&#39;ll reveal it in a moment.)</p><p>Foo then creates its own Task object, marks it as incomplete, and returns it up the stack to the click handler.</p><p>The click handler examines Foo&#39;s task and discovers it is incomplete. The continuation of the await in the handler is to call Bar(), so the click handler creates a delegate which calls Bar() and sets it as the continuation of the task returned by Foo().  It then returns up the stack to the message loop.</p><p>The message loop keeps processing messages. Eventually the timer magic created by the delay task does its thing and posts a message to the queue saying that the continuation of the delay task can now be executed.  So the message loop calls the task continuation, putting itself on the stack as usual. That delegate calls Blah(). Blah() does what it does and returns up the stack.</p><p>Now what happens?  Here&#39;s the tricky bit. The continuation of the delay task does not <em>only</em> call Blah(). <strong>It has to also trigger a call to Bar()</strong>, but that task doesn&#39;t know about Bar!</p><p>Foo <em>actually</em> created a delegate that (1) calls Blah(), and (2) calls the continuation of the task that Foo created and handed back to the event handler. That&#39;s how we call a delegate that calls Bar().</p><p>And now we&#39;ve done everything that we needed to do, in the correct order. But we never stopped processing messages in the message loop for very long, so the application remained responsive.</p><blockquote><p>That these scenarios are too advanced for a stack makes perfect sense, but what replaces the stack?</p></blockquote><p>A graph of task objects containing references to each other via the closure classes of delegates. Those closure classes are <em>state machines</em> which keep track of the position of the most recently executed await and the values of the locals. Plus, in the example given, a global-state queue of actions implemented by the operating system and the message loop which executes those actions.</p><p>Exercise: how do you suppose this all works in a world without message loops?  For example, console applications. await in a console app is quite different; can you deduce how it works from what you know so far?</p><blockquote><p>When I had learned about this years ago, the stack was there because
 it was lightning fast and lightweight, a piece of memory allocated at
 application away from the heap because it supported highly efficient
 management for the task at hand (pun intended?). What&#39;s changed?</p></blockquote><p>Stacks are a useful data structure when the lifetimes of method activations form a stack, but in my example the activations of the click handler, Foo, Bar and Blah do not form a stack. And therefore the data structure which represents that workflow cannot be a stack; rather it is a graph of heap-allocated tasks and delegates that represents a workflow. The awaits are the points in the workflow where progress cannot be made further in the workflow until work started earlier has completed; while we&#39;re waiting, we can execute <em>other</em> work that does <em>not</em> depend on those particular started tasks having completed.</p><p>The stack is just an array of frames, where frames contain (1) pointers to the middle of functions (where the call happened) and (2) values of local variables and temps. Continuations of tasks are the same thing: the delegate is a pointer to the function and it has a state which references a specific point in the middle of the function (where the await happened), and the closure has fields for each local variable or temporary.  The frames just don&#39;t form a nice neat array anymore, but all the information is the same.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='https://free-tor-game.com/software/local-stack-vs-call-stack/'>Local Stack vs Call Stack</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/i-understand-what-a-stack-pointer-is-but-what-is-it-used-for/'>I understand what a stack pointer is &#8211; but what is it used for</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/can-a-tree-be-used-to-create-a-stack/'>Can a tree be used to create a stack</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/how-is-stack-and-heap-are-assigned-to-each-processes/'>How is stack and heap are assigned to each processes</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/why-does-the-call-stack-have-a-static-maximum-size/'>Why does the call stack have a static maximum size</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/limit-of-the-stack/'>Limit of the stack</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='http://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="https://free-tor-game.com/wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>