<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="https://free-tor-game.com/wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>How to handle business rules that are &#8220;uniqueness&#8221; constraints &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.min.js?ver=11.2.0' id='highlight-js'></script>     <script>( function( w, d, s, l, i ) {
				w[l] = w[l] || [];
				w[l].push( {'gtm.start': new Date().getTime(), event: 'gtm.js'} );
				var f = d.getElementsByTagName( s )[0],
					j = d.createElement( s ), dl = l != 'dataLayer' ? '&l=' + l : '';
				j.async = true;
				j.src = 'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
				f.parentNode.insertBefore( j, f );
			} )( window, document, 'script', 'dataLayer', ' ' );</script>      <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1078685 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="https://free-tor-game.com/3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="https://free-tor-game.com/contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1078685" class="post-1078685 software type-software status-publish hentry category-software tag-domain-driven-design"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">How to handle business rules that are &#8220;uniqueness&#8221; constraints</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">domain-driven-design</span></p><div class="entry-content"><p>In a hypothetical system that handles adding users, there are several business rules. Some of the rules can easily be checked in the model. For example a user registration can only be saved if they entered a 10 digit phone number.</p><p>But what if we want this phone number to be unique?</p><p>In most databases it&#39;s fairly easy to add a constraint that generates an error when trying to store a duplicate value. But when following that approach, the model doesn&#39;t explicitly make clear that a phone number should be unique. If the model is reused or the database is changed, these business rules could be overlooked.</p><p>If we want to encapsulate this knowledge in the domain, we could create a Domain Service (since Entities are not supposed to communicate with the outside world like the database). This UserService could use the UserRepository to check if the phone number already exists.</p><p>The second approach requires more code and an additional round trip to the database, but it improves the domain model.</p><p>Are there (better) alternatives? Which approach would you choose and why?</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><blockquote><p>But what if we want this phone number to be unique?</p></blockquote><p>An important question is &#34;what is it worth to the business?&#34;  How expensive are errors here?  Will a best effort approximation keep you under the error budget?</p><blockquote><p>In most databases it&#39;s fairly easy to add a constraint that generates an error when trying to store a duplicate value. But when following that approach, the model doesn&#39;t explicitly make clear that a phone number should be unique. If the model is reused or the database is changed, these business rules could be overlooked.</p></blockquote><p>That&#39;s the most common approach -- the general term for the uniqueness problem is <a href="http://codebetter.com/gregyoung/2010/08/12/eventual-consistency-and-set-validation/" rel="nofollow noreferrer">set validation</a>, and RDBMS systems tend to be <em>really really good</em> at sets.</p><p>So what that answer might look like is using an RDBMS as your message store, and also have in the schema a table for the phone number mappings, with the appropriate uniqueness constraints.</p><p>But as you note, that solution isn&#39;t entirely satisfactory, because the responsibility for managing the constraints is split between the storage appliance and the domain model.</p><p>If you want to solve this in the model, well... the answer is to pull the set into the domain model.  So far, I&#39;ve only seen two variations.</p><p>One is to make &#34;the set&#34; into an aggregate - so all of the users would be part of a single aggregate.  Checking the uniqueness of the phone number is easy, but contention for other kinds of edits goes up.</p><p>Another is to make &#34;the set of all users with this phone number&#34; into an aggregate.  Instead of &#34;this user has a phone number&#34;, it&#39;s &#34;this phone number has a user&#34;.</p><p>A big consideration in these cases, and the reason you&#39;ll get a lot of advice not to got down this particular rabbit hole, is that your system isn&#39;t the authority for the relationship that you are trying to enforce.  Unless you are a phone switchboard assigning numbers to accounts, it&#39;s not your data, and it can change without giving you notice.  (Note: you get the same problems when using the database to enforce constraints on data you don&#39;t own.)</p><blockquote><p>If you pull phone numbers into model how you will handle concurrency, if someone adds the same number after you add it second time but just after you pulled set from db...</p></blockquote><p>You&#39;ll handle concurrency the same way that you needed to anyway -- first writer wins semantics on your persistence store.  You load an old value into your model, compute the new value, and then apply a compare-and-swap operation on your persistent store.  The winner of the data race is done, the loser gets to compensate using whatever strategy you prefer (abort, retry, ignore)...</p><p>There&#39;s nothing about set validation that is special here if you remember that you need to model the set as a first class entity (which means paying for the contention).</p><blockquote><p>Why would you prefer this over creating a Domain Service to check uniqueness before inserting/updating?</p></blockquote><p>Because if you aren&#39;t locking the set against modification, your validation has race bugs.</p><p>Fundamentally, all of the checks you run in local memory are working off of a <em>copy</em> of the data.  If the underlying source changes while you are looking at the copy, then you haven&#39;t really checked what you think you have.</p><p>I only know of two patterns to address this; you either put a hard lock on the set (which is what we are effectively doing when we arrange that the database enforces the constraint), or you apply an atomic compare-and-swap to ensure that the copy of the data that you used for validation is still up to date.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='https://free-tor-game.com/software/architecture-where-to-validate-domain-model-rules-that-depend-on-database-content/'>Architecture &#8211; Where to validate domain model rules that depend on database content</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/design-ddd-domain-model-factory-design/'>Design &#8211; DDD: Domain Model Factory Design</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/where-should-business-logic-go-in-a-layered-architecture/'>Where should business logic go in a layered architecture</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/event-sourcing-and-cross-aggregate-validation/'>Event Sourcing and cross Aggregate validation</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/c-ddd-best-practices/'>C# &#8211; DDD Best practices</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/ddd-how-to-handle-growing-entity-collection/'>DDD &#8211; how to handle growing entity collection</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='http://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="https://free-tor-game.com/wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>