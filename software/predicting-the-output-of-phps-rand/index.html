<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Predicting the output of PHP&#8217;s rand() &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1066593 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1066593" class="post-1066593 software type-software status-publish hentry category-software tag-random tag-security"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Predicting the output of PHP&#8217;s rand()</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">random</span><span class="mr-2 badge badge-info">Security</span></p><div class="entry-content"><p>I&#39;ve read in numerous sources that the output of PHP&#39;s rand() is predictable as its a PRNG, and I mostly accept that as fact simply because I&#39;ve seen it in so many places.</p><p>I&#39;m interested in a proof-of-concept: how would I go about predicting the output of rand()? From reading <a href="http://improved-security.com/wiki/Randomization_(PHP)#Why_not_use_rand.28.29_and_mt_rand.28.29.3F">this article</a> I understand that the random number is a number returned from a list starting at a pointer (the seed) &#8212; but I can&#39;t imagine how this is predictable.</p><p>Could someone reasonably figure out what random # was generated via rand() at a given moment in time within a few thousand guesses? or even 10,000 guesses? How?</p><p>This is coming up because I saw a auth library which uses rand() to produce a token for users who have lost passwords, and I assumed this was a potential security hole. I&#39;ve since replaced the method with hashing a mixture of <code>openssl_random_pseudo_bytes()</code>, the orignal hashed password, and microtime. After doing this I realized that if I were on the outside looking in, I&#39;d have no idea how to guess the token even knowing it was a md5 of rand().</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>The ability to guess the next value from <code>rand</code> is tied to being able to determine what <code>srand</code> was called with.  In particular, <strong>seeding <code>srand</code> with a predetermined number results in predictable output</strong>!  From the PHP interactive prompt:</p><pre><code>[charles@charles-workstation ~]$ php -a
Interactive shell

php &gt; srand(1024);
php &gt; echo rand(1, 100);
97
php &gt; echo rand(1, 100);
97
php &gt; echo rand(1, 100);
39
php &gt; echo rand(1, 100);
77
php &gt; echo rand(1, 100);
93
php &gt; srand(1024);
php &gt; echo rand(1, 100);
97
php &gt; echo rand(1, 100);
97
php &gt; echo rand(1, 100);
39
php &gt; echo rand(1, 100);
77
php &gt; echo rand(1, 100);
93
php &gt; 
</code></pre><p>This isn&#39;t just some fluke.  Most PHP versions<sup>*</sup> on most platforms<sup>**</sup> will generate the sequence 97, 97, 39, 77, 93 when <code>srand</code>&#39;d with 1024.</p><p>To be clear, this isn&#39;t a problem with PHP, this is a problem with the implementation of <code>rand</code> itself.  The same problem appears in other languages that use the same (or a similar) implementation, including Perl.</p><p>The trick is that any sane version of PHP will have pre-seeded <code>srand</code> with an &#34;unknown&#34; value.  Oh, but it isn&#39;t <em>really</em> unknown.  From <code>ext/standard/php_rand.h</code>:</p><pre class="lang-c prettyprint-override"><code>#define GENERATE_SEED() (((long) (time(0) * getpid())) ^ ((long) (1000000.0 * php_combined_lcg(TSRMLS_C))))
</code></pre><p>So, it&#39;s some math with <code>time()</code>, the PID, and the result of <code>php_combined_lcg</code>, which is defined in <code>ext/standard/lcg.c</code>.  I&#39;m not going to c&amp;p here, as, well, my eyes glazed over and I decided to stop hunting.</p><p>A bit of Googling shows that <a href="http://seclists.org/fulldisclosure/2010/Mar/519" rel="noreferrer">other areas of PHP don&#39;t have the best randomness generation properties</a>, and calls to <code>php_combined_lcg</code> stand out here, especially this bit of analysis:</p><blockquote><p>Not only does this function (<code>gettimeofday</code>) hand us back a precise server timestamp on a silver platter, it also adds in LCG output if we request &#34;more entropy&#34; (from PHP&#39;s <code>uniqid</code>).</p></blockquote><p>Yeah <a href="http://us2.php.net/manual/en/function.uniqid.php" rel="noreferrer">that <code>uniqid</code></a>.  It seems that the value of <code>php_combined_lcg</code> is what we see when we look at the resulting hex digits after calling <code>uniqid</code> with the second argument set to a true value.</p><p>Now, where were we?</p><p>Oh yes. <code>srand</code>.</p><p>So, if the code you&#39;re trying to predict random values from <em>doesn&#39;t</em> call <code>srand</code>, you&#39;re going to need to determine the value provided by <code>php_combined_lcg</code>, which you can get (indirectly?) through a call to <code>uniqid</code>.  With that value in hand, it&#39;s <em>feasible</em> to brute-force the rest of the value -- <code>time()</code>, the PID and some math.  The linked security issue is about breaking sessions, but the same technique would work here.  Again, from the article:</p><blockquote>Here&#39;s a summary of the attack steps outlined above:<ul><li>wait for the server to reboot</li><li>fetch a uniqid value</li><li>brute force the RNG seed from this</li><li>poll the online status to wait for target to appear</li><li>interleave status polls with uniqid polls to keep track of current server time and RNG value</li><li>brute force session ID against server using the time and RNG value interval established in polling</li></ul></blockquote><p>Just replace that last step as required.</p><p>(This security issue was reported in an earlier PHP version (5.3.2) than we have currently (5.3.6), so it&#39;s possible that the behavior of <code>uniqid</code> and/or <code>php_combined_lcg</code> has changed, so this <em>specific</em> technique might not be workable any longer.  YMMV.)</p><p>On the other hand, if the code you&#39;re trying to product <em>calls <code>srand</code> manually</em>, then unless they&#39;re using something many times better than the result of <code>php_combined_lcg</code>, you&#39;re probably going to have a much <em>easier</em> time guessing the value and seeding your local generator with the right number.  Most people that would manually call <code>srand</code> also wouldn&#39;t realize how horrible of an idea this is, and thus aren&#39;t likely to use better values.</p><p>It&#39;s worth noting that <code>mt_rand</code> is also afflicted by the same problem.  Seeding <code>mt_srand</code> with a known value will also produce predictable results.  Basing your entropy off of <code>openssl_random_pseudo_bytes</code> is probably a safer bet.</p><p><strong>tl;dr:</strong> For best results, don&#39;t seed the PHP random number generator, and for goodness&#39; sake, don&#39;t expose <code>uniqid</code> to users.  Doing either or both of these may cause your random numbers to be more guessable.</p><hr/><h2>Update for PHP 7:</h2><p>PHP 7.0 introduces <a href="http://php.net/random_bytes" rel="noreferrer"><code>random_bytes</code></a> and <a href="http://php.net/random_int" rel="noreferrer"><code>random_int</code></a> as core functions.  They use the underlying system&#39;s CSPRNG implementation, making them free from the problems that a seeded random number generator has.  They&#39;re effectively similar to <code>openssl_random_pseudo_bytes</code>, only without needing an extension to be installed. <a href="https://github.com/paragonie/random_compat" rel="noreferrer">A polyfill is available for PHP5</a>.</p><hr/><p>*: The <a href="http://www.hardened-php.net/suhosin/" rel="noreferrer">Suhosin security patch</a> changes the behavior of <code>rand</code> and <code>mt_rand</code> such that they always re-seed with every call.  Suhosin is provided by a third party.  Some Linux distributions include it in their official PHP packages by default, while others make it an option, and others ignore it entirely.</p><p>**: Depending on the platform and the underlying library calls being used, different sequences will be generated than documented here, but the results should still be repeatable unless the Suhosin patch is used.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../php-rand-function-or-not-so-rand/'>PHP rand function (or not so rand)</a></li><li class="list-group-item"><a href='../what-makes-a-hashing-algorithm-secure/'>What makes a hashing algorithm &#8220;secure&#8221;</a></li><li class="list-group-item"><a href='../unit-testing-how-should-i-test-randomness/'>Unit-testing &#8211; How should I test randomness</a></li><li class="list-group-item"><a href='../how-do-functional-languages-handle-random-numbers/'>How do functional languages handle random numbers</a></li><li class="list-group-item"><a href='../api-authentication-one-time-token-vs-dynamic-tokens/'>API Authentication, One time token VS Dynamic tokens</a></li><li class="list-group-item"><a href='../java-testing-a-function-that-uses-random-number-generator/'>Java &#8211; Testing a function that uses random number generator</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>