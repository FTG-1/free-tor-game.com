<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Fast, lossless compression of a video stream &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1075437 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1075437" class="post-1075437 software type-software status-publish hentry category-software tag-algorithms tag-compression"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Fast, lossless compression of a video stream</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">algorithms</span><span class="mr-2 badge badge-info">compression</span></p><div class="entry-content"><p>I have a video coming from a stationary camera. Both the resolution and the FPS are quite high. The data I get is in <a href="http://www.siliconimaging.com/Specifications/AN3 - Bayer Color Processing.PDF" rel="nofollow">Bayer</a> format and uses 10 bit per pixel. As there&#39;s no 10 bit data type on my platform, the original data is stored in memory using 16-bit words. I want to implement some kind of <a href="https://en.wikipedia.org/wiki/Lossless_compression" rel="nofollow">lossless compression</a> of the data before transmitting it over a network.</p><ul><li>The camera does not move, so big parts of consecutive frames are<br /> nearly identical &#8211; but still not completely, due to the inevitable<br /> noise (denoising is not an option, as it is supposed to be lossless<br /> and shouldn&#39;t &#34;lose&#34; even the noise).</li><li>Because of high FPS, even the parts that change don&#39;t change much<br /> between any two consecutive frames.</li><li>However, it looks like the camera also shakes a little. Very little, but still, even the stationary objects are not completely so in the image space.</li><li>The compression has to be done on the fly, so I can not gather a lot<br /> of frames and compress them all together, but I can look 1 frame back<br /> and use it as a reference.</li></ul><p>Based on the above, my first thought was to bit-pack the data, so that those 6 redundant bits are not wasted on every word. However, I thought that if I use some entropy coding (e. g. Huffman etc.), that redundancy would be automatically taken into account, so no extra packing is necessary. So I&#39;ve done the following:</p><ul><li>Took binary difference between two consecutive frames. The original<br /> data range was 0~1023 (e. g. unsigned 10 bits). Difference data<br /> becomes signed and the range increases to -1023~1023, but the data<br /> variation (or what&#39;s the correct mathematical term) becomes much less<br /> than in the original data, in fact, most of the values are, not<br /> surprisingly, close to zero.</li><li>Applied Rice coding to the difference. From what I understand, it<br /> looks like a good choice for data sets of mostly small numerical<br /> values.</li></ul><p>This gives me about 60% reduction in size for 1280&#215;720 frames, and my test system (Linux in VirtualBox on a single core) can do ~40 such compressions per second (without much optimization). Not that great, but reasonable, I guess (or is it?).</p><p>Are there better ways? Any common mistakes I made? Any general steps I missed? Higher resolution frames may be used later &#8211; should I expect better compression rates for bigger frame sizes?</p><p>UPD.:</p><ul><li>I used <a href="http://bcl.comli.eu/" rel="nofollow">this library</a> for Rice encoding. The library is very slow (the author himself describes it as something for learning rather than for real use), for example it reads and writes bits one-by-one in loops, which kills performance. Initially it only gave me ~20 FPS, after some very basic optimization it became 40 FPS (as reported above), later I optimized it some more, it became 80. That is on a single i7 core without vectorization.</li><li>As for vectorization, though, unfortunately I couldn&#39;t think of a way to vectorize Rice code (don&#39;t even know if it is at all possible &#8211; could not find any data on Rice code, what I could find about Huffman code suggests that it&#39;s sequential and can&#39;t be efficiently vectorized, that may apply to Rice code as well as other variable-length codes).</li><li>I also tried a completely different approach: split the data into small pieces (e. g. like 64 pixel apiece) and use simple <a href="https://en.wikipedia.org/wiki/Zero_suppression" rel="nofollow">zero suppression</a>. We find the biggest number in a block, write the number of bits required to represent it to the beginning of the block (4 additional bits were required for that, in my case), then reduce all numbers in the block to the same number of bits. I expected compression rate to be bad, but if the pieces are small, many of them won&#39;t have noise spikes, therefore their binary difference can be reduced to something like 4~6 bits per value, and it was, in fact, only about 5% worse than that of Rice code, while being about twice as fast (e. g. 160 FPS for my case). I tried vectorizing it, but I kinda suck at vectorization, so maybe because of that I could only achieve about x1.8 of further speed-up.</li></ul><p>Because negative numbers don&#39;t have leading zeros, I applied <a href="https://gist.github.com/mfuerstenau/ba870a29e16536fdbaba" rel="nofollow">zigzag encoding</a> after binary difference and before Rice/zero suppression.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>You&#39;ve got temporal prediction, but no spatial. For better compression at the cost of speed,  you should be able to use the pixels above and to the left of the current pixel in the current frame as predictors, as well as the pixel at the same location in the previous frame. The reason for only looking up and left is the same as the reason for only looking at the previous frame; you want to only rely on data you&#39;ve already decoded, and limit how much of it you have to keep around.</p><p>Rice codes are probably a good tradeoff between efficiency and speed, but a static Huffman code (precomputed by you on a sample of video data) might be more efficient and equally fast.</p><p>As for speed, make sure that your code is getting <a href="https://en.wikipedia.org/wiki/Automatic_vectorization" rel="nofollow">vectorized</a> — either by using the right compiler flags and code patterns to allow the compiler to auto-vectorize, or by hand-writing the code to use vector <a href="https://en.wikipedia.org/wiki/Intrinsic_function" rel="nofollow">intrinsics</a> or assembly.</p><p>Finally, is dropping down to 8 bits per pixel a possibility? Obviously that&#39;s leaving the realm of &#34;lossless&#34;, but not only would it reduce the size of your compressed output, it would also, with vectorized code, possibly increase your throughput up to 2x.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../c-fast-compression-in-c-and-decompression-in-c/'>C# &#8211; Fast compression in C++ and decompression in C#</a></li><li class="list-group-item"><a href='../best-two-way-compression-algorithm-for-32-bit-numbers/'>Best two-way compression algorithm for 32-bit numbers</a></li><li class="list-group-item"><a href='../compression-algorithm-for-non-repeating-integers/'>Compression algorithm for non-repeating integers</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>