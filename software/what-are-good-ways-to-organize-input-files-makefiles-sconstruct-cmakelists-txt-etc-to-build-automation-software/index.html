<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>What are good ways to organize input files (Makefiles, SConstruct, CMakeLists.txt, etc.) to build automation software &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1082318 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1082318" class="post-1082318 software type-software status-publish hentry category-software tag-builds tag-refactoring"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">What are good ways to organize input files (Makefiles, SConstruct, CMakeLists.txt, etc.) to build automation software</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">builds</span><span class="mr-2 badge badge-info">refactoring</span></p><div class="entry-content"><p>One thing I like to do with my code is make sure that it&#39;s refactored into manageable pieces. However, when it comes to building the software, I find that whatever build automation software I end up using (lately it&#39;s been GNU Make or SCons) ends up becoming a complete mess. The input files look like long scripts that seem to defy easy refactoring. I&#39;d like to be able to refactor them in some way, but the concept of &#34;function&#34; doesn&#39;t quite behave the same way in some build automation software as it does in a programming language, so I find it difficult to write manageable Makefiles or SConscript files for any projects that are moderately complicated.</p><p>Does anyone have any advice on writing manageable input files for build automation software? Software-agnostic advice would be best, but even advice about a specific build automation tool would be helpful, particularly Make or SCons, since that&#39;s what I&#39;ve been using for projects.</p><p><strong>Edit:</strong> As Thorbjørn has pointed out, I should add some context and usage examples. I&#39;m finishing up my PhD in chemical engineering and I do research in computational science. (I&#39;m a pro tem mod over at SciComp.SE, for those of you who visit.) My projects typically involve a mix of compiled languages (C, C++, Fortran) that do some of the heavy lifting, scripting languages (Python, Perl) for prototyping, and occasionally, domain-specific languages for prototyping or technical purposes.</p><p>I&#39;ve added two examples below, roughly in the 250-line range. The problem for me is generally a lack of modularity. Some of these projects can be organized into modular units, and it&#39;d be nice to abstract the parts of the build along those lines to make it easier for me and future maintainers to keep track of. Breaking each script up into multiple files has been one solution I&#39;ve been toying around with in my head.</p><p>The second example is particularly important, because I&#39;m going to have to a large number of files to it soon.</p><p>Here&#39;s what a 265-line <code>Makefile</code> might look like for me, taken from an actual project, and organized as best I can:</p><pre class="lang-sh prettyprint-override"><code>#!/usr/bin/make
#Directory containing DAEPACK library folder
daepack_root = .
library = $(daepack_root)/lib
wrappers = $(daepack_root)/Wrappers/DSL48S
c_headers = parser.h problemSizes.h
f77_headers=problemSizes.f commonParam.f
f90_headers=problemSizes.f commonParam.f90
includes = -I. -Iinclude -I/usr/include/glib-2.0 \
    -I/usr/lib/glib-2.0/include -I/usr/include/libxml2 \
    -I/usr/include/libgdome -I/usr/include/gtest/

#Fortran 77 environment variables
f77=gfortran
fflags=-ggdb -cpp -fno-second-underscore --coverage -falign-commons \
    -mcmodel=large -fbacktrace -pg 
flibs=

#Fortran 90 environment variables
f90=gfortran
f90flags=-ggdb -cpp -fno-second-underscore --coverage -falign-commons \
    -mcmodel=large -fbacktrace -pg 
f90libs=

#C environment flags
cc=gcc
cflags=-ggdb --coverage $(includes) -mcmodel=large 
clibs=

#Libraries for linking
libs=-L$(library) -ldaepack_sparse -lblas -llapack -ldl -lg2c \
    -lgdome -lxml2 -lgtest -lcunit -lcholmod -lamd -lcolamd -lccolamd \
    -lmetis -lspqr -lm -lblas -llapack -lstdc++ -lpcre

#Object files
objs=main.o $(dsl48sObjs) $(gdxObjs)
gdxObjs = gdxf9def.o gdxf9glu.o gamsglobals_mod.o 
commonObjs=libdsl48s_model.sl cklib.o parser.o $(gdxObjs)
originalModelObjs=originalModel.o dsl48sChemkinModule.o $(commonObjs)
cspSlowModelObjs=cspSlowModel.o dsl48sChemkinModuleSlow.o cspModule.o \
    $(commonObjs)
orthoProjModelObjs=orthoProjModel.o dsl48sChemkinModuleOrthoProj.o \
    orthoProjModule.o basisModule.o spqrUtility.o $(commonObjs)

#Shell environment variable definitions for FUnit
FCFLAGS := $(f90flags)
LDFLAGS := libdsl48s_model.sl cklib.o gdxf9glu.o parser.o spqrUtility.o \
    $(libs)

misc=*table *size.f 
output=*.out

#Ftncheck flags for static analysis of Fortran 77 code
ftnchekflags= -declare -include=. -library -style=block-if,distinct-do,do-enddo,end-name,goto,labeled-stmt,structured-end

all: ckinterp.exe parserTest.exe originalModel.exe cspSlowModel.exe \
    orthoProjModel.exe spqrUtilityTest.exe
#Check code style with lexical analyzer
    @echo Checking program style...
    ftnchek $(ftnchekflags) rhs.f
    ftnchek $(ftnchekflags) resorig.f
    ftnchek $(ftnchekflags) res.f
#   ftnchek $(ftnchekflags) cklib.f
#   ftnchek $(ftnchekflags) ckinterp.f
#Set up baseline coverage data file
    @echo Set up baseline coverage data file
    lcov -c -i -d . -o conpDSL48Sbase.info
#Run unit test on cspModule.f90
    @echo Running unit tests on cspModule.f90...
    funit cspModule
#Generate test coverage data for cspModule.f90
    @echo Generating test coverage data from cspModule.f90 tests...
    lcov -c -d . -o conpDSL48ScspTest.info
#Run unit test on orthoProjModule.f90
    @echo Running unit tests on orthoProjModule.f90...
    funit orthoProjModule
#Generate test coverage data for orthoProjModule.f90
    @echo Generating test coverage data from orthoProjModule.f90 tests...
    lcov -c -d . -o conpDSL48SgenProjTest.info
#Run unit tests on the parser C library
    @echo Running unit tests on parser in C...
    -G_SLICE=always-malloc G_DEBUG=gc-friendly valgrind -v --tool=memcheck \
    --leak-check=full --show-reachable=yes --leak-resolution=high \
    --num-callers=20 --log-file=parserTest.vgdump \
    ./parserTest.exe &gt; parserTest.log
#Generate test coverage data for the parser wrapper C library
    @echo Generating test coverage data for the parser in C...
    lcov -c -d . -o conpDSL48SparserTest.info
#Run unit tests on the SparseQR C library
    @echo Running unit tests on SparseQR library in C...
    ./spqrUtilityTest.exe
#Generate test coverage data for the SparseQR C library
    @echo Generating test coverage data for the SparseQR C library...
    lcov -c -d . -o conpDSL48SsparseTest.info
#Run unit test on basisModule.f90
    @echo Running unit tests on basisModule.f90...
    funit basisModule
#Generate test coverage data for basisModule.f90
    @echo Generating test coverage data from basisModule.f90 tests...
    lcov -c -d . -o conpDSL48SbasisMod.info
#Combine test coverage data
    @echo Combine baseline and test coverage data...
    lcov -a conpDSL48Sbase.info \
    -a conpDSL48ScspTest.info \
    -a conpDSL48SgenProjTest.info \
    -a conpDSL48SbasisMod.info \
    -a conpDSL48SparserTest.info \
    -a conpDSL48SsparseTest.info \
    -o conpDSL48Stotal.info
#Post-process to remove coverage statistics from automatically 
#generated source code.
    @echo Removing coverage statistics for automatically generated source...
    lcov -r conpDSL48Stotal.info basisModule_fun.f90 \
    ckinterp.f cklib.f cspModule_fun.f90 davisSkodjeAd.f90 \
    davisSkodjeJac.f90 davisSkodjeRes.f90 davisSkodjeRhs.f90 \
    davisSkodjeSp.f90 gdxf9def.f90 gdxf9glu.c orthoProjModule_fun.f90 \
    jac.f jacorig.f resad.f resadp.f resorigad.f resorigadp.f ressp.f \
    resorigsp.f senrhs.f senrhsorig.f TestRunner.f90 \
    -o conpDSL48Stotal.info
#Generate HTML report of coverage data
    @echo Generate HTML report of coverage data...
    genhtml conpDSL48Stotal.info
    @echo Open &#34;index.html&#34; in browser for coverage results!

originalModel.exe: $(originalModelObjs) $(f90_headers) $(f77_headers) \
    $(c_headers)
    $(f90) $(f90flags) -o originalModel.exe $(originalModelObjs) $(libs)

originalModel.o: dsl48sChemkinModule.o $(commonObjs) $(f77_headers) \
    $(f90_headers) $(c_headers)
    $(f90) $(f90flags) -c -o originalModel.o originalModel.f90

cspSlowModel.exe: $(cspSlowModelObjs) $(f90_headers) $(f77_headers) \
    $(c_headers)
    $(f90) $(f90flags) -o cspSlowModel.exe $(cspSlowModelObjs) $(libs)

cspSlowModel.o: dsl48sChemkinModuleSlow.o cspModule.o $(commonObjs) \
    $(c_headers) $(f77_headers)
    $(f90) $(f90flags) -c -o cspSlowModel.o cspSlowModel.f90

orthoProjModel.exe: $(orthoProjModelObjs) $(f90_headers) $(f77_headers) \
    $(c_headers) resOrthoFast.o
    $(f90) $(f90flags) -o orthoProjModel.exe $(orthoProjModelObjs) \
    resOrthoFast.o $(libs)

orthoProjModel.o: dsl48sChemkinModuleOrthoProj.o orthoProjModule.o $(commonObjs) \
    $(c_headers) $(f90_headers) $(f77_headers) resOrthoFast.o basisModule.o
    $(f90) $(f90flags) -c -o orthoProjModel.o orthoProjModel.f90

dsl48sChemkinModule.o: dsl48sChemkinModule.f90 cklib.o problemSizes.h \
    parser.o $(c_headers) $(f90_headers)
    $(f90) $(f90flags) -c -o dsl48sChemkinModule.o dsl48sChemkinModule.f90 

dsl48sChemkinModuleSlow.o: dsl48sChemkinModuleSlow.f90 cspModule.o cklib.o \
    problemSizes.h parser.o $(c_headers) $(f90_headers)
    $(f90) $(f90flags) -c -o dsl48sChemkinModuleSlow.o \
    dsl48sChemkinModuleSlow.f90

dsl48sChemkinModuleOrthoProj.o: dsl48sChemkinModuleOrthoProj.f90 \
    orthoProjModule.o basisModule.o cklib.o problemSizes.h \
    parser.o $(c_headers) $(f90_headers)
    $(f90) $(f90flags) -c -o dsl48sChemkinModuleOrthoProj.o \
    dsl48sChemkinModuleOrthoProj.f90

basisModule.o: basisModule.f90 cklib.o spqrUtility.o commonParam.f90
    $(f90) $(f90flags) -c -o basisModule.o basisModule.f90

spqrUtility.o: spqrUtility.h spqrUtility.c
    $(cc) $(cflags) -c -o spqrUtility.o spqrUtility.c

spqrUtilityTest.exe: spqrUtilityTest.o spqrUtility.o
    $(cc) $(cflags) -o spqrUtilityTest.exe spqrUtilityTest.o \
    spqrUtility.o $(libs)

spqrUtilityTest.o: spqrUtilityTest.c spqrUtility.o
    $(cc) $(cflags) -c -o spqrUtilityTest.o spqrUtilityTest.c

cklib.o: cklib.f ckstrt.f
    $(f77) $(fflags) -c -o cklib.o cklib.f

ckinterp.exe: ckinterp.o
    $(f77) $(fflags) -o ckinterp.exe ckinterp.o

ckinterp.o: ckinterp.f
    $(f77) $(fflags) -c -o ckinterp.o ckinterp.f

#Recursive makefile inherited from previous graduate students
libdsl48s_model.sl: $(f77_headers) cklibDAEPACK.f
    cp $(wrappers)/makefile model.mk
    make -f model.mk

resOrthoFast.o: libdsl48s_model.sl
    $(f90) $(f90flags) -c -o resOrthoFast.o resOrthoFast.f90

problemSizes.f: problemSizes.fpp problemSizes.h
    cpp problemSizes.fpp problemSizes.f
    perl -p -i.bak -we &#39;s/# /! /;&#39; problemSizes.f

commonParam.f90: commonParam.f
    perl -p -i.bak -we &#39;s/^#/!/;&#39; commonParam.f
    echo &#34;commonParam t f t fpp&#34; | pref77tof90
    echo &#34;commonParam /&#34; | f77tof90
    perl -p -i.bak -we &#39;s/integer a/!integer a/;&#39; commonParam.f
    perl -p -i.bak -we &#39;s/END   //;&#39; commonParam.f90

commonParam.f: commonParam.fpp problemSizes.h
    cpp commonParam.fpp commonParam.f
    perl -p -i.bak -we &#39;s/^#/!/;&#39; commonParam.f

cspModule.o: cspModule.f90
    $(f90) $(f90flags) -c -o cspModule.o cspModule.f90

orthoProjModule.o: gamsglobals_mod.o gdxf9def.o gdxf9glu.o orthoProjModule.f90 \
    formatLabels.f90
    $(f90) $(f90flags) -c -o orthoProjModule.o orthoProjModule.f90

gdxf9def.o: gdxf9def.f90
    $(f90) $(f90flags) -c -o gdxf9def.o gdxf9def.f90

gdxf9glu.o: gdxf9glu.c gdxf9def.o
#64-bit version of wrappers (with underscores)
    $(cc) $(cflags) -DCIA_LEX -DAPIWRAP_LCASE_DECOR -c -o \
    gdxf9glu.o gdxf9glu.c
#64-bit version of wrappers (without underscores, for C interoperability)
#   $(cc) $(cflags) -DCIA_LEX -DAPIWRAP_LCASE_NODECOR -c gdxf9glu.c
#32-bit version of wrappers
#   $(cc) $(cflags) -DAPIWRAP_LCASE_DECOR -c gdxf9glu.c -Iinclude

gamsglobals_mod.o: gamsglobals_mod.f90 gdxf9def.o gdxf9glu.o
    $(f90) $(f90flags) -c gamsglobals_mod.f90

parser.o: parser.c $(c_headers)
    $(cc) $(cflags) -c -o parser.o parser.c 

parserTest.exe: parserTest.o parser.o
    $(cc) $(cflags) -o parserTest.exe parser.o \
    parserTest.o $(libs)

parserTest.o: parserTest.cpp parser.o
    $(cc) $(cflags) -c -o parserTest.o parserTest.cpp

clean:
    -rm *.bak
    -rm *.f77
    -rm *.log
    -rm commonParam.f90
    -rm problemSizes.f
    -rm commonParam.f
    -make clean -f model.mk
    -rm model.mk
    -rm *.o
    -rm *.mod
    -rm $(misc)
    -rm *.exe
    -funit --clean
    -rm *.gcno
    -rm *.gcda
    -rm *.info
    -rm *.png
    -rm *.html
    -rm *.css
    -rm -rf html
    -rm *.pyc
    -rm *.lst
</code></pre><p>Here&#39;s a 245-line <code>SConstruct</code> file that I&#39;m currently trying to organize for a project that&#39;s roughly as complex:</p><pre class="lang-py prettyprint-override"><code>## \file SConstruct
#  \brief Compiles the library and compiles tests.
#

import SCons

## \brief Build up directory names of each COIN library from package names
#         and versions.
#

## Overall SCons environment
#
env = Environment();

flags = []

## Compile using debug versions?
#
debug = True
debugString = &#39;-debug&#39;
debugFlags = [&#39;-ggdb&#39;]

dynamicLinkFlag = &#39;-Wl,-rpath,&#39;

if debug:
    flags += debugFlags

## Compile Google Test from scratch.
#
GTestVersion = &#39;1.6.0&#39;
GTestStem = &#39;gtest-&#39; + GTestVersion
GTestBuildIncDir = [GTestStem,
                    GTestStem + &#39;/include&#39;,
                    ]
GTestAllLib = env.Library(&#39;lib/libgtest.a&#39;, &#39;gtest-1.6.0/src/gtest-all.cc&#39;,
                      CPPPATH = GTestBuildIncDir,
                      CXXFLAGS = flags)
GTestMainLib = env.Library(&#39;lib/libgtest_main.a&#39;,
                           &#39;gtest-1.6.0/src/gtest_main.cc&#39;,
                           CPPPATH = GTestBuildIncDir,
                           CXXFLAGS = flags)

GTestIncDir = GTestStem + &#39;/include/gtest&#39;
GTestLibDir = &#39;lib&#39;
GTestLibFlags = [&#39;gtest&#39;, &#39;gtest_main&#39;, &#39;pthread&#39;]

## Armadillo matrix library
#
ArmadilloLibFlags = [&#39;armadillo&#39;];

## Quick reminder of SCons flags:
#  CPPPATH = path of headers (include directories)
#  LIBPATH = path of libraries
#  LIBS = flags of libraries
#  CXXFLAGS = C++ compilation flags
#




## Locations of libraries installed on system in standard locations
#
StdIncDir = &#39;/usr/include&#39;
StdLibDir = &#39;/usr/lib&#39;

## Configuration information for COIN libraries
#
CoinUtilsVersion = &#39;2.6.4&#39;
ClpVersion = &#39;1.12.0&#39;
OsiVersion = &#39;0.103.0&#39;
CbcVersion = &#39;2.5.0&#39;

## Some standard directory locations of COIN libraries, with slashes added for
#  for convenience.
#
CoinLibLocation = &#39;/usr/local/COIN/&#39;
StdCoinIncDir = &#39;/include/coin&#39;
StdCoinLibDir = &#39;/lib&#39;

CoinUtilsStem = &#39;CoinUtils-&#39; + CoinUtilsVersion
ClpStem = &#39;Clp-&#39; + ClpVersion
OsiStem = &#39;Osi-&#39; + OsiVersion
CbcStem = &#39;Cbc-&#39; + CbcVersion

if debug:
    CoinUtilsStem += debugString
    CbcStem += debugString
    ClpStem += debugString
    OsiStem += debugString


## Build up include directory names for COIN projects from constituent parts.
#
CoinUtilsIncDir = CoinLibLocation + CoinUtilsStem + StdCoinIncDir
ClpIncDir = CoinLibLocation + ClpStem + StdCoinIncDir
OsiIncDir = CoinLibLocation + OsiStem + StdCoinIncDir
CbcIncDir = CoinLibLocation + CbcStem + StdCoinIncDir

## Build up library names from COIN projects from constituent parts
#
CoinUtilsLibDir = CoinLibLocation + CoinUtilsStem + StdCoinLibDir
ClpLibDir = CoinLibLocation + ClpStem + StdCoinLibDir
OsiLibDir = CoinLibLocation + OsiStem + StdCoinLibDir
CbcLibDir = CoinLibLocation + CbcStem + StdCoinLibDir

## CPLEX
#
CpxStem = &#39;/opt/ibm/ILOG/CPLEX_Studio_Academic123/cplex/&#39;
CpxIncDir = CpxStem + &#39;include/ilcplex&#39;
CpxLibDir = CpxStem + &#39;lib/x86-64_sles10_4.1/static_pic&#39;

## Gurobi
# 
GrbStem = &#39;/opt/gurobi460/linux64/&#39;
GrbIncDir = GrbStem + &#39;include&#39;
GrbLibDir = GrbStem + &#39;lib&#39;

OsiLibFlags = [&#39;Osi&#39;, &#39;CoinUtils&#39;]
ClpLibFlags = [&#39;Clp&#39;, &#39;OsiClp&#39;]
CbcLibFlags = [&#39;Cbc&#39;, &#39;Cgl&#39;]
OsiCpxLibFlags = [&#39;OsiCpx&#39;]
OsiGrbLibFlags = [&#39;OsiGrb&#39;]
CpxLibFlags = [&#39;cplex&#39;, &#39;ilocplex&#39;, &#39;pthread&#39;, &#39;m&#39;]
GrbLibFlags = [&#39;gurobi_c++&#39;, &#39;gurobi46&#39;, &#39;pthread&#39;, &#39;m&#39;]

milpIncDirs = [CoinUtilsIncDir,
               ClpIncDir,
               OsiIncDir,
               CbcIncDir,
               CpxIncDir,
               GrbIncDir,
            GTestIncDir,
               ]
milpLibDirs = [CoinUtilsLibDir,
               ClpLibDir,
               OsiLibDir,
               CbcLibDir,
               CpxLibDir,
               GrbLibDir,
               GTestLibDir,
            ]
milpLibFlags = [OsiCpxLibFlags,
                OsiGrbLibFlags,
                CbcLibFlags,
                ClpLibFlags,
                OsiLibFlags,
                CpxLibFlags,
                GrbLibFlags,
                GTestLibFlags,
                ]
##milpSolver = env.Object(&#39;milpSolver.cpp&#39;,
            ##                         CPPPATH = milpIncDirs,
##                         LIBPATH = milpLibDirs,
##                         CXXFLAGS = flags)
milpSolverTest = env.Program(&#39;milpSolverUnitTest&#39;,
                                  [&#39;milpSolverTest.cpp&#39;,
                                   &#39;milpSolver.cpp&#39;],
                                  CPPPATH = milpIncDirs,
                                  LIBPATH = milpLibDirs,
                                  LIBS = milpLibFlags,
                                  CXXFLAGS = flags,
                                  LINKFLAGS = [&#39;-Wl,-rpath,&#39; + OsiLibDir])
env.Depends(milpSolverTest, [GTestAllLib, GTestMainLib])

## Chemkin source directories and files
#
ChemkinSourceDir = &#39;/mnt/hgfs/DataFromOldLaptop/Data/ModelReductionResearch/Papers/AdaptiveChemistryPaper/AdaptiveChemistry/NonOpenSource/ChemkinII/&#39;;
ChemkinSourceList = [&#39;cklib.f&#39;, &#39;pcmach.f&#39;,&#39;tranlib.f&#39;]
ChemkinSourceList = [ChemkinSourceDir + FileName
                     for FileName in ChemkinSourceList]
env.Depends(&#39;cklib.f&#39;,&#39;ckstrt.f&#39;)

## Cantera include directorie
#
CanteraStem = &#39;/usr/local/cantera&#39;

if debug:
    CanteraStem += debugString

CanteraIncDir = CanteraStem + &#39;/include/cantera&#39;
CanteraLibDir = CanteraStem + &#39;/lib&#39;
CanteraTestingFlags = [&#39;kinetics&#39;, &#39;thermo&#39;, &#39;tpx&#39;, &#39;ctbase&#39;, &#39;m&#39;,]
CanteraLibFlags = [&#39;user&#39;, &#39;oneD&#39;, &#39;zeroD&#39;, &#39;equil&#39;, &#39;kinetics&#39;, &#39;transport&#39;,
                    &#39;thermo&#39;, &#39;ctnumerics&#39;, &#39;ctmath&#39;, &#39;tpx&#39;, &#39;ctspectra&#39;,
                    &#39;converters&#39;, &#39;ctbase&#39;, &#39;cvode&#39;, &#39;ctlapack&#39;, &#39;ctblas&#39;,
                    &#39;ctf2c&#39;, &#39;ctcxx&#39;, &#39;ctf2c&#39;, &#39;m&#39;, &#39;m&#39;, &#39;stdc++&#39;]

CxxFortranFlags = [&#39;g2c&#39;, &#39;gfortran&#39;]; 

chemSolverIncDir = [CanteraIncDir,
                    StdIncDir,
                    &#39;/usr/local/include&#39;,
                    GTestIncDir,
                    ]
chemSolverLibDir = [StdLibDir,
                    CanteraLibDir,
                    GTestLibDir,
                    ]
chemSolverLibFlags = [GTestLibFlags,
                      CxxFortranFlags,
                      CanteraLibFlags,
                      ArmadilloLibFlags,
                      ]

chemSolverTest = env.Program(&#39;chemSolverUnitTest&#39;,
                        [&#39;chemSolverTest.cpp&#39;,
                         &#39;chemSolver.cpp&#39;,
                         &#39;ckwrapper.f90&#39;] + ChemkinSourceList,
                        CPPPATH = chemSolverIncDir,
                        LIBPATH = chemSolverLibDir,
                        LIBS = chemSolverLibFlags,
                        CXXFLAGS = flags,
                        FORTRANFLAGS = flags,
                        F90FLAGS = flags)
env.Depends(chemSolverTest, [GTestAllLib, GTestMainLib])

#env.AddPostAction(milpSolverTest, milpSolverTest[0].abspath)
testAlias = env.Alias(&#39;test&#39;, [milpSolverTest, chemSolverTest])
AlwaysBuild(testAlias)

ckInterp = env.Program(&#39;ckinterp&#39;, ChemkinSourceDir + &#39;ckinterp.f&#39;)

canteraGTestLibFlags = CanteraTestingFlags + GTestLibFlags

#canteraGTestLibFlags = [&#39;kinetics&#39;, &#39;thermo&#39;, &#39;tpx&#39;,
#                        &#39;ctbase&#39;,  &#39;m&#39;, &#39;gtest&#39;, &#39;gtest_main&#39;, &#39;pthread&#39;]

canteraGTest = env.Program(&#39;canteraGTest&#39;,
                           &#39;canteraGTest.cpp&#39;,
                           CPPPATH = chemSolverIncDir,
                           LIBPATH = chemSolverLibDir,
                           LIBS = canteraGTestLibFlags,
                           CXXFLAGS = flags)
env.Depends(canteraGTest, [GTestAllLib, GTestMainLib])

canteraMemTestLibFlags = CanteraTestingFlags

canteraMemTest = env.Program(&#39;canteraMemTest&#39;,
                             &#39;canteraMemTest.cpp&#39;,
                             CPPPATH = chemSolverIncDir,
                             LIBPATH = chemSolverLibDir,
                             LIBS = canteraMemTestLibFlags,
                             CXXFLAGS = flags)
</code></pre></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><h2>Refactoring strategy</h2><p>In addition to the comments by dietbuddha and ThorbjørnRavnAnderson, another way to refactor build scripts is to separate them into multiple files. How you do this depends on the build system.</p><p>For Make, it&#39;s as simple as using the <code>include</code> command, as recommended in <a href="http://aegis.sourceforge.net/auug97.pdf">&#34;Recursive Make Considered Harmful&#34;</a>. This directive works just like <code>#include</code> in the C preprocessor and processes the included file as if it had been cut and pasted in place of the <code>include</code> command. Using the <code>include</code> command, it&#39;s possible to refactor your main <code>Makefile</code> by moving modular pieces into sub-<code>Makefile</code>s.</p><p>CMake has a similar command.</p><p>SCons requires a similar type of approach with different commands. The basic idea of splitting up the build script into a master script and several smaller sub-scripts stays the same, but instead of directly including the text of the smaller scripts in the master build script, SCons treats the smaller scripts like separate namespaces (because SCons uses Python instead of the shell). SCons <code>Environment</code> objects have a method called <code>SConscript()</code> that enables you to import objects from an <code>SConstruct</code> file to subsidiary files called <code>SConscript</code> files that can be used to refactor your build script. The basic idea of <code>SConscript</code> files and the <code>SConscript()</code> command can be found <a href="http://www.scons.org/wiki/SConscript()">here</a> on the <a href="http://www.scons.org/wiki/FrontPage">SCons Wiki</a>. Examples of how to use <code>SConscripts</code> in hierarchical builds can be found <a href="http://www.scons.org/doc/production/HTML/scons-user/x3271.html#AEN3334">here</a> in the <a href="http://www.scons.org/doc/production/HTML/scons-user/">SCons User Guide</a>.</p><p>Extrapolating from these three examples, it seems like the general strategy is to refactor a build script by splitting it into a master script that calls several files. How one does this is idiomatic to the particular build automation software used.</p><h2>SCons Example, Revisited</h2><p>Taking the <code>SConstruct</code> file above, I moved all of the configuration information into a module called <code>build_config.py</code>. All literals live in the global namespace, which could be dangerous for Python, but that&#39;s easily (though somewhat tediously) fixable. I checked ahead to make sure that I had no name clashes with <code>__builtin__</code> (the Python built-in namespace, so I&#39;m not overwriting any important objects).</p><pre class="lang-py prettyprint-override"><code>## \file build_config.py
#  \brief Sets configuration of file locations manually.
#

## Flags for compilers
#

flags = []

## Compile using debug versions?
#
debug = True
debugString = &#39;-debug&#39;
debugFlags = [&#39;-ggdb&#39;]

dynamicLinkFlag = &#39;-Wl,-rpath,&#39;

if debug:
    flags += debugFlags

## Configuration information for GTest
#
GTestVersion = &#39;1.6.0&#39;
GTestStem = &#39;gtest-&#39; + GTestVersion
GTestBuildIncDir = [GTestStem,
                    GTestStem + &#39;/include&#39;,
                    ]

GTestIncDir = GTestStem + &#39;/include/gtest&#39;
GTestLibDir = &#39;lib&#39;
GTestLibFlags = [&#39;gtest&#39;, &#39;gtest_main&#39;, &#39;pthread&#39;]

## Configuration information for Armadillo matrix library
#

ArmadilloLibFlags = [&#39;armadillo&#39;];

## Locations of libraries installed on system in standard locations
#
StdIncDir = &#39;/usr/include&#39;
StdLibDir = &#39;/usr/lib&#39;

## Configuration information for COIN libraries
#
CoinUtilsVersion = &#39;2.6.4&#39;
ClpVersion = &#39;1.12.0&#39;
OsiVersion = &#39;0.103.0&#39;
CbcVersion = &#39;2.5.0&#39;

## Standard directory locations of COIN libraries, with slashes added for
#  for convenience.
#
CoinLibLocation = &#39;/usr/local/COIN/&#39;
StdCoinIncDir = &#39;/include/coin&#39;
StdCoinLibDir = &#39;/lib&#39;

CoinUtilsStem = &#39;CoinUtils-&#39; + CoinUtilsVersion
ClpStem = &#39;Clp-&#39; + ClpVersion
OsiStem = &#39;Osi-&#39; + OsiVersion
CbcStem = &#39;Cbc-&#39; + CbcVersion

if debug:
    CoinUtilsStem += debugString
    CbcStem += debugString
    ClpStem += debugString
    OsiStem += debugString

## Build up include directory names for COIN projects from constituent parts.
#
CoinUtilsIncDir = CoinLibLocation + CoinUtilsStem + StdCoinIncDir
ClpIncDir = CoinLibLocation + ClpStem + StdCoinIncDir
OsiIncDir = CoinLibLocation + OsiStem + StdCoinIncDir
CbcIncDir = CoinLibLocation + CbcStem + StdCoinIncDir

## Build up library names from COIN projects from constituent parts
#
CoinUtilsLibDir = CoinLibLocation + CoinUtilsStem + StdCoinLibDir
ClpLibDir = CoinLibLocation + ClpStem + StdCoinLibDir
OsiLibDir = CoinLibLocation + OsiStem + StdCoinLibDir
CbcLibDir = CoinLibLocation + CbcStem + StdCoinLibDir

## CPLEX
#
CpxStem = &#39;/opt/ibm/ILOG/CPLEX_Studio_Academic123/cplex/&#39;
CpxIncDir = CpxStem + &#39;include/ilcplex&#39;
CpxLibDir = CpxStem + &#39;lib/x86-64_sles10_4.1/static_pic&#39;

## Gurobi
# 
GrbStem = &#39;/opt/gurobi460/linux64/&#39;
GrbIncDir = GrbStem + &#39;include&#39;
GrbLibDir = GrbStem + &#39;lib&#39;

OsiLibFlags = [&#39;Osi&#39;, &#39;CoinUtils&#39;]
ClpLibFlags = [&#39;Clp&#39;, &#39;OsiClp&#39;]
CbcLibFlags = [&#39;Cbc&#39;, &#39;Cgl&#39;]
OsiCpxLibFlags = [&#39;OsiCpx&#39;]
OsiGrbLibFlags = [&#39;OsiGrb&#39;]
CpxLibFlags = [&#39;cplex&#39;, &#39;ilocplex&#39;, &#39;pthread&#39;, &#39;m&#39;]
GrbLibFlags = [&#39;gurobi_c++&#39;, &#39;gurobi46&#39;, &#39;pthread&#39;, &#39;m&#39;]

milpIncDirs = [CoinUtilsIncDir,
               ClpIncDir,
               OsiIncDir,
               CbcIncDir,
               CpxIncDir,
               GrbIncDir,
            GTestIncDir,
               ]
milpLibDirs = [CoinUtilsLibDir,
               ClpLibDir,
               OsiLibDir,
               CbcLibDir,
               CpxLibDir,
               GrbLibDir,
               GTestLibDir,
            ]
milpLibFlags = [OsiCpxLibFlags,
                OsiGrbLibFlags,
                CbcLibFlags,
                ClpLibFlags,
                OsiLibFlags,
                CpxLibFlags,
                GrbLibFlags,
                GTestLibFlags,
                ]

## Configuration information for Chemkin source directories and files
#
ChemkinSourceDir = &#39;/mnt/hgfs/DataFromOldLaptop/Data/ModelReductionResearch/Papers/AdaptiveChemistryPaper/AdaptiveChemistry/NonOpenSource/ChemkinII/&#39;;
ChemkinSourceList = [&#39;cklib.f&#39;, &#39;pcmach.f&#39;,&#39;tranlib.f&#39;]
ChemkinSourceList = [ChemkinSourceDir + FileName
                     for FileName in ChemkinSourceList]

## Configuration information for Cantera
#
CanteraStem = &#39;/usr/local/cantera&#39;

if debug:
    CanteraStem += debugString

CanteraIncDir = CanteraStem + &#39;/include/cantera&#39;
CanteraLibDir = CanteraStem + &#39;/lib&#39;
CanteraTestingFlags = [&#39;kinetics&#39;, &#39;thermo&#39;, &#39;tpx&#39;, &#39;ctbase&#39;, &#39;m&#39;,]
CanteraLibFlags = [&#39;user&#39;, &#39;oneD&#39;, &#39;zeroD&#39;, &#39;equil&#39;, &#39;kinetics&#39;, &#39;transport&#39;,
                    &#39;thermo&#39;, &#39;ctnumerics&#39;, &#39;ctmath&#39;, &#39;tpx&#39;, &#39;ctspectra&#39;,
                    &#39;converters&#39;, &#39;ctbase&#39;, &#39;cvode&#39;, &#39;ctlapack&#39;, &#39;ctblas&#39;,
                    &#39;ctf2c&#39;, &#39;ctcxx&#39;, &#39;ctf2c&#39;, &#39;m&#39;, &#39;m&#39;, &#39;stdc++&#39;]

CxxFortranFlags = [&#39;g2c&#39;, &#39;gfortran&#39;]; 

chemSolverIncDir = [CanteraIncDir,
                    StdIncDir,
                    &#39;/usr/local/include&#39;,
                    GTestIncDir,
                    ]
chemSolverLibDir = [StdLibDir,
                    CanteraLibDir,
                    GTestLibDir,
                    ]
chemSolverLibFlags = [GTestLibFlags,
                      CxxFortranFlags,
                      CanteraLibFlags,
                      ArmadilloLibFlags,
                      ]
canteraGTestLibFlags = CanteraTestingFlags + GTestLibFlags

#canteraGTestLibFlags = [&#39;kinetics&#39;, &#39;thermo&#39;, &#39;tpx&#39;,
#                        &#39;ctbase&#39;,  &#39;m&#39;, &#39;gtest&#39;, &#39;gtest_main&#39;, &#39;pthread&#39;]
</code></pre><p>The main <code>SConstruct</code> file calls a bunch of <code>SConscript</code> files to build modules containing the major features I have in my code. Moving most of the build commands to <code>SConscript</code> files makes the <code>SConstruct</code> file really simple:</p><pre class="lang-py prettyprint-override"><code>## \file SConstruct
#  \brief Compiles the library and compiles tests.
#

import SCons
from build_config import *

## \brief Build up directory names of each COIN library from package names
#         and versions.
#

## Overall SCons environment
#
env = Environment();

## Compile Google Test from source using SConscript file.
#
GTestAllLib, GTestMainLib = env.SConscript(&#39;gtest.scons&#39;,
                                           exports=[&#39;env&#39;])

## Compile MILP solver module and tests from source using SConscript file.
#
milpSolverTest = env.SConscript(&#39;milpSolver.scons&#39;,
                                exports=[&#39;env&#39;])

## Compile chemistry solver module and associated tests from source
#  using SConscript file.
chemSolverTest, canteraGTest = env.SConscript(&#39;chemSolver.scons&#39;,
                                              exports=[&#39;env&#39;])

## Since all tests use GTest, make the dependency of the module
# tests on the GTest libraries explicit.
env.Depends(milpSolverTest, [GTestAllLib, GTestMainLib])
env.Depends(chemSolverTest, [GTestAllLib, GTestMainLib])
env.Depends(canteraGTest, [GTestAllLib, GTestMainLib])

#env.AddPostAction(milpSolverTest, milpSolverTest[0].abspath)
testAlias = env.Alias(&#39;test&#39;, [milpSolverTest, chemSolverTest])
AlwaysBuild(testAlias)
</code></pre><p>Then all of three <code>SConscript</code> files have the extension <code>.scons</code> and break up the project into modules representing different functionality.</p><p>Google Test <code>SConscript</code> file:</p><pre class="lang-py prettyprint-override"><code>## \file gtest.scons
#  \brief SConscript file that contains information for SCons build of
#  GTest. Use Python syntax highlighting for source.

from build_config import *
Import(&#39;env&#39;)

## Compile Google Test from scratch.
#
GTestAllLib = env.Library(&#39;lib/libgtest.a&#39;, &#39;gtest-1.6.0/src/gtest-all.cc&#39;,
                      CPPPATH = GTestBuildIncDir,
                      CXXFLAGS = flags)
GTestMainLib = env.Library(&#39;lib/libgtest_main.a&#39;,
                           &#39;gtest-1.6.0/src/gtest_main.cc&#39;,
                           CPPPATH = GTestBuildIncDir,
                           CXXFLAGS = flags)

Return(&#39;GTestAllLib&#39;, &#39;GTestMainLib&#39;)
</code></pre><p>Mixed-integer linear programming solver <code>SConscript</code> file:</p><pre class="lang-py prettyprint-override"><code>## \file milpSolver.scons
#  \brief SConscript file that contains information for SCons build of
#  mixed-integer linear programming solver module. Use Python syntax
#  highlighting for source.

from build_config import *
Import(&#39;env&#39;)

## Compile MILP solver module and tests.
#

##milpSolver = env.Object(&#39;milpSolver.cpp&#39;,
            ##                         CPPPATH = milpIncDirs,
##                         LIBPATH = milpLibDirs,
##                         CXXFLAGS = flags)
milpSolverTest = env.Program(&#39;milpSolverUnitTest&#39;,
                                  [&#39;milpSolverTest.cpp&#39;,
                                   &#39;milpSolver.cpp&#39;],
                                  CPPPATH = milpIncDirs,
                                  LIBPATH = milpLibDirs,
                                  LIBS = milpLibFlags,
                                  CXXFLAGS = flags,
                                  LINKFLAGS = [&#39;-Wl,-rpath,&#39; + OsiLibDir])

Return(&#39;milpSolverTest&#39;)
</code></pre><p>Chemistry engine <code>SConscript</code> file:</p><pre class="lang-py prettyprint-override"><code>## \file chemSolver.scons
#  \brief  SConscript file that sets up SCons build of chemistry solver module.
#  Use Python syntax highlighting for source.

from build_config import *
Import(&#39;env&#39;)

## Compile CHEMKIN interpreter.
#
ckInterp = env.Program(&#39;ckinterp&#39;, ChemkinSourceDir + &#39;ckinterp.f&#39;)

## Enforce explicit dependence of CHEMKIN library on CHEMKIN
#  parameter file &#39;ckstrt.f&#39; because SCons&#39; scanner won&#39;t pick it up.
env.Depends(&#39;cklib.f&#39;,&#39;ckstrt.f&#39;)

chemSolverTest = env.Program(&#39;chemSolverUnitTest&#39;,
                        [&#39;chemSolverTest.cpp&#39;,
                         &#39;chemSolver.cpp&#39;,
                         &#39;ckwrapper.f90&#39;] + ChemkinSourceList,
                        CPPPATH = chemSolverIncDir,
                        LIBPATH = chemSolverLibDir,
                        LIBS = chemSolverLibFlags,
                        CXXFLAGS = flags,
                        FORTRANFLAGS = flags,
                        F90FLAGS = flags)

canteraGTest = env.Program(&#39;canteraGTest&#39;,
                           &#39;canteraGTest.cpp&#39;,
                           CPPPATH = chemSolverIncDir,
                           LIBPATH = chemSolverLibDir,
                           LIBS = canteraGTestLibFlags,
                           CXXFLAGS = flags)

canteraMemTestLibFlags = CanteraTestingFlags

canteraMemTest = env.Program(&#39;canteraMemTest&#39;,
                             &#39;canteraMemTest.cpp&#39;,
                             CPPPATH = chemSolverIncDir,
                             LIBPATH = chemSolverLibDir,
                             LIBS = canteraMemTestLibFlags,
                             CXXFLAGS = flags)

Return(&#39;chemSolverTest&#39;, &#39;canteraGTest&#39;)
</code></pre><p>The combination of these five files is probably a bit longer than the original long file, but it&#39;s easier for me to manage because I can separate the build into a configuration file, and a bunch of mostly uncoupled units, so I don&#39;t have to keep track of the whole build in my mind at one time.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../object-oriented-what-are-the-practical-ways-to-implement-the-srp/'>Object-oriented &#8211; What are the practical ways to implement the SRP</a></li><li class="list-group-item"><a href='../what-software-models-are-appropriate-for-daily-builds-and-continuous-integration/'>What software models are appropriate for daily builds and continuous integration</a></li><li class="list-group-item"><a href='../object-oriented-did-the-gradual-shift-in-methodology-of-writing-code-affect-system-performance-and-should-i-care/'>Object-oriented &#8211; Did the gradual shift in methodology of writing code affect system performance? And Should I care</a></li><li class="list-group-item"><a href='../what-are-the-advantages-of-build-scripts/'>What are the advantages of build scripts</a></li><li class="list-group-item"><a href='../c-is-it-good-practice-to-check-in-updated-assemblyinfo-cs-files-after-build/'>C# &#8211; Is it good practice to check in updated assemblyinfo.cs files after build</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>