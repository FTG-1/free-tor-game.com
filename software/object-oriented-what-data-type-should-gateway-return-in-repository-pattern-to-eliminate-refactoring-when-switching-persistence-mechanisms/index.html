<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Object-oriented &#8211; What data type should Gateway return in Repository Pattern to eliminate refactoring when switching persistence mechanisms &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1079162 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1079162" class="post-1079162 software type-software status-publish hentry category-software tag-object-oriented tag-persistence tag-refactoring tag-repository"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Object-oriented &#8211; What data type should Gateway return in Repository Pattern to eliminate refactoring when switching persistence mechanisms</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">object-oriented</span><span class="mr-2 badge badge-info">persistence</span><span class="mr-2 badge badge-warning">refactoring</span><span class="mr-2 badge badge-primary">repository</span></p><div class="entry-content"><p>Following <a href="http://code.tutsplus.com/tutorials/the-repository-design-pattern--net-35804">this description</a> of the Repository Pattern, we have three main concerns that need their own classes:</p><ol><li>The &#34;Repository,&#34; which takes and returns Domain Models.</li><li>The &#34;Gateway,&#34; which takes data from the Domain Model and returns some sort of generic data</li><li>The &#34;Factory,&#34; which takes the &#34;generic&#34; data from the Gateway and maps it to the Domain Model</li></ol><p>A Repository needs two objects in order to do its job:</p><ol><li>A &#34;Gateway&#34; for interacting with persistent storage</li><li>A &#34;Factory&#34; to translate data from the Gateway into the Domain Model</li></ol><p>When dealing with strongly typed languages, every variable needs a &#34;Type.&#34; If you specify that Type and use it in your Repository, you are coupling it to the underlying data model of the persistence layer, and then passing it on to the Factory, but the examples I find show the Repository dealing directly with both the Gateway <em>and</em> Factory.</p><p>An example of the interfaces for a &#34;Blog&#34;</p><pre class="lang-cs prettyprint-override"><code>public interface IBlogGateway
{
    // Returns generic data type so switching persistence
    // does not require refactoring in the Repository
    object Find(long id);
}

public interface IBlogFactory
{
    // Accepts generic data type so switching persistence
    // does not require refactoring in the Repository
    Blog Make(object data);
}

public interface IBlogRepository
{
    Blog Find(long id);
}
</code></pre><p>And the implementation of the interfaces:</p><pre class="lang-cs prettyprint-override"><code>public class SqlBlogGateway : IBlogGateway
{
    public object Find(long id)
    {
        DataTable table = // Find from database
        DataRow row = table.Rows.Count == 1
                    ? table.Rows[0]
                    : null;

        // Implicit cast from DataRow to object (this code smells)
        return row;
    }
}

public class SqlBlogFactory : IBlogFactory
{
    public Blog Make(object data)
    {
        // Explicit cast from object to DataRow (this code smells)
        DataRow row = (DataRow)data;
        Blog blog = new Blog(long.Parse(row[&#34;ID&#34;].ToString()))
        {
            Title = row.Field&lt;string&gt;(&#34;TITLE&#34;)
        };

        return blog;
    }
}

public class BlogRepository : IBlogRepository
{
    private IBlogFactory factory;
    private IBlogGateway gateway;

    public BlogRepository(IBlogFactory factory, IBlogGateway gateway)
    {
        this.factory = factory;
        this.gateway = gateway;
    }

    public Blog Find(long id)
    {
        object data = gateway.Find(id);

        if (data == null)
            return null;

        return factory.Make(data);
    }
}
</code></pre><p>Specifically I&#39;m working with C# in .NET, but this is applicable to any strongly typed object oriented language. When persisting to a database, we could deal with <code>DataSet</code>, <code>DataTable</code> and <code>DataRow</code> objects (or <code>array</code> for PHP or <code>HashTable</code> for Java). When it comes time to refactor the &#34;Gateway&#34; to persist to a web service those Types will not suffice, because a web service is not likely to use a <code>DataTable</code>. Instead it will specify it&#39;s own Data Transfer Object.</p><p>You could have the Gateway return an <code>object</code> type, and the &#34;Factory&#34; take an <code>object</code> type and cast it to the proper type, but then you lose all the benefits of a strongly typed language, such as compile time checking and Intellisense/Auto-Complete in an IDE. Further more if you cast up to <code>object</code> then back down to a type specific to the Gateway, you really can introduce some funky, hard to debug runtime errors. It feels like the Repository needs a Gateway, and a Gateway needs a Factory, but the Repository <em>shouldn&#39;t</em> know about the Factory.</p><p><strong>To eliminate the need for refactoring the Repository when changing persistence mechanisms, what data type should the Gateway return?</strong></p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>Ideally, you only want your Gateway class to know what persistence back-end it is talking to, and all the other parts should be agnostic to the back-end. Unfortunately, you are finding that, given this particular implementation, the Factory class cannot be agnostic because it needs to know what type of <code>object</code> it is getting.</p><p>You mentioned that you can&#39;t just return a <code>DataTable</code>, etc. because a non-database persistence back-end wouldn&#39;t use these structures. Can we instead pass an agnostic representation out of the Gateway? Let&#39;s look at some options:</p><ol><li><p>Return a <code>DataTable</code>. If you are <strong>only</strong> going to use database-backed persistence, just do this. It handles a lot of the details for you while being generic across database engines. You don&#39;t want to do this because you are worried that a non-database back-end doesn&#39;t use this.</p></li><li><p>Return a simple, custom DTO object from the Gateway. For the <code>IBlogGateway</code>, it might return a <code>BlogDTO</code> object with just data members. This means more classes, but you can return an object with all the correct types already in place. This also creates a dependency on the DTO class in  all of the other classes, but this dependency is reasonable since they all already deal with <code>Blog</code> and <code>BlogDTO</code> will mirror that dependency.</p></li><li><p>Return a generic container that can be created from any type of persistence. For example, we can convert the <code>DataTable</code> to an <code>IEnumberable&lt;Dictionary&lt;string, object&gt;&gt;</code>, where the enumerable holds the database rows (or web service results, etc.) represented as <code>Dictionary</code>s mapping keys to values. We lose some type information since all the values are <code>object</code>s, but <code>DataRow</code> has a similar limitation that seems otherwise acceptable. This is comparable with the way dynamic languages return results (such as PHP returning an array of associative arrays).</p></li></ol><hr/><p>I want to also point out (as @Ewan noted in a comment to the question) that the Gateway, Factory, and Repository don&#39;t strictly need to be distinct classes/interfaces. A repository can fill the role of all three, especially when starting out. Later, we can refactor out parts as needed. Even if the gateway is factored out, often the factory and repository can be the same class since they have closely related responsibilities (creating objects of a type).</p><p>Contrarily, separating the classes out provides the opportunity for composition, allowing (for example) the gateway to vary in isolation from the rest of the code. Different gateway implementations, corresponding to different back-ends, can be composed in at runtime (and test time) for greater flexibility.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../are-persistence-ignorant-objects-able-to-implement-lazy-loading/'>Are Persistence-Ignorant objects able to implement lazy loading</a></li><li class="list-group-item"><a href='../c-confused-on-how-to-properly-employ-a-repository-pattern-with-service-business-layer-on-top/'>C# &#8211; Confused on how to properly employ a Repository Pattern with Service/Business Layer on top</a></li><li class="list-group-item"><a href='../c-when-are-enums-not-a-code-smell/'>C# &#8211; When are enums NOT a code smell</a></li><li class="list-group-item"><a href='../architecture-should-i-use-a-layer-between-service-and-repository-for-a-clean-architecture-spring/'>Architecture &#8211; Should I use a layer between service and repository for a clean architecture &#8211; Spring</a></li><li class="list-group-item"><a href='../domain-driven-design-updating-and-persisting-aggregates/'>Domain Driven Design &#8211; Updating and persisting aggregates</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>