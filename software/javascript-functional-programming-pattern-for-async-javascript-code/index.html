<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Javascript &#8211; Functional programming pattern for async JavaScript code &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1085663 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1085663" class="post-1085663 software type-software status-publish hentry category-software tag-angularjs tag-asynchronous-programming tag-functional-programming tag-javascript"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Javascript &#8211; Functional programming pattern for async JavaScript code</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">angularjs</span><span class="mr-2 badge badge-info">asynchronous-programming</span><span class="mr-2 badge badge-warning">functional programming</span><span class="mr-2 badge badge-primary">javascript</span></p><div class="entry-content"><p>I have adopted a pattern in one of my projects that I really like and I suspect it&#39;s likely to be something standard.   I&#39;d like to describe it here and see if you guys can tell me how other JavaScript programmers solve this type of problem.</p><p>A few rules I established for myself before I started the project.<br /> 1.  Functional / Lazy evaluation wherever possible.   Don&#39;t do a bunch of things at startup.<br /> 2.  Use promises (I happen to be using Angular&#39;s $q, but the syntax is all pretty much similar)</p><p>For the sake of simplicity, let&#39;s say that I am wanting to update the screen and display say at the top the user&#39;s name, how many Likes they have, and their current Friend count.  Some of this may seem contrived, but bare with me.</p><p>In my controller on the client side I would make simple calls to a client-side service that does something like:</p><pre><code>   function getCurrentUserName() {
       getCurrentUser().then( function(user) {
           return user.name;
       }
   }

   function getCurrentUserLikeCount() {
       getCurrentUser().then( function(user) {
           return user.likeCount;
       }
   }

   function getCurrentUserFriendCount() {
       getCurrentUser().then( function(user) {
           return user.friendCount;
       }
   }
</code></pre><p>Now I might have multiple UI elements that access the controller, and who knows what order the requests might come in at.   Heck, it&#39;s possible there might be a 3rd party widget that access the controller, so there might be multiple calls to one of these routines coming in quickly.</p><p>Now, the first obvious problem is that getCurrentUser() is async and does some kind of an ajax/rest call to the server.    So:<br /> 1) You don&#39;t need to make unnecessary calls to the server.  If getCurrentUser() got called already, you don&#39;t need to call it again (given some rationale such as the user is still logged in, etc.)</p><p>So let&#39;s assume getCurrentUser() is smart enough to cache the results.  On subsequent calls, it may return the cached value (still asynchronously using when()).</p><p>The second problem is, what happens when getCurrentUser() gets called while another call to getCurrentUser() is already processing.   The cache hasn&#39;t been updated yet, so the second call doesn&#39;t see the cache so it makes another HTTP call to the server.   You don&#39;t want that.   So you need to know that there&#39;s a pending request to the server and throttle the call.</p><p>So the pattern I adopted is that an async function that makes a call to the server follows the following high-level idea:<br /> 1.  If it&#39;s the first call, issue the call to the server, and immediately return a promise to the client.  Also, hang on to this promise.   When the server responds, resolve the promise but also keep the original value returned from the server (i.e. cache)</p><ol start="2"><li><p>If it&#39;s not the first call, determine if the first call completed.  If the first called has already completed, return the value that was returned from the server (i.e. the cache).  Of course, you&#39;d do this using when() since the client is expecting a promise.</p></li><li><p>If it&#39;s not the first call, but the first call has not yet completed, then return to the client the cached promise that was returned by the first call.   When then promise is resolved, all clients are notified.</p></li></ol><p>In fact, what also works with the angular $q (and probably others), is to reuse the original promise even after it was returned in the past.  Then you can avoid caching the data as well since the promise contains the data returned from the server.</p><p>I call this whole thing throttling, for lack of a better term.</p><p>The following function wraps an existing async function and makes a new function that automatically throttles:</p><pre><code>    // This routine makes a custom throttle wrapper for the async-function that&#39;s passed in.
    // A throttle function, when called, calls an async function (one that returns a promise)
    // in such a way to ensure the async function is only called when it&#39;s not already in progress.
    // in which case rather than calling it again, this routine returns the original promise to the caller.
    // If it&#39;s already in progress, then the original promise is returned instead.
    var makeThrottleFunction = function (asyncFunction) {
        var asyncPromise = null;
        return function (asyncInParam) {
            if (!asyncPromise) {
                var asyncDeferred = $q.defer();
                asyncPromise = asyncDeferred.promise;
                asyncFunction(asyncInParam).then(function (asyncOutParam) {
                    asyncDeferred.resolve(asyncOutParam);
                }).catch(function (parameters) {
                    return $q.reject(parameters);
                }).finally(function () {
                    asyncPromise = null;
                });
            }
            return asyncPromise;
        };
    };
</code></pre><p>Example usage:</p><pre><code>var getCurrentUser = makeThrottleFunction(function() {
    // async call to server to get data
    // return promise..
});
</code></pre><p>I&#39;m curious what the experts have to say about this approach.  What is an alternative, etc.   I used it all over the place in my app and it works really well.   I also don&#39;t think I could do without it, which begs the question: if something like this isn&#39;t already in the frameworks, then I may be missing something obvious, like some setting or library that already does this very exact thing.   So I&#39;d love to get some feedback.</p><p>Although I&#39;m looking for opinions from others on how they solve this common problem, in order to satisfy this being a Q&amp;A, I think a good answer would be one of the following:<br /> 1.  Point to a library that does this type of thing.<br /> 2.  Points out that there&#39;s a simpler way to do this.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>I&#39;m not aware of a published implementation of this technique, but it&#39;s a fairly standard way of using promises.  An interesting side effect of the composability, reusability, and extensibility of functional programming is that often you don&#39;t find things in libraries that you would expect.</p><p>In a less composable paradigm, you would <em>need</em> support in a library to do something like your throttle function, because you have to weave support for it throughout other functions.  In functional code, programmers just write it themselves once, then they can reuse it everywhere.</p><p>After you write something like this, who do you share it with, and how?  It&#39;s too small to be its own library.  It&#39;s a little too specific to not be considered bloat in a promise library.  Perhaps some sort of promise utilities library, but then it would be in a not very cohesive module with other functions vaguely related to promises, which makes it hard to find.</p><p>What happens to me a lot is I search for 10 minutes or so, then just write it myself because it would only take me a half hour.  I put it in a &#34;utilities&#34; file I keep around with other odds and ends functions that are short but highly reusable, but don&#39;t really fit anywhere.  Then six months later I happen upon it by chance in a community-maintained library with some weird name.</p><p>My point is, with functional programming, not being able to find an existing implementation for something that feels fairly &#34;standard&#34; is not a sign that other people are either doing it in a superior way, or that you&#39;re the first to come up with it.  It&#39;s just a symptom of the difficulty of sharing short, reusable code in a way that&#39;s easy to discover by a search.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../architecture-which-layer-does-async-code-belong/'>Architecture &#8211; Which layer does async code belong</a></li><li class="list-group-item"><a href='../javascript-is-it-ok-to-use-promises-for-caching/'>Javascript &#8211; Is it OK to use Promises for Caching</a></li><li class="list-group-item"><a href='../is-lazy-loading-factories-in-angularjs-using-this-q-defer-method-good-practice/'>Is &#8220;lazy loading&#8221; factories in AngularJS using this $q.defer method good practice</a></li><li class="list-group-item"><a href='../is-there-really-a-fundamental-difference-between-callbacks-and-promises/'>Is there really a fundamental difference between callbacks and Promises</a></li><li class="list-group-item"><a href='../c-why-is-it-necessary-for-every-new-api-to-be-async/'>C# &#8211; Why is it necessary for every new api to be async</a></li><li class="list-group-item"><a href='../javascript-how-do-javascript-engines-convert-async-await-to-promises-under-the-hood/'>Javascript &#8211; How do JavaScript engines convert async/await to promises under the hood</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>