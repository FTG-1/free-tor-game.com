<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="https://free-tor-game.com/wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Forth: How do CREATE and DOES&gt; work exactly &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.min.js?ver=11.2.0' id='highlight-js'></script>     <script>( function( w, d, s, l, i ) {
				w[l] = w[l] || [];
				w[l].push( {'gtm.start': new Date().getTime(), event: 'gtm.js'} );
				var f = d.getElementsByTagName( s )[0],
					j = d.createElement( s ), dl = l != 'dataLayer' ? '&l=' + l : '';
				j.async = true;
				j.src = 'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
				f.parentNode.insertBefore( j, f );
			} )( window, document, 'script', 'dataLayer', ' ' );</script>      <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1073788 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="https://free-tor-game.com/3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="https://free-tor-game.com/contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1073788" class="post-1073788 software type-software status-publish hentry category-software tag-compilation tag-forth tag-implementations"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Forth: How do CREATE and DOES> work exactly</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">compilation</span><span class="mr-2 badge badge-info">forth</span><span class="mr-2 badge badge-warning">implementations</span></p><div class="entry-content"><p>I am in the process of creating my own concatenative language, heavily based on Forth.</p><p>I am having a little trouble understanding how the compiling words <code>CREATE</code> and <code>DOES&gt;</code> work, and how they are implemented (How the state of Forth&#39;s run time environment changes exactly when they are executed).</p><p>I have read the following resources that give a general view, but only of how to use them, and not of how a system implements them:</p><ul><li><a href="http://galileo.phys.virginia.edu/classes/551.jvn.fall01/primer.htm#create" rel="nofollow noreferrer">Forth Primer &#8211; CREATE&#8230;DOES&gt;</a></li><li><a href="http://www.forth.org/svfig/Len/arrays.htm" rel="nofollow noreferrer">Arrays in Forth</a></li><li><a href="http://www.mostlymaths.net/2010/03/forths-create-does-maybe-im-amazed.html" rel="nofollow noreferrer">Forth&#39;s CREATE&#8230;DOES&gt; Maybe I&#39;m amazed?</a></li><li><a href="https://www.taygeta.com/forth/dpans6.htm#6.1.1000" rel="nofollow noreferrer">The sections</a> in the ANS Forth standard (that I had trouble understanding because of the very general terms that are used)</li></ul><p>The following things about the behaviour of these two words are unclear to me:</p><ul><li><code>CREATE</code> takes the next (space-delimited) word from the input stream, and creates a new dictionary item for it.<ul><li>What happens then?</li><li>Does <code>CREATE</code> fill in anything in the new dictionary item, or not?</li><li>What does <code>CREATE</code> return (on the stack?)?</li><li>Is there anything special that happens to the words between <code>CREATE</code> and <code>DOES&gt;</code>?</li></ul></li><li><code>DOES&gt;</code> &#39;fills in&#39; the run time behaviour of the created word.<ul><li>What does <code>DOES&gt;</code> consume as input?</li><li>How does it alter the dictionary entry of the CREATE&#39;d word?</li><li>In code snippets like <code>17 CREATE SEVENTEEN ,</code>, no <code>DOES&gt;</code> is used. Is there some kind of &#39;default behaviour&#39; that <code>DOES&gt;</code> overrides?</li></ul></li></ul><p>These different unclarities of course all arise from the core problem, that I have trouble understanding what is going on, and how these concepts, that seem rather complex, can be/are implemented in a simple manner in a low-level language like Assembly.</p><p>How do <code>CREATE</code> and <code>DOES&gt;</code> work exactly?</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>So, I&#39;m a little late to the game, but these questions (particularly about DOES&gt;) were mystifying me as well, being new to Forth.  Here is what I&#39;ve learned and how I&#39;ve implemented it:</p><p>[<strong>TL;DR:</strong> &#34;CREATE&#34; makes a word with a simple, default behavior.  &#34;DOES&gt;&#34; does not return to its caller. Instead, it uses the return address to put a &#34;goto&#34; in the most recent definition.]</p><p>CREATE does not take anything from the stack or return anything.  It parses a word from the input and makes a dictionary entry for it.  It does fill in the code for the newly-created word with standard boilerplate code that pushes an aligned address on the stack and simply returns (the same aligned address that subsequent &#34;,&#34; (comma) calls would fill in with data).  In my system, the generated code for something like <code>CREATE NewVar</code> would look like this:</p><pre><code>NewVar:    push_data  next_addr
           return
next_addr:
</code></pre><p>Therefore, we could define (initialized) VARIABLE as:</p><pre><code>: VARIABLE CREATE 0 , ;
</code></pre><p>or, in pseudo-machine code:</p><pre><code>VARIABLE:  call       CREATE
           push_data  0
           call       comma
           return
</code></pre><p>Saying something like <code>VARIABLE NewVar</code> would then make NewVar as a word that does the &#34;push_data/return&#34;.  The <code>0 ,</code> then stores a zero at the address that NewVar puts on the stack -- the &#34;next_addr&#34; shown in the code snippet.  Doing things like <code>NewVar @</code> or <code>42 NewVar !</code> then reads and writes that location.</p><p>There is nothing special (at least in my system) about the words between CREATE and DOES&gt; or even the words after DOES&gt; in terms of compilation.  A word whose definition uses CREATE and DOES&gt; is compiled normally, making sure that DOES&gt; is &#34;call&#34;ed in the compiled code.  The special thing that DOES&gt; does is as follows:  It finds the code location of the last-created word, and then it overwrites the &#34;return&#34; instruction with a &#34;jump&#34; instruction, the destination of which is the address on the return stack of the DOES&gt; routine.  This address is popped off the return stack every time DOES&gt; is called, being used to make &#34;jump&#34; instructions.  When DOES&gt; then tries to return to its caller, it is actually returning to whomever called the word that had DOES&gt; in it... not to the remainder of code.  My implementation of DOES&gt; looks sort of like this:</p><pre><code>DOES&gt;:  [find second opcode of latest definition]
        popr      ; like &#34;R&gt;&#34;
        [overwrite opcode with a &#34;jump&#34; to TOS value]
        return
</code></pre><p>So, when we define VALUE like this:</p><pre><code>: VALUE VARIABLE DOES&gt; @ ;
</code></pre><p>What we get is something like this:</p><pre><code>VALUE: call   VARIABLE
       call   DOES&gt;
       call   fetch  &lt;-- return address of call to DOES&gt;
       return
</code></pre><p>The code will call our definition of VARIABLE, given above, which in turn calls CREATE to create the new entry.  But, when it calls DOES&gt;, DOES&gt; will pop the return address pointed to above, and adjust the definition of NewVar to jump to that location, thus making NewVar so that it pushes &#34;next_addr&#34; on the data stack as before, but now jumps and calls fetch.  This also makes execution of VALUE such that it ends at the call to DOES&gt;.  When DOES&gt; returns, it returns to the caller of VALUE, not to the remainder of VALUE&#39;s definition (<code>@ ;</code>).</p><p>Notice that CREATE is not an immediate word.  Our definition of VARIABLE was <code>CREATE 0 ,</code>, but that does not create a word named &#34;0&#34;, since CREATE is encountered during the definition of VARIABLE... it just gets baked into the definition.  Instead, it is when VARIABLE actually executes that CREATE will attempt to retrieve the next word from input and make a new definition for it.</p><p>Also notice that DOES&gt; assumes a lot about the most-recently defined word.  I could have made it search diligently for the &#34;return&#34; opcode but instead, knowing how CREATE creates a new word, it simply used a fixed offset into that definition.  I&#39;m leaning on the spec. that says &#34;An ambiguous condition exists if [ the most recent definition ] was not defined with CREATE ...&#34;.  In my system, that &#34;ambiguous condition&#34; is that some word gets a &#34;jump&#34; opcode as its second instruction.</p><blockquote><p>What does DOES&gt; consume as input?</p></blockquote><p>It consumes its own return address and also uses a global variable that points to the most recent definition.</p><blockquote><p>Is there some kind of &#39;default behaviour&#39; that DOES&gt; overrides?</p></blockquote><p>Yes.  It is the default behavior (&#34;push_data/return&#34;) that CREATE makes.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='https://free-tor-game.com/software/in-general-how-do-event-handlers-work/'>In general how do Event Handlers work</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='http://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="https://free-tor-game.com/wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>