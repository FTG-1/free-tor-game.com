<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>C++ &#8211; Strategy for fixing signed/unsigned warnings &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1084835 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1084835" class="post-1084835 software type-software status-publish hentry category-software tag-c"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">C++ &#8211; Strategy for fixing signed/unsigned warnings</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">c</span></p><div class="entry-content"><p>I&#39;m working on obtaining a clean compile with <code>-Wsign-conversion</code> for existing library code. The library is 25 years old or so. Eventually, this higher bar will be a security gate, and all check-ins will need to meet it or be rejected.</p><p>The existing library code does a fair amount of the following (a gross simplification that captures the essence):</p><pre class="lang-none prettyprint-override"><code>class SHA1 : &lt;inherited interfaces (contracts) and classes (behaviors)&gt;
{
    ...
    enum {DIGEST_SIZE = 20U};
    unsigned int MaxDigestSize() { return DIGEST_SIZE; }
    ...
    int m_digestSize;
}
</code></pre><p>Then, the library does things like (the interaction is more complex, but this captures the essence):</p><pre class="lang-none prettyprint-override"><code>if(m_digestSize == -1)
    m_digestSize = MaxDiegstSize();
</code></pre><p>External callers may use it like:</p><pre><code>SHA1 sha;
...

// Calculate truncated digest
sha.Final(buffer, 8 /*signed or unsigned*/);
// Calculate using full digest
sha.Final(buffer, -1 /*signed*/);
// Calculate using full digest
sha.Final(buffer, sha.MaxDigestSize() /*unsigned*/);
</code></pre><p>The reason <code>-1</code> is popular is because the following &#34;just works&#34; (notice the switch from <code>SHA-1</code> to <code>SHA-512</code>):</p><pre><code>SHA512 sha;

// Calculate using full digest
sha.Final(buffer, -1 /*signed*/);
</code></pre><p>For the library, we want to convert to <code>unsigned</code> types to squash the warning. Then, setup an <code>enum {DEFAULT_DIGEST_VALUE=...};</code> to handle the case of &#34;default digest&#34; that was compatible with the existing &#34;-1 pattern&#34;. Finally, remove the compares to <code>-1</code> and use a compare with <code>DEFAULT_DIGEST_VALUE</code>.</p><p>But <code>enum {DEFAULT_DIGEST_VALUE=std::numeric_limits&lt;unsigned int&gt;::max()};</code> turned out to be a dead end <a href="https://stackoverflow.com/q/31282305">due to limitations in <code>numeric_limits</code></a>.</p><p>Someone suggested to use <code>UINT_MAX</code>, but I&#39;m not sure if I should use it (OS X lacks <code>&lt;cstdint&gt;</code>, so it introduces a C header dependency). Other potential candidates are <code>__INT_MAX__ * 2U + 1</code> (from <code>&lt;limits&gt;</code> on OS X), and <code>~(0)</code> (popular in lots of library code, but maybe not correct). In fact, I&#39;m not sure this is the proper path in general.</p><p>What is the proper or best way to:</p><ul><li>switch to unsigned for consistency and eventual security gate</li><li>handle the &#34;-1 pattern&#34; for existing, non-library callers</li><li>provide a portable, C++ solution</li><li>address potential issues with bit patterns</li></ul><hr/><p>My apologies for asking a simple question. I am a security architect by trade. I need the help of the software architects because I don&#39;t have the software engineering experience.</p><hr/><p>From the comments, here&#39;s some more information regarding constraints:</p><p><strong><em>Existing Code</em></strong> &#8211; The library already exists, and its called <a href="http://www.cryptopp.com/" rel="nofollow noreferrer">Crypto++</a>. It was authored in the 1990s, and it enjoys continued development. It is cross platform, and runs on the BSDs, Linux, OS X, Solaris, Windows. The solution needs to support older standards like C++98 and C++03. We can drop support for C++98 <em>if</em> the community agrees.</p><p><strong><em>ABI Changes</em></strong> &#8211; we can change the API if the community agrees. I&#39;m fairly certain that will happen when we make the policy change of a &#34;clean compile as a security gate.&#34; We don&#39;t need to have 100% compatibility, but we do need to handle an existing code base of users using <code>-1</code> in the field. We can even give users warning to modify their code with the preprocessor macro <code>CRYPTOPP_MAINTAIN_BACKWARDS_COMPATIBILITY</code>. But in the end, things have to &#34;just work&#34; for them.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>Well from my point of view, you&#39;re trying to fix the wrong problem. You use the error-code &#34;-1&#34; to signalize that the <code>MaxDigestSize</code> should be used. This is a technique that Robert C. Martin calls &#34;Mental mapping&#34; in his book <a href="http://rads.stackoverflow.com/amzn/click/0132350882" rel="nofollow">Clean Code</a>. Your <code>signed</code>/<code>unsigned</code> conflict is solely caused by the fact that you&#39;re using this &#34;error-code&#34;. So the problem that you should be fixing instead is &#34;How do I avoid using an error-code&#34;.</p><p>Lets get into it:</p><p>Easiest approach: make <code>m_digestSize</code> and the parameter for the <code>sha.Final()</code> both <code>unsigned ints</code>. This ensures that the <code>Final</code> method can only accept valid values. Now instead of giving your method an error-code, just overload with a default-parameter like:</p><pre><code>Final(byte* buffer, unsigned int digest = DEFAULT_DIGEST);
</code></pre><p>In the example you provided this <code>DEFAULT_DIGEST</code> is based on the immutable value of <code>MaxDigestSize()</code> and would therefore be 20.</p><p>EDIT:</p><p>Based on the new information in the comments and edits: It appears to me that the big problems are the warnings. Best solution: check for -1 <strong>before</strong> assigning the parameter to the member variable. Additionally, as mentioned in the comments, you should wrap the primitive into a small structure and offer that as an alternative while marking the old function as deprecated:</p><pre><code>Final(byte* buffer, int digest = DEFAULT_DIGEST) // Mark as deprecated
{
    if(digest &lt; MINIMUM_DIGEST)
    {
        digest = DEFAULT_DIGEST;
    }
    m_digestSize = static_cast&lt;unsigned int&gt;(digest);
    [...]
}

Final(byte* buffer, Digest digest = Digest())
{
    m_digestSize = digest;
    [...]
}

class Digest
{
    public:
    Digest(usigned int value = DEFAULT_DIGEST)
    :digestValue(value){};

    unsigned int GetValue()
    {
        return digestValue
    };

    private:
    unsigned int digestValue;
}
</code></pre></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../c-one-want-to-disable-compiler-warnings/'>C# &#8211;  one want to disable compiler warnings</a></li><li class="list-group-item"><a href='../c-what-are-the-best-practices-regarding-unsigned-ints/'>C++ &#8211; What are the best practices regarding unsigned ints</a></li><li class="list-group-item"><a href='../c-a-good-strategy-for-binding-view-objects-to-model-objects-in-c/'>C++ &#8211;  a good strategy for binding view objects to model objects in C++</a></li><li class="list-group-item"><a href='../c-c-c-which-conversion-warnings-make-sense-in-practice/'>C++ &#8211; C/C++: Which conversion warnings make sense in practice</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>