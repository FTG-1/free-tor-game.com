<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Web-development &#8211; How to manage automated emails sent from a web application &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1068240 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1068240" class="post-1068240 software type-software status-publish hentry category-software tag-architecture tag-web-applications tag-web-design tag-web-development"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Web-development &#8211; How to manage automated emails sent from a web application</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">Architecture</span><span class="mr-2 badge badge-info">web-applications</span><span class="mr-2 badge badge-warning">web-design</span><span class="mr-2 badge badge-primary">web-development</span></p><div class="entry-content"><p>I am designing a web application and I am wondering how to design the architecture to manage sending automated emails.</p><p>Currently I have this feature build into my web app and the emails are sent based on user input / interactions (like creating a new user). The problem is that connecting directly to a mail server takes a couple of seconds. Scaling my application up, this will be a significant bottle neck in the future.</p><p>What is the best way to manage sending a large amount of automated emails within my system architecture?</p><p>There won&#39;t be a huge amount of emails sent (2000 a day max). Emails don&#39;t need to be send immediately, up to 10 mins lag is fine.</p><p>Update:<br /> Message queuing has been given as an answer, but how would this be designed? Would this be handled in the app and processed during a quiet period, or do i need to create a new &#39;mail app&#39; or web service to just manage the queue?</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>The common approach, as <a href="https://softwareengineering.stackexchange.com/a/191136/25936">Ozz already mentioned</a>, is a <a href="http://en.wikipedia.org/wiki/Message_queue" rel="nofollow noreferrer">message queue</a>. From a design perspective a message queue is essentially a <a href="http://en.wikipedia.org/wiki/Queue_(abstract_data_type)" rel="nofollow noreferrer">FIFO queue</a>, which is a rather fundamental data type:</p><p><a href="http://en.wikipedia.org/wiki/Queue_(abstract_data_type)" rel="nofollow noreferrer"><img src="../../../i.stack.imgur.com/iQRWm.png" alt="FIFO queue"/></a></p><p>What makes a message queue special is that while your application is responsible for en-queueing, a different process would be responsible for de-queueing. In queueing lingo, your application is the sender of the message(s), and the de-queueing process is the receiver. The obvious advantage is that the whole process is asynchronous, the receiver works independently of the sender, as long as there are messages to process. The obvious disadvantage is that you need an extra component, the sender, for the whole thing to work.</p><p>Since your architecture now relies on two components exchanging messages, you can use the fancy term <a href="http://en.wikipedia.org/wiki/Interprocess_communication" rel="nofollow noreferrer">inter-process communication</a> for it.</p><h3>How does introducing a queue affect your application&#39;s design?</h3><p>Certain actions in your application generate emails. Introducing a message queue would mean that those actions should now push messages to the queue instead (and nothing more). Those messages should carry the absolute minimum amount of information that&#39;s necessary to construct the emails when your receiver gets to process them.</p><h3>Format and content of the messages</h3><p>The format and content of your messages is completely up to you, but you should keep in mind the smaller the better. Your queue should be as fast to write on and process as possible, throwing a bulk of data at it will probably create a bottleneck.</p><p>Furthermore several cloud based queueing services have restrictions on message sizes and may split larger messages. You won&#39;t notice, the split messages will be served as one when you ask for them, but you will be charged for multiple messages (assuming of course you are using a service that requires a fee).</p><h3>Design of the receiver</h3><p>Since we&#39;re talking about a web application, a common approach for your receiver would be a simple cron script. It would run every <code>x</code> minutes (or seconds) and it would:</p><ul><li>Pop <code>n</code> amount of messages from the queue,</li><li>Process the messages (i.e. send the emails).</li></ul><p>Notice that I&#39;m saying pop instead of get or fetch, that&#39;s because your receiver is not just getting the items from the queue, it&#39;s also clearing them (i.e. removing them from the queue <em>or</em> marking them as processed). How exactly that will happen depends on your implementation of the message queue and your application&#39;s specific needs.</p><p>Of course what I&#39;m describing is essentially a <a href="http://en.wikipedia.org/wiki/Batch_processing" rel="nofollow noreferrer">batch operation</a>, the simplest way of processing a queue. Depending on your needs you may want to process messages in a more complicated manner (that would also call for a more complicated queue).</p><h3>Traffic</h3><p>Your receiver could take into consideration traffic and adjust the number of messages it processes based on the traffic at the time it runs. A simplistic approach would be to predict your high traffic hours based on past traffic data and assuming you went with a cron script that runs every <code>x</code> minutes you could do something like this:</p><pre><code>if( 
    now() &gt; 2pm &amp;&amp; now() &lt; 7pm
) {
    process(10);
} else {
    process(100);
}

function process(count) {
    for(i=0; i&lt;=count; i++) {
        message = dequeue();
        mail(message)
    }
}
</code></pre><p>A very naive &amp; dirty approach, but it works. If it doesn&#39;t, well, the other approach would be to find out the current traffic of your server at each iteration and adjust the number of process items accordingly. Please don&#39;t micro-optimize if it&#39;s not absolutely necessary though, you&#39;d be wasting your time.</p><h3>Queue storage</h3><p>If your application already uses a database, then a single table on it would be the simplest solution:</p><pre><code>CREATE TABLE message_queue (
  id int(11) NOT NULL AUTO_INCREMENT,
  timestamp timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP,
  processed enum(&#39;0&#39;,&#39;1&#39;) NOT NULL DEFAULT &#39;0&#39;,
  message varchar(255) NOT NULL,
  PRIMARY KEY (id),
  KEY timestamp (timestamp),
  KEY processed (processed)
) 
</code></pre><p>It really isn&#39;t more complicated than that. You can of course make it as complicated as you need, you can, for example, add a priority field (which would mean that this is no longer a FIFO queue, but if you actually need it, who cares?). You could also make it simpler, by skipping the processed field (but then you&#39;d have to delete rows after you processed them).</p><p>A database table would be ideal for 2000 messages per day, but it would <em>probably</em> not scale well for millions of messages per day. There are a million factors to consider, everything in your infrastructure plays a role in the overall scalability of your application.</p><p>In any case, assuming you&#39;ve already identified the database based queue as a bottleneck, the next step would be to look at a cloud based service. <a href="http://aws.amazon.com/sqs/" rel="nofollow noreferrer">Amazon SQS</a> is the one service I used, and did what it promises. I&#39;m sure there are quite a few similar services out there.</p><p>Memory based queues is also something to consider, especially for short lived queues. <a href="http://memcached.org/" rel="nofollow noreferrer">memcached</a> is excellent as message queue storage.</p><p>Whatever storage you decide to build your queue on, be smart and abstract it. Neither your sender nor your receiver should be tied up to a specific storage, otherwise switching to a different storage at a later time would be a complete PITA.</p><h3>Real life approach</h3><p>I&#39;ve build a message queue for emails that&#39;s very similar to what you are doing. It was on a PHP project and I&#39;ve build it around <a href="http://framework.zend.com/manual/1.12/en/zend.queue.html" rel="nofollow noreferrer">Zend Queue</a>, a component of the Zend Framework that offers <a href="http://framework.zend.com/manual/1.12/en/zend.queue.adapters.html" rel="nofollow noreferrer">several adapters</a> for different storages. My storages where:</p><ul><li>PHP arrays for unit testing,</li><li>Amazon SQS on production,</li><li>MySQL on the dev and testing environments.</li></ul><p>My messages were as simple as they can be, my application created small arrays with the essential information (<code>[user_id, reason]</code>). The message store was a serialized version of that array (first it was PHP&#39;s internal serialization format, then JSON, I don&#39;t remember why I switched). The <code>reason</code> is a constant and of course I have a big table somewhere that maps <code>reason</code> to fuller explanations (I did manage to send about 500 emails to clients with the cryptic <code>reason</code> instead of the fuller message once).</p><h3>Further reading</h3><p>Standards:</p><ul><li><a href="http://www.amqp.org/" rel="nofollow noreferrer">Advanced Message Queuing Protocol</a></li><li><a href="http://xmpp.org/" rel="nofollow noreferrer">Extensible Messaging and Presence Protocol</a></li></ul><p>Tools:</p><ul><li><a href="http://www.zeromq.org/" rel="nofollow noreferrer">ØMQ</a> (a socket library for async messaging)</li><li><a href="http://www.rabbitmq.com/" rel="nofollow noreferrer">RabbitMQ</a> (<a href="http://en.wikipedia.org/wiki/Message_broker" rel="nofollow noreferrer">message broker</a>)</li><li><a href="http://activemq.apache.org/" rel="nofollow noreferrer">Apache ActiveMQ</a> (message broker)</li></ul><p>Interesting reads:</p><ul><li><a href="http://en.wikipedia.org/wiki/Message-oriented_middleware" rel="nofollow noreferrer">Message-oriented middleware</a></li><li><a href="http://blog.mayflower.de/2011-Message-Queues-for-web-applications-with-STOMP.html" rel="nofollow noreferrer">Message Queues for web applications with STOMP</a></li><li><a href="http://merchantos.com/blog/2012/09/using-amazon-sqs-as-a-messaging-bus/" rel="nofollow noreferrer">Using Amazon SQS as a Messaging Bus</a></li></ul></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../web-development-design-of-high-performance-file-processing-web-application/'>Web-development &#8211; Design of high performance file processing web application</a></li><li class="list-group-item"><a href='../architecture-why-cant-a-server-continue-to-act-on-a-request-after-sending-the-response/'>Architecture &#8211; Why can&#8217;t a server continue to act on a request after sending the response</a></li><li class="list-group-item"><a href='../desktop-to-web-how-to-deal-with-user-interactive-workflows/'>Desktop to Web &#8211; How to deal with user-interactive workflows</a></li><li class="list-group-item"><a href='../architecture-managing-non-domain-application-behaviour-in-cqrs/'>Architecture &#8211; Managing non-domain application behaviour in CQRS</a></li><li class="list-group-item"><a href='../python-multiple-users-using-the-same-script-for-their-websites/'>Python &#8211; Multiple users using the same script for their websites</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>