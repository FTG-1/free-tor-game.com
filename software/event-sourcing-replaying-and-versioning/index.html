<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Event sourcing, replaying and versioning &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1067435 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1067435" class="post-1067435 software type-software status-publish hentry category-software tag-apache-kafka tag-cqrs tag-event-sourcing tag-microservices tag-versioning"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Event sourcing, replaying and versioning</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">apache-kafka</span><span class="mr-2 badge badge-info">cqrs</span><span class="mr-2 badge badge-warning">event-sourcing</span><span class="mr-2 badge badge-primary">microservices</span><span class="mr-2 badge badge-danger">versioning</span></p><div class="entry-content"><p>I am designing a system that uses Event Sourcing, CQRS and microservices. I am lead to understand this isn&#39;t an uncommon pattern. A key feature of the service needs to be the ability to rehydrate/restore from a system of record. Microservices will produce commands and queries on a MQ (Kafka). Other microservices will respond (events). Commands and queries will be persisted on S3 for purpose of auditing and restoring.</p><p>The current thought process was that, for the purposes of restoring the system, we could extract the event log from S3 and simply feed it back into Kafka.</p><p>However, this fails to acknowledge changes in both producers <em>and</em> consumers over time. Versioning at the command/query level seems to go some way toward solving the problem but I can&#39;t wrap my head around versioning consumers such that I could enforce that when a command, during a restore, is received and processed, it&#39;s the exact same [version of the] code that&#39;s performing the processing as it was the first time the command was received.</p><p>Are there any patterns I can use to solve this? Is anyone aware of other systems that advertise this feature?</p><p>EDIT: Adding an example.</p><p>A &#39;buyer&#39; sends a &#39;question&#39; to a &#39;seller&#39; on my auction site. The flow looks as follows:<br /> <code><br /> UI      -&gt; Web App:           POST /question {:text text :to seller-id :from user-id}<br /> Web App -&gt; MQ:                SEND {:command send-question :args [text seller-id user-id]}<br /> MQ      -&lt; Audit:             &lt;command + args appended to log in S3&gt;<br /> MQ      -&lt; Questions service: - Record question in DB<br /> - Email seller &#39;You have a question&#39;<br /> </code></p><p>Now, as a result of a new business requirement, I adjust the &#39;Questions service&#39; consumer, to persist a count of all unread questions. The DB schema is changed. We have had no notion of whether or not a question was read by the seller, until now. The last line becomes:</p><p><code><br /> MQ      -&lt; Questions service: - Record question in DB<br /> - Email seller &#39;You have a question&#39;<br /> - Increment &#39;unread questions count&#39;<br /> </code></p><p>Two commands are issues, one before the change, one after the change. The &#39;unread questions count&#39; equals 1.</p><p>The system crashes. We restored by replaying the commands through the <em>new</em> code. At the end of the restore, our &#39;unread questions count&#39; equals 2. Even though, in this contrived example, the result is not a catastrophe, the state that has been restored is <em>not</em> what it previously was.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>First, it is important to understand and be able to leverage the difference between <em>Commands</em> and <em>Events.</em></p><p>As <a href="https://stackoverflow.com/questions/4962755/why-are-commands-and-events-separately-represented">this question</a> succinctly points out, <em>Commands</em> are things we would like to happen, and <em>Events</em> are things that have already happened.  A command does not necessarily result in a significant event in the system, but it usually does. For example, a <code>send message</code> command may be rejected, in which case no event happens (typically an error would not be considered an event in this sense, though we may still choose to log it in a diagnostic log).  Now, if the <code>send message</code> command is accepted, the <code>message sent</code> event occurs, and event details could describe the sender, the receiver, and the content.</p><p>When we talk about the system state, we are actually discussing not a culmination of commands, but of events. <strong>Only events reflect changes of state in the system.</strong> To draw from a life example, suppose I go to the local Publix supermarket and buy a Florida lottery ticket.  The command was &#34;Buy Ticket&#34; and the event was &#34;Ticket issued.&#34; My next command then is to the lottery to draw my numbers for the PowerBall. The lottery is going to ignore my command (but I have no knowledge), and the event &#34;PowerBall numbers chosen&#34; takes place irrespective of my wishes.  If my numbers match, the event &#34;Jackpot won&#34; happens to me (and I think my command was heard).  If not, I realize my command was ignored.</p><p>From a historical perspective, the lottery is only interested in a subset of events. The lottery only cares that (a) a ticket was issued, (b) the numbers were chosen, and (c) the jackpot was won. Those are the items of interest. The act of purchasing the ticket, wanting to win, etc. are all irrelevant, as is what I do with my ticket after I lose. While the real world does change for mundane events, we only need to record those events which are significant to our system.</p><p>In theory, under an event-sourcing technique, a stream of events may be replayed from the beginning of time to arrive at the current state.  This relies upon the assumption that the underlying system conditions are constant and deterministic.  However, these assumptions are not valid in many systems.  The data associated with an event, as well as the types of events we are interested in, may change as our computer software evolves. In addition, it can be computationally expensive to re-compute the current state in response to every query.  For this reason, snapshots of the system state are often taken to represent known points in time, which most recent events can then be added to.</p><p>While it is still possible to replay an event stream across multiple versions, the amount of human effort involved in doing so is likely to be cost-prohibitive. Unless there is a justifiable reason to design that capability into the system, you are better off building your system to utilize snapshots.</p><p><strong>Example in Question</strong></p><p>In the example given in the question, the architecture is not truly event-based; it is command-based.  Replaying commands creates the system state.  This is an anti-pattern and should be fixed.  Instead, the primary events are:</p><ul><li>Buyer asks question</li><li>Seller responds to question</li></ul><p>Each of these events can be &#34;replayed&#34; to give the current state. For example, in the act of asking a question, the system behavior might be to email the seller and increment the <code>unanswered question</code> counter. This behavior can be changed; however, the fact that the question was asked does not.  Similarly, the system might decrement the <code>unanswered question</code> counter when the seller responds. This behavior is changable, but the fact that the seller responded is not.</p><p>Most event-sourcing systems would dynamically compute the count of unanswered questions by replaying the specific event stream in response to a query.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../inheritance-commands-and-event-sourcing/'>Inheritance, commands and event sourcing</a></li><li class="list-group-item"><a href='../how-to-deal-with-side-effects-in-event-sourcing/'>How to deal with side effects in Event Sourcing</a></li><li class="list-group-item"><a href='../designing-events-in-an-event-driven-event-sourced-architecture-and-managing-duplication/'>Designing events in an event-driven (event sourced) architecture and managing duplication</a></li><li class="list-group-item"><a href='../confused-about-commands-domain-events-and-external-events-in-event-sourcing/'>Confused about commands, domain events and external events in event sourcing</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>