<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>C# &#8211; What exactly happens when a thread awaits a task inside a while loop &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1066188 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1066188" class="post-1066188 software type-software status-publish hentry category-software tag-async tag-c tag-loops"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">C# &#8211; What exactly happens when a thread awaits a task inside a while loop</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">async</span><span class="mr-2 badge badge-info">c</span><span class="mr-2 badge badge-warning">loops</span></p><div class="entry-content"><p>After dealing with C#&#39;s async/await pattern for a while now, I suddenly came to realization that I don&#39;t really know how to explain what happens in the following code:</p><pre><code>async void MyThread()
{
    while (!_quit)
    {
        await GetWorkAsync();
    }
}
</code></pre><p><code>GetWorkAsync()</code> is assumed to return an awaitable <code>Task</code> which may or may not cause a thread switch when the continuation is executed.</p><p>I wouldn&#39;t be confused if the await wasn&#39;t inside a loop. I&#39;d naturally expect that the rest of the method (i.e. continuation) would potentially execute on another thread, which is fine.</p><p>However, inside a loop, the concept of &#34;the rest of the method&#34; gets a bit foggy to me.</p><p>What happens to &#34;the rest of the loop&#34; if the thread is switched on continuation vs. if it isn&#39;t switched? On which thread is the next iteration of the loop executed?</p><p>My observations show (not conclusively verified) that each iteration starts on the same thread (the original one) while the continuation executes on another. Can this really be? If yes, is this then a degree of unexpected parallelism that needs to be accounted for vis-a-vis thread-safety of the GetWorkAsync method?</p><p>UPDATE: My question is not a duplicate, as suggested by some. The <code>while (!_quit) { ... }</code> code pattern is merely a simplification of my actual code. In reality, my thread is a long-lived loop that processes its input queue of work items on regular intervals (every 5 seconds by default). The actual quit condition check is also not a simple field check as suggested by the sample code, but rather an event handle check.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>You can actually check it out at <a href="http://tryroslyn.azurewebsites.net/#K4Zwlgdg5gBAygTxAFwKYFsB0AVAFgJ1QEMATSKHIkAaxAG4AoUc+JNdRgYwBsqQYACvgD2UfEXQMA3gxhyYKIsjCcYAN2FgSMALJFIACgCUs+TPkXdBgAxHGFgL6m5zmAAd8YNUtQLkSlRgAI2FhbhgAfQBHYDBke3lXRWVVKgQIVQ0tK0hkGEg3YGQTC3NLOQB3XDBuXwMAQmjY4tdyuSIK/TzsKmpMABFUXgQDAEZrWwS5JwcgA==" rel="noreferrer">Try Roslyn</a>.  Your await method gets rewritten into <code>void IAsyncStateMachine.MoveNext()</code> on the generated async class.</p><p>What you&#39;ll see is something like this:</p><pre><code>            if (this.state != 0)
                goto label_2;
            //set up the state machine here
            label_1:
            taskAwaiter.GetResult();
            taskAwaiter = default(TaskAwaiter);
            label_2:
            if (!OuterClass._quit)
            {
               taskAwaiter = GetWorkAsync().GetAwaiter();
               //state machine stuff here
            }
            goto label_1;
</code></pre><p>Basically, it doesn&#39;t matter which thread you&#39;re on; the state machine can resume properly by replacing your loop with an equivalent if/goto structure.</p><p>Having said that, async methods don&#39;t necessarily execute on a different thread.  See Eric Lippert&#39;s explanation <a href="https://blogs.msdn.microsoft.com/ericlippert/2010/11/04/asynchrony-in-c-5-0-part-four-its-not-magic/" rel="noreferrer">&#34;It&#39;s not magic&#34;</a> to explain how you can have working <code>async/await</code> on only one thread.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../c-efficient-mixing-of-sync-and-async-methods-within-a-single-method/'>C# &#8211; Efficient mixing of sync and async methods within a single method</a></li><li class="list-group-item"><a href='../what-are-the-differences-between-a-while-loop-and-a-for-loop/'>What are the differences between a while loop and a for loop</a></li><li class="list-group-item"><a href='../c-how-to-implement-await-in-android/'>C# &#8211; How to implement await in Android</a></li><li class="list-group-item"><a href='../async-controllers-in-asp-net-mvc-real-advantages-how-achieved/'>Async Controllers in ASP.NET MVC: Real Advantages / How Achieved</a></li><li class="list-group-item"><a href='../c-why-does-c-allow-you-to-make-an-override-async/'>C# &#8211; Why does C# allow you to make an override async</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>