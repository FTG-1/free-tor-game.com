<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Design &#8211; Architecture for message processing with scheduling, at scale &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1079317 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1079317" class="post-1079317 software type-software status-publish hentry category-software tag-architecture tag-design tag-design-patterns tag-distributed-system tag-message-queue"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Design &#8211; Architecture for message processing with scheduling, at scale</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">Architecture</span><span class="mr-2 badge badge-info">design</span><span class="mr-2 badge badge-warning">design-patterns</span><span class="mr-2 badge badge-primary">distributed-system</span><span class="mr-2 badge badge-danger">message-queue</span></p><div class="entry-content"><p>I have to design the architecture of a system that processes messages in a distributed manner. If this were the only requirement, I would use a message queue like Kafka and distribute the work with <a href="https://faust.readthedocs.io/en/latest/" rel="nofollow noreferrer">Faust</a>. This solution would be perfect for my use-case because the work that needs to be done for each message involves a lot of I/O, and therefore the asynchronous nature of the Faust workers would be a good fit.</p><p>The problem comes because I also have to be able to schedule messages in the future. I&#39;d like to schedule a new execution as soon as the worker is done with a particular message. The delay depends on the specific message and is not known beforehand.</p><p>Furthermore, the queue would contain tens of millions of messages at any given time (messages are small, fortunately, less than 100 bytes usually).</p><p>This is what I came up with, but I&#39;m not very satisfied:</p><ol><li>the Kafka queue is initially seeded in some way, and the messages are distributed to the Faust workers;</li><li>when a worker is done with a message, it adds a new version of the message to a Redis sorted set. The score would be the timestamp of the future execution (making it a priority queue);</li><li>a separate worker polls the priority queue at a periodic interval, and takes the messages that need to be processed at that time;</li><li>the messages are sent to the Kafka queue and processed again.</li></ol><p>Some more details:</p><ul><li>it&#39;s not important that a message scheduled for a certain time is executed exactly at that time. Errors in the range of minutes or even hours sometimes are not problematic;</li><li>messages are not processed in constant time, but could be roughly divided in 2-3 buckets of execution length (and this is known beforehand, from the message);</li><li>if there is nothing to do (which should never happen) then the first messages should be processed anyway, instead of waiting for the scheduled time.</li></ul><p>I&#39;m not particularly excited about my solution, as the Redis priority queue could grow too much in size and use up all the memory. It would be best if messages could be rescheduled directly on the Kafka queue, but as far as I know it does not support scheduling.</p><p>Final note: I talk about scheduling but the focus is not so much about the exact time, but ensuring that the messages are re-processed (with variants and some messages more frequently than others). If there was a way to reorder messages on a Kafka queue probably it would be a better solution.</p><p>I would appreciate any inputs. I hope I made the requirements sufficiently clear.</p><p><strong>EDIT</strong>: Upon further research, I think I can replace the priority queue with a scheduler, like <a href="https://github.com/agronholm/apscheduler" rel="nofollow noreferrer">APScheduler</a>. Such a scheduler supports a variety of backends, including PostgreSQL. Using that I would avoid running out of memory. Each job would simply put the messages on the Kafka queue when it&#39;s run. With this architecture, I think I would also solve or greatly attenuate the problems with back/forward pressure on the queue.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>Kafka does not support scheduled delivery, AWS SQS may be an alternative.</p><p>Otherwise you have to set up the schedule on consumer side, like you mentioned APScheduler or something similar. Even if you are using Redis or Dynamo db to set up the future timestamp, you can always expire the records after you process them, so storage shouldn&#39;t be an issue.</p><p>Or maybe you can just use <a href="https://github.com/sky-uk/kafka-message-scheduler" rel="nofollow noreferrer">Kafka message scheduler</a> to do this for you with specified timestamp showing when you want the message being delivered.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../java-is-it-worth-it-to-use-a-message-queue-framework-in-this-case/'>Java &#8211; Is it worth it to use a message-queue framework in this case</a></li><li class="list-group-item"><a href='../fair-distributed-task-scheduling-with-rabbitmq/'>Fair distributed task scheduling with RabbitMQ</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>