<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Patterns for a tree of persistent data with multiple storage options &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1081175 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1081175" class="post-1081175 software type-software status-publish hentry category-software tag-data-structures tag-design-patterns tag-persistence tag-repository tag-trees"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Patterns for a tree of persistent data with multiple storage options</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">data structures</span><span class="mr-2 badge badge-info">design-patterns</span><span class="mr-2 badge badge-warning">persistence</span><span class="mr-2 badge badge-primary">repository</span><span class="mr-2 badge badge-danger">trees</span></p><div class="entry-content"><p>I have a real-world problem which I&#39;ll try to abstract into an illustrative example.</p><p>So imagine I have data objects in a tree, where parent objects can access children, and children can access parents:</p><pre><code>// Interfaces
interface IParent&lt;TChild&gt; { List&lt;TChild&gt; Children; }
interface IChild&lt;TParent&gt; { TParent Parent; }

// Classes
class Top : IParent&lt;Middle&gt; {}
class Middle : IParent&lt;Bottom&gt;, IChild&lt;Top&gt; {}
class Bottom : IChild&lt;Middle&gt; {}

// Usage
var top = new Top();
var middles = top.Children; // List&lt;Middle&gt;
foreach (var middle in middles) {
    var bottoms = middle.Children; // List&lt;Bottom&gt;
    foreach (var bottom in bottoms) {
        var middle = bottom.Parent; // Access the parent
        var top = middle.Parent; // Access the grandparent
    }
}
</code></pre><p>All three data objects have properties that are persisted in two data stores (e.g. a database and a web service), and they need to reflect and synchronise with the stores. Some objects only request from the web service, some only write to it.</p><p><strong>Data Mapper</strong></p><p>My favourite pattern for data access is <a href="http://msdn.microsoft.com/en-us/magazine/dd569757.aspx#id0400052">Data Mapper</a>, because it completely separates the data objects themselves from the communication with the data store:</p><pre><code>class TopMapper {
    public Top FetchById(int id) {
        var top = new Top(DataStore.TopDataById(id));
        top.Children = MiddleMapper.FetchForTop(Top);
        return Top;
    }
}

class MiddleMapper {
    public Middle FetchById(int id) {
         var middle = new Middle(DataStore.MiddleDataById(id));
         middle.Parent = TopMapper.FetchForMiddle(middle);
         middle.Children = BottomMapper.FetchForMiddle(bottom);
         return middle;
    }
}
</code></pre><p>This way I can have one mapper per data store, and build the object from the mapper I want, and then save it back using the mapper I want.</p><p>There is a circular reference here, but I guess that&#39;s not a problem because most languages can just store memory references to the objects, so there won&#39;t actually be infinite data.</p><p>The problem with this is that every time I want to construct a new <code>Top</code>, <code>Middle</code> or <code>Bottom</code>, it needs to build the entire object tree within that object&#39;s <code>Parent</code> or <code>Children</code> property, with all the data store requests and memory usage that that entails. And in real life my tree is much bigger than the one represented here, so that&#39;s a problem.</p><p><strong>Requests in the object</strong></p><p>In this the objects request their <code>Parent</code>s and <code>Children</code> themselves:</p><pre><code>class Middle {
    private List&lt;Bottom&gt; _children = null; // cache
    public List&lt;Bottom&gt; Children {
        get {
            _children = _children ?? BottomMapper.FetchForMiddle(this);
            return _children;
        }
        set {
            BottomMapper.UpdateForMiddle(this, value);
            _children = value;
        }
    }
}
</code></pre><p>I think this is an example of the <a href="http://msdn.microsoft.com/en-us/magazine/dd569757.aspx#id0400058">repository pattern</a>. Is that correct?</p><p>This solution seems neat &#8211; the data only gets requested from the data store when you need it, and thereafter it&#39;s stored in the object if you want to request it again, avoiding a further request.</p><p>However, I have two different data sources. There&#39;s a database, but there&#39;s also a web service, and I need to be able to create an object from the web service and save it back to the database and then request it again from the database and update the web service.</p><p>This also makes me uneasy because the data objects themselves are no longer ignorant of the data source. We&#39;ve introduced a new dependency, not to mention a circular dependency, making it harder to test. And the objects now mask their communication with the database.</p><p><strong>Other solutions</strong></p><p>Are there any other solutions which could take care of the multiple stores problem but also mean that I don&#39;t need to build / request all the data every time?</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>The undesirable part of your approach comes from having the data objects themselves unfreezing (loading, deserialising) themselves.</p><p>This is not a simple problem!</p><p>Ideally you want your data objects being quite simple, and some external agent being responsible for deserialising and serialising them using data that lives on disk, or on the network, etc.</p><p>One approach to this might use reflection and object introspection and fancy things like that.</p><p>Another approach might use to use &#34;generic objects&#34;. A generic object can store an arbitrary amount of properties (i.e. fields/variables). Each field can be one of a few set types: int, string, byte array, reference to another generic object (<strong>that one is important</strong>), etc. So you can then model your data objects as generic objects.</p><p>The advantage of using &#34;generic objects&#34; is that you can then have a mechanism external (or super) to the generic object class through which its properties are accessed. This mechanism recognises when a field hasn&#39;t yet been loaded, and can fetch it from the appropriate source. It an also handle cache writing, e.g. fetching data from remote source, writing to to local cache.</p><p><strong>The above is a very general sounding description, but it&#39;s not a trivial thing to implement so it might be hard to get any more specific without getting very verbose.</strong></p><p>See also this SO question: <a href="https://stackoverflow.com/questions/9200545/recommended-pattern-for-lazy-loading-portions-of-object-graph-from-cache">https://stackoverflow.com/questions/9200545/recommended-pattern-for-lazy-loading-portions-of-object-graph-from-cache</a></p><p>Also note that <a href="http://en.wikipedia.org/wiki/Core_Data" rel="nofollow noreferrer">Core Data</a> in iOS is an object grapher which handles lazy loading (faulting) -- your problem area is very similar to what Core Data addresses.</p><blockquote><p>Core Data is an object graph and persistence framework provided by
 Apple [...] It allows data organised by the relational
 entity–attribute model to be serialised into XML, binary, or SQLite
 stores. The data can be manipulated using higher level objects
 representing entities and their relationships. Core Data manages the
 serialised version, providing object lifecycle and object graph
 management, including persistence.</p></blockquote></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../java-design-pattern-for-access-to-tree-like-database-in-java/'>Java &#8211; Design pattern for access to tree-like database in Java</a></li><li class="list-group-item"><a href='../data-structures-and-algorithms-for-a-directed-rooted-tree-with-inherited-properties/'>Data structures and algorithms for a directed rooted tree with inherited properties</a></li><li class="list-group-item"><a href='../data-structure-for-storing-sorted-data/'>Data structure for storing sorted data</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>