<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Architecture &#8211; Serverless event-sourced architecture using AWS offerings &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1083053 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1083053" class="post-1083053 software type-software status-publish hentry category-software tag-architecture tag-aws tag-cloud-computing tag-cqrs tag-event-sourcing"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Architecture &#8211; Serverless event-sourced architecture using AWS offerings</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">Architecture</span><span class="mr-2 badge badge-info">aws</span><span class="mr-2 badge badge-warning">cloud computing</span><span class="mr-2 badge badge-primary">cqrs</span><span class="mr-2 badge badge-danger">event-sourcing</span></p><div class="entry-content"><p>This is my first post on the Software Engineering Stack Exchange so let me know if something is wrong with it.</p><p>I&#39;m looking into the serverless offerings of Amazon to try to figure out if that is the way to go for a few new projects I have in mind. I&#39;m particularly interested in an event-sourced, CQRS model, as I find the purported advantages of such a model very attractive in this instance. But I&#39;m having a little bit of trouble understanding all of the services Amazon have to offer, what their pros and cons are, and how it all fits together. I&#39;ll give some pretext first and state my questions afterwards.</p><p>I&#39;ll use an example application to illustrate what I&#39;m after:</p><p>It&#39;s a simple (static) web application, hosted in S3 and served over cloudflare.</p><p>It has two actions: One command and one query (in CQRS terms).</p><p>The command posts an event onto the event stream to increment a counter.</p><p>The query gets the current state of the counter, i.e. how many times it has been incremented.</p><p>That&#39;s it, so how do I implement this using serverless AWS technology? Here&#39;s what I&#39;m thinking so far:</p><p>To send the command to increment the counter, the web application sends AJAX requests to a lambda L1 (through an API gateway). This lambda L1 posts an event to the event stream.</p><p>Another lambda L2 listens to the event stream and stores a record of the event/command so that it can be replayed at a later date if need be.</p><p>Yet another lambda L3 listens to the event stream and executes the command. In other words, it fetches the current state of the counter, increments it and persists the new state atomically.</p><p>To send the query, the web application sends an AJAX request to lambda L4 (through an API gateway), which queries the state and returns the result.</p><p>This seems like it should be a fairly straight forward, minimal project. Here are my concerns so far:</p><p>First of all, what should my event stream look like? I have seen many suggestions floating around, each one more convoluted and contrived than the last. Various fanning out strategies, mixtures of SNS, SQS, Kinesis, DynamoDB streams, you name it&#8230; I fear I will end up with too many moving parts, a cost-ineffective system that&#39;s difficult to scale in the sense that the complexity makes it difficult to develop for.</p><p>Second, can I achieve atomicity? The event stream services I mentioned above typically have some sort of &#34;at-least-once delivery&#34; property, which needs to be handled by the consumer. One suggestion I have seen is to make every event idempotent, but that does not seem feasible in my example application. Two clients could increment the counter at the same time, and one of the increments could get &#34;lost&#34; because both of the commands would say &#34;the counter is now at 17 (for example)&#34;. You could argue that this is correct behavior, both client saw the number as 16 and wanted to increment it to 17, but let&#39;s say in this situation we would like both increments to count toward the total. We want our command to represent only a delta between the two states. Is there any way to achieve this?</p><p>Third, lambdas L3 and L4 both need to be able to access some sort of persistence layer. Ideally I would like this to be a relational database (SQL) so that I can perform advanced queries on the current application state. It&#39;s not necessary for my incrementing counter example, but will be necessary for the projects I have in mind. I think this only leaves me with one option if I want to stay serverless: Serverless Aurora. That&#39;s fine by me, but it&#39;s my understanding that Aurora needs to run in a VPC, and that lambdas need to run in the same VPC to have access to Aurora. I&#39;m very concerned about performance here, as L3 is the single congestion point in my example (everything else is append-only or read-only). My understanding is that VPCs incur a pretty hefty performance cost (throughput, number of connections, bandwidth), and that lambdas in VPCs can have cold starts of upwards of 10 seconds. How can I tackle these problems? Alarm bells are going off in my head, that this just introduces more problems than it solves. I would probably have to ping L4 continuously so that it never cold starts (10 second load time is unacceptable), and at that point, am I really going serverless? If this is a bad idea, are there any better alternatives? Do I have to persist state in DynamoDB as well, losing querying capabilities?</p><p>This post is already pretty lengthy so I&#39;ll leave it at these three concerns for now. Aside from answering my questions directly, if you could help me clear up any misunderstandings, offer alternative solutions, etc. I would be grateful!</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>I don&#39;t think you are going to find any authoritative answers to this, although there are a fair number of articles about.</p><p>You should probably anticipate (in the first pass, anyway) that any mutable state in your solution could have more than one writer.  So you should anticipate that all mutable writes use some sort of predicate/validator to support a conditional PUT.</p><p>Both DynamoDB and S3 support conditional puts, so they are options -- but they aren&#39;t necessarily free, in the sense that you&#39;ll need to think through your storage strategy, and implement the appropriate semantics on top of them</p><p>During the breakout on event sourcing at Re:Invent 2017, DynamoDB was the primary persistence choice in the discussion.  After some discussion, the conclusion was that batch writes would not work in a multiple writer scenario - each conditional write would insert a single row.</p><p>You also need to think about what reliability guarantees that you need -- is it safe to broadcast events before you store them?  Should L1 be reporting success before the persistent changes have been verified?</p><p>My best guess at an MVP would be to have your L1 endpoints reading and writing to Dynamo, and then chain other idempotent consumers off the back of that (ie a lambda that reads events out of dynamo and writes them to SNS, Kinesis, etc).</p><p>Depending on your guarantees, you might be able to simplify the writers somewhat via L1 -&gt; SNS -&gt; L2 -&gt; Dynamo -&gt; etc.</p><blockquote><p>when you say mutable writes should use a predicate, do you mean I should write my events like &#34;the state has been updated from 16 to 17&#34;, and then make L2 validate that the state is currently 16 before updating?</p></blockquote><p>Yes -- think &#34;compare and swap&#34;, <a href="https://www.rfc-editor.org/rfc/rfc7232#section-3.1" rel="nofollow noreferrer">If-Match</a>, <a href="https://www.rfc-editor.org/rfc/rfc6902#section-4.6" rel="nofollow noreferrer">JSON Patch test operation</a>, and so on.  If multiple writers need to be enforcing an invariant, then you need some way to ensure that the state being overwritten is the correct one.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../designing-events-in-an-event-driven-event-sourced-architecture-and-managing-duplication/'>Designing events in an event-driven (event sourced) architecture and managing duplication</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>