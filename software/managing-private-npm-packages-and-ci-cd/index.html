<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Managing private NPM packages and CI/CD &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1085165 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1085165" class="post-1085165 software type-software status-publish hentry category-software tag-configuration-management tag-continuous-integration tag-docker tag-node-js tag-npm"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Managing private NPM packages and CI/CD</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">configuration-management</span><span class="mr-2 badge badge-info">continuous integration</span><span class="mr-2 badge badge-warning">docker</span><span class="mr-2 badge badge-primary">node.js</span><span class="mr-2 badge badge-danger">npm</span></p><div class="entry-content"><p>At work, we have an application that is run directly on dev machines, but deployed in Docker swarms (a QA swarm and production swarm). The code and CI/CD pipelines are all in GitLab CE.</p><p>It uses several private, internal NPM packages. We refer to these packages in the <code>package.json</code> like so:</p><pre><code>&#34;@project/utils&#34;: &#34;git@gitlab.com:project/utils.git#branch&#34;
</code></pre><p>This gives us a few problems:</p><ol><li>When developing locally on a feature branch, you have to manually edit the <code>package.json</code> but not check it in, and append the feature branch to the dependency URL.</li><li>Since it&#39;s a git URL, <a href="https://github.com/npm/npm/issues/3328" rel="nofollow noreferrer">Yarn/NPM will not check and get the latest code (even if the <code>package.json</code> version is incremented)</a>. You have to delete the dependency from the <code>node_modules</code> and delete (or edit) the <code>yarn.lock</code>/<code>package-lock.json</code> file  (though I believe <code>yarn upgrade</code> <em>does</em> now upgrade git packages). We do have scripts to do this but, ew.</li><li>We have scripts in our CI/CD pipelines that have to &#34;fix&#34; the branches in the package.json for internal dependencies. This increases build time considerably, and makes it quite fragile. Basically:<ol><li><code>yarn install --frozen-lockfile</code></li><li><code>./fixInternalPrivatePackages.sh package.json $BRANCH #where $branch can be #qa, feature-blah, etc.</code></li><li><code>yarn install #to now get any changed dependencies, sometimes modifies other unrelated deps in the lockfile</code></li><li><code>yarn run build</code></li></ol></li></ol><p>And then it&#39;s pushed to a Docker registry.</p><p>With this setup the lockfile sometimes gets modified, causing builds to fail. It&#39;s also a pain to manage on dev machines. Devs sometimes check-in their <code>package.json</code> with the wrong <code>#branch</code>, and this causes other people&#39;s builds to fail.</p><p>Possible solutions:</p><ol><li>Automate tagging internal dependencies, then adjust the <code>package.json</code> with these tags (could really just be the commit hash).</li><li>Private package repository. This fixes the problem with getting the latest version if the latest is always pushed. I believe this should fix the <code>fixInternalPrivatePackages</code> hacky script situation as well.</li><li>Git/NPM pre/post hooks/scripts to fix a project&#39;s own <code>package.json</code> (remove all branches, etc.)</li></ol><p>But all these solutions just seem more like band-aids on a fundamental problem. Are we doing this the right way? Are there any example projects with internal dependencies like this that I could get some inspiration from?</p><p>I feel like one fundamental issue is that the internal dependencies need their own independent QA-&gt;Prod cycle, so that they are already locked to a specific version before the rest of the app is moved along from QA-&gt;prod.</p><p>Another problem is that while yarn and npm now have lockfiles (we don&#39;t talk about the time before lockfiles), our workflow breaks this functionality when it has to modify the <code>package.json</code> to switch branches, and reinstall dependencies without the <code>--frozen-lockfile</code> switch. We want reproducible builds, and I can&#39;t guarantee that we have them.</p><p>It takes a long time to get a developer up to speed on our project because of all these configuration management issues. The actual code itself is much simpler than the code that requires DevOps knowledge to get it running.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>Well, I stumbled on <a href="https://lernajs.io/" rel="nofollow noreferrer">Lerna</a> from a post from Hacker News and it appears to be just what we need. I will accept if it works out but it&#39;s going to be a while.</p><blockquote><p>Splitting up large codebases into separate independently versioned packages is extremely useful for code sharing. However, making changes across many repositories is messy and difficult to track, and testing across repositories gets complicated really fast.</p><p>To solve these (and many other) problems, some projects will organize
 their codebases into multi-package repositories. Projects like Babel,
 React, Angular, Ember, Meteor, Jest, and many others develop all of
 their packages within a single repository.</p><p>Lerna is a tool that optimizes the workflow around managing
 multi-package repositories with git and npm.</p></blockquote><p>I&#39;m also removing the <code>fixInternalPrivatePackages.sh</code> CI step <s>and just checking in the branched project&#39;s package.json as it should be. This will require manual steps if a new branch is added to a dependency but that happens less often than problems from the CI script.</s></p><h3>UPDATE Sept 2018:</h3><p>Lerna is nice but won&#39;t help our CI workflow. It&#39;s more for dev workstations. We really need a private package repository to keep published versions. QA and feature branches can use <code>latest</code> tags, where production can use our semver-ish tags.</p><p>I discovered <a href="https://github.com/verdaccio/verdaccio" rel="nofollow noreferrer">Verdaccio</a>, and I&#39;m hoping it will resolve our dependency hell.</p><h3>UPDATE Dec 2018:</h3><p>The React project itself seems well organized and a good project to imitate. Using yarn workspaces seems like a good idea -- but it would take time to convert everything to a monorepo.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../best-practices-for-adding-node-js-build-features-to-a-non-node-project/'>Best practices for adding Node.JS build features to a non-Node project</a></li><li class="list-group-item"><a href='../what-version-numbers-should-i-assign-to-builds-on-different-branches-as-part-of-continuous-integration-for-net-core-based-projects/'>What version numbers should I assign to builds on different branches as part of continuous integration for NET Core-based projects</a></li><li class="list-group-item"><a href='../git-flow-w-vsts-build-pipelines/'>Git Flow w/ VSTS Build Pipelines</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>