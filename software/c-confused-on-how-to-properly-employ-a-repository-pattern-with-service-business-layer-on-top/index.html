<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>C# &#8211; Confused on how to properly employ a Repository Pattern with Service/Business Layer on top &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1073004 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1073004" class="post-1073004 software type-software status-publish hentry category-software tag-asp-net tag-c tag-design-patterns tag-entity-framework tag-repository"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">C# &#8211; Confused on how to properly employ a Repository Pattern with Service/Business Layer on top</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">asp.net</span><span class="mr-2 badge badge-info">c</span><span class="mr-2 badge badge-warning">design-patterns</span><span class="mr-2 badge badge-primary">entity-framework</span><span class="mr-2 badge badge-danger">repository</span></p><div class="entry-content"><p>I&#39;m building a ASP.NET Web Api 2 solution for learning purposes, and I&#39;ve hit a snag. I was wondering if anyone could tell me what exactly it is that I&#39;m missing.</p><p>My Web Api solution has 4 Layers:</p><ul><li>Data, which contains the Data Models ( POCOs ), Fluent API Mappings, EF Context, Migrations and Seeding</li><li>Repository, which implements CRUD for all Data Models and returns the business Models</li><li>Domain / Service / Business which supplies the IRepository interface, and should hold services which implement the application&#39;s business logic. Also contains the Business Models.</li><li>Web, the Web Api controllers and DI / IoC to tie everything together.</li></ul><p>References are as follows: Data &lt; Repository &gt; Domain</p><p>Web references all 3 layers for DI.</p><p>The idea behind the separate domain layer is that it is completely oblivious to anything that happens in the Data or Repository layer. It simply outlines its requirements by providing the IRepository for the Repository layer, and the Business Models that it wants to get as a result. It&#39;s up to the Repository layer to meet the Domain Layer&#39;s requests.</p><p><strong>Here is my conundrum</strong>:</p><ul><li>Since Domain has no ties to Data, it does not know anything about the structure of the Data model. This means that the repository layer needs to convert everything to the Business Model before returning it. &#8211; I suppose I could return it as a generic object, and then map the generic object to the business model inside the Domain Layer. Would that be more appropriate?</li><li>Again, since Domain does not know anything about the Data Model, I can&#39;t pass any expressions to apply on the data set to my Repository. This means that for every property I want to WHERE, I&#39;d have to create a POCO specific Repository with matching IBussinessModelRepository which outlines it&#39;s requirements, and then implement that requirement. This quickly gets tedious though, as it calls for a bunch of &#34;GetByProp1&#34;, &#34;GetByProp2&#34; &#8211; monkey code central.</li><li>What if I want to create a composite business model that requires a complex query to hydrate? Is my only option to create yet another IBusinessRepository with a matching Repository and then write the complex query in the repository layer? If that is the case, then it feels like the service layer is mostly just another step that passes along non-crud requests to specific repositories.</li><li><strike>Is it proper for web API controllers to send requests directly to the repository? It would seem pretty silly to route all CRUD requests through the service layer, which just passes the request to the repository layer anyway.</strike> No, it&#39;s not as the service layer should be the entry point for all operations. ( With Web just acting as a consumer of the services offered. )</li><li>I currently don&#39;t use a Unit of Work because there is a lot of mixed opinions when it comes to UoW + EF. I&#39;m not yet experienced enough to be on either side of the fence. Would a UoW be helpful in this scenario?</li></ul><p>I feel like I am missing a vital part in what makes this pattern / layer approach tick.</p><p>I know that I could easily proceed by cheating ( i.e. give service access to data specific stuff like the context ), but I&#39;m more interested in learning how to do it the proper way.</p><p>The research I have done so far yielded results that vary wildly:</p><ul><li>From the Repository using AutoMapper to change the type to the business model without actually executing the query, allowing the service layer to pass Business Model Expressions which can then be applied and then running the query, returning the mapped result &#8212; sounds great, except that approach does not seem to work for me due to AutoMapper not being able to deal with my Models having recursive nav properties.</li><li>To the service layer just interfacing directly with the POCOs. ( And thus having direct access to the DAL )</li></ul><p>What am I missing?</p><p>Edit to explain more about my code:</p><p><strong><a href="https://github.com/Bio2hazard/ShortStuff/blob/master/ShortStuffApi/ShortStuff.Repository/RepositoryBase.cs" rel="nofollow noreferrer">My Generic Repository on Github</a></strong> contains CRUD methods like this one:</p><pre><code>public abstract class RepositoryBase&lt;TData, TDomain, TId&gt; : IRepository&lt;TDomain, TId&gt; where TDomain : EntityBase&lt;TId&gt;, new() where TData : class, IDataEntity&lt;TId&gt;, new()
{
    private readonly ShortStuffContext _context;

    public RepositoryBase(ShortStuffContext context)
    {
        _context = context;
    }

    public IEnumerable&lt;TDomain&gt; GetAll()
    {
        return _context.Set&lt;TData&gt;().BuildQuery&lt;TData, TDomain&gt;();
    }
}
</code></pre><p>BuildQuery is a LINQ Extension which either grabs all entities, or can take a expression to fetch a single entity and then uses ValueInjecter to map the Data Model to the Domain Model.</p><p>The repository methods are requested by the Domain Layer via Interface:</p><pre><code>public interface IRepository&lt;TDomain, TId&gt; where TDomain : EntityBase&lt;TId&gt;
{
    IEnumerable&lt;TDomain&gt; GetAll();
}
</code></pre><p>The RepositoryBase is extended by Repositories for the individual POCOs, which currently sit empty, only providing TData, TDomain and TId to the Repository Base:</p><pre><code>public class UserRepository : RepositoryBase&lt;Data.Entities.User, User, decimal&gt;
{
    public UserRepository(ShortStuffContext context)
        : base(context)
    {
    }
}
</code></pre><p>Which can be requested by the Domain Layer via Constructor Injection <code>IRepository&lt;User, decimal&gt; UserRepository</code> through a ninject <code>InRequestScope</code> binding.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>How large is your application?  There&#39;s a good chance you&#39;re overthinking this.  Unless the application is a large, enterprise-grade application, the high degree of loose coupling you are advocating is probably unnecessary.</p><p>If you decide that this level of loose coupling  is still necessary, create a service layer that returns &#34;service&#34; objects.  This fulfills a similar function to View Models in MVC.  You will then write code in your service layer that maps objects from your domain model to your service model.</p><p>Note that part of your struggle may be due to the fact that, while your Data Repository is returning CRUD objects, your Service Layer should be returning <em>the result of actions.</em> For example:</p><pre><code>public InvoiceView GetInvoice(int invoiceID);
</code></pre><p>returns a <code>InvoiceView</code> object containing whatever data you wish to expose to the public, including Name, Address, Line Items and so forth, from several different tables/objects in your domain.</p><pre><code>public class InvoiceView
{
    public int InvoiceID;
    public Address ShippingAddress;
    public Address BillingAddress;
    public List&lt;LineItem&gt; LineItems;
    ...
}
</code></pre><p>Similarly, there will be Service Layer methods that simply performs an action and returns an object indicating the result of the action:</p><pre><code>public TransactionResult Transfer(
    int sourceAccountID, int targetAccountID, Money amount, ValidationToken token);
</code></pre><p>IMPORTANT: <strong>You&#39;ll never be able to completely decouple from your data.</strong> Your consumer will always have to have some knowledge of the data, even if it&#39;s just an object ID or UUID.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../architecture-how-to-use-the-unit-of-work-and-repository-patterns-in-a-service-oriented-enviroment/'>Architecture &#8211; How to use the unit of work and repository patterns in a service oriented enviroment</a></li><li class="list-group-item"><a href='../how-accurate-is-business-logic-should-be-in-a-service-not-in-a-model/'>How accurate is &#8220;Business logic should be in a service, not in a model&#8221;</a></li><li class="list-group-item"><a href='../architecture-repository-pattern-with-service-layer-too-much-separation/'>Architecture &#8211; Repository pattern with service layer &#8211; too much separation</a></li><li class="list-group-item"><a href='../design-how-to-describe-the-repository-pattern/'>Design &#8211; How to describe the Repository pattern</a></li><li class="list-group-item"><a href='../how-domain-repository-and-service-layers-works-vs-original-dao-pattern/'>How Domain, repository and service layers works VS original DAO pattern</a></li><li class="list-group-item"><a href='../avoiding-repository-pattern-implementing-onion-architecture-with-dbcontext-only/'>Avoiding Repository pattern &#8211; implementing Onion Architecture with DbContext only</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>