<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="https://free-tor-game.com/wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>C# &#8211; Is the C# EventHandler designed the wrong way &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.min.js?ver=11.2.0' id='highlight-js'></script>     <script>( function( w, d, s, l, i ) {
				w[l] = w[l] || [];
				w[l].push( {'gtm.start': new Date().getTime(), event: 'gtm.js'} );
				var f = d.getElementsByTagName( s )[0],
					j = d.createElement( s ), dl = l != 'dataLayer' ? '&l=' + l : '';
				j.async = true;
				j.src = 'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
				f.parentNode.insertBefore( j, f );
			} )( window, document, 'script', 'dataLayer', ' ' );</script>      <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1078081 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="https://free-tor-game.com/3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="https://free-tor-game.com/contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1078081" class="post-1078081 software type-software status-publish hentry category-software tag-clr tag-c tag-event-handling tag-net"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">C# &#8211; Is the C# EventHandler designed the wrong way</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">\clr</span><span class="mr-2 badge badge-info">c</span><span class="mr-2 badge badge-warning">event handling</span><span class="mr-2 badge badge-primary">net</span></p><div class="entry-content"><p>State of the union:</p><p>C# Events/Eventhandlers are:</p><ul><li>blocking</li><li>throwing Exceptions</li><li>sequential</li><li>deterministic executed in order</li><li>MulticastDelegates</li><li>a handler is always dependent on the behavior of the handlers registered earlier</li></ul><p>Actually they are pretty close to regular function pointers. Despite beeing a sequence of them.</p><p>If any event-subscriber is doing evil things (blocking, throwing Exceptions):</p><ul><li>the event invoker is blocked (in the worst case indefinitely)</li><li>the event invoker has to deal with unpredictable exceptions</li><li>the internal sequential eventhandler calling will break at the first exception</li><li>any EventHandler internally stored after the failing Eventhandler will not be executed</li></ul><p><a href="https://dotnetfiddle.net/ekgiPM" rel="noreferrer">C# Example on .Net Fiddle</a></p><p>I always thought of c# events as an implementation of the publish-subcribe pattern.</p><p><strong>But:</strong></p><p>This contradicts my intuition of publishing/subcriber semantics.<br /> Actually it seems to be the opposite.</p><p>If i publish a news/website/book/podcast/newsletter:</p><ul><li>publishing is non-blocking (in relationship to the subscribers)</li><li>consuming is concurrent</li><li>reader/subscriber errors don&#39;t interfere with my publishing</li><li>reader/subscriber errors don&#39;t interfere with other readers/subscribers</li></ul><p>Transfered to .Net this would mean: event.Invoke(&#8230;) leads to:</p><ul><li>event.Invoke(&#8230;) is fire and forget</li><li>all subscriptions are dispatched to the thread-pool</li><li>and executed concurrent and independent of each other (not threadsafe though)</li><li>undeterministic order of execution</li><li>you might have to take care of threadsafety while accessing objects</li><li>one handler cannot &#34;kill&#34; the execution of other handlers</li></ul><p>Other people seem to be confused too:</p><ul><li><a href="https://stackoverflow.com/questions/7106454/are-c-sharp-events-synchronous">https://stackoverflow.com/questions/7106454/are-c-sharp-events-synchronous</a></li><li><a href="https://stackoverflow.com/questions/2341731/why-wont-control-update-refresh-mid-process/2341744">https://stackoverflow.com/questions/2341731/why-wont-control-update-refresh-mid-process/2341744</a></li><li><a href="https://stackoverflow.com/questions/287142/invoke-is-blocking/287149">https://stackoverflow.com/questions/287142/invoke-is-blocking/287149</a></li><li><a href="https://stackoverflow.com/questions/2328815/should-c-sharp-event-handlers-be-exception-safe">https://stackoverflow.com/questions/2328815/should-c-sharp-event-handlers-be-exception-safe</a></li></ul><p>PS:<br /> I&#39;m aware that this might be highly subjective.<br /> I guess there&#39;ve been good reasons to do it this way.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>There seem to be two main thrusts to your critique:</p><ul><li>Events are fragile in the face of hostile or buggy subscribers.</li><li>The publish-subscribe metaphor doesn&#39;t match your intuition.</li></ul><p>Let&#39;s deal with the second point first. All metaphors in design patterns are analogies, not isomorphisms. The criticism is valid, but remember, the design was not motivated by a desire to match the intuitions entailed by the metaphor! The design was motivated by a desire to meet the needs of line-of-business developers at a reasonable cost.</p><p>The first point is the more important one. <strong>Events are indeed fragile in the face of hostile or buggy subscribers</strong>. There are some interesting attacks.</p><p>Consider for example the .NET 1.0 security model, which was designed to allow code of different trust levels to be &#34;on the stack&#34; at the same time, but &#34;luring&#34; attacks -- where low-trust code calls high-trust code to do something hostile -- are mitigated by stack walks. That is, when high-trust code attempts a dangerous act, all the code on the call stack must be sufficiently trusted, not just the high-trust code itself.</p><p>Now, what happens when low-trust code adds a delegate to a high-trust method as a handler of an event?  When the event is triggered, the low-trust code is no longer on the stack, so the stack walk does not see it!</p><p>There are a great many ways that events may be used by hostile code to damage the user. <strong>Events were specifically not designed to mitigate these vulnerabilities</strong>. You, the developer, are responsible for writing code that ensures that only high-trust code is allowed to add an event handler, and that the handler is benign.</p><p>Your question then is &#34;is the design <strong>wrong</strong>?&#34; Well, the answer is that a design is wrong when it fails to achieve its design goals. Designing a system where events were robust in the face of hostile event handlers was explicitly a non-goal of the design process, so the design is not in that sense &#34;wrong&#34;.</p><p>It is certainly possible to develop a publish-subscribe system that has the properties you want: asynchrony, isolation, robustness and so on. The default event system was not designed to have those properties. Rather, <em>it was designed to make a checkbox turn green when you click a button</em>. It succeeds at that goal extremely well.</p><p>Moreover, it is by no means clear that your preferences are &#34;better&#34; universally; they may only be better in your specific use cases.  Let&#39;s look at one of them, for argument&#39;s sake. Is it <em>good</em> that an exception thrown by one handler prevents the execution of the next handler, or <em>bad</em>? You imply that it is <em>bad</em>, but examine the premises more carefully. Under what circumstances can we expect that a handler raises an unhandled exception?</p><ul><li>The handler is hostile and attempting a denial of service attack.</li></ul><p>In this situation is the right thing to do to keep on trying to execute more handler code that <em>also</em> might be attacks? Attacks that might be <em>depending</em> on whatever broken state has been produced that caused the crash?</p><ul><li>The handler is benign but buggy and has crashed by accident</li></ul><p>The handler is so buggy that it crashed, possibly leaving its own internal state inconsistent, and possibly losing user data. Is the right thing to do to run a <em>second</em> handler that might <em>also</em> depend on that internal state, and lose <em>more</em> user data?</p><ul><li>The handler is benign and not buggy, and its action exposes a crashing bug in the event source.</li></ul><p>The event source&#39;s internal data structures are so corrupted that they are throwing unexpected exceptions during event handling. Is the right thing to do to run <em>more code</em>?</p><hr/><p>If something unexpected has happened and the world is now in a dangerously unstable, unpredictable state, running <em>more random code</em> is almost always the <em>wrong</em> thing to do. Sometimes isolating crashes just keeps a broken system producing harm alive <em>longer</em> to produce more harm! The <em>right</em> thing to do when an event handler throws an unexpected exception is to shut the entire system down, stopping further damage, logging the problem, and encouraging the development team to patch the buggy, crashing code.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='https://free-tor-game.com/software/c-what-is-a-proper-way-to-register-eventhandler/'>C# &#8211; what is a proper way to register eventHandler</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/c-async-network-programming-using-reactive-extensions/'>C# &#8211; Async network programming using Reactive Extensions</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/c-how-does-persistence-fit-into-a-purely-functional-language/'>C# &#8211; How does persistence fit into a purely functional language</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/c-testing-c-eventhandler-subscription/'>C# &#8211; Testing C# Eventhandler Subscription</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/c-should-i-omit-the-parameter-e-when-using-eventhandler/'>C# &#8211; Should I omit the parameter &#8220;e&#8221; when using EventHandler<EventArgs></a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/c-how-to-write-a-custom-eventhandler-class/'>C# &#8211; How to write a custom EventHandler class</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/domain-events-cqrs-and-dependency-resolution-in-handlers/'>Domain Events, CQRS, and dependency resolution in handlers</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='http://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="https://free-tor-game.com/wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>