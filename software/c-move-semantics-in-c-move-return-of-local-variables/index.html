<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>C++ &#8211; Move semantics in C++ &#8211; Move-return of local variables &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1067140 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1067140" class="post-1067140 software type-software status-publish hentry category-software tag-c tag-c11"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">C++ &#8211; Move semantics in C++ &#8211; Move-return of local variables</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">c</span><span class="mr-2 badge badge-info">c++11</span></p><div class="entry-content"><p>My understanding is that in C++11, when you return a local variable from a function by value, the compiler is allowed to treat that variable as an r-value reference and &#39;move&#39; it out of the function to return it (if RVO/NRVO doesn&#39;t happen instead, of course).</p><p>My question is, can&#39;t this break existing code?</p><p>Consider the following code:</p><pre><code>#include &lt;iostream&gt;
#include &lt;string&gt;

struct bar
{
  bar(const std::string&amp; str) : _str(str) {}
  bar(const bar&amp;) = delete;
  bar(bar&amp;&amp; other) : _str(std::move(other._str)) {other._str = &#34;Stolen&#34;;}
  void print() {std::cout &lt;&lt; _str &lt;&lt; std::endl;}

  std::string _str;
};

struct foo
{
  foo(bar&amp; b) : _b(b) {}
  ~foo() {_b.print();}

  bar&amp; _b;
};

bar foobar()
{
  bar b(&#34;Hello, World!&#34;);
  foo f(b);

  return std::move(b);
}

int main()
{
  foobar();
  return EXIT_SUCCESS;
}
</code></pre><p>My thoughts were that it would be possible for a destructor of a local object to reference the object that gets implicitly moved, and therefore unexpectedly see an &#39;empty&#39; object. I tried to test this (see <a href="http://ideone.com/ZURoeT">http://ideone.com/ZURoeT</a> ), but I got the &#39;correct&#39; result without the explicit <code>std::move</code> in <code>foobar()</code>. I&#39;m guessing that was due to NRVO, but I didn&#39;t try to rearrange the code to disable that.</p><p>Am I correct in that this transformation (causing a move out of the function) happens implicitly and could break existing code?</p><p><strong>UPDATE</strong><br /> Here is an example which illustrates what I&#39;m talking about. The following two links are for the same code.<br /> <a href="http://ideone.com/4GFIRu">http://ideone.com/4GFIRu</a> &#8211; C++03<br /> <a href="http://ideone.com/FcL2Xj">http://ideone.com/FcL2Xj</a> &#8211; C++11</p><p>If you look at the output, it&#39;s different.</p><p>So, I guess this question now becomes, was this considered when adding implicit move to the standard, and it was decided that it was OK to add this breaking change as this kind of code is rare enough? I also wonder if any compilers will warn in cases like this&#8230;</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>Scott Meyers <a href="http://groups.google.com/group/comp.lang.c++/browse_thread/thread/d51d6282f098b3ca" rel="noreferrer">posted</a> to comp.lang.c++ (August 2010) about a problem where implicit generation of move constructors could break C++03 class invariants:</p><pre><code>struct X
{
  // invariant: v.size() == 5
  X() : v(5) {}

  ~X() { std::cout &lt;&lt; v[0] &lt;&lt; std::endl; }

private:    
  std::vector&lt;int&gt; v;
};

int main()
{
    std::vector&lt;X&gt; y;
    y.push_back(X()); // X() rvalue: copied in C++03, moved in C++0x
}
</code></pre><p>Here the problem is that in C++03, <code>X</code> had an invariant that its <code>v</code> member always had 5 elements. <code>X::~X()</code> counted on that invariant, but the newly-introduced move constructor moved from <code>v</code>, thereby setting its length to zero.</p><p>This is related to your example since the broken invariant is only detected in the <code>X</code>&#39;s destructor (as you say it&#39;s possible for a destructor of a local object to reference the object that gets implicitly moved, and therefore unexpectedly see an <em>empty</em> object).</p><p>C++11 try to achieve a balance between breaking some of existing code and providing useful optimizations based on move constructors.</p><p>Committee initially decided that move constructors and move assignment operators should be generated by the compiler when not provided by the user.</p><p>Then decided that this was indeed cause for alarm and it restricted the automatic generation of move constructors and move assignment operators in such a way that it is much less likely, though not impossible, for existing code to break (e.g. explicitly defined destructor).</p><p>Itâ€™s tempting to think that preventing the generation of implicit move constructors when a user-defined destructor is present is enough but it&#39;s not true (<a href="http://www.open-std.org/jtc1/sc22/wg21/docs/papers/2010/n3153.htm" rel="noreferrer">N3153 - Implicit Move Must Go</a> for further details).</p><p>In <a href="http://www.stroustrup.com/move.pdf" rel="noreferrer">N3174 - To Move or not to Move</a> Stroupstrup says:</p><blockquote><p>I consider this a language design problem, rather than a simple backwards
 compatibility problem. It is easy to avoid breaking old code (e.g. just
 remove move operations from C++0x), but I see making C++0x a better language
 by making move operations pervasive a major goal for which it may be worth
 breaking some C++98 code.</p></blockquote></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../c-simplifying-c11-optimal-parameter-passing-when-a-copy-is-needed/'>C++ &#8211; Simplifying C++11 optimal parameter passing when a copy is needed</a></li><li class="list-group-item"><a href='../c-are-there-real-world-examples-demonstrating-reasonable-performance-improvement-by-using-move-semantics/'>C++ &#8211; Are there real world examples demonstrating reasonable performance improvement by using move semantics</a></li><li class="list-group-item"><a href='../c-object-lifetime-invariants-vs-move-semantics/'>C++ &#8211; Object lifetime invariants vs. move semantics</a></li><li class="list-group-item"><a href='../c-in-c-why-shouldnt-all-function-parameters-be-references/'>C++ &#8211; In C++, why shouldn&#8217;t all function parameters be references</a></li><li class="list-group-item"><a href='../c-how-to-implement-option-to-return-blob-arraybuffer-or-audiobuffer-from-window-speechsynthesis-speak-call/'>C++ &#8211; How to implement option to return Blob, ArrayBuffer, or AudioBuffer from window.speechSynthesis.speak() call</a></li><li class="list-group-item"><a href='../c-is-it-bad-practice-to-write-code-that-relies-on-compiler-optimizations/'>C++ &#8211; Is it bad practice to write code that relies on compiler optimizations</a></li><li class="list-group-item"><a href='../c-when-should-i-use-string_view-in-an-interface/'>C++ &#8211; When should I use string_view in an interface</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>