<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Domain Driven Design &#8211; Updating and persisting aggregates &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1080533 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1080533" class="post-1080533 software type-software status-publish hentry category-software tag-aggregate tag-domain-driven-design tag-domain-model tag-repository"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Domain Driven Design &#8211; Updating and persisting aggregates</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">aggregate</span><span class="mr-2 badge badge-info">domain-driven-design</span><span class="mr-2 badge badge-warning">domain-model</span><span class="mr-2 badge badge-primary">repository</span></p><div class="entry-content"><p>I&#39;m trying to wrap my head around the best possible solution in the following situation:</p><p>When updating part of an aggregate, could be any part of the aggregate so either the root or any other entity, <strong>how could these changes be persisted back to the db layer.</strong></p><p>There have been a lot of solutions on StackExchange advising something like using your ORM models as Domain objects so you could change the attribute on the Aggregate and let the ORM layer diff and flush the changes to the db, most examples contain references to the Enity Framework if I&#39;m not mistaken. <a href="https://stackoverflow.com/questions/7496094/saving-domain-entities-changes">Like the solution here, Article which is a Domain object contains ORM persistence logic</a></p><p><strong>My partial understanding of DDD was that you shouldn&#39;t define any persistence layer logic in your domain models.</strong> The persistence logic should be defined in your repository, possibility of having a variety of persistence mechanisms (Postgres, MongoDB, S3 etc). Also &#39;littering&#39; Domain models with persistance logic and/or &#39;original&#39; SQL objects makes it a lot harder to test my Domain objects / Aggregates.</p><p>I&#39;m having trouble understanding an easy and simple solution, maybe there isn&#39;t any, on how to map these changes back to my ORM layer, in my case I&#39;m using Postgres. Unless the answer is a <strong>strong mapping between your ORM model and Domain model in your repository</strong> it looks really hard and verbose to do so.</p><p>I figured out, by reading other solutions, that there are a couple of other possibilities (they all have their own drawbacks):</p><ol><li><p>Generate a <code>ModelAttributeChanged</code> event whenever you change something in your Domain model. You could either return this event, or store it somewhere on the Domain model. When persisting this model in the repository, query the ORM model first and map these changes back on the ORM model before committing it.</p><pre><code>changed_name_event = person_aggregate.set_name(&#39;Henk&#39;)
Repository.save(person_aggregate, changed_name_event)
</code></pre></li><li><p>After you change something on the Aggregate, explicitly call the update method on the Repository aswell to update the attribute. You&#39;d need to update everything on both the Aggregate and on the repository, and you need to know in advance which attributes of your aggregate are going to change before calling the right method on your repository.</p><pre><code>person_aggregate.change_name(&#39;Henk&#39;)
repository.change_person_name(person_aggregate, &#39;Henk&#39;)
</code></pre></li></ol><p>Ideally I just want to be able to update my aggregate and save it through my repository. However because I map my ORM model to an AR, Aggregate Root, I &#39;loose&#39; the mapping to the ORM model. I could ofcourse keep track of all the changes I make to the Aggregate and whenever I call the repository apply these changes to the ORM model and commit it to the database. My &#39;problem&#39; with this solution is that I need a strong mapping and tracking changes for nested entities is a hard, complex and error prone process.</p><p>If this is the necessary evil in order completely isolate your domain logic I&#39;m okay with it but it just feels like a lot of logic has to be defined in order to get this abstraction working.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><blockquote><p>Ideally I just want to be able to update my aggregate and save it through my repository.</p></blockquote><ol start="3"><li>Save the entire aggregate every time it changes regardless of which (possibly nested) fields change:</li></ol><p><code>Repository.save(person_aggregate)</code></p><p>In all seriousness, I&#39;d actually like to address a different question above - one that was not specifically denoted (Robert Harvey&#39;s answer touches on this as well).</p><p>Phrases like &#34;best possible solution&#34; are, at best, misleading, and at worst, obfuscating. Every design decision you make is a <em>trade off</em>. Understanding these trade offs and making the &#34;best possible&#34; choice between them is precisely the job of an architect. Unfortunately for us, we cannot know for what <em>you</em> would like to optimize or what levels of compromise <em>your</em> system can tolerate.</p><p><em>Me</em>? I think in terms of complexity. I would not go down the road of manually implementing change-tracking (worst option). Nor would I introduce some variant of event sourcing (second worst option). I also wouldn&#39;t duplicate/propagate changes in every use-case. Where does that leave <em>you</em>?</p><p>You seem to have a reasonable grasp of the trade offs between the different options. Now be an architect and pick one.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../how-far-to-go-with-domain-driven-design/'>How far to go with Domain Driven Design</a></li><li class="list-group-item"><a href='../design-domain-driven-design-can-two-aggregates-have-the-same-root/'>Design &#8211; Domain driven design, can two aggregates have the same root</a></li><li class="list-group-item"><a href='../domain-driven-design-approach-without-orm/'>Domain Driven Design Approach without ORM</a></li><li class="list-group-item"><a href='../c-pitfalls-of-domain-driven-design-with-entity-framework/'>C# &#8211; Pitfalls of Domain Driven Design with Entity Framework</a></li><li class="list-group-item"><a href='../a-problem-with-understanding-aggregates-and-aggregate-roots-in-domain-driven-design-ddd/'>A problem with understanding aggregates and aggregate roots in Domain Driven Design (DDD)</a></li><li class="list-group-item"><a href='../domain-driven-design-updating-part-of-aggregate/'>Domain Driven Design &#8211; updating part of aggregate</a></li><li class="list-group-item"><a href='../c-domain-driven-design-navigation-properties-and-aggregate/'>C# &#8211; Domain Driven Design // Navigation Properties and Aggregate</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>