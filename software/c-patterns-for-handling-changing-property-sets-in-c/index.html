<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>C++ &#8211; Patterns for Handling Changing Property Sets in C++ &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1076973 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1076973" class="post-1076973 software type-software status-publish hentry category-software tag-c tag-design tag-design-patterns"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">C++ &#8211; Patterns for Handling Changing Property Sets in C++</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">c</span><span class="mr-2 badge badge-info">design</span><span class="mr-2 badge badge-warning">design-patterns</span></p><div class="entry-content"><p>I have a bunch &#34;Property Sets&#34; (which are simple <code>structs</code> containing POD members). I&#39;d like to modify these property sets (eg: add a new member) at run time so that the definition of the property sets can be externalized and the code itself can be re-used with multiple versions/types of property sets with minimal/no changes.</p><p>For example, a property set could look like this:</p><pre><code>struct PropSetA
{
    bool activeFlag;
    int processingCount;
    /* snip few other such fields*/
};
</code></pre><p>But instead of setting its definition in stone at compile time, I&#39;d like to create it <em>dynamically</em> at run time. Something like:</p><pre><code>class PropSet propSetA;
propSetA(&#34;activeFlag&#34;,true);  //overloading the function call operator
propSetA(&#34;processingCount&#34;,0); 
</code></pre><p>And the code dependent on the property sets (possibly in some other library) will use the data like so:</p><pre><code> bool actvFlag = propSet[&#34;activeFlag&#34;];
 if(actvFlag  == true)
 {
   //Do Stuff
 }
</code></pre><p>The current implementation behind all of this is as follows:</p><pre><code>class PropValue
{
 public:
    // Variant like class for holding multiple data-types
    // overloaded Conversion operator. Eg:
    operator bool()
    {
      return (baseType == BOOLEAN) ? this-&gt;ToBoolean() : false;
    }
    // And a method to create PropValues various base datatypes
    static FromBool(bool baseValue);
};

class PropSet
{

 public:
  // overloaded[] operator for adding properties
  void operator()(std::string propName, bool propVal)
  {
    propMap.insert(std::make_pair(propName, PropVal::FromBool(propVal)));
  }

 protected:
   // the property map
   std::map&lt;std::string, PropValue&gt; propMap;
};
</code></pre><p>This problem at hand is similar to <a href="https://stackoverflow.com/questions/235376/c-dynamic-class-dynamic-hack">this</a> question on SO and the current approach (described above) is based on <a href="https://stackoverflow.com/a/235503/761170">this</a> answer. But as noted over at SO this is more of a hack than a proper solution. The fundamental issues that I have with this approach are as follows:</p><ul><li>Extending this for supporting new types will require significant code change. At the bare minimum overloaded operators need to be extended to support the new type.</li><li>Supporting complex properties (eg: <code>struct</code> containing <code>struct</code>) is tricky.</li><li>Supporting a reference mechanism (needed for an optimization of not duplicating identical property sets) is tricky. This also applies to supporting pointers and multi-dimensional arrays in general.</li></ul><p>Are there any known patterns for dealing with this scenario? Essentially, I&#39;m looking for the equivalent of the <a href="http://en.wikipedia.org/wiki/Visitor_pattern" rel="nofollow noreferrer">visitor</a> pattern, but for extending <code>class</code> properties rather than methods.</p><p><strong>Edit:</strong> Modified problem statement for clarity and added some more code from current implementation.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>Well, AFAIU you want some kind of reflection, but to retain static type checking the reflection data must be available for template metaprograms.  There are (or at least were) several efforts to implement such a library: <a href="http://kifri.fri.uniza.sk/~chochlik/mirror-lib/html/" rel="nofollow">Mirror C++ reflection utilities</a>, <a href="https://svn.boost.org/trac/boost/wiki/LibrariesUnderConstruction#ReflectiveProgramming" rel="nofollow">Boost libraries for reflective programming</a> (seem to be outdated).  Take a look at them at least as source of inspiration.  Also take a look at <a href="http://www.boost.org/doc/libs/1_49_0/libs/fusion/doc/html/" rel="nofollow">Boost.Fusion</a>, it is a library for working with heterogeneous collections of data (tuples), which in turn can represent structs.</p><p>The simplest static reflection can achieved using a separate code generator which produces code like:</p><pre><code>struct Foo {
  int a;
  double b;
};

// Types to identify struct members
namespace name_tags { struct a; struct b; }

// Reflection metadata for struct Foo
template&lt;&gt;
struct DataMembers&lt;Foo&gt; {
  typedef boost::fusion::result_of::make_map&lt;
    name_tags::a,
    name_tags::b,
    Member&lt;Foo, int&gt;,
    Member&lt;Foo, double&gt;
  &gt;::type type;

  type value;
};

DataMembers&lt;Foo&gt;::type
DataMembers&lt;Foo&gt;::value = 
  boost::fusion::result_of::make_map&lt;
    name_tags::a,
    name_tags::b&gt;(Member&lt;Foo, int&gt;(&amp;Foo::a, &#34;a&#34;), 
                  Member&lt;Foo, double&gt;(&amp;Foo::b, &#34;b&#34;));
</code></pre><p>Where <code>Member</code> class template is like:</p><pre><code>template&lt;typename S, typename M&gt;
struct Member
{
  M S::* ptr;
  std::string name;

  Member(M S::* ptr, const std::string&amp; name) : ptr(ptr), name(name) { }
};
</code></pre><p>Then you can use Boost.Fusion to apply a functor to all members of the class.  You can use additional metafunctions to mark some members, e.g. as properties to process.</p><p>Iterating over members of <code>Foo</code> can be done as</p><pre><code>boost::fusion::for_each(DataMembers&lt;Foo&gt;::value, ProcessMember());

struct ProcessMember
{
  void operator() (const boost::fusion::pair&lt;name_tags::a, Member&lt;Foo, int&gt;&gt;&amp; mem) const
   {
     // ...
   }

  void operator() (const boost::fusion::pair&lt;name_tags::b, Member&lt;Foo, double&gt;&gt;&amp; mem) const
   {
     // ...
   }

   // You can also provide a default case
   template&lt;typename T&gt;
   void operator() (const T&amp;) const { }
};
</code></pre><p>Tag types <code>name_tags::a</code> and <code>name_tags::b</code> appear in the signatures of the <code>operator()</code> and allow to provide separate processing function for each member of <code>Foo</code>.  If you add a member to <code>Foo</code> and update the reflection data (this should be automated) and forget to update processing functors application of those functions will fail to compile.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../architecture-property-container-design-pattern-in-depth-definition/'>Architecture &#8211; &#8220;Property Container&#8221; design-pattern in-depth definition</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>