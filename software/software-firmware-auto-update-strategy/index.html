<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Software/firmware auto update strategy &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1087679 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1087679" class="post-1087679 software type-software status-publish hentry category-software tag-automatic-update tag-deployment tag-software-updates"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Software/firmware auto update strategy</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">automatic update</span><span class="mr-2 badge badge-info">deployment</span><span class="mr-2 badge badge-warning">software-updates</span></p><div class="entry-content"><p>I&#39;ve got a medium-sized project now that&#39;s just nearing the end of the &#34;sloppy caffeine-powered prototypes for client demos&#34; phase and transitioning into &#34;think about the future&#34; phase. The project consists of Linux-based devices with software and firmware, and a central administrative web server. 10 prototypes currently exist, production is expected to be on the order of low 1000&#39;s.</p><p>Not being well-versed in the art of auto-updates, and being short on time, I had quickly rolled my own software deployment / auto-update strategy and, frankly, it sucks. It currently consists of the following:</p><ul><li>A hosted git repo (GitLab) with a production release branch (note the web server source is also in this same repo, as well as a few other things).</li><li>A &#34;deploy update&#34; button on the web interface that:<ol><li>Pulls the latest version from the production release branch into a local repo area and also copies it to a temporary package prep staging area.</li><li>Runs a sanitization script (stored in the repo) in the staging area to remove unrelated source files (e.g. server source, firmware source, etc.) and .git files.</li><li>Writes the current git hash to a file in the update package (purpose will become clear below).</li><li>If all went well, it gzips it and makes it ready to serve by overwriting the previous gzipped package with a file of the same name, then deletes the staging area.</li><li>Note that there are now two copies of the current device software on the server, which are expected to be in sync: A full local git repo on the latest production branch and a ready-to-go gzipped package that is now assumed to represent that same version.</li></ol></li><li>Software on the device is self-contained in a directory named <code>/opt/example/current</code>, which is a symlink to the current version of the software.</li><li>An auto-update function on the device that, on boot:<ol><li>Checks for the presence of a <code>do_not_update</code> file and takes no further action if it exists (for dev devices, see below).</li><li>Reads the current commit hash from the above-mentioned text file.</li><li>Makes an HTTP request to the server with that hash as a query parameter. The server will either respond with a 304 (hash is current version) or will serve the gzipped update package.</li><li>Installs the update package, if one was received, into <code>/opt/example</code> by:<ol><li>Extracting the updated software info a folder named <code>stage</code>.</li><li>Running a post-installation script from the update package that does things like make necessary local changes for that update, etc.</li><li>Copying the current software root folder to <code>previous</code> (deletes existing <code>previous</code> first, if there is one).</li><li>Copying the <code>stage</code> folder to <code>latest</code> (deletes existing <code>latest</code> first, if there is one).</li><li>Ensuring the <code>current</code> symlink to point to <code>latest</code>.</li><li>Rebooting the device (firmware updates, if present, are applied on reboot).</li></ol></li></ol></li></ul><p>There is also the issue of initial deployment on newly constructed devices. The devices are <em>currently</em> SD card based (has its own set of problems, out of scope here) so this process consists of:</p><ol><li>An SD image exists that has some stable earlier version of the software on it.</li><li>An SD card is created from this image.</li><li>On first boot, various first-time device-specific (serial number based) initialization takes place and then the auto-updater grabs and installs the latest production version of the software as per usual.</li></ol><p>Additionally, I needed support for development devices. For development devices:</p><ul><li>A full local git repo is maintained on the device.</li><li>The <code>current</code> symlink points to the development directory.</li><li>A local <code>do_not_update</code> file exists which prevents the auto-updater from blowing away development code with a production update.</li></ul><hr/><p>Now, the deployment process was theoretically intended to be:</p><ol><li>Once the code is ready for deployment push it to the release branch.</li><li>Press the &#34;deploy update&#34; button on the server.</li><li>The update is now live and devices will auto-update the next time they check.</li></ol><p>However, there are a <em>ton</em> of problems in practice:</p><ul><li>The web server code is in the same repo as the device code, and the server has a local git repo that I execute out of. The latest web server code is not on the same branch as the latest device code. The directory structure is problematic. When the &#34;deploy update&#34; button pulls the latest version from the production branch, it pulls it into a subdirectory of the server code. This means that when I deploy to a server from scratch, I have to manually &#34;seed&#34; this subdirectory by grabbing the device production branch into it, because, probably from git user error on my part, if I don&#39;t the deployment attempts to pull the device code from the parent directory&#39;s <em>web server</em> branch. I think this is solvable by making the staging area not be a subdirectory of the server&#39;s local git repo.</li><li>The web server currently does not maintain the git hash of the device software persistently. On server startup, it does a <code>git rev-parse HEAD</code> in its local device software repo to retrieve the current hash. For reasons I can&#39;t wrap my head around this is also causing a ton of logic errors that I won&#39;t describe here, suffice it to say that sometimes restarting the server screws things up, especially if the server is brand new and no production branch repo has been pulled yet. I&#39;d happily share the source for that logic if requested, but this post is getting long.</li><li>If the sanitization script (server side) fails for some reason, then the server is left with an up-to-date repo but an out-of-sync/missing update package, thus <code>git rev-parse HEAD</code> will return a hash that does not match what&#39;s actually being served to the devices, and problems here must be corrected manually on the server command line. I.e. the server does not know the update package is not correct, it merely always assumes so on pure faith. This combined with the previous points makes the server extremely fragile in practice.</li><li><strong>One of the biggest problems is</strong>: <em>There is currently no separate updater daemon running on the device.</em> Due to complications waiting for wifi internet access to come up and some last minute hackery, it&#39;s the main device control software itself that checks and updates the device. This means that if somehow a poorly tested version makes it into production, and the control software can&#39;t start, all devices that exist are essentially bricked, as it can no longer update itself. This would be an absolute nightmare in production. Same deal for a single device if it loses power at an unlucky time.</li><li><strong>The other major problem is</strong>: <em>There is no support for incremental updates.</em> If a device, say, isn&#39;t turned on for a while, then the next time its updated it skips a bunch of release versions, it has to be able to do a direct version-skipping update. The consequence of this is updated deployment is a nightmare of making sure that any given update can be applied on top of any given past version. Furthermore, since git hashes are used to identify versions rather than version numbers, lexicographical comparison of versions to facilitate incremental updates is currently not possible.</li><li>A new requirement that I do not currently support is that there will exist some per-device configuration options (key/value pairs) that must be configured on the administrative server side. I wouldn&#39;t mind somehow serving these per-device options back to the device in the same HTTP request as the software update (perhaps I could encapsulate it in HTTP headers/cookies) although I&#39;m not too concerned about this, as I can always make it a separate HTTP request.</li><li>There is a slight complication due to the fact that two (and more in the future) versions of the hardware exist. The current version of the hardware is actually stored as an environment variable on its initial SD image (they can&#39;t self-identify) and all software is designed to be compatible with all versions of the devices. Firmware updates are chosen based on this environment variable and the update package contains firmware for all versions of the hardware. I can live with this although it is a bit clunky.</li><li>There currently exists no way to manually upload an update to the device (long story short these devices have two wifi adapters in them, one to connect to the internet, and one in AP mode that the user uses to configure the device; in the future I intend to add an &#34;update software&#34; function to the device&#39;s local web interface). This is not a huge deal but does have some impact on the update installation method.</li><li>A bunch of other frustrations and general unsafeness.</li></ul><hr/><p>So&#8230; that was long. But my question boils down to this:</p><p><strong>How do I do this properly and safely?</strong> Are there small adjustments I can make to my existing process? Is there a time-tested strategy / existing system I can leverage so that <em>I don&#39;t have to roll my own crappy update system</em>? Or if I do have to roll my own, what are the things that must be true in order for a deployment/update process to be safe and successful? I have to also be able to include development devices in the mix.</p><p>I hope the question is clear. I realize it&#39;s a bit fuzzy, but I am 100% sure that this is a problem that has been tackled before and successfully solved, I just do not know what the currently accepted strategies are.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>Could you please provide more information about Linux distribution, bootloader and architecture (x86, ARM, MIPS?) that are in use?</p><p>I&#39;ll try to guess either way and hopefully steer your into the right direction.</p><p>If that is a Yocto-based distro with U-Boot, I&#39;d recommend taking a look at <a href="https://mender.io/" rel="nofollow noreferrer">mender.io</a> or <a href="https://github.com/sbabic/swupdate" rel="nofollow noreferrer">swupdate</a>. These projects seem to fit the criteria well. Their primary goal is to ensure atomic updates.</p><blockquote><p>One of the biggest problems is: There is currently no separate updater daemon running on the device. Due to complications waiting for wifi internet access to come up and some last minute hackery, its the main device control software itself that checks and updates the device. This means that if somehow a poorly tested version makes it into production, and the control software can&#39;t start, all devices that exist are essentially bricked, as it can no longer update itself. This would be an absolute nightmare in production. Same deal for a single device if it loses power at an unlucky time.</p></blockquote><p>Mender provides a bunch of tools including a daemon (and a bunch of systemd scripts) written in Go that will lift this burden from your shoulders. This project is pretty easy to use with Yocto (they provide a meta-layer for many devices that should be easy to adapt for your specific case and partition layout. They have a lot of ready-to-go solutions for popular SOCs as well). In case you don&#39;t use Yocto you can look into this <a href="https://mender.io/blog/porting-mender-to-a-non-yocto-build-system" rel="nofollow noreferrer">post</a> which explains exactly what steps you need to make in order to use it with non-Yocto-based distros.</p><p>swupdate is also pretty awesome but it seems like a one-man effort from a guy from DENX (an organization behind U-Boot). It seems pretty mature as well.</p><p>There&#39;s also Ubuntu Snappy I don&#39;t have any experience with and I cannot competently comment on this one (maybe someone will pitch in). The idea is to ship you apps in self-contained &#34;snaps&#34;. From what I&#39;ve understood this is barely a solution to your issue, though as it&#39;s not systemwide.</p><blockquote><p>I hope the question is clear. I realize it&#39;s a bit fuzzy, but I am 100% sure that this is a problem that has been tackled before and successfully solved, I just do not know what the current accepted strategies are.</p></blockquote><p>As a matter of fact  it seems like the trend today is to use Docker (even in embedded systems) and friends over APT/YUM. Latter might make it very difficult to ensure consistency.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../is-it-a-bad-practice-to-stop-providing-support-for-outdated-software-if-updates-are-free-and-easy/'>Is it a bad practice to stop providing support for outdated software if updates are free and easy</a></li><li class="list-group-item"><a href='../is-it-good-practice-on-server-client-systems-to-automatically-install-updates/'>Is it good practice on server/client systems to automatically install updates</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>