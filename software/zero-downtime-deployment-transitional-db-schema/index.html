<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Zero Downtime Deployment &#8211; Transitional Db Schema &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1075467 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1075467" class="post-1075467 software type-software status-publish hentry category-software tag-deployment tag-downtime tag-schema tag-strategy"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Zero Downtime Deployment &#8211; Transitional Db Schema</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">deployment</span><span class="mr-2 badge badge-info">downtime</span><span class="mr-2 badge badge-warning">schema</span><span class="mr-2 badge badge-primary">strategy</span></p><div class="entry-content"><p><a href="https://softwareengineering.stackexchange.com/questions/202541/achieving-zero-downtime-deployment">Achieving Zero Downtime Deployment</a> touched on the same issue but I need some advice on a strategy that I am considering.</p><h3>Context</h3><p>A web-based application with Apache/PHP for server-side processing and MySQL DB/filesystem for persistence.</p><p>We are currently building the infrastructure. All networking hardware will have redundancy and all main network cables will be used in bonded pairs for fault-tolerance. Servers are being configured as high-availability pairs for hardware fault-tolerance and will be load-balanced for both virtual-machine fault-tolerance and general performance.</p><p>It is my intent that we are able to apply updates to the application without any down-time. I have taken great pains when designing the infrastructure to ensure that I can provide 100% up-time; it would be extremely disappointing to then have 10-15 minutes downtime every time an update was applied. This is particularly significant as we intend to have a very rapid release cycle (sometimes it may reach one or more releases per day.</p><h3>Network Topology</h3><p>This is a summary of the network:</p><pre><code>                      Load Balancer
             |----------------------------|
              /       /         \       \  
             /       /           \       \ 
 | Web Server |  DB Server | Web Server |  DB Server |
 |-------------------------|-------------------------|
 |   Host-1   |   Host-2   |   Host-1   |   Host-2   |
 |-------------------------|-------------------------|
            Node A        \ /        Node B
              |            /            |
              |           / \           |
   |---------------------|   |---------------------|
           Switch 1                  Switch 2
    
   And onward to VRRP enabled routers and the internet
</code></pre><p>Note: DB servers use master-master replication</p><h3>Suggested Strategy</h3><p>To achieve this, I am currently thinking of breaking the DB schema upgrade scripts into two parts. The upgrade would look like this:</p><ol><li>Web-Server on node A is taken off-line; traffic continues to be processed by web-server on node B.</li><li>Transitional Schema changes are applied to DB servers</li><li>Web-Server A code-base is updated, caches are cleared, and any other upgrade actions are taken.</li><li>Web-Server A is brought online and web-server B is taken offline.</li><li>Web-server B code-base is updated, caches are cleared, and any other upgrade actions are taken.</li><li>Web-server B is brought online.</li><li>Final Schema changes are applied to DB</li></ol><p>&#39;Transitional Schema&#39; would be designed to establish a cross-version compatible DB. This would mostly make use of table views that simulate the old version schema whilst the table itself would be altered to the new schema. This allows the old version to interact with the DB as normal. The table names would include schema version numbers to ensure that there won&#39;t be any confusion about which table to write to.</p><p>&#39;Final Schema&#39; would remove the backwards compatibility and tidy the schema.</p><h3>Question</h3><p>In short, will this work?</p><p>more specifically:</p><ol><li><p>Will there be problems due to the potential for concurrent writes at the specific point of the transitional schema change? Is there a way to make sure that the group of queries that modify the table and create the backwards-compatible view are executed consecutively? i.e. with any other queries being held in buffer until the schema changes are completed, which will generally only be milliseconds.</p></li><li><p>Are there simpler methods that provide this degree of stability whilst also allowing updates without down-time? It is also preferred to avoid the &#39;evolutionary&#39; schema strategy as I do not wish to become locked into backwards schema compatibility.</p></li></ol></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>It sounds like what you are really looking for is not so much High Availability as you would need <a href="https://en.wikipedia.org/wiki/Continuous_availability" rel="noreferrer">Continuous Availability</a>.</p><p>Essentially your plan will work but you seem to have noticed that the major flaw in your setup is that database schema changes in a release could result in either downtime or failure of still available node to operate correctly.  Continuous Availability approach solves this by essentially creating a number of Production environments.</p><h2>Production One</h2><p>This environment is your current live version of the software being utilized by users.  It has its own web servers, application servers, and database servers and tablespace.  It operates independently of any other environment.  The Load Balancer which owns the domain resolution endpoint for these services is currently pointing to these web servers.</p><h2>Production Two</h2><p>This is basically release staging environment that is identical to Production One.  You can perform your release upgrades here and do your sanity tests before your go live event.  This also affords you to safely perform your database changes on this environment.  The Load Balancer does not point to this environment currently.</p><h2>Production DR</h2><p>This is another duplicate at a separate data center that is located in a different region of the world.  This allows you to fail over in the event of catastrophic event by doing a DNS switch at the Load Balancer.</p><h2>Go Live</h2><p>This event is essentially updating the DNS record to cycle to Production Two from Production One or vice-versa.  This takes a while to propagate throughout the DNS servers of the world so you leave both environments running for a while.  Some users MAY be working in existing sessions on the old version of your software.  Most users will be establishing new sessions on the upgraded version of your software.</p><h2>Data Migration</h2><p>The only drawback here is that not all data during that window is available to all users at that time.  There is clearly important user data in the previous version database that now needs to be migrated safely to the new database schema.  This can be accomplished with a well tested data export and migration script or batch job or similar ETL process.</p><h2>Conclusion</h2><p>Once you have fully completed your release event, Production Two is now your primary and you begin working on installing the next release to Production One for the next deployment cycle.</p><h2>Drawbacks</h2><p>This is a complex environment setup and it requires a large amount of system resources, often times two to three times the system resources to do successfully.  Operating this way can be expensive, especially if you have very large heavy use systems.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../database-achieving-zero-downtime-deployment/'>Database &#8211; Achieving Zero Downtime Deployment</a></li><li class="list-group-item"><a href='../how-to-deploy-c-application-to-be-used-in-branch-remote-offices/'>How to deploy C# application to be used in branch / remote office(s)</a></li><li class="list-group-item"><a href='../db-migration-and-azure-deployment-slots/'>DB migration and Azure deployment slots</a></li><li class="list-group-item"><a href='../support-multiple-versions-of-mobile-apps/'>Support Multiple versions of Mobile apps</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>