<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="https://free-tor-game.com/wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Php &#8211; What Layer does a Query Builder belong in &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.min.js?ver=11.2.0' id='highlight-js'></script>     <script>( function( w, d, s, l, i ) {
				w[l] = w[l] || [];
				w[l].push( {'gtm.start': new Date().getTime(), event: 'gtm.js'} );
				var f = d.getElementsByTagName( s )[0],
					j = d.createElement( s ), dl = l != 'dataLayer' ? '&l=' + l : '';
				j.async = true;
				j.src = 'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
				f.parentNode.insertBefore( j, f );
			} )( window, document, 'script', 'dataLayer', ' ' );</script>      <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1085986 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="https://free-tor-game.com/3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="https://free-tor-game.com/contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1085986" class="post-1085986 software type-software status-publish hentry category-software tag-design-patterns tag-object-oriented-design tag-php"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Php &#8211; What Layer does a Query Builder belong in</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">design-patterns</span><span class="mr-2 badge badge-info">object-oriented-design</span><span class="mr-2 badge badge-warning">PHP</span></p><div class="entry-content"><p>In my project I have specified 5 sublayers for my DBAL:</p><ol><li>Database Layer ( the database itself)</li><li>Database Connection Layer ( \PDO and a class that handles the database connections)</li><li>Database Request Layer( classes that actually query the database )</li><li>Database Model Layer ( All classes that represent 1 Database table each and a Factory class that gives easy access to all Model class)</li><li>Model Layer ( classes that combines several Database Model class t make them work together )</li></ol><p>Now I have set the restriction that each layer SHOULD only have access to classes of its own layer or classes directly below (Layer 4 MAY access Layer 4 and 3 but MUST NOT access Layer 5 and SHOULD NOT access layers 1 and 2).<br /> But when it comes to a Query Builder ( I&#39;ve decided to use <a href="https://github.com/nilportugues/php-sql-query-builder" rel="nofollow noreferrer">https://github.com/nilportugues/php-sql-query-builder</a> as it does not require a database connection) I wonder what layer this should be assigned to and where I should use it.</p><p>Clearly the resulting query should be passed to Layer 3, so the Query Builder should be either 3 or 4, but then in most cases I seem to more likely need to build a query in layer 5 when I want to create some Layer 4 objects.</p><p>Currently my code that uses the Query Builder looks like this (in Layer 5):</p><pre><code>$builder = $this-&gt;entityFactory-&gt;getDbRequest()-&gt;getQueryBuilder();
// build the $query
$entity = $this-&gt;entityFactory-&gt;makeEntityByQuery( Entityname::class, $query);
</code></pre><p>So currently I located the QueryBuilder in Layer 3 but that forces me access Layer 3 from Layer 5 which I&#39;d like to avoid. I could move it to layer 4 but then I&#39;d either have to make it a dependency for most Classes of the Model Layer or make it accessible directly from that EntityFactory. But then again the EntityFactory would have 2 responsibilities, which violates SRP.</p><p>In which layer do you or would you use the Query Builder?</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>It feels like Layer 3, the Database Request layer needs this. First, to be honest, the layering could use fixing. If you have &#34;layers&#34; and the question &#34;which layer does this go in?&#34; is not easily answered then you either don&#39;t have enough layers, or don&#39;t have the <em>right</em> layers.</p><p>What you have:</p><ol><li><p>Database layer</p></li><li><p>Database connection layer</p></li><li><p>Database Request Layer</p></li><li><p><strong>(this is your problem)</strong> Database Model Layer</p></li><li><p><strong>(and so is this)</strong> Model Layer</p></li></ol><p>Layer 3, the Database Request Layer is where your Query Builder belongs. Nothing outside of that layer should be doing ad hoc queries. Really, Layer 3 is more commonly referred to as the Data Access Layer (DAL) or Repository Layer. This is the layer that knows about the database. It should even know about the factories required to generated your entity objects.</p><p>Think of the DAL or Repository as a coordinating layer between two sub layers: The Database Request and Entity Factory layers.</p><p>What you really need:</p><pre><code>         +----------+
         | Database |
         +----------+
              /\
              ||
              ||
              \/
+----------------------------+    +---------------+    +----------------+    +--------+
| Database Request (Gateway) |    | Query Builder |    | Entity Factory |    | Entity |
+----------------------------+    +---------------+    +----------------+    +--------+
              /\                      /\                       /\                /\
              ||                      ||                       ||                ||
              ||                      ||                       ||                ||
              ||                      ||      ++===============++                ||
              ||                      ||      ||                                 ||
              ||                      ||      ||                                 ||
              ||                      \/      \/                                 ||
              ||                    +------------+                               ||
              ++==================&gt; | Repository | &lt;=============================++
                                    +------------+
                                          /\
                                          ||
                                          ||
                                          \/
                                 +------------------+
                                 | Your Application |
                                 +------------------+
</code></pre><p>Your entity classes should have absolutely no knowledge about persistence. It&#39;s the Repository/DAL that coordinates between multiple layers underneath - including your query builder.</p><p>Nothing outside the Repository/DAL should have <em>anything</em> to do with the query builder. This is a utility for making the construction of SQL queries easier. Instead, you can provide a Data Transfer Object (DTO) that will contain all the possible criteria values if you need to perform a search. The Repository/DAL should have a method that accepts this criteria DTO as an argument, and then uses the DTO to build a query using the Query Builder.</p><p>From that, something else has to translate the query builder object into a request to the database. You can create another class called a Query Executor which translates the Query Builder and creates a DB request, or just pass the query builder directly to the DB request object. Yeah you &#34;break the separation of layers&#34; but how much coupling have you <em>really</em> introduced? It&#39;s up to you.</p><p><strong>Once your application reaches the complexity where you have a question like this, you need to invest your time in learning and configuring a good Object Relational Mapper (ORM).</strong></p><hr/><blockquote><p>So I Inject those repository classes to my Application classes?</p></blockquote><p>Yes, but generally only your controllers and service classes will need access to repository objects.</p><blockquote><p>Are those repository classes manually created in the controller (or the DI-Container respectively)?</p></blockquote><p>A little be &#34;Yes&#34; and a little bit &#34;No&#34;.</p><p>If you use Dependency Injection then the DI container or a factory object that churns out controllers will instantiate the repository.</p><p>If you introduce interfaces for your repository, you can have both:</p><pre><code>interface IFooRepository
{
    public function find($id);
}

class FooRepository implements IFooRepository
{

}

class FoosController
{
    public function __construct(IFooRepository $repository = null) {
        if (!isset($repository)) {
            $repository = new FooRepository();
        }

        $this-&gt;repository = $repository;
    }
}
</code></pre><p>The constructor for the controller accepts an <code>IFooRepository</code> as an argument. If <code>null</code> it defaults to the <code>FooRepository</code> concrete implementation. Now, you can actually unit test your controllers by providing a mock or stub of the <code>IFooRepository</code> interface.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='https://free-tor-game.com/software/php-best-design-pattern-for-library-with-data-model/'>Php &#8211; Best design pattern for library with data model</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/php-the-point-behind-building-an-abstraction-layer-pdo-adapter-class-instead-of-using-native-pdo/'>Php &#8211;  the point behind building an abstraction layer PDO Adapter class instead of using native PDO</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/php-handle-named-constructors-with-factory-pattern/'>Php &#8211; Handle Named constructors with factory pattern</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/object-oriented-php-class-composition-how-to-implement-has-a-relationship-in-the-case-of-a-dal/'>Object-oriented &#8211; php class composition: how to implement “has a” relationship in the case of a DAL</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='http://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="https://free-tor-game.com/wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>