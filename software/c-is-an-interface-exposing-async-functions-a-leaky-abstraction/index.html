<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>C# &#8211; Is an interface exposing async functions a leaky abstraction &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1077886 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1077886" class="post-1077886 software type-software status-publish hentry category-software tag-api-design tag-c tag-dependency-injection tag-interfaces tag-object-oriented"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">C# &#8211; Is an interface exposing async functions a leaky abstraction</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">api-design</span><span class="mr-2 badge badge-info">c</span><span class="mr-2 badge badge-warning">dependency-injection</span><span class="mr-2 badge badge-primary">interfaces</span><span class="mr-2 badge badge-danger">object-oriented</span></p><div class="entry-content"><p>I&#39;m reading the book <a href="https://www.manning.com/books/dependency-injection-principles-practices-patterns" rel="noreferrer">Dependency Injection Principles, Practices, and Patterns</a> and I read about the concept of leaky abstraction which is well described in the book.</p><p>These days I&#39;m refactoring a C# code base using dependency injection so that async calls are used instead of blocking ones. Doing so I&#39;m considering some interfaces which represent abstractions in my code base and which needs to be redesigned so that async calls can be used.</p><p>As an example, consider the following interface representing a repository for application users:</p><pre><code>public interface IUserRepository 
{
  Task&lt;IEnumerable&lt;User&gt;&gt; GetAllAsync();
}
</code></pre><p>According to the book definition a <em>leaky abstraction</em> is an abstraction designed with a specific implementation in mind, so that some implementation details &#34;leak&#34; through the abstraction itself.</p><p>My question is the following: can we consider an interface designed with async in mind, such as IUserRepository, as an example of a Leaky Abstraction ?</p><p>Of course not all possible implementation have something to do with asynchrony: only the out of process implementations (such as a SQL implementation) do, but an in memory repository does not require asynchrony (actually implementing an in memory version of the interface is probably more difficult if the interface exposes async methods, for instance you probably have to return something like Task.CompletedTask or Task.FromResult(users) in the method implementations).</p><p>What do you think about that ?</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>One can, of course, invoke the <a href="https://www.joelonsoftware.com/2002/11/11/the-law-of-leaky-abstractions" rel="noreferrer">law of leaky abstractions</a>, but that&#39;s not particularly interesting because it posits that all abstractions are leaky. One can argue for and against that conjecture, but it doesn&#39;t help if we don&#39;t share an understanding of what we mean by <em>abstraction</em>, and what we mean by <em>leaky</em>. Therefore, I&#39;ll first try to delineate how I view each of these terms:</p><h1>Abstractions</h1><p>My favourite definition of <em>abstractions</em> is derived from Robert C. Martin&#39;s <a href="http://amzn.to/19W4JHk" rel="noreferrer">APPP</a>:</p><blockquote><p>&#34;An abstraction is the amplification of the essential and the elimination of the irrelevant.&#34;</p></blockquote><p>Thus, <a href="http://blog.ploeh.dk/2010/12/02/Interfacesarenotabstractions" rel="noreferrer">interfaces aren&#39;t, in themselves, abstractions</a>. They&#39;re only abstractions if they bring to the surface what matters, and hides the rest.</p><h1>Leaky</h1><p>The book <em>Dependency Injection Principles, Patterns, and Practices</em> defines the term <em>leaky abstraction</em> in the context of Dependency Injection (DI). Polymorphism and the SOLID principles play a big role in this context.</p><p>From the <a href="https://en.wikipedia.org/wiki/Dependency_inversion_principle" rel="noreferrer">Dependency Inversion Principle</a> (DIP) it follows follows, again quoting APPP, that:</p><blockquote><p>&#34;clients [...] own the abstract interfaces&#34;</p></blockquote><p>What this means is that clients (calling code) define the abstractions that they require, and then you go and implement that abstraction.</p><p>A <em>leaky abstraction</em>, in my view, is an abstraction that violates the DIP by somehow including some functionality that the client doesn&#39;t <em>need</em>.</p><h1>Synchronous dependencies</h1><p>A client that implements a piece of business logic will typically use DI to decouple itself from certain implementation details, such as, commonly, databases.</p><p>Consider a domain object that handles a request for a restaurant reservation:</p><pre><code>public class MaîtreD : IMaîtreD
{
    public MaîtreD(int capacity, IReservationsRepository repository)
    {
        Capacity = capacity;
        Repository = repository;
    }

    public int Capacity { get; }
    public IReservationsRepository Repository { get; }

    public int? TryAccept(Reservation reservation)
    {
        var reservations = Repository.ReadReservations(reservation.Date);
        int reservedSeats = reservations.Sum(r =&gt; r.Quantity);

        if (Capacity &lt; reservedSeats + reservation.Quantity)
            return null;

        reservation.IsAccepted = true;
        return Repository.Create(reservation);
    }
}
</code></pre><p>Here, the <code>IReservationsRepository</code> dependency is determined <em>exclusively</em> by the client, the <code>MaîtreD</code> class:</p><pre><code>public interface IReservationsRepository
{
    Reservation[] ReadReservations(DateTimeOffset date);
    int Create(Reservation reservation);
}
</code></pre><p>This interface is entirely synchronous since the <code>MaîtreD</code> class doesn&#39;t <em>need</em> it to be asynchronous.</p><h1>Asynchronous dependencies</h1><p>You can easily change the interface to be asynchronous:</p><pre><code>public interface IReservationsRepository
{
    Task&lt;Reservation[]&gt; ReadReservations(DateTimeOffset date);
    Task&lt;int&gt; Create(Reservation reservation);
}
</code></pre><p>The <code>MaîtreD</code> class, however, doesn&#39;t <em>need</em> those methods to be asynchronous, so now the DIP is violated. I consider this a leaky abstraction, because an implementation detail forces the client to change. The <code>TryAccept</code> method now also has to become asynchronous:</p><pre><code>public async Task&lt;int?&gt; TryAccept(Reservation reservation)
{
    var reservations =
        await Repository.ReadReservations(reservation.Date);
    int reservedSeats = reservations.Sum(r =&gt; r.Quantity);

    if (Capacity &lt; reservedSeats + reservation.Quantity)
        return null;

    reservation.IsAccepted = true;
    return await Repository.Create(reservation);
}
</code></pre><p>There&#39;s no inherent rationale for the domain logic to be asynchronous, but in order to support the asynchrony of the implementation, this is now required.</p><h1>Better options</h1><p>At NDC Sydney 2018 <a href="https://youtu.be/F9bznonKc64" rel="noreferrer">I gave a talk on this topic</a>. In it, I also outline an alternative that doesn&#39;t leak. I&#39;ll be giving this talk at several conferences in 2019 as well, but now rebranded with the new title of <em>Async injection</em>.</p><p>I plan to also publish a series of blog posts to accompany the talk. These articles are already written and sitting in my article queue, waiting to be published, so stay tuned.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../java-jee-mvc-controller-calls-the-interface-instead-of-the-interface-implementation/'>Java &#8211; JEE MVC, controller calls the interface instead of the interface implementation</a></li><li class="list-group-item"><a href='../how-many-injections-is-acceptable-in-one-class-when-using-dependency-injection/'>How many injections is acceptable in one class when using dependency injection</a></li><li class="list-group-item"><a href='../object-oriented-another-why-use-abstract-interface-question-but-im-a-solo-developer-why-use-it/'>Object-oriented &#8211; Another &#8220;Why use Abstract/Interface&#8221; question. But I&#8217;m a solo developer. Why use it</a></li><li class="list-group-item"><a href='../architecture-is-poor-mans-dependency-injection-a-good-way-to-introduce-testability-to-a-legacy-application/'>Architecture &#8211; Is Poor Man&#8217;s Dependency Injection a good way to introduce testability to a legacy application</a></li><li class="list-group-item"><a href='../c-generic-repository-pattern-ef-and-unit-of-work/'>C# &#8211; Generic repository pattern +EF and unit of work</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>