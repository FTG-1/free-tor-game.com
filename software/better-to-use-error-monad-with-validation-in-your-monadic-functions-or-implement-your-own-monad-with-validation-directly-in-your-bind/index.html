<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Better to use error monad with validation in your monadic functions, or implement your own monad with validation directly in your bind &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1085367 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1085367" class="post-1085367 software type-software status-publish hentry category-software tag-functional-programming tag-haskell tag-monad tag-validation"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Better to use error monad with validation in your monadic functions, or implement your own monad with validation directly in your bind</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">functional programming</span><span class="mr-2 badge badge-info">haskell</span><span class="mr-2 badge badge-warning">monad</span><span class="mr-2 badge badge-primary">validation</span></p><div class="entry-content"><p>I&#39;m wondering what&#39;s better design wise for usability/maintainability, and what&#39;s better as far as fitting with the community.</p><p>Given the data model:</p><pre><code>type Name = String

data Amount = Out | Some | Enough | Plenty deriving (Show, Eq)
data Container = Container Name deriving (Show, Eq)
data Category = Category Name deriving (Show, Eq)
data Store = Store Name [Category] deriving (Show, Eq)
data Item = Item Name Container Category Amount Store deriving Show
instance Eq (Item) where
  (==) i1 i2 = (getItemName i1) == (getItemName i2)

data User = User Name [Container] [Category] [Store] [Item] deriving Show
instance Eq (User) where
  (==) u1 u2 = (getName u1) == (getName u2)
</code></pre><p>I can implement monadic functions to transform the User for instance by adding items or stores etc, but I may end up with an invalid user so those monadic functions would need to validate the user they get and or create.</p><p>So, should I just:</p><ul><li>wrap it in an error monad and make the monadic functions execute the validation</li><li>wrap it in an error monad and make the consumer bind a monadic validation function in the sequence that throws the appropriate error response (so they can choose not to validate and carry around an invalid user object)</li><li>actually build it into a bind instance on User effectively creating my own kind of error monad that executes validation with every bind automatically</li></ul><p>I can see positives and negatives to each of the 3 approaches but want to know what is more commonly done for this scenario by the community.</p><p>So in code terms something like, option 1:</p><pre><code>addStore s (User n1 c1 c2 s1 i1) = validate $ User n1 c1 c2 (s:s1) i1
updateUsersTable $ someUser &gt;&gt;= addStore $ Store &#34;yay&#34; [&#34;category that doesnt exist, invalid argh&#34;]
</code></pre><p>option 2:</p><pre><code>addStore s (User n1 c1 c2 s1 i1) = Right $ User n1 c1 c2 (s:s1) i1
updateUsersTable $ Right someUser &gt;&gt;= addStore $ Store &#34;yay&#34; [&#34;category that doesnt exist, invalid argh&#34;] &gt;&gt;= validate
-- in this choice, the validation could be pushed off to last possible moment (like inside updateUsersTable before db gets updated)
</code></pre><p>option 3:</p><pre><code>data ValidUser u = ValidUser u | InvalidUser u
instance Monad ValidUser where
    (&gt;&gt;=) (ValidUser u) f = case return u of (ValidUser x) -&gt; return f x; (InvalidUser y) -&gt; return y
    (&gt;&gt;=) (InvalidUser u) f = InvalidUser u
    return u = validate u

addStore (Store s, User u, ValidUser vu) =&gt; s -&gt; u -&gt; vu
addStore s (User n1 c1 c2 s1 i1) = return $ User n1 c1 c2 (s:s1) i1
updateUsersTable $ someValidUser &gt;&gt;= addStore $ Store &#34;yay&#34; [&#34;category that doesnt exist, invalid argh&#34;]
</code></pre></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>Fist I&#39;d ask myself: Is having an invalid <code>User</code> a code bug or a situation that can normally occur (for example someone entering a wrong input to your application). If it&#39;s a bug, I&#39;d try to ensure that it can never happen (like using <a href="http://www.haskell.org/haskellwiki/Smart_constructors" rel="nofollow noreferrer">smart constructors</a> or creating more sophisticated types).</p><p>If it&#39;s a valid scenario then some error processing during runtime is appropriate. Then I&#39;d ask: What does it really mean for me that a <code>User</code> is <em>invalid</em>?</p><ol><li>Does it mean that an invalid <code>User</code> can make some code fail? Do parts of your code rely on the fact that a <code>User</code> is always valid?</li><li>Or does it just mean that its an inconsistency that needs to be fixed later, but doesn&#39;t break anything during the computation?</li></ol><p>If it is 1., I&#39;d definitely go for some kind of error monad (either standard or your own), otherwise you&#39;ll lose guarantees that your code is functioning properly.</p><p>Creating your own monad or using a stack of monad transformers is another issue, maybe this will be helpful: <a href="https://stackoverflow.com/q/2759968/1333025">Has anyone ever encountered a Monad Transformer in the wild?</a>.</p><hr/><p><strong>Update:</strong> Looking at your expanded options:</p><ol><li><p>Looks as the best way to go. Perhaps, to be really safe, I&#39;d rather hide the constructor of <code>User</code> and instead export only a few functions that don&#39;t allow to create an invalid instance.  This way you&#39;ll be sure that any time it happens it gets handled properly. For example, a generic function for creating a <code>User</code> could be something like</p><pre><code>user :: ... -&gt; Either YourErrorType User
-- more generic:
user :: (MonadError YourErrorType m) ... -&gt; m User
-- Or if you actually don&#39;t need to differentiate errors:
user :: ... -&gt; Maybe User
-- or more generic:
user :: (MonadPlus m) ... -&gt; m User
-- etc.
</code></pre><p>Many libraries take a similar appropach, for example <code>Map</code>, <code>Set</code> or <code>Seq</code> hide the underlying implementation so that it&#39;s not possible to create a structure that doesn&#39;t obey their invariants.</p></li><li><p>If you postpone validation to the very end, and use <code>Right ...</code> everywhere, you don&#39;t need a monad any more. You can just do pure computations and resolve any possible errors at the end. IMHO this approach is very risky, as an invalid user value can lead to having invalid data elsewhere, because you didn&#39;t stop the computation soon enough. And, if it happens that some other method updates the user so that it&#39;s valid again, you&#39;ll end up with having invalid data somewhere and not even knowing about it.</p></li><li><p>There are several problems here.</p><ul><li>The most important is that a monad must accept any type parameter, not just <code>User</code>. So your <code>validate</code> would have to have type <code>u -&gt; ValidUser u</code> without any restriction on <code>u</code>. So it&#39;s not possible to write such a monad that validates inputs of <code>return</code>, because <code>return</code> must be fully polymorhpic.</li><li><p>Next, what I don&#39;t understand is that you match on <code>case return u of</code> in the definition of <code>&gt;&gt;=</code>. The main point of <code>ValidUser</code> should be to distinguish valid and invalid values, and so the monad must ensure that this is always true. So it could be simply</p><pre><code>(&gt;&gt;=) (ValidUser u) f = f u
(&gt;&gt;=) (InvalidUser u) f = InvalidUser u
</code></pre></li></ul><p>And this already looks very much like <code>Either</code>.</p></li></ol><p>Generally, I&#39;d use a custom monad only if</p><ul><li>There are no existing monads that provide you with the functionality you need. Existing monads usually have many support functions, and more importantly, they have monad transformers so you can compose them into monad stacks.</li><li>Or if you need a monad that is too complex to describe as a monad stack.</li></ul></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../if-the-model-is-validating-the-data-shouldnt-it-throw-exceptions-on-bad-input/'>If the model is validating the data, shouldn&#8217;t it throw exceptions on bad input</a></li><li class="list-group-item"><a href='../architecture-validation-and-data-persistence-in-a-domain-model/'>Architecture &#8211; Validation and data persistence in a domain model</a></li><li class="list-group-item"><a href='../c-how-to-avoid-double-data-validation-in-an-application-with-web-interface/'>C# &#8211; How to avoid double data validation in an application with web interface</a></li><li class="list-group-item"><a href='../c-overall-view-validation-with-a-datagrid-and-keeping-to-mvvm/'>C# &#8211; Overall view validation with a datagrid and keeping to MVVM</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>