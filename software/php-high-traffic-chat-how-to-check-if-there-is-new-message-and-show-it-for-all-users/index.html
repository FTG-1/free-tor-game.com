<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Php &#8211; High traffic chat &#8211; how to check if there is new message and show it for all users &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1073984 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1073984" class="post-1073984 software type-software status-publish hentry category-software tag-chat tag-jquery tag-mysql tag-php tag-websites"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Php &#8211; High traffic chat &#8211; how to check if there is new message and show it for all users</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">chat</span><span class="mr-2 badge badge-info">jquery</span><span class="mr-2 badge badge-warning">MySQL</span><span class="mr-2 badge badge-primary">PHP</span><span class="mr-2 badge badge-danger">websites</span></p><div class="entry-content"><p>I already had question about this but obviously it was not accepted very well, apparently too long when it&#39;s actually more information so you could have given me better answer.</p><p>Ok, I will be much clearer now. Best possible logic to develop scalable chat in terms of stability, storing/reading messages on chat, updating chat on new message for all users etc.? I have most of this developed, the logic I think I miss is &#8211;&gt; check if there is new message and show it for all users. I have this implemented but it crashes the site due to its traffic of 300k-400k people, so that&#39;s my main question.</p><p>The chat is PHP based and uses Pusher (www.pusher.com) for instant messaging but it lacks what I need because it&#39;s more like a websocket.</p><hr/><p>I&#39;m using hardcoded files to keep messages (want to avoid database as much as possible). It&#39;s a no extension type of file, I&#39;m sure you know. I&#39;m getting crash with</p><pre><code>$fp = fopen(..., &#34;w&#34;); // pretend ... is the path and filename
fwrite($fp, $msg); //hardcode the message
fclose($fp);
</code></pre><p>where <code>$msg</code> is the message itself. I&#39;m having 1 file per message. I show last 150 messages = 150 file accesses and reads, yeah it&#39;s too much I guess. I have better logic now which I&#39;m pursuing and that is 1 file with last 50-100 messages at all time. Sure it should be much better.</p><p>How does it crash, that&#39;s the trickiest part because everything seems ordinary, believe me it is difficult to determine what exactly crashes the site, but in like 5 minutes when I try to open the site it&#39;s gone, then I put the old content without chat and is back online again.</p><p>I&#39;m having jquery post every 1 second to check if there is new message. I&#39;m using timestamp in a special file where I keep the time last message was sent and <code>if ((time() - time in file) &lt;= 2)</code> = reload last 150 messages including the last one. Too much input/output, write/read or however to say it I think is what crashes the site.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>First of all, could you provide me with some clarification: are you coding a chat room (one-to-many) or individual (one-to-one) chats?</p><p>There are a couple of obvious flaws in your current system&#39;s design that I would like to point out.  First, I&#39;ll start out with a brief analysis and then explain what is wrong with it and what you can do to fix it.  Obviously if you want to run a successful project you should start from step one and get your hands dirty with systems analysis and design.</p><h2>Problem</h2><p><em>Website receives a high volume of traffic and eventually crashes.</em></p><h2>Requirements</h2><ol><li>Sustain high volume of web traffic</li><li>Display previous 150 messages</li><li>Secure communication pathway between clients</li></ol><h2>Problem Analysis</h2><p>Right away it is obvious that your site is crashing because the code that opens the file is being called <em>hundreds of thousands of times per second</em>.  Opening files and writing to them <strong>is very memory intensive</strong>.</p><p><strong>The FILE Probem:</strong> Files do not handle concurrency very well at all.  In fact, they&#39;re terrible with concurrency.  Think about it like this, essentially you&#39;ve opened the same file with notepad with <strong>hundreds of thousands of open windows/processes <em>and you&#39;re changing the content in all of them simultaneously</em></strong>.  When you try to solve a problem with <em>this type of solution</em> you end up with <strong>non-deterministic results</strong>.  Basically, it is impossible to predict what data will be in the file.</p><p>Fortunately, there is a way to get <strong>deterministic results</strong> <em>while still using files if you lock them properly</em>.  Unfortunately, this is not a solution to <em>your problem</em>.  In <em>your case</em>, only one person would be able to send a message at a time.  Surely that is <strong>NOT</strong> the solution you want!</p><h1>Wait... there <em>IS</em> a solution:</h1><h1>You <em>CAN USE</em> a Database!</h1><p><strong>Databases are <em>particularly good</em> at solving this sort of concurrency issue!</strong> Depending on what database/engine you use your table may lock or only a single record might lock.  In you case, I would suggest a free database like <strong>MySQL</strong> and a <em>record-locking engine</em> like <strong>InnoDB</strong>.  If you&#39;re not a database rookie, you might want to look into <strong>MariaDB</strong> as well, it is a fork of the MySQL project by the original developer and is a binary drop in.</p><p>Basically, there is no way around it using a database for this type of solution.  In fact, databases are very powerful and you can program procedures with them.  From your query you can choose to select only 150 messages and then order them by most recent very easily.  All users will be able to send messages at the same time with a record-locking database engine like <strong>InnoDB</strong>.</p><p>I would like to additionally point out that I would be a little troubled to find out what the code for the rest of the application looks like.  It is very easy to write PHP code that looks fine but performs terribly.  I&#39;m not sure if you&#39;re familiar with <strong>asymptotic analysis</strong> or <strong>unit testing</strong> but I highly suggest that you thoroughly <em>test your code before pushing it to production</em>.  Given the size of your userbase you should be concerned about code optimization and runtime.  If your application/problem/solution was properly analyzed, designed, implemented, tested, and debugged you would have a much better handle on your problem.</p><p>It is also very easy to write code in PHP that is insecure.  I would like to advise you to test your code thoroughly (try to break it) when writing modules that interact with the database.  Poorly coded web applications can be very easy to exploit and given your user base of 300-400k I wouldn&#39;t doubt it if Cindy Lou Who suddenly decided to give it her own security audit.  If a white hat hacker discovers the flaw in your system they will likely encourage you to fix it.  If a black hat hacker discovers the flaw they will likely use it to spread malware and steal information.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../php-is-it-recommended-to-use-docblock-even-if-im-not-using-phpdocumentor/'>Php &#8211; Is it recommended to use DocBlock even if I&#8217;m not using phpDocumentor</a></li><li class="list-group-item"><a href='../object-oriented-whats-a-good-simple-way-to-combat-the-n1-problem/'>Object-oriented &#8211; What&#8217;s a good simple way to combat the n+1 problem</a></li><li class="list-group-item"><a href='../design-system-design-scalable-chat-server/'>Design &#8211; System Design: Scalable Chat Server</a></li><li class="list-group-item"><a href='../build-a-realtime-chat-app-which-stores-messages-in-a-mysql-database/'>Build a realtime chat app which stores messages in a MySQL database</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>