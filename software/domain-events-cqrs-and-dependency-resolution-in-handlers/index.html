<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Domain Events, CQRS, and dependency resolution in handlers &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1083293 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1083293" class="post-1083293 software type-software status-publish hentry category-software tag-aggregate tag-asp-net-core tag-cqrs tag-domain-driven-design tag-event-handling"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Domain Events, CQRS, and dependency resolution in handlers</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">aggregate</span><span class="mr-2 badge badge-info">asp.net-core</span><span class="mr-2 badge badge-warning">cqrs</span><span class="mr-2 badge badge-primary">domain-driven-design</span><span class="mr-2 badge badge-danger">event handling</span></p><div class="entry-content"><p>Currently: ASP.NET Core 2.2.</p><p>I&#39;ve been doing quite an extensive research in this topic (Domain Driven Design used together with Clean Architecture):</p><p><a href="https://softwareengineering.stackexchange.com/questions/325996/ddd-where-to-place-domain-event-handlers">DDD: Where to place domain event handlers?</a></p><p>And I&#39;ve seen a couple of DDD and Clean Architecture Repos to better understand:</p><ul><li><a href="https://github.com/VaughnVernon/IDDD_Samples_NET" rel="nofollow noreferrer">https://github.com/VaughnVernon/IDDD_Samples_NET</a></li><li><a href="https://github.com/ivanpaulovich/clean-architecture-manga" rel="nofollow noreferrer">https://github.com/ivanpaulovich/clean-architecture-manga</a></li><li><a href="https://github.com/fals/cqrs-clean-eventual-consistency" rel="nofollow noreferrer">https://github.com/fals/cqrs-clean-eventual-consistency</a></li></ul><p>Some other topics:</p><ul><li><a href="https://softwareengineering.stackexchange.com/questions/368401/should-domain-services-raise-events">Should Domain Services Raise Events?</a></li><li><a href="https://softwareengineering.stackexchange.com/questions/253194/managing-non-domain-application-behaviour-in-cqrs">Managing non-domain application behaviour in CQRS</a></li><li><a href="https://docs.microsoft.com/en-us/dotnet/standard/microservices-architecture/microservice-ddd-cqrs-patterns/domain-events-design-implementation" rel="nofollow noreferrer">https://docs.microsoft.com/en-us/dotnet/standard/microservices-architecture/microservice-ddd-cqrs-patterns/domain-events-design-implementation</a></li></ul><p>(plus many other resources)</p><p>And I&#39;ve even been skimming through Vaughn Vernon&#39;s book..</p><p>I&#39;m trying to keep things as simple as possible. But there is something I&#39;m not understanding&#8230; If the Aggregates themselves are the ones supposed to raise the domain events, <strong>how are we supposed to resolve the dependencies that the event handler need in order to execute successfully?</strong></p><p>Let me explain (This is my complete understanding are you are more than welcome to correct me):</p><p>Aggregates are the ones in charge of raising the event. You would have an Event Bus that will subscribe and publish the Events and Handlers accordingly. So far so good. The problem starts when you&#39;re going to resolve the handler&#39;s dependencies.</p><p>From what I&#39;m understanding, Aggregates should have zero external dependencies (That should be the Application&#39;s Layer responsibility), therefore you&#39;re forced to use a static method that raises the event inside the Aggregate. Once raised, you dispatch them to the respective handler. But what happens if the handler itself has dependencies such as a Repository/Service/Processor that needs to be instantiated?</p><p>Wouldn&#39;t I have to create some sort of factory that creates these dependencies? That means that I wouldn&#39;t be able to use the IoC library to make the dependencies for me, right?</p><p>I thought on using <a href="https://github.com/jbogard/MediatR" rel="nofollow noreferrer">MediatR</a> to handle same-tier, same-domain dispatches because it wires into my Dependency Resolver and automatically injects all the dependencies. For this to be achieved, MediatR would need to be injected in the Aggregate, breaking the principle of having no external dependencies.</p><p>From one of the GitHub links above, the <a href="https://github.com/fals/cqrs-clean-eventual-consistency" rel="nofollow noreferrer">Ametista</a> project has the events raised in the Application Layer (Command Stack), and not inside the Aggregates.</p><p>While that would violate the Aggregate principle, it would&#39;ve solved the dependency issue. Yet, it would introduce another problem, which is domain events duplication. You would&#39;ve to reimplement the same event each time the criteria is met for that event to be raised.</p><p>That just put me to think&#8230; deep, and made me come up with the following (untested) solution (Which I don&#39;t have high hopes that it&#39;s going to work):</p><p>We implement the Service Locator pattern to wrap up MediatR in a Static Class. We would inject via a static method and property the Startup.cs Service Provider. I don&#39;t know if the shared static property across the entire application is a good idea. I also don&#39;t know if the Service Provider would get disposed or inaccessible in a certain part of the app. I also don&#39;t know if I&#39;m creating a consistent MediatR instance that will be able to publish all the events transaction-wise from the bounded context (That is, all the events that were raised in the domain would work as a same transaction within the same bounded context).</p><p>In Startup.cs:</p><pre><code>// This method gets called by the runtime. Use this method to configure the HTTP request pipeline.
public void Configure(IApplicationBuilder app, IHostingEnvironment env, ILoggerFactory loggerFactory)
{

     StaticMediatR.LoadServiceProvider(app.ApplicationServices);
}


    public class StaticMediatR
    {
        private static IServiceProvider _serviceProvider;

        public static void LoadServiceProvider(IServiceProvider serviceProvider)
        {
            _serviceProvider = serviceProvider;
        }

        public static IMediator Mediator()
        {
            var serviceScope = _serviceProvider.GetRequiredService&lt;IServiceScopeFactory&gt;().CreateScope();

                return serviceScope.ServiceProvider.GetRequiredService&lt;IMediator&gt;();

        }

    }
</code></pre><p>I haven&#39;t tried the code above yet&#8230; That&#39;s what I have in mind.</p><p><strong>Edit</strong>: I just tried the code above&#8230; and effectively, it&#39;s been disposed.</p><p><strong>Edit x2</strong>: Wait, removing the Using does not dispose the object. I&#39;ve made the changes above.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>Using a static class vs injecting some sort of &#34;event bus&#34; into either an Aggregate&#39;s constructor or into one of it&#39;s methods is a matter of preference, and each has its trade-offs.</p><p>While injecting the eventing infrastructure does yield <em>slightly</em> more flexibility, it also means splattering this concern all over your domain. Is <code>EventBus</code> <em>really</em> something a domain expert talks about? Not usually. Furthermore, in my experience, I have never once found myself wanting for the flexibility pure injection gives. The event paradigm is rather simple and tends to remain constant (for good reason).</p><p>On the other hand while a static class may &#34;hide&#34; a dependency (although it should be common knowledge your domain objects will need to raise events), it offers a one-line solution to raising events without mucking up method/constructor signatures. In practice, I find it&#39;s worth this trade-off.</p><p>All that said, your question seems to be more about dependency injection than anything else. How an event is raised is a different concern than how it is handled. You are correct that your event handlers will have dependencies, and that wiring them up is a pain. Using a DI container is a pretty standard solution here, and can save you quite a bit of headache.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../ddd-domain-events-vs-application-events/'>DDD &#8211; Domain events vs application events</a></li><li class="list-group-item"><a href='../confused-about-commands-domain-events-and-external-events-in-event-sourcing/'>Confused about commands, domain events and external events in event sourcing</a></li><li class="list-group-item"><a href='../reducing-the-code-duplication-between-read-and-write-application-in-cqrs/'>Reducing the code duplication between read and write application in CQRS</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>