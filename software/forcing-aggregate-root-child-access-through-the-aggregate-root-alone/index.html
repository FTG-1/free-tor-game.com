<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Forcing aggregate root child access through the aggregate root alone &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1074742 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1074742" class="post-1074742 software type-software status-publish hentry category-software tag-design-patterns tag-domain-driven-design"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Forcing aggregate root child access through the aggregate root alone</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">design-patterns</span><span class="mr-2 badge badge-info">domain-driven-design</span></p><div class="entry-content"><p><strong>Context</strong></p><p>I&#39;m developing an application using a Domain Driven Design approach. I want to use a design pattern wherever appropriate and apply all <a href="http://en.wikipedia.org/wiki/SOLID_(object-oriented_design)" rel="nofollow">SOLID</a> principles.</p><p><strong>Scenario</strong></p><p>I have an order and I want to allow clients to add order lines to it.</p><p>Consider the following pseudo code:</p><pre><code>class Order
    OrderLines[] (readonly)
    AddOrderLine(orderLine)

class OrderLine
    Product
    Amount

class OrderLineFactory
    OrderLine Create(product, amount)

class OrderLineRepository
    Save(orderLine)
</code></pre><p>Now lets add an OrderLine to the Order:</p><pre><code>Order.AddOrderLine(OrderLineFactory.Create(product: &#34;Chocolate Cake&#34;, amount: 3))
</code></pre><p>By the way, the OrderLineFactory is there because in my case, there is some relatively complex logic involved with creating order lines. This is one of the main reasons for applying the factory pattern.</p><p><strong>Problem</strong></p><p>The problem is that I could do this instead&#8230;</p><pre><code>orderLine = OrderLineFactory.Create(product: &#34;Chocolate Cake&#34;, amount: 3)
OrderLineRepository.Save(orderLine)
</code></pre><p>&#8230;and get around the <code>Order.AddOrderLine</code> method, effectively short-cutting any checks that are performed in that method (e.g. protecting against duplicates or limiting the order amount).</p><p><strong>Working towards a solution</strong></p><p>An argument could be that there shouldn&#39;t be a <code>Save</code> method on <code>OrderLineRepository</code>, because an OrderLine isn&#39;t an aggregate root. This would (just like I want) render the client incapable of storing the bare OrderLine except from adding it to the Order and saving the Order consequently.</p><p>However, having a <code>Save</code> method on repositories that concern non-root aggregates, allows for saving changes made to them directly, such as:</p><pre><code>orderLine = orderLineRepository.Get(31923)
orderLine.Amount = 5
OrderLineRepository.Save(orderLine)
</code></pre><p>Not being able to save the OrderLine would require me to do something like&#8230;</p><pre><code>order = OrderRepository.FindByOrderLineId(31923)
order.OrderLines[31923].Amount = 5
OrderRepository.Save(order)
</code></pre><p>&#8230;which isn&#39;t all that efficient or practical. I could add a requirement to provide the (actually redundant) Order ID as well but that would put some unnecessary burden on the client.</p><p>So lets say I want to stick with my <code>OrderLineRepository.Save</code> method and still find a way to stop my client from being able to get around my <code>Order.AddOrderLine</code> method.</p><p>All I can think of now, is dropping the OrderLineFactory and creating a domain service that combines the creation and the assignment.</p><pre><code>class OrderService
    AddOrderLine(order, product, amount)
</code></pre><p>So we can:</p><pre><code>order = orderRepository.Get(123)
OrderService.AddOrderLine(order: order, product: &#34;Chocolate Cake&#34;, amount: 3))
orderRepository.Save(order)
</code></pre><p>I don&#39;t really like the service combining multiple concerns here though, those of creation and assignment. That would call for&#8230; a factory&#8230; again.</p><p>Okay, let&#39;s consider a private factory then, one that&#39;s not available to the client but to the domain service alone. In my case I would get stuck with unit testing and Inversion Of Control. I&#39;d be creating an uninjectable dependency, since my client wouldn&#39;t be able to register my non-public factory.</p><p><strong>Summary</strong></p><ul><li>I want my client to be able to create order lines through the Order class and in no other way</li><li>I don&#39;t want to mangle multiple concerns in a single class</li><li>I want to keep OrderLine creation outside of the Order class</li><li>I&#39;d like to keep using a factory for that</li></ul><p>So I&#39;m a little stuck here, trying to find the best way to deal with this. Any suggestions?</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>I feel like you were really close, but just missed it</p><pre><code>order = orderRepository.Get(123)
OrderService.AddOrderLine(order: order, product: &#34;Chocolate Cake&#34;, amount: 3))
orderRepository.Save(order)
</code></pre><p>What you were looking for is more like this:</p><pre><code>order = orderRepository.Get(123)
order.AddOrderLine(orderService: orderService, product: &#34;Chocolate Cake&#34;, amount: 3))
orderRepository.Save(order)
</code></pre><p>Domain services support queries within the domain model - they don&#39;t write changes to the model; the aggregates change and protect the domain state.  So as a rule, you want to pass the domain service to the aggregate, then let the aggregate pass current state to the service, as needed.  For instance</p><pre><code>// Order.AddOrderLine()
orderLine = orderService.createOrderLine(this.id, product, amount);
this.lines.add(orderLine);
</code></pre><p>Note the (implied) separation of responsibilities</p><ul><li>The domain service creates an instance of the orderLine, using only the context provided to it.  But there&#39;s no persistence here, it&#39;s just transient data in memory at this point.</li><li>The aggregate then evaluates the orderLine to determine whether or not it satisfies the invariant.  If it does, the orderLine will become part of the graph of entities reachable via the aggregate root.</li></ul><blockquote><p>However, having a Save method on repositories that concern non-root aggregates, allows for saving changes made to them directly</p></blockquote><p>That&#39;s not a good thing?</p><pre><code>orderLine = orderLineRepository.Get(31923)
orderLine.Amount = 5
OrderLineRepository.Save(orderLine)
</code></pre><p>But if this orderLine is part of an order aggregate, then presumably the Order is expected to check that the state of the order is consistent.  It can&#39;t do that if you insist on being able to mutate the subordinate entities directly.</p><p>Part of the point to aggregates is that all changes to the domain model must go through paths that force the model to remain consistent.  Are all of the OrderLine methods going to walk back up the graph to the Order to ensure that the invariant is still satisfied?</p><p>Of course, this might actually be a hint that the aggregate boundaries are in the wrong place.  If you should be able to modify OrderLine without the entire Order, then perhaps OrderLines are aggregate roots, and not merely subordinate entities.  Your domain experts might tell you that discrepancies between the Order and OrderLines aren&#39;t actually particularly expensive; ensuring that they are rare (rather than eliminating them entirely) may suffice.  Horses for courses.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../how-to-create-new-aggregate-root-in-cqrs/'>How to create new aggregate root in CQRS</a></li><li class="list-group-item"><a href='../how-to-query-a-child-object-within-an-aggregate-root-on-demand/'>How to query a child object within an aggregate root on demand</a></li><li class="list-group-item"><a href='../find-the-ddd-aggregate-root/'>Find the DDD Aggregate Root</a></li><li class="list-group-item"><a href='../ddd-is-an-aggregate-root-responsible-for-deleting-its-child-entities-from-their-repository/'>DDD: Is an aggregate root responsible for deleting its child entities from their repository</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>