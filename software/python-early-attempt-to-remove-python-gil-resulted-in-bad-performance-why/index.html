<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Python &#8211; Early attempt to remove Python GIL resulted in bad performance: Why &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1086855 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1086855" class="post-1086855 software type-software status-publish hentry category-software tag-python"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Python &#8211; Early attempt to remove Python GIL resulted in bad performance: Why</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">python</span></p><div class="entry-content"><p><a href="http://www.artima.com/weblogs/viewpost.jsp?thread=214235"><strong>This post</strong></a> from Python creator, Guido Van Rossum, mentions an early attempt to remove the GIL from Python:</p><blockquote><p>This has been tried before, with disappointing results, which is why<br /> I&#39;m reluctant to put much effort into it myself. In 1999 Greg Stein<br /> (with Mark Hammond?) produced a fork of Python (1.5 I believe) that<br /> removed the GIL, replacing it with fine-grained locks on all mutable<br /> data structures. He also submitted patches that removed many of the<br /> reliances on global mutable data structures, which I accepted.<br /> However, after benchmarking, it was shown that even on the platform<br /> with the fastest locking primitive (Windows at the time) it slowed<br /> down single-threaded execution nearly two-fold, meaning that on two<br /> CPUs, you could get just a little more work done without the GIL than<br /> on a single CPU with the GIL. This wasn&#39;t enough, and Greg&#39;s patch<br /> disappeared into oblivion. (See Greg&#39;s writeup on the performance.)</p></blockquote><p>I can hardly argue with the actual results, but I really wonder why this happened.  Presumably, the main reason that removing the GIL from CPython is so difficult is because of the reference counting memory management system.  A typical Python program will call <a href="https://docs.python.org/2/c-api/refcounting.html"><strong><code>Py_INCREF</code></strong></a> and <a href="https://docs.python.org/2/c-api/refcounting.html"><strong><code>Py_DECREF</code></strong></a> thousands or millions of times, making it a key contention point if we were to wrap locks around it.</p><p>But, I don&#39;t understand why adding atomic primitives would slow down a <em>single</em> threaded program.  Suppose we just modified CPython so that the refcount variable in each Python object was an atomic primitive.  And then we just do an atomic increment (fetch-and-add instruction) when we need to increment the reference count.  This would make Python reference counting thread-safe, and shouldn&#39;t have any performance penalty on a single-threaded application, because there would be no lock contention.</p><p>But alas, many people who are smarter than me have tried and failed, so obviously I&#39;m missing something here.  What is wrong with the way I&#39;m looking at this problem?</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>I am unfamiliar with the Greg Stein Python fork, so discount this comparison as speculative historical analogy if you wish. But this was exactly the historical experience of <em>many</em> infrastructure codebases moving from single- to multi-threaded implementations.</p><p>Essentially every Unix implementation I studied in the 1990s--AIX, DEC OSF/1, DG/UX, DYNIX, HP-UX, IRIX, Solaris, SVR4, and SVR4 MP--all went through exactly this kind of &#34;we put in finer-grained locking--now it&#39;s slower!!&#34; problem. The DBMSs I followed--DB2, Ingres, Informix, Oracle, and Sybase--they all went through it too.</p><p>I have heard &#34;these changes won&#39;t slow us down when we&#39;re running single-threaded&#34; a million times. It never works out that way. The simple act of conditionally checking &#34;are we running multithreaded, or not?&#34; adds real overhead, especially on highly-pipelined CPUs. Atomic operations and occasional spin-locks added to ensure the integrity of shared data structures have to be called quite often, and they&#39;re very slow. First-generation lock/synchronization primitives also were slow. Most implementation teams eventually add several classes of primitives, in various &#34;strengths,&#34; depending on how much interlock protection was needed at various places. Then they realize where they initially slapped down locking primitives was not really the right place, so they had to profile, design around the bottlenecks found, and systematically roto-till. Some of these sticking points eventually got OS or hardware acceleration, but that whole evolution took 3-5 years, bare minimum. Meanwhile, the MP or MT versions were limping, performance-wise.</p><p>Otherwise-sophisticated development teams have argued that such slowdowns are basically a persistent, intractable fact of life. IBM e.g. refused to SMP-enable AIX for at least 5 years after the competition, adamant that single-threaded was just purely better. Sybase used some of the same arguments. The only reason some of the teams eventually came around was that single-thread performance could no longer be reasonably improved at a CPU level. They were forced to either go MP/MT or accept having an increasingly uncompetitive product.</p><p>Active concurrency is HARD. And it&#39;s deceptive. Everyone rushes into it thinking &#34;this won&#39;t be so bad.&#34; Then they hit the quicksand, and have to plod through. I&#39;ve seen this happen with at least a dozen name-brand, well-funded, smart teams. Generally it seemed to take at least five years after choosing to multi-thread to &#34;get back to where they should be, performance-wise&#34; with MP/MT products; most were still meaningfully improving MP/MT efficiency/scalability even ten years after making the shift.</p><p>So my speculation is that, absent GvR&#39;s endorsement and support, no one has taken on the long trudge for Python and its GIL. Even if they were to do so today, it&#39;d be Python 4.x timeframe before you&#39;d say &#34;Wow! We&#39;re really over the MT hump!&#34;</p><p>Perhaps there is some magic that separates Python and its runtime from all the other stateful infrastructure software--all the language runtimes, operating systems, transaction monitors, and database managers that have gone before. But if so, it&#39;s unique or nearly so. Everyone else removing a GIL-equivalent has taken five-plus years of hard, committed effort and investment to get from MT-not to MT-hot.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../python-erlang-or-x-is-it-worth-it-vs-python-w-gil/'>Python &#8211; Erlang or &#8216;x&#8217;.. Is it worth it (vs. Python w/ GIL)</a></li><li class="list-group-item"><a href='../python-why-is-python-used-for-high-performance-scientific-computing-but-ruby-isnt/'>Python &#8211; Why is Python used for high-performance/scientific computing (but Ruby isn&#8217;t)</a></li><li class="list-group-item"><a href='../python-mutable-default-argument-why/'>Python mutable default argument: Why</a></li><li class="list-group-item"><a href='../python-why-was-python-written-with-the-gil/'>Python &#8211; Why Was Python Written with the GIL</a></li><li class="list-group-item"><a href='../python-does-dynamically-generating-classes-in-python-affect-readability-performance/'>Python &#8211; Does dynamically generating classes in python affect readability/performance</a></li><li class="list-group-item"><a href='../python-callback-function-with-arguments-bad-practice/'>Python callback function with arguments bad practice</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>