<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="https://free-tor-game.com/wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Python &#8211; How are queues made thread-safe in Python &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.min.js?ver=11.2.0' id='highlight-js'></script>     <script>( function( w, d, s, l, i ) {
				w[l] = w[l] || [];
				w[l].push( {'gtm.start': new Date().getTime(), event: 'gtm.js'} );
				var f = d.getElementsByTagName( s )[0],
					j = d.createElement( s ), dl = l != 'dataLayer' ? '&l=' + l : '';
				j.async = true;
				j.src = 'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
				f.parentNode.insertBefore( j, f );
			} )( window, document, 'script', 'dataLayer', ' ' );</script>      <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1069604 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="https://free-tor-game.com/3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="https://free-tor-game.com/contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1069604" class="post-1069604 software type-software status-publish hentry category-software tag-algorithms tag-multithreading tag-python"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Python &#8211; How are queues made thread-safe in Python</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">algorithms</span><span class="mr-2 badge badge-info">multithreading</span><span class="mr-2 badge badge-warning">python</span></p><div class="entry-content"><p><strike>I admit this was asked to me in interview a long time ago, but I never bothered to check it.</strike></p><p>The question was simple, how does Python make <code>Queue</code> thread-safe?</p><p>My answer was, because of Interpreter Lock (GIL), any time only 1 thread is making a call to get the element from queue while others are sleeping/waiting. I was/am still not sure if it a valid answer.</p><p><strike>The interviewer seemed dissatisfied and asked</strike> if <code>Queue</code>s are thread-safe in Java or .Net implementation of Python which doesn&#39;t have GIL? If so, how do they implement thread-safe feature on said data structure.</p><p>I tried looking for it, but I always seem to stumble upon <code>how to use thread-safe queues</code>.</p><p>So how is <code>Queue</code> or a simple <code>list</code> can be made thread-safe and avoid race conditions?</p><p>Alternatively, what algorithms or techniques used by <code>GEvent</code> implementation of thread-safe <code>Queue</code>s?</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>You are mistaken that the GIL would make a Python program threadsafe. It only makes the interpreter itself threadsafe.</p><p>For example, let&#39;s look at a super simple LIFO queue (aka. a Stack). We&#39;ll ignore that a <code>list</code> can already be used as a stack.</p><pre class="lang-py prettyprint-override"><code>class Stack(object):
  def __init__(self, capacity):
    self.size = 0
    self.storage = [None] * capacity

  def push(self, value):
    self.storage[self.size] = value
    self.size += 1

  def pop(self):
    self.size -= 1
    result = self.storage[self.size]
    self.storage[self.size] = None
    return result
</code></pre><p>Is this threadsafe? Absolutely not, despite running under the GIL.</p><p>Consider this sequence of events:</p><ul><li><p>Thread 1 adds a couple of values</p><pre class="lang-py prettyprint-override"><code>stack = Stack(5)
stack.push(1)
stack.push(2)
stack.push(3)
</code></pre><p>The state is now <code>storage=[1, 2, 3, None, None]</code>, <code>size=3</code>.</p></li><li><p>Thread 1 adds a value <code>stack.push(4)</code> and is suspended before the size can be incremented</p><pre class="lang-py prettyprint-override"><code>self.storage[self.size] = value
# interrupted here
self.size += 1
</code></pre><p>The state is now <code>storage=[1, 2, 3, 4, None]</code>, <code>size=3</code>.</p></li><li><p>Thread 2 removes a value <code>stack.pop()</code> which is <code>3</code>.</p><p>The state is now <code>storage=[1, 2, None, 4, None]</code>, <code>size=2</code>.</p></li><li><p>Thread 1 is resumed</p><pre class="lang-py prettyprint-override"><code>self.storage[self.size] = value
# resume here
self.size += 1
</code></pre><p>The state is now <code>storage=[1, 2, None, 4, None]</code>, <code>size=3</code>.</p></li></ul><p>As a result, the stack is corrupted: the pushed value can&#39;t be retrieved, and the top element is empty.</p><p>The GIL only linearises data accesses, but this is almost completely useless to the ordinary Python developer because the order of operations is still unpredictable. I.e. the GIL cannot be used as a Python-level lock, it just guarantees that the values of all variables are up to date (<code>volatile</code> in C or Java). Python implementations without a GIL must also provide this property for compatibility, e.g. by using <code>volatile</code> memory accesses or using their own locks. <a href="http://www.jython.org/jythonbook/en/1.0/Concurrency.html" rel="noreferrer">Jython is a GIL-less implementation</a> that specifically uses threadsafe implementations for <code>dict</code>, <code>list</code>, and so on.</p><p>Because Python does not guarantee any order of operations between threads, it comes as no surprise that thread-safe data structures must use a lock. For example, the standard library <a href="https://github.com/python/cpython/blob/v3.6.4/Lib/queue.py" rel="noreferrer"><code>queue.Queue</code> class @v3.6.4</a> has a <code>mutex</code> member, and a few condvars using that mutex. All data accesses are properly guarded. But note that this class isn&#39;t primarily intended a queue data structure, but as a job queue between multiple threads. A pure data structure would not usually be concerned with locking.</p><p>Of course, locks and mutexes stink for various reasons, e.g. because of the possibility of deadlocks, and because acquiring a lock is slow. As a consequence, there&#39;s lots of interest in <a href="https://en.wikipedia.org/wiki/Lock-free_data_structures" rel="noreferrer"><em>lock-free data structures</em></a>. When the hardware provides certain atomic instructions, it is possible to update a data structure with such an atomic operation, e.g. by replacing a pointer. But this tends to be rather difficult to do.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='https://free-tor-game.com/software/is-a-1-writeread-thread-system-safe/'>Is a 1:* write:read thread system safe</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/thread-safe-gui-programming/'>Thread safe GUI programming</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/java-how-to-make-a-universal-construction-more-efficient/'>Java &#8211; How to make a universal construction more efficient</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/implementing-a-hash-table-with-true-concurrency/'>Implementing a hash table with true concurrency</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='http://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="https://free-tor-game.com/wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>