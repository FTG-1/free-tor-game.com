<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>C# &#8211; Passing State or Context Across Layers in Web API &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1071659 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1071659" class="post-1071659 software type-software status-publish hentry category-software tag-c tag-dependency-injection tag-web-api"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">C# &#8211; Passing State or Context Across Layers in Web API</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">c</span><span class="mr-2 badge badge-info">dependency-injection</span><span class="mr-2 badge badge-warning">web-api</span></p><div class="entry-content"><p>I am running into an interesting scenario that I just haven&#39;t been able to get answers on. I would like to see if there are elegant solutions for this. Here are some use cases:</p><ol><li><p>I want to pass the identity/user principal of the user that called an API Action in a Controller to Services and Repository layers. There are important decisions that get taken at Service layer depending on the User&#39;s claims and/or privileges/permissions.</p></li><li><p>I want to identify a tenant (occurs using HTTP Headers or Hostnames) but pass this Tenant information to Services and Repository layers so that different Redis Caches and Databases can be used depending on the Tenant.</p></li></ol><p>I can easily build a method in a base service called WithTenant(object tenant); which I can use to pass tenants.</p><p>This means every service call I make will need this WithTenant called.</p><p>For e.g. a call:</p><pre><code> _inventoryService.CheckInventory() 
</code></pre><p>will now change to:</p><pre><code>_inventoryService.WithTenant(tenant).CheckInventory();
</code></pre><p>Likewise, if I want to pass the HttpRequest in addition to the Tenant, I will have to do this:</p><p>_inventoryService.WithHttpRequest(Request).WithTenant(tenant).CheckInventory();</p><p>This gets even more complex as I need to pass this to the Repository layer. My Mongo DB Context is a singleton. I might need to change this to accept the tenant so the connection string can be changed based on the tenant.</p><p>So I was thinking:</p><ol><li>Isn&#39;t there a way by which I can pass a Context object across these layers? Maybe build a Context class and set properties like Request, or Tenant or anything else I need and then pass it across layers?</li><li>More importantly, is there a way to dynamically inject this into the Constructors of these services so I don&#39;t need to manually wire it up again? I know that I can store my context in the Request object or maybe even an Owin Context. Could I somehow inject that? If so I haven&#39;t seen any good examples of this across multiple layers.</li></ol><p>I guess I&#39;m simply trying to simplify the ability to pass state between layers. Cross cutting functions like Caching, Logging, Database Access change on a per Tenant basis so if I could create a central context, that would greatly simplify things.</p><p>Any thoughts? Would love to see what others are doing to solve such problems.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>to everyone that may want to know how this was solved, it turned out to be an easy fix with a little bit of understanding of Dependency Injection Lifetimes as well as clean Architecture strategies.. The following was the logic I applied:</p><ol><li><p>Identify the Tenant - Look up the Tenant based on the available strategies (i.e. either a Tenant Id in a Claim, or a Host Header, or the originating request).</p></li><li><p>Get the Tenant&#39;s Profile - Once the Tenant was identified, his profile information was obtained. This included Tenant&#39;s Data center information and various other parameters (queues, caching cluster etc)</p></li><li><p>Build a Tenant Context (instantiate singletons for Redis, Mongo and maintain a Connection string for SQL Databases). Keep this Tenant Context in a Memory Cache so future retrieval is easy.</p></li><li><p>Built a Per Resolve Tenant Context resolution using Unity (or a similar DI tool). Per Resolve ensures that the Tenant Context resolution only occurs once during a request and the same instance can be used across the board. This was important because the same Tenant Context was needed at Attribute Filter level, Application and Domain Services and sometimes all the way up to the Repository layer. All these would have the same context instead of building a new one for each class up/down the food-chain.</p></li><li><p>Use the context at each layer to get a connection factory to connect to Mongo, Redis, SQL or Queues.</p></li></ol><p>Once I had the factory, a global replace allowed me to use it across the board (got lucky because I was already using a cleaner architecture).</p><p>If anyone is really interested in peeking into the code/details, here is a link that might help: <a href="http://www.hypertrends.com/2017/10/saaskit-dependency-injection-tenants/" rel="nofollow noreferrer">http://www.hypertrends.com/2017/10/saaskit-dependency-injection-tenants/</a></p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../database-to-repository-or-not-to-repository/'>Database &#8211; To Repository Or Not To Repository</a></li><li class="list-group-item"><a href='../c-confused-on-how-to-properly-employ-a-repository-pattern-with-service-business-layer-on-top/'>C# &#8211; Confused on how to properly employ a Repository Pattern with Service/Business Layer on top</a></li><li class="list-group-item"><a href='../c-repository-pattern-exposing-data-context-to-underlying-layers/'>C# &#8211; Repository Pattern: Exposing Data Context to Underlying Layers</a></li><li class="list-group-item"><a href='../c-dependency-injection-for-a-library-with-internal-dependencies/'>C# &#8211; Dependency injection for a library with internal dependencies</a></li><li class="list-group-item"><a href='../c-dependency-inject-dbcontext-into-mvc-controller/'>C# &#8211; Dependency Inject DbContext into MVC Controller</a></li><li class="list-group-item"><a href='../c-entity-framework-extending-or-injecting-services-into-db-context/'>C# &#8211; Entity Framework &#8211; extending OR injecting services into DB Context</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>