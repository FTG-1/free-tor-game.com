<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>SQL &#8211; Algorithm for finding availability of a resource &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1070365 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1070365" class="post-1070365 software type-software status-publish hentry category-software tag-algorithms tag-scheduling tag-sql"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">SQL &#8211; Algorithm for finding availability of a resource</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">algorithms</span><span class="mr-2 badge badge-info">scheduling</span><span class="mr-2 badge badge-warning">sql</span></p><div class="entry-content"><p>I&#39;m having trouble creating a mysql compatible algorithm for this.</p><h2>Background</h2><p>App with mysql, perl and JS. It&#39;s a booking system where each <code>booking</code> is comprised of a <code>start</code>, <code>end</code> and <code>qty</code>.  Start and end are timestamps.</p><p>Schema simplified to a single table:</p><pre class="lang-none prettyprint-override"><code>|  bookings        
|-------------------
| id    | pkey      
| start | timestamp 
| end   | timestamp 
| qty   | int       
</code></pre><h2>Question</h2><p>In SQL, how do you check how many resources are booked at once for a given <code>timeRange</code>? Code with explanation or an algorithm that is SQL compatible both work.</p><p>So, for the following schedule:</p><pre class="lang-none prettyprint-override"><code>09:00 -----               &lt;-|
09:30 |   |                 | A maximum of 12 are booked at once during this range
10:00 |x7 |                 | 
10:30 ----- ----- -----     |
11:00       |   | |   |     |                       
11:30       |x2 | |x10|   &lt;-|
12:00       |   | |   |
12:30       ----- -----
</code></pre><p>I should get 12 since the x2 and x10 bookings don&#39;t overlap with the x7 booking, so there are never more than 12 items booked at once between <code>9:00</code> and <code>11:30</code>.</p><h2>Progress</h2><pre class="lang-sql prettyprint-override"><code>--It&#39;s been heavily shrunk to show just the relevant part, so it might have some errors
SELECT coalesce(max(qtyOverlap.sum),0) booked
FROM (
    SELECT coalesce(sum(b2.qty),0) sum
        FROM booking b1
        LEFT JOIN (
            SELECT b.qty, b.tStart, b.tEnd FROM booking b
        ) b2
        ON b1.tStart &lt; b2.tEnd AND
           b1.tEnd &gt; b2.tStart AND
           b2.tStart &lt; &#39;2015-02-19 16:30:00&#39; AND
           b2.tEnd &gt; &#39;2015-02-19 06:00:00&#39;
        WHERE 
              b1.tStart &lt; &#39;2015-02-19 16:30:00&#39; AND
              b1.tEnd &gt; &#39;2015-02-19 06:00:00&#39;
        GROUP BY b1.id
) qtyOverlap
GROUP BY qtyOverlap.itemId
</code></pre><p>Which is this algorithm:</p><pre class="lang-none prettyprint-override"><code>Max of
    For each booking that overlaps given timeRange
        return sum of
            each booking that overlaps this booking and given timeRange
</code></pre><p>In the schedule above this would be:</p><pre><code>max([7],[2+10],[10+2]) = 12
</code></pre><p>But given a schedule like:</p><pre class="lang-none prettyprint-override"><code>09:00 -----               &lt;-|
09:30 |   |                 | A maximum of 17 are booked at once during this range, not 19
10:00 |x7 |                 | 
10:30 |   |       -----     |
11:00 -----       |   |     |                       
11:30       ----- |x10|   &lt;-|
12:00       |x2 | |   |
12:30       ----- -----
</code></pre><p>This gives:</p><pre><code>max([7+10],[2+10],[10+7+2]) = 19
</code></pre><p>Which is wrong.</p><p>The only way I can think of to fix this is to use recursion (which isn&#39;t mysql compatible afaik).</p><p>It would look something like (in working JS code)</p><pre><code>function getOverlaps(bookings,range) {
    return bookings.filter(function(booking){
        return isOverLapping(booking,range);
    });
}
function isOverLapping(a, b) {
    return (a.start &lt; b.end &amp;&amp; a.end &gt; b.start);
}
function maxSum(booking, overlaps) { // main recursive function
    var currentMax = 0;
    var filteredOverlaps = getOverlaps(overlaps,booking);
    for (var i = 0; i &lt; filteredOverlaps.length; i++) {
        currentMax = Math.max(
            maxSum(filteredOverlaps[i], removeElement(filteredOverlaps,i)),
            currentMax
        );
    }
    return currentMax + booking.qty;
}
function removeElement(array,i){
    var clone = array.slice(0)
    clone.splice(i,1);
    return clone;
}
var maxBooked = maxSum(timeRange, getOverlaps(bookings,timeRange));
</code></pre><p><a href="http://jsfiddle.net/slicedtoad/8o09ebgq/1/" rel="nofollow">Visual JSFiddle demo</a></p><p>Any way to do this in SQL? (any reasonable way, that is)</p><p><strong>Update</strong><br /> I just tried to use a stored procedure recursion emulation method as documented <a href="http://guilhembichot.blogspot.ca/2013/11/with-recursive-and-mysql.html" rel="nofollow">here</a>. But part way through implementing it, I tried it with the demo data and decided the <strike>performance was far too terrible.</strike> Actually, it just needed indexing. Now it&#39;s just &#39;kinda&#39; bad.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>This is tricky, because you&#39;ve modeled your bookings as time intervals with granularity as fine as your DB allows. Perfectly natural to do, but as you&#39;ve found out it makes some comparisons difficult.</p><pre class="lang-none prettyprint-override"><code>Max of
    For each booking that overlaps given timeRange
        return sum of
            each booking that overlaps this booking and given timeRange
</code></pre><p>The problem with this algorithm is that it checks that each other booking interval matches the one currently being examined (the foreach iteration), but it doesn&#39;t check overlapping bookings against each other, to see if they line up. A run through of your second example goes like this:</p><ul><li>Select 7x booking<ul><li>7x does not overlap with 2x; +0</li><li>7x overlaps with 10x; +10</li><li>Total 17</li></ul></li><li>Select 2x booking<ul><li>2x does not overlap with 7x; +0</li><li>2x overlaps with 10x; +10</li><li>Total 12</li></ul></li><li>Select 10x booking<ul><li>10x overlaps with 7x; +7</li><li>10x overlaps with 2x; +2</li><li>[Missing step: check if 7x and 2x overlap]</li><li>Total 19</li></ul></li><li>Max 19</li></ul><p>Is it reasonably possible to map your data to nice, neat discrete chunks of some size? For example, do your bookings generally begin and end on the 15s (12:00, 12:15, 12:30, 12:45)? If so, you can change your algorithm to compare bookings against a static time interval, rather than each other, and drastically reduce the required number of comparisons:</p><pre class="lang-none prettyprint-override"><code>Max of
  For each 15 minute chunk in timeRange
    Sum quantities of all bookings overlapping this chunk
</code></pre><p>In terms of SQL implementation, choose an interval size and use a numbers or tally table to generate an inline query to create the chunks:</p><pre><code>select @startTime + interval (15 * numbers.value) minute as start
, @startTime + interval (15 * (numbers.value + 1)) minute as end
from numbers
where (@startTime + interval (15 * numbers.value) minute) &lt; @endTime
</code></pre><p>(Off the cuff, may contain minor syntax or math errors)</p><p>This is a relatively sane way of performing this query in SQL without recursion. It has the obvious drawback that it will never perfectly align with your current schema, but do you <em>really</em> need absolute perfection?</p><p>I&#39;ve used 15 minutes as an example size. You can easily make this as finely grained as you like: 5 minutes, 1 minute, 1 second, etc. There <em>must</em> be some point at which the granularity is too fine, because MySQL&#39;s timestamp type does not possess arbitrary precision. &#34;Booking&#34; to me implies something involving humans actually showing up. If this is true, I can&#39;t imagine that an interval size smaller than one minute would be appropriate.</p><p>In the comments you expressed some concern about performance because of a large number of comparisons. Complexity for this algorithm is O(n*m), where n is the number of chunks (time range / interval size) and m is the number of booking rows within the given time range. I&#39;ll hazard that in practice, n &gt;&gt; m, meaning that what really matters to the computation time is the number of intervals. This should be a non-issue, as long as you use sane timeframes and your DB is indexed and maintained correctly. For example, using an interval size of one second for the time range in your question (9:00 - 11:30) is only 9000 intervals to inspect. 9000 rows is paltry to an SQL server. I trust this to be performant a lot more than I do using dynamic SQL to emulate recursion.</p><p>If the interval size is 50 million times smaller than the time range, then yes, this will take a significant amount of time to run (notice I didn&#39;t say perform poorly), because you&#39;ll be running a query against 50 million rows. But is querying the maximum bookings for <em>every millisecond in a twelve hour span</em> (43.2 million ms) reasonable and necessary? There are only 604800 seconds in a week. Performing a query on a set that size, while not trivial, shouldn&#39;t give an SQL server any difficulty.</p><p>What does your data look like? How fine of an inspection period do you need? If there&#39;s a two minute (or second, decasecond, millisecond...) interval where there are 105 bookings instead of 100 because someone entered an &#34;unusual&#34; end time, will that destroy the integrity of your report, or can that data be discarded as noise? I can&#39;t answer these questions, but some simple data and requirements analysis on your part can.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../unit-testing-of-inherently-random-non-deterministic-algorithms/'>Unit-testing of inherently random/non-deterministic algorithms</a></li><li class="list-group-item"><a href='../algorithm-for-finding-overlapping-times/'>Algorithm for finding overlapping times</a></li><li class="list-group-item"><a href='../faster-algorithm-for-finding-all-subsets/'>Faster algorithm for finding all subsets</a></li><li class="list-group-item"><a href='../guidance-on-excel-vba-resource-scheduling-algorithm/'>Guidance on Excel VBA resource scheduling algorithm</a></li><li class="list-group-item"><a href='../identify-algorithm-for-the-resource-allocation-needs/'>Identify algorithm for the resource allocation needs</a></li><li class="list-group-item"><a href='../database-an-algorithm-for-finding-subset-matching-criteria/'>Database &#8211; An algorithm for finding subset matching criteria</a></li><li class="list-group-item"><a href='../algorithm-to-determine-optimal-availability-for-scheduling-appointments-with-several-resources/'>Algorithm to determine optimal availability for scheduling appointments with several resources</a></li><li class="list-group-item"><a href='../sql-algorithm-for-most-overlapping-events/'>SQL algorithm for most overlapping events</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>