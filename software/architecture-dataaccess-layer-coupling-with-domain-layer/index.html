<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Architecture &#8211; DataAccess Layer coupling with Domain Layer &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1083511 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1083511" class="post-1083511 software type-software status-publish hentry category-software tag-architecture tag-domain-driven-design tag-domain-model tag-entity-framework tag-repository-pattern"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Architecture &#8211; DataAccess Layer coupling with Domain Layer</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">Architecture</span><span class="mr-2 badge badge-info">domain-driven-design</span><span class="mr-2 badge badge-warning">domain-model</span><span class="mr-2 badge badge-primary">entity-framework</span><span class="mr-2 badge badge-danger">repository-pattern</span></p><div class="entry-content"><p>We have an issue with how the implementation of the Data Access layer (<a href="https://docs.microsoft.com/en-us/ef/ef6/querying/related-data" rel="nofollow noreferrer">EF6 Includes</a> more specifically), influences the behavior of our Domain layer.</p><p>A theoretical example to illustrate:</p><p>Application in 3 layers, DDD:</p><ul><li><p><strong>Domain layer</strong>: simplistic domain model</p><ul><li>An <code>Order</code> has <code>Orderlines</code></li><li>An <code>Order</code> has a public property <code>&#34;CanBeExtended&#34;</code>. Business logic is<br /> <em>&#34;when there are less than 10 Orderlines, an order can be extended&#34;</em></li><li>Note: This implementation is unit testable, no dependencies</li></ul></li><li><p><strong>Data Access layer</strong>: this layer contains the <code>OrderRepository</code>, which uses EF6 to retrieve an <code>Order</code> object from the database.</p><ul><li><code>GetOrderById</code> is the only relevant method for this example</li><li>References the Domain layer.</li></ul></li><li><p><strong>Service layer</strong>: contains &#34;Controllers&#34; in MVC-speak, is accessed via the API</p><ul><li>References both Data Access and Domain layer</li><li>Exposes a method <code>&#34;CanOrderBeExtended&#34;</code>: input is the id of the order, returns a bool whether the order can be extended</li></ul></li></ul><p><strong>Implementation of this Service layer:</strong><br /> Retrieve the <code>Order</code> object from the repository using <code>GetOrderById</code>, then call its property <code>CanBeExtended</code>, and return that value.</p><p><strong>Problem:</strong><br /> Depending on the implementation of the Data Access layer, the Domain layer behaves wrong: <em>depending on whether you <code>Include</code> the <code>Orderlines</code> of the <code>Order</code> in <code>GetOrderById</code>, the <code>CanBeExtended</code> behaves differently.</em></p><p><strong>The Bug:</strong><br /> When you <em>forget</em> the <code>Include</code>, all <code>Orders</code> are extendable.</p><p><strong>Possible solutions:</strong></p><ol><li>Lazy loading is considered, but it&#39;s not our favorite.<br /> It&#39;s a technical detail of EF6, and it might turn out to be problematic in a late stage, and highly dependent on the actual setup: db server access speed,&#8230;</li></ol><p>We&#39;re looking for a more fundamental solution:<br /> How can we mitigate this dependency between the Domain and the Data Access layer?<br /> How can we make sure we don&#39;t forget <code>Includes</code>?</p><ol start="2"><li>Making multiple and specific methods on the repository is considered as well, but it doesn&#39;t appear to scale well:</li></ol><p>This example might then use something like <code>&#34;GetOrderWithOrderLinesById&#34;</code> which contains the <code>Include(o =&gt; o.OrderLines)</code>.<br /> But to decide which method is needed, we&#39;d have to review the implementation of <code>CanBeExtended</code> in the Domain layer.<br /> Additionally, when that implementation changes, the repository method needs to change as well (e.g. to add extra <code>Include</code> statements), or another, new method would turn out to be needed, thus highly coupling the Repository (in the Data Access layer) with the Domain layer.</p><p>Fowler nor Evans seem to touch this specific topic AFAIK.</p><p>Any and all thoughts welcome!</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><h2>First of all</h2><p>A relevant <a href="https://softwareengineering.stackexchange.com/questions/387135/should-entity-framework-6-not-be-used-with-repository-pattern/387178#387178">answer of mine</a> I think you should read.</p><p>Your question is based on your interpretation on the fundamentals of repositories with EF, and that interpretation is not complete (that&#39;s not to say mine is provably complete either). This leads to the issues you&#39;re uncovering.</p><p>However, it requires you to change your interpretation, rather than try to solve the issue the way you&#39;re trying to now. I strongly urge you to reconsider your architectural approach, because a more abstracted variant will make this problem a lot easier to tackle.</p><hr/><h2>Answering the actual question</h2><p>Never forget the responsibilities of each layer.</p><ul><li>The <strong>DAL</strong> stores and retrieves data for you.</li><li>The <strong>BLL</strong> performs operations and adheres (and forces other to adhere) to the required business rules, which may or may not involve speaking to the data store.</li><li>The <strong>Service</strong> layer (as per your naming) is the public interface which gives users access to the BLL operations.</li></ul><blockquote><p><strong>Problem</strong>: Depending on the implementation of the Data Access layer, the Domain layer behaves wrong: depending on whether you <code>Include</code> the <code>Orderlines</code> of the Order in <code>GetOrderById</code>, the <code>CanBeExtended</code> behaves differently.</p></blockquote><p><strong>TL;DR</strong> The DAL is a <strong>dependency</strong> of the BLL. The BLL cannot question the DAL&#39;s responses as the BLL&#39;s actions are based on the responses received from the DAL.</p><p>The core issue here is that you are making the BLL responsible for making a judgment call (can this order be extended?), but you are not giving the BLL the autonomy to <strong>verify the information</strong> it needs to make that judgment call.</p><p>The way you currently have it, the BLL&#39;s validator can be fooled by passed a bogus list of orderlines into it. The validation is supposed to work as a line of defence which prevents storage of data that violates business rules, and as you&#39;ve pointed out yourself this line of defence can be easily circumvented. The simple truth is that your line of defence is ineffective.</p><p>If the BLL is expected to be the judge on whether the order can be extended or not, the BLL must be able to check the database to count how many lines currently exist. Without it, the BLL cannot make this judgment call.</p><p>In other words, you expect something along the lines of:</p><pre><code>public bool CanOrderBeExtended(Order order)
{
    var existingOrderLineCount = unitOfWork
                                     .OrderLineRepository
                                     .GetByOrderId(order.Id)
                                     .Count();

    return existingOrderLineCount &lt; 10;
}
</code></pre><p>And there you have your answer. The BLL will not behave differently based on the data an external consumer passes to it. The BLL will protect the datastore by verifying the datastore itself.</p><p>Note that if the <code>Order</code> object is fetched by the BLL itself and the DAL method that was used to fetch the order already guarantees that all existing order lines are fetched as well (e.g. <code>GetOrderWithAllOfItsOrderLines</code>); then the validation does not need to access the database again, because the DAL itself has already guaranteed that the current list of orderlines is correct.</p><p>Something like this would also be correct:</p><pre><code>public OrderDto GetOrderById(int orderId)
{
    var order = unitOfWork
                    .OrderRepository
                    .GetOrderWithAllOfItsOrderLines(orderId);

    var result = new OrderDto()
                 {
                     Order = order
                     CanBeExtended = order.OrderLines.Count() &lt; 10;
                 };

    return result;
}
</code></pre><p>The BLL relies on the DAL to provide the actual contents of the datastore.</p><p><strong>But what if the datastore doesn&#39;t return all orderlines?</strong></p><p>If the datastore is not performing its job (e.g. it only returns one orderline even though there are 15 order lines in the database for this order), then <strong>the BLL cannot be expected to protect against that</strong>. That is an issue you have to detect (via testing) and solve in the DAL.</p><p>The DAL is a dependency of the BLL. The BLL depends on the DAL to be correct. If the DAL is not correct, the BLL cannot be expected to know better than what its own dependencies tell it.</p><hr/><h2>Your proposed solutions</h2><blockquote><ol><li>Lazy loading is considered, but it&#39;s not our favorite. It&#39;s a technical detail of EF6, and it might turn out to be problematic in a late stage, and highly dependent on the actual setup: db server access speed,...</li></ol></blockquote><p>If you lazy load from the BLL, that means you are leaking IQueryables. <strong>DO NOT DO THIS</strong>. Leaking IQueryables outside of the DAL means that you&#39;ve compromised the separation of your layers.</p><p>The issue you&#39;re highlighting (a second DB call) further compounds the problem but it is not the main decision point as to why you shouldn&#39;t be doing this. There are valid solutions which do use a second db call, which might not be what you need in this particular instance but are a better solution than lazy loading nonetheless.</p><blockquote><ol start="2"><li>Making multiple and specific methods on the repository is considered as well, but it doesn&#39;t appear to scale well</li></ol></blockquote><p>It scales as well as you can reasonably expect it to.</p><p>In this context, you stating it does &#34;not scaling well&#34; seems to imply that you are expecting a generic solution to load any related entity for any entity you&#39;re currently dealing with. That&#39;s not a reasonable expectation as it compromises the DAL&#39;s internal responsibility.</p><p>The DAL decides what data gets fetched from the database. The BLL does not decide that. At best, the BLL is allowed to communicate to the DAL using methods which the DAL <strong>expliticly</strong> exposes.<br/> Simply put, the DAL decides to allow consumer to ask it to retrieve the order lines (= the DAL exposes a public method), and then consumers (the BLL in this case) are able to use this public method to do the thing the DAL has allowed them to do (fetching the order lines).</p><p>Allowing the BLL to dynamically alter the fetched data without having an explicitly defined DAL method implies that you are either leaking your IQueryables (as mentioned before, <strong>do not do this</strong>), or your DAL has some specific publci method which you&#39;ve created for this purpose (which avoids IQueryable leakage).</p><p>The latter inherently means that you&#39;ve <em>custom built</em> a DAL method that the BLL calls, which according to you &#34;does not scale well&#34;. Therefore, by elimination, the only way in which you could have a method which &#34;scales well&#34; is by leaking the IQueryable, which you should not do.</p><p>In short, <strong>your expectation of how scalable something needs to be is leading you to compromise the separation of your layers</strong>. If you want to uphold the separation of your layers, the DAL needs to explicitly expose custom methods (i.e. written by the DAL developer, not just passed on from the EF library) which allow for the retrieval of related entities.</p><blockquote><p>But to decide which method is needed, we&#39;d have to review the implementation of CanBeExtended in the Domain layer.</p></blockquote><p>This is a vary confusing point your making.</p><p>I think you&#39;re putting the cart before the horse. The DAL doesn&#39;t include the order lines just because the BLL wants to validate the data. The DAL includes the order lines <strong>because it has either privately decided or is explicitly asked to include them</strong>.</p><p><em>Why</em> the DAL was asked to include them (by the BLL) is irrelevant as far as the DAL cares. Yes, the BLL may have asked the DAL for the order lines specifically to validate some business logic, but the DAL doesn&#39;t need to know that. All it needs to know is that it was asked to fetch the order lines from the datastore, and therefore it returns the order lines from the datastore.</p><p>That is the only responsibility of the DAL. It does not care about your business logic at all, because the DAL lives one layer deeper than the business logic.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../c-confused-on-how-to-properly-employ-a-repository-pattern-with-service-business-layer-on-top/'>C# &#8211; Confused on how to properly employ a Repository Pattern with Service/Business Layer on top</a></li><li class="list-group-item"><a href='../should-i-use-the-repository-in-the-domain-object-or-push-the-domain-object-back-to-the-service-layer/'>Should I use the repository in the Domain Object or push the Domain Object back to the Service Layer</a></li><li class="list-group-item"><a href='../is-domain-persistence-model-isolation-usually-this-awkward/'>Is domain/persistence model isolation usually this awkward</a></li><li class="list-group-item"><a href='../c-domain-driven-design-navigation-properties-and-aggregate/'>C# &#8211; Domain Driven Design // Navigation Properties and Aggregate</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>