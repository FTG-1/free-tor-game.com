<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>CQRS and microservices: passing information from one service to another &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1084944 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1084944" class="post-1084944 software type-software status-publish hentry category-software tag-cqrs tag-microservices tag-read-model"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">CQRS and microservices: passing information from one service to another</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">cqrs</span><span class="mr-2 badge badge-info">microservices</span><span class="mr-2 badge badge-warning">read-model</span></p><div class="entry-content"><p>We&#39;re building two microservices that use CQRS and Event Sourcing: an Order Service and an Inventory Service. When an order is made, the inventory of that item must be decreased by the amount ordered. An order can also be canceled. In that case, the inventory must be increased again.</p><p>So in the Order Service we store an <code>OrderCreated</code> event that contains the necessary details for the Inventory Service: a list of <code>Item</code> instances with their IDs and amounts. Sample code:</p><pre><code>public class OrderCreated
{
    public int OrderId { get;set; }
    public IList&lt;Item&gt; Items { get; set; }
}

public class Item
{
    public int Id { get; set; }
    public int Amount { get; set; }
}
</code></pre><p>This event is also sent to the Inventory Service (could be mapped to a shared contract), so the Inventory Service can decrease the stock for the items.</p><p>When an order is canceled, we store an <code>OrderCanceled</code> event. For the Order Service, this only needs to contain an <code>OrderId</code>, eg:</p><pre><code>public class OrderCanceled
{
    public int OrderId { get;set; }
}
</code></pre><p>But how do we now send the items to the Inventory Service?</p><h1>Option 1</h1><p>Add the items to the <code>OrderCanceled</code> event:</p><pre><code>public class OrderCanceled
{
    public int OrderId { get;set; }
    public IList&lt;Item&gt; Items { get; set; }
}
</code></pre><p>This seems strange to us, because when re-applying the event (ie hydrating), this serves no purpose.</p><h1>Option 2</h1><p>Create an Event Handler for the <code>OrderCanceled</code> event, that retrieves the aggregate and accesses items, eg (not-real-life-code):</p><pre><code>public class MyEventHandler : IEventHandler&lt;OrderCanceled&gt;
{
    public void Handle(OrderCanceled e)
    {
        var order = _repository.Get(e.OrderId);
        var message = new OrderCanceledMessage
        {
            OrderId = e.OrderId,
            Items = order.Items.Select(x =&gt; new ItemMessage(...))
        };

        _messageSender.Send(message);
    }
}
</code></pre><p>The weird thing here is that we&#39;re retrieving the <code>Order</code> instance, even though we already retrieved it in our command handler previously (i.e. when the user canceled the order, a command was sent to the system). So we retrieved our aggregate twice.</p><h1>Option 3</h1><p>The same as option 2, but instead of retrieving the <code>Order</code> in the Event Handler, we let the Event Handler call the read model to retrieve the items.</p><p>But in most articles I read, it is advised not to have the command side call the query side (though often with little argumentation).</p><h1>Option 4</h1><p>Send a message with only the <code>OrderId</code> but have the Inventory Service listen to all necessary messages of the Order Service and build its own read model of the orders.</p><p>This means we would actually have components create a read model for their own use, instead of read models for others. In the above example, the Inventory Service would build a model of the orders with its items.</p><p>The advantage seems here that you can build a read model purely for your own use. In a situation of microservices, we fear that a component might have to build too many different read models for all the different microservices.</p><p>A disadvantage could be that changes/additions of events in the Order Service would require changes in the read model generation of the Inventory Service.</p><h1>So what am I asking here?</h1><ul><li>How do I tackle the issue where an Event Handler needs more information?</li><li>Does a microservices architecture mean I will need lots of read models (aka endpoints) per client?</li></ul></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><blockquote><p>We&#39;re building two microservices that use CQRS and Event Sourcing: an Order Service and an Inventory Service. When an order is made, the inventory of that item must be decreased by the amount ordered. An order can also be canceled. In that case, the inventory must be increased again.</p></blockquote><p>You may be getting yourself tripped up because you are conflating manipulation of the order with reservation of the inventory.</p><p>Hint: creating an order doesn&#39;t deplete your stock; <em>shipping product</em> depletes stock.</p><p>Sometimes the patterns don&#39;t fit because they are trying to tell you that the model is broken.</p><blockquote><p>Send a message with only the OrderId but have the Inventory Service listen to all necessary messages of the Order Service and build its own read model of the orders.</p></blockquote><p>I want to call this out explicitly as a bad idea -- the inventory service should not be trying to build its own read model of orders; that couples the inventory service to the internals of the order model, and means that you can&#39;t easily change the order model without also re-deploying the inventory service.</p><p>But... it&#39;s perfectly reasonable for the inventory service to have its <em>own</em> model for &#34;reserved inventory&#34; that it builds up because of the messages that it receives from the order service.</p><p>In other words, during cancellation the inventory service doesn&#39;t care what the order items are, it just cares what stock was reserved for that order.  It can look in its own store for that....</p><blockquote><p>How do I tackle the issue where an Event Handler needs more information?</p></blockquote><p>One thing to keep in mind: by the time an event reaches an event handler, the event is <em>stale</em>.</p><p>If the Inventory Service receives an event, and needs additional information to act upon it, then it queries the authority for the information it needs.  So if the inventory service needs to know the state of the order because the Order was cancelled, then it sends a query to the order service asking for the information that it needs.</p><p>Note the separation - you establish an api contract that allows the inventory service to ask for what it needs, and a schema for the messages exchanged.  The two services can independently change in any way that respects that API.</p><p>So you might imagine an exchange where the inventory service gets a thin notification that an order was cancelled, and then queries the order service to get a fatter representation of the order at that time.</p><p>That query doesn&#39;t necessarily need to be <em>synchronous</em> -- the result of the query is just another input message to the inventory service.</p><blockquote><p>Does a microservices architecture mean I will need lots of read models (aka endpoints) per client?</p></blockquote><p>Write only databases aren&#39;t very interesting, so you are going to need endpoints that let you get the data back out.  If you are careful about your api designs, you won&#39;t <em>necessarily</em> need more read models than you would in a monolith.  But you will sometimes need to support more than one read model for a given capability, so that legacy and upgraded clients can both access the information that the need.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../cqrs-ddd-event-sourcing-can-the-readmodel-read-itself/'>CQRS / DDD + Event Sourcing. Can the ReadModel read itself</a></li><li class="list-group-item"><a href='../how-to-update-a-nosql-database-and-publish-event-atomically-in-an-event-driven-microservices-architecture/'>How to update a NoSQL database and publish event atomically in an event-driven microservices architecture</a></li><li class="list-group-item"><a href='../reducing-the-code-duplication-between-read-and-write-application-in-cqrs/'>Reducing the code duplication between read and write application in CQRS</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>