<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>MVVM in Photoshop-like application: What object has the responsibility for composing the document &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1086898 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1086898" class="post-1086898 software type-software status-publish hentry category-software tag-design-patterns"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">MVVM in Photoshop-like application: What object has the responsibility for composing the document</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">design-patterns</span></p><div class="entry-content"><p>I&#39;m wondering how an application like Adobe Photoshop, could be architectured to conform to the C+M+V+VM design-pattern, specifically how do you handle the canvas?</p><p>There would be a Model system which represents the current document, with its layers (each containing raw pixel data, potentially gigabytes worth), effects applied to layers, and other information about the document state.</p><p>Then you would have the ViewModel for the Main Window which would have child-ViewModels for each tool-window, as well as a child-ViewModel for the main canvas area. My question relates to how the ViewModel would represent the current canvas data. It is the View&#39;s responsibility to draw the pixels of the <em>composited</em> document to the screen (or some virtual output device for tests), but who has responsibility to compose the document? Is it correct to even compose the document <em>at all</em>? &#8211; especially if the View is particularly advanced enough to have the capability to do that itself, such as hardware-accelerated Views. What if composition is done at the ViewModel layer on the GPU, the data would have to be passed back into main-memory and then copied again to the GPU for the View &#8211; the optimization of keeping the data in GPU memory cannot happen because the View and ViewModel should be ignorant of each other.</p><p>Is there a solution to this problem, or would a different design-pattern be appropriate?</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>There is something I had to learn while designing medical imaging / data visualization software in WPF/MVVM:</p><blockquote><p>If your domain model deals with visualization, then your ViewModel <em>has to contain</em> visual information.</p></blockquote><p>I&#39;ll elaborate.</p><p>Let&#39;s take an example of an accounting system. There you can get every application functionality purely in the model, but it would be weird for an human to deal with all the accounting concepts without visualizing them.
Enter the View, purely as an aid (a true Graphical <em>User Interface</em> in a Human-Computer-Interaction sense), so the human operator can see the state of the underlying information, which has not a visual by itself.</p><p>On the other hand, let&#39;s take your extreme example: an application whose <em>very purpose</em> is to manipulate images. That is, the core Domain Model class is the Composite Image, with its layers, and each one with its pixel effects, and masks, and so on.</p><p>One core concept of MVVM, <em>Data Binding</em> totally loses its sense here: how are you suppose to have a property in the ViewModel, which is bound to a property in the View, if the very thing you are representing is already composed of pixels? At least, I suppose, your code-behind would need to be very rich (instead of non-existant in purist by-the-book MVVM).</p><p>What I have been doing lately (the current application I am developing has a custom realtime plotter) is more or less like this:</p><ol><li><p>My Model layer is a Domain Model, containing only the conceptual classes related to the broad problem, and the rules by which the objects cooperate with one another. Nothing application-related (that is, which might vary between different applications working on the same domain) lives in this layer, which by the way does not contain WPF infrastructure. Good class candidates would be <code>CompositeCanvas</code>, <code>CanvasLayer</code>, <code>PixelEffect</code>, <code>Mask</code>, <code>Tool</code>, etc.</p></li><li><p>The ViewModel layer would contain application logic, that is, how the current application chooses to manipulate the domain model objects. Here we start to use WPF related classes. For example, I most probably would represent a <code>CompositeCanvas</code> with a <a href="https://msdn.microsoft.com/pt-br/library/system.windows.media.imaging.writeablebitmap(v=vs.110).aspx" rel="nofollow"><code>WriteableBitmap</code></a>, since it can be directly used as the <code>Source</code> property of an <code>Image</code> control via classic Data Binding.</p></li><li><p>The View layer would be the dumbest as possible. Apart from the skinned input controls (toolbar buttons, custom mouse cursors and manipulator handlers), the actual CompositeImage would be composed of one or more WriteableBitmaps stacked into a Canvas or Grid or ViewBox (or a combination of them).</p></li></ol><p>One important thing to consider is how the layers interact to each other:</p><ul><li>If you have independent layers which don&#39;t interact with one another - that is, an application less sophisticated than Photoshop - then you can composite in the View, stacking multiple <code>Image</code> controls over one another inside a grid.<ul><li>Now if you want to implement <a href="https://en.wikipedia.org/wiki/Blend_modes" rel="nofollow">blending modes</a>, you might prefer to have a single <code>Image</code> to represent every layer, and apply the composition to its BitmapSource, which might be a <code>DrawingImage</code> with a <code>DrawingGroup</code> containing multiple <code>ImageDrawing</code>, one for each layer. That transfer the compositing to the ViewModel.</li><li>Now if you want <em>full control</em>, so that you can apply sophisticated image-processing algorithms, represent your image as arrays (of double, that would be a good thing), change color modes, and do other Clever Things, then you could perfectly has your layers represented in the model, and have some operation to, say, transfer that array to a WriteableBitmap in the ViewModel, which then automatically updates the View&#39;s Image.</li></ul></li></ul><p>It is interesting to &#34;visualize&#34; (pun intended) how, for example, drawing with a self-smoothing, brushed pencil would work: with the selected tool, you click on the image and drag. You could implement your DataContext (ViewModel) as an Interface, say <code>ITool</code> and make mouse events like MouseMove call methods on the ViewModel. You would then store the drawing-space (not screen-space) coordinates in an array, which could be continuously smoothed by some algorithm defined in the model. Then, you can regenerate your image source (that is, <em>render</em> it in the model), and in the ViewModel you just set its result to the <code>CanvasSource</code> property, and the property changed event would automatically update the View. This is quite different than most mouse-drawing demos found using WPF.</p><p>Hope this helps!</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../who-should-control-navigation-in-an-mvvm-application/'>Who should control navigation in an MVVM application</a></li><li class="list-group-item"><a href='../c-mvvm-pattern-best-design-approach-to-manage-an-application/'>C# &#8211; MVVM pattern &#8211; Best design approach to manage an application</a></li><li class="list-group-item"><a href='../c-di-ioc-abstract-factory-galore/'>C# &#8211; DI / IoC Abstract Factory Galore</a></li><li class="list-group-item"><a href='../design-how-to-handle-complex-views-consisting-of-several-parts-in-mvc-web-application/'>Design &#8211; How to handle complex views (consisting of several parts) in MVC web application</a></li><li class="list-group-item"><a href='../c-mvc-3-tier-where-viewmodels-come-into-play/'>C# &#8211; MVC + 3 tier; where ViewModels come into play</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>