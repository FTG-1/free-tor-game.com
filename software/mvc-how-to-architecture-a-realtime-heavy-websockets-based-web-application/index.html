<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Mvc &#8211; How to architecture a realtime-heavy websockets-based web application &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1065922 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1065922" class="post-1065922 software type-software status-publish hentry category-software tag-mvc tag-web-applications tag-websockets"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Mvc &#8211; How to architecture a realtime-heavy websockets-based web application</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">mvc</span><span class="mr-2 badge badge-info">web-applications</span><span class="mr-2 badge badge-warning">websockets</span></p><div class="entry-content"><p>In the process of developing a realtime Single Page Application, I have progressively adopted websockets to empower my users with up to date data. During this phase, I was sad to notice that I was destroying way too much of my app structure, and I failed to find a solution to this phenomenon.</p><p>Before getting into specifics, just a bit of context:</p><ul><li>The webapp is a realtime SPA ;</li><li>The Backend is in Ruby on Rails. Realtime events are pushed by Ruby to a Redis key, then a micro node server pulls back that and pushes it to Socket.Io ;</li><li>The Frontend is in AngularJS, and connects directly to the socket.io server in Node.</li></ul><p>On the server side, before realtime I had a clear controller/model based separation of the resources, with processing attached to each. This <strong>classical MVC design</strong> was completely shredded down, or at least bypassed, right when I started push stuff via websockets to my users. I have now a <strong>single pipe where all of my app flows down more or less structured data</strong>. And I find it stressful.</p><p>On the front end, the main concern is the duplication of business logic. When the user loads the page, I have to load my models trough classical AJAX calls.<br /> But I also have to handle realtime data flooding in, and I find myself duplicating much of my client-side business logic to maintain consistency of my client-side models.</p><p>After some researches, I can&#39;t find any good posts, articles, books or whatever that would give advices about how one can and should design the architecture of a modern webapp with a few specific topics in mind :</p><ul><li>How to structure the data that is sent from the server to the user?<ul><li>Should I only send events like &#34;this resource has been updated and you should reload it via an AJAX call&#34; or push the updated data and replace previous data loaded via initial AJAX calls?</li><li>How to define a coherent and scalable skeleton to data sent? is this a model update message or &#34;there was an error with blahblahblah&#34; message</li></ul></li><li>How not to send data about everything from anywhere in the backend?</li><li>How to reduce the business logic duplication both on the server and the client side?</li></ul></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><blockquote><p>How to structure the data that is sent from the server to the user?</p></blockquote><p>Use the <a href="https://en.wikipedia.org/wiki/Messaging_pattern" rel="noreferrer">messaging pattern</a>. Well, you&#39;re already using a messaging protocol, but I mean structure the changes as messages... specifically events. When server side changes, that results in business events. In your scenario, your client views are interested in these events. The events should contain all data relevant to that change (not necessarily all view data). The client page should then update the parts of view it is maintaining with the event data.</p><p>For instance, if you were updating a stock ticker and AAPL changed, you wouldn&#39;t want to push all stock prices down or even all the data about AAPL (name, description, etc). You would only push AAPL, the delta, and the new price. On the client, you would then update only that stock price on the view.</p><blockquote><p>Should I only send events like &#34;this resource has been updated and you should reload it via an AJAX call&#34; or push the updated data and replace previous data loaded via initial AJAX calls?</p></blockquote><p>I would say neither. If you are sending the event, go ahead and send relevant data with it (not the whole object&#39;s data). Give it a name for the kind of event it is. (The naming and what data is relevant to that event is beyond the scope of the mechanical workings of the system. This has more to do with how the business logic is modeled.) Your view updaters need to know how to translate each specific event into a precise view change (i.e. only update what changed).</p><blockquote><p>How to define a coherent and scalable skeleton to data sent? is this a model update message or &#34;there was an error with blahblahblah&#34; message</p></blockquote><p>I would say this is a large, open-ended question that should be broken up into several other questions and posted separately.</p><p>In general though, your back end system should create and dispatch events for important happenings to your business. Those could come in from external feeds or from activity in the back-end itself.</p><blockquote><p>How not to send data about everything from anywhere in the backend?</p></blockquote><p>Use the <a href="https://en.wikipedia.org/wiki/Publishâ€“subscribe_pattern" rel="noreferrer">publish/subscribe pattern</a>. When your SPA loads a new page which is interested in receiving real-time updates, the page should subscribe to only those events it can use, and call the view update logic as those events come in. You will probably need pub/sub logic on the server to reduce the network load. Libraries exist for Websocket pub/sub, but I&#39;m not sure what those are in the Rails ecosystem.</p><blockquote><p>How to reduce the business logic duplication both on the server and the client side?</p></blockquote><p>It sounds like you are having to update the view data on both the client and server. My guess is you need the server-side view data so that you have a snapshot to get the real-time client started. Being that there are two languages/platforms involved (Ruby and Javascript), the view update logic will have to be written in both. Aside from transpiling (which has its own issues), I don&#39;t see a way around that.</p><p><em>Technical point: Data manipulation (view update) is not business logic. If you mean use case validation, then that seems unavoidable since the client&#39;s validations are necessary for good user experience, but cannot ultimately be trusted by the server.</em></p><hr/><p>Here is how I see such a thing structured well.</p><p>Client Views:</p><ul><li>Requests a view snapshot and the view&#39;s last seen event number<ul><li>This will prepopulate the view so the client doesn&#39;t have to build from scratch.</li><li>Could be over HTTP GET for simplicity</li></ul></li><li>Makes a websocket connection and subscribes to specific events, starting from the view&#39;s last event number.</li><li>Receives events over websocket and updates its view based on event type/data.</li></ul><p>Client Commands:</p><ul><li>Request data change (HTTP PUT/POST/DELETE)<ul><li>Response is only success or failure + error</li><li>(The event(s) generated by the change will come over websocket and trigger a view update.)</li></ul></li></ul><p>The server side could actually be broken up into several components with limited responsibilities. One that just processes the incoming requests and creates events. Another could manage client subscriptions, listen for events (say in-process) and forward appropriate events to subscribers. You could have a third that listens for events and updates server-side views -- maybe this even happens before subscribers receive the events.</p><p>What I have described is a form of <a href="http://martinfowler.com/bliki/CQRS.html" rel="noreferrer">CQRS</a> + <a href="https://en.wikipedia.org/wiki/Messaging_pattern" rel="noreferrer">Messaging</a>, and a typical strategy to address of the kind of issues you are facing.</p><p>I didn&#39;t bring <a href="http://martinfowler.com/eaaDev/EventSourcing.html" rel="noreferrer">Event Sourcing</a> into this description as I&#39;m not sure if it&#39;s something you want to take on or if you need it necessarily. But it is a related pattern.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../java-websockets-vs-ajax-call-for-scheduled-event/'>Java &#8211; WebSockets vs Ajax call for scheduled event</a></li><li class="list-group-item"><a href='../is-kafka-needed-in-a-realtime-chat-application/'>Is Kafka needed in a realtime chat application</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>