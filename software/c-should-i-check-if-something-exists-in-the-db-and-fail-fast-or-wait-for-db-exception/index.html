<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>C# &#8211; Should I check if something exists in the db and fail fast or wait for db exception &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1064547 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1064547" class="post-1064547 software type-software status-publish hentry category-software tag-asp-net-core tag-c tag-entity-framework tag-orm tag-web-api"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">C# &#8211; Should I check if something exists in the db and fail fast or wait for db exception</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">asp.net-core</span><span class="mr-2 badge badge-info">c</span><span class="mr-2 badge badge-warning">entity-framework</span><span class="mr-2 badge badge-primary">orm</span><span class="mr-2 badge badge-danger">web-api</span></p><div class="entry-content"><p>Having two classes:</p><pre><code>public class Parent 
{
    public int Id { get; set; }
    public int ChildId { get; set; }
}

public class Child { ... }
</code></pre><p>When assigning <code>ChildId</code> to <code>Parent</code> should I check first if it exists in the DB or wait for the DB to throw an exception?</p><p>For example (using Entity Framework Core):</p><p><strong>NOTE</strong> these kinds of checks are <strong>ALL OVER THE INTERNET</strong> even on official Microsoft&#39;s docs: <a href="https://docs.microsoft.com/en-us/aspnet/mvc/overview/getting-started/getting-started-with-ef-using-mvc/handling-concurrency-with-the-entity-framework-in-an-asp-net-mvc-application#modify-the-department-controller" rel="noreferrer">https://docs.microsoft.com/en-us/aspnet/mvc/overview/getting-started/getting-started-with-ef-using-mvc/handling-concurrency-with-the-entity-framework-in-an-asp-net-mvc-application#modify-the-department-controller</a> but there is additional exception handling for <code>SaveChanges</code></p><p>also, note that the main intent of this check was to return friendly message and known HTTP status to the user of the API and not to completely ignore database exceptions. And the only place exception be thrown is inside <code>SaveChanges</code> or <code>SaveChangesAsync</code> call&#8230; so there won&#39;t be any exception when you call <code>FindAsync</code> or <code>Any</code>. So if child exists but was deleted before <code>SaveChangesAsync</code> then concurrency exception will be thrown.</p><p>I did this due to a fact that <code>foreign key violation</code> exception will be much harder to format to display &#34;Child with id {parent.ChildId} could not be found.&#34;</p><pre><code>public async Task&lt;ActionResult&lt;Parent&gt;&gt; CreateParent(Parent parent)
{
    // is this code redundant?
   // NOTE: its probably better to use Any isntead of FindAsync because FindAsync selects *, and Any selects 1
    var child = await _db.Children.FindAsync(parent.ChildId);
    if (child == null)
       return NotFound($&#34;Child with id {parent.ChildId} could not be found.&#34;);

    _db.Parents.Add(parent);    
    await _db.SaveChangesAsync();        

    return parent;
}
</code></pre><p>versus:</p><pre><code>public async Task&lt;ActionResult&lt;Parent&gt;&gt; CreateParent(Parent parent)
{
    _db.Parents.Add(parent);
    await _db.SaveChangesAsync();  // handle exception somewhere globally when child with the specified id doesn&#39;t exist...  

    return parent;
}
</code></pre><p>The second example in Postgres will throw <code>23503    foreign_key_violation</code> error: <a href="https://www.postgresql.org/docs/9.4/static/errcodes-appendix.html" rel="noreferrer">https://www.postgresql.org/docs/9.4/static/errcodes-appendix.html</a></p><p>The downside of handling exceptions this way in ORM like EF is that it will work only with a specific database backend. If you ever wanted to switch to SQL server or something else this will not work anymore because the error code will change.</p><p>Not formatting the exception properly for the end-user could expose some things you don&#39;t want anybody but developers to see.</p><p>Related:</p><p><a href="https://stackoverflow.com/questions/6171588/preventing-race-condition-of-if-exists-update-else-insert-in-entity-framework">https://stackoverflow.com/questions/6171588/preventing-race-condition-of-if-exists-update-else-insert-in-entity-framework</a></p><p><a href="https://stackoverflow.com/questions/4189954/implementing-if-not-exists-insert-using-entity-framework-without-race-conditions">https://stackoverflow.com/questions/4189954/implementing-if-not-exists-insert-using-entity-framework-without-race-conditions</a></p><p><a href="https://stackoverflow.com/questions/308905/should-there-be-a-transaction-for-read-queries">https://stackoverflow.com/questions/308905/should-there-be-a-transaction-for-read-queries</a></p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>Rather a confused question, but <strong>YES</strong> you should check first and not just handle a DB exception.</p><p>First of all, in your example you are at the data layer, using EF directly on the database to run SQL. You code is equivalent to running</p><pre><code>select * from children where id = x
//if no results, perform logic
insert into parents (blah)
</code></pre><p>The alternative you are suggesting is:</p><pre><code>insert into parents (blah)
//if exception, perform logic
</code></pre><p>Using the exception to execute conditional logic is slow and universally frowned upon.</p><p>You do have a race condition and should use a transaction. But this can be fully done in code.</p><pre><code>using (var transaction = new TransactionScope())
{
    var child = await _db.Children.FindAsync(parent.ChildId);
    if (child == null) 
    {
       return NotFound($&#34;Child with id {parent.ChildId} could not be found.&#34;);
    }

    _db.Parents.Add(parent);    
    await _db.SaveChangesAsync();        
    transaction.Complete();

    return parent;
}
</code></pre><p>The key thing is to ask yourself:</p><blockquote><p>&#34;Do you expect this situation to occur?&#34;</p></blockquote><p>If not, then sure, insert away and throw an exception. But just handle the exception like any other error that might occur.</p><p>If you do expect it to occur, then it is NOT exceptional and you should check to see if the child exists first, responding with the appropriate friendly message if it doesn&#39;t.</p><p><strong>Edit</strong> - There&#39;s a lot of controversy over this it seems. Before you downvote consider:</p><p>A. What if there were two FK constraints. Would you advocate parsing the exception message to work out which object was missing?</p><p>B. If you have a miss, only one SQL statement is run. It&#39;s only hits which incur the extra expense of a second query.</p><p>C. Usually Id would be a surrogate key, It&#39;s hard to imagine a situation where you know one <em>and</em> you aren&#39;t pretty sure it&#39;s on the DB. Checking would be odd. But what if its a natural key the user has typed in? That could have a high chance of not being present</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../c-separating-data-access-in-asp-net-mvc/'>C# &#8211; Separating data access in ASP.NET MVC</a></li><li class="list-group-item"><a href='../how-to-get-around-the-circular-reference-issue-with-json-and-entity/'>How to get around the Circular Reference issue with JSON and Entity</a></li><li class="list-group-item"><a href='../c-how-to-avoid-double-data-validation-in-an-application-with-web-interface/'>C# &#8211; How to avoid double data validation in an application with web interface</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>