<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Architecture &#8211; How to avoid tight coupling when practically every decision-logic has to check lots of distributed state &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1072718 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1072718" class="post-1072718 software type-software status-publish hentry category-software tag-architecture tag-coupling tag-dependency-injection tag-design-patterns tag-solid"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Architecture &#8211; How to avoid tight coupling when practically every decision-logic has to check lots of distributed state</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">Architecture</span><span class="mr-2 badge badge-info">coupling</span><span class="mr-2 badge badge-warning">dependency-injection</span><span class="mr-2 badge badge-primary">design-patterns</span><span class="mr-2 badge badge-danger">solid</span></p><div class="entry-content"><p>As the senior developer in our company, I am currently starting to move our commercial php-mysql e-commerce solution (which takes data from a specific ERP-system) from procedural spaghetti-code which uses globals for pretty much everything and has very little separation of concerns to OOP.</p><p>The title describes the basic problem rather well &#8211; almost every user-interaction will have to check lots and lots of things (state), and do different things based on that. How can I avoid bloating my controllers &amp; services or coding structural knowledge about everything into my classes (constructor over-injection, service-locator, law-of-Demeter violations etc)?</p><p>More information about the current situation:</p><p>I have already successfully developed a basic architectural style and implemented an RMA-module with this design.</p><p>A brief summary: For every basic business-entity (the rows of our mysql-tables), I have a class for data-storage and retrieval, as well as for getting NULL-versions of that object, a configuration-class that holds information about which fields are mapped from db, what a potential alternative unique key besides the db-id is, as well as the name of the table (or view) to get data from. Furthermore, I have specific collection-classes which ensure that they only contain instances of the data-classes and specific repositories also implementing the identity-map pattern which manage both basic retrieval &amp; persistence as well as entity-specific methods. When non-persistent business-entities are needed, they can be stand-alone, in a dyad with collection or a triad with collection and repository.</p><p>On top of this, I have quasi-&#34;front controllers&#34; for modules which use services for processing-tasks. In case of multi-step processes (currently RMA, later also user-account, order etc), the module &#34;front controller&#34; checks the current step (action) &amp; user-input (delegate validation to services where sensible).</p><p>If multiple actions are possible on a view, and an action only changes data within the view, and has no potential to change which view has to be chosen &#8211; the &#34;front-controller&#34; will pass that action to a presenter for the view. If the action can change what page is displayed (re-routing on validation error, progressing to different view on successful input-validation), the business-logic is done by the module &#34;front-controller&#34; itself with the help of a service or services.</p><p>As a rather standard php-application, the application is created with user input via URL, POST &amp; GET, has this input from the beginning, constructs a response, outputs it and then is destroyed. New user input will create the entire application anew &#8211; with the exception of one or two places where Ajax-code is put into the site by the application, which is basically just creating a mini-application and integrating its output into the browser-window, and isn&#39;t an interaction with the application-instance that created the page. So the application cannot update views during its lifetime &#8211; actually creating a view in the UI is the end of the application lifetime, meaning actual MVC / MVVM / MVP implementations as originally conceived are not strictly possible&#8230; only partial mappings are. I have tried a modest implementation as described above.</p><p>RMA is working nicely, and has already achieved huge increase in separation of concerns and thus &#34;debuggability&#34;. Using traits for fields and field-related methods that different classes need to fulfill common interfaces (the business-entity specific collections, configs, data-objects and repositories/identity-maps), I was able to avoid code duplication quite neatly.</p><p>After many months of reading all about best practices, patterns and anti-patterns, architectural styles etc and trying out different things &#8211; I&#39;m still left with some rather pressing problems.</p><p>The coupling between the classes related to a single business-entity (data-object, config, collection and repository) is acceptable, in fact quite beneficial: in virtue of this tetrad-pattern and the use of traits, new business-entities are added (and provide extremely powerful methods for handling them) in a matter of minutes. Schema-modifications merely necessitate changing the respective fields in the data-object and their description in the config (two lines of code for every field, plus a potential further two if the non-id unique-key changes&#8230; which does&#39;t happen).</p><p>What&#39;s bothering me mostly is that I have found no way to avoid falling prey to at least one of the set of bad practices related to constructor over-injection, service locator plus law-of-Demeter violation and tight coupling (too much knowledge) in general for the controllers and services.</p><p>That&#39;s mainly because pretty much every single controller will have to check with huge amounts of distributed state&#8230; mainly, what should be done and displayed on a certain URL with a certain set of POST &amp; GET data depends on a so many things: Is the shop b2c, b2b or salesperson? Is the visitor logged in? Does the form-data identifying a record to act upon match the records company-code, shop-code, shop-language-code? If we are in b2b, does the user have permission for the module? Does the user have permission for the record? What is the content of the text-snippet with the given code in the local language?</p><p>All this information is distributed in different model-entities. Wherever a procedure concerns only the data of the object itself, it is in the data-class or (when meta-information is needed) in a service that knows about the data-class and its config. When it contains nothing but operations on a given collection/aggregate of a business-entity, it&#39;s in the collection-class, if it concerns retrieval, it&#39;s in the repository/identity-map.</p><p>But since practically every module and nearly every action the user can perform with respect to a module is dependent upon so many different things, I currently can&#39;t seem to find a way to avoid either bloating objects and their constructors beyond the pale, or using (as I do now with the RMA-module) Configuration-Objects such as &#34;CurrShopConfiguration&#34; which contain the current shop, shop-language, a provider of local text-constants, the current visitor, user and customer and a &#34;god&#34;-like helper-service for a controller which has the CurrConfig-Object and implements all procedures the &#34;front-controller&#34; needs to perform beyond choosing actions, models, views and linking them.</p><p>I would very much like to write more SOLID code &#8211; yet can&#39;t see how, since the essential decision-logic of the modules and actions have so many necessary dependencies.</p><p>Perhaps you have some ideas on how to approach this issue?</p><p>Here is some example code &#8211; the part of the RMA-&#34;Front Controller&#34; that is executed when the &#39;save&#39; action on a a form with a returnable shipment is called:</p><pre><code>//Check for existence of shipment-id in input
if (!($this-&gt;inputHeaderID &gt; 0)) {
    //add user-faced error-message for view-models
    $this-&gt;errors[] = $this-&gt;templateEngine-&gt;getText(&#39;record_not_set&#39;);
    //go to search-view (where errors are displayed)
    $this-&gt;_showSearchPage();
} else {
    //Try to get shipment from Repository (extracted from helper), get either target shipment or NULL-object (unset fields)
    $shipment = $this-&gt;retShipmentRepository-&gt;findByID($this-&gt;inputHeaderID);
    //Check for NULL-Object
    if (!((int)$shipment-&gt;id) &gt; 0) {
        $this-&gt;errors[] = $this-&gt;templateEngine-&gt;getText(&#39;record_not_set&#39;);         
        $this-&gt;_showSearchPage();
    } else {
        //We have valid shipment. Check for user permission on shipment
        if (!$this-&gt;helper-&gt;checkUserShipmentPermission($this-&gt;user,$shipment,$this-&gt;inputEMail,$this-&gt;inputPostCode)) {
            $this-&gt;errors[] = $this-&gt;templateEngine-&gt;getText(&#39;record_not_permitted&#39;);
            $this-&gt;_showSearchPage();
        } else {
            //We have permission, attempt saving (shop-context based switching and further validation inside service)
            if(!($this-&gt;helper-&gt;saveReturnOrder($shipment,$this-&gt;inputReference,$this-&gt;inputLines))) {
                $this-&gt;errors = $this-&gt;helper-&gt;getErrors();
                $this-&gt;_showShipmentPage($shipment);
            } else {
                //The Shipment could be appended with the return order information and saved.
                //Check if it was deemed to require verification via link with token in email to owner of shipment
                //Show either success view or confirmation-required view based
                $saveStatus = $this-&gt;helper-&gt;getSaveStatus($shipment-&gt;id);
                if($saveStatus == RMAOrderHelper::SAVE_STATUS_WITHOUT_TOKEN) {
                    $this-&gt;_showSuccessPage();
                } elseif($saveStatus == RMAOrderHelper::SAVE_STATUS_WITH_TOKEN) {
                    $this-&gt;_requestTokenConfirmation($shipment);
                }
            }
        }
    }
}
</code></pre><p>The user-input variables are stored on __construct of the controller (which is injected with the helper &#8211; it accesses the helper&#39;s &#34;CurrShopConfig&#34; and extracts information it needs directly) via filter_var.</p><p>The above code smells pretty badly to me &#8230; but there&#39;s far more to the decision-logic, which is is in the helper-service and accesses the current shop-configuration, user, visitor etc to perform the tasks of its public methods.</p><p>Here are the first 2/3rds of the helper-services saveReturnOrder-Method</p><pre><code>public function saveReturnOrder( RetShipmentDocument $shipment, $yourReference, $inputLines ) {
        //Check if document isn&#39;t already marked with a return order request 
        //that hasn&#39;t been synchronized with the ERP-System (and thus cleared) yet
        if (!$shipment-&gt;isReturnOrderSettable()) {
            $this-&gt;errors[] = $this-&gt;templateEngine-&gt;getText(&#39;internal_error&#39;);
            return FALSE;
        }
        //Check if the input for the shipment-lines (id, return quantity and return-reason code)
        //belong to the shipment and are valid (e.g. return quantity &lt;= un-returned quantity)
        if (!$this-&gt;_validateReturnOrderLineInput($shipment, $inputLines)) {
            $this-&gt;errors[] = $this-&gt;templateEngine-&gt;getText(&#39;internal_error&#39;);
            return FALSE;
        }

        //ValidatedLineRequests are stored for the shipment by the _validateReturnOrderLineInput-Method
        //that has just been executed
        $requestLines  = $this-&gt;validatedLineRequests[$shipment-&gt;id];
        $shipmentLines = $shipment-&gt;getLines();

        $token  = &#39;&#39;;
        $markAsConfirmed = TRUE;

        //If visitor is not logged in and we have a content for a confirmation-request mail
        //we must not mark it as confirmed and generate a token
        if (!$this-&gt;shopConfiguration-&gt;visitorLoggedIn() &amp;&amp; ($this-&gt;getConfirmMailTextModule()-&gt;id &gt; 0)) {
            $token  = md5(uniqid(mt_rand(), TRUE));
            $markAsConfirmed = FALSE;
        //Otherwise if visitor is not logged in and there is no such mail-content
        //we have an error and cannot proceed
        } elseif (!$this-&gt;shopConfiguration-&gt;visitorLoggedIn() &amp;&amp; !($this-&gt;getConfirmMailTextModule()-&gt;id &gt; 0)) {
            $this-&gt;errors[] = $this-&gt;templateEngine-&gt;getText(&#39;internal_error&#39;);
            return FALSE;
        }
        $lineRepository = $this-&gt;shipmentRepository-&gt;getLineRepository();
        $committedLineRequests = 0;
        foreach ($requestLines as $lineRequest) {
            $lineID           = $lineRequest[&#39;line_id&#39;];
            $returnQuantity   = $lineRequest[&#39;return_quantity&#39;];
            $returnReasonCode = $lineRequest[&#39;return_reason_code&#39;];         
            foreach ($shipmentLines as $shipmentLine) {             
                if ($shipmentLine-&gt;id == $lineID) {
                    //The shipment has a line matching the request, attempt setting the return-order data
                    if (!$shipmentLine-&gt;setReturnOrder($markAsConfirmed, $returnQuantity, $returnReasonCode)) {
                        $this-&gt;errors[] = $this-&gt;templateEngine-&gt;getText(&#39;internal_error&#39;);
                        $this-&gt;_unsetReturnOrder($shipment);
                        return FALSE;
                    }
                    //Data could be set in object - now try persisting it
                    if (!$lineRepository-&gt;updateSingle($shipmentLine)) {
                        $this-&gt;errors[] = $this-&gt;templateEngine-&gt;getText(&#39;internal_error&#39;);
                        $this-&gt;_unsetReturnOrder($shipment);
                        return FALSE;
                    }
                    //Persistence succeeded, increment counter
                    ++$committedLineRequests;
                }
            }
        }
</code></pre><p>As you can see&#8230; I&#39;ve already made many discrete sub-processes into methods and located them with objects to which they belong, but I&#39;m still left with huge ugly nested conditionals and an explosion of dependencies. Splitting up every part (or even most parts) of such nested conditionals into different objects is unfeasible&#8230; and unhelpful, since practically every conditional already uses methods that are with objects where they belong, and since such a splitting would likely increase re-usability very little and would have to be done for many dozens such situations, resulting in a class- and file-explosion.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>If you have too many dependencies being passed around, the general technique is to eliminate those dependencies higher up in the call stack, by changing the order decisions are made.  This is easiest to explain with an example:</p><pre><code>getPath(config, user) {
  if (config.isB2B())
    return b2bpath(config, user);
  else
    return b2cpath(config, user);
}

b2bpath(config, user) {
  if (!config.allowedToAccessPath(user))
    return accessDeniedPage();
  else
    return &#34;My fancy b2b page&#34;;
}

b2cpath(config, user) {
  if (!config.allowedToAccessPath(user))
    return accessDeniedPage();
  else
    return &#34;My fancy b2c page&#34;;
}
</code></pre><p>You are repeating the authorization check down at the lowest levels of the call stack, so move it up:</p><pre><code>getPath(config, user) {
  if (!config.allowedToAccessPath(user))
    return accessDeniedPage();

  if (config.isB2B())
    return b2bpath();
  else
    return b2cpath();
}

b2bpath() {
    return &#34;My fancy b2b page&#34;;
}

b2cpath() {
    return &#34;My fancy b2c page&#34;;
}
</code></pre><p>Then repeat to see if you can move some of the decisions into the code that calls <code>getPath</code>.  This is a simple example, but I see the former kind of code all over the place with more layers.  Start with decisions at your lowest layers, and try to figure out ways to move them up.  Sometimes this requires judicious use of inheritance, like:</p><pre><code>getPath(config, user) {
  module = config.isB2B() ? B2BModule() : B2CModule()
  if (!config.allowedToAccessPath(user))
    return module.accessDeniedPage();

  return module.getPath();
}
</code></pre><p>It&#39;s <em>very</em> rare not to be able to simplify dependencies this way.  It&#39;s a matter of trying different arrangements until you find one that works.</p><p>If you have workflow-type dependencies, not just data dependencies, as in your first example, you can separate them out using something like this:</p><pre><code>step1 = new ValidateHeaderId(inputHeaderId);
step2 = new FindShipment(retShipmentRepository);
step3 = new ValidateUserPermission(user, inputPostCode, inputEmail);
step4 = new SaveReturnOrder(inputLines, inputReference);
step5 = new CheckSaveStatus();
notSet = new NotSetPage(templateEngine, searchPage);
notPermitted = new NotPermittedPage(templateEngine, searchPage);
saveErrors = new SaveErrorsPage();
success = new SuccessPage();
requestTokenConfirmation = new RequestTokenConfirmation();

steps = [step1, [notSet, step2], [notSet, step3], [notPermitted, step4],
         [saveErrors, step5], [success, requestTokenConfirmation]];
executeSteps(steps);
</code></pre><p>This recognizes you have a series of steps which each produce some sort of result and choose the next step. <code>executeSteps</code> abstracts away the repetition of calling <code>run()</code> on each step, and passing the output from the previous step into the next step.  This allows the steps to be stored in a data structure instead of a function, which can then be built up in several different ways, including by some sort of registration process or config file.  Once each step object has been created, its dependencies no longer need to be tracked outside it.  I believe the rules engines from <a href="https://softwareengineering.stackexchange.com/a/271580/3965">BobDalgleish&#39;s answer</a> are basically pre-existing libraries to help you do this more easily.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../php-how-to-use-di-and-di-containers/'>Php &#8211; How to use DI and DI containers</a></li><li class="list-group-item"><a href='../mvc-model-view-controller-does-the-user-interact-with-the-view-or-with-the-controller/'>Mvc &#8211; Model-View-Controller: Does the user interact with the View or with the Controller</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>