<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="https://free-tor-game.com/wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Database &#8211; How to handle foreign key constraints when migrating from monolith to microservices &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.min.js?ver=11.2.0' id='highlight-js'></script>     <script>( function( w, d, s, l, i ) {
				w[l] = w[l] || [];
				w[l].push( {'gtm.start': new Date().getTime(), event: 'gtm.js'} );
				var f = d.getElementsByTagName( s )[0],
					j = d.createElement( s ), dl = l != 'dataLayer' ? '&l=' + l : '';
				j.async = true;
				j.src = 'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
				f.parentNode.insertBefore( j, f );
			} )( window, document, 'script', 'dataLayer', ' ' );</script>      <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1068361 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="https://free-tor-game.com/3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="https://free-tor-game.com/contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1068361" class="post-1068361 software type-software status-publish hentry category-software tag-architecture tag-database tag-microservices tag-refactoring"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Database &#8211; How to handle foreign key constraints when migrating from monolith to microservices</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">Architecture</span><span class="mr-2 badge badge-info">database</span><span class="mr-2 badge badge-warning">microservices</span><span class="mr-2 badge badge-primary">refactoring</span></p><div class="entry-content"><p>My team is migrating from a monolithic ASP.NET application to .NET Core and Kubernetes.  The code changes seem to be going as well as can be expected but where my team is encountering a lot of discord is around the database.</p><p>We currently have rather large SQL Server database that houses all of the data for our entire business.  I&#39;m proposing that we split the database in a similar way to splitting the code&#8211;catalog data in one (logical) database, inventory data in another, orders in another, etc&#8211;and each microservice would be the gatekeeper for its database.</p><p>The implication here is that foreign keys that cross microservice boundaries would have to be removed and sprocs and views that reach across boundaries would be prohibited.  All of the data models may or may not reside in the same physical database, but even if they do, they should not interact with each other directly.  Orders might still reference catalog items by Id but the data integrity would not be strictly enforced at the database level and that data will have to be joined in code rather than in SQL.</p><p>I see the loss of these as necessary trade offs in moving to microservice and getting the scalability benefits that come with.  As long as we choose our seams wisely and develop around them then it should be OK.  Other team members are adamant that everything must stay in the same monolithic database so everything can be ACID and have referential integrity preserved everywhere.</p><p>This brings me to my question.  First, is my stance on foreign key constraints  and join plausible?  If so, is anyone aware of any credible reading material I could offer to my colleagues?  Their position is nearly religious and they don&#39;t seem like they will be swayed by anything short of Martin Fowler himself telling them they&#39;re wrong.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>There is no clear solution because this depends entirely on your context – in particular, along which dimensions your system is supposed to scale and what your actual problems are. Is the database really your bottleneck?</p><p>This (unfortunately rather lengthy) answer will read a bit like “microservices are bad, monoliths for life!”, but that&#39;s not my intention. My point is that microservices and distributed databases can solve various problems, but not without having some issues of their own. In order to make a strong argument for your architecture, you must show that these issues do not apply or can be mitigated, and that this architecture is the best choice for your business needs.</p><h3>Distributed data is difficult.</h3><p>The same flexibility that enables better scaling is the flip side of weaker guarantees. Notably, distributed systems are much <em>much</em> harder to reason about.</p><p>Atomic updates, transactions, consistency/referential integrity, and durability are extremely valuable and should not be waived rashly. There is little point in having data if it is incomplete, out of date, or outright wrong.
When you have ACID as a business requirement but are using database technology that cannot offer it out of the box (e.g. many NoSQL databases, or a DB-per-microservice architecture), then <em>your application</em> must fill the gap and provide those guarantees.</p><ul><li><p>This is not impossible to do, but tricky to get right. Very tricky. Especially in a distributed setting where there are multiple writers to each database. This difficulty translates to a high chance of bugs, possibly including dropped data, inconsistent data, and so on.</p><p>For example, consider reading the <a href="https://jepsen.io/analyses" rel="nofollow noreferrer">Jepsen analyses of well-known distributed database systems</a>, perhaps starting with the <a href="https://aphyr.com/posts/294-call-me-maybe-cassandra" rel="nofollow noreferrer">analysis of Cassandra</a>. I don&#39;t understand half of that analysis, but the TL;DR is that distributed systems are so difficult that even industry-leading projects sometimes get them wrong, in ways that can seem obvious in hindsight.</p></li><li><p>Distributed systems also imply a larger development effort. To a certain degree, there&#39;s a direct trade-off between development costs or dropping money on beefier hardware.</p></li></ul><h3>Example: dangling references</h3><p>In practice, you should not look at computer science but at your business requirements to see whether and how ACID can be relaxed. E.g. many foreign-key relationships might not be as important as they seem. Consider a product – category n:m relationship. In a RDBMS we might use a foreign-key constraint so that only existing products and existing categories can be part of that relationship. What happens if we introduce separate product and category services, and a product or category is deleted?</p><p>In this case, that might not be a big problem and we can write our application so that it filters out any products or categories that no longer exist. But there are tradeoffs!</p><ul><li><p>Note that this might require an application-level <code>JOIN</code> over multiple databases/microservices, which merely moves processing from the database server to your application. This increases total load and has to move extra data through the network.</p></li><li><p>This can mess with pagination. E.g. you request the next 25 products from a category, and filter out unavailable products from that response. Now your application displays 23 products. In theory, a page with zero products would also be possible!</p></li><li><p>You will want to occasionally run a script that cleans up dangling references, either after each relevant change or on regular intervals. Note that such scripts are fairly expensive because they have to request every product/category from the backing database/microservice to see whether it still exists.</p></li><li><p>This should be obvious, but for clarity: do not reuse IDs. Autoincrement-style IDs may or may not be fine. GUIDs or hashes give you more flexibility, e.g. by being able to assign an ID before the item is inserted into a database.</p></li></ul><h3>Example: concurrent orders</h3><p>Now instead consider a product – order relationship. What happens to an order if a product is deleted or changed? Ok, we can simply copy the relevant product data into the order entry to keep it available – trading disk space for simplicity. But what if the product&#39;s price changes or the product becomes unavailable just before an order for that product is made? In a distributed system, effects take time to propagate and the order will likely go through with outdated data.</p><p>Again, how to approach this depends on your business requirements. Maybe the outdated order is acceptable, and you can later cancel the order if it cannot be fulfilled.</p><p>But maybe that&#39;s not an option, e.g. for highly concurrent settings. Consider 3000 people rushing to buy concert tickets within the first 10 seconds, and let&#39;s assume a change in availability will require 10ms to propagate. What is the probability of selling the last ticket to multiple people? Depends on how those collisions are handled, but using a Poisson distribution with <code>λ = 3000 / (10s / 10ms) = 3</code> we get a <code>P(k &gt; 1) = 1 - P(k = 0) - P(k = 1) = 80%</code> chance of collision per 10ms interval. Whether selling and later cancelling the majority of your orders is possible without committing fraud might lead to an interesting conversation with your legal department.</p><h3>Pragmatism means cherry-picking the best features.</h3><p>The good news is that you don&#39;t have to move to a distributed database model, if that&#39;s not required otherwise. No one will revoke your Microservice Club membership if you don&#39;t do microservices “properly”, because there is no such club – and no one true way to build microservices.</p><p>Pragmatism wins every time, so mix and match various approaches as they solve your problem. This could even mean microservices with a centralized database. Really, don&#39;t go through the pain of distributed databases if you don&#39;t have to.</p><h3>You can scale without microservices.</h3><p>Microservices have two major benefits:</p><ul><li>The organizational benefit that they can be developed and deployed independently by separate teams (which in turns requires the services to offer a stable interface).</li><li>The operational benefit that each microservice can be scaled <em>independently</em>.</li></ul><p>If independent scaling is not required, microservices are a lot less attractive.</p><p>A database server already is a kind of service which you can scale (somewhat) independently, e.g. by adding read replicas. You mention stored procedures. Reducing them might have such a large effect that any other scalability discussions are moot.</p><p>And it&#39;s perfectly possible to have a scalable monolith which includes all services as libraries. You can then scale by launching more instances of the monolith, which of course requires each instance to be stateless.</p><p>This tends to work well until the monolith is too large to be reasonably deployed, or if some services have special resource requirements so that you might want to scale them independently. The problem domains that involve extra resources might not involve a separate data model.</p><h3>Do you have a strong business case?</h3><p>You are aware of the business needs of your organization, and can therefore create an argument for a database-per-microservice architecture, based on an analysis:</p><ul><li>that a certain scale is required, and this architecture is the most cost-effective approach to obtain that scalability, taking into account the increased development effort for such a setup and alternative solutions; and</li><li>that your business requirements allow relevant ACID guarantees to be relaxed, without leading to various problems like those discussed above.</li></ul><p>Conversely, if you are unable to demonstrate this, in particular if the current database design is able to support sufficient scale into the future (as your colleagues seem to believe), then you also have your answer.</p><p>There&#39;s also a big YAGNI component to scalability. In the face of uncertainty, it is a strategic business decision on building for scalability now (lower total costs, but involves opportunity costs and may not be needed) versus deferring some work on scalability (higher total costs if needed, but you have a better idea of the actual scale). This is not primarily a technical decision.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='https://free-tor-game.com/software/java-how-to-decompose-monolithic-applications-into-microservices-with-interdependent-functional-modules/'>Java &#8211; How to decompose Monolithic applications into Microservices with interdependent functional modules</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/database-breaking-up-a-monolith-into-soa-and-breaking-referential-integrity/'>Database &#8211; Breaking up a monolith into SOA, and breaking referential integrity</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/data-security-between-users-in-a-microservice-architecture/'>Data Security Between Users in a Microservice Architecture</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/architecture-how-to-keep-relationship-integrity-with-microservice-architecture/'>Architecture &#8211; How to keep relationship integrity with Microservice Architecture</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/architecture-data-replication-in-microservices/'>Architecture &#8211; Data replication in microservices</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/database-splitting-application-into-multiple-but-keeping-database-same/'>Database &#8211; Splitting application into multiple but keeping database same</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/architecture-microservices-and-stored-procedures/'>Architecture &#8211; Microservices and stored procedures</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='http://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="https://free-tor-game.com/wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>