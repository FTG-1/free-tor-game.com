<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>C# &#8211; Where should I put Validation Logic when using CQRS &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1077624 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1077624" class="post-1077624 software type-software status-publish hentry category-software tag-c tag-domain-driven-design"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">C# &#8211; Where should I put Validation Logic when using CQRS</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">c</span><span class="mr-2 badge badge-info">domain-driven-design</span></p><div class="entry-content"><p>I asked this question a while ago: <a href="https://softwareengineering.stackexchange.com/questions/359143/what-is-the-best-way-to-apprach-validation-from-the-perspective-of-a-ddd-puris">What is the &#34;best&#34; way to apprach validation from the perspective of a DDD purist?</a></p><p>At the time I decided to put the validation logic inside the domain object constructor like one of the answerers suggested.</p><p>The business have recently become interested in how data has arrived at its current state.  Therefore I am familiarising myself with Event Sourcing and also CQRS.  I am unsure where to put the validation logic when using CQRS.  For example, please see the Command object below:</p><pre><code>public class RequestBookingCommand : Command
    {
        public RequestBookingCommand(int courtId, int hour, int length, string userName, string notes)
        {
            Name = &#34;AddBooking&#34;;
            CourtId = courtId;
            Hour = hour;
            Length = length;
            UserName = userName;
            Notes = notes;
        }

        public int CourtId { get; private set; }
        public int Hour { get; private set; }
        public int Length { get; private set; }
        public string UserName { get; private set; }
        public string Notes { get; private set; }
    }
</code></pre><p>There is also a domain object that accepts the RequestBookingCommand in the constructor like this:</p><pre><code>public RequestBooking(RequestBookingCommand requestBookingCommand)
        {
            Name = requestBookingCommand.Name;
            CourtId = requestBookingCommand.CourId;
            Hour = requestBookingCommand.Hour;
            Length = requestBookingCommand.Length;
            UserName = requestBookingCommand.UserName;
            Notes = requestBookingCommand.Notes;
        }
</code></pre><p>I believe I have three options for the validation:</p><pre><code>Option 1 - Put the validation in the Command object only.
Option 2 - put the validation in the Domain object only.
Option 3 - Put the validation in both the Command object and the domain object
</code></pre><p>An example of validation is (it is simple):</p><pre><code>if (CourtId = 0)
{
    throw new ArguementException();
}
//Ensure the rest of the members are populated with values.....
</code></pre><p>At first I thought option 2 or 3 was the most appropriate because the Domain object should be responsible for maintaining the invariants and also the business analysts have requested this validation.  However everywhere I look suggests that the validation logic should go in the Command object e.g. <a href="https://lostechies.com/jimmybogard/2016/04/29/validation-inside-or-outside-entities/" rel="nofollow noreferrer">here</a> and <a href="https://softwareengineering.stackexchange.com/questions/348337/how-exactly-should-a-cqrs-command-be-validated-and-transformed-to-a-domain-objec/348350?noredirect=1#comment816899_348350">here</a>.  Steven also suggests it <a href="https://stackoverflow.com/questions/47991017/understanding-the-command-pattern-in-a-ddd-context/47993398?noredirect=1#comment88371976_47993398">here</a>.</p><p>It appears to me that putting the validation logic in a command is like putting it in the application service (making the domain model anemic).  Is that not the case?</p><p>I realise my application will work regardless of what option I choose.  However, I am trying to follow the principle of least astonishment here.</p><p><strong>Update</strong></p><p>Following on from VoiceOfUnreasons answer.  Say I have a class called Customers and also a class called CustomerCommand:</p><pre><code>public class CustomerCommand
{
  public Guid id;
  public string Age;

  public CustomerCommand()
  {
       If (Age &lt;0)
       {
            throw new ArgumentException();
       }
       If (Id==Guid.Empty())
       {
            throw new ArgumentException();
       }
  }

}

public class Customer 
{
  public Guid id;
  public decimal Age;
  public IOffer Offer;

  public Customer()
  {
       If (Age &lt; 18)
       {
            throw new ArgumentException();
       }
  }

  public AssignOffer(List&lt;IOffer&gt; allOffers, IOfferCalculator offerCalculator)
  {
     Offer = offerCalculator.calculateOffer(this, allOffers);
  }

}
</code></pre><p>Say the company only creates an offer for customers over the age of 18.  In this example code I believe:</p><p>1) The command is validating that it is well formed e.g. a person cannot be aged -50 because this is impossible.</p><p>2) Given the customer is over 18, then assign an offer.</p><p>3) If the customer is over 18, then the domain object can satisfy all queries.</p><p>Does this satisfy your three parts?</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>One area that I found very confusing in the early going is that <em>messages</em> and <em>domain values</em> are not really the same thing.</p><p>In particular, messages are part of your API - they describe an agreed upon protocol/representation for communicating semantic information across the boundary of the domain model.  In situations where different organizations are <em>sharing</em> messages (example, a client sending messages to a server), messages schemas tend to change slowly, and with a great deal of care for backwards compatibility.</p><p>Value objects are <em>not</em> part of your API; they are domain semantics applied to data structures.  So you can change those as aggressively as you like - because ultimately, the domain objects don&#39;t leak out of the boundaries of your service.</p><p>Over the lifetime of a successful project, you are likely change your value objects much more often than you change your messages.</p><p>If you are familiar with Gary Bernhardt&#39;s talk <a href="https://www.destroyallsoftware.com/talks/boundaries" rel="nofollow noreferrer">Boundaries</a>: messages are how we replicate information from one imperative shell to another.  Our imperative shell turns the message into values which are used by the functional core.</p><p>Microservices don&#39;t share <em>value objects</em>.  They share message schema - that allows either team to change up their domain model as much as they like without forcing cascading maintenance across the entire system.</p><p>That means we might be expecting the version 2.1 representation of a message, but we are expected to be able to handle 2.0 (backward compatibility) and 2.2 (forward compatibility).</p><p>Note: messages are not limited to a single representation either.  You might have one channel listening for messages expressed as byte arrays that can be decoded using a JSON parser, and another channel listening for messages expressed as byte arrays that are application/x-www-form-urlencoded.</p><p>It&#39;s our adapter that is responsible for ensuring that the bytes we have received can be sensibly understood as a message of the appropriate schema.  Prior to that point, the data is untrusted -- so you certainly want to have validation in place as you take the domain agnostic bytes and create an in memory representation of the message semantics.</p><p>Converting the message to a value object - you are really going from one trusted representation to another.  There&#39;s a lot less risk there; faults that are introduced at this point are much more likely to be programmer error than they are malicious attacks.</p><p>But there are likely to be cases where you aren&#39;t working with your adapter.  For instance, the tests that you run between changes to ensure you have broken anything -- do you need validation there?</p><p>Furthermore, the concept of &#34;untrusted&#34; data gets fuzzier when dealing with stand alone applications.  For example; does your desktop calculator really need separate <code>message</code> and <code>value object</code> models?</p><p><a href="https://pragprog.com/book/swdddf/domain-modeling-made-functional" rel="nofollow noreferrer">Domain Modeling Made Functional</a> has a lot of good material on this topic; but in short you can treat validation as a pipeline, and make &#34;this data is untrusted&#34; an explicit concept in your program.</p><p>But while &#34;trust&#34; is an important element of some domains,  the dangers of malicious byte representations of messages are part of the &#34;secure software domain&#34;, and should be modeled there - not in the core business logic (as a rule).</p><p>To the best of my knowledge, this isn&#39;t a topic well covered in the Blue Book -- I simply can&#39;t remember any details discussions of the problems of distributed messaging.</p><blockquote><p>Are you saying that if I remove primitive obsession, then all of the validation is done in the domain? Is there any validation done on the command?</p></blockquote><p>No.  I&#39;m saying that you have two separate <em>logical</em> translations</p><pre><code>Untrusted Message Representation -&gt; Trusted Message
Trusted Message -&gt; Domain Values
</code></pre><p>To offer a contrived example: your message specification may say that <code>Estimated Arrival Time</code> is an <a href="https://xkcd.com/1179/" rel="nofollow noreferrer">ISO-8601 Local Date</a>, where your <em>domain model</em> tracks that information as a <code>System.DateTime</code>.</p><pre><code>Untrusted Representation -&gt; ISO Local Date
ISO Local Date -&gt; System.DateTime
</code></pre><p>Later on in the project, you realize that tracking Estimated Arrival Time as &#34;seconds since epoch&#34; meets your needs better, you change the value objects in your domain to use the new in memory representation.</p><pre><code>Untrusted Representation -&gt; ISO Local Date
ISO Local Date -&gt; long
</code></pre><p>And so your <code>Value Object</code> changes, and the adapter that translates from <code>Trusted Message</code> to <code>Value Object</code> changes.</p><p>But the <em>message schema</em> that you use to communicate with other processes <em>stays the same</em>.</p><p>The motivation for &#34;validation&#34; in the two cases is very different.  In the first, we are using run time checks to protect the system from corrupt data, malicious data, and messaging errors by other parties (our partner sends a message to the wrong endpoint, a message gets misdirected by the routing middleware).</p><p>In the second, we&#39;re guarding against errors being introduced by the impedance mismatch between our domain semantics and the domain agnostic in memory representations that we use.</p><p>So, in short: ideally, you should have &#34;validation&#34; in both your messages and in your value objects.  But the trade offs in the two cases are <em>not</em> the same, and there are circumstances where you might reasonably choose one without the other.</p><blockquote><p>Every single example I look at has only context validation.</p></blockquote><p>Not a fan - I&#39;m more comfortable with a different type in each context:</p><ul><li>I prefer having the differences in <em>semantics</em> between validated and unvalidated representations be <em>explicit</em> in code</li><li>I often program in languages with type checking; using explicit types catches some of the errors I make</li></ul><p>I don&#39;t mind re-using the same underlying <em>data structure</em> at different stages -- the expression of the semantics in memory is an implementation detail.</p><p>Note that to some degree, it&#39;s a quibble between</p><pre><code>class UntrustedMessage {
    boolean isValid();
}
</code></pre><p>which I hate, and the <em>almost</em> equivalent</p><pre><code>class UntrustedMessage {
    Optional&lt;TrustedMessage&gt; validate();
}
</code></pre><blockquote><p>As a thumb rule: you use validation (in the command) to ensure the input data is in valid format, then the business rules (in the domain) decide how/if the input changes a model</p></blockquote><p>This isn&#39;t quite right.  I see three parts, rather than two</p><ul><li><p>Is the &#34;command&#34; message well formed?  This is basically a validation check against the <em>messaging schema</em>.  Is <code>Withdraw(200 USD)</code> a correct message?</p></li><li><p>Given the current state of the domain, what should we do with this message? That&#39;s business rule, it&#39;s the semantics of what&#39;s supposed to happen.  I think of this as part of the <em>problem</em> domain.  Somebody withdrew 200USD - do they have funds to cover that? do we need to escalate? notify government authorities? offer them overdraft protection?  All of this is variations on &#34;figure out how this message changes the current domain state&#34;.</p></li></ul><p>But the part that&#39;s missing is one I&#39;m trying to demonstrate is separate from message validation</p><ul><li>Are the domain objects in a valid state?  With is to say, are they in a condition that allows them to satisfy the post conditions of <em>all</em> queries that might be asked of them.</li></ul><p>Crazy thought experiment - suppose our domain model had <code>SmallMoney</code> and <code>BigMoney</code>; we&#39;ve discovered in our experience of the domain that there are different processes in place for small amounts of money vs large amounts -- you can get SmallMoney from an ATM, or a cashier, but BigMoney requires talking to a bank officer, or whatever.  So SmallMoney, the value object, has a post condition like SmallMoney::toInt returns a number in the range 0-100.</p><p>That has nothing to do with the message schema at all, and it is only loosely coupled to the domain logic (which is to say, we&#39;re pretending that SmallMoney means something to the domain experts), but we use validation on the object so that we can do it in one place, rather than everywhere/not at all.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../where-should-business-logic-go-in-a-layered-architecture/'>Where should business logic go in a layered architecture</a></li><li class="list-group-item"><a href='../c-method-to-validate-an-object-should-i-have-one-method-encapsulating-all-validation-logic/'>C# &#8211; Method to validate an object &#8211; should I have one method encapsulating all validation logic</a></li><li class="list-group-item"><a href='../how-exactly-should-a-cqrs-command-be-validated-and-transformed-to-a-domain-object/'>How exactly should a CQRS Command be validated and transformed to a domain object</a></li><li class="list-group-item"><a href='../c-tool-pattern-for-business-rule-rather-than-validation/'>C# &#8211; Tool/Pattern for Business Rule rather than Validation</a></li><li class="list-group-item"><a href='../understanding-ddd-when-using-an-orm-such-as-hibernate/'>Understanding DDD when using an ORM such as Hibernate</a></li><li class="list-group-item"><a href='../ddd-and-mediatr-where-the-validation-and-business-logic-go/'>DDD and MediatR &#8211; where the Validation and Business Logic go</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>