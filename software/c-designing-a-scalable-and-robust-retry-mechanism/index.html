<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>C# &#8211; Designing a scalable and robust retry mechanism &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1076811 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1076811" class="post-1076811 software type-software status-publish hentry category-software tag-c tag-design tag-sql-server"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">C# &#8211; Designing a scalable and robust retry mechanism</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">c</span><span class="mr-2 badge badge-info">design</span><span class="mr-2 badge badge-warning">sql server</span></p><div class="entry-content"><p><strong>Backstory</strong></p><p>I have an Messaging Server Application that is responsible for brokering/proxying calls made from an Application Tier to numerous external services.  The purpose of this application is to abstract the technicalities of invoking these services away from the main Application Tier.</p><p>This works well as the Application Server does not have to worry about http/ldap etc protocols, wcf, ftp, soap, ebxml etc etc.  They simply send a &#34;payload&#34;, with a few identifiers, and the Messaging Server handles the rest.  It also means that if a service definition changes the Application Server does not need to be changed.  Additionally the Messaging Server is back ended by an SQL 2008 database that stores an audit of all messages sent and associated responses etc.</p><p>The general data flow architecture of this is as follows:</p><p>Application Server(s) =&gt; Load Balancer =&gt; Messaging Server(s) =&gt; [X] =&gt; External Services</p><p><strong>The Question</strong></p><p>I need to implement a retry mechanism into the Messaging Application tier.  The intention is to gracefully recover from situations where the Messaging Server isn&#39;t able to forward onto the target service (i.e. service down, network issues, timeouts etc), i.e issues with point [X] in the architecture above.</p><p><strong>The high level design requirement is:</strong></p><p>Application Server sends a request to the Messaging Server.  This then attempts to forward to the external services.  If the first attempt at this fails the Messaging Server responds synchronously to the Application Server stating that the message is &#34;in retry&#34;</p><p>The Messaging Server then proceeds to retry the fowarding per the contract (i.e. X retries with Y seconds between each).</p><p>One of two things will happen next, all contracted retries will have been performed unsuccessfully or one of the retries will succeed.  In either case a message is sent back into the Application Tier to notify the state of the messaging request.</p><p><strong>A few gothcas</strong></p><p>The message to retry can&#39;t be held in &#34;memory&#34; as if that Messaging Server goes down the message is lost.  Additionally a retry contract could be 5 times once every 12 hours, holding data in memory for that length of time isn&#39;t feasible.  That said some retry contracts could be 5 times once every 5 seconds.</p><p>If the forward network goes down and then recovers the load of the retries should be spread across the entire messaging tier rather than a single server.</p><p><strong>The question</strong></p><p>The commucation between Application and Messaging tier isn&#39;t a concern as that framework is already in place.  However the architecture of the retry framework in the Messaging Tier is still up in the air.  How would you implement this?</p><p><strong>Options we have/are considering</strong></p><p>On failure store the retry data in a database, then have a polling service that checks the database every second.  If a message is found that is scheduled for retry this is push back onto the Messaging Tier via the Load Balancer</p><p>On failure store the retry data in a database, use a CLR job to poll the database and push messages, scheduled for retry, back onto the Load Balancer</p><p><strong>Other Information</strong></p><p>May or may not be relevant:</p><ul><li>All code is C#</li><li>Databases are SQL 2008</li><li>Comms from Application to Messaging tier is performed via WCF with BasicHttpBinding.</li><li>We have complete control over all aspects of the Messaging Server tier and no control over the Application Tier.</li><li>The Messaging Tier currently handles around 500k transactions per hour, so you can imagine how quickly things will backup if there is a failure on one of the external services</li></ul></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p><strong>Consider a exponential retry timeout</strong></p><p>In the solution you&#39;ve provided above having a retry mechanism every 1 second is naive solution.</p><p>You should consider a exponential time increase up to a maximum (decided by the business).</p><p>This is to avoid situations where you are spending valuable cycles on polling an ever increasing backlog of messages which will only fail and slowing down the processing of messages that can be handled and processed immediately.</p><p><strong>Poisoned Messages</strong></p><p>It is possible for poisoned messages to show up.  These messages may never be able to be processed for one reason or another.  You should consider having a process in place to identify and handle these messages.</p><p><strong>This is a business decision, not an implementation detail</strong></p><p>I think the most pertinent question is not what is said here, but what does the business want to do in this situation?  How to actually create a retry polling mechanism is trivial.  What the business wants to do in that situation is not, and is purely a business decision.</p><p><strong>Real world example</strong></p><p>I wrote a Distributed System for my employer a number of years ago (MSMQ, C#, etc).  I implemented a system whereby messages would have a retry mechanism which would retry using an exponential function until it hit a max of once per hour.</p><p>I had a NAGIOS monitor in place which would poll and then detect number of failed messages in the queue and then push an alert if it reached a certain threshold.  This would instantly alert the business that a vendor was offline and that clients who would be expecting a turnaround of lets say an hour.</p><p>It would then be a business decision (in this case the business decided to cancel all of these queued backlog of messages and then handle these manually via the helpdesk).  And so the application had to be written to be able to allow manual processing of these messages.</p><p>In other instances where the vendor was only offline for a few minutes, the retry mechanism picked them up and handled them as per normal.  However having the exponential timeout allowed the system to gracefully process regular transactions and the backlog without snowing the server under when the vendor came back online.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../architecture-write-data-to-sql-server-directly-from-biztalk-or-use-external-service/'>Architecture &#8211; Write data to SQL Server directly from BizTalk or use external service</a></li><li class="list-group-item"><a href='../designing-an-scalable-message-queue-architecture/'>Designing an scalable message queue architecture</a></li><li class="list-group-item"><a href='../java-what-to-consider-when-designing-a-web-application-that-will-be-deployed-under-a-load-balancer/'>Java &#8211; What to consider when designing a web application that will be deployed under a load balancer</a></li><li class="list-group-item"><a href='../c-domain-driven-design-and-wcf-services-architecture/'>C# &#8211; Domain driven design and WCF services architecture</a></li><li class="list-group-item"><a href='../c-a-clr-sql-server-stored-procedure-calling-an-asp-net-web-api/'>C# &#8211; A CLR SQL Server Stored Procedure calling an ASP.NET Web API</a></li><li class="list-group-item"><a href='../design-system-design-scalable-chat-server/'>Design &#8211; System Design: Scalable Chat Server</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>