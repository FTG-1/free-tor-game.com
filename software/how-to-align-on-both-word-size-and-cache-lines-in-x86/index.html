<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>How to align on both word size and cache lines in x86 &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1076688 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1076688" class="post-1076688 software type-software status-publish hentry category-software tag-caching tag-cpu tag-memory tag-unicode tag-x86"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">How to align on both word size and cache lines in x86</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">caching</span><span class="mr-2 badge badge-info">cpu</span><span class="mr-2 badge badge-warning">memory</span><span class="mr-2 badge badge-primary">unicode</span><span class="mr-2 badge badge-danger">x86</span></p><div class="entry-content"><p>From what it sounds like, a 64 bit processor means aligning to 64 bits, which means if you have unicode utf-8 stored in there, each 8-bit chunk would take up 64 bits of space. That doesn&#39;t really make too much sense, so I think I need to do <a href="https://software.intel.com/en-us/articles/coding-for-performance-data-alignment-and-structures" rel="nofollow noreferrer">a bit more</a> to understand exactly <a href="https://software.intel.com/en-us/articles/data-alignment-when-migrating-to-64-bit-intel-architecture" rel="nofollow noreferrer">how cache aligning works</a>.</p><p>But thanks to this great answer to <a href="https://stackoverflow.com/questions/381244/purpose-of-memoryalignment/381368#381368">Purpose of memory alignment</a> I see how alignment is beneficial, so I would like to learn what it would mean in practice to implement <a href="https://en.wikipedia.org/wiki/Data_structure_alignment#Typical_alignment_of_C_structs_on_x86" rel="nofollow noreferrer">alignment</a> to a <a href="https://en.wikipedia.org/wiki/Word_(computer_architecture)" rel="nofollow noreferrer">word</a> and to a <a href="https://stackoverflow.com/questions/3928995/how-do-cache-lines-work">cache line</a>, together.</p><p>For example, take unicode encoded in utf-8. If you were to store that in memory and access it most efficiently in terms of word alignment and cache line alignment, I&#39;m wondering what that would look like / mean.</p><p>Some examples are:</p><ol><li>Accessing individual characters.</li><li>Accessing large blocks of text.</li></ol><p>From what it sounds like, on a 64-bit machine, you would do this (I&#39;m still a bit confused on how to apply it, which is the reason for the question), where the letters would be unicode encoded in ascii (for the simple case of utf-8, just using ascii):</p><pre><code>a b a b a b ...
</code></pre><p>That would look like:</p><pre><code>01100001 01100010 01100001 01100010 01100001 01100010 ...
</code></pre><p>Or more specifically:</p><pre><code>011000010110001001100001011000100110000101100010...
</code></pre><p>To add more characters to the mix (adding newlines for readability, not adding it to the data):</p><pre><code>abcdefghijklmnopqrstuvwxyz
abcdefghijklmnopqrstuvwxyz
...
abcdefghijklmnopqrstuvwxyz
</code></pre><p>That&#39;s 26 x n, where let&#39;s say n is 100, so 2600 8-bit characters (2600 bytes) stacked next to each other. From my understanding, you could say these are &#34;8-bit aligned&#34;, or &#34;1-byte aligned&#34;.</p><p>But now there are two problems:</p><ol><li>Word alignment (and how to figure out what your machine&#39;s word alignment is).</li><li>Cache line alignment (assuming all 64-bit machines use 64 bytes as cache line alignment, which is what I&#39;ve seen from the web).</li></ol><p>Since we have 2600 bytes, we could theoretically have 2600 / 64 = 40.625 ≈ 41 cache line aligned chunks, and if the word size was 2 bytes, then 2600 / 2 = 1300 word-aligned chunks.</p><p>Now I&#39;m lost, I don&#39;t see how we are supposed to access or alternatively organize the data so it takes advantage of these 2 alignment conditions (word and cache line alignment). I already feel like I&#39;m going to create more confusion than is necessary for the question if I try to explain more.</p><p>So my question is, how to (a) organize this utf-8 string in memory so that (b) you can take advantage of the 2 alignment conditions, while (c) accessing the data (either individual characters, or chunks between word size and cache line size, or or chunks larger than cache line size). I don&#39;t really know what &#34;accessing larger than 64 bits at a time&#34; would mean, since registers are limited like that. So again, don&#39;t really understand how the cache alignment works, and interested to know how to align to both conditions properly in this case as a practical example.</p><p>Sidenote: I don&#39;t need to know exactly how to do it for x86, like which instructions to use and whatnot (unless it is easy / straightforward to describe). I am just looking for at a high level how it works, using x86 as a starting point.</p><p>Another way I try looking at this comes after <a href="https://software.intel.com/en-us/articles/data-alignment-when-migrating-to-64-bit-intel-architecture" rel="nofollow noreferrer">reading</a>:</p><blockquote><ul><li>Align 8-bit data at any address [don&#39;t understand this]</li><li>Align 16-bit data to be contained within an aligned four-byte word</li><li>Align 32-bit data so that its base address is a multiple of four</li><li>Align 64-bit data so that its base address is a multiple of eight</li><li>Align 80-bit data so that its base address is a multiple of sixteen</li><li>Align 128-bit data so that its base address is a multiple of sixteen</li></ul></blockquote><p>Don&#39;t quite follow exactly, but say for 8-bit data we align to a 4-byte word. That means it would look like this:</p><pre><code>&lt;letter&gt; &lt;empty&gt; &lt;empty&gt; &lt;empty&gt; &lt;letter&gt; &lt;empty&gt; &lt;empty&gt; &lt;empty&gt; ...
</code></pre><p>So:</p><pre><code>a---b---a---b---...
</code></pre><p>That seems like a lot of wasted space. That would mean that plain text requires 4x the actual size of the text to store in memory, which doesn&#39;t seem right.</p><p>Finally, when they talk about how if you <em>don&#39;t</em> align to the boundaries, it will fetch the extra data, I keep thinking &#34;won&#39;t it do a fetch for the empty space anyways&#34;. I don&#39;t see how if the memory is full or not at a specific point that fetching some extra data would be harmful. That is to say, say the data was like this:</p><pre><code>abcdef...
</code></pre><p>And 4-byte aligned. That means to access <code>a</code> we would be actually fetching <code>abcd</code>, to fetch <code>b</code> it would also fetch <code>abcd</code>, etc.. But I don&#39;t see how that is any different from fetching <code>a---</code> in this layout:</p><pre><code>a---b---c---d---e---f---...
</code></pre></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>To understand how alignment affects things, let&#39;s look at a larger context.</p><p>First, as you note, 2600 bytes of UTF-8 (or any kind of data) will indeed take 2600 bytes.</p><p>If you allocate 2600 bytes from the heap using <code>malloc(2600)</code> e.g. in C, then since malloc does not accept alignment information, it will not know that you&#39;re intent is to store only individual bytes — it assumes worst case, which is that you&#39;re using the memory for the largest native type that the processor supports.  In the case of 64-bit processor that is going to be 16 bytes, which is rather large.</p><p>So, the memory allocator locates free memory that matches the 16-byte alignment (and at least 2600 bytes in length).  A later memory allocation via <code>malloc</code> will also be rounded up to 16-byte alignment, so there will be a small gap between the 2600 byte chunk and the next memory block returned by malloc, because 2600 is an exact multiple of 8 but not of 16.  (There are also potentially other overheads associate with each malloc block as well.)</p><p>Both Linux &amp; Windows offer an aligned malloc; however, Linux explicit states that the minimum alignment is pointer size.  Even on Windows, which doesn&#39;t say, it is clear from the documentation that the authors expect larger alignments to be requested, not smaller alignments.</p><p>C will create structures with proper field alignment for the target platform, meaning that it will insert unused pad bytes within a <code>struct</code> if the preceding fields do not layout such that the proper alignment can be had.  For example:</p><pre><code>struct S {
   char c;
   int  i;
}
</code></pre><p>Struct <code>S</code> declares <code>c</code>, as a 1-byte item, and it will be at offset 0 in the struct.  The field <code>i</code>, is, let&#39;s say, a 4-byte item.  After <code>c</code> the next available offset is 1 but that is not suitably aligned for a 4-byte value, so the compiler will insert 3 padding bytes and use offset 4 for <code>i</code>, making the size of the struct <code>sizeof(struct S)</code> is 8, even though it only stores 5 bytes of information.</p><p>Let&#39;s also talk about endian-ness.  If you have a string of bytes, then each succesive byte is stored at the next higher byte address (just add 1 to the address to get to the next one) — However, big-endian machines store the 4 bytes needed to make up a 4-byte word reversed from little-endian machines.  So, if you wanted to use word-sized access on your string &#34;abcd&#34;, you would see a difference between a big and little-endian machine: the big-endian machine would give you &#39;abcd&#39; whereas the little-endian machine will give you &#39;dcba&#39;.</p><p>In summary, it is generally best not to use the same memory both as bytes and as words (at the same time): if it holds bytes, then use byte-sized access, and if it holds words, then use word-sized access.  Note this will naturally happen unless you do &#34;bad things&#34; like cast pointers to a type other than what they originally pointed to.  (There are times when you might need to, and, authors of routines like <code>memcpy</code> and <code>memmove</code> play some tricks for performance.)  We can also note that it is not even possible to mix byte-sized and word-sized accesses (for the same data/object/array) in a language like Java (without resorting to serialization) since it doesn&#39;t offer the low-level feature of casting pointers.</p><p>The compiler and runtime (e.g. malloc) cooperate to make sure your data is properly aligned (perhaps even if over-aligned).  For example, the stack, before <code>main</code>, should be initially aligned (by the runtime) to at least a 16-byte boundary, and then the compiler can create stack frames that are rounded up to a 16-byte size so the stack and all local variables remain aligned during function calls.  Global variables get similar treatment, and we have already discussed heap allocations.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../is-utf-16-fixed-width-or-variable-width-why-doesnt-utf-8-have-byte-order-problem/'>Is UTF-16 fixed-width or variable-width?  Why doesn&#8217;t UTF-8 have byte-order problem</a></li><li class="list-group-item"><a href='../a-unicode-sentinel-value-i-can-use/'>A Unicode sentinel value I can use</a></li><li class="list-group-item"><a href='../why-does-charset-really-mean-encoding-in-common-usage/'>Why does &#8220;charset&#8221; really mean &#8220;encoding&#8221; in common usage</a></li><li class="list-group-item"><a href='../relation-between-cache-line-and-memory-page/'>Relation between cache line and memory page</a></li><li class="list-group-item"><a href='../how-should-i-handle-the-fetching-of-cached-data-in-ios/'>How should I handle the fetching of cached data in iOS</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>