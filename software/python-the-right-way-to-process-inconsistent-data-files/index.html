<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Python &#8211;  the right way to process inconsistent data files &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1076198 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1076198" class="post-1076198 software type-software status-publish hentry category-software tag-design tag-etl tag-python"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Python &#8211;  the right way to process inconsistent data files</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">design</span><span class="mr-2 badge badge-info">etl</span><span class="mr-2 badge badge-warning">python</span></p><div class="entry-content"><p>I&#39;m working at a company that uses Excel files to store product data, specifically, test results from products before they are shipped out. There are a few thousand spreadsheets with anywhere from 50-100 relevant data points per file. Over the years, the schema for the spreadsheets has changed significantly, but not unidirectionally &#8211; in the sense that, changes often get reverted and then re-added in the space of a few dozen to few hundred files. My project is to convert about 8000 of these spreadsheets into a database that can be queried. I&#39;m using MongoDB to deal with the inconsistency in the data, and Python.</p><p>My question is, what is the &#34;right&#34; or canonical way to deal with the huge variance in my source files? I&#39;ve written a data structure which stores the data I want for the latest template, which will be the final template used going forward, but that only helps for a few hundred files historically. Brute-forcing a solution would mean writing similar data structures for each version/template &#8211; which means potentially writing hundreds of schemas with dozens of fields each. This seems very inefficient, especially when sometimes a change in the template is as little as moving a single line of data one row down or splitting what used to be one data field into two data fields.</p><p>A slightly more elegant solution I have in mind would be writing schemas for all the variants I can find for pre-defined groups in the source files, and then writing a function to match a particular series of files with a series of variants that matches that set of files. This is because, more often that not, most of the file will remain consistent over a long period, only marred by one or two errant sections, but inside the period, which section is inconsistent, is inconsistent.</p><p>For example, say a file has four sections with three data fields, which is represented by four Python dictionaries with three keys each.</p><p>For files 7000-7250, sections 1-3 will be consistent, but section 4 will be shifted one row down. For files 7251-7500, 1-3 are consistent, section 4 is one row down, but a section five appears. For files 7501-7635, sections 1 and 3 will be consistent, but section 2 will have five data fields instead of three, section five disappears, and section 4 is still shifted down one row. For files 7636-7800, section 1 is consistent, section 4 gets shifted back up, section 2 returns to three cells, but section 3 is removed entirely. Files 7800-8000 have everything in order.</p><p>The proposed function would take the file number and match it to a dictionary representing the data mappings for different variants of each section. For example, a section_four_variants dictionary might have two members, one for the shifted-down version, and one for the normal version, a section_two_variants might have three and five field members, etc. The script would then read the matchings, load the correct mapping, extract the data, and insert it into the database.</p><p>Is this an accepted/right way to go about solving this problem? Should I structure things differently? I don&#39;t know what to search Google for either to see what other solutions might be, though I believe the problem lies in the domain of ETL processing. I also have no formal CS training aside from what I&#39;ve taught myself over the years. If this is not the right forum for this question, please tell me where to move it, if at all. Any help is most appreciated.</p><p>Thank you.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>Most IT &#34;patterns&#34; deal with repeatable, reproducible situations. Yours is exactly the opposite. You&#39;ve got truly dirty data: Not just dirty instances, but changing, inconsistent, and occasionally erroneous schema, varying over time. <em>Oy vey!</em></p><p>I don&#39;t know of a canonical, widely-accepted &#34;best practice&#34; name for dealing with such an irregular dataset, but cleaning up a largely- but incompletely-structured set of files is a common ETL problem. I call the pattern I use <strong>The Spice Must Flow</strong>. If you want to be very fancy, it&#39;s a variation on <a href="http://en.wikipedia.org/wiki/Management_by_exception" rel="nofollow">Management by Exception</a>, augmented with agile/incremental development and an understanding of <a href="http://en.wikipedia.org/wiki/Orders_of_approximation" rel="nofollow">successive approximation</a>.</p><p><strong>Good News / Bad News</strong></p><p>The bad news: By definition, you don&#39;t know exactly which parts of the files are good, how they&#39;re structured, whether the individual data elements are internally consistent, or where errors may crop up.</p><p>But, there&#39;s plenty of good news: People who collect data usually intend for it to be useful, even if they&#39;re somewhat haphazard when recording it. Large swaths of your files will be comprehensible. You didn&#39;t provide examples of the data, but from your description, you have maybe at most 12 different schema? And most of those seem to be variations, rather than wholly new or alien entities.</p><p><strong>The Process</strong></p><p>First create parsers/handlers for one (or a few) of the larger swaths of data that you can readily handle. When you encounter parts of the dataset you can&#39;t yet handle, write those parts to &#34;remainders&#34; or &#34;leftovers&#34; files for subsequent handling. Ideally this determination can be made mechanically, by the program. Occasionally, it&#39;s human judgment that dictates some sections are wrong/different/need special handling. In those cases, you will have to more explicitly direct that some files/parts of files be processed or directed to leftovers.</p><p>Next write a parser for one or two of the odd cases you couldn&#39;t manage earlier. Run those, processing the original leftovers, creating a second-generation leftovers file. Iterate this &#34;write parser/handler, run, create leftovers&#34; process until you have no further leftovers.</p><p>It&#39;s appealing to think that you could create enough parsers/handlers to deal with your entire dataset in one fell swoop. In my experience, that&#39;s rarely feasible or desirable. The process is fundamentally one of discovery. Unless your dataset is very small and regular, you probably have not observed/understood all the possible quirks, variations, and errors up-front. Even if you know a lot about them, you probably won&#39;t catch them all. Theory says there are an infinite number of possible variations; while the practical variations are fewer, they&#39;re often confounding. An agile/adaptive approach that assumes from the start that you don&#39;t know all the possible variations/errors is more realistic and less frustrating. It also encourages you to add many more checks and assertions into your handlers, which usually lead to further discoveries about the data formatting and structure, and bring to light other possible errors. Management by exception is all about handling the cases you can, with the lowest overhead and highest automation possible, setting aside the exceptions for further scrutiny and higher-touch fixes.</p><p>As you go through this process, you may decide to commit the data you have successfully parsed to your final dataset, then incrementally extend your &#34;clean&#34; dataset with the subsequent processing passes. Alternatively, you may decide to use the processing passes as primarily exploratory steps, then run the whole shebang from scratch once you&#39;ve achieved zero-leftovers. The decision will be based on how much data you have, whether it&#39;s possible and/or valuable to use initial data even in an incomplete form, and whether any pass&#39;s discoveries have invalidated parsing/processing assumptions made on previous passes. If you have a very large amount of data (thousands of files is getting there), and it is independently sequenceable (i.e., does not need to processed from start to finish to make sense of it), a more incremental approach is good. If, however, the items are not easily processed out of order, or there are later discoveries that invalidate earlier runs, re-runs from scratch become more necessary.</p><p>It is often the case in such projects that one does not create official schema for all the variations seen. The N different schema and variations get encoded into the parsing/handling code that translates existing data files into the new, cleaned file/database. That may not be ideal, but the general idea is that you&#39;ll create one clean new dataset, and then have a better, cleaner, and genuine schema for new additions to the dataset.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../python-parsing-scripts-that-use-curly-braces/'>Python &#8211; Parsing scripts that use curly braces</a></li><li class="list-group-item"><a href='../design-can-a-system-be-100-data-driven/'>Design &#8211; Can a system be 100% Data Driven</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>