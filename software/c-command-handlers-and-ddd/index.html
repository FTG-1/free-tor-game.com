<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>C# &#8211; Command handlers and DDD &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1069797 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1069797" class="post-1069797 software type-software status-publish hentry category-software tag-architecture tag-c tag-cqrs tag-domain-driven-design tag-validation"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">C# &#8211; Command handlers and DDD</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">Architecture</span><span class="mr-2 badge badge-info">c</span><span class="mr-2 badge badge-warning">cqrs</span><span class="mr-2 badge badge-primary">domain-driven-design</span><span class="mr-2 badge badge-danger">validation</span></p><div class="entry-content"><p>I have an ASP.NET MVC application, that uses a query service to get data and a command service to send commands. My question is about the command part.</p><p>If a request comes in, the command service uses a command dispatcher that will route the command to its designated command handler. This command handler validates the comand first and if everything is acceptable, it executes the command.</p><p>Concrete example: the AddCommentToArticleCommandHandler receives an AddCommentToArticleCommand, which has an ArticleId, CommentText and EmailAddress.</p><p>First; validation has to occur, like:<br /> &#8211; check if article exists<br /> &#8211; check if article is not closed<br /> &#8211; check if comment text is filled in and between 20 and 500 characters<br /> &#8211; check if email address is filled in and has a valid format.</p><p>I&#39;m wondering where to put this validation?</p><p>1/ in the command handler itself. But then, it cannot be reused in other command handlers.</p><p>2/ in the domain entity. But as a domain entity doesn&#39;t know about repositories or services, it cannot do the needed validation (cannot check whether an article exists). But on the other hand, if the entity doesn&#39;t contain logic, than it becomes a simple data container, which is not following DDD principles.</p><p>3/ the command handler uses validators, so that validation can be reused in other command handlers.</p><p>4/ Other mechanisms?</p><p>I&#39;m looking for the chain of responsibilities for this particular example and what objects (entities, repositories, &#8230;) play a role in it.</p><p>Do you have ideas on how you would implement this, starting from the command handler up to the repositories?</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>I think you need to separate two types of validation in this case; <em>domain validation</em> and <em>application validation</em>.</p><p>Application validation is what you have when you verify that the command property &#39;text&#39; is between 20 and 200 characters; so you validate this with the GUI and with a view-model-validator that also executes at the server after a POST. The same goes for e-mail (btw, I hope you realize that an e-mail such as `32.d+&#34;Hello World .42&#34;@mindom√§n.local&#34; is a valid according to the RFC).</p><p>Then you have another validation; check that article exists - you have to ask yourself the question why the article should not exist if there is indeed a command sent from the GUI that is about attaching a comment to it. Was your GUI eventually consistent and you have an aggregate root, the article, that can be physically deleted from the data store? In that case you just move the command to the error queue because the command handler fails to load the aggregate root.</p><p>In the above case, you would have infrastructure that handles poison messages - they would for example retry the message 1-5 times and then move it to a poision queue where you could manually inspect the collection of messages and re-dispatch those relevant. It&#39;s a good thing to monitor.</p><p>So now we&#39;ve discussed:</p><ul><li><p>Application validation</p><ul><li>With javascript in the GUI</li><li>With MVC-validation at the web server</li></ul></li><li><p>Missing aggregate root + poison queues</p></li></ul><p>What about commands that are out of sync with the domain? Perhaps you have a rule in your domain logic saying that after 5 comments to an article, only comments below 400 characters are allowed, but one guy was too late with the 5th comment and got to be the 6th - GUI didn&#39;t catch it because it was not consistent with the domain at the point of him sending his command - in this case you have a &#39;validation failure&#39; as a part of your domain logic and you would return the corresponding failure event.</p><p>The event could be in the form of a message onto a message broker or your custom dispatcher. The web server, if the application is monolithic, could synchronously listen for both a success event and the failure event mentioned and display the appropriate view/partial.</p><p>Often you have custom event that means failure for many types of commands, and it is this event that you subscribe to from the web server&#39;s perspective.</p><p>In the system that we are working on, we&#39;re doing request-response with commands/events over a MassTransit+RabbitMQ message bus+broker and we have an event in this particular domain (modelling a workflow in part) that is named <code>InvalidStateTransitionError</code>. Most commands that try to move along an edge in the state graph may cause this event to happen. In our case, we&#39;re modelling the GUI after an eventually consistent paradigm, and so we send the user to a &#39;command accepted&#39; page and thereafter let the web server&#39;s views update passively through event subscriptions. It should be mentioned that we are also doing event-sourcing in the aggregate roots (and will be doing for sagas as well).</p><p>So you see, a lot of the validation you are talking about are actually application-type validations, not actual domain logic. There&#39;s no problem in having a simple domain model if your domain is simple but you are doing DDD. As you continue modelling your domain, however, you&#39;ll discover that the domain might not be as simple as it first turned out. In many cases the aggregate root/entity might just accept a method invocation caused by a command and change some of its state without even performing any validation - especially if you trust your commands like you&#39;d do if you validate them in the web server that you control.</p><p>I can recommand watching the two presentations on DDD from <a href="http://s3.amazonaws.com/TheZenDev/files/NDC2011.torrent" rel="nofollow">Norwegian Developer Conference 2011</a> and also Greg&#39;s presentation at <a href="http://oredev.org/2010/videos" rel="nofollow">√ñredev 2010</a>.</p><p>Cheers,
Henke</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../where-to-put-format-validation-in-a-cqrs-stylish-domain-model/'>Where to put format validation in a CQRS ‚Äústylish‚Äù domain model</a></li><li class="list-group-item"><a href='../php-dtos-vs-domain-models-and-invoking-command-handlers-directly/'>Php &#8211; DTOs vs Domain Models and invoking Command Handlers directly</a></li><li class="list-group-item"><a href='../ddd-cqrs-per-query-and-per-command-authorization/'>DDD CQRS &#8211; per-query and per-command authorization</a></li><li class="list-group-item"><a href='../how-exactly-should-a-cqrs-command-be-validated-and-transformed-to-a-domain-object/'>How exactly should a CQRS Command be validated and transformed to a domain object</a></li><li class="list-group-item"><a href='../design-command-handling-fail-feedback-with-cqrs/'>Design &#8211; Command handling fail feedback with CQRS</a></li><li class="list-group-item"><a href='../in-a-domain-driven-development-ddd-have-a-validation-on-a-dto-that-calls-a-external-service-is-wrong-if-yes-where-should-it-be/'>In a Domain Driven Development DDD, have a validation on a DTO that calls a external service is wrong, if yes, where should it be</a></li><li class="list-group-item"><a href='../cqrs-using-queries-or-read-services-only/'>CQRS using queries or read services only</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>