<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Sharing of event source stream between aggregates &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1085222 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1085222" class="post-1085222 software type-software status-publish hentry category-software tag-aggregate tag-cqrs tag-domain-driven-design tag-event-sourcing"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Sharing of event source stream between aggregates</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">aggregate</span><span class="mr-2 badge badge-info">cqrs</span><span class="mr-2 badge badge-warning">domain-driven-design</span><span class="mr-2 badge badge-primary">event-sourcing</span></p><div class="entry-content"><p>I have a question related to cqrs + event sourcing. I have two aggregate roots (AR1 and AR2). When AR1 received a command/event it will be recreated from previous event sourcing stream from repository (in this case it will have list of some values x,y,z) and after updating internal state to (a,b,c,x,y,z) it will emit new events (a,b,c). This events will be fetched by AR2 and then processed. At the point when I need to recreate AR2 from event source stream, dashed layer inside AR2 should be excatly same as leyer inside AR1 &#8211; so there I should have (a,b,c,x,y,z).</p><p>One more notice &#8211; in AR2 this layer would be read-only = needed to do some business logic inside AR2.</p><p>The question is &#8211; could I use same events generated in AR1 inner layer to recreate AR2 dashed layer?</p><p>There is always option to duplicate data (have the same stream of events stored both in AR1 layer and in AR2 dashed layer) but this will just waste memory. Another option is always to send all the data from AR1 layer to AR2 whenever some event happens &#8211; in this case I would send also x,y,z together with a,b,c.</p><p>[UPDATE]<br /> It just came to my mind that I can model this as AR2 having reference to AR1 and asking AR1 each time for data. Just have to see how to handle this case since in CQRS aggregate cannot return data?</p><p><a href="../../../i.stack.imgur.com/chsnQ.jpg" rel="nofollow noreferrer"><img src="../../../i.stack.imgur.com/chsnQ.jpg" alt="Aggregate Roots Event"/></a></p><blockquote><p>What about this implementation with saga style below?</p></blockquote><p><a href="../../../i.stack.imgur.com/VRaCs.jpg" rel="nofollow noreferrer"><img src="../../../i.stack.imgur.com/VRaCs.jpg" alt="Saga aggregates communication"/></a></p><blockquote><p>Update: This is what I have so far &#8211; saga can be used for sending events transformed to commands from AR1 to AR2 (basically 2nd picture), but in case of instantiating new AR2 (green color in pic2 &#8211; that should not exist there actually), I do it from service layer like this:</p></blockquote><pre><code>namespace serviceLayer{

    public void createAr1AndAr2(Ar1Id idar1, Ar2Id idar2){
            var ar1 = getAr1FromRepo(iadr1);
            var ar2 = getAr2FromRepo(idar2);        //returns regularAr2 or nullObjectAr2
            ar1.doSmth(ar2);
    }

}

namespace domain{

    class Ar1 {
        List&lt;Smht&gt; partOfInnerState;

        void doSmth(Ar2 ar2){
            ar2.doSmth2(partOfInnerState);
        }
    }

    class regularAr2 extends Ar2{
        void doSmth(List&lt;Smht&gt; partOfInnerState){
                //we need only part of partOfInnerState
        }
    }

    class nullObjectAr2 extends Ar2{
        void doSmth(List&lt;Smht&gt; partOfInnerState){
                //we need full partOfInnerState in order to initialize this object for the first time
        }
    }
}
</code></pre></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><blockquote><p>This events will be fetched by AR2 and then processed.</p></blockquote><p>Ohh, that sounds like a bad idea.</p><blockquote><p>One more notice - in AR2 this layer would be read-only = needed to do some business logic inside AR2.</p></blockquote><p>So looking at your picture, AR2 is writing out events (d,e,f), which says that AR2 is not read only -- which is good; read only aggregate roots don&#39;t make sense.</p><p>The <em>usual</em> pattern for what you seem to be trying to do here is to use a <a href="http://www.enterpriseintegrationpatterns.com/patterns/messaging/ProcessManager.html" rel="nofollow noreferrer">process manager</a> to coordinate the activities of the two aggregate roots.  The role of the process manager is to listen for events, and respond by dispatching commands.</p><p>In that picture, you would have something like the following:</p><pre><code>Command(A) arrives at AR(1)
    AR(1) loads its history [x,y,z]
    AR(1) executes Command(A), producing events [a,b,c]
    AR(1) writes its new history [x,y,z,a,b,c]

Events(a,b,c) are published

ProcessManager receives the events (a,b,c)
    ProcessManager dispatches Command(B) to AR(2)

Command(B) arrives at AR(2)
    AR(2) loads its own history [d,e,f]
    AR(2) executes Command(B), producing events [g,h]
    AR(2) writes its new history [d,e,f,g,h]

Events(g,h) are published
</code></pre><p>Trying to have two different aggregate roots share a common event history is really weird; it strongly suggests that your model needs rethinking (why are there two different authorities for the same fact? what happens when AR1 writes an event that violates the invariant enforced by AR2?).</p><p>But taking some of the state from one event, and making that an argument in a command sent to another aggregate; <em>that</em> pattern is pretty common.  The process manager itself is just a substitute for <a href="https://abdullin.com/post/ddd-evolving-business-processes-a-la-lokad/" rel="nofollow noreferrer">a human being reading the events</a> and deciding what commands to fire.</p><blockquote><p>I always need current state of AR1 layer, even if AR2 is created from the scratch it needs to have content of layer from AR1. The layer would be read only.</p></blockquote><p>There&#39;s no such thing as getting the &#34;current&#34; state of another aggregate; AR1 could be changing while AR2 is doing its work, and there&#39;s no way to know that.  If that&#39;s not acceptable, then your aggregate boundaries are in the wrong place.</p><p>If stale data is acceptable, you can have the AR2 command handler query the state of AR1, and use that information in processing the command.  If you are going to do that, I normally prefer to wrap the query in a Domain Service, which gives you an extra layer of indirection to work with (the domain model doesn&#39;t need to know how the service is implemented).  In this design, AR2 doesn&#39;t see the AR1 events at all; AR2 passes some state to the domain service, and the domain service looks at the events to figure out the answer, and passes that answer back as a value that AR2 will understand.</p><p><a href="http://danielwhittaker.me/2014/11/22/4-secrets-inter-aggregate-communication-event-sourced-system/" rel="nofollow noreferrer">Whittaker&#39;s</a> solution isn&#39;t bad; once you recognize that the data is stale <em>anyway</em>, you have the option of deciding whether the state available at the time of creating the command is good enough.  I&#39;m of mixed minds on this -- putting everything into the command is nice, and really easy to understand.  On the other hand, there is a larger window for a change to happen, and to some degree discovering the right data to use requires accessing state internal to the aggregate that can change while the command is in flight.</p><p>I much prefer designs where the aggregates aren&#39;t coupled, though.</p><blockquote><p>But it seems that this is again sharing of data between the AR-s, since fat command will use data from layer from AR1 to supply to AR2</p></blockquote><p>You might look into what Udi Dahan has to say about <a href="http://udidahan.com/2010/11/15/the-known-unknowns-of-soa/" rel="nofollow noreferrer">services as technical authorities</a>.  In that case, the data that gets shared is mostly limited to opaque identifiers.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../ddd-saga-event-sourcing-can-a-compensate-action-simply-be-a-delete-on-the-event-store/'>DDD, Saga &#038; Event-sourcing: Can a Compensate Action simply be a delete on the event store</a></li><li class="list-group-item"><a href='../how-to-create-new-aggregate-root-in-cqrs/'>How to create new aggregate root in CQRS</a></li><li class="list-group-item"><a href='../ddd-event-handlers-and-aggregates-in-functional-programming/'>DDD: Event handlers and aggregates in functional programming</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>