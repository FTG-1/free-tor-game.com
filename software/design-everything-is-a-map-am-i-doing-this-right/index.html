<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Design &#8211; &#8220;Everything is a Map&#8221;, am I doing this right &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1068799 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1068799" class="post-1068799 software type-software status-publish hentry category-software tag-architecture tag-design tag-design-patterns tag-functional-programming"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Design &#8211; &#8220;Everything is a Map&#8221;, am I doing this right</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">Architecture</span><span class="mr-2 badge badge-info">design</span><span class="mr-2 badge badge-warning">design-patterns</span><span class="mr-2 badge badge-primary">functional programming</span></p><div class="entry-content"><p>I watched Stuart Sierra&#39;s talk &#34;<a href="http://www.infoq.com/presentations/Thinking-in-Data" rel="noreferrer">Thinking In Data</a>&#34; and took one of the ideas from it as a design principle in this game I&#39;m making. The difference is he&#39;s working in Clojure and I&#39;m working in JavaScript.  I see some major differences between our languages in that:</p><ul><li>Clojure is idiomatically functional programming</li><li>Most state is immutable</li></ul><p>I took the idea from the slide &#34;Everything is a Map&#34; (From 11 minutes, 6 seconds to &gt; 29 minutes in).  Some things he says are:</p><ol><li>Whenever you see a function that takes 2-3 arguments, you can make a case for turning it into a map and just passing a map in.  There are a lot of advantages to that:<ol><li>You don&#39;t have to worry about argument order</li><li>You don&#39;t have to worry about any additional information.  If there are extra keys, that&#39;s not really our concern.  They just flow through, they don&#39;t interfere.</li><li>You don&#39;t have to define a schema</li></ol></li><li>As opposed to passing in an Object there&#39;s no data hiding.  But, he makes the case that data hiding can cause problems and is overrated:<ol><li>Performance</li><li>Ease of implementation</li><li>As soon as you communicate over the network or across processes, you have to have both sides agree on the data representation anyway.  That&#39;s extra work you can skip if you just work on data.</li></ol></li><li><p><strong>Most relevant to my question. This is 29 minutes in:</strong> &#34;Make your functions composable&#34;. Here&#39;s the code sample he uses to explain the concept:</p><pre><code>;; Bad
(defn complex-process []
  (let [a (get-component @global-state)
        b (subprocess-one a) 
        c (subprocess-two a b)
        d (subprocess-three a b c)]
    (reset! global-state d)))

;; Good
(defn complex-process [state]
  (-&gt; state
    subprocess-one
    subprocess-two
    subprocess-three))
</code></pre><p>I understand the majority of programmers aren&#39;t familiar with Clojure, so I&#39;ll rewrite this in imperative style:</p><pre><code>;; Good
def complex-process(State state)
  state = subprocess-one(state)
  state = subprocess-two(state)
  state = subprocess-three(state)
  return state
</code></pre><p>Here are the advantages:</p><ol><li>Easy to test</li><li>Easy to look at those functions in isolation</li><li>Easy to comment out one line of this and see what the outcome is by removing a single step</li><li>Each subprocess could add more information on to the state.  If subprocess one needs to communicate something to subprocess three, it&#39;s as simple as adding a key/value.</li><li>No boilerplate to extract the data you need out of the state just so that you can save it back in.  Just pass in the whole state and let the subprocess assign what it needs.</li></ol></li></ol><p>Now, back to my situation:  I took this lesson and applied it to my game.  That is, almost all of my high level functions take and return a <code>gameState</code> object.  This object contains all the data of the game.  EG: A list of badGuys, a list of menus, the loot on the ground, etc.  Here&#39;s an example of my update function:</p><pre><code>update(gameState)
  ...
  gameState = handleUnitCollision(gameState)
  ...
  gameState = handleLoot(gameState)
  ...
</code></pre><p>What I&#39;m here to ask about is, <strong>have I created some abomination that perverted an idea that is only practical in a functional programming language?</strong> JavaScript isn&#39;t <em>idiomatically</em> functional (though it can be written that way) and it&#39;s really challenging to write immutable data structures.  One thing that concerns me is he <em>assumes</em> that each of those subprocesses are pure. Why does that assumption need to be made?  It&#39;s rare that any of my functions are pure (by that, I mean they often modify the <code>gameState</code>.  I don&#39;t have any other complicated side effects other than that).  Do these ideas fall apart if you don&#39;t have immutable data?</p><p>I&#39;m worried that one day I&#39;ll wake up and realize this whole design is a sham and I&#39;ve really just been implementing the <a href="http://en.wikipedia.org/wiki/Big_ball_of_mud" rel="noreferrer">Big Ball Of Mud anti-pattern</a>.</p><hr/><p>Honestly, I&#39;ve been working on this code for months and it&#39;s been great.  I feel like I&#39;m getting all the advantages he&#39;s claimed.  My code is super easy <em>for me</em> to reason about.  But I&#39;m a one man team so I have the curse of knowledge.</p><h1>Update</h1><p>I&#39;ve been coding 6+ months with this pattern. Usually by this time I forget what I&#39;ve done and that&#39;s where &#34;did I write this in a clean way?&#34; comes into play. If I haven&#39;t, I&#39;d really struggle. So far, I&#39;m not struggling at all.</p><p>I understand how another set of eyes would be necessary to validate its maintainability. All I can say is I care about maintainability first and foremost. I&#39;m always the loudest evangelist for clean code no matter where I work.</p><p>I want to reply directly to those that already have a bad personal experience with this way of coding.  I didn&#39;t know it then, but I think we&#39;re really talking about two different ways of writing code.  The way I&#39;ve done it appears to be more structured than what others have experienced.  When someone has a bad personal experience with &#34;Everything is a map&#34; they talk about how hard it is to maintain because:</p><ol><li>You never know the structure of the map that the function requires</li><li>Any function can mutate the input in ways you&#39;d never expect.  You have to look all over the code base to find out how a particular key got into the map or why it disappeared.</li></ol><p>For those with such an experience, perhaps the code base was, &#34;Everything takes 1 of N types of maps.&#34; Mine is, &#34;Everything takes 1 of 1 type of map&#34;. If you know the structure of that 1 type, you know the structure of everything.  Of course, that structure usually grows over time.  That&#39;s why&#8230;</p><p>There&#39;s one place to look for the reference implementation (ie: the schema). This reference implementation is code the game uses so it can&#39;t get out of date.</p><p>As for the second point, I don&#39;t add/remove keys to the map outside of the reference implementation, I just mutate what&#39;s already there. I also have a large suite of automated tests.</p><p>If this architecture eventually collapses under its own weight, I&#39;ll add a second update.  Otherwise, assume everything is going well ðŸ™‚</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>I&#39;ve supported an application where &#39;everything is a map&#39; before. It&#39;s a terrible idea. PLEASE don&#39;t do it!</p><p>When you specify the arguments that are passed to the function, that makes it very easy to know what values the function needs.  It avoids passing extraneous data to the function that just distracts th programmer - every value passed implies that it&#39;s needed, and that makes the programmer supporting your code have to figure out why the data is needed.</p><p>On the other hand, if you pass everything as a map, the programmer supporting your app will have to fully understand the called function in every way to know what values the map needs to contain.  Even worse, it&#39;s very tempting to re-use the map passed to the current function in order to pass data to the next functions.  This means that the programmer supporting your app needs to know all functions called by the current function in order to understand what the current function does.  That&#39;s exactly the opposite of the purpose for writing functions - abstracting problems away so that you don&#39;t have to think about them!  Now imagine 5 calls deep and 5 calls wide each.  That&#39;s a hell of a lot to keep in your mind and a hell of a lot of mistakes to make.</p><p>&#34;everything is a map&#34; also seems to lead to using the map as a return value.  I&#39;ve seen it.  And, again, it&#39;s a pain.  The called functions need to never overwrite each other&#39;s return value - unless you know the functionality of everything and know that the input map value X needs to be replaced for the next function call.  And the current function needs to modify the map to return it&#39;s value, which must sometimes overwrite the previous value and must sometimes not.</p><p><strong>edit - example</strong></p><p>Here&#39;s an example of where this was problematic.  This was a web application.  User input was accepted from the UI layer and placed in a map.  Then functions were called to process the request.  The first function set would check for erroneous input.  If there was an error, the error message would be put in the map.  The calling function would check the map for this entry and write the value in the ui if it existed.</p><p>The next function set would start the business logic.  Each function would take the map, remove some data, modify some data, operate on the data in the map and put the result in the map, etc.  Subsequent functions would expect results from prior functions in the map.  In order to fix a bug in a subsequent function, you had to investigate all prior functions as well as a the caller to determine everywhere the expected value might have been set.</p><p>The next functions would pull data from the database.  Or, rather, they&#39;d pass a the map to the data access layer.  The DAL would check if the map contained certain values to control how the query executed.  If &#39;justcount&#39; was a key, then the query would be &#39;count select foo from bar&#39;.  Any of the functions that was previously called might have ben the one that added &#39;justcount&#39; to the map.  The query results would be added to the same map.</p><p>The results would bubble up to the caller (business logic) which would check the map for what to do.  Some of this would come from things that were added to the map by the initial business logic. Some would come from the data from the database.  The only way to know where it came from was to find the code that added it.  And the other location that can also add it.</p><p>The code was effectively a monolithic mess, that you had to understand in it&#39;s entirety to know where a single entry in the map came from.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../in-functional-programming-does-having-most-of-the-data-structures-immutable-require-more-memory-usage/'>In functional programming, does having most of the data structures immutable require more memory usage</a></li><li class="list-group-item"><a href='../java-how-to-refactor-a-java-singleton-to-clojure/'>Java &#8211; How to refactor a Java singleton to Clojure</a></li><li class="list-group-item"><a href='../c-when-programming-in-functional-style-do-you-have-a-single-application-state-that-you-weave-through-the-application-logic/'>C# &#8211; When programming in Functional style, do you have a single application state that you weave through the application logic</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>