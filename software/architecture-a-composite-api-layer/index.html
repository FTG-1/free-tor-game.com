<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Architecture &#8211; A &#8220;Composite API&#8221; layer &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1075816 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1075816" class="post-1075816 software type-software status-publish hentry category-software tag-api-design tag-architecture tag-soa"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Architecture &#8211; A &#8220;Composite API&#8221; layer</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">api-design</span><span class="mr-2 badge badge-info">Architecture</span><span class="mr-2 badge badge-warning">soa</span></p><div class="entry-content"><p>We are giving services a complete overhaul at work: Swapping soap for rest, resculpting the domains to give better separation of concerns, etc.</p><p>These new services will be publicly available. During one of our on-going conversations to refine our architectural vision, the idea of a &#34;Composite API&#34; was introduced. I am hoping to get some community feedback regarding the validity of this approach. I will list the pros and cons as I understand them. Disclaimer: I am no SOA expert</p><p><strong>Pros</strong></p><ol><li>Clients will received fully hydrated objects instead of having to make multiple service calls to compose something useful</li><li>A&amp;A is isolated to one place and does not need to muddy service behavior</li></ol><p><strong>Cons</strong> (again, this is purely my understanding).</p><p><strong>Composed resources obscure the security of individual resources</strong> <br /> <strike>Requesting an individual child resource might return a 403, but requesting a parent resource returns a 200 with content and is missing parts of the data. While this may be acceptable client-side, I feel it&#39;s a bit or a risk server-side. Developers will have to maintain the security of the individual resources in one way, and the security of composed resources in another.</strike></p><p>After reading <a href="http://martinfowler.com/articles/microservices.html" rel="nofollow">Martin Fowler&#39;s article on microservices</a>, I do think the domain service should govern the actual write, but this doesn&#39;t necessarily contradict the API gateway.</p><p><strong>Complicated reads/writes based on user role</strong> <br /> <strike><br /> Basically, we may serve some info on a dto that some users should not see. Serving the id is not an issue, but serving the object that the id represents is. Of course, the composite api could simply not serve the object, but that&#39;s when the real problem comes. The back-end service no longer cares who the user is, only that the dto contains all necessary information to complete a write successfully. If we naively send null for a field because the client didn&#39;t have it, we&#39;d blow away valid data. This means the composite layer must somehow fetch the existing object and merge with the pending request to make sure the appropriate writes happen. If we control what fields are updated within the respective service, it&#39;s as simple as not changing the field before writing to the database. If not, it seems like a lot more work.</strike></p><p>Positing the API gateway leaves 2 options:</p><ol><li>Let the composite api construct the aggregated response</li><li>Allow each domain service to construct a fully hydrated response, but only accept trimmed requests.</li></ol><p>Option 1 does seem to be the least amount of code.</p><p><strong>Consolidated A&amp;A, not quite</strong> <br /> <strike><br /> For better or worse, we still have audit fields on a lot of tables. This means we need to include the username on an UpdatedBy field. Because the payload may have many entities on it and because we don&#39;t care about the audit fields client-side, we left them off the service DTOs. Instead, we are now passing custom headers into each service that contains the userId, username, and potentially the user roles. When the request hits the client, we convert those headers into something that will be available in the code block where we are creating/updating the domain models. I feel like there are plenty of plugins for various frameworks and platforms do this for us if we change our services to rely on an auth protocol, namely OAuth. Internally users/apps, and external users/apps should hit a common auth provider, get a token, and consume services as allowed. This makes each service responsible for controlling how a write should happen, which I kinda think is best place for that logic.</strike></p><p>While passing the header works when there is a header, it doesn&#39;t work so well when there isn&#39;t. Say we have a backend service that needs to call a domain service. We could leverage the same authentication protocol a user would have, which isn&#39;t bad. Now say that backend service is doing work on a user&#39;s behalf. How would we distinguish the service acting on its own from the service acting on a behalf of a user? Perhaps it&#39;s best to keep the domain services behind the API gateway for external use and allow backend services to use custom headers to simulate who the user was.</p><p><strong>Payload size</strong><br /> <strike><br /> The client will have to fetch all of the data either way, but does it really need to write it all back? Why can&#39;t we just send ids?</strike></p><p>It can send back the ids. The domain service will expect that, and the API gateway will act as a reverse proxy in that sense.</p><p><strong>Domain ambiguity</strong> <br /> If a client receives a composed object within one request, they get the impression they can put the resource back with modifications anywhere, even if some of those parts came from some other domain. Responding with ids only removes this ambiguity.</p><p><strong>Concurrency</strong> <br /> We&#39;d have to expose data versions on the DTOs, and potentially versions on parts of the DTOs, hope for a good write, relay a failure back to the client, and determine which part of the transaction failed. Granted, this is true with any transactional write where &#34;last in wins&#34; is unacceptable. I think it just exacerbates the problem.</p><p><strong>Service versioning requires more coupling</strong> <br /> For mobile clients, service versioning is a big deal, so we&#39;ll already have service versioning. With a composite api, we now need to support versioning in a third place. Not the worst thing ever, but still, I&#39;d rather not.</p><p><strong>Strongly-typed clients may require more work to adapt</strong> <br /> Consider the relationship between a lookup object and a hydrated dto that is composed with that lookup object. When the lookup object changes server-side, it will have to change in two places client-side, once on the lookup, and once on the hydrated object. If we choose not to compose them, the client only needs to send back ids to the server.</p><p><strong>Why not just introduce an ESB</strong><br /> <strike><br /> If we really need this, why not use an existing product instead of writing another service that is coupled to all the other services?</strike></p><p>It looks like the API gateway is between the client and domain services, whereas an ESB might not be. In a lot of ways they are very similar. I&#39;m still comparing the two.</p><p>I poured it on a little at the end, but I think these are all valid concerns. Anyway, I&#39;d like to get a lot of feedback on this.</p><hr/><p>I finally found some documenation:</p><ul><li><a href="http://microservices.io/patterns/apigateway.html" rel="nofollow">Microservices.io: API Gateway Pattern</a></li><li><a href="http://techblog.netflix.com/2013/01/optimizing-netflix-api.html" rel="nofollow">Optimizing the Netflix API</a></li></ul></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>As for this part:</p><blockquote><p>Clients will received fully hydrated objects instead of having to make
 multiple service calls to compose something useful</p></blockquote><p>Take a look at this nice article: <a href="http://www.vinaysahni.com/best-practices-for-a-pragmatic-restful-api" rel="nofollow">Best Practices for Designing a Pragmatic RESTful API</a>. It contains some nice pieces of wisdom, one of them is the suggestion to give API clients the ability to decide how much information is returned in each call, by using an <code>embed</code> parameter in the query string that contains a comma separated list of the dependend entities that should be returned. For example: <code>GET customers/1234?embed=invoices,messages</code>.</p><p>This way you let the client to decide whether it wants to performs many small queries to your API or just a single big one.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../soa-microservices-how-to-handle-authorization-in-inter-services-communications/'>SOA/Microservices: How to handle authorization in inter-services communications</a></li><li class="list-group-item"><a href='../use-dto-pattern-or-serialize-domain-objects/'>Use DTO Pattern or Serialize Domain Objects</a></li><li class="list-group-item"><a href='../architecture-preventing-abuse-of-api-which-is-called-via-client-side-javascript/'>Architecture &#8211; Preventing abuse of API which is called via client side Javascript</a></li><li class="list-group-item"><a href='../rest-support-multiple-request-formats-for-single-rest-endpoint/'>Rest &#8211; Support multiple request formats for single REST endpoint</a></li><li class="list-group-item"><a href='../architecture-microservice-architecture-for-multiple-composite-data-entities/'>Architecture &#8211; Microservice architecture for multiple composite data entities</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>