<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>C# &#8211; Dependency injection for a library with internal dependencies &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1065955 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1065955" class="post-1065955 software type-software status-publish hentry category-software tag-c tag-dependency-injection tag-inversion-of-control tag-net"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">C# &#8211; Dependency injection for a library with internal dependencies</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">c</span><span class="mr-2 badge badge-info">dependency-injection</span><span class="mr-2 badge badge-warning">inversion-of-control</span><span class="mr-2 badge badge-primary">net</span></p><div class="entry-content"><p><strong>Background</strong></p><p>I am working on a class library in support of a web site.  The library combines related APIs from several different vendors, all of which have their own particular nuances and domain objects.  As an example, imagine there is a credit card provider that exposes a <code>BankAccount</code> object, a loans provider that exposes an <code>Account</code>, and a checking account system exposes an <code>AccountDto</code>.  The primary design goal of the library is to hide these various implementations and allow the web site to work with a single concept of <code>Account</code>, with a set of services that decide which vendor to call and how to coordinate the data from the various sources.</p><p>To hide the confusion and keep the API clean, only my own domain objects and services are <code>public</code>.  Inside the library, each vendor has its own <a href="https://msdn.microsoft.com/en-us/library/ff649690.aspx" rel="noreferrer">repository</a> and domain objects.  The vendor&#39;s classes are all marked <code>internal</code> to keep the web developers from circumventing the services layer (either intentionally or unintentionally).</p><p>So the flow goes like this:</p><blockquote><p>Web Site &gt;&gt;  My API &gt;&gt; Service Layer (public) &gt;&gt; Repository Layer (internal)</p></blockquote><p>This solution uses dependency injection and the Unity IoC container.  My APIs&#39; services are registered in the composition root and injected directly into the web sites&#39; controllers as constructor arguments.  All of this works fine.</p><p><strong>The problem</strong></p><p>Here is the problem I am struggling with.  My services have constructor arguments that allow the repositories to be injected into them.  But the repositories are <code>internal</code> so the web site cannot register them in the composition root (without doing something truly bizarre with Reflection).  Plus I don&#39;t want the web site developers to worry about injecting them.</p><p>So the question is: How do I inject the internal/private repositories into the public service layer, while adhering to the accepted conventions in a DI approach?</p><p><strong>My proposed solution</strong></p><p>The way I am doing this right now is as follows:</p><p>I have added an abstract <code>RepositoryLocator</code> interface and class to the library. It has its own Unity container. It is left unsealed so that a unit testing project can derive its own version and substitute stub repositories.</p><pre><code>public interface IRepositoryLocator
{
    T GetRepository&lt;T&gt;() where T : IRepository;
}

public abstract class BaseRepositoryLocator : IRepositoryLocator
{
    protected readonly UnityContainer _container = new UnityContainer();

    public virtual T GetRepository&lt;T&gt;() where T : IRepository
    {
        return _container.Resolve&lt;T&gt;();
    }
}
</code></pre><p>Then I added a <code>DefaultRepositoryLocator</code> to my library that is hardcoded to provide the production runtime repositories.</p><pre><code>public sealed class DefaultRepositoryLocator : BaseRepositoryLocator
{
    public DefaultRepositoryLocator()
    {
        RegisterDefaultTypes();
    }
    private void RegisterDefaultTypes()
    {
        _container.RegisterType&lt;IVendorARepository, VendorARepository&gt;();
        _container.RegisterType&lt;IVendorBRepository, VendorBRepository&gt;();
        _container.RegisterType&lt;IVendorCRepository, VendorCRepository&gt;();
    }
}
</code></pre><p>Then in my services classes, instead of injecting repositories, I inject the repository <em>locator</em>, and pull out the repositories that are needed in the constructor.</p><pre><code>public class AccountService : IAccountService
{
    internal readonly IVendorARepository _vendorA;
    internal readonly IVendorBRepository _vendorB;

    public AccountService(IRepositoryLocator repositoryLocator)
    {
        _vendorA = repositoryLocator.GetRepository&lt;IVendorARepository&gt;();
        _vendorB = repositoryLocator.GetRepository&lt;IVendorBRepository&gt;();
    }
}
</code></pre><p><strong>The web development team&#39;s only task</strong></p><p>In the web site&#39;s composition root, they just need to register the default repository locator in their Unity container.</p><pre><code>container.RegisterType&lt;IRepositoryLocator, DefaultRepositoryLocator&gt;();
</code></pre><p>Once they do that, the Unity container injects the repository locator into all the services that are injected into controllers, and the services can retrieve the repositories they need.</p><p><strong>Unit testing</strong></p><p>In a unit testing project, the unit testing assembly will be given access to the internal members using the <a href="https://msdn.microsoft.com/en-us/library/system.runtime.compilerservices.internalsvisibletoattribute(v=vs.110).aspx" rel="noreferrer">InternalsVisibleTo attribute</a>, and the test project would substitute its own <code>StubRepositoryLocator</code> conformed to the internal-but-now-public interfaces.</p><p><strong>Things that are troublesome about this design</strong></p><p>So, all you IoC experts, what sort of problems have I created?  Here&#39;s what I worry about</p><ol><li>There are two Unity containers, one in the web application and one in the library&#39;s <code>RepositoryLocator</code>.  I hear there really ought to be only one, but I also read that it is an anti-pattern to pass it around.</li><li>The RepositoryLocator is hardcoded for production runtime. I don&#39;t think harcoding is a cardinal sin like many engineers do, but I do regard it with suspicion.</li><li><p>The unit testing project will need <a href="https://msdn.microsoft.com/en-us/library/system.runtime.compilerservices.internalsvisibletoattribute(v=vs.110).aspx" rel="noreferrer">InternalsVisibleToAttribute</a> added to the library. This is definitely a code smell and I wonder how we would deal with it if the unit testing project changes its name or if there needs to be several of them.</p></li><li><p>The constructors for my services take one injection for the <code>RepositoryLocator</code> itself, instead of separate injections for the individual repositories.  This conceals the individual dependencies at compile time.</p></li></ol><p>Is there an approach that resolves these issues and is consistent with IoC best practices, while still concealing the repository layer behind <code>internal</code> scope?</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><blockquote><p>In the web site&#39;s composition root, they just need to register the default repository locator</p></blockquote><p>IMO the web site doesn&#39;t even need to know about your repositories. As you said, the repos and vendors classes are internal, so your site should not worry about accessing them or injecting them into somewhere. Again, as you said, it is your library&#39;s role to abstract multiple vendors and expose a simpler API to the user (which is the web site in your example).</p><p>Having said that, I think you should:</p><ul><li>In your API, provide some initial entry point method, that needs to be executed once by the client in order that your library works appropriately;</li><li>Within this method (that&#39;s within your library), you configure the container with vendors repositories classes (internal to your library);</li><li>Keep vendors stuff private and your services public</li><li>That&#39;s it: your client (the website) need to worry only about injecting your services, nothing more than that.</li><li>Optional: you could use configuration file to bind interfaces and implementations</li></ul><p>About your question / worries:</p><ol><li>You (usually) have no control about what your client will do; the client app might not even inject your classes, it could just use them right away; so don&#39;t worry about that, like said in the comments;</li><li>Config file might be a better approach for this, easily changeble for production or test environments;</li><li>Regarding unit testing purposes, I see no problem with this attribute;</li><li>My suggestion solves this</li></ol></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../dependency-injection-ioc-container-practices-when-writing-frameworks/'>Dependency Injection/IoC container practices when writing frameworks</a></li><li class="list-group-item"><a href='../acceptable-placement-of-the-composition-root-using-dependency-injection-di-and-inversion-of-control-ioc-containers/'>Acceptable placement of the composition root using dependency injection (DI) and inversion of control (IoC) containers</a></li><li class="list-group-item"><a href='../c-organising-data-access-for-dependency-injection/'>C# &#8211; Organising data access for dependency injection</a></li><li class="list-group-item"><a href='../ioc-unity-and-passing-parameters-or-a-way-to-avoid-doing-so/'>IoC, Unity and passing parameters (or a way to avoid doing so)</a></li><li class="list-group-item"><a href='../c-dependency-injection-with-adapter-pattern/'>C# Dependency Injection with Adapter Pattern</a></li><li class="list-group-item"><a href='../c-unity-dependency-injection-and-helper-functions/'>C# &#8211; Unity Dependency Injection and Helper functions</a></li><li class="list-group-item"><a href='../handling-disposables-with-dependency-injection/'>Handling disposables with dependency injection</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>