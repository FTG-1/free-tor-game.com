<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="https://free-tor-game.com/wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Implementing a hash table with true concurrency &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.min.js?ver=11.2.0' id='highlight-js'></script>     <script>( function( w, d, s, l, i ) {
				w[l] = w[l] || [];
				w[l].push( {'gtm.start': new Date().getTime(), event: 'gtm.js'} );
				var f = d.getElementsByTagName( s )[0],
					j = d.createElement( s ), dl = l != 'dataLayer' ? '&l=' + l : '';
				j.async = true;
				j.src = 'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
				f.parentNode.insertBefore( j, f );
			} )( window, document, 'script', 'dataLayer', ' ' );</script>      <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1073757 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="https://free-tor-game.com/3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="https://free-tor-game.com/contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1073757" class="post-1073757 software type-software status-publish hentry category-software tag-concurrency tag-design-patterns tag-hashtable tag-multithreading tag-mutex"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Implementing a hash table with true concurrency</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">concurrency</span><span class="mr-2 badge badge-info">design-patterns</span><span class="mr-2 badge badge-warning">hashtable</span><span class="mr-2 badge badge-primary">multithreading</span><span class="mr-2 badge badge-danger">mutex</span></p><div class="entry-content"><p>This was recently a question I was asked in a screening and it got me thinking.  I never totally settled on how the conversation ended, and I did some digging.  None of the answers I saw seemed satisfactory to me.</p><p>The question is essentially &#34;how would you implement a thread safe hash map?&#34; Obviously protect with a mutex, but then you have to deal with contention of multiple threads waiting on a single mutex which means access isn&#39;t truly concurrent, and so on.  We eventually got to a simple design of n buckets in the hash table, with one mutex corresponding to one bucket. Easy enough, and this is where I see a lot of answers to this question on other sites stop. It does not handle what happens when the hash table is resized or for whatever reason the table is rehashed.</p><p>It was supposed that one thread would manage rehashing, so our simple design becomes n + 1 mutexes, and the managing thread has to lock all n + 1 mutexes to rehash.  However, any thread that is waiting on any of the n buckets could gain ownership to a mutex which is now matched matched to a different bucket (after a rehash).   Only answer I could come up w/ basically went back to a non-concurrent hash map.</p><p>I believe java has some type of concurrent hash map out of the box, but I live in a C++ world.  I passed the screen but I&#39;m still very curious about this as I never had that &#34;a-ha&#34; moment and it sounds like a practical application.</p><p>I do think read-write locks may be a somewhat suitable answer but again, I think there is still the caveat when rehashing.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p><em>I have wrestled with this. I did a few iterations on my design...</em></p><p><strong>First solution</strong>: Just have a hash table with a global lock.</p><p><strong>Second solution</strong>: Wait free fixed size hash table. We need to figure out that it is possible to implement a wait free thread safe hash set with fixed size. To do this, we are going to use an array, where the index is the hash, we will use linear probing, and all operations are going to be interlocked.</p><p>So, yes, we will have locking. However a thread will never be spin waiting or waiting on a wait handle. It takes some work to figure out how to guarantee they are all atomic.</p><p><strong>Third solution</strong>: Lock on growth. The naive approach is to lock the structure, create a new array, copy all the data, then unlock. That works, it is thread safe. We can get away with locking only on growth because as long as the size does not change we can work as in the prior solution.</p><p>Except I do not like the down time. There are threads waiting for the copy to complete. We can do better...</p><p><strong>Fourth solution</strong>: Cooperative growth. First implement a thread safe state machine so that the structure can change from normal use to growth and back. Next, every thread that wants to do an operation, instead of waiting, will cooperate in copying data to the new array. How? We can have an index that we increment, again with an interlocked operation... each thread increments the index, takes the element, computes where to place it in the new array, writes it there and then loops until the operation is completed.</p><p>There is a problem: it does not shrink.</p><p><strong>Fifth solution</strong>: Sparse array. Instead of using an array, we can use a tree of arrays, and use it like a sparse array. Its size will be enough to allocate every value that our hash function can output. Now, threads can nodes as needed. We will keep track of usage of each node, that is how many children are occupied and how many threads are currently using it. When usage reaches zero, we can remove it... wait... locking? turns out we can do an optimistic solution: we keep to references to the node data, every thread will write one after operation. The thread that found 0 will erase, then read (another thread could have written it), and then copy to the second reference. All interlocked operations.</p><p>By the way, those atomic operations? Yeah, it turns out they are some common patterns we can abstract out. At the end, I only have <code>DoMayIncrement</code> for operation that may or may not add items, <code>DoMayDecrement</code> for those that may or may not remove, and <code>Do</code> for everything else. They will take callbacks with references to the values, which the callback code does not need to know exactly where they are stored, and we build on top of that more specific operations and add probing to handle collisions along the way.</p><p>Oh, I forgot, to minimize allocations I pool the arrays that make up the nodes of the tree.</p><p><strong>Sixth solution</strong>: Phil Bagwell&#39;s <a href="http://lampwww.epfl.ch/papers/idealhashtrees.pdf" rel="noreferrer">Ideal Hash Trees</a>. It is similar to my fifth solution. Main difference is that the tree does not behave like a sparse array where all values are inserted at the same depth. Instead, the depth of tree branches is dynamic. When a collision happens, the old node is replaced with a branch where the old node is reinserted in addition to the new node. This should make Bagwellâ€™s solution more memory efficient on the average case. Bagwell also pools arrays. Bagwell does not elaborate on shrinking.</p><hr/><p>The fifth solution is what I currently use to backport/polyfill <code>ConcurrentDictionary&lt;TKey, TValue&gt;</code> to .NET 2.0. More precisely, <a href="https://github.com/theraot/Theraot/blob/master/Framework.Core/System/Collections/Concurrent/ConcurrentDictionary.cs" rel="noreferrer">my backport of <code>ConcurrentDictionary&lt;TKey, TValue&gt;</code></a> wraps around a custom type <a href="https://github.com/theraot/Theraot/blob/master/Framework.Core/Theraot/Collections/ThreadSafe/ThreadSafeDictionary.cs" rel="noreferrer"><code>ThreadSafeDictionary&lt;TKey, TValue&gt;</code></a> which uses a <a href="https://github.com/theraot/Theraot/blob/master/Framework.Core/Theraot/Collections/ThreadSafe/Bucket.cs" rel="noreferrer"><code>Bucket&lt;KeyValuePair&lt;TKey, TValue&gt;&gt;</code></a> which implement atomic operations over a <a href="https://github.com/theraot/Theraot/blob/master/Framework.Core/Theraot/Collections/ThreadSafe/BucketCore.cs" rel="noreferrer"><code>BucketCore</code></a> which is my thread-safe sparse array thingy, which has the logic for shrink and grow.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='https://free-tor-game.com/software/java-testing-concurrency-thread-safety/'>Java &#8211; Testing concurrency/thread-safety</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/possible-concurrency-issues-with-database-read-writes/'>Possible concurrency issues with database read/writes</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='http://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="https://free-tor-game.com/wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>