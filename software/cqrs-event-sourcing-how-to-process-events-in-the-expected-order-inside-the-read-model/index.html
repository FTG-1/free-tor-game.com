<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>CQRS-Event Sourcing: how to process events in the expected order inside the read model &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1073883 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1073883" class="post-1073883 software type-software status-publish hentry category-software tag-cqrs tag-event-sourcing tag-messaging tag-read-model"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">CQRS-Event Sourcing: how to process events in the expected order inside the read model</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">cqrs</span><span class="mr-2 badge badge-info">event-sourcing</span><span class="mr-2 badge badge-warning">messaging</span><span class="mr-2 badge badge-primary">read-model</span></p><div class="entry-content"><p>I&#39;m looking for some insights about how to handle the read model in a CQRS Event Sourcing application, in order to do the best to ensure data consistency.</p><p>The missing point is <strong>how to be sure (actually not sure, but reasonably sure) that the projections inside the read model are able to process the events created from the write model in the expected order (which is the order in which the write model generated the events)</strong>.</p><p>Let&#39;s try to clarify the scenario with an example.</p><p>Let&#39;s suppose of having an app with a write stack generating events for an aggregate called <strong>news</strong> and read stack made by a single projection, which is basically a denormalized table listing all the news with some properties (for instance the title, the summary and the author name).<br /> This way, a client app is able to render a user interface listing all the latest news published by the editors.</p><p>The infrastructure for the event sourcing is an event store which saves the events as documents inside a MongoDB collection and then publish a corresponding message to a service bus, so that with a classic <strong>pub-sub pattern</strong> all the interested projections are able to subscribe the message and do the proper work in response to it.<br /> For those who are familiar with <strong>RabbitMQ</strong>, this kind of stuff could be implemented by using a <strong>fanout exchange</strong>. With <strong>Azure service bus</strong>, instead, you can use a <strong>topic</strong>.<br /> In this kind of scenario the write model and the read model are deployed to different machines which are free to be scaled independently of each other, based on the request load on both the write stack and the read stack.</p><p>Given such a scenario, <strong>it is entirely possible that at a given point in time there are two or more instances of the app hosting the read model of our system</strong>. These instances will be <strong>competing consumers</strong> over the events published by the write model.</p><p>Imagine now that in a brief time interval two events, say E1 and E2, are published to the service bus and that there are two running instances, say M1 and M2, of the app hosting the read model.<br /> Given these scenario it is entirely possible that the event E1 will be processed by the machine M1 and the event E2 will be concurrently processed by the machine M2 (remember that the two instances are <strong>competing</strong> over the messages published to the service bus). At this point <strong>the final state of the projection is unpredictable</strong>, because each one of the instances could be faster than the other.</p><p>A typical example is when both the events are of type <strong>TitleSet</strong>, because an editor has decided to change the news title twice in a very brief time interval: at the end of the processing the projection will contain the wrong title for the news and the wrong title will be visible to the final users in the client application (which, of course, gets the data for the user interface from the projection).</p><p>What is the best way to handle these kind of scenario so that the best possible consistency is ensured in the read stack of the application ?</p><p>P.S.: the events E1 and E2 have been generated in the expected order by the write model and they have been stored properly inside the Event Store. <strong>The data inconsistency we are talking about is only for the read model</strong>.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><blockquote><p>The infrastructure for the event sourcing is an event store which saves the events as documents inside a MongoDB collection and then publish a corresponding message to a service bus, so that with <strong>a classic pub-sub pattern</strong> all the interested projections are able to subscribe the message and do the proper work in response to it.</p></blockquote><p>(Emphasis added)</p><p>This assumption here is the one that you want to push back on.  Pub/Sub can work for consumers that only care about a single message in isolation.  Consumers that need state should be consuming histories, not events.</p><p>In the irredeemably non-optimized case, a consumer reads the entire history of ordered events each time it runs, and then processes them all.</p><p>An optimized version of this is that the consumer tracks where in the event history it left off, and runs an &#34;all events since event X&#34; query to find out what has happened.  The irredeemably non-optimized case simply being the degenerate case of this: &#34;all events since there were no events&#34;.</p><p>You might still see the pub/sub pattern applied, not to rebuild the read model, but to wake up the consumer to pull history as described above (in effect, it becomes a latency reduction mechanism).</p><p>There&#39;s nothing wrong with the consumer also having a bit of clever to recognize that the received event is the immediate successor to what is already known.  This is normally accomplished with meta data attached to the event, indicating its position in the history.</p><p>So in your competing consumer scenario, you might see two different read behaviors at work.  The receiver of E1 determines that E1 is the immediate successor of the previous state, and simply goes to work.  The receiver of E2 sees from the metadata that at least one event is missing, so refreshes its copy of the event stream, receiving in return the sequence [E1,E2], which it then consumes.</p><p>Some references</p><blockquote><p>At the DDD Europe conference, I realized that the speakers I talked with where avoiding Pub/Sub whenever possible. -- <a href="https://groups.google.com/forum/#!topic/dddcqrs/S_c_eqQElh8" rel="noreferrer">Raymond Rutjes, 2016</a></p></blockquote><p>Greg Young, <a href="https://www.youtube.com/watch?v=hv2dKtPq0ME&amp;t=24m54s" rel="noreferrer">Polyglot Data (2014)</a>; Greg talks a bit about the benefits of pull.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../cqrs-ddd-event-sourcing-can-the-readmodel-read-itself/'>CQRS / DDD + Event Sourcing. Can the ReadModel read itself</a></li><li class="list-group-item"><a href='../how-do-event-sourced-systems-make-sure-the-read-model-is-only-updated-once/'>How do event sourced systems make sure the read model is only updated once</a></li><li class="list-group-item"><a href='../cqrs-event-sourcing-and-near-real-time-reporting/'>CQRS, Event Sourcing and (near) Real Time Reporting</a></li><li class="list-group-item"><a href='../how-to-model-domain-events-so-that-the-denormalizers-can-fill-highly-denormalized-read-models/'>How to model domain events so that the denormalizers can fill highly denormalized read models</a></li><li class="list-group-item"><a href='../cqrs-with-an-event-log-and-without-event-sourcing/'>CQRS with an Event Log and without Event Sourcing</a></li><li class="list-group-item"><a href='../event-sourcing-and-sync-between-write-and-read-model/'>Event sourcing and sync between write and read model</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>