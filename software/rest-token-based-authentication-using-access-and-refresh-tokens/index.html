<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Rest &#8211; Token-based authentication using access and refresh tokens &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1073242 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1073242" class="post-1073242 software type-software status-publish hentry category-software tag-api tag-authentication tag-design tag-rest tag-security"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Rest &#8211; Token-based authentication using access and refresh tokens</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">api</span><span class="mr-2 badge badge-info">authentication</span><span class="mr-2 badge badge-warning">design</span><span class="mr-2 badge badge-primary">rest</span><span class="mr-2 badge badge-danger">Security</span></p><div class="entry-content"><p>I am implementing a token-based authentication system for a REST API using a short-lived access token and a long-lived refresh token. This is an abstract overview of the relevant API endpoints (HTTPS is enforced for all endpoints):</p><h2>Endpoints:</h2><pre><code>POST /register/
POST /login/
POST /logout/
POST /password/change/
</code></pre><hr/><h2>Implementation:</h2><p><code>POST /register/</code>:</p><ul><li>Request: Client sends username, email, and password in JSON.</li><li>Server actions:<ol><li>Validates input, creates user in database (stores user id, username, email, and password hash).</li><li>Creates short-lived access token in JWT format (contains user id, issued date, and expiration date).</li><li>Creates long-lived refresh token as a UUID string and stores it in database (stores user id and refresh token).</li></ol></li><li>Response: Server returns access token and refresh token in JSON.</li></ul><p><code>POST /login/</code>:</p><ul><li>Request: Client sends username and password in JSON.</li><li>Server actions:<ol><li>Validates input, checks if credentials are valid by checking database.</li><li>If credentials are valid, creates short-lived access token and long-lived refresh token as mentioned previously.</li></ol></li><li>Response: Same as <code>/register/</code>, returns access token and refresh token in JSON.</li></ul><p><code>POST /logout/</code>:</p><ul><li>Request: Client sends <strong>refresh</strong> token in <code>Authorization</code> header as <code>Bearer</code> token.</li><li>Server actions:<ol><li>Validates refresh token by checking refresh token database.</li><li>Removes the refresh token from the database.<br /> <strong>Note:</strong> This leaves the access token valid, but since it will be short-lived (1 hour or so, I think it should be fine).</li></ol></li><li>Response: Returns whether the logout request was successfully processed in JSON.</li></ul><p><code>POST /password/change/</code>:</p><ul><li>Request: Client sends <strong>access</strong> token in <code>Authorization</code> header as <code>Bearer</code> token, and also sends old password and new password in JSON through HTTPS.</li><li>Server actions:<ol><li>Decodes access token to retrieve the user, and checks the user&#39;s old password with the database.</li><li>Sets password hash of user in the database to new password&#39;s hash.</li><li>Removes all refresh tokens associated with user in the refresh token database to essentially log out existing sessions (leaves short-lived access tokens valid).</li></ol></li><li>Response: Returns whether the password change request was successfully processed in JSON.</li></ul><hr/><h2>Questions:</h2><ol><li>Is this approach secure? Specifically:<ul><li>Is sending the username and password through JSON safe if done over HTTPS? How would I prevent unauthorized domains from making calls to this endpoint? Furthermore, how would I prevent programmatic logins?</li><li>Should the refresh tokens be hashed before storing them in the database, or am I just being paranoid?</li></ul></li><li><strong>If the client were a web browser, how would I securely store the refresh token on the client?</strong><ul><li>One idea I have for storing the refresh token is: when the user logs in, in addition to sending the refresh token to the client, the server stores the token in an <code>HttpOnly</code> cookie with a <code>secure</code> flag. Authorization will still be done through the <code>Authorization</code> header, but when the client initially loads up, it can send a <code>GET</code> request to an endpoint that checks if the cookie contains a valid refresh token, and if so, return it to the user in JSON. In other words, the only time the cookie will actually be used is to return the refresh token inside the cookie to the client. Is this approach secure? I think it will prevent CSRF as there are no side effects when requesting the refresh token from the cookie, but is there another way an attacker could intercept the refresh token (assuming HTTPS)?</li></ul></li></ol></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><blockquote><p>Is this approach secure? Specifically:</p><ul><li>Is sending the username and password through JSON safe if done over HTTPS?</li></ul></blockquote><p>Yes. Headers, request params and request body are encrypted during the communication.</p><p>Once on the server-side, do not log the request body :-)</p><blockquote><ul><li>How would I prevent unauthorised domains from making calls to this endpoint?</li></ul></blockquote><p>You can not. Basically, once the API is on the WWW, it&#39;s automatically exposed to all sort of malice. The best you can do is to be prepared and to be aware of the threats. At least about those that concern you. Take a look <a href="https://www.owasp.org/index.php/OWASP_API_Security_Project" rel="nofollow noreferrer">here</a>.</p><p>A possible approach to the problem could be implementing (or contracting) an <a href="https://en.m.wikipedia.org/wiki/API_management" rel="nofollow noreferrer">API Manager</a>.</p><p>On-premise API Managers can reduce the attack surface because all the endpoints behind the AM are not necessarily public.</p><p>You could achieve the same result with some products in the cloud, but they are absurdly expensive for the mainstream.</p><p>Anyways, the API Management endpoints will remain exposed to attacks.</p><blockquote><ul><li>Furthermore, how would I prevent programmatic logins?</li></ul></blockquote><p>If by programmatic logins you mean attacks by brute force, a <em>threshold</em> (max number of allowed requests per second) and a black list should be enough to deter the attacker&#39;s insistence. For further information, take a look <a href="https://www.owasp.org/index.php/REST_Security_Cheat_Sheet#Protocol_for_Authentication_and_Authorization" rel="nofollow noreferrer">here</a>.</p><p>Many of the API Managers provide out of the box API Rate Limit configurations and <a href="https://en.m.wikipedia.org/wiki/Whitelist" rel="nofollow noreferrer">Whitelists</a>.</p><p>If you are familiar with the Google API Console, then you can guess what an API Manager can do.</p><blockquote><ul><li>Should the refresh tokens be hashed before storing them in the
 database, or am I just being paranoid?</li></ul></blockquote><p>Whether the refresh token is a plain UUID or anything else, I don&#39;t like to expose this sort of implementation detail. So I would suggest to hash it. To me, the more opaque are the implementation details of the security layer, the better.</p><p>Regarding the JWT security, take a look <a href="https://www.owasp.org/index.php/JSON_Web_Token_(JWT)_Cheat_Sheet_for_Java#NONE_hashing_algorithm" rel="nofollow noreferrer">here</a>.</p><blockquote><ul><li>If the client were a web browser, how would I securely store the
 refresh token on the client?</li></ul></blockquote><p>You might be interested in <a href="https://www.owasp.org/index.php/JSON_Web_Token_(JWT)_Cheat_Sheet_for_Java#Token_storage_on_client_side" rel="nofollow noreferrer">JSON Web Token (JWT) - Storage on client side</a>.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../api-authentication-one-time-token-vs-dynamic-tokens/'>API Authentication, One time token VS Dynamic tokens</a></li><li class="list-group-item"><a href='../rest-stateful-authentication-in-rest-api-using-tokens/'>Rest &#8211; Stateful authentication in REST API using tokens</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>