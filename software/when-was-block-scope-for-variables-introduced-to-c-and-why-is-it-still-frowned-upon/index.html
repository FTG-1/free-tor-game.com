<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>When was block scope for variables introduced to C, and why is it still frowned upon &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1075782 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1075782" class="post-1075782 software type-software status-publish hentry category-software tag-c tag-memory-usage tag-scope"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">When was block scope for variables introduced to C, and why is it still frowned upon</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">c</span><span class="mr-2 badge badge-info">memory usage</span><span class="mr-2 badge badge-warning">scope</span></p><div class="entry-content"><p>In light of the recent <a href="http://bxr.su/OpenBSD/lib/libssl/src/crypto/objects/obj_dat.c#OBJ_obj2txt" rel="nofollow noreferrer"><code>OBJ_obj2txt</code></a> vulnerability in LibreSSL (which was <a href="http://seclists.org/oss-sec/2015/q4/87" rel="nofollow noreferrer">found during the OpenSMTPD audit, and does not affect OpenSSL</a>), it came to my attention that the memory leak issue likely resulted from some <a href="http://cvsweb.allbsd.org/cvsweb.cgi/src/lib/libssl/src/crypto/objects/obj_dat.c?cvsroot=openbsd#rev1.25" rel="nofollow noreferrer">earlier code refactoring</a>, where the <em>block scoped</em> variable <code>char *bndec</code> was moved out to be <em>function scoped</em> instead.</p><p>I know first-hand that there is this great resistance to <em>block scoped</em> variables within old-school projects like OpenBSD, but what other justification would there be to move the <code>char *bndec</code> declaration?</p><p>More broadly, when was block scoping introduced for variables in C?  All I could find is that it <a href="https://stackoverflow.com/a/1880752/1122270">was already part of C89</a>.  Is that where it started, or was it also part of an earlier spec?</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p><em>TL;DR</em>: It&#39;s not an issue of block scoping, but rather a misunderstanding of how pointers should be handled.</p><hr/><p>Courtesy of the <a href="http://seclists.org/oss-sec/2015/q4/87" rel="nofollow">vulnerability listing</a> that you posted, let&#39;s take a look at the code in question.</p><pre><code>489 int
490 OBJ_obj2txt(char *buf, int buf_len, const ASN1_OBJECT *a, int no_name)
491 {
...
494         char *bndec = NULL;
...
516         len = a-&gt;length;
...
519         while (len &gt; 0) {
...
570                         bndec = BN_bn2dec(bl);
571                         if (!bndec)
572                                 goto err;
573                         i = snprintf(buf, buf_len, &#34;.%s&#34;, bndec);
...
598         }
...
601         free(bndec);
...
609 }
</code></pre><p>And if we delve into the <a href="http://bxr.su/OpenBSD/lib/libssl/src/crypto/bn/bn_print.c" rel="nofollow">declaration of <code>BN_bn2dec</code></a> we see a comment of:</p><pre><code>/* Must &#39;free&#39; the returned data */
</code></pre><hr/><p>What you see as a block scoping issue, I see as a poor understanding of pointer operations as the root issue.</p><p>This <a href="http://cvsweb.allbsd.org/cvsweb.cgi/src/lib/libssl/src/crypto/objects/obj_dat.c.diff?r1=1.24&amp;r2=1.25&amp;cvsroot=openbsd&amp;f=h" rel="nofollow">diff revision</a> shows when the <code>*bndec</code> was moved from inside the while loop to outside the while loop.  The error was also introduced at the same time when the <code>free(bndec)</code> statement was moved outside the loop.</p><p>Where <code>*bndec</code> is declared for this function is a bit irrelevant.  It can safely be defined either outside or inside the while loop.  And if memory serves correctly, the actual declaration will be moved to the top of the function by the compiler anyway.</p><p>Declaring <code>*bndec</code> inside the loop merely would have forced an error if the <code>free()</code> call remained outside of the loop.  It remains to be seen whether that error would have been sufficient to alert the programmer to the fallacy behind their refactoring logic.</p><p>Being a bit of a pessimist when it comes to most programmers and pointers, I&#39;m going to posit that the <code>free</code> accessing an out-of-scope variable error wouldn&#39;t have helped them discover the error of their ways.  Instead, they would have taken the naive (and incorrect) solution of resolving the error by merely moving the variable declaration outside of the block. And that&#39;s why I disagree with the contention that the root cause of this is a block scoping issue.</p><p>If C happened to have garbage collection, then block scoping would have been of more value in this case.  But it doesn&#39;t, and that line of thought becomes pointless speculation.</p><hr/><p>Unfortunately, we don&#39;t really know <em>why</em> the refactoring programmer chose to move that <code>free(bndec)</code> statement.  All that they left via check-in comments was this:</p><blockquote><p>Clean up some of the nightmare of string and pointer arithmatic in
 this nasty function.<br/> This gets rid of the nasty tmp variables used to hold temporary strings
 and the DECIMAL_SIZE hack. it gets rid of the rather pointless null checks
 for buf (since the original code dereferences it before checking). It also
 gets rid of the insane possibility this could return -1 when stuff is
 using the return values to compute lengths All the failure cases now
 return 0 and an empty string like the first error case in the original
 code.</p></blockquote><p>And while I respect their dedication to clean code, I&#39;m not certain I fully agree with their removing of various checks from the code.  Having written a fair amount of C code with a fairly large team of developers, my experience is that defensive coding practices are almost always warranted.  And while a developer may not be able to justify the time expense to <em>add</em> those defensive practices, I can&#39;t say that I have ever found valid grounds to <em>remove</em> those defenses.</p><p>To delve into an equal amount of hyperbole as the refactoring programmer, I find their check-in comment to smack a little bit too much of hubris and not enough of humility.  That hubris is likely what led them to assume they &#34;knew what they were doing&#34; <sup>(TM)</sup> in moving the <code>free(bndec)</code> statement, and they didn&#39;t mentally walk through what that was going to do to the code.</p><p>This error was introduced with the refactoring not because of the block scoping, but because of the failure to understand how pointers operate and the failure to understand how pointers relate to memory.</p><hr/><p>While I think I have established why block scoping is irrelevant to this issue, I want to address what you see as <code>&#34;great resistance to block scoped variables within old-school projects&#34;</code>.  And to my knowledge, ANSI C has always had block scoping available for variables.  Going out on a limb, I suspect K&amp;R C also had it.</p><p>Keep in mind that C is not a gentle language for the naive or the initiate.  It was created in order to provide an additional layer of abstraction over <code>B</code> and assembly level programming.  Programmers writing in C were still expected to have an understanding of the underlying assembler that was being generated.  For example, variables are not automatically initialized, and many a programmer has been burned by that lack of initialization.  C expects the programmer to understand what that variable declaration maps to in memory.  C also has more than its fair share of unwritten style rules that are considered to be &#34;good form.&#34;</p><p>Moving all variable declarations is one of those unwritten style rules, and the pragmatic reason goes back to the lack of automatic initialization.  Disciplined C programmers declared all of their variables at the beginning of the function so they could make a quick visual scan to verify that all declared variables had been initialized.  It&#39;s an easy way to make sure that a common mistake (e.g. lack of initialization) has been avoided.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../why-was-the-c-syntax-for-arrays-pointers-and-functions-designed-this-way/'>Why was the C syntax for arrays, pointers, and functions designed this way</a></li><li class="list-group-item"><a href='../c-in-c-c-are-block-scope-variables-stacked-only-if-the-block-is-executed/'>C++ &#8211; In c/c++, are block-scope variables stacked only if the block is executed</a></li><li class="list-group-item"><a href='../why-was-the-percent-sign-chosen-as-the-format-specifier-for-the-printf-family-of-functions/'>Why was the percent sign (%) chosen as the format specifier for the printf family of functions</a></li><li class="list-group-item"><a href='../when-and-for-what-purposes-should-the-const-keyword-be-used-in-c-for-variables/'>When and for what purposes should the const keyword be used in C for variables</a></li><li class="list-group-item"><a href='../should-i-declare-variables-at-the-top-of-the-function-for-reasons-other-than-the-scope-rules/'>Should I declare variables at the top of the function for reasons other than the scope rules</a></li><li class="list-group-item"><a href='../why-would-you-want-different-identifiers-for-a-typedef-and-its-associated-struct-tag/'>Why would you want different identifiers for a typedef and its associated struct tag</a></li><li class="list-group-item"><a href='../java-why-do-languages-require-parenthesis-around-expressions-when-used-with-if-and-while/'>Java &#8211; Why do languages require parenthesis around expressions when used with &#8220;if&#8221; and &#8220;while&#8221;</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>