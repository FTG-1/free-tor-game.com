<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Unit of work + repository pattern + dependency injection &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1077062 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1077062" class="post-1077062 software type-software status-publish hentry category-software tag-ninject tag-repository-pattern tag-unit-of-work"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Unit of work + repository pattern + dependency injection</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">ninject</span><span class="mr-2 badge badge-info">repository-pattern</span><span class="mr-2 badge badge-warning">unit-of-work</span></p><div class="entry-content"><p>I am in the process of refactoring and improving a codebase. One of the major missing features is transactional safety and certain errors arising from each repository having its own DbContext.</p><p>The current setup is as follows:</p><ul><li>The BLL (<code>FooManager</code>) connects to as many repositories (<code>FooRepository</code>, <code>BarRepository</code>) as it wants to.</li><li>Each repository has its own <code>DbContext</code>.</li><li>Ninject is used for constructor injection.</li></ul><p>What I want to create is as follows:</p><ul><li>The BLL (<code>FooManager</code>) has an injected <code>UnitOfWork</code></li><li>The <code>UnitOfWork</code> class holds a reference to all repositories <em>(Note: I am aware of the possibility of having the repositories register themselves to the unit of work, more on that later.)</em></li><li>A <code>UnitOfWork</code>&#39;s repositories should all use the same DbContext.</li><li>We must ensure that the <code>DbContext</code> is disposed of even if the <code>FooManager</code> is kept alive after its method was called.</li></ul><p>But I&#39;m encountering a few issues here. I initially wanted to post these as separate questions but I suspect that any relevant answer needs to take all these considerations into account. I&#39;ve found individual answer to each question (which I will mention when relevant) but I haven&#39;t found a solution that ticks all the boxes.</p><hr/><p><strong>How to ensure that the <code>DbContext</code> is shared between repositories?</strong></p><p>Currently, the <code>DbContext</code> is injected into the repository constructor. I see other options, but I can&#39;t fully solve any of them.</p><ul><li>I could set NInject to treat the <code>DbContext</code> as a singleton. However, then two units of work will also share the same <code>DbContext</code>.</li><li>I could inject the <code>DbContext</code> into the <code>UnitOfWork</code> constructor, but I&#39;m unsure how to then pass the context to the underlying repositories.<ul><li>Setting a public property feels dirty.</li><li>Using a constructor would mean that the UOW constructs the repository instead of NInject, which feels like an antipattern.</li><li>Having the repositories each point to the context in the UOW requires the UOW injecting itself into the repositories. The question remains the same, regardless of whether I choose to pass the context or the UOW itself to the underlying repositories.</li></ul></li></ul><hr/><p><strong>How to ensure that contexts get closed?</strong></p><p>I want to stay away from using NInject&#39;s <code>.InRequestScope()</code> feature, because the company has in the past shown to reuse its libraries in different forms. In the past, we&#39;ve encountered issues because a BLL never disposed of its context.</p><p>Initially, it was developed for a REST web API, so the context was disposed of at the end of the request. But when the BLL was later reused as part of a Windows service, the contexts were never disposed of because the &#34;request&#34; never finished (since the service was active at all times). It took us many weeks of work to trace bugs that were caused by this (we kept seeing ghost data enter the database).</p><p>I want to avoid it in the new project, so the proposed solution needs to work both for a web service and a windows service. I am already relying on factory injection here, provided by a NInject extension:</p><pre><code>public class FooManager
{
    private Func&lt;UnitOfWork&gt; createUOW;

    public FooManager(Func&lt;UnitOfWork&gt; uowFactory)
    {
       createUOW = uowFactory;
    }

    public object PublicMethod1()
    {
        using (var uow = createUOW())
        {
            // ...
        }
    }

    public object PublicMethod2()
    {
        using (var uow = createUOW())
        {
            // ...
        }
    }
}
</code></pre><p>The goal is to ensure that each &#34;call&#34; to the business logic gets its own unique UOW (and therefore unique context). This means that in a Windows service, where the <code>FooManager</code> may be kept alive for an extended time, that the underlying context will still be refreshed every time the <code>FooManager</code> is called upon.</p><hr/><p><strong>How to connect the UOW and the repositories?</strong></p><p>My first attempt was to simply inject every repository via the UOW constructor. While that is technically possible, I&#39;m apprehensive of having to bloat the constructor to using more than 30 different repositories. It&#39;s going to be hell to maintain in the future.</p><p>I can&#39;t just inject the <code>IKernel</code> itself into the UOW. The DI and BLL (and DAL) are separate projects, and the DI already depends on the BLL (and DAL) so I can&#39;t have the BLL (and DAL) depend on the DI project as well as that would create a circular dependency.</p><p>I&#39;ve come across <a href="https://stackoverflow.com/questions/16064902/dependency-injection-in-unit-of-work-pattern-using-repositories">solutions to have the repository register itself with the unit of work</a>, but I&#39;m unsure if this actually improves things in my case.</p><ul><li>While I do have a <code>Repository&lt;T&gt;</code> that all repositories inherit from, almost all repositories heavily rely on an additional <code>FooRepository</code> which considerably extends the available method. The <code>FooManager</code> can&#39;t just use <code>Repository&lt;Foo&gt;</code>, it should be using <code>FooRepository</code>.</li><li>If I understand it correctly, this would also still require the BLL to instantiate the repositories it needs. But I&#39;m specifically trying to prevent this behavior. I want the BLL to only work with a UOW directly.<ul><li>I&#39;m aware that the BLL will still be aware of which repositories of the UOW it wishes to use, but I don&#39;t want the BLL to be responsible for <em>instantiating</em> the repositories.</li></ul></li></ul><hr/><p>One last mention I want to make is that <strong>complexity matters</strong>. I&#39;ve fought long and hard for the opportunity to refactor the codebase, but management is liable to cancel the whole change if it takes too long or becomes too complex for the current developers to understand/properly work with. This means that I probably won&#39;t be able to implement a <em>perfect</em> design.</p><p>The main requirements are:</p><ul><li>Transactional behavior</li><li>Ensuring that a UOW uses a single db context in all of its repositories.</li><li>Ensuring that every BLL-method uses its own UOW/context and correctly disposes of it at the end of the method.</li><li>For all other concerns, the needed change from the current setup should be minimized.</li></ul><p>While I have found some solutions to the problems listed above, I cannot find one that aligns all needed requirements.</p><p>Am I missing something here, or am I trying to go about it the wrong way?</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>The credit should go to <strong>@user1450877</strong> but he&#39;s not actually posting an answer. The suggestion to use a named scope indeed solved the issue.</p><p><a href="https://www.planetgeek.ch/2010/12/08/how-to-use-the-additional-ninject-scopes-of-namedscope/" rel="nofollow noreferrer">Reference link, I used the first of the three options.</a></p><p>I installed the <strong>NInject.Extensions.NamedScope</strong> plugin, and then created a string key to act as the name of the scope:</p><pre><code>private const string UnitOfWorkScope = &#34;UNITOFWORKSCOPE&#34;;
</code></pre><p>And then changed my bindings to use the correct scope:</p><pre><code>kernel.Bind&lt;IUnitOfWork&gt;()
      .To&lt;UnitOfWork&gt;()
      .DefinesNamedScope(UnitOfWorkScope);

kernel.Bind&lt;IFooRepository&gt;()
      .To&lt;FooRepository&gt;();

kernel.Bind&lt;MyDbContext&gt;()
      .ToSelf()
      .InNamedScope(UnitOfWorkScope);
</code></pre><p>This achieves exactly what I wanted, a <code>DbContext</code> that behaves <em>like</em> a singleton in scope of every <code>IUnitOfWork</code> that is instantiated.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../architecture-hooking-up-a-business-layer-and-repository-using-unit-of-work-pattern/'>Architecture &#8211; Hooking up a Business Layer and Repository using Unit of Work Pattern</a></li><li class="list-group-item"><a href='../unit-of-work-repository-pattern-with-dependency-injection-advice/'>Unit of work/repository pattern with dependency injection advice</a></li><li class="list-group-item"><a href='../cqrs-with-repository-pattern-and-inversion-of-control-with-di/'>CQRS with Repository pattern and Inversion of Control (with DI)</a></li><li class="list-group-item"><a href='../unit-of-work-pattern/'>Unit of Work pattern</a></li><li class="list-group-item"><a href='../c-dependency-injection-multiple-instances-or-only-one-inrequestscope/'>C# &#8211; Dependency injection multiple instances or only one InrequestScope</a></li><li class="list-group-item"><a href='../handling-disposables-with-dependency-injection/'>Handling disposables with dependency injection</a></li><li class="list-group-item"><a href='../c-unit-of-work-with-multiple-database-context/'>C# &#8211; Unit Of Work with multiple database context</a></li><li class="list-group-item"><a href='../avoiding-repository-pattern-implementing-onion-architecture-with-dbcontext-only/'>Avoiding Repository pattern &#8211; implementing Onion Architecture with DbContext only</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>