<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>How to update a NoSQL database and publish event atomically in an event-driven microservices architecture &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1085126 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1085126" class="post-1085126 software type-software status-publish hentry category-software tag-microservices tag-nosql"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">How to update a NoSQL database and publish event atomically in an event-driven microservices architecture</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">microservices</span><span class="mr-2 badge badge-info">nosql</span></p><div class="entry-content"><p>In an event-driven microservices architecture, services typically need to update their domain state and publish an integration event to a service bus at the same time (Either both operations complete, or none).</p><p><strong>Simple example:</strong><br /> The ordering microservice receives a REST API call to create an order.  The microservice needs to:</p><p>1) Create the order entity and persist it in the database</p><p>2) Publish an OrderCreated integration event through an event bus</p><p>When using a relational database this is typically achieved using the outbox pattern: a single entry is saved in the database that indicates that event X needs to be published.  This entry is saved as part of the same transaction that contains the domain-state changes.  A background process then polls these entries and publishes the events.  This means that the event will eventually be published, making the system eventually consistent.</p><p>However, NoSQL databases do not favor the idea of updating multiple documents in a single transaction, and many of them do not support it without ugly workarounds.  Below is a list of potential solutions (Some more ugly than others):</p><p><strong>1. Outbox pattern variation:</strong></p><p>Outbox pattern, but instead of having a separate collection of documents for the pending events, they will be saved as part of the domain entity.  Each domain entity will encapsulate a collection of events that remain to be published and a background process will poll such entities and publish the events.</p><p>Cons:</p><ol><li><s>If the background process publishes the event but fails to remove it<br /> from  the domain entity, it will re-publish it.</s> This shouldn&#39;t really be a problem if updates are idempotent or if the event handler is able to identify duplicate events.</li><li>Domain entities are<br /> corrupted with integration events.</li></ol><p><strong>2. Event sourcing:</strong></p><p>Event sourcing makes this problem go away but is very complex to implemented and a big overhead for small microservices.</p><p>Cons:</p><ol><li>Complex, might need complete re-design of the way services work with data.</li></ol><p><strong>3. Listening to own events:</strong></p><p>The service will only publish an event that is also subscribed to (It will not update its state as part of the same operation).  When the service bus sends the event back for handling, the service will update its domain entity.</p><p>Cons:</p><ol><li>Other microservices may handle the event before the origin microservice.  This may cause problems if they assume that the event already happened when in fact it hasn&#39;t.</li></ol><p>Are there any other solutions to this problem?  Which is the best one?</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>You can&#39;t.  You are writing to two different databases (NoSQL + Service Bus) - you cannot guarantee consistency between the two without introducing distributed transactions which are bound to cause headaches, slowdowns and ultimately failures.</p><p>Event sourcing is the way to go.  Event sourcing is not as much of an overhead as it is believed to be, in fact, it is easy to implement (No need for frameworks, easy to build something production-ready), reduces overall complexity and increases performance for large scale applications.</p><p>Some comments about the other two approaches:</p><p>Approach #1: This seems to be a downgraded variation of ES.  It is temporarily persisting the events and using the latest snapshot as the source of truth.  I think this is a clear downgrade from event sourcing because:</p><ol><li>History is lost.</li><li>Having background threads that are writing to the
aggregate (To delete the events after publishing) may
increase the rate of optimistic concurrency exceptions.</li></ol><p>Approach #3: This is essentially an attempt to use the service bus as an event store - it is not meant to be an event store, don&#39;t do it.  I&#39;ve seen some systems that use something like Kafka as an event store, but this is because Kafka leverages events as its core principle and provides some event-sourcing features out of the box.</p><p>I recommend going through Greg Young&#39;s talks &amp; papers about event sourcing, he&#39;s known to be one of the event sourcing gurus.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../handling-changes-in-a-event-driven-microservice-architecture/'>Handling changes in a event-driven microservice architecture</a></li><li class="list-group-item"><a href='../architecture-how-to-handle-transactional-operations-in-an-event-driven-architecture/'>Architecture &#8211; How to handle transactional operations in an event-driven architecture</a></li><li class="list-group-item"><a href='../message-bus-v-mediator-pattern-v-in-memory-bus/'>Message Bus v Mediator pattern v In Memory Bus</a></li><li class="list-group-item"><a href='../service-bus-or-event-stream-for-event-driven-architecture/'>Service Bus or Event Stream for Event-Driven Architecture</a></li><li class="list-group-item"><a href='../confused-about-commands-domain-events-and-external-events-in-event-sourcing/'>Confused about commands, domain events and external events in event sourcing</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>