<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="https://free-tor-game.com/wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>C# &#8211; Multiple HttpClients in .NET Core Console Application &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.min.js?ver=11.2.0' id='highlight-js'></script>     <script>( function( w, d, s, l, i ) {
				w[l] = w[l] || [];
				w[l].push( {'gtm.start': new Date().getTime(), event: 'gtm.js'} );
				var f = d.getElementsByTagName( s )[0],
					j = d.createElement( s ), dl = l != 'dataLayer' ? '&l=' + l : '';
				j.async = true;
				j.src = 'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
				f.parentNode.insertBefore( j, f );
			} )( window, document, 'script', 'dataLayer', ' ' );</script>      <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1085892 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="https://free-tor-game.com/3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="https://free-tor-game.com/contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1085892" class="post-1085892 software type-software status-publish hentry category-software tag-api-design tag-c tag-http tag-net tag-rest"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">C# &#8211; Multiple HttpClients in .NET Core Console Application</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">api-design</span><span class="mr-2 badge badge-info">c</span><span class="mr-2 badge badge-warning">http</span><span class="mr-2 badge badge-primary">net</span><span class="mr-2 badge badge-danger">rest</span></p><div class="entry-content"><p>I&#39;m building a .NET Core class library wrapper for a REST API that, ideally, could be used in both console applications and ASP.NET Core web applications. So far, I&#39;ve based development on supporting dependency injection for the latter by creating a <a href="https://docs.microsoft.com/en-us/dotnet/architecture/microservices/implement-resilient-applications/use-httpclientfactory-to-implement-resilient-http-requests" rel="nofollow noreferrer">typed client</a> for each group of REST API methods, i.e. one client for each group of (Index, Create, Destroy, etc.). It may be important to note that in this case, each group has same base address, and in most cases, the same authorization header would be used.</p><p>The typed clients inherit from a base client that handles some of the configuration:</p><pre><code>public abstract class BaseClient
{
    protected readonly HttpClient _client;

    public BaseClient(IConfigService config, HttpClient client)
    {
        _client = client;
        _client.BaseAddress = new Uri(config.BaseAddress);

       // More configuration
    }
}
</code></pre><p>So I end up with something like this:</p><pre><code>public class ClientA : BaseClient, IClientA
{
    public ClientA(IConfigService config, HttpClient client) : base(config, client) { }

    // Some methods
}

public class ClientB : BaseClient, IClientB
{
    public ClientB(IConfigService config, HttpClient client) : base(config, client) { }

    // More methods
}
</code></pre><p>And so on. With this I&#39;ve written an <code>IServiceCollection</code> extension that registers all of these services:</p><pre><code>public static class WrapperServiceCollectionExtensions
{
    public static IServiceCollection AddWrapper(this IServiceCollection services, string username, string key)
    {
        services.AddSingleton&lt;IConfigService&gt;(new ConfigService(username, key));
        services.AddHttpClient&lt;IClientA, ClientA&gt;();
        services.AddHttpClient&lt;IClientB, ClientB&gt;();

        // More clients

        return services;
    }
}
</code></pre><p>As I understand it, using this DI pattern, a new <code>HttpClient</code> is instantiated for each typed client, so I see no issue with a typed client being individually responsible for its own configuration. But let&#39;s say I want to create these clients in a console application. Finally, I get to my question: knowing that the clients all have the same base address and all will most likely be using the same credentials for authorization, what would be the recommended way of instantiating them in a console application? I&#39;m inclined to create a new <code>HttpClient</code> for each typed client:</p><pre><code>class Program
{
    private static HttpClient _clientA = new HttpClient();
    private static HttpClient _clientB = new HttpClient();

    static void Main(string[] args)
    {
        var config = new ConfigService(&#34;user&#34;, &#34;key&#34;);
        var a = new ClientA(config, _clientA);
        var b = new ClientB(config, _clientB);
    }
}
</code></pre><p>But is this really necessary if the configurations would be the same for both anyways? Should I only worry about one <code>HttpClient</code> unless I&#39;m dealing with multiple configurations? Should I even have multiple typed clients if the configuration would be the same for each? To me, it feels a little hacky to let each typed client successively overwrite a single <code>HttpClient</code>&#39;s configuration in its constructor, but in terms of behavior, unless different credentials were used, I don&#39;t think it would matter. Seriously stuck here.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>First of all this a good question. :)</p><p>Let me try to help you by comparing the two approaches that you have mentioned.</p><h2>One typed client for each group of API</h2><h3>Pros</h3><ul><li>This is a more flexible approach<ul><li>You can apply different credentials later if it is needed</li><li>You can define different timeouts against different domains</li><li>You can use different resilient strategies (for example for idempotent operations you can introduce retry logic)</li></ul></li><li>If a single instance fails then it does not affect the others<ul><li>Separate monitoring can be introduced (and use circuit breakers to avoid flooding downstream systems)</li></ul></li><li>Consumer can decide which one to use<ul><li>Consumer can throttle the outgoing requests on a domain basis (by using for example the bulkhead)</li></ul></li></ul><h3>Cons</h3><ul><li>If you have 10+ nearly identical groups of API then managing all clients can be challenging if it needs to be done manually</li><li>Configuring all clients with almost the same settings can be a tedious and error-prone job</li></ul><h2>A single shared client for all groups</h2><h3>Pros</h3><ul><li>Simplified configuration</li><li>Simpler credential management</li><li>Code might be easier to understand (it can improve readability)</li></ul><h3>Cons</h3><ul><li>Mixing <em>http</em> and <em>https</em> calls can cause overhead due to extensive handshaking<ul><li>You might end up with <code>IOException</code> if you use wrong TLS version</li><li>You might end up with a <code>SocketException</code> if you exhaust the connection pool (too frequent connection open requests)</li></ul></li><li>Changing the <code>BaseAddress</code> of the client can cause <code>InvalidOperationException</code> if there are one or more pending requests.<ul><li>Same applies for other global settings like <code>Timeout</code> or <code>MaxResponseContentBufferSize</code></li></ul></li><li><code>CancelPendingRequests</code> method call can take a while</li></ul><p>My point is that each approach has its own strengths and trade-offs. It is up to you to decide which one to use based on the functional and non-functional requirements.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='https://free-tor-game.com/software/managing-large-number-of-app-config-files/'>Managing large number of app.config files</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/rest-oauth-alternative-for-a-2-party-system/'>Rest &#8211; OAuth alternative for a 2 party system</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/c-should-timeout-be-a-public-static-property-or-a-parameter-to-every-function/'>C# &#8211; Should timeout be a public static property or a parameter to every function</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/c-two-way-communication-between-server-and-clients/'>C# &#8211; Two way Communication between Server and Clients</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/c-design-pattern-for-different-code-behaviors-according-to-different-clients/'>C# &#8211; Design pattern for different code behaviors according to different clients</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/rest-oauth2-ropc-vs-basic-auth-for-public-rest-apis/'>Rest &#8211; OAuth2 ROPC vs Basic Auth for public REST APIs</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='http://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="https://free-tor-game.com/wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>