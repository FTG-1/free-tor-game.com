<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>C# &#8211; Help me resolve this circular dependency &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1066774 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1066774" class="post-1066774 software type-software status-publish hentry category-software tag-c tag-dependency-injection tag-domain-driven-design tag-layers"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">C# &#8211; Help me resolve this circular dependency</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">c</span><span class="mr-2 badge badge-info">dependency-injection</span><span class="mr-2 badge badge-warning">domain-driven-design</span><span class="mr-2 badge badge-primary">layers</span></p><div class="entry-content"><p>This would be behind a spoiler tag if I could get the markdown to work. Sorry.</p><hr/><blockquote><p>As soon as I typed in &#34;circular dependency&#34;, I got a ton of suggested results. Such as:</p><ul><li><a href="https://softwareengineering.stackexchange.com/questions/253646/how-to-handle-circular-dependency-in-dependency-injection">How to handle “circular dependency” in dependency injection</a></li><li><a href="https://softwareengineering.stackexchange.com/questions/306483/how-to-solve-circular-dependency">How to solve circular dependency</a></li><li><a href="https://softwareengineering.stackexchange.com/questions/273079/is-circular-dependency-injection-a-good-practice">Is circular Dependency Injection a good practice?</a></li><li><a href="https://softwareengineering.stackexchange.com/questions/306907/circular-dependencies-recursive-grammar-parser-e-g-json">Circular dependencies: Recursive grammar parser (e.g. json)</a> (which, ironically, references the first three)</li><li><a href="https://softwareengineering.stackexchange.com/questions/244679/circular-dependency-and-object-creation-when-attempting-ddd">Circular dependency and object creation when attempting DDD</a></li></ul><p>I&#39;ve read through those, and others. I still don&#39;t know how to solve my problem, thus this question:</p></blockquote><hr/><p>Ok, real question.</p><p>The &#34;typical&#34; method of dependency injection for a data access layer goes something like this:</p><ol><li>Create an interface for your persistence layer within your domain layer.</li><li>Have your domain services accept that interface in their constructors.</li><li>Make sure your persistence layer implements that interface. This implies that the persistence layer depends on the domain layer, and all is good.</li><li>Your client layer has references to the domain layer and to the persistence layer.</li><li>Your client layer instantiates the persistence object and injects it into the domain services. This is typically done with a <code>using</code> clause.</li></ol><p>For example:</p><pre><code>// Simplified...
using (var p = new PersistenceThing ()) {
    var s = new ServiceThing (p);
}
</code></pre><p>&#8230; and if you have multiple layers&#8230;</p><pre><code>using (var p = new PersistenceThing ()) {
    using (var s1 = new LowerLayerThing (p)) {
        using (var s2 = new HigherLayerThing (s1)) {
            // How deep does the rabbit hole go before you can actually do anything?
        }
    }
}
</code></pre><p>I have a valid need to move the creation of these service objects into factories. (The reasons are long, involving separation into separate tiers). That changes my project layout a little.</p><p>Going from the top down:</p><ul><li>I have a client project.</li><li>Below that, I have an &#34;upper layer interface&#34; project that contains the service contract for the layer and the factory for the layer. The client project need only reference this &#34;upper layer interface&#34; project.</li><li>Next, I have an &#34;upper layer implementation&#34; layer. This layer references the &#34;upper layer interface&#34; project and the &#34;lower layer interface&#34; project.</li><li>Then there&#39;s a &#34;lower layer interface&#34; project containing the service contract and factory. It doesn&#39;t reference anything.</li><li>Then a &#34;lower layer implementation&#34; layer. It references the &#34;lower layer interface&#34; project and&#8230; and&#8230;</li></ul><p>And then I get to the persistence layer and it all breaks down.</p><p>I need to have a factory to handle the instantiation of my persistence layer.<br /> The lower service layer needs to have or reference the persistence interface because that&#39;s what it&#39;s working against. The factory needs to have or reference that same interface so that it can expose the proper method signature. Easy enough: the &#34;persistence interface&#34; project references the &#34;lower service&#34; project. But the &#34;lower service&#34; project needs to have access to the factory so that it can get an instantiation of the persistence layer.</p><p>My first thought was to move the interface into the &#34;persistence interface&#34; project, but it still needs a reference to the &#34;lower service&#34; project because it references all of the domain object types. My second thought was to move the factory into the &#34;lower service&#34; project, but it needs references to the &#34;persistence implementation&#34; layer so that it has something to instantiate. But the &#34;persistence implementation&#34; layer would still need a reference to the &#34;lower domain&#34; layer so that I can implement the interface.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>That&#39;s not how layered (or tiered) architecture works. Specifically: each layer only has knowledge of the layers directly below it and any required shared objects. Which contradicts items 4 and 5 in your list of how typical dependency injection works. Which is why you have a circular dependency problem.</p><p>In a three layer system consisting of client, domain and persistence layers:
 1. The client layers &#34;knows&#34; about the domain layer through interfaces and shared data objects
 2. The domain layer &#34;knows&#34; about the client layer interfaces (because it implements them) and the shared data objects the client requires
 3. The domain layer also &#34;knows&#34; about the persistence layer interfaces and persistence shared data objects.
 4. The persistence layer &#34;knows&#34; about the persistence layer interfaces (because it implements them) and persistence shared data objects</p><p>So you end up with five projects. A client project, a domain project, a persistence project, a project that is referenced by the client and the domain and a project that is referenced by domain and persistence. If you have a common data object that you want to reference in all layers, then that goes in another project.</p><p>Assuming this is a desktop application you will have one additional parent project that references everything but is only there to start up the app. In that project you can use something like Unity to do your actual injection.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../java-which-of-these-is-the-best-strategy-for-dependency-injection/'>Java &#8211; Which of these is the best strategy for dependency injection</a></li><li class="list-group-item"><a href='../c-mvvm-application-architecture-where-to-put-dependency-injection-configuration-class-businesslayer-and-common-interfaces/'>C# &#8211; MVVM application architecture, where to put dependency injection configuration class, BusinessLayer and Common interfaces</a></li><li class="list-group-item"><a href='../c-instantiate-an-engine-from-a-second-project-without-having-a-reference-to-the-second-project-causing-a-circular-reference/'>C# &#8211; Instantiate an engine from a second project without having a reference to the second project causing a circular reference</a></li><li class="list-group-item"><a href='../c-circular-dependency-in-dependency-injection/'>C# &#8211; Circular dependency in dependency injection</a></li><li class="list-group-item"><a href='../handling-disposables-with-dependency-injection/'>Handling disposables with dependency injection</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>