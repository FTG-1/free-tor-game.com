<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>C# &#8211; I need advice developing a sensitive data transfer/storage/encryption system &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1072941 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1072941" class="post-1072941 software type-software status-publish hentry category-software tag-c tag-encryption tag-mysql tag-php tag-security"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">C# &#8211; I need advice developing a sensitive data transfer/storage/encryption system</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">c</span><span class="mr-2 badge badge-info">encryption</span><span class="mr-2 badge badge-warning">MySQL</span><span class="mr-2 badge badge-primary">PHP</span><span class="mr-2 badge badge-danger">Security</span></p><div class="entry-content"><p>I got closed on SO and told to post this here as it&#39;s about general application design as opposed to specific code.</p><h2>Intro</h2><p>I&#39;m currently working on a project which involves the daily extraction of data (pharmacy records) from a VisualFox Pro database, and uploading some of it to a WordPress site, where clients of the pharmacy can securely view it. I would like some advice in terms of the general methodology of my software &#8211; I am able to code it, but need to know if I&#39;m going the right way about it. I&#39;m writing both the PC software (in C#/.NET 4.5) and the PHP WordPress plugin. (It doesn&#39;t matter much that it&#39;s in WordPress, the actual code for this will pretty much run separately).</p><h2>Question 1: Encryption</h2><p>The current process for encrypting the data server-side I plan to use is based on <a href="http://i.amniels.com/mysql-database-encryption-using-public-private-keys" rel="noreferrer">this article</a>. Summarised, it advocates encrypting each separate user&#39;s data asymmetrically with their own public key, stored on the server. The private key to decrypt this data is then itself encrypted symmetrically using the user&#39;s password, and stored. This way, even if the database is stolen, the user&#39;s password hash needs to be broken, and even then the process needs to be repeated for every user&#39;s data.</p><p>The only weakness, pointed out by the author himself, and the main point of my question, is the fact that while the user is logged in, the decrypted key is stored in session storage. The way the article suggests to deal with it is to just limit the time the user is logged in. I thought a better solution would be to store that key in a short-lived secure cookie (of course the whole process is happening over HTTPS). That way, if the attacker has control of the user&#39;s computer and can read their cookies, they can probably just keylog their password and log in, no need to steal the database, while even if the attacker gains access to the server, they cannot decrypt the HTTPS traffic (or can they? I&#39;m not sure.)</p><p><strong>Should I use secure cookies or session storage to temporarily store the decrypted key?</strong></p><h2>Question 2: Storage</h2><p>The second thing I still want to work out is how to store the data &#8211; this is more of an efficiency problem. Since every user has their own key for encryption, it follows that records for every user must be stored separately. I don&#39;t know if I should store a &#34;block&#34; of data for every user, containing encrypted JSON with an array of objects representing records, or whether I should store records in a table with the actual data structure, and encrypt each data field separately with the key.</p><p>I am leaning towards storing the data as one block &#8211; it seems to me to be more efficient to decrypt one big block of data at a time, than perhaps several thousands separate fields. Also, even if I stored the data in its proper structure, I still wouldn&#39;t be able to use MySQL&#39;s WHERE, ORDERBY etc, since the data would all be BLOBs.</p><p><strong>Should I store the data as a big block per user, or separated into the different fields?</strong></p><h2>Question 3: Transfer</h2><p>I extract the data from the DBF file, and essentially make a &#34;diff&#34;, whereby I compare the current extracted data from the last day&#39;s data, and only upload the blocks of the users that have changed (I can&#39;t only upload the records, as I probably will end up storing the users&#39; data in blocks). I also include &#34;delete&#34; instructions for users which have been deleted. This is as there are hundreds of thousands records in the database, totalling over 200mb, and the size increases every day.</p><p>My current plan is to write all this data to a JSON file, gzip it and upload it to the server. My question is, how do I do that while ensuring the security of the data? Naturally, the upload will happen over HTTPS, and I have an API password in place to only allow authorised uploads, but my main concern is how to protect the data if the server is compromised. I don&#39;t want the attacker to just grab the JSON file from the server while it&#39;s being processed. One idea I had was to get the server to send me a list of public keys for the users, and perform the encryption in my software, before the upload. It seems to me like that&#39;s the only way of protecting that data. I could encrypt the whole JSON file, perhaps with an API key or a special password, but that&#39;s moot if the attacker can just access the decrypted file as it&#39;s being processed on the server. Is that a good solution?</p><p><strong>Should I encrypt the data individually client-side, or is there a way to securely transfer it to the server and encrypt it there?</strong></p><p>Thanks in advance for any answers, I&#39;d love to hear from someone who&#39;s dealt with problems like this before.</p><p>Matt</p><p><strong>EDIT: I&#39;m pretty decided on 1 and 2 &#8211; thanks @Morons. I&#39;ll use secure cookies and store data in blocks. My main question is now question 3, would love to get some input on that.</strong></p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>I hope this isn&#39;t too blunt, but the task you are undertaking here is extremely difficult, and the odds of you getting it right are slim. Security flaws are most of the time caused by mistakes in implementation, not in the underlying technologies. In order to make a system like the one you&#39;ve described secure, you have to use the correct tools and the correct methodology  and account for all of the edge cases or the security of the entire system will be compromised.</p><p>That&#39;s not really a helpful answer though, is it? When you are building a system like you are building the question you should be asking shouldn&#39;t be &#34;How do I do this?&#34; It should instead be &#34;What is the way I can do this that relies the least on myself?&#34; The answer to that question is to use tried and tested systems wherever possible, and to roll your own solutions only as a last resort.</p><p>To answer your first point about encryption, it doesn&#39;t make sense to worry too much about securing a key in memory of the server. If an attacker has enough access to a machine to read your keys out of memory, you are totally and completely hosed and any solutions that you have coded up aren&#39;t going to help much any way. In other words, <strong>favor securing data at rest and data that is moving over the internet,</strong> since that is where most attacks are going to occur.</p><p>As far as storing the data goes, I don&#39;t see any reason why asymmetric crypto needs to be involved here. I would use something like <a href="http://en.wikipedia.org/wiki/PBKDF2" rel="nofollow noreferrer">PBKDF2</a> to derive a key directly from the user&#39;s password, then encrypt the data and store the encrypted blob in a database. I would recommend a database over a flat file because managing a folder full of flat files is tedious at the best of times. Databases may not show any solid benifits in speed or security over flat files, but they come with many other features such as pooled connections and they also make backing up data much easier than flat files. <strong>Use the simplest system you can to minimize your attack surface, and use thoroughly tested open source tools whenever possible.</strong> If you can find a way to use <a href="http://www.gnupg.org/" rel="nofollow noreferrer">GPG</a> for the encryption and key derivation part of things, I would recommend it.</p><p>As far as transfer goes, I believe that you are thinking about things the wrong way. <strong>Don&#39;t</strong> do any encryption client side. Browser javascript is not suitable for cryptography, as explained in <a href="http://www.matasano.com/articles/javascript-cryptography/" rel="nofollow noreferrer">this article</a>. So long as you make sure that you use TLS/SSL for all connections to your site, you shouldn&#39;t need to worry about transmitting data unencrypted. For an example of why it is hard to do client side encryption, do some googling about the security of MegaUpload&#39;s successor, MEGA.</p><p>Finally, I wouldn&#39;t trust any one dude you get an answer from on the internet, including myself. I would do a lot of research about this sort of thing before committing to a solution. Also, I might recommend asking this question over at the <a href="https://security.stackexchange.com/">IT Security Stack Exchange</a>.</p><p>-- EDIT --</p><p>Somehow, I totally missed the fact that there are three parts to your system, the client (browser), the server (database), and the connector that imports data from the VisualFox Database. This actually makes the whole system a lot more complex, because there are essentially three parties that need to share a secret, instead of two. What I would recommend is not to encrypt the data based on the users password, but to instead encrypt it based on some server password. I&#39;m having a little bit of trouble thinking of a good way to describe this process, so I&#39;ll give you an example workflow instead.</p><p><strong>Server Side</strong></p><ol><li>Admin starts server.</li><li>During start up, server code asks for a password.</li><li>Server uses PBKDF2 to derive a key which is stored only in memory.</li><li>Server spawns a thread that will poll the VirtualFox Pro server every X (days/hours/minutes) for updated data.</li><li>Server enters loop awaiting requests from browser clients.</li></ol><p><strong>Updating database</strong></p><ol><li>Main Server&#39;s child thread requests an update of data from the Virtual Fox Pro server.</li><li>VirtualFox Pro server dumps a report containing data for client&#39;s with modified entries.</li><li>VirtualFox Pro server opens secure connection to main server (ssh, sftp, etc) and transmits zipped data.</li><li>One by one, the main server uses the PBKDF2 derived key that is stored in memory to decrypt blobs stored in a database, update them with new data, reencrypt them, and store them back into the database. This process should all happen in-memory.</li></ol><p><strong>Browser client connects</strong></p><ol start="11"><li>Main server receives https request from client.</li><li>Main server uses some third party authentication framework to check clients credentials. This framework should use bcrypt to hash passwords and only store the hashes on the file system.</li><li>If the authentication framework positively identifies a user, the main server will decrypt the user&#39;s blob using the PBKDF2 derived key in memory and send the data to the user.</li><li>When the user&#39;s authentication cookie expires, the main server will stop using the PBKDF2 derived key to decrypt data, and will instead prompt the user to re-authenticate.</li></ol><p>This model is more in line with how traditional websites work (which means that you can rely on third party, bug tested frameworks), but data is encrypted/decrypted in memory before touching the database. Ideally, you could use GPG or some other keystore for managing the encryption keys on the main server as well.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../how-to-handle-encryption-key-conflicts-when-synchronizing-data/'>How to handle encryption key conflicts when synchronizing data</a></li><li class="list-group-item"><a href='../whats-safest-way-to-tell-if-decryption-was-successful/'>Whats safest way to tell if decryption was successful</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>