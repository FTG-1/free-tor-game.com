<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="https://free-tor-game.com/wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>C# &#8211; Should Entity Framework 6 not be used with repository pattern &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.min.js?ver=11.2.0' id='highlight-js'></script>     <script>( function( w, d, s, l, i ) {
				w[l] = w[l] || [];
				w[l].push( {'gtm.start': new Date().getTime(), event: 'gtm.js'} );
				var f = d.getElementsByTagName( s )[0],
					j = d.createElement( s ), dl = l != 'dataLayer' ? '&l=' + l : '';
				j.async = true;
				j.src = 'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
				f.parentNode.insertBefore( j, f );
			} )( window, document, 'script', 'dataLayer', ' ' );</script>      <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1072003 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="https://free-tor-game.com/3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="https://free-tor-game.com/contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1072003" class="post-1072003 software type-software status-publish hentry category-software tag-c tag-design-patterns tag-entity-framework tag-orm tag-repository-pattern"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">C# &#8211; Should Entity Framework 6 not be used with repository pattern</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">c</span><span class="mr-2 badge badge-info">design-patterns</span><span class="mr-2 badge badge-warning">entity-framework</span><span class="mr-2 badge badge-primary">orm</span><span class="mr-2 badge badge-danger">repository-pattern</span></p><div class="entry-content"><p>So I am asking this after reading the following: <a href="https://softwareengineering.stackexchange.com/questions/180851/why-shouldnt-i-use-the-repository-pattern-with-entity-framework/220126">Why shouldn&#39;t I use the repository pattern with Entity Framework?</a>.</p><p>It seems there is a large split of people who say yay and those that say nay. What seems to be missing from some of the answers are concrete examples, whether that be <code>code</code> or good reasoning or whatever.</p><p>The issue is I keep reading people responding saying &#34;well EF is already abstraction&#34;. Well that&#39;s great, and that&#39;s probably true, but then how would you use it without the repository pattern?</p><p>For those that say otherwise, why would you say otherwise, what personally have you run into that made is necessary?</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>To get this out of the way, I am a big proponent of Entity Framework, but it does come with some drawbacks that you need to be aware of.</p><p>I also apologize for the long answer, but this is a very hot topic with many opinions and many required considerations. For small application, a lot of these considerations don&#39;t matter, but for enterprise-grade applications they do matter a lot.</p><p>Part of what makes the EF discussion such a hot topic is that it leads to a chain of events, where each solution introduces a new problem (which sometimes only applies in more advanced cases). If I just gave you the final (or should I say current) answer, you&#39;d think that I was omitting several other solutions, so I think it&#39;s relevant to walk you through the solutions and how they are not the final solution to the problem.</p><hr/><h2>Repositories</h2><blockquote><p>how would you use it without the repository pattern?</p></blockquote><p>The short answer to that is that (simple) repositories are an <strong>anti-pattern*</strong> to Entity Framework.</p><p>EF provides a context, which essentially provides access to the whole database. You can e.g. fire a query that returns all Country entities with their Province entities already filled in, with each province&#39;s City entities already filled in. In short, it enables to you execute multiple-entity-type queries (this is a phrase I coined myself in order to explain the difference with repositories).</p><p>Repositories, at least the basic implementation thereof, tend to take a &#34;one entity type per repository&#34; approach. If you want to get a list of all countries with all their provinces and all of the province&#39;s cities, you&#39;ll have to separately talk to the <code>CountryRepository</code>, <code>ProviceRepository</code> and <code>CityRepository</code>. In short, repositories limit you to only being able to execute single-entity-type queries. For the same example, you would have to launch 3 separate database queries in order to get all countries and their provinces and their cities.</p><p>And don&#39;t get me wrong, I like repositories. I like having the neat little boxes so you can separate your storage of different domain objects, which e.g. would allow you to get the countries from your database but the provinces from a remote API and the cities for a second remote API.</p><p>But this separation of entity types into their own private boxes very much clashes with the benefit of having relational databases, where part of the benefit is that you can launch a single query that can take related entities into account (for filtering, sorting or returning).</p><p>You might rightly respond that <em>&#34;a repository can still return more than one entity type&#34;</em>. And you would be correct. But if you have a query which returns both <code>Foo</code> and <code>Bar</code> entities, where do you place it? In the <code>FooRepository</code>? In the <code>BarRepository</code>? There may be examples where the choice is easy, but there are also examples where the choice is hard and multiple developers may have different categorization methods and thus the codebase becomes inconsistent and the true purpose of the &#34;one entity type per repository&#34; approach will be thrown out the window.</p><hr/><p><em>*When I say repositories are an anti-pattern, that is not a global statement, but rather than they specifically counteract the purpose of EF. Without EF or a similar solution, repositories are not an anti-pattern.</em></p><hr/><h2>Query objects</h2><p>Query objects are the only real way to get around the &#34;one entity type per repository&#34; approach. The shortest way I can describe what a query object is, is that you should think of it as a &#34;one method repository&#34;.</p><p>Repositories suffer from having to deal with multiple types of entities, and the more methods a repository has, the more distinct entity types it&#39;s likely going to be handling. By separating each repository method into a query object of its own, you&#39;ve simply removed the contradictory suggestion that &#34;this repository only handles one type&#34;, and instead are suggesting that &#34;this query object runs this particular query, regardless of which entity types it needs to use&#34;.</p><p>You can still use repositories at the same time, and you are then able to <strong>enforce</strong> that repositories will never handle more than their designated entity type.</p><ul><li>If a query makes use of more than one entity type (e.g. <code>Country</code> and <code>Province</code>), then it belongs in its own private query object (e.g. <code>CountriesAndTheirProvincesQuery</code>).</li><li>If a query only focuses on one entity type (e.g. <code>Country</code>), then it belongs to that entity type&#39;s repository (e.g. <code>CountryRepository</code>).</li></ul><p>On a technical level, query objects work exactly like repositories do. The only difference is that you separate the logic differently by no longer trying to pretend that your multi-entity-type queries belong to a single-entity-type repository.</p><hr/><h2>Repositories 2</h2><p>There is a second problem pertaining to repositories. As they are separate classes, they do not depend on each other. This usually also means that each repository will use their own EF context (I&#39;m omitting dependency injection here as it sidetracks the focus of the answer).</p><p>Suppose you are doing an import, which adds countries and cities to the database. However, you want transactional safety, meaning that when <em>any</em> failure is encountered, then <em>nothing</em> should be saved to the database.<br/> But when you have to deal with two repositories that each have their own context, how can you knowingly call <code>SaveChanges()</code> on one context before knowing that the other context&#39;s <code>SaveChanges()</code> succeeded? You&#39;re going to have to guess, and you&#39;re going to be stuck manually undoing the first context&#39;s commit when the second context&#39;s commit ends up failing.</p><p>By separating the repositories, you&#39;ve removed their ability to have a <em>shared</em> context, which you need in times where you&#39;re dealing with transactions that operate on more than one entity type at the same time.</p><hr/><h2>Unit of work</h2><p>In any sufficiently large codebase or domain where I&#39;ve used repositories and EF, I&#39;ve ended up implementing a unit of work to at least somewhat counter the problem of transactional safety.</p><p>Very simply put, a unit of work is a collection of all repositories, it forces the repositories to share the same context, and it allows for the developer to directly commit/rollback the context for all repositories at the same time. A simple example:</p><pre><code>public class UnitOfWork : IDisposable
{
    public readonly FooRepository FooRepository;
    public readonly BarRepository BarRepository;
    public readonly BazRepository BazRepository;

    private readonly MyContext _context;

    public UnitOfWork()
    {
        _context = new MyContext();

        this.FooRepository = new FooRepository(_context);
        this.BarRepository = new BarRepository(_context);
        this.BazRepository = new BazRepository(_context);
    }

    public void Commit()
    {
        _context.SaveChanges();
    }

    public void Dispose()
    {
        _context.Dispose();
    }
}
</code></pre><p>And a simple usage example:</p><pre><code>using (var uow = new UnitOfWork())
{
    uow.FooRepository.Add(myFoo);
    uow.BarRepository.Update(myBar);
    uow.BazRepository.Delete(myBaz);

    uow.Commit();
}
</code></pre><p>And now we have transactional safety. Either all three objects are handled in the database, or none of them are.</p><hr/><h2>But Entity Framework is a framework! (personal note)</h2><p>Maybe you&#39;ve noticed, maybe you haven&#39;t, but you should see strong similarities to EF&#39;s <code>DbContext</code> and the <code>UnitOfWork</code> I just created. They are essentially the same thing. They represent a single transaction to the database, and offer access to collections of all available entity types:</p><pre><code>public class UnitOfWork
{
    public readonly FooRepository FooRepository;
    public readonly BarRepository BarRepository;
    public readonly BazRepository BazRepository;

    public void Commit() { }
}

public class MyContext : DbContext
{
    public Set&lt;Foo&gt; Foos { get; private set; }
    public Set&lt;Bar&gt; Bars { get; private set; }
    public Set&lt;Baz&gt; Bazs { get; private set; }

    public int SaveChanges() { }
}
</code></pre><p>EF&#39;s <code>DbContext</code> satifies <a href="https://martinfowler.com/eaaCatalog/unitOfWork.html" rel="noreferrer">the definition of what a unit of work is</a>:</p><blockquote><p>A Unit of Work keeps track of everything you do during a business transaction that can affect the database. When you&#39;re done, it figures out everything that needs to be done to alter the database as a result of your work.</p></blockquote><p><strong>So why do we do this?</strong> Well, simply put, because developers always try to abstract dependencies. We don&#39;t want the business layer to directly depend on EF. This is the exact same reason why you&#39;ve been creating repositories in the first place: so that your business logic doesn&#39;t directly use EF.</p><p>But what&#39;s the point of it all? Why do we use EF, then anti-patterned repositories, and then an anti-anti-patterned unit of work to make it all workable? This costs so much effort. We have to manually write search filters instead of being able to innately rely on EF&#39;s ability to parse (pretty much) any lambda method we throw at it. <strong>Why are we going through all this effort instead just to use EF in the way it&#39;s already intended to work out of the box?</strong></p><p>And I have to admit that I&#39;ve had this question for a long time but I find little support for my opinion. If you allow me to soapbox for a moment; my opinion on the matter is that this is why EF is called Entity <strong>Framework</strong> and not Entity Library.<br/> The difference between frameworks and libraries is often semantial and up for debate, but I think an agreeable line can be drawn <a href="https://stackoverflow.com/a/148759/952296">as explained here</a>:</p><blockquote><p>A library performs specific, well-defined operations.</p><p>A framework is a skeleton where the application defines the &#34;meat&#34; of the operation by filling out the skeleton. The skeleton still has code to link up the parts but the most important work is done by the application.</p></blockquote><p>This description of a framework fits with EF to a tee. It pretty much does the whole DB interaction for us, but it requires us to extend <code>DbContext</code> with the entities (and model configuration) that we expect EF to use.</p><p>We abstract dependencies (libraries) because we can, and because the benefit of doing so (swappability) far outweighs the drawback (effort required to implement the abstraction). But frameworks, the skeleton of a system, are not easily replaced because they cannot be easily abstracted. The effort is much greater than the likelihood of needing to replace the dependency, and thus it&#39;s no longer worth the effort to do so.</p><p>I think that in order to cut out a lot of boilerplating code, it would be beneficial to consider EF as a framework that we build the application around and cannot easily move away from (the same way we can for a library). This means that we can do away with the repositories and the unit of work altogether, as their only purpose is to give access to the features EF already has; and instead use EF directly and accept that its usage is an architectural choice that we do not implement with the intention of easily moving away from it.</p><p>This means we could cut out the repositories and unit of work, and instead have our business logic deal with the context directly. Notice how the business logic code hardly changes:</p><pre><code>// OLD

using (var uow = new UnitOfWork())
{
    uow.FooRepository.Add(myFoo);
    uow.BarRepository.Update(myBar);
    uow.BazRepository.Delete(myBaz);

    uow.Commit();
}

// NEW

using (var db = new MyContext())
{
    db.Foos.Add(myFoo);
    db.Bars.Update(myBar);
    db.Bazs.Delete(myBaz);

    db.SaveChanges();
}
</code></pre><hr/><blockquote><p>The issue is I keep reading people responding saying &#34;well EF is already abstraction&#34;. Well that&#39;s great, and that&#39;s probably true, but then how would you use it without the repository pattern?</p></blockquote><p>By using EF directly and no longer trying to abstract it behind a self-developed wall of repositories (and possibly a unit of work).</p><blockquote><p>For those that say otherwise, why would you say otherwise, what personally have you run into that made is necessary?</p></blockquote><p>The answer is sort of a recapitulation of my experience with EF over the last 6 to 7 years. Basic repositories by themselves introduce more problems than they solve. There are advanced solutions that solve the problems introduced by basic repositories; but you do eventually reach a point where you start wondering if it&#39;s not better to simply choose to not use repositories so you don&#39;t have to spend the effort to get them to play nicely with EF.</p><p>Can they be made to play nicely with EF? Sure thing. Is it worth the effort to create all that abstraction? That very much depends on the likelihood of you moving away from EF (or using a datastore that&#39;s incompatible with EF).</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='https://free-tor-game.com/software/entity-framework-with-large-systems-how-to-divide-models/'>Entity Framework with large systems &#8211; how to divide models</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/design-repository-pattern-without-entity-framework/'>Design &#8211; Repository pattern without entity framework</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/repository-pattern-and-custom-queries-rest-api-is-it-the-right-approach/'>Repository Pattern and custom queries/REST API. Is it the right approach</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/c-dbcontext-with-nested-classes-containing-the-repository-methods/'>C# DbContext with nested classes containing the Repository methods</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/if-repository-pattern-is-overkill-for-modern-orms-ef-nhibernate-what-is-a-better-abstraction/'>If Repository Pattern is overkill for modern ORMs (EF, nHibernate), what is a better abstraction</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/web-api-vs-entity-framework-with-repository-pattern-using-xamarin/'>Web API vs Entity Framework with Repository Pattern using Xamarin</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/c-generic-repository-pattern-ef-and-unit-of-work/'>C# &#8211; Generic repository pattern +EF and unit of work</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/avoiding-repository-pattern-implementing-onion-architecture-with-dbcontext-only/'>Avoiding Repository pattern &#8211; implementing Onion Architecture with DbContext only</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='http://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="https://free-tor-game.com/wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>