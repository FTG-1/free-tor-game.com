<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>C# &#8211; Accessing shared data without blocking in TPL &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1073727 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1073727" class="post-1073727 software type-software status-publish hentry category-software tag-c tag-concurrency tag-locks tag-task"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">C# &#8211; Accessing shared data without blocking in TPL</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">c</span><span class="mr-2 badge badge-info">concurrency</span><span class="mr-2 badge badge-warning">locks</span><span class="mr-2 badge badge-primary">task</span></p><div class="entry-content"><p>I am writing a class that contains data. It exposes methods that allow to query the data, while the data is also being updated from an external source (web service, for example).</p><p>All the methods expose tasks that are started on a worker thread using the default task scheduler. So the structure of the class is as follows:</p><pre><code>public class A
{
    private object _myLock;

    public Task&lt;int&gt; GetSomeNumber(int aParameter)
    {
        return Task.Run(() =&gt;
        {
            lock (_myLock)
            { 
                int result = 0;
                // calculate the result...
                // ...
                return result;
            }
        });
    }

    public Task&lt;string&gt; GetSomeText(int aParameter)
    {
        return Task.Run(() =&gt;
        {
            lock (_myLock)
            {
                string result = &#34;&#34;;

                // calculate the result...
                // ...
                return result;
            }
        });
    }
}
</code></pre><p>The methods may be called several multiple times, while the data itself is being updated, so the calculations that require the shared data are surrounded with a lock statement. The problem is that this code blocks the thread in which the task is run. Of course, these are not UI thread, so the UI remains responsive, but it does consume threads and keeps them blocked. I would prefer for the worker threads in the thread pool to remain as available as possible.</p><p>Is there a way, a best practice of some sort, that allows to write this code so that the shared data is thread safe and at the same time the tasks are not blocked? If instead of waiting for a lock, the tasks would need to wait for something else to finish (a task), I would use <code>ContinueWith</code> in order to create a continuation task and return it, so that it would be scheduled to run when the first task is completed. Is there a way to do the same with lock, so that the task is only scheduled when the lock is available?</p><p><strong>Update</strong><br /> I have done some reading and found out about several possible options that allow for shared data sync. These include: <code>SemaphoreSlim</code>, <code>AsyncLock</code>, and <code>ConcurrentExclusiveSchedulerPair</code>.</p><p>I would love to see a recommendation for a best practice, of writing a service class that provides &#34;read only&#34; task methods that can run concurrently with a read lock, and &#34;write&#34; task methods that require write lock.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>This answer is based on the additional information about the use case mentioned in the comments.</p><blockquote><p>We have a web service the provides graph nodes. We hold a local copy
 of part of the graph and expose and async API to query the graph. If
 the area that you query is in the cache then we simply calculate and
 return the result, otherwise we start downloading the missing part and
 then perform the calculation and return the result. There is also a
 recurring task in the background that polls the server for changes in
 the node and applies the changes to the local cache.</p></blockquote><hr/><p>One should realize that if a request cannot be completed right away because the data needed to fulfill the request is simply not available (e.g. haven&#39;t been downloaded or cached), there are only a few choices:</p><ul><li>Return a failure right away. This is similar to the <code>TryGet</code> pattern, which does not block - but the task won&#39;t succeed.</li><li>Return a failure right away, but also indicate that it has started an asynchronous request to fetch data from the external server. This way, the reader won&#39;t block, but will have to retry at a later time.</li><li>Require the reader to provide a callback function, which will be called later when the data is available. This can be combined with the asynchronous request approach.</li><li>Block the reader until the data has been fetched.</li></ul><p>Each of the options above has its own set of &#34;best practices&#34; and integration patterns with TPL. It would be too much to discuss all of them here.</p><p><strong><em>Help needed:</em></strong> If anyone knows of good online resource that covers the best practices for these options, please post as comments.</p><hr/><p>If you decide that blocking the reader is the only choice given the requirements of your application, keep in mind that:</p><ul><li>The .NET default thread pool is elastic - meaning that it will launch more worker threads if it senses that some threads are being blocked. This is good. It means that blocking any number of readers will not result in system-wide failure.</li><li>If it is not elastic, your application may deadlock due to worker thread starvation (exhaustion).</li><li>You must therefore <strong>never</strong> change the settings on the default thread pool that will cause it to lose the elasticity - unless you are willing to reboot your service whenever that happens.<ul><li>For example, do not set a maximum number of worker threads.</li></ul></li></ul><hr/><p>If you want the concurrent readers to never get stuck (being obstruction free), I think you have several choices:</p><hr/><p><strong>Multiple buffering</strong></p><p><a href="http://en.wikipedia.org/wiki/Multiple_buffering" rel="nofollow">Link to Wikipedia article</a></p><ul><li>The system maintains multiple copies of the graph, and rotate (cycle through) them whenever a modification is needed.</li><li>At any point in time, at most one copy will be modified. All other copies will be read-only.</li><li>When a modification is taking place, each reader must choose between:<ul><li>Reading from one of the other read-only, slightly out-of-date copies of the graph. Multiple readers can access it concurrently.</li><li>Wait until the modification is complete, to make sure it will have access to the most up-to-date version of the graph.</li></ul></li></ul><hr/><p><strong>Concurrent graph update algorithms</strong></p><p>The exact details will depend on what operations and algorithms are needed for the application.</p><p>Some of them may be lock-free, using the hardware-enabled atomic instructions. Others may use various kinds of locks, but may try to minimize the probability or the length of time where readers might be blocked.</p><p>One may either use an existing library or implement one&#39;s own.</p><p>I&#39;m not familiar with concurrent graph update algorithms, so I can&#39;t give much suggestions.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../c-why-does-shared-state-degrade-performance/'>C# &#8211; Why does shared state degrade performance</a></li><li class="list-group-item"><a href='../java-apple-dispatch-queue-vs-threads/'>Java &#8211; Apple Dispatch Queue vs Threads</a></li><li class="list-group-item"><a href='../java-difference-between-consumer-producer-and-observer-observable/'>Java &#8211; Difference between Consumer/Producer and Observer/Observable</a></li><li class="list-group-item"><a href='../c-does-readerwriterlockslim-provide-thread-safety-and-speed-efficiency-compared-to-a-traditional-lock-when-using-a-list/'>C# &#8211; Does ReaderWriterLockSlim provide thread safety and speed efficiency (compared to a traditional lock) when using a List</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>