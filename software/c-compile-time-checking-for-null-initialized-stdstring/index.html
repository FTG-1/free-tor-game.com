<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>C++ &#8211; Compile-time checking for NULL initialized std::string &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1073665 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1073665" class="post-1073665 software type-software status-publish hentry category-software tag-c tag-c11 tag-null tag-strings"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">C++ &#8211; Compile-time checking for NULL initialized std::string</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">c</span><span class="mr-2 badge badge-info">c++11</span><span class="mr-2 badge badge-warning">null</span><span class="mr-2 badge badge-primary">strings</span></p><div class="entry-content"><p>This is sort of the complementary question to <a href="https://softwareengineering.stackexchange.com/questions/220687/how-to-best-protect-from-0-passed-to-stdstring-parameters">How to best protect from 0 passed to std::string parameters?</a>. Basically, I&#39;m trying to figure out whether there is a way to have the compiler warn me if a code path would unconditionally try to call <code>std::string</code>&#39;s <code>char*</code> constructor using <code>NULL</code>.</p><p>Run time checks are all well and good, but for a case like:</p><pre><code>std::string get_first(const std::string&amp; foo) {
    if (foo.empty()) return 0; // Or NULL, or nullptr
    return foo.substr(0, 1);
}
</code></pre><p>it&#39;s annoying that, even though the code is guaranteed to fail if that code path is exercised, and the system header is usually annotated with the precondition saying that the pointer must not be null, this still passes compilation under <code>gcc</code>, <code>clang</code>, etc., even with <code>-std=c++11 -Wall -Wextra -pedantic -Werror</code>. I can block the specific case of <code>0</code> on <code>gcc</code> with <code>-Werror=zero-as-null-pointer-constant</code>, but that doesn&#39;t help with <code>NULL</code>/<code>nullptr</code> and it&#39;s sort of tackling the related but dissimilar problem. The major issue is that a programmer can make this mistake with <code>0</code>, <code>NULL</code> or <code>nullptr</code> and not notice it if the code path isn&#39;t exercised.</p><p>Is it possible to force this check to be compile time, covering an entire code base, without nonsense like replacing <code>std::string</code> with a special subclass throughout the code?</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>There are different approaches, depending on whether it should work on all compilers, in very restricted circumstances and with some side-effects, or only on some, but in exchange far more broadly:</p><ol><li><p>Adding overloads which complain when used. There is <a href="http://en.cppreference.com/w/cpp/language/attributes" rel="nofollow"><code>[[deprecated]]</code></a> since C++11 which will complain at the immediate call-site, as long as it&#39;s not suppressed, like normally in a system-header.</p><p>GCC and CLANG provide a better suited custom attribute, <a href="https://gcc.gnu.org/onlinedocs/gcc/Common-Function-Attributes.html#Common-Function-Attributes" rel="nofollow"><code>__attribute__((error(&#34;message&#34;)))</code></a>, which will always break the build if the function is used and name the call-site.</p><p>The problem with adding overloads accepting all those things which could be nullpointer-literals, is that it might confuse other template&#39;s SFINAE, thus breaking code, and cannot catch an argument already of type <code>char*</code> which unfortunately just happens to be a nullpointer:</p><pre><code>// added overload, common lines:
template&lt;class X, class = typename
    std::enable_if&lt;std::is_arithmetic&lt;X&gt;() &amp;&amp; !std::is_pointer&lt;X&gt;()&gt;
// best on GCC / clang:
string(X) __attribute__((error(&#34;nullpointer&#34;)));
// best on others:
[[deprecated(&#34;UB&#34;)]] string(X) /* no definition, link breaks */;
</code></pre></li><li><p>The preferable alternative is marking the argument as non-null, and letting the compilers optimizer figure it out. You are asking for and heeding such warnings, right?<br/> That&#39;s only an option in GCC and CLANG, but it avoids the disadvantage of additional overloads and catches all cases the compiler can figure out, which means it works better with more optimization.</p><pre><code>basic_string(const CharT* s,
             size_type count,
             const Allocator&amp; alloc = Allocator()) __attribute__((nonnull));
basic_string(const CharT* s,
             const Allocator&amp; alloc = Allocator()) __attribute__((nonnull));
</code></pre><p>Generally, one can ask GCC / clang whether it can determine the value of any expression at compile-time, using <a href="https://gcc.gnu.org/onlinedocs/gcc-3.4.5/gcc/Other-Builtins.html" rel="nofollow"><code>__builtin_constant_p</code></a>.</p></li></ol></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../database-sql-empty-string-vs-null-value/'>Database &#8211; SQL: empty string vs NULL value</a></li><li class="list-group-item"><a href='../c-what-performance-can-we-expect-from-stdstrings-c_str-always-constant-time/'>C++ &#8211; What performance can we expect from std::string&#8217;s c_str()? Always constant time</a></li><li class="list-group-item"><a href='../c-are-there-real-world-examples-demonstrating-reasonable-performance-improvement-by-using-move-semantics/'>C++ &#8211; Are there real world examples demonstrating reasonable performance improvement by using move semantics</a></li><li class="list-group-item"><a href='../c-key-value-store-development-porting-to-modern-c/'>C++ &#8211; Key / Value store development porting to modern C++</a></li><li class="list-group-item"><a href='../c-when-should-i-use-string_view-in-an-interface/'>C++ &#8211; When should I use string_view in an interface</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>