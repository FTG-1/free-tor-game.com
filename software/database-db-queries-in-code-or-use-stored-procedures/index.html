<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Database &#8211; DB Queries in code or use Stored Procedures &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1070978 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1070978" class="post-1070978 software type-software status-publish hentry category-software tag-architecture tag-database tag-query tag-sql tag-stored-procedures"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Database &#8211; DB Queries in code or use Stored Procedures</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">Architecture</span><span class="mr-2 badge badge-info">database</span><span class="mr-2 badge badge-warning">query</span><span class="mr-2 badge badge-primary">sql</span><span class="mr-2 badge badge-danger">stored-procedures</span></p><div class="entry-content"><p>Some of my colleagues tells me that using stored procedures in the database adds to much business logic in the database, and that you should keep the data separate from logic. Other colleagues tells me that adding DB Queries in source code as strings is not only hard to change, but also poses a security risk.</p><p>I&#39;m leaning towards to put stored procedures in the database, as long as you only use them for simple tasks like getters and setters and avoid business logic in the database.</p><p>I know its possible to add an ORM layer in between the database and the logic using Entity Framework or similar, which may solve both problems. But I&#39;m still not sure which way is the best in this scenario.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>There&#39;s a few things to consider here, which I&#39;ll try to explain in enough detail to help you understand the problem space. Personally, for RDMS&#39;, I prefer using stored procedures, reasons for which I&#39;ll go into in a moment.</p><hr/><p>In any discrete application layer, there is a need to ensure that the boundary of that layer has sufficient controls in place to prevent dirty data from entering the layer, which could then cause corruption. This is the case regardless of whether the layer is an API exposed publicly, an internal API (e.g. front controller negotiating with services), or calls to an external layer (e.g. communicating with the data store). In DDD this is called the Anti-Corruption Layer, in OOP it goes by a few names (Design By Contract, Assertions, Pre-/Post-Conditions), and it can take as simple a form as strongly typing input and output variables. In any case, the purpose of this layer is to ensure that the layer can consistently and predictably enforce communication standards for input and output operations.</p><p>What does this have to do with stored procedures vs. ad hoc SQL?</p><p>Allowing ad hoc SQL to be executed against the database is a form of <a href="https://en.wikipedia.org/wiki/Cowboy_coding" rel="noreferrer">cowboy coding</a>, in that the SQL query itself is not governed, the only measure of it&#39;s validity is whether or not it executes successfully, and the only safety net in place is wisdom (of the application) by the developer and/or code reviewer. Combine this with a latent notion that no business logic should go into the database (i.e. no constraints or triggers to ensure data structure remain intact), and you begin introducing risks to data integrity. An example of this is an object being saved to database that needs to be updated/inserted in multiple tables - if you miss an insert statement or two, you could end up with invalid, meaningless, or orphaned data. If you used stored procedures, you could ensure that all operations of that type adhere to the requirement to insert/update <em>all</em> relevant rows.</p><p>The bone I have to pick with the notion that business logic does not belong in the database is twofold:</p><ol><li>A database is tightly coupled with the application utilising it as it&#39;s data store. To consider the database and the application as separable is not possible - one may not meaningfully exist without the other.</li><li>Business logic is comprised of two main ideas: business rules, and data logic. Business rules belong in the application, data logic belongs in the data store.</li></ol><p>My first point should be reasonably obvious and require no further explanation. My second point requires some expansion though...</p><p>With the advent of NOSQL and DDD, it is clear that modern data and data usage is increasing in complexity, and in many cases data is being thought about in terms of rich entities that have their own internal structure and governing rules. The rules around what makes a rich object valid are it&#39;s <em>business rules</em>. How the data is stored is the <em>data logic</em>. Data logic, or how the object hangs together in storage, is entirely different to whether that form is sensible in the context of business rules. Your data architect may think that a certain object should be stored in the database as a set of rows across multiple tables, or one row as a JSON string - either way the object remains valid in the context of business rules. Data storage concerns are typically different to business rules concerns, and revolve around things like:</p><ul><li>How fast will a CRUD operation be, and will it run risks of locking or delays?</li><li>How efficient are <code>SELECT</code> operations on the data?</li><li>How many indexes, statistics tables, and other optimisations will be required, and what impact will they have on write operations?</li><li>Is the data uniquely identifiable?</li><li>Is the data stored efficiently given the data types available?</li></ul><p>Answers to these questions may change at a different rate or at different times to enhancements in the application. By separating out data logic from business rules, you empower the data administrator to choose the data schema and functionality that is best fit for purpose. By exposing data interactions (both get and set) only via stored procedures, you can retain a consistent interface for the parent application whilst allowing the data administrator the freedom to make changes to the underlying data structure as they see fit.</p><p>What needs to be considered though is how much capacity does the business (read: IT Dept) have to support ideological design decisions. It may be the case that you are a small company, where one person does the front end, back end, and database work. You may be in a large organisation where there are teams assigned to each application layer. The less people working on the code, the more broad knowledge they have (q.v. <a href="https://en.wikipedia.org/wiki/Information_silo" rel="noreferrer">Information Silo</a>), which can lead to a lack of assertions between layers, as the developer knows everything about the process and neglects to include logical assertions. But, (whether large or small) the more indirection and assertions you implement in your code, the longer it takes to write and maintain. You have to weigh up the theory with the practice, idealism and pragmatism. On top of this, you need to consider whether the application has a limited lifetime, what skill sets staff have, how they are managed, how tightly the SDLC is governed, and above all people&#39;s personalities and coding habits. This is the horrible and scary world of Technical Leads and Senior Management.</p><hr/><p>While think about it, here is an example that demonstrates where business rules can validly fit into the database, and rightly sit there. This isn&#39;t to be cantankerous, but to demonstrate that aphorisms such as &#34;Business logic does not belong in the database&#34; have exceptions, no matter how noble their idea is:</p><blockquote><p>Let us suppose we have a client management system where people&#39;s
 details are stored, and changes to those details are stored in an
 audit log table. We want a new function in the application where a
 moderator can flag a client as having not provided tax details for
 this FY, which has the flow-on effect of taxing all transactions at the top rate.
 The developer codes up this new functionality but neglects to include an insert into the audit table. They then pass it to a senior
 for peer review, and for one reason or another it passes peer review
 and enters production. A few months later a client complains that they
 are being erroneously charged the maximum taxation rate. The root cause
 of the problem is the developer - but there was a business user who
 performed the update incorrectly, which is an indication of a gap in
 knowledge or training. This cannot be addressed as there is no record
 in the audit log table stating which user performed the update and when.
 The underlying code issue can be solved, but only time will tell when the
 operational issue can/will be addressed.</p></blockquote><p>This problem was a result of ad hoc SQL that performed it&#39;s own CRUD operation on a database without considering the company policy that &#34;All changes to data must be recorded for auditing purposes&#34;. The database did not complain, because an <code>UPDATE</code> statement that sets the <code>invalildTaxFileDetails</code> column to <code>1</code> is entrirely valid in the context of the <code>BIT</code> data type. Yet, the data has now lost it&#39;s integrity, which could result in financial and/or reputational risk to the company. In some cases, this may go entirely unnoticed, and clients may be overcharged for their entire engagement period, and then take their business elsewhere due to competitive costing, without realising that they are even entitled to a refund.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../c-how-to-suggest-using-an-orm-instead-of-stored-procedures/'>C# &#8211; How to suggest using an ORM instead of stored procedures</a></li><li class="list-group-item"><a href='../c-whether-to-put-the-business-logic-in-stored-procedure-or-not/'>C# &#8211; Whether to put the business logic in Stored Procedure or Not</a></li><li class="list-group-item"><a href='../when-not-to-use-orm-and-prefer-stored-procedures/'>When not to use ORM and prefer stored procedures</a></li><li class="list-group-item"><a href='../do-stored-procedures-violate-three-tier-separation/'>Do stored procedures violate three-tier separation</a></li><li class="list-group-item"><a href='../design-when-should-i-use-stored-procedures/'>Design &#8211; When should I use stored procedures</a></li><li class="list-group-item"><a href='../architecture-microservices-and-stored-procedures/'>Architecture &#8211; Microservices and stored procedures</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>