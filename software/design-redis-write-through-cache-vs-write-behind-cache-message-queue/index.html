<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Design &#8211; Redis write-through cache vs write-behind cache (message queue?) &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1086405 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1086405" class="post-1086405 software type-software status-publish hentry category-software tag-caching tag-design tag-redis"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Design &#8211; Redis write-through cache vs write-behind cache (message queue?)</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">caching</span><span class="mr-2 badge badge-info">design</span><span class="mr-2 badge badge-warning">redis</span></p><div class="entry-content"><p>I have a simple use case:</p><ul><li>Newsfeeds aggregated based on posts that are linked to geopoints</li><li>Users can comment on feed posts</li><li>Users can like feed posts and comments</li></ul><p>I&#39;m certain that Redis as a cache can provide me with what I need if this app were to come under high load, however I am a bit puzzled about the following options:</p><p><strong>Write-through cache</strong></p><p>Java app -&gt; Redis -&gt; DB</p><p>Seems like the best option data consistency-wise, in that the request will only return when the database has been updated. However the disadvantage implies that no batch updates are possible.<br /> If the app were to come under heavy load, this doesn&#39;t seem to be the best option.</p><p><strong>Write-behind cache</strong></p><p>Java app -&gt; Redis -&gt; Java app (batch config) -&gt; DB</p><p>Seems like the best option performance wise. In case of heavy load, data is transferred from the cache to the DB through Java (configuring batch sizes, delay etc).<br /> However, the disadvantage seems that if there is a system failure on Redis, all in-memory data is gone (?)!</p><p>My question is simple:</p><ul><li>Does a high-availability cluster with write-behind cache solve all of my problems?</li><li>Does high-availability write to disk (Redis), guaranteeing that no data will be lost?</li><li>Even with write-behind cache, is it the safest course of action to add a message queue (eg RabbitMq) or is this generally not necessary even under high load?</li></ul><p>Missing posts in a user app like this in case of failure is a big no-no, so I wonder what is your view on this, and what is the best resolution of the problem.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>Your question is specific, so I&#39;ll answer it head-on first.</p><p>I anticipate that <strong>&#34;write-behind&#34; cache will be better</strong>. &#34;write-through&#34; might help with occasional spikes in ingress data, but won&#39;t alleviate the problem of disk throughput (and transaction throughput).</p><p>Of course, this would need to be verified in real-life with benchmarking.</p><hr/><p><strong>My recommended implementation</strong></p><p>I strongly recommend that you don&#39;t overengineer your architecture. Less is more.</p><p>YAGNI: Start simple and tunable, then update your architecture as needed.</p><p><strong>1. Bypass the Java and Redis, and write directly to the database</strong></p><ul><li>see <a href="https://colossal.gitbook.io/microprocess/definition/data-web-gateway" rel="nofollow noreferrer">https://colossal.gitbook.io/microprocess/definition/data-web-gateway</a>. This approach lets you write directly to the database over HTTP.</li><li>Choose MariaDB(MySQL) as the database and choose the InnoDB engine; I am quite sure that it generally has higher throughput than PostgreSQL, and supports a higher number of concurrent connections (~200k vs 500) - but you should measure that yourself using the target hardware/VM that you plan to use. (see [Compatible Database Performance Comparisons] in <a href="https://colossal.gitbook.io/microprocess/database-system/introduction" rel="nofollow noreferrer">https://colossal.gitbook.io/microprocess/database-system/introduction</a>)</li><li>Have a table with the available Database-Web-Gateway endpoints (that you can add to in the future) and have your client connect to a random one; <code>select * from View_DataWebGateways order by RAND() limit 1;</code></li><li>Use a writeable view so that you can point straight to the <code>posts</code> table today, and be able to change that in the future. Query something like: <code>insert into WriteView_Posts (...) values (...)</code>. The same goes for <code>PostComments</code> and <code>PostReactions</code></li><li>(Install MySQL and the Database Web Gateway on the same VM)</li></ul><p><strong>2. Optimise DB and Hardware</strong></p><p>Right off the bat, you need a DBA and SysOps person who you can call on to scale up your DB and VM/Hardware and stay ahead of your growth curve. You&#39;ll probably find that starts happening in say 2 years anyway. If it happens sooner, your business is doing great and you can now hire more programmers yay!</p><p><strong>3. Logical Sharding</strong></p><p>With posts, you have a natural shard topic - the post. You won&#39;t have PostComments that belong to two posts, they will have an affinity for the Post. You also have Geo affiliated data, so I am guessing that people close to those locations will want that data more - with Sharding you can master that data in a closer data center.</p><p>Create a &#34;Management&#34; database to hold a Shards table, as well as the DataWebGateways table. This will be a replicated database with one master, and each new shard will have a read-replica of this.</p><p>For each new shard:</p><ul><li>Create a new VM, create a new Database with a numbered scheme &#34;Posts_1&#34;, &#34;Posts_2&#34;. (there is NO need to replicate these databases)</li><li>Make sure you have a read-replica of the Management database to this MariaDB instance.</li><li>Insert the relevant Shard and DataWebGateway records into the master instance (manually I guess).</li></ul><p>Now, you can make the View_DataWebGateways view a bit smarter. Let the client get all of the records, so that it can randomly choose one to use, while pinging the others to see which is closest (by latency), then switch to that.</p><p><strong>4. Staging Table</strong></p><p>It&#39;s probably best that you just create another shard, but if you do testing, and find that batching greatly improves insert performance, then you can do the following:</p><ul><li>Change <code>WriteView_Posts</code> to point to <code>PostStaging</code> instead of <code>Posts</code> table.</li><li>Benchmark different MariaDB engines, and select the right engine and configuration for the <code>PostStaging</code> table that optimise for Insert performance. This table can be configured to a dedicated Disk Volume that is also benchmarked to perform best for the simulated load (sequential reads).</li><li>Ensure you don&#39;t have any constraints or triggers on this PostStaging table. (While Posts can)</li><li>Create a Timed-Interval <a href="https://colossal.gitbook.io/microprocess/definition/microprocess" rel="nofollow noreferrer">Microprocess</a> which batches inserts into Posts from PostStaging every X seconds.</li></ul><p>Now, if the power goes out, you don&#39;t have to lose your &#34;cached&#34; posts. This also helps because you can also redirect posts to the appropriate shard by geography at this point.</p><p><strong>5. &#34;High load&#34; probably means Reads not writes</strong></p><ul><li>Add more VM/hardware: create Read-Replicas of Shards within the same datacentre, and add DataWebGateways records with ReadOnly flag for the client to use. The client will do all reading from read-replicas, and writing to the single write master DWebG.</li></ul><p><strong>6. Curate feeds with FeedViews</strong></p><p>Avoid caching at all costs - <a href="https://colossal.gitbook.io/microprocess/building/caching" rel="nofollow noreferrer">https://colossal.gitbook.io/microprocess/building/caching</a></p><p>If you would like to curate specific geographic feeds (eg. Germany, France, ...). While a geography shard server is great, Germans might want a mix of posts from around the world, while the French only want French posts - that&#39;s up to you to figure out.</p><p>To make this work:</p><ul><li>Have a crude view <code>View_CountryFeed</code> and use it like <code>select * from View_CountryFeed order by post_id desc limit 10;</code>. This will only work on a single shard to begin with.</li></ul><p>When that is reaching its limits, improve your algorithm and also introduce manual materialisation with the following:</p><ul><li>Log interest in posts per country</li><li>Run your algorithms as microprocesses</li><li>The algorithm parameters will be shared on the Management replicated database</li><li>The algorithm will run in isolation on each Shard grouping to Country IDs</li><li>The Management database will be configured on which shard to store the feed</li><li>A microprocess will pull country feeds from other shards to aggregate. Each shard will pull the right CountryIDs as configured. &#34;Pulling&#34; is done on the resource-sensitive side so this can be tuned per-shard to minimise resource usage.</li><li>Update View_CountryFeed: having PostID, PostBodyJSON, ShardID. The ShardID is important because that&#39;s where post interactions will be sourced from and published, while the PostBodyJSON will enable efficient rendering of the post by the client.</li></ul><p><strong>7. Realtime Notifications</strong></p><p>Database Web Gateway will be able to help here to in the future. see <a href="https://colossal.gitbook.io/microprocess/database-system/feature-gaps" rel="nofollow noreferrer">https://colossal.gitbook.io/microprocess/database-system/feature-gaps</a>. When the CountryFeed table is updated, a trigger will fire and notify the DWebG which will rerun subscribed Views and send new records to the subscribed web clients.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../how-to-implement-a-message-queue-over-redis/'>How to implement a message queue over Redis</a></li><li class="list-group-item"><a href='../redis-strategy-for-cache-item-dependency/'>Redis strategy for cache item dependency</a></li><li class="list-group-item"><a href='../do-application-level-caches-belong-inside-web-servers/'>Do application-level caches belong inside web servers</a></li><li class="list-group-item"><a href='../java-cache-vs-db-design-decision/'>Java &#8211; Cache vs DB design decision</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>