<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>C# &#8211; Implementation of pure abstract classes and interfaces &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1072386 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1072386" class="post-1072386 software type-software status-publish hentry category-software tag-abstract-class tag-c tag-interfaces tag-optimization"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">C# &#8211; Implementation of pure abstract classes and interfaces</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">abstract class</span><span class="mr-2 badge badge-info">c</span><span class="mr-2 badge badge-warning">interfaces</span><span class="mr-2 badge badge-primary">optimization</span></p><div class="entry-content"><p>Although this isn&#39;t mandatory in the C++ standard, it seems the way GCC for example, implements parent classes, including pure abstract ones, is by including a pointer to the v-table for that abstract class in every instantiation of the class in question.</p><p>Naturally this bloats the size of every instance of this class by a pointer for every parent class it has.</p><p>But I&#39;ve noticed that many C# classes and structs have lots of parent interfaces, which are basically pure abstract classes. I would be surprised if every instance of say <a href="https://msdn.microsoft.com/en-us/library/system.decimal(v=vs.110).aspx" rel="noreferrer"><code>Decimal</code></a>, was bloated with 6 pointers to all it&#39;s various interfaces.</p><p>So if C# does do interfaces differently, how does it do them, at least in a typical implementation (I understand the standard itself may not define such an implementation)? And do any C++ implementations have a way of avoiding object size bloat when adding pure virtual parents to classes?</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>In C# and Java implementations, the objects typically have a single pointer to its class. This is possible because they are single-inheritance languages. The class structure then contains the vtable for the single-inheritance hierarchy. But calling interface methods has all the problems of multiple inheritance as well. This is typically solved by putting additional vtables for all implemented interfaces into the class structure. This saves space compared to typical virtual inheritance implementations in C++, but makes interface method dispatch more complicated â€“ which can be partially compensated by caching.</p><p>E.g. in the OpenJDK JVM, each class contains an array of vtables for all implemented interfaces (an interface vtable is called an <em>itable</em>). When an interface method is called, this array is searched linearly for the itable of that interface, then the method can be dispatched through that itable. Caching is used so that each call site remembers the result of the method dispatch, so this search only has to be repeated when the concrete object type changes. Pseudocode for method dispatch:</p><pre class="lang-cpp prettyprint-override"><code>// Dispatch SomeInterface.method
Method const* resolve_method(
    Object const* instance, Klass const* interface, uint itable_slot) {

  Klass const* klass = instance-&gt;klass;

  for (Itable const* itable : klass-&gt;itables()) {
    if (itable-&gt;klass() == interface)
      return itable[itable_slot];
  }

  throw ...;  // class does not implement required interface
}
</code></pre><p>(Compare the real code in the OpenJDK HotSpot <a href="https://github.com/JetBrains/jdk8u_hotspot/blob/jdk8u76-b03/src/share/vm/interpreter/bytecodeInterpreter.cpp#L2504" rel="nofollow noreferrer">interpreter</a> or <a href="https://github.com/JetBrains/jdk8u_hotspot/blob/jdk8u76-b03/src/cpu/x86/vm/macroAssembler_x86.cpp#L4836" rel="nofollow noreferrer">x86 compiler</a>.)</p><p>C# (or more precisely, the CLR) uses a related approach. However, here the itables don&#39;t contain pointers to the methods, but are slot maps: they point to entries in the main vtable of the class. As with Java, having to search for the correct itable is only the worst case scenario, and it is expected that caching at the call site can avoid this search nearly always. The CLR uses a technique called Virtual Stub Dispatch in order to patch the JIT-compiled machine code with different caching strategies. Pseudocode:</p><pre class="lang-cpp prettyprint-override"><code>Method const* resolve_method(
    Object const* instance, Klass const* interface, uint interface_slot) {

  Klass const* klass = instance-&gt;klass;

  // Walk all base classes to find slot map
  for (Klass const* base = klass; base != nullptr; base = base-&gt;base()) {
    // I think the CLR actually uses hash tables instead of a linear search
    for (SlotMap const* slot_map : base-&gt;slot_maps()) {
      if (slot_map-&gt;klass() == interface) {
        uint vtable_slot = slot_map[interface_slot];
        return klass-&gt;vtable[vtable_slot];
      }
    }
  }

  throw ...;  // class does not implement required interface
}
</code></pre><p>The main difference to the OpenJDK-pseudocode is that in OpenJDK each class has an array of all directly or indirectly implemented interfaces, whereas the CLR only keeps an array of slot maps for interfaces that were directly implemented in that class. We therefore need to walk the inheritance hierarchy upwards until a slot map is found. For deep inheritance hierarchies this results in space savings. These are particularly relevant in CLR due to the way how generics are implemented: for a generic specialization, the class structure is copied and methods in the main vtable may be replaced by specializations. The slot maps continue to point at the correct vtable entries and can therefore be shared between all generic specializations of a class.</p><p>As an ending note, there are more possibilities to implement interface dispatch. Instead of placing the vtable/itable pointer in the object or in the class structure, we can use <em>fat pointers</em> to the object, that are basically a <code>(Object*, VTable*)</code> pair. The drawback is that this doubles the size of pointers and that upcasts (from a concrete type to an interface type) are not free. But it&#39;s more flexible, has less indirection, and also means that interfaces can be implemented externally from a class. Related approaches are used by Go interfaces, Rust traits, and Haskell typeclasses.</p><p>References and further reading:</p><ul><li><a href="https://lukasatkinson.de/2018/interface-dispatch/" rel="nofollow noreferrer">Interface dispatch</a>. An expanded version of this answer, complete with diagrams and in-depth discussion.</li><li>Wikipedia: <a href="https://en.wikipedia.org/wiki/Inline_caching" rel="nofollow noreferrer">Inline caching</a>. Discusses caching approaches that can be used to avoid expensive method lookup. Typically not needed for vtable-based dispatch, but very desirable for more expensive dispatch mechanisms like the above interface dispatch strategies.</li><li>OpenJDK Wiki (2013): <a href="https://wiki.openjdk.java.net/display/HotSpot/InterfaceCalls" rel="nofollow noreferrer">Interface Calls</a>. Discusses itables.</li><li>Pobar, Neward (2009): SSCLI 2.0 Internals. Chapter 5 of the book discusses slot maps in great detail. Was never published but <a href="http://blogs.tedneward.com/post/sscli-20-internals/" rel="nofollow noreferrer">made available by the authors on their blogs</a>. The <a href="http://www.newardassociates.com/files/SSCLI2.pdf" rel="nofollow noreferrer">PDF link</a> has since moved. This book probably no longer reflects the current state of the CLR.</li><li>CoreCLR (2006): <a href="https://github.com/dotnet/coreclr/blob/master/Documentation/botr/virtual-stub-dispatch.md" rel="nofollow noreferrer">Virtual Stub Dispatch</a>. In: Book Of The Runtime. Discusses slot maps and caching to avoid expensive lookups.</li><li>Kennedy, Syme (2001): <a href="https://www.microsoft.com/en-us/research/publication/design-and-implementation-of-generics-for-the-net-common-language-runtime/" rel="nofollow noreferrer">Design and Implementation of Generics for the .NET Common Language Runtime</a>. (<a href="https://www.microsoft.com/en-us/research/wp-content/uploads/2001/01/designandimplementationofgenerics.pdf" rel="nofollow noreferrer">PDF link</a>). Discusses various approaches to implement generics. Generics interact with method dispatch because methods might be specialized so vtables might have to be rewritten.</li></ul></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../c-abstract-base-class-with-interfaces-as-behaviors/'>C# &#8211; Abstract Base Class with Interfaces as Behaviors</a></li><li class="list-group-item"><a href='../java-different-usage-rationale-for-abstract-classes-interfaces-in-c-and-java/'>Java &#8211;  different usage rationale for abstract classes/interfaces in C++ and Java</a></li><li class="list-group-item"><a href='../c-di-ioc-abstract-factory-galore/'>C# &#8211; DI / IoC Abstract Factory Galore</a></li><li class="list-group-item"><a href='../java-why-were-default-and-static-methods-added-to-interfaces-in-java-8-when-we-already-had-abstract-classes/'>Java &#8211; Why were default and static methods added to interfaces in Java 8 when we already had abstract classes</a></li><li class="list-group-item"><a href='../c-code-re-use-in-c-via-multiple-inheritance-or-composition-or/'>C++ &#8211; Code re-use in C++, via multiple inheritance or composition? Or&#8230;</a></li><li class="list-group-item"><a href='../c-what-kind-of-members-should-be-used-in-a-gethashcode-implementation/'>C# &#8211; What kind of members should be used in a GetHashCode() implementation</a></li><li class="list-group-item"><a href='../object-oriented-avoiding-vtable-pointers-in-objects-in-c/'>Object-oriented &#8211; Avoiding vtable pointers in objects in C++</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>