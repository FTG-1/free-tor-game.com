<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>C++ &#8211; Merits of copy-on-write semantics &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1076167 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1076167" class="post-1076167 software type-software status-publish hentry category-software tag-c tag-qt"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">C++ &#8211; Merits of copy-on-write semantics</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">c</span><span class="mr-2 badge badge-info">qt</span></p><div class="entry-content"><p>I am wondering what possible merits does copy-on-write have? Naturally, I don&#39;t expect personal opinions, but real-world practical scenarios where it can be technically and practically beneficial in a tangible way. And by tangible I mean something more than saving you the typing of a <code>&amp;</code> character.</p><p>To clarify, this question is in the context of datatypes, where assignment or copy construction creates an implicit shallow copy, but modifications to it creates an implicit deep copy and applies the changes to it instead of the original object.</p><p>The reason I am asking is I don&#39;t seem to find any merits of having COW as a default implicit behavior. I use Qt, which has COW implemented for a lot of the datatypes, practically all which have some underlying dynamically allocated storage. But how does it really benefit the user?</p><p>An example:</p><pre><code>QString s(&#34;some text&#34;);
QString s1 = s; // now both s and s1 internally use the same resource

qDebug() &lt;&lt; s1; // const operation, nothing changes
s1[o] = z; // s1 &#34;detaches&#34; from s, allocates new storage and modifies first character
           // s is still &#34;some text&#34;
</code></pre><p>What do we win by using COW in this example?</p><p>If all we intend to do is use const operations, <code>s1</code> is redundant, might as well use <code>s</code>.</p><p>If we intend to change the value, then COW only delays the resource copy until the first non-const operation, at the (albeit minimal) cost of incrementing the ref count for the implicit sharing and detaching from the shared storage. It does look like all the overhead involved in COW is pointless.</p><p>It is not much different in the context of parameter passing &#8211; if you don&#39;t intend to modify the value, pass as const reference, if you do want to modify, you either make an implicit deep copy if you don&#39;t want to modify the original object, or pass by reference if you want to modify it. Again COW seems like needless overhead that doesn&#39;t achieve anything, and only adds a limitation that you cannot modify the original value even if you want to, as any change will detach from the original object.</p><p>So depending on whether you know about COW or are oblivious to it, it may either result in code with obscure intent and needless overhead, or completely confusing behavior which doesn&#39;t match the expectations and leaves you scratching your head.</p><p>To me it seems that there are more efficient and more readable solutions whether you want to avoid an unnecessary deep copy, or you intend to make one. So where is the practical benefit from COW? I assume there must be some benefit since in it used in such a popular and powerful framework.</p><p>Furthermore, from what I&#39;ve read, COW is now explicitly forbidden in the C++ standard library. Don&#39;t know whether the con&#39;s I see in it have something to do with it, but either way, there must be a reason for this.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>Copy on write is used in situations where you very often will create a copy of the object and not modify it.  In those situations, it pays for itself.</p><p>As you mentioned, you can pass a const object, and in many cases that is sufficient.  However, const only guarantees that the caller can&#39;t mutate it (unless they <code>const_cast</code>, of course).  It does not handle multithreading cases and it does not handle cases where there are callbacks (which might mutate the original object).  Passing a COW object by value puts the challenges of managing these details on the API developer, rather than the API user.</p><p>The new rules for C+11 forbid COW for <code>std::string</code> in particular.   Iterators on a string must be invalidated if the backing buffer is detached.  If the iterator was being implemented as a <code>char*</code> (As opposed to a <code>string*</code> and an index), this iterators are no longer valid.  The C++ community had to decide how often iterators could be invalidated, and the decision was that <code>operator[]</code> should not be one of those cases. <code>operator[]</code> on a <code>std::string</code> returns a <code>char&amp;</code>, which may be modified.  Thus, <code>operator[]</code> would need to detach the string, invalidating iterators.  This was deemed to be a poor trade, and unlike functions like <code>end()</code> and <code>cend()</code>, there&#39;s no way to ask for the const version of <code>operator[]</code> short of const casting the string. (<a href="https://stackoverflow.com/questions/12199710/legality-of-cow-stdstring-implementation-in-c11">related</a>).</p><p>COW is still alive and well outside of the STL.  In particular, I have found it very useful in cases where it is unreasonable for a user of my APIs to expect that there&#39;s some heavyweight object behind what appears to be a very lightweight object.  I may wish to use COW in the background to ensure they never have to be concerned with such implementation details.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../c-algorithm-to-copy-data-faster-than-windows-default-copy-provider/'>C++ &#8211; Algorithm to Copy data faster than windows default copy provider</a></li><li class="list-group-item"><a href='../c-in-c-are-acquire-release-memory-order-semantics-transitive/'>C++ &#8211; In C++, are acquire-release memory order semantics transitive</a></li><li class="list-group-item"><a href='../c-move-semantics-in-c-move-return-of-local-variables/'>C++ &#8211; Move semantics in C++ &#8211; Move-return of local variables</a></li><li class="list-group-item"><a href='../c-object-lifetime-invariants-vs-move-semantics/'>C++ &#8211; Object lifetime invariants vs. move semantics</a></li><li class="list-group-item"><a href='../c-implementing-copy-on-write/'>C++ &#8211; Implementing copy-on-write</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>