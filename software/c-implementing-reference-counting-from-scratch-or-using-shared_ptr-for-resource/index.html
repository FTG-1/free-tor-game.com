<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>C++ &#8211; Implementing reference counting from scratch or using shared_ptr for resource &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1083030 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1083030" class="post-1083030 software type-software status-publish hentry category-software tag-c tag-c11 tag-resources"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">C++ &#8211; Implementing reference counting from scratch or using shared_ptr for resource</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">c</span><span class="mr-2 badge badge-info">c++11</span><span class="mr-2 badge badge-warning">resources</span></p><div class="entry-content"><p>In an OpenGL application that I am writing, I want to have a simple shader class to wrap the OpenGL shader handle. Ultimately, I want this shader class to behave very similarly to a shared_ptr in c++ (that is, keep a reference count and free the resource when no references are left). While it is relatively trivial to implement this reference counting from scratch, I was wondering if it is considered a better design choice to instead use <code>std::shared_ptr</code> with a custom deleter to free up the resource.</p><p>The main source of my doubt is the fact that it might be considered unconventional due to the fact that (as far as I know), creating an OpenGL shader program handle does not actually involve heap memory (which is what shared_ptr takes care of) but I still feel that it could apply here because I want this resource to be handled very similarly to how heap memory would be handled. The purpose of this question is basically to seek the opinion of others as to whether this actually is unconventional, because I do not know.</p><p>Also, although I used shaders as an example, the same question also applies to textures and buffers in OpenGL as they also must be allocated and freed.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p><code>unique_ptr&lt;T, D&gt;</code> is actually specially designed to be able to work with more arbitrary handle-like types. I spelled out the template name fully because <code>D</code> is the key here. Normally <code>unique_ptr&lt;T, D&gt;::get()</code> returns a <code>T*</code>. That is the default, but this can be overridden by <code>D</code>: the deleter type.</p><p>If the deleter type has a <code>pointer</code> alias (<code>D::pointer</code> is legal syntax), then <code>unique_ptr&lt;T, D&gt;::get()</code> will return that type. This allows you to have something like <code>unique_ptr&lt;GLuint, gl::program_deleter&gt;</code>, where <code>gl::program_deleter::pointer</code> is of type <code>int</code>.</p><p>I bring all of this up because <code>shared_ptr</code> <em>cannot do this</em>. <code>unique_ptr&lt;T, D&gt;</code> gets away with it because the deleter is actually part of the <code>unique_ptr</code> type itself. By contrast, while <code>shared_ptr</code>&#39;s constructors can take a deleter, the only thing that deleter function can do is delete the memory.</p><p>So <code>shared_ptr&lt;GLuint&gt;::get()</code> will always return a <code>GLuint*</code>. This means that, if you want to use <code>shared_ptr</code> as some kind of shared handle type, that type must be dynamically allocated in some way. You may not be using the global heap, but it cannot just store and return integer either. <code>shared_ptr&lt;T&gt;</code> always contains a <code>T*</code>.</p><p>So no matter what, you&#39;re going to have to manage <code>GLuint*</code>s if you want to use <code>shared_ptr</code>&#39;s reference counting machinery. Yes, the deleter can be used to call <code>glDeleteProgram</code> or whatever you want, but the <code>shared_ptr&lt;GLuint&gt;</code> will still be storing a <code>GLuint*</code>.</p><blockquote><p>creating an OpenGL shader program handle does not actually involve heap memory</p></blockquote><p>OK, let&#39;s forget for a moment that by creating an OpenGL object, the driver almost certainly heap allocated some memory. Let&#39;s look just at what you have to do.</p><p>By creating a <code>shared_ptr</code> that owns some storage, <em>something</em> will be allocated. Namely, the shared block that manages the <code>shared_ptr</code>&#39;s reference count. There&#39;s no getting around that. So if you want to use <code>shared_ptr</code>&#39;s reference counting infrastructure, you&#39;re going to allocate from somewhere.</p><p>So the most idiomatic way to do this is to just heap allocate a <code>GLuint</code> and use a special deleter that destroys the OpenGL object and deallocates the integer. It&#39;s not pretty and it&#39;s kind of wasteful, but it&#39;s hardly terrible. And if you use <code>make_shared</code>, you can make things pretty compact in terms of allocations.</p><hr/><p>Now, you can avoid this allocation by <em>cheating</em>. You can do this:</p><pre><code>GLuint program = glCreateProgram();
shared_ptr&lt;GLuint&gt; sp(reinterpret_cast&lt;GLuint*&gt;(program), ProgramDeleter);
</code></pre><p>So here, we&#39;re taking an integer and casting it to a pointer value, to be stored within the <code>shared_ptr</code>. When you need to use it, you have to reverse the cast to recover the integer value.</p><p>But judge the following code for yourself:</p><pre><code>glProgramUniform1i(reinterpret_cast&lt;GLuint&gt;(sp.get()), val);
</code></pre><p>Does that look like something you want to do frequently? Does it look like something you want to <em>read</em> frequently? Does that look like something that someone else will easily understand what&#39;s going on?</p><p>Not only that, you can never use <code>*sp</code> to get the value, since the pointer value <em>is</em> the value in question.</p><p>Oh, and the reference counting control block still gets heap allocated, so it&#39;s not like you prevent allocating memory or something.</p><p>This is not idiomatic C++.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../c-good-design-pattern-for-a-c-wrapper-around-a-c-object/'>C++ &#8211; Good design pattern for a c++ wrapper around a c object</a></li><li class="list-group-item"><a href='../c-where-is-the-this-variable-stored/'>C++ &#8211; Where is the &#8216;this&#8217; variable stored</a></li><li class="list-group-item"><a href='../c-no-exceptions-c-and-partially-constructed-objects/'>C++ &#8211; No exceptions C++ and partially constructed objects</a></li><li class="list-group-item"><a href='../c-what-design-pattern-best-suits-managing-handles-to-objects-without-passing-handles-or-manager-around/'>C++ &#8211; What design pattern best suits managing handles to objects, without passing handles or Manager around</a></li><li class="list-group-item"><a href='../c-when-to-actually-use-raii/'>C++ &#8211; When to actually use RAII</a></li><li class="list-group-item"><a href='../object-oriented-abstraction-of-vaos-vbos-and-models/'>Object-oriented &#8211; Abstraction of VAOs, VBOs and Models</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>