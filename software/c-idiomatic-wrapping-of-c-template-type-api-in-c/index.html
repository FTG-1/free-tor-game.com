<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>C++ &#8211; Idiomatic wrapping of C++ template type API in C &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1086010 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1086010" class="post-1086010 software type-software status-publish hentry category-software tag-api-design tag-c"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">C++ &#8211; Idiomatic wrapping of C++ template type API in C</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">api-design</span><span class="mr-2 badge badge-info">c</span></p><div class="entry-content"><p>I&#39;m working on wrapping a C++ API which provides access to a data store (Hazelcast) in C functions, so that the data store can also be accessed from C-only code.</p><p>The Hazelcast C++ API for the Map datastructure looks like this:</p><pre><code>auto map = hazelcastClient-&gt;client-&gt;getMap&lt;int, string&gt;(mapName);
map.put(key, value);
</code></pre><p>It makes use of template types for <code>key</code> and <code>value</code> parameters. As there are no templates available in C, i thought about creating a wrapper function for each specialization of the <code>getMap&lt;T, U&gt;</code> method. That is, for each C type. Although I&#39;m aware that there are <code>signed</code> and <code>unsigned</code> versions of C types, I&#39;m fine with limiting the API to support only <code>int</code>, <code>double</code>, <code>float</code>, <code>char *</code> for <code>key</code> and <code>value</code>.</p><p>So I wrote a small script, that auto-generates all combinations. The exported functions look like this:</p><pre><code>int Hazelcast_Map_put_int_string(
    Hazelcast_Client_t *hazelcastClient,
    const char *mapName,
    int key,
    char *value,
    char** errptr
);

int Hazelcast_Map_put_int_int(
    Hazelcast_Client_t *hazelcastClient,
    const char *mapName,
    int key,
    int value,
    char** errptr
);

...
</code></pre><p>Generating a function for <code>get</code>, <code>set</code>, <code>contains</code> with all possible combinations of <code>key</code> and <code>value</code> types increases the amount of code quite a lot, and although I think generating the code is a good idea, it adds additional complexity by having to create some kind of code-generating infrastructure.</p><p>Another idea I can imagine is one generic function in C, like this:</p><pre><code>int Hazelcast_Map_put(
    Hazelcast_Client_t *hazelcastClient,
    const char *mapName,

    const void *key,
    API_TYPE key_type,

    const void *value,
    API_TYPE value_type,

    char** errptr
);
</code></pre><p>Which can be used like this:</p><pre><code>Hazelcast_Map_put(client, mapName, &#34;key&#34;, API_TYPE_STR, &#34;val&#34;, API_TYPE_STR, &amp;err);
</code></pre><p>This makes it a bit easier for the caller, because it shifts the burden of getting the correct specialization on my code, but it looses type safety and requires casts. Also, for passing in an int, as <code>void *</code> is now the type of <code>key</code> and <code>value</code>, a cast like <code>(void *) (intptr_t) intVal</code> would be needed on the callers side, which again isn&#39;t super nice to read and maintain.</p><ul><li>Is there any third option, which I can&#39;t recognize?</li><li>Which version would be preferred by C developers?</li></ul><p>I&#39;m mostly inclined to auto-generate all type combinations and create a function for each, although the header file will become quite huge I suppose.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>Generating for all possibilities did not look to be a very good solution to me. The key and values may be objects as well. Hence, the possibilities are infinite :(</p><p>Did you have a look at IMapImpl class? This class does not use types but the binary data (which is provided after serialization). Hence, another solution would be writing an API that mimics this interface + providing a Serialization utility which converts any given type to the binary that this interface needs.</p><p>E.g.</p><p>API:</p><pre><code>struct Binary {
   byte *data;
   size_t length;
   int32_t dataType;
};
Binary *hazelcast_map_put(const Binary *key, const Binary *value);
</code></pre><p>Serialization utility:</p><pre><code>int hazelcast_binary_to_int(const Binary *data);
</code></pre><p>You may need to write these helper functions for object types that you would like to support.
This may be a viable interface. There are things to be considered such as memory management.</p><p>Serialization is a complex subject, but you can surely start with supporting the primitive types first. See <a href="http://docs.hazelcast.org/docs/3.6/manual/html-single/#serialization" rel="nofollow">http://docs.hazelcast.org/docs/3.6/manual/html-single/#serialization</a> and <a href="https://github.com/hazelcast/hazelcast/blob/master/hazelcast/src/main/java/com/hazelcast/internal/serialization/impl/ConstantSerializers.java" rel="nofollow">https://github.com/hazelcast/hazelcast/blob/master/hazelcast/src/main/java/com/hazelcast/internal/serialization/impl/ConstantSerializers.java</a> for serialization details.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../are-data-type-declarators-like-int-and-char-stored-in-ram-when-a-c-program-executes/'>Are data type declarators like &#8220;int&#8221; and &#8220;char&#8221; stored in RAM when a C program executes</a></li><li class="list-group-item"><a href='../rest-how-to-correctly-implement-keyvalue-storage-rest-api/'>Rest &#8211; How to correctly implement key=value storage REST API</a></li><li class="list-group-item"><a href='../c-in-c-why-shouldnt-all-function-parameters-be-references/'>C++ &#8211; In C++, why shouldn&#8217;t all function parameters be references</a></li><li class="list-group-item"><a href='../c-can-the-c-template-system-be-used-to-perform-type-safe-operations-of-the-relational-algebra/'>C++ &#8211; Can the C++ template system be used to perform type safe operations of the relational algebra</a></li><li class="list-group-item"><a href='../c-when-one-should-use-template-specialization-if-not-for-metaprogramming/'>C++ &#8211; When one should use template specialization, if not for metaprogramming</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>