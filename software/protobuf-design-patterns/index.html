<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="https://free-tor-game.com/wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Protobuf design patterns &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.min.js?ver=11.2.0' id='highlight-js'></script>     <script>( function( w, d, s, l, i ) {
				w[l] = w[l] || [];
				w[l].push( {'gtm.start': new Date().getTime(), event: 'gtm.js'} );
				var f = d.getElementsByTagName( s )[0],
					j = d.createElement( s ), dl = l != 'dataLayer' ? '&l=' + l : '';
				j.async = true;
				j.src = 'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
				f.parentNode.insertBefore( j, f );
			} )( window, document, 'script', 'dataLayer', ' ' );</script>      <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1066348 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="https://free-tor-game.com/3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="https://free-tor-game.com/contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1066348" class="post-1066348 software type-software status-publish hentry category-software tag-protobuf tag-serialization"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Protobuf design patterns</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">protobuf</span><span class="mr-2 badge badge-info">serialization</span></p><div class="entry-content"><p>I am evaluating Google Protocol Buffers for a Java based service (but am expecting language agnostic patterns). I have two questions:</p><p>The first is a broad general question:</p><blockquote><p>What patterns are we seeing people use? Said patterns being related to class organization (e.g., messages per .proto file, packaging, and distribution) and message definition (e.g., repeated fields vs. repeated encapsulated fields*) etc.</p></blockquote><p>There is very little information of this sort on the Google Protobuf Help pages and public blogs while there is a ton of information for established protocols such as XML.</p><p>I also have specific questions over the following two different patterns:</p><ol><li><p>Represent messages in .proto files, package them as a separate jar, and ship it to target consumers of the service &#8211;which is basically the default approach I guess.</p></li><li><p>Do the same but also include hand crafted wrappers (not sub-classes!) around each message that implement a contract supporting at least these two methods (T is the wrapper class, V is the message class (using generics but simplified syntax for brevity):</p><pre><code>public V toProtobufMessage() {
    V.Builder builder = V.newBuilder();
    for (Item item : getItemList()) {
        builder.addItem(item);
    }
    return builder.setAmountPayable(getAmountPayable()).
                   setShippingAddress(getShippingAddress()).
                   build();
}

public static T fromProtobufMessage(V message_) { 
    return new T(message_.getShippingAddress(), 
                 message_.getItemList(),
                 message_.getAmountPayable());
}
</code></pre></li></ol><p>One advantage I see with (2) is that I can hide away the complexities introduced by <code>V.newBuilder().addField().build()</code> and add some meaningful methods such as <code>isOpenForTrade()</code> or <code>isAddressInFreeDeliveryZone()</code> etc. in my wrappers. The second advantage I see with (2) is that my clients deal with immutable objects (something I can enforce in the wrapper class).</p><p>One disadvantage I see with (2) is that I duplicate code and have to sync up my wrapper classes with .proto files.</p><p>Does anyone have better techniques or further critiques on any of the two approaches?</p><hr/><p>*By encapsulating a repeated field I mean messages such as this one:</p><pre><code>message ItemList {
    repeated item = 1;
}

message CustomerInvoice {
    required ShippingAddress address = 1;
    required ItemList = 2;
    required double amountPayable = 3;
}
</code></pre><p>instead of messages such as this one:</p><pre><code>message CustomerInvoice {
    required ShippingAddress address = 1;
    repeated Item item = 2;
    required double amountPayable = 3;
}
</code></pre><p>I like the latter but am happy to hear arguments against it.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>Where I work, the decision was taken to conceal the use of protobuf. We don&#39;t distribute the <code>.proto</code> files between applications, but rather, any application that exposes a protobuf interface exports a client library which can talk to it.</p><p>I have only worked on one of these protobuf-exposing applications, but in that, each protobuf message corresponds to some concept in the domain. For each concept, there is a normal Java interface. There is then a converter class, which can take an instance of an implementation and construct an appropriate message object, and take a message object and construct an instance of an implementation of the interface (as it happens, usually a simple anonymous or local class defined inside the converter). The protobuf-generated message classes and converters together form a library which is used by both the application and the client library; the client library adds a small amount of code for setting up connections and sending and receiving messages.</p><p>Client applications then import the client library, and provide implementations of any interfaces they wish to send. Indeed, both sides do the latter thing.</p><p>To clarify, that means that if you have a request-response cycle where the client is sending a party invitation, and the server is responding with an RSVP, then the things involved are:</p><ul><li>PartyInvitation message, written in the <code>.proto</code> file</li><li><code>PartyInvitationMessage</code> class, generated by <code>protoc</code></li><li><code>PartyInvitation</code> interface, defined in the shared library</li><li><code>ActualPartyInvitation</code>, a concrete implementation of <code>PartyInvitation</code> defined by the client app (not actually called that!)</li><li><code>StubPartyInvitation</code>, a simple implementation of <code>PartyInvitation</code> defined by the shared library</li><li><code>PartyInvitationConverter</code>, which can convert a <code>PartyInvitation</code> to a <code>PartyInvitationMessage</code>, and a <code>PartyInvitationMessage</code> to a <code>StubPartyInvitation</code></li><li>RSVP message, written in the <code>.proto</code> file</li><li><code>RSVPMessage</code> class, generated by <code>protoc</code></li><li><code>RSVP</code> interface, defined in the shared library</li><li><code>ActualRSVP</code>, a concrete implementation of <code>RSVP</code> defined by the server app (also not actually called that!)</li><li><code>StubRSVP</code>, a simple implementation of <code>RSVP</code> defined by the shared library</li><li><code>RSVPConverter</code>, which can convert an <code>RSVP</code> to an <code>RSVPMessage</code>, and an <code>RSVPMessage</code> to a <code>StubRSVP</code></li></ul><p>The reason we have separate actual and stub implementations is that the actual implementations are generally JPA-mapped entity classes; the server either creates and persists them, or queries them up from the database, then hands them off to the protobuf layer to be transmitted. It wasn&#39;t felt that it was appropriate to be creating instances of those classes on the receiving side of the connection, because they wouldn&#39;t be tied to a persistence context. Furthermore, the entities often contain rather more data than is transmitted over the wire, so it wouldn&#39;t even be possible to create intact objects on the receiving side. I am not entirely convinced that this was the right move, because it has left us with one more class per message than we would otherwise have.</p><p>Indeed, I am not entirely convinced that using protobuf at all was a good idea; if we&#39;d stuck with plain old RMI and serialization, we wouldn&#39;t have had to create nearly as many objects. In many cases, we could just have marked our entity classes as serializable and got on with it.</p><p>Now, having said all that, I have a friend who works at Google, on a codebase that makes heavy use of protobuf for communication between modules. They take a completely different approach: they don&#39;t wrap the generated message classes at all, and enthusiastically pass them deep(ish) into their code. This is seen as a good thing, because it&#39;s a simple of way of keeping interfaces flexible. There is no scaffolding code to keep in sync when messages evolve, and the generated classes provide all the necessary <code>hasFoo()</code> methods needed for receiving code to detect the presence or absence of fields that have been added over time. Bear in mind, though, that people who work at Google tend to be (a) rather clever and (b) a bit nuts.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='https://free-tor-game.com/software/move-from-json-to-protobuf-is-it-worth-it/'>Move from JSON to Protobuf. Is it worth it</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/c-is-it-rational-to-convert-protobuf-into-json-to-send-it-to-a-web-server/'>C++ &#8211; Is it rational to convert protobuf into json to send it to a web server</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/arbitrary-protobuf-message-as-byte-array-over-websocket-how-to-determine-actual-message-type-upfront/'>Arbitrary protobuf message as byte-array over Websocket &#8211; how to determine actual message type upfront</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/why-protobuf-3-made-all-fields-on-the-messages-optional/'>Why Protobuf 3 made all fields on the messages optional</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='http://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="https://free-tor-game.com/wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>