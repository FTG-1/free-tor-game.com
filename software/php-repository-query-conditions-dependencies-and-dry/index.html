<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Php &#8211; Repository query conditions, dependencies and DRY &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1080223 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1080223" class="post-1080223 software type-software status-publish hentry category-software tag-domain-driven-design tag-dry tag-php tag-separation-of-concerns"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Php &#8211; Repository query conditions, dependencies and DRY</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">domain-driven-design</span><span class="mr-2 badge badge-info">dry</span><span class="mr-2 badge badge-warning">PHP</span><span class="mr-2 badge badge-primary">separation-of-concerns</span></p><div class="entry-content"><p>To keep it simple, let&#39;s suppose an application which has <code>Accounts</code> and <code>Users</code>. Each account may have any number of users. There&#39;s also 3 consumers of <code>UserRepository</code>:</p><ul><li>An admin interface which may list all users</li><li>Public front-end which may list all users</li><li>An account authenticated API which should only list it&#39;s own users</li></ul><p>Assuming <code>UserRepository</code> is something like this:</p><pre class="lang-php prettyprint-override"><code>class UsersRepository extends DatabaseAbstraction {
    private function query() {
        return $this-&gt;database()-&gt;select(&#39;users.*&#39;);
    }
    public function getAll() {
        return $this-&gt;query()-&gt;exec();
    }
    // IMPORTANT:
    // Tons of other methods for searching, filtering,
    // joining of other tables, ordering and such...
}
</code></pre><p>Keeping in mind the comment above, and the necessity to abstract user querying conditions, How should I handle querying of users filtering by <code>account_id</code>? I can picture three possible roads:</p><h3>1. Should I create an <code>AccountUsersRepository</code>?</h3><pre class="lang-php prettyprint-override"><code>class AccountUsersRepository extends UserRepository {
    public function __construct(Account $account) {
        $this-&gt;account = $account;
    }
    private function query() {
        return parent::query()
            -&gt;where(&#39;account_id&#39;, &#39;=&#39;, $this-&gt;account-&gt;id);
    }
}
</code></pre><p><em>This has the advantage of reducing the duplication of <code>UsersRepository</code> methods, but doesn&#39;t quite fit into anything I&#39;ve read about DDD so far (I&#39;m rookie by the way)</em></p><h3>2. Should I put it as a method on <code>AccountsRepository</code>?</h3><pre class="lang-php prettyprint-override"><code>class AccountsRepository extends DatabaseAbstraction {
    public function getAccountUsers(Account $account) {
        return $this-&gt;database()
            -&gt;select(&#39;users.*&#39;)
            -&gt;where(&#39;account_id&#39;, &#39;=&#39;, $account-&gt;id)
            -&gt;exec();
    }
}
</code></pre><p><em>This requires the duplication of all <code>UserRepository</code> methods and may need another <code>UserQuery</code> layer, that implements those querying logic on chainable way.</em></p><h3>3. Should I query <code>UserRepository</code> from within my account entity?</h3><pre class="lang-php prettyprint-override"><code>class Account extends Entity {
    public function getUsers() {
        return UserRepository::findByAccountId($this-&gt;id);
    }
}
</code></pre><p><em>This feels more like an aggregate root for me, but introduces dependency of <code>UserRepository</code> on <code>Account</code> entity, which may violate a few principles.</em></p><h3>4. Or am I missing the point completely?</h3><p>Maybe there&#39;s an even better solution?</p><p></p><p><strong>Footnotes:</strong> Besides permissions being a Service concern, in my understanding, they shouldn&#39;t implement SQL query but leave that to repositories since those may not even be SQL driven.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>I would keep all <code>User</code> related data-access in the <code>UserRepository</code>. It is not a good idea to make repositories depend on each other but it&#39;s perfectly ok to have a service depend on multiple repositories. So in this case you could have an <code>AccountService</code> which uses both <code>UserRepository</code> and <code>AccountRepository</code>.</p><p>The third option you have considered is something I&#39;ve also used and it has the benefit that now the user list is loaded lazily (although this can be accomplished by other means as well). The huge drawback is that it will be very hard to serialize that object to send it over wire for example and it also couples the data-access layer with your object model.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../how-to-deal-with-queries-that-do-not-return-full-entities-in-domain-driven-design/'>How to deal with queries that do not return full entities in Domain Driven Design</a></li><li class="list-group-item"><a href='../object-oriented-xerox-solid-example-in-php/'>Object-oriented &#8211; Xerox SOLID example in PHP</a></li><li class="list-group-item"><a href='../c-separation-of-concerns-between-repository-and-service-in-ddd-with-complex-entities/'>C# &#8211; Separation of concerns between repository and service in DDD with complex entities</a></li><li class="list-group-item"><a href='../object-oriented-oop-implementation-doubts-with-databases/'>Object-oriented &#8211; OOP implementation doubts with databases</a></li><li class="list-group-item"><a href='../a-filtering-logic-should-be-in-a-repository-or-in-a-service/'>A filtering logic should be in a repository or in a service</a></li><li class="list-group-item"><a href='../access-multiple-entities-in-repository-clean-architecture/'>Access multiple entities in repository &#8211; clean architecture</a></li><li class="list-group-item"><a href='../ending-up-with-too-many-services-in-ddd/'>Ending up with too many services in DDD</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>