<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Unit-testing &#8211; Unit testing in Django &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1086751 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1086751" class="post-1086751 software type-software status-publish hentry category-software tag-django tag-testing tag-unit-testing"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Unit-testing &#8211; Unit testing in Django</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">django</span><span class="mr-2 badge badge-info">testing</span><span class="mr-2 badge badge-warning">unit testing</span></p><div class="entry-content"><p>I&#39;m really struggling to write effective unit tests for a large Django project.  I have reasonably good test coverage, but I&#39;ve come to realize that the tests I&#39;ve been writing are definitely integration/acceptance tests, not unit tests at all, and I have critical portions of my application that are not being tested effectively.  I want to fix this ASAP.</p><p>Here&#39;s my problem. My schema is deeply relational, and heavily time-oriented, giving my model object high internal coupling and lots of state.  Many of my model methods query based on time intervals, and I&#39;ve got a lot of <code>auto_now_add</code> going on in timestamped fields.  So take a method that looks like this for example:</p><pre><code>def summary(self, startTime=None, endTime=None):
    # ... logic to assign a proper start and end time 
    # if none was provided, probably using datetime.now()

    objects = self.related_model_set.manager_method.filter(...)

    return sum(object.key_method(startTime, endTime) for object in objects)
</code></pre><p>How does one approach testing something like this?</p><p>Here&#39;s where I am so far.  It occurs to me that the unit testing objective should be <em>given some mocked behavior <code>by key_method</code> on its arguments, is <code>summary</code> correctly filtering/aggregating to produce a correct result?</em></p><p>Mocking datetime.now() is straightforward enough, but how can I mock out the rest of the behavior?</p><ul><li>I could use fixtures, but I&#39;ve heard pros and cons of using fixtures for building my data (poor maintainability being a con that hits home for me).</li><li>I could also setup my data through the ORM, but that can be limiting, because then I have to create related objects as well.  And the ORM doesn&#39;t let you mess with <code>auto_now_add</code> fields manually.</li><li>Mocking the ORM is another option, but not only is it tricky to mock deeply nested ORM methods, but the logic in the ORM code gets mocked out of the test, and mocking seems to make the test really dependent on the internals and dependencies of the function-under-test.</li></ul><p>The toughest nuts to crack seem to be the functions like this, that sit on a few layers of models and lower-level functions and are very dependent on the time, even though these functions may not be super complicated. My overall problem is that no matter how I seem to slice it, my tests are looking way more complex than the functions they are testing.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>I&#39;m going to go ahead and register an answer for what I&#39;ve come up with so far.</p><p>My hypothesis is that for a function with deep coupling and state, the reality is that it&#39;s simply going to take a lot of lines to control for its outside context.</p><p>Here&#39;s what my test case looks like roughly, relying on the standard Mock library:</p><ol><li>I use the standard ORM to set up the sequence of events</li><li>I create my own start <code>datetime</code> and subvert the <code>auto_now_add</code> times to fit a fixed timeline of my design.  I thought that the ORM didn&#39;t allow this, but it works fine.</li><li>I make sure the function-under-test uses <code>from datetime import datetime</code> so that I can patch <code>datetime.now()</code> in just that function (if I mock the entire <code>datetime</code> class, the ORM pitches a fit).</li><li>I create my own replacement for <code>object.key_method()</code>, with simple but well defined functionality that depends on the arguments.  I want it to depend on the arguments, because otherwise I might not know if the logic of the function-under-test is working. In my case, it simply returns the number of seconds between <code>startTime</code> and <code>endTime</code>.  I patch it in by wrapping it in a lambda and patching directly on to <code>object.key_method()</code> using the <code>new_callable</code> kwarg of <code>patch</code>.</li><li>Finally, I run a series of asserts on various calls of <code>summary</code> with different arguments to check equality with expected hand-calculated results accounting for the given behavior of the mock <code>key_method</code></li></ol><p>Needless to say, this is significantly longer and more complicated than the function itself.  It depends on the DB, and doesn&#39;t really feel like a unit test.  But it is also fairly decoupled from the internals of the function--just its signature and dependencies.  So I think it might actually be a unit test, still.</p><p>In my app, the function is quite pivotal, and subject to refactoring to optimize its performance.  So I think the trouble is worth it, complexity notwithstanding.  But I&#39;m still open to better ideas on how to approach this.  All part of my long journey toward a more test-driven style of development...</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../java-on-the-effectiveness-of-unit-testing/'>Java &#8211; On the effectiveness of unit testing</a></li><li class="list-group-item"><a href='../unit-testing-single-or-multiple-files-for-unit-testing-a-single-class/'>Unit-testing &#8211; Single or multiple files for unit testing a single class</a></li><li class="list-group-item"><a href='../c-how-to-use-mock-objects-c-without-passing-them-as-arguments-to-functions/'>C++ &#8211; How to use mock objects [C++] without passing them as arguments to functions</a></li><li class="list-group-item"><a href='../unit-testing-are-integration-tests-meant-to-repeat-all-unit-tests/'>Unit-testing &#8211; Are integration tests meant to repeat all unit tests</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>