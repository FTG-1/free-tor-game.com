<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>How does a stack VM manage with only one stack &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1086101 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1086101" class="post-1086101 software type-software status-publish hentry category-software tag-low-level tag-virtual-machine"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">How does a stack VM manage with only one stack</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">low-level</span><span class="mr-2 badge badge-info">virtual machine</span></p><div class="entry-content"><p>Lately I&#39;ve been asking a lot of questions here about VMs. Here&#39;s another one:</p><p>I understand that often stack based VMs use only one stack &#8211; the call stack &#8211; for everything. E.g. it is also used for evaluation of arithmetic expressions.</p><p>What I don&#39;t understand is, how doesn&#39;t this complicate things a whole lot? I&#39;ll demonstrate what I mean with an example.</p><p>Please consider the following psuedocode program:</p><pre><code>func main:
    funcA()

func funcA:
    2 + 4 * 8
</code></pre><p>This would compile to the following bytecode:</p><pre><code>main:
call funcA
end
funcA:
push 2
push 4
push 8
mult
add
end
</code></pre><p>(In this bytecode, the program starts at <code>main:</code>. <code>call</code> pushes the program counter onto the stack and jumps to the specified label. When an <code>end</code> is reached, the top of the stack &#8211; assumed to be a line number &#8211; is popped and we jump there.)</p><p>So let&#39;s see what happens here:</p><p>In <code>call funcA</code>, we push the program counter (i.e. next line number) onto the stack. Then we jump to <code>funcA</code>.</p><p>In <code>funcA</code> some computation is made. After the computation, the number <code>34</code> is left at the top of the stack.</p><p>When we reach <code>end</code>, we pop the top of the stack, assuming it&#39;s the line number we should return to<br /> But it isn&#39;t, the line number to return to is buried underneath. How should <code>end</code> know about this?</p><p>To avoid all this mess, we can just have a separate data stack and call stack, and not mix the two.</p><p>So my question is: why do some VMs (such as the JVM) use one stack for everything, and when the do: how do they handle situations such as the one described above?</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><blockquote><p>When we reach <code>end</code>, we pop the top of the stack, assuming it&#39;s the line number we should return to But it isn&#39;t, the line number to return to is buried underneath. How should end know about this?</p></blockquote><p>You compiled the source to the wrong opcodes. There are two ways to solve this:</p><ol><li><p>Put a <code>swap</code> before each <code>end</code>. Because the return address sits immediately underneath the return value, this will put the return address onto the top. After <code>end</code> has performed the return, the return value will be the top value.</p></li><li><p>Define an operation <code>return</code> which pops <em>two</em> values off the stack. The second value is the return address, the first value is the return value. After updating the instruction pointer to point to the return address, the return value is pushed back onto the stack. Then use this sane <code>return</code> instead of <code>end</code>.</p></li></ol><p>The compiler is responsible for emitting correct instructions.</p><hr/><p>It is possible to write a VM using only one stack. However, this vastly restricts the expressiveness. When using multiple stacks, it becomes far more easy to implement more advanced control flow such as coroutines, continuations, error handlers. In a multi-stack architecture, there would typically be a value stack, and a separate call stack which stores not only the return address but possibly also debugging data, or cleanup actions to perform when the current scope is left. If you&#39;re already using multiple stacks, it also becomes easier to use segmented stacks, which are a technique to avoid stack overflows. Essentially, the stack is actually a linked lists of smaller stacks. If one segment is full and would overflow, then another segment is allocated and added to the list.</p><p>For a well-studied multi-stack VM look at the <a href="https://en.wikipedia.org/wiki/SECD_machine" rel="nofollow">SECD machine</a>, essentially a lambda calculus interpreter.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../does-it-violate-the-license-to-use-windows-xp-mode-with-virtual-box/'>Does it violate the license to use Windows XP Mode with Virtual Box</a></li><li class="list-group-item"><a href='../how-would-one-go-about-reading-memory-from-a-process-is-it-different-by-os/'>How would one go about reading memory from a process? Is it different by OS</a></li><li class="list-group-item"><a href='../which-are-the-alternatives-to-using-a-stack-to-represent-function-call-semantics/'>Which are the alternatives to using a stack to represent function call semantics</a></li><li class="list-group-item"><a href='../how-do-vms-implement-function-calling/'>How do VMs implement function calling</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>