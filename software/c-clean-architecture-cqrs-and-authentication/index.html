<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>C# &#8211; Clean architecture, CQRS, and authentication &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1071544 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1071544" class="post-1071544 software type-software status-publish hentry category-software tag-c tag-clean-architecture tag-cqrs tag-design-patterns"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">C# &#8211; Clean architecture, CQRS, and authentication</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">c</span><span class="mr-2 badge badge-info">clean-architecture</span><span class="mr-2 badge badge-warning">cqrs</span><span class="mr-2 badge badge-primary">design-patterns</span></p><div class="entry-content"><p>I&#39;m working on implementing my first clean architecture and CQRS application, I&#39;ve stumbled across a bit of logic that&#39;s leaving me a bit stumped. I&#39;m working on integrating authorization and authentication into my application, but I&#39;m having some trouble trying to figure out how to architect a portion of my application that will handle command validation. My system is multitenant and currently shares a database across all of my clients, and I need to implement some sort of system that will enable me to perform all of my verification in a way that is straightforward and not too tightly coupled.</p><p>In my system, I have a implementations for both <code>Users</code> and <code>Clients</code>. Users can belong to any number clients. These users also have varying levels of permissions granted to them (but this is managed by my roles systems and mostly irrelevant here). My WebAPI is designed in such a way that I limit authorization based on a fixed number of <code>Roles</code> and <code>Claims</code>. These largely remain static, so I don&#39;t need much flexibility here.</p><p>My main source of headache is determining &#34;User-Client&#34; interaction permissions. Namely, I want to determine if a user has access to client that they&#39;re attempted to update records for. One approach would be to add <code>UserId</code> to all of my commands and to individually check the permissions during each command and query. This seems tedious and prone to issues.</p><p>Another approach I considered was to define an interface or base class that merely added the client and user Ids to any object in which they were required, but this had the adverse affect of exposing those implementations to my WebAPIs (via swagger and the UserId/ClientId being a portion of the Request/Command object).</p><p>One final approach would be to make my underlying commands still implement those interfaces, but have my controller contain minimal logic to map an API request into one of my command objects. Again, this would be tedious and would start leaking my logic into my controllers.</p><p>Overall, it&#39;s as if I need some additional structure in my application in which I can pipe any object containing a <code>ClientId</code> into so that I can keep the <code>Authentication</code> and <code>Authorization</code> logic out of my core app. However, I&#39;m mostly stumped, and I&#39;m looking for ways that I can simplify my application by minimizing the overhead of adding client-dependent commands and queries.</p><p>If it&#39;s of any relevance, some of the core tools and technologies I&#39;m leveraging are:</p><ul><li>.Net Core 2.1</li><li>Mediatr</li><li>Entity Framework</li></ul><p>And my core application implements commands in a similar fashion to:</p><pre><code>public class CreateProductCommand : IRequest
{
    public int ClientId { get;set; }
    public int ParentProductId { get; set; }
    public string ProductName { get; set; }
    // other creation specific props here
}

public class CreateProductCommandHandler : IHandler&lt;CreateProductCommand&gt;
{
    public async Task&lt;Unit&gt; Handle(CreateProductCommand command)
    {
        // check parent permissions, make sure parent product
        // belongs to client who is entered. 
        // -----
        // rest of logic to save

        // -- Ideally the User-Client check would happen before
        // -- the command is ever sent to the handler, so that
        // -- only client-specific logic and permissions are checked.
        // -- As long as the user can edit the specific client, anything
        // -- that happens to the client is determined by standard business 
        // -- and domain logic.
    } 
}
</code></pre></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>Looks to me like your issue is:</p><p><em>I have a thread acting on behalf of a user. I don&#39;t wish to pollute my nice clean business logic with authorisation details. But my data store needs authorisation details to enforce control of the data.</em></p><p>From your description it sounds pretty critical that User A does/does not have access to Client B.  That sounds very much like a <em>Business Concern</em>. So the first answer is its pretty obvious: <strong>Your business logic should care about which user is doing what</strong>. Passing the user details through the appropriate business logic directly is the clean way to handle this. This gives many positives: its clear, its clean, its easily tested, and the API is not coupled to the Data Store.</p><p>If need be there will be a point in your Business Logic where you can translate from talking about a <code>User</code>, to specifically talking about <code>Authorised to do X</code>. Also there is no reason why this User information could not be made more anemic, or enriched in different parts of your Business Logic.</p><p>Pragmatically, if the thread only serves one User at a time, use Thread Local storage and shove a reference to the user there. Later in your data store (aka wherever you need it) access that reference. <em>This is a dreadful solution.</em> It enforces direct coupling between API and Data Store (the recipient location), the Business Concern is not in the Business Logic, and you have a non-intuitive, indirect argument, that may not be set or cleaned up properly affecting future calls on the thread. In short what you make back from tedium, you will pay back over and over again in bugs and change resistance.</p><hr/><p><em>Added extra answer</em></p><p><strong>Possible Solutions</strong></p><ol><li>Attribute with some Aspect-Orientated programming.</li><li>an Abstract Class/interface with some Aspect-Orientated programming.</li><li>A Generic class that wraps a lambda/interface.</li><li>a Meta Program that constructs an Abstract class for derivation.</li><li>a Meta Program that constructs a tailored class which wraps a lambda/interface.</li></ol><p>Solutions 1 and 2 uses your languages aspect orientation (C# attributes) to detect the &#34;authorisation required&#34; functions, and intercept calls to them. It will throw an exception on unauthorised, but permit the call if authorised.</p><pre><code>class command
{
    public command(User user);

    public User user {get; }

    [AuthorisedFor(&#34;xyz&#34;)]
    public void action(object a);

    [AuthorisedFor(&#34;xyz&#34;)]
    public void action(User user, object a);
}
</code></pre><p>Solution 1 requires you to directly decorate the authorisation required functions, and provide an properties/arguments for user information.</p><p>Solution 2 allows you to pre-specify the authorisation required for the standard functions, and provide the properties/arguments for user information.</p><p>Solution 3 is a decorator and captures through its constructor the knowledge about authority required, the permit and deny functions. The only issue is that the Command interface will either force you to use <code>Object</code> arguments, a Generic Type and a limit on arguments, or require copies per downstream command interface.</p><pre><code>class command&lt;T&gt;
{
    public command(User user, Authority[] required, Action&lt;T&gt; permit, Action&lt;T&gt; deny);

    public void action(T arguments);
}
class command2
{
    public command(Authority[] required, SomeInterface permit, SomeInterface2 deny);

    public void action();
}
</code></pre><p>Solutions 4 and 5 are just not easily achieved in C#. You would essential need to write code that JIT&#39;s a new Base Class and derivations, or decorator classes for the various interfaces. I only include them for completeness.</p><p>The run-time flexible options are 3 or 5. The other solutions 1, 2 or 4 are more reasonable for compile time.</p><p><strong>User and Authorisation Passing</strong></p><p>Orthogonal to which solution you pick for handling permit/deny, those solutions will need access to the user/authorisations. These could be stored in various forms of storage:</p><ul><li>global</li><li>thread local</li><li>object property</li><li>function argument</li></ul><p>Picking Global or thread local is going to give you the implicit user passing you desire, it will however complicate testing and be a source of non-intuitive bugs.</p><p>Picking an Object property or a function argument is going to require that you pass the user/authorisation information through your commands. It will make the information requirement explicit, simplify testing, and reduce the capacity for non-intuitive bugs. It will require more typing.</p><p>My preference is for explicitly passing the user/authorisations down. However there may be a reason that makes the implicit Global/Thread local option the better choice.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../cqrs-and-cache-invalidation-while-load-balancing/'>CQRS and cache invalidation (while load balancing)</a></li><li class="list-group-item"><a href='../ddd-cqrs-per-query-and-per-command-authorization/'>DDD CQRS &#8211; per-query and per-command authorization</a></li><li class="list-group-item"><a href='../isnt-cqrs-overengineering/'>Isn&#8217;t CQRS overengineering</a></li><li class="list-group-item"><a href='../c-dealing-with-property-level-permissions-in-ddd-and-should-ui-or-authorization-influence-the-domain-model/'>C# &#8211; Dealing with property-level permissions in DDD and should UI or authorization influence the domain model</a></li><li class="list-group-item"><a href='../clean-architecture-and-repository-pattern/'>Clean architecture and Repository pattern</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>