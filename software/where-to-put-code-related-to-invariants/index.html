<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Where to put code related to invariants &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1084999 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1084999" class="post-1084999 software type-software status-publish hentry category-software tag-domain-driven-design tag-invariants"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Where to put code related to invariants</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">domain-driven-design</span><span class="mr-2 badge badge-info">invariants</span></p><div class="entry-content"><p>I am developing an small application, just to practice DDD. Afaik. invariants are the umbrella term of validation related to domain. So for example if I want to have only ucfirst names, then that is an invariant and I need validation in the property setter to make sure that this invariant is protected and make only the setter public, not the property itself.</p><p>My current problem is that I need to have usernames, which are generated from firstname, lastname, birthDate and probably some random stuff, if these are not unique enough. As far as I understand having a unique username is a domain concern, because it is very important if you want to login, or just bind some data to an actual user. So having a database table with pk on the username and wait for violating constraint error is just not enough, I should put some code into the domain, which makes sure that the generated username will be unique. I guess the code goes into the repository or into the entity somehow. Can you show me an example how this would look like in a real app? The domain and the app service implementation what I am curious of.</p><p>I might not be right about this. Every entity has a unique identifier and has repository, so probably I should put the username generation into the repository, and that&#39;s all. I might need to rephrase this for example what if we don&#39;t have a unique identifier, just a property which should be unique?</p><p>I made a little code draft:</p><pre><code>class CustomerService {

    // ...

    public createCustomerFromNameAndYear(name, year){
        try {
            transaction.begin();
            username = generateUsername(name, year);
            while (repo.findByUsername(username))
                username = addSomeRandomChar(username, 1);
            password = &#34;&#34;;
            password = addSomeRandomChar(password, 6);
            customer = new Customer(username, password, name, year);
            repo.save(customer);
            transaction.commit();
            dto = new CustomerDTO(customer.getUsername(), customer.getPassword());
            return dto;
        }
        catch(exception) {
            transaction.rollback();
            throw new ExceptionWithCauses(CUSTOMER_CREATION_FAILED, exception.getMessage());
        }
    }

}
</code></pre><p>If I put this into the app service, it will ensure that the name is unique unless if concurrence happens, but sending an error message is okay in that rare case. I am not sure whether this is okay. It does not feel right if the invariants must be parts of the domain code.</p><p>Another possible solution to have a create method in the repo.</p><pre><code>class CustomerService {

    // ...

    public createUserFromNameAndYear(name, year){
        try {
            transaction.begin();
            customer = repo.create(name, year);
            transaction.commit();
            dto = new CustomerDTO(customer.getUsername(), customer.getPassword());
            return dto;
        }
        catch(exception) {
            transaction.rollback();
            throw new ExceptionWithCauses(CUSTOMER_CREATION_FAILED, exception.getMessage());
        }
    }

}

class CustomerRepository implements iCustomerRepository {

    // ...

    public create(name, year){
        username = generateUsername(name, year);
        while (this.findByUsername(username))
            username = addSomeRandomChar(username, 1);
        password = &#34;&#34;;
        password = addSomeRandomChar(password, 6);
        customer = new Customer(username, password, name, year);
        this.save(customer);
        return customer;
    }
}
</code></pre><p>This might be better.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>In a multi-tier application an application is usually divided into three layers:</p><ul><li>presentation,</li><li>business logic,</li><li>data access.</li></ul><p>A data access layer should do one thing and do it well, it should know how to retrieve and persist entities which are used by business logic layer and shouldn&#39;t contain any business logic.</p><p>Note, that I am saying shouldn&#39;t, because errors in your data access layer may be your last resort mechanism, when everything else failed - such as you&#39;re trying to insert a duplicate record of a unique attribute because you failed to check beforehand.</p><p>But why exactly would a unique username attribute exist within your system? There are two posibilities:</p><ol><li>The data access layer&#39;s mechanism produces this constraint and you have no control over it.</li><li>Your stakeholders told you that in your system a username MUST be unique and will be used for signing in - stakeholders presented a business rule which must be fulfilled.</li></ol><p>We can completely ignore case number 1, as data storages do not care at all what goes into them, as long as the format is correct they do not care about the actual value. They only limit you to unique values if you tell them to do so. Meaning, you are actually facing the 2. situation - a business rule.</p><p>With the rule in mind, you added a constraint to your data store engine (should it support) that an attribute MUST indeed be unique, but as I have mentioned, you shouldn&#39;t rely on this, it&#39;s only there to fail at the lowest level when everything else fails.</p><p>And because the rule that a username MUST be unique was actually produced by the business owners, it belong to the business logic layer, that&#39;s its rightful place.</p><p>Your repository <code>create</code> method should only contain the <code>INSERT</code> command and no checks anymore. And if someone forgets to check for unique username and uses the <code>create</code> method of the <code>ICustomerRepository</code> interface without checking for a unique username then it&#39;s expected the repository method might fail, because the programmer ignoring the check actually broke an important rule.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../is-domain-entity-violating-single-responsibility-principle/'>Is Domain Entity violating Single Responsibility Principle</a></li><li class="list-group-item"><a href='../how-to-avoid-duplication-of-code-related-to-shared-entities-in-the-repository-pattern/'>How to avoid duplication of code related to shared entities in the repository pattern</a></li><li class="list-group-item"><a href='../how-to-design-the-aggregate-boundaries/'>How to design the aggregate boundaries</a></li><li class="list-group-item"><a href='../c-ddd-factory-or-service/'>C# &#8211; DDD &#8211; Factory or Service</a></li><li class="list-group-item"><a href='../architecture-dataaccess-layer-coupling-with-domain-layer/'>Architecture &#8211; DataAccess Layer coupling with Domain Layer</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>