<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>C# &#8211; Is it possible to implement a well-distributed hash table without using the % operator &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1080639 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1080639" class="post-1080639 software type-software status-publish hentry category-software tag-algorithms tag-c tag-hashing tag-language-agnostic"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">C# &#8211; Is it possible to implement a well-distributed hash table without using the % operator</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">algorithms</span><span class="mr-2 badge badge-info">c</span><span class="mr-2 badge badge-warning">hashing</span><span class="mr-2 badge badge-primary">language-agnostic</span></p><div class="entry-content"><p>I&#39;m looking to implement a fast, well-distributed hash table in C#. I&#39;m having trouble choosing my hash-constraining function that takes an arbitrary hash code and &#34;constrains&#34; it so it can be used to index the buckets. There are two options that I see so far:</p><ul><li><p>On one hand, you can make sure your buckets always have a prime number of elements, and to constrain the hash you simply modulo it by the number of buckets. This is, in fact, <a href="https://github.com/dotnet/coreclr/blob/master/src/mscorlib/src/System/Collections/Generic/Dictionary.cs">what .NET&#39;s Dictionary does</a>. <strong>The problem with this approach is that using % is extremely slow compared to other operations;</strong> if you look at the <a href="http://www.agner.org/optimize/instruction_tables.pdf">Agner Fog instruction tables</a>, <code>idiv</code> (which is the assembly code that gets generated for %) has an instruction latency of ~25 cycles for newer Intel processors. Compare this to around 3 for <code>mul</code>, or 1 for bitwise ops like <code>and</code>, <code>or</code>, or <code>xor</code>.</p></li><li><p>On the other hand, you can have the number of buckets always be a power of 2. You will still have to calculate the modulus of the hash so you don&#39;t attempt to index outside the array, but this time it will be less expensive. Since for powers of 2 <code>% N</code> is just <code>&amp; (N - 1)</code>, the constraining is reduced to a masking operation which only takes 1-2 cycles. This is done by <a href="https://github.com/sparsehash/sparsehash/blob/master/src/sparsehash/internal/sparsehashtable.h#L580">Google&#39;s sparsehash</a>. <strong>The downside of this is that we are counting on users to provide good hashes;</strong> masking the hash essentially cuts off part of the hash, so we are no longer taking all bits of the hash into account. If the user&#39;s hash is unevenly distributed, for example only the higher bits are filled out or the lower bits are consistently the same, then this approach has a much higher rate of collisions.</p></li></ul><p>I am looking for an algorithm I can use that has the best of both worlds: <strong>it takes all bits of the hash into account, and is also faster than using %.</strong> It does not necessarily have to be a modulus, just something that is guaranteed to be in the range <code>0..N-1</code> (where N is the length of the buckets) and has even distribution for all slots. Does such an algorithm exist?</p><p>Thanks for helping.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>Modern hash table implementations do not use the modulo function. They often use power of two sized tables and chop off unneeded bits. An ideal hash function would allow this. The use of modulo combined with prime number table sizes arose in the days when hash functions were generally poor, as they often are in .net development. I recommend reading about <a href="https://en.wikipedia.org/wiki/SipHash" rel="nofollow">SipHash</a>, a modern hash function, then reading about some other modern functions, such as <a href="https://github.com/Cyan4973/xxHash" rel="nofollow">xxHash</a>.</p><p>I should explain why .net hash functions are often poor. In .net, programmers are often forced to implement hash functions by overriding GetHashcode. But .net does not provide the tools needed to ensure the programmer created functions are high-quality, namely:</p><ul><li>encapsulation of the hash state in a structure or class</li><li>hash &#34;add&#34; functions, which add new data to the hash state (add a byte array, or a double, for example)</li><li>a hash &#34;finalize&#34; function, to produce the avalanche</li><li>encapsulation of the hash result -- in .net you get one choice, a 32 bit signed integer.</li></ul><p>For more information about using a hash function result as a hash table index, please see the definitions of universal forms of hashing in this paper: <a href="http://arxiv.org/abs/1503.03465" rel="nofollow">Faster 64-bit universal hashing using carry-less multiplications</a></p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../hash-algorithm-randomness-visualization/'>Hash Algorithm Randomness Visualization</a></li><li class="list-group-item"><a href='../how-does-pearson-hashing-compare-with-other-non-cryptographic-hashing-algorithms/'>How does Pearson hashing compare with other non-cryptographic hashing algorithms</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>