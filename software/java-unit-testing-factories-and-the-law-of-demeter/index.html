<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Java &#8211; Unit testing, factories, and the Law of Demeter &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1068428 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1068428" class="post-1068428 software type-software status-publish hentry category-software tag-dependency-injection tag-java tag-unit-testing"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Java &#8211; Unit testing, factories, and the Law of Demeter</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">dependency-injection</span><span class="mr-2 badge badge-info">java</span><span class="mr-2 badge badge-warning">unit testing</span></p><div class="entry-content"><p>Here&#39;s how my code works. I have an object that represents the current state of something akin to a shopping cart order, stored in a 3rd party shopping API. In my controller code, I want to be able to call:</p><pre><code>myOrder.updateQuantity(2);
</code></pre><p>In order to actually send the message to the third party, the third party also needs to know several things that are specific to THIS order, like the <code>orderID</code>, and the <code>loginID</code>, which will not change in the lifetime of the application.</p><p>So when I create <code>myOrder</code> originally, I inject a <code>MessageFactory</code>, which knows <code>loginID</code>. Then, when <code>updateQuantity</code> is called, the <code>Order</code> passes along <code>orderID</code>. The controlling code is easy to write. Another thread handles the callback and updates <code>Order</code> if its change was successful, or informs <code>Order</code> that its change failed if it was not.</p><p>The problem is testing. Because the <code>Order</code> object depends on a <code>MessageFactory</code>, and it needs <code>MessageFactory</code> to return actual <code>Message</code>s (that it calls <code>.setOrderID()</code> on, for example), now I have to set up very complicated <code>MessageFactory</code> mocks. <a href="http://dearjunior.blogspot.com/2009/11/demeter-saves-mocking-fairies.html" rel="nofollow noreferrer">Additionally, I don&#39;t want to kill any fairies, as &#34;Every time a Mock returns a Mock a fairy dies.&#34;</a></p><p>How can I solve this problem while keeping the controller code just as simple? I read this question: <a href="https://stackoverflow.com/questions/791940/law-of-demeter-on-factory-pattern-and-dependency-injection">https://stackoverflow.com/questions/791940/law-of-demeter-on-factory-pattern-and-dependency-injection</a> but it didn&#39;t help because it didn&#39;t talk about the testing problem.</p><p>A few solutions I&#39;ve thought of:</p><ol><li>Somehow refactor the code to not require that the factory method return real objects. Perhaps it&#39;s less of a factory and more of a <code>MessageSender</code>?</li><li>Create a testing-only implementation of <code>MessageFactory</code>, and inject that.</li></ol><hr/><p>The code is pretty involved, here&#39;s my attempt at an sscce:</p><pre><code>public class Order implements UpdateHandler {
    private final MessageFactory factory;
    private final MessageLayer layer;

    private OrderData data;

    // Package private constructor, this should only be called by the OrderBuilder object.
    Order(OrderBuilder builder, OrderData initial) {
        this.factory = builder.getFactory();
        this.layer = builder.getLayer();
        this.data = original;
    }

    // Lots of methods like this
    public String getItemID() {
        return data.getItemID();
    }

    // Returns true if the message was placed in the outgoing network queue successfully. Doesn&#39;t block for receipt, though.
    public boolean updateQuantity(int newQuantity) {
        Message newMessage = factory.createOrderModification(messageInfo);

        // *** THIS IS THE KEY LINE ***
        // throws an NPE if factory is a mock.
        newMessage.setQuantity(newQuantity); 

        return layer.send(newMessage); 
    }

    // from interface UpdateHandler
    // gets called asynchronously
    @Override 
    public handleUpdate(OrderUpdate update) {
        messageInfo.handleUpdate(update);
    }
}
</code></pre></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>The major concern here is that mocks can&#39;t (or shouldn&#39;t) return mocks. This is probably good advice, but talks around a solution: return a real <code>Message</code>. If the <code>Message</code> class is well-tested and passing, you can consider it to be just as friendly as a mock. Perhaps it is even friendlier as it will respond like the real thing because it is the real thing.</p><p>What kind of real <code>Message</code>s can you return? Well, you can return a full-fledged real <code>Message</code>, a simplified real <code>Message</code> (wherein well-known defaults are used), or you can return a <code>NullMessage</code> (as in the Null Object Pattern). A <code>NullMessage</code> is just as valid a <code>Message</code> as any other, and can be dropped in anywhere else in your application. Which one to use depends on the complexity of creating and returning a full message.</p><p>As to the Law of Demeter, there are multiple concerns here. First, your constructor takes its own builder as a parameter, then extracts elements from it. This is a clear violation of Demeter, and also creates a superfluous dependency. Worse yet, the builder is acting as a mini service locator, masking the real dependencies of the class. The <code>OrderBuilder</code> should create these objects and pass them in as their own parameters.</p><p>In order to test this, then, you would pass in a mock <code>MessageFactory</code>, which returns a real <code>Message</code> (either full, simple, or null), and a mock <code>MessageLayer</code> that takes the message. If you use a full or simplified <code>Message</code>, you could get it back from your <code>MessageLayer</code> mock and inspect it for testing assertions.</p><p>I would also look at the <code>MessageFactory</code> and <code>MessageLayer</code> as a functionality clump at a different level of abstraction, and so I would extract a <code>MessageSender</code> class that encapsulated that functionality. You could test this class by using a simple mock <code>MessageSender</code>, and shift everything I talked about above into the <code>MessageSender</code>&#39;s tests, thereby adhering more closely to Single Responsibility as well.</p><hr/><p>I see there are really two questions here. There is a specific question of how to test <em>this</em> code, <strong>and</strong> a general question about mocks returning mocks. The specific question is what I dealt with above to a larger extent, and I have more thoughts at the end of here about it now that some more details have come to light, but there is not really a good answer yet to the general question: Why should mocks not return mocks?</p><p>The reason mocks should not return mocks is that you can end up testing your tests rather than testing your code. Instead of just making sure that the unit is fully functional, the test now depends on a whole new piece of code found only in the test case itself (which often is itself not tested). This creates two problems.</p><p>First, the test now cannot tell me for sure if the unit is broken or if the interrelated mocks are broken. The whole point of a test is to create an isolated environment where there should be only one cause for failure. A mock on its own is generally very simple and can be inspected directly for problems, but wiring multiple mocks together like this becomes exponentially harder to confirm by inspection.</p><p>The second problem is, as APIs change for the real objects, tests may start failing far away since the mocks do not automatically change as well. The Law of Demeter comes into play here, as these are exactly the type of effects following the law avoids. In my tests, I would have to worry about keeping in sync not only the mocks of direct dependencies, but also the mocks of dependencies of dependencies <em>ad infinitum</em>. This has the effect of shotgun surgery on the tests when classes change.</p><hr/><p>Now, as to the specific question of how to test this particular piece of code, let&#39;s break down some assumptions.</p><p><strong>Question 1:</strong> What are we really testing? While this is an abbreviated portion of the code, we can see three essential activities going on here. First, we have a factory generating a <code>Message</code>. We aren&#39;t testing whether the factory is producing the <code>Message</code>, as you&#39;re already mocking that out. We&#39;re not testing the <code>Message</code>, as it should be tested elsewhere, presumably in a suite of tests for the third-party API that generates the <code>Message</code>. In the second line, we can see from inspection that the method is simply called on the <code>Message</code> and so there is really nothing to test in the second line. Once again, there should be tests elsewhere that make testing this redundant. The third line calls the <code>MessageLayer</code> API, and simply passes through the result. Once again, <code>MessageLayer</code>&#39;s API should already be tested elsewhere. This leaves us with essentially nothing to test. There are no direct visible side effects to the external code, and we should not be testing internal implementation. That leads us to the one conclusion that <strong>it would be inappropriate to test this code at all</strong>. (For more on this line of reasoning, see Sandi Metz&#39;s presentation <em>Magic Tricks of Testing</em>, [<a href="https://speakerdeck.com/skmetz/magic-tricks-of-testing-railsconf">slides</a>, <a href="http://www.confreaks.com/videos/2452-railsconf2013-the-magic-tricks-of-testing">video</a>])</p><p><strong>Question 2:</strong> Wait, so then...wha?? Yes, that&#39;s right, don&#39;t test this at all. Now, as mentioned, this is an abbreviated version of the code. If you have other logic, test that, but encapsulate this into a separate unit (like the <code>MessageSender</code> implementation mentioned above). You can then mock this entire aspect of the code easily, while still having the ability to test other logic.</p><p>You are basically using a third-party API directly in your code. Third-party code is notoriously hard to test because it can have these types of dependency issues you have here. Encapsulating it off into a corralled area can make it easier to test your other code, and reduce shotgun surgery if that third-party changes their code (or just changes). While there may still be pain in testing the part that interacts with the third-party API, it is limited to one small facet that you can isolate.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../c-interfacing-application-code-with-unit-tests/'>C++ &#8211; Interfacing application code with unit tests</a></li><li class="list-group-item"><a href='../unit-testing-the-most-appropriate-testing-method-in-this-scenario/'>Unit-testing &#8211;  the most appropriate testing method in this scenario</a></li><li class="list-group-item"><a href='../unit-testing-should-we-design-our-code-from-the-beginning-to-enable-unit-testing/'>Unit-testing &#8211; Should we design our code from the beginning to enable unit testing</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>