<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Why would more CPU cores on virtual machine slow compile times &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1065523 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1065523" class="post-1065523 software type-software status-publish hentry category-software tag-asp-net tag-compiler tag-scalability tag-virtual-machine tag-virtualization"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Why would more CPU cores on virtual machine slow compile times</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">asp.net</span><span class="mr-2 badge badge-info">compiler</span><span class="mr-2 badge badge-warning">scalability</span><span class="mr-2 badge badge-primary">virtual machine</span><span class="mr-2 badge badge-danger">virtualization</span></p><div class="entry-content"><p>[edit#2] If anyone from VMWare can hit me up with a copy of VMWare Fusion, I&#39;d be more than happy to do the same as a VirtualBox vs VMWare comparison. Somehow I suspect the VMWare hypervisor will be better tuned for hyperthreading (see my answer too)</p><p>I&#39;m seeing something curious. As I increase the number of cores on my Windows 7 x64 virtual machine, the overall compile time <strong><em>increases</em></strong> instead of decreasing. Compiling is usually very well suited for parallel processing as in the middle part (post dependency mapping) you can simply call a compiler instance on each of your .c/.cpp/.cs/whatever file to build partial objects for the linker to take over. So I would have imagined that compiling would actually scale very well with # of cores.</p><p>But what I&#39;m seeing is:</p><ul><li>8 cores: 1.89 sec</li><li>4 cores: 1.33 sec</li><li>2 cores: 1.24 sec</li><li>1 core: 1.15 sec</li></ul><p>Is this simply a design artifact due to a particular vendor&#39;s hypervisor implementation (type2:virtualbox in my case) or something more pervasive across more VMs to make hypervisor implementations more simpler? With so many factors, I seem to be able to make arguments both for and against this behavior &#8211; so if someone knows more about this than me, I&#39;d be curious to read your answer.</p><p>Thanks<br /> Sid</p><p>[<em>edit:addressing comments</em>]</p><p>@MartinBeckett: Cold compiles were discarded.</p><p>@MonsterTruck: Couldn&#39;t find an opensource project to compile directly. Would be great but can&#39;t screwup my dev env right now.</p><p>@Mr Lister, @philosodad: Have 8 hw threads, using VirtualBox, so should be 1:1 mapping without emulation</p><p>@Thorbjorn: I have 6.5GB for the VM and a smallish VS2012 project &#8211; it&#39;s quite unlikely that I&#39;m swapping in/out trashing the page file.</p><p>@All: If someone can point to an open source VS2010/VS2012 project, that might be a better community reference than my (proprietary) VS2012 project. Orchard and DNN seem to need environment tweaking to compile in VS2012. I really would like to see if someone with VMWare Fusion also sees this (for VMWare vs VirtualBox compartmentalization)</p><p><strong>Test details:</strong></p><ul><li>Hardware: Macbook Pro Retina<ul><li>CPU : Core i7 @ 2.3Ghz (quad core, hyper threaded = 8 cores in windows task manager)</li><li>Memory : 16 GB</li><li>Disk : 256GB SSD</li></ul></li><li>Host OS: Mac OS X 10.8</li><li>VM type: VirtualBox 4.1.18 (type 2 hypervisor)</li><li>Guest OS: Windows 7 x64 SP1</li><li>Compiler: VS2012 compiling a solution with 3 C# Azure projects<ul><li>Compile times measure by VS2012 plugin called &#39;VSCommands&#39;</li><li>All tests run 5 times, first 2 runs discarded, last 3 averaged</li></ul></li></ul></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>Answer: It doesn&#39;t slow down, it does scale up with # of CPU cores. The project used in the original question was &#39;too small&#39; (it&#39;s actually a <em>ton</em> of development but small/optimized for a compiler) to reap the benefits of multiple cores. Seems instead of planning how to spread the work, spawning multiple compiler processes etc, at this small scale it&#39;s best to hammer at the work serially right off the bat.</p><p>This is based off the new experiment I did based off the comments to the question (and my personal curiosity). I used a larger VS project - Umbraco CMS&#39;s <a href="http://umbraco.codeplex.com/SourceControl/list/changesets">source code</a> since it&#39;s large, open sourced and one can directly load up the solution file and rebuild (hint: load up <code>umbraco_675b272bb0a3\src\umbraco.sln</code> in VS2010/VS2012).</p><p>NOW, what I see is what I expect, i.e. <em>compiles scale up!!</em> Well, to a certain point since I find:</p><p><img src="../../../i.stack.imgur.com/J3FxN.png" alt="Table of results"/></p><p>Takeaways:</p><ul><li>A new VM core results in a new OS X Thread within the VirtualBox process</li><li>Compile times scale up as expected (compiles are long enough)</li><li>At 8 VM cores, core emulation might be kicking in within VirtualBox as the penalty is massive (50% hit)</li><li>The above is likely because OS X is unable to present 4 hyper-threaded cores (8 h/w thread) as 8 cores to VirtualBox</li></ul><p>That last point caused me to monitor the CPU history across all the cores via &#39;Activity Monitor&#39; (CPU history) and what I found was</p><p><img src="../../../i.stack.imgur.com/LN5Yj.png" alt="OS X CPU history graph"/></p><p>Takeaways:</p><ul><li><p>At one VM core, the activity seems to be hopping across the 4 HW cores. Makes sense, to distribute heat evenly at core levels.</p></li><li><p>Even at 4 Virtual cores (and 27 VirtualBox OS X threads or ~800 OS X thread overall), only even HW threads (0,2,4,6) are almost saturated while odd HW threads (1,3,5,7) are almost at 0%. More likely the scheduler works in terms of HW cores and NOT HW threads so I speculate perhaps the OSX 64bit kernel/scheduler isn&#39;t optimized for hyper threaded CPU? Or looking at the 8VM core setup, perhaps it starts using them at a high % CPU utilization? Something funny is going one ... well, that&#39;s a separate question for some Darwin developers ...</p></li></ul><p>[edit]: I&#39;d love to try the same in VMWare Fusion. Chances are it won&#39;t be this bad. I wonder if they showcase this as a commercial product ...</p><p>Footer:</p><p>In case the images ever disappear, the compile time table is (text, ugly!)</p><pre><code>Cores in    Avg compile      Host/OSX    Host/OSX CPU
   VM         times (sec)   Threads      consumption
    1           11.83            24        105-115%
    2           10.04            25        140-190%
    4            9.59            27        180-270%
    8           14.18            31        240-430%
</code></pre></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   </div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>