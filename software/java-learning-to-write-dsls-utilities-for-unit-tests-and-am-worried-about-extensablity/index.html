<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Java &#8211; Learning to write DSLs utilities for unit tests and am worried about extensablity &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1086926 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1086926" class="post-1086926 software type-software status-publish hentry category-software tag-construction tag-dsl tag-java"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Java &#8211; Learning to write DSLs utilities for unit tests and am worried about extensablity</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">construction</span><span class="mr-2 badge badge-info">dsl</span><span class="mr-2 badge badge-warning">java</span></p><div class="entry-content"><p>I&#39;m trying to simplify our unit tests with hand written DSL&#39;s.  So far I have DSL&#39;s that walk developers through processing a service after setting up all preconditions and the construction of an <a href="https://stackoverflow.com/questions/22909717/is-this-monster-builder-a-good-builder-factory-pattern-for-abstracting-long-co">monster object</a> that has a huge constructor and setters that conflict.  The monster is one of the many preconditions of processing the service and they constructed by hand over and over as developers write unit tests for new services in our system.  So it would be worth putting considerable effort into making constructing them easier.  I&#39;m tried of watching people copy and paste the &#34;life support system&#34; from unit test to unit test.</p><p>I&#39;m making separate new classes, one who&#39;s job it is to build the monster class and one that walks them through the steps to process the service.  These will be used by many developers.  This means once it&#39;s used widely changes will be difficult.  That&#39;s why I&#39;m worried about extendability.</p><p>Rather than a simple <a href="http://onjavahell.blogspot.com/2009/07/introducing-builder-design-pattern.html" rel="nofollow noreferrer">fluent interface builder</a> (where every method returns a <code>this</code> and is always available) I&#39;ve decided to use an internal DSL that returns a different nested class.  This is a very powerful choice.  It lets me limit the methods available at any one step to only the valid ones.  It also lets me change what the return type of a method is based on the &#34;state&#34; previous choices put the DSL into.</p><p>Briefly, the way it works is the first method returns the first nested class that has the next valid method that could not have been called before.  This limits the choices intelisense will offer making writing the DSL&#39;s calling code easier.</p><pre><code>//Final build() method doesn&#39;t exist on PersonBuilder.  Its on a nested class.
public class PersonBuilder {
    public GotRequired doRequired() {
        return new GotRequired();
    }

    //One of many nested classes 
    public class GotRequired {
        public GotFirstName addFirstName(String firstName) {
            mFirstName = firstName;
            return new GotFirstName();
        }
    }

    public class GotFirstName {
        public GotMiddleName addMiddleName(String middleName) {
            mMiddleName = middleName;
            return new GotMiddleName();
        }
    }

    ...

}
</code></pre><p>This can be used to ensure methods are called in some order and ensure that preconditions have been met.  The inner classes can be thought of as states the DSL is in.  More than one state change path can be supported.  Simply being in a state can tell you what states came before so long as no state merges two state paths into one.  This all just means if you&#39;re careful you can know every needed method was called before building or returning a result.</p><p>Fair warning, what follows is java verbose boiler plate at it&#39;s finest.  The full listing is here: <a href="http://pastebin.com/5k5LhXW8" rel="nofollow noreferrer">Monster builder code</a>.</p><p>The monsters DSL code looks something like this:</p><pre><code>public class PersonBuilder {

// -- Required -- //

private String   mFirstName;
private String   mMiddleName;
...

// -- Required Alternatives -- //  
    
//Not both; not neither
private int      mBeersToday;     //One or
private String   mHowDrunk;       //the other


// -- What all the fuss is about -- //

private Person   mPerson;

/** Call each required method in order offered.*/
public GotRequired doRequired() {
    return new GotRequired();
}

public class GotRequired {
    public GotFirstName addFirstName(String firstName) {
        mFirstName = firstName;
        return new GotFirstName();
    }
}

public class GotFirstName {
    public GotMiddleName addMiddleName(String middleName) {
        mMiddleName = middleName;
        return new GotMiddleName();
    }
}

...

/*
   Client code example


    .doRequiredAlternatives()   //Either x or y. a, b, or c. etc.
        .addBeersToday(3)       //Now can&#39;t call addHowDrunk(&#34;Hammered&#34;);
        .addFavoriteBeer(&#34;Duff&#34;)//Now canâ€™t call addJobTitle(&#34;Safety Inspector&#34;);  
   .addBuild();                 //Calls different constructors based on alternatives

*/
    /** Now the interesting forking bit */
    public class GotRequiredAlternatives {
        public GotPerson addBeersToday(int beersToday){
            mBeersToday = beersToday;

            //Got enough for constructor
            mPerson = new Person(
                    mFirstName,
                    mMiddleName, 
                    mLastName,
                    
                    mNickName,                        
                    mMaidenName, 
                    mEyeColor,   
                    mHairColor,  
                    mDateOfBirth,
                    mBeersToday, //GotBeersToday
                    mAliases);
                
            return new GotPerson();
        }        

        public GotPerson addHowDrunk(String howDrunk){
            mHowDrunk = howDrunk;

            //Got enough for constructor
            mPerson = new Person(
                    mFirstName,
                    mMiddleName, 
                    mLastName,
                    
                    mNickName,                        
                    mMaidenName, 
                    mEyeColor,   
                    mHairColor,  
                    mDateOfBirth,
                    mHowDrunk, //GotHowDrunk
                    mAliases);
                
            return new GotPerson();
        }        
    }
    
    //Could have created GotHowDrunk and GotBeersToday 
    //but we&#39;re past the constructor choice so we can 
    //forget the path that brought us here.
    
    public class GotPerson {
        /** Build Person object leaving optional fields set to default values */
        public Person doBuild() {
            return mPerson;
        }
        /** Call any or none of these optional fields */
        public GotOptional doOptional() {
            return new GotOptional();        
        }
    }
    
    //Since person is not immutable the only thing gained here is confidence that these were set according to persons whacky rules
    class GotOptional {
        
        /** Build Person object */
        public Person doBuild() {
            return mPerson;
        }

        public GotOptionalAlternatives doOptionalAlternatives() {
            return new GotOptionalAlternatives();
        }

        public GotOptional addClothing(String clothing) {
            mPerson.setClothing(clothing);
            return this; 
        }
        
        public GotOptional addTatoo(String tattoo) {
            mPerson.setTattoo(tattoo);
            return this; 
        }
        
        //Add any number of setters that have good default values and do not conflict with each other
        
    }
    
    //Ideally person wouldn&#39;t allow this anyway but person is set in stone so at least this provides a safer interface
    public class GotOptionalAlternatives {

        /** Build Person object */
        public Person doBuild() {            
            return mPerson;
        }

        //Optional but conflicting setters. Might never be called.  Must never be called together.
       

        public GotFavoriteBeer addFavoriteBeer(String favoriteBeer){
            //mFavoriteBeer = favoriteBeer;  //TODO remove
            mPerson.setFavoriteBeer(favoriteBeer); //GotFavoriteBeer

            return new GotFavoriteBeer();
        }
        
        public GotJobTitle addJobTitle(String jobTitle){
            //mJobTitle = jobTitle;  //TODO remove
            mPerson.setJobTitle(jobTitle); //GotJobTitle

            return new GotJobTitle();
        }
    }
    
    //These are not strictly needed.  They are like one-statement {}&#39;s after an &#39;if&#39;.  Simply there if more gets added.

    public class GotFavoriteBeer {
        /** Build Person object */
        public Person doBuild() {            
            return mPerson;
        }
    }
    
    public class GotJobTitle {
        /** Build Person object */
        public Person doBuild() {            
            return mPerson;
        }
    }
}
</code></pre><p>I&#39;ll spare you the service code that uses the same nested class technique to mix optional methods and required methods.  It is also able to return different result types based on previous alternate method choices since even though the result() method has the same name and params it&#39;s coming off a different inner class.</p><p>Despite the unreal amount of typing required to create these DSLs I&#39;ve found the results to be very powerful.  However, I expect people will want new features added, new preconditions for processing the service.  If I use this style is there any hope of reuse or would it be better to just write a whole new DSL each time something needs to change?</p><p>Cause once it&#39;s working and being used I do NOT want to dive back into the existing DSL classes and mess with them.</p><p>If you can see other issues please let me know.  I&#39;m hoping for a peer review but I appreciate any feedback.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>Here&#39;s the thing with unit tests. You want them to be really easy to write. Anytime writing a test is made more difficult, it will result in tests not being written, and bugs will be allowed to live. So let&#39;s imagine I&#39;m writing a test:</p><pre><code>void testCanDrive() {
    Person person = new PersonBuilder()
        .doRequired()
        .addFirstName(&#34;John&#34;)
        .addMiddleName(&#34;Q&#34;)
        .addLastName(&#34;Smith&#34;)
        .addNickName(&#34;Johnny&#34;)
        .addMaidenName(&#34;Public&#34;)
        .addEyeColor(&#34;Blue&#34;)
        .addHairColor(&#34;Blond&#34;)
        .addDateOfBirth(new Date(1990, 1, 14))
        .addAliases()
        .doRequiredAlternatives()
        .addBeersToday(1)
        .doBuild();
    assertFalse(person.canDrive());
}
</code></pre><p>Here&#39;s the thing, I had to write a crazy amount of code to create the person object, and I didn&#39;t really care about most of those details. The only factors that would seem relevant to whether you can drive would be your date of birth and the beers you&#39;ve had. Forcing the test writer to specify all of that other details makes it harder to follow the test and discourages me from writing further tests.</p><p>Now your solution is probably way better than the status quo, but it still sucks. I would suggest that you really want to use a typical builder interface that set default values for everything. Each test will only set those details pertinent to the test itself, for everything else the defaults should be fine.</p><pre><code>void testCanDrive() {
    Person person = new PersonBuilder()
        .setDateOfBirth(new Date(1990, 1, 14))
        .setBeersToday(1)
        .doBuild();
    assertFalse(person.canDrive());
}
</code></pre></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../java-object-oriented-class-design/'>Java &#8211; Object-Oriented Class Design</a></li><li class="list-group-item"><a href='../java-benefit-of-using-static-inner-builder-class/'>Java &#8211; Benefit of using static inner builder class</a></li><li class="list-group-item"><a href='../java-is-it-considered-bad-practice-to-make-a-dao-call-in-an-objects-constructor/'>Java &#8211; Is it considered bad practice to make a DAO call in an object&#8217;s constructor</a></li><li class="list-group-item"><a href='../java-when-to-call-the-constructor-and-when-to-call-the-method-in-java/'>Java &#8211; When to call the constructor and when to call the method in Java</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>