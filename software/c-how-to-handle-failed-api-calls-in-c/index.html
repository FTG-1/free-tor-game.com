<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>C# &#8211; How to handle failed API calls in C# &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1076087 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1076087" class="post-1076087 software type-software status-publish hentry category-software tag-api tag-c tag-error-handling"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">C# &#8211; How to handle failed API calls in C#</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">api</span><span class="mr-2 badge badge-info">c</span><span class="mr-2 badge badge-warning">error handling</span></p><div class="entry-content"><p>I built my API service and now I want to consume the information from a WPF application.<br /> So far I created the class <code>ApiHelper</code> which initializes and provides the <code>HttpClient</code> used to call the API endpoints and the class <code>MemberService</code> which exposes the methods to get the data that it retrieves from the API.</p><pre><code>public class ApiHelper : IApiHelper
{
    private readonly IConfiguration _config;

    public HttpClient ApiClient { get; private set; }

    public ApiHelper(IConfiguration config)
    {
        _config = config;
        InitializeClient();

    }

    private void InitializeClient()
    {
        string apiBase = _config[&#34;api&#34;];

        ApiClient = new HttpClient
        {
            BaseAddress = new Uri(apiBase)
        };

        ApiClient.DefaultRequestHeaders.Clear();
        ApiClient.DefaultRequestHeaders.Accept.Add(new MediaTypeWithQualityHeaderValue(&#34;application/json&#34;));
    }
</code></pre><p>This is the service:</p><pre><code>public class MemberService : IMemberService
{
    private readonly IApiHelper _apiHelper;

    public MemberService(IApiHelper apiHelper)
    {
        _apiHelper = apiHelper;
    }

    public async Task&lt;List&lt;Member&gt;&gt; GetAllMembersAsync()
    {
        using (HttpResponseMessage response = await _apiHelper.ApiClient.GetAsync(&#34;/api/Members&#34;))
        {
            // If the response has a successful code...
            if (response.IsSuccessStatusCode)
            {
                // Read the response
                var result = await response.Content.ReadAsAsync&lt;List&lt;MemberResponse&gt;&gt;();
                var output = AutoMapping.Mapper.Map&lt;List&lt;Member&gt;&gt;(result);
                return output;
            }
            else
            // If the response is not successful
            {
                // Error handling here
            }
        }

        return null;
    }
</code></pre><p>My question is not about handling errors such as <code>HttpRequestException</code> that I could handle with a <code>try catch</code> block, but how to handle responses with a status code not in the 2xx range.<br /> In particular, the endpoints of the API are token-protected so a user has to authenticate before making a request and after the token expires, it needs to be refreshed.<br /> What I&#39;d like to do is when the response has a status of <code>401 - Unauthorized</code>, instead of throwing an exception or returning an object with an error message, the method should try to refresh the token (calling the appropriate method in another service) because it could be expired and just if the call fails again, throw the exception. I&#39;d like to have this behavior for all the API calls.<br /> It&#39;s the first time I work with API calls, so this is what I thought to do, but I&#39;d like to have some tips about how to do it.<br /> What is the best approach to achive this? Or do you suggest another way to make API calls and manage its responses?</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><blockquote><p>What I&#39;d like to do is when the response has a status of 401 - Unauthorized, instead of throwing an exception or returning an object with an error message, the method should try to refresh the token (calling the appropriate method in another service) because it could be expired and just if the call fails again, throw the exception. I&#39;d like to have this behavior for all the API calls.</p></blockquote><p>That sounds like a great idea.</p><p>Let&#39;s start with a helper method to do exactly that:</p><pre><code>public class ApiHelper : IApiHelper
{
    ...
    public async HttpContent GetAuthenticatedAsync(string requestUri)
    {
        var response = await ApiClient.GetAsync(requestUri);

        // Pseudo code:
        //
        // if (200): return response.Content
        // if (401): 
        //   refresh token
        //   try GetAsync again
        //   if (200): return response
        //   else: throw meaningful exception - something is wrong with our credentials
        // else: throw meaningful exception - unexpected return value
        ...
    }
}
</code></pre><p>Then I&#39;d use encapsulation to ensure that your business logic can&#39;t accidentally <em>bypass</em> your helper method: Make <code>ApiClient</code> private and add new low-level helper methods as needed.</p><p>You have now taken the first step to <em>abstract away</em> the transport mechanism. This improves readability of your business logic, since the code there can now concentrate on solving problems in your problem domain, rather than dealing with issues on the transport layer. If you always use the same deserialization logic, it might make sense to put that into ApiHelper as well (e.g. some <code>public async TResult GetAuthenticatedAsync&lt;TResult, TResultMessage&gt;(string requestUri)</code>).</p><p>It will also make unit testing easier: Authentication issues should be tested by testing <code>ApiHelper</code>, not by testing <code>MemberService</code>.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../c-shipping-the-first-class-library-any-gotchas-i-need-to-be-aware-of/'>C# &#8211; Shipping the first class library. Any gotchas I need to be aware of</a></li><li class="list-group-item"><a href='../handling-slow-external-apis-in-web-application/'>Handling Slow External API&#8217;s in Web Application</a></li><li class="list-group-item"><a href='../rest-specialized-api-endpoints-or-multiple-calls-to-generic-resources/'>Rest &#8211; Specialized API endpoints or multiple calls to generic resources</a></li><li class="list-group-item"><a href='../rest-api-initialize-method-post-or-get/'>Rest &#8211; API &#8220;initialize&#8221; method: POST or GET</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>