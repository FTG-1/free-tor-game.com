<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Techniques for efficiently partitioning data in a shared multi-tenant database &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1081329 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1081329" class="post-1081329 software type-software status-publish hentry category-software tag-database-design tag-multitenancy tag-web-applications"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Techniques for efficiently partitioning data in a shared multi-tenant database</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">database-design</span><span class="mr-2 badge badge-info">multitenancy</span><span class="mr-2 badge badge-warning">web-applications</span></p><div class="entry-content"><p>I work for a franchise and am beginning the complete redesign of the application that each franchise uses to manage its daily operations. It functions as a point of sale and scheduling application. Currently, each franchise has its own local SQL Express database. The desktop application runs in their facility and reads from and writes to this database. On the corporate end, we need to get at aggregate information about all of the franchises so each time the application saves a local record, it messages a copy to the corporate server which inserts the data from all franchises into a shared database with an identical schema. Corporate can then run reports on the shared database containing records from all franchises. Why is it designed like this? At the time of its design (over a decade ago), stakeholders felt it was important that franchises be able to access their data without an internet connection.</p><p>Well times have changed and all involved are finally willing to move to a single centralized database with a web app front end to support all franchises instead of a desktop app. So in technical terms, we are designing a multi-tenant app with a shared database. Like I said, we actually already have the database on the corporate end, but it&#39;s not supporting the moment-to-moment in-franchise reads and writes.</p><p>To give you an idea of the amount of data we&#39;re dealing with, there are currently a few hundred franchises, 3 million customer accounts of which a much smaller portion is actually active customers, and 8 million purchases. One of the largest tables contains weekly customer calendar entries and has over 91 million rows. Again, each of these records is specific to a single franchise but they will be stored together. E.G. tbl_Customers has 3 million customers and each has an fk_FranchiseID pointing back to tbl_Franchises.</p><p>The database will need to support the daily franchise operations (web app most likely using an Entity Framework-based data layer), reporting for both individual franchises and aggregate corporate reports, and some customer-facing website functions such as displaying schedules and customer account information. I think the aggregate reports, expense, and ease of adding new franchises are the factors driving the idea of a shared database. Additionally I think the plan is currently to have a load balancer with two web and two database servers.</p><p>With the caveat that there is a lot I still don&#39;t understand and am still learning about SQL Server, my biggest concerns are:</p><ul><li>Partitioning franchise data. The franchise web app will need to retrieve records only for its current user&#39;s franchise. In the current database, some tables are 5-10 joins away from tbl_franchise. Having to do all of these joins just to filter on the franchise ID when otherwise no joins might have been required seems like it could really harm performance. Queries need to run at least as fast as they do today against their local private databases so the filtering by franchise needs to be negligible. As wrong as it seems, would it be better to sacrifice normalization and include the franchise ID directly in some or all of these child tables? Or are the joins negligible if the keys are indexed and the query is not using any other columns from the joined tables?</li><li>Privacy. We need to make it impossible for a user or a developer to intentionally or accidentally pull up data that belongs to the wrong franchise. SQL Server 2016 row level security seems to be an option for this. This, again, leads me to point 1, though. A whole lot of joins will be required to associate the rows with their franchise record in the predicate function.</li><li>Lock contention. If we can use indexes to safely put sifting through other franchise&#39;s records aside, for the most part, the franchise management app should be doing short read and write operations. But still suddenly having all users potentially accessing these tables at the same time has alarm bells sounding in my mind. Additionally, we need to continue offering reporting to the franchises for their individual data, and to corporate for the aggregate data. A few of these reports are pretty computationally heavy and cannot necessarily accept dirty reads so I&#39;m worried if a report is running, we might have a few hundred franchises unable to use the system.</li></ul><p>So the overall question is: what strategies and techniques can be used to efficiently segregate tenant data in a shared database such as this?</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>The primary concerns of this design are security and size. But before I get there, I want to clear up a misunderstanding:</p><blockquote><p>As wrong as it seems, would it be better to sacrifice normalization and include the franchise ID directly in some or all of these child tables?</p></blockquote><p>I see why you might think this: if you consider franchise ID as an attribute then including it in every table violates third normal form.</p><p>But here&#39;s an alternative way to look at it: <em>in the logical design</em> the row key includes franchise ID: <code>(FRANCHISE_ID, TABLE_ID)</code>.</p><p>But, you say, <code>TABLE_ID</code> is an identity column! To which I answer: yes, but that&#39;s a <em>physical</em> detail, not a <em>logical</em> detail. And logically, tables are allowed to have multiple &#34;candidate&#34; keys (I turn to <a href="https://www.amazon.com/dp/" rel="noreferrer">C. J. Date</a> as my authority for this statement).</p><p>And once you accept this logical design, you&#39;ll get a lot of physical benefits. First, you don&#39;t need joins to access data; while, logically, joins take no time, physically they do. Plus, if your queries tend to retrieve multiple rows for the same franchise, you can also benefit by <a href="http://blog.kdgregory.com/2017/03/mysql-problem-with-synthetic-primary.html" rel="noreferrer">using a clustered index to collocate rows</a>.</p><p>OK, now on to the main topics.</p><h2>Security</h2><p>From a corporate management perspective, this is probably your most important issue. Clearly, you can&#39;t allow one franchisee to see data that belongs to another. But there are many ways to accomplish this, imposing different levels of load on the system <em>and its developers</em>. I&#39;m just going to throw out some ideas here for you to consider.</p><p><strong>Predicate applied to individual queries</strong></p><p>This is the simplest, but adds the heaviest load to the developers. Every one of your protected queries will have to include a check against franchise ID. Forgetting even one could have economic consequences for your company (ie, lawsuits).</p><p>However, I think you can probably overcome this with a combination of code review, static analysis, and integration testing. You need the discipline to ensure that all queries go through a data access layer that&#39;s rigorously verified.</p><p><strong>Views</strong></p><p>To ensure that all queries include a check for franchise ID, you can hide your tables behind views, and ensure that each view includes a franchise check. Each franchisee will have their own set of views, stored in a different schema.</p><p>An additional benefit of this approach is that you&#39;ll be able to expose data directly to the franchisees. It also allows your physical tables to change without affecting the exposed data.</p><p>However, there are several significant drawbacks. First, your developers will have to ensure that they use the correct set of views for each query (maybe not that bad, depending on how you manage connections). Second, you will have a long-term maintenance cost, as changes have to be propagated to all of schemas that hold a particular view (although this should be easily automatable).</p><p><strong>Row-level Security</strong></p><p>I&#39;m not familiar with SQL-Server, but my understanding of row-level security is that it&#39;s based on database users, so you&#39;ll need (at least) one user per franchisee. Which means that you&#39;ll need (at least) one connection per franchisee, which may cause undue load for your database (or alternatively, constant creation/destruction of connections). I&#39;m also guessing that your developers will have to code queries that include franchise conditions or suffer runtime errors. And you&#39;ll have to manage all of those users.</p><p>All-in-all, this seems like the most painful route, but it is the one that guarantees security, so I&#39;m guessing it&#39;s the way you&#39;ll go.</p><h2>Size</h2><p>From the development perspective this is going to be the bigger pain point -- especially when your users complain about slow response times.</p><p>Your overriding goal should be to touch as few data blocks as possible per query. Here are a few techniques that I&#39;ve used successfully in the past:</p><p><strong>Buy as much RAM as you can afford</strong></p><p>Your goal should be to keep the entire database in memory. Really. It doesn&#39;t matter that SSDs are blindingly fast, they still require time to read and write data blocks.</p><p>In a perfect world, you would read the entire database into memory at startup, and the only IO would be writes.</p><p><strong>Reduce the &#34;active&#34; size of tables</strong></p><p>You mentioned one 91MM row table. How much of this table is accessed for a particular query? Can you partition the table so that infrequently accessed data is stored in another table? (I&#39;m assuming that SQL-Server supports declarative partitioning, but if not you can manually move/duplicate rows).</p><p>Large tables necessarily mean that queries have to access a lot of rows. Even if you have indexes, because those indexes will also be large.</p><p><strong>Collocate data</strong></p><p>By default, databases store rows wherever they can find the space. Which means that data that is typically accessed together, such as the transactions for a user, might be spread all over the disk.</p><p>However, you generally have some level of control over this, either using clustered indexes (see my link above) or covering indexes. Leverage these to their fullest.</p><p><strong>Use read replicas</strong></p><p>A typical application executes selects far more frequently than updates, and tends to select multiple rows while updates affect a single row.</p><p>By separating these two operations, you get a couple of benefits. First, you can scale capacity independently: if you have a lot of reads you can buy more or bigger machines. And second, you can reduce contention: a long-running select won&#39;t block an update (personally, I think this is less of an issue today than, say, 20 years ago, but it&#39;s still worth considering).</p><p>The downside of read replicas is that there&#39;s a lag between the time a row is updated on the server and on the replica. This may or may not be a problem for you (and in my experience, lag is caused by undersized machines; more money solves that problem).</p><p><strong>Offload reporting to a data warehouse</strong></p><p>True &#34;reporting&#34; queries tend to be very different from operational queries. For example, an operational query might retrieve the most recent order for a single user, while a reporting query might find all users that bought a particular product. As a result, attempting to support both operational and reporting queries with the same physical design is a recipe for failure.</p><p>At the very least, shift reporting to a dedicated read replica, one that is indexed appropriately. Better is to make use of a completely different DBMS, one whose storage and query characteristics more closely match your reporting needs. Something like <a href="https://en.wikipedia.org/wiki/Amazon_Redshift" rel="noreferrer">Amazon Redshift</a>, <a href="https://en.wikipedia.org/wiki/BigQuery" rel="noreferrer">Google BigQuery</a>, or <a href="https://en.wikipedia.org/wiki/Azure_SQL_Data_Warehouse" rel="noreferrer">Azure SQL Data Warehouse</a>. Or maybe a locally-hosted option like <a href="https://en.wikipedia.org/wiki/Apache_Cassandra" rel="noreferrer">Apache Cassandra</a>.</p><h2>And now for something completely different</h2><p>Don&#39;t do this.</p><p>The time taken to develop a multi-tenant solution is time not available to add features that may be more relevant to your franchisees, or to improve the current code and processes.</p><p>If the issue is maintenance, or per-franchise capital expenses, look to alternatives that enable central management. For example, use Azure or another cloud provider with an ops person at the corporate office. You should be able to deploy a cloud-based solution for a per-franchise cost of a few hundred dollars per month (if that), cutting both capital and operational expenses for the franchisees.</p><p>If the issue is reporting, focus on more efficient data acquisition and transformation. Again, cloud-based solutions can help with this.</p><hr/><h2>Update</h2><p>The idea of moving to a cloud provider -- and Azure is only one option, which I picked because you seem to be a Microsoft shop -- is to eliminate the problems caused by franchisees who aren&#39;t trained computer operators.</p><p>In the simplest form, you would create a database server for each franchisee in the cloud, and their existing applications would point to that server rather than the local database. The database would always be up, so that you could retrieve data at any time. And, typically, the cloud provider does regular backups and provides other options for fault-tolerance and recovery.</p><p>Pricing in the cloud is largely dependent on the features that you want. For example, looking at the <a href="https://azure.microsoft.com/en-us/pricing/details/sql-database/" rel="noreferrer">Azure Cloud SQL pricing page</a>, the base price for a &#34;Standard&#34; database service is $0.0202/hour, or $15/month. I have no idea what this actually provides you in terms of database performance; in my experience, $100/month is more likely.</p><p>There is nothing that prevents you from using cloud hosting as a first step, and then moving on to a true multi-tenant solution. And if you have hundreds or thousands of franchisees, that makes sense to manage cost. But it seems like your real problem is one of operations management.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../in-multi-tenant-systems-what-is-the-correct-practice-for-segregating-each-tenants-data-from-each-other/'>In multi-tenant systems what is the correct practice for segregating each tenants data from each other</a></li><li class="list-group-item"><a href='../design-multi-tenant-database-design/'>Design &#8211; Multi-tenant database design</a></li><li class="list-group-item"><a href='../do-multi-tenant-dbs-have-multiple-databases-or-shared-tables/'>Do multi-tenant DBs have multiple databases or shared tables</a></li><li class="list-group-item"><a href='../how-to-handle-common-data-in-multi-tenant-applications/'>How to handle common data in multi-tenant applications</a></li><li class="list-group-item"><a href='../multi-tenant-in-a-micro-service/'>Multi tenant in a micro-service</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>