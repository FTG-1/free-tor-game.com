<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Python &#8211; How to perform consistent hashing on any Python object that works with hash() &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1083998 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1083998" class="post-1083998 software type-software status-publish hentry category-software tag-caching tag-hashing tag-python"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Python &#8211; How to perform consistent hashing on any Python object that works with hash()</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">caching</span><span class="mr-2 badge badge-info">hashing</span><span class="mr-2 badge badge-warning">python</span></p><div class="entry-content"><p>I have a Python library that performs a kind of calculation given a parameter-object. A requirement of the parameter object is that it be both hashable and serializable. It&#39;s a long calculation, so it memoizes itself. Let&#39;s say this is implemented something like this:</p><pre class="lang-py prettyprint-override"><code># Notes: params *must* be serializable and hashable;
#        equal params *always* produce equal results.
def long_calc(params):
   if params in long_calc._cache:
      return long_calc._cache[params]
   result = _long_calc_but_with_math(params)
   long_calc._cache[params] = result
   return result
long_calc._cache = {}
</code></pre><p>In particular, this calculation is really slow, so I would like to add an optional feature to the function such that, if you provide it with a cache location, it will check for a cache file and either load/return it instead of running the calculation or, if that file is not found, will calculate the result and save it before returning it. This would be something like this:</p><pre class="lang-py prettyprint-override"><code>def long_calc(params, cache=None):
   if params in long_calc._cache:
      return long_calc._cache[params]
   if cache is not None and os.path.isfile(cache):
      return _load_calc_result(cache)
   result = _long_calc_but_with_math(params)
   long_calc._cache[params] = result
   if cache is not None:
      _save_calc_result(cache, result)
   return result
long_calc._cache = {}
</code></pre><p>In typical use, this calculation will be run many times with many sets of parameters, and a given Python instance will likely examine many results. Accordingly, I would like to make this easier for the user and allow them to provide just a cache directory; the <code>long_calc</code> function would then be responsible for ensuring that its contents represented a correct/unique hashing of the cached data. My first idea for how to do this was to use the parameter-hashes as directory names; each directory represented a set of parameter values, all of which have the same hash and thus all collide in this schema. The parameters themselves would be serialized out to a file <code>key-001.pickle</code> and the result to <code>val-001.pickle</code> so that exact parameters could be checked and collisions resolved. I realize this is slow, but the calculations are plenty long enough to justify the wait. For context, this is scientific software, so security is not really a concern, but reproducibility is. I wrote this approach up something like this:</p><pre class="lang-py prettyprint-override"><code>def long_calc(params, cache=None):
   if params in long_calc._cache:
      return long_calc._cache[params]
   if cache is not None:
      cache = _cache_filename(params, cache)
      if os.path.isfile(cache):
         return _load_calc_result(cache)
   result = _long_calc_but_with_math(params)
   long_calc._cache[params] = result
   if cache is not None:
      _save_calc_result(cache, result)
   return result
long_calc._cache = {}

def _cache_filename(params, cache_dir):
   # Get a hash for the params:
   h = hash(params)
   # Turn it into a directory name
   hstr = (&#39;p&#39; if h &gt; 0 else &#39;n&#39;) + str(abs(h))
   hdir = os.path.join(cache_dir, hstr)
   # make it if it doesn&#39;t exist
   os.makedirs(hdir, mode=0o755)
   # look for a key that either matches or is not yet filled
   k = 0
   while True:
      # get the keyfile&#39;s name
      kfilename = os.path.join(hdir, &#39;key_%d.pkl&#39; % k)
      if not os.path.isfile(kfilename):
         # Claim this spot
         _save_params(kfilename, params)
         break
      v = _load_params(kfilename)
      if params == v:
         break
      k = k + 1
   # return the value file that matches the key file 
   return os.path.join(hdir, &#39;val_%d.pkl&#39; % k)
</code></pre><p>For the record I know there&#39;s a race condition here and am not worried about it.</p><p>This approach worked just fine and tested just fine&#8230; until I restarted my python instance. It ends up that <a href="https://stackoverflow.com/questions/27522626/hash-function-in-python-3-3-returns-different-results-between-sessions">python&#39;s hash function is intentionally salted</a> as a security measure, so the line <code>h = hash(params)</code> isn&#39;t finding a <em>consistent</em> hash, which is what I need. This puts me in a bit of a bind because previous versions of the software have already established the norm that the params need to be <em>hashable</em> (i.e. via the <code>hash()</code> function) to be valid. Changing this requirement to instead be that the params object must be hashable by some other library&#39;s schema will break code unless the other library has a drop-in replacement for <code>hash()</code>.</p><p><strong>TLDR; Question 1:</strong> Is there a drop-in replacement for <code>hash(x)</code> that yields a <em>consistent</em> hash of <code>x</code> for any (or almost any) <code>x</code> normally hashable by <code>hash(x)</code>? Note that I&#39;m willing to sacrifice a few unusual edge cases regarding the type of <code>x</code> if there&#39;s a drop-in for this that is pretty close.</p><p>Other answers about this kind of question have pointed at <a href="https://docs.python.org/3/library/hashlib.html" rel="noreferrer">hashlib</a>, but it looks to me like with this library where I would need to convert objects like <code>frozenset</code>s to a unique string of bytes for hashing, which means it doesn&#39;t have a clear replacement for <code>hash()</code>. (I can&#39;t guarantee that equal parameter objects will have identical serialization strings, only that, once deserialized, the objects will again be equal).</p><p><strong>TLDR; Question 2:</strong> Is there an easy way to make an object that is hashable (via <code>hash()</code>) and serializable (into a byte-string that can be different from that of another equal object) work with existing hash-libraries like <code>hashlib</code>?</p><p>A bit of research shows that you can pass <code>Python</code> the environment variable <a href="https://docs.python.org/3.3/using/cmdline.html#envvar-PYTHONHASHSEED" rel="noreferrer"><code>PYTHONHASHSEED=0</code></a> to disable salting. This is basically what I want, but for various reasons I don&#39;t think it&#39;s a good idea to force/require my users to do this themselves, and, as far as I can tell, you can&#39;t update the hash-seed during a python process. This has led me to the uncomfortable conclusion that the best way to get at this problem is possibly to fork/exec and have the child-process manage the calculation/caching of the result with an updated seed. I think that this is a pretty bad solution, and it&#39;s hard for me to imagine that there would be a consistent hash algorithm deep in python that just can&#39;t be accessed in any other way than this one.</p><p><strong>TLDR; Question 3:</strong> Is there a way to temporarily disable the python hash salting aside from starting a new python process?</p><p>One last piece of context is that it&#39;s okay if a cache directory for one node/OS/python-version isn&#39;t compatible with that of another. But if I have a local cache on my local machine that is being updated within the same context, it should all work correctly. (Also it would be even better if the cache were consistent across all these things! it&#39;s just not required of a solution.)</p><p>Any other solutions that fall within the constraints I&#39;ve laid out would also be very welcome! Thanks in advance.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>Change your cache file so that it doesn’t map hash code to result of calculation, but parameters to result of calculation.</p><p>Since the calculation takes very long, having to match the parameters shouldn’t be a big deal, even though it is somehow inefficient. And of course you _can_calculate hash codes for parameters that you compared in memory.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../what-data-structure-should-i-use-for-this-caching-strategy/'>What data structure should I use for this caching strategy</a></li><li class="list-group-item"><a href='../python-caching-factory-design/'>Python &#8211; Caching factory design</a></li><li class="list-group-item"><a href='../python-how-should-you-cleanly-restrict-object-property-types-and-values-in-python/'>Python &#8211; How should you cleanly restrict object property types and values in Python</a></li><li class="list-group-item"><a href='../use-a-timestamp-parameter-for-cache-invalidation/'>Use a timestamp parameter for cache invalidation</a></li><li class="list-group-item"><a href='../rest-why-would-a-rest-api-demand-a-hash-of-the-parameters/'>Rest &#8211; Why would a Rest Api demand a hash of the parameters</a></li><li class="list-group-item"><a href='../python-using-null-none-nil-vs-empty-data-types/'>Python &#8211; Using Null/None/Nil vs empty data types</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>