<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>How to deal with side effects in Event Sourcing &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1073860 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1073860" class="post-1073860 software type-software status-publish hentry category-software tag-cqrs tag-event-programming tag-event-sourcing"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">How to deal with side effects in Event Sourcing</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">cqrs</span><span class="mr-2 badge badge-info">event-programming</span><span class="mr-2 badge badge-warning">event-sourcing</span></p><div class="entry-content"><p>Let&#39;s assume that we want to implement a small security subsystem for a financial application that warns the users via email if a strange pattern is detected. For this example, the pattern will consist in three transactions as the ones depicted. The security subsystem can read events from the main system from a queue.</p><p>What I would like to get is an alert that is a direct consequence of the events that happen in the system, without an intermediate representation that models the current state of the pattern.</p><ol><li>Monitoring activated</li><li>Transaction processed</li><li>Transaction processed</li><li>Transaction processed</li><li><strong>Alert triggered</strong> (id: 123)</li><li><strong>Email for alert sent</strong> (for id: 123)</li><li>Transaction processed</li></ol><p>Having this in mind, I thought event sourcing could apply here very well, although I have a question without a clear answer. The alert triggered in the example has a clear side effect, an email needs to be sent, a circumstance that should only happen once. Therefore, it shouldn&#39;t happen when replaying all the events of an aggregate.</p><p>To some extent, I see the email that needs to be sent similar to the materializations generated by the query side that I have seen so many times in the CQRS/Event sourcing literature, with a not so subtle difference though.</p><p>In this literature, the query side is built from event handlers that can generate a materialization of the state at a given point reading again all the events. In this case, though, that can&#39;t be accomplished exactly like that for the reasons explained before. <strong>The idea that every state is transient does not apply so well here</strong>. We need to record the fact that an alert was sent somewhere.</p><p>An easy solution for me would be having a different table or structure where you keep records of the alerts that were previously triggered. As we have an ID, we would be able to check if an alert with the same ID was issued before. Having this information would make the SendAlertCommand idempotent. Several commands can be issued, but the side effect will only happen once.</p><p>Even having that solution in mind, I don&#39;t know if this is a hint that there is something wrong with this architecture for this problem.</p><ul><li>Is my approach correct?</li><li>Is there any place where I can find more information about this?</li></ul><p>It is strange that I haven&#39;t been able to find more information about this. Maybe I have been using the wrong wording.</p><p>Thank you so much!</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><blockquote><p>How do I deal with side effects in Event Sourcing?</p></blockquote><p>Short version: the domain model doesn&#39;t perform side effects.  It <em>tracks</em> them.  Side effects are performed using a port that connects to the boundary; when the email is sent, you send the acknowledgement back to the domain model.</p><p>This means that the email is sent <em>outside of</em> the transaction that updates the
event stream.</p><p>Precisely where, outside, is a matter of taste.</p><p>So conceptually, you have a stream of events like</p><pre><code>EmailPrepared(id:123)
EmailPrepared(id:456)
EmailPrepared(id:789)
EmailDelivered(id:456)
EmailDelivered(id:789)
</code></pre><p>And from this stream you can create a fold</p><pre><code>{
    deliveredMail : [ 456, 789 ],
    undeliveredMail : [123]
}
</code></pre><p>The fold tells you which emails haven&#39;t been acknowledged, so you send them again:</p><pre><code>undeliveredMail.each ( mail -&gt; {
    send(mail);
    dispatch( new EmailDelivered.from(mail) );
}     
</code></pre><p>Effectively, this is a two phase commit: you are modifying SMTP in the real world, and then you are updating the model.</p><p>The pattern above gives you an at-least-once delivery model.  If you want at-most-once, you can turn it around</p><pre><code>undeliveredMail.each ( mail -&gt; {
    commit( new EmailDelivered.from(mail) );
    send(mail);
}     
</code></pre><p>There&#39;s a transaction barrier between making EmailPrepared durable and actually sending the email.  There&#39;s also a transaction barrier between sending the email and making EmailDelivered durable.</p><p>Udi Dahan&#39;s <a href="https://vimeo.com/111998645" rel="noreferrer">Reliable Messaging with Distributed Transactions</a> may be a good starting point.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../at-what-granularity-are-events-recorded-in-event-sourcing/'>At what granularity are events recorded in Event Sourcing</a></li><li class="list-group-item"><a href='../persistence-models-for-event-sourcing/'>Persistence models for Event Sourcing</a></li><li class="list-group-item"><a href='../is-there-something-dirty-about-using-a-non-linear-store-in-event-sourcing/'>Is there something &#8220;dirty&#8221; about using a non-linear store in Event Sourcing</a></li><li class="list-group-item"><a href='../cqrs-event-sourcing-and-near-real-time-reporting/'>CQRS, Event Sourcing and (near) Real Time Reporting</a></li><li class="list-group-item"><a href='../event-sourcing-and-sync-between-write-and-read-model/'>Event sourcing and sync between write and read model</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>