<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="https://free-tor-game.com/wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Design &#8211; Entities vs. Services in domain driven design (DDD) &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.min.js?ver=11.2.0' id='highlight-js'></script>     <script>( function( w, d, s, l, i ) {
				w[l] = w[l] || [];
				w[l].push( {'gtm.start': new Date().getTime(), event: 'gtm.js'} );
				var f = d.getElementsByTagName( s )[0],
					j = d.createElement( s ), dl = l != 'dataLayer' ? '&l=' + l : '';
				j.async = true;
				j.src = 'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
				f.parentNode.insertBefore( j, f );
			} )( window, document, 'script', 'dataLayer', ' ' );</script>      <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1087422 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="https://free-tor-game.com/3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="https://free-tor-game.com/contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1087422" class="post-1087422 software type-software status-publish hentry category-software tag-design tag-domain-driven-design tag-object-oriented-design"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Design &#8211; Entities vs. Services in domain driven design (DDD)</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">design</span><span class="mr-2 badge badge-info">domain-driven-design</span><span class="mr-2 badge badge-warning">object-oriented-design</span></p><div class="entry-content"><p>I wanted to get some feedback on the design of a chat application I recently developed. The application is written in PHP, but the language probably isn&#39;t important here.</p><p>The main components are <code>User</code>, <code>Conversation</code>, and <code>Message</code>:</p><pre class="lang-php prettyprint-override"><code>class User {
    public function getId(): int {}
    public function getUsername(): string {}
    public function getFirstName(): string {}
    public function getLastName(): string {}

    // token used with a 3rd party API for sending messages
    public function getToken(): ?string;
    
    // if a user doesn&#39;t have a token they can&#39;t be messaged
    public function isOnline(): bool {}

    public function __construct(int $id, string $username, ...) {}
}

class Conversation {
    public function getId(): int {}
    public function getUsers(): User[] {}

    public function __construct(int $id, array $users) {}
}

class Message {
    public function getId(): int {}
    public function getText(): string {}
    public function getConversation(): Conversation {}
    public function getAuthor(): User {}

    public function __construct(int $id, string $text, Conversation $conversation) {}
}
</code></pre><p>I also have some services:</p><pre class="lang-php prettyprint-override"><code>class MessageSender implements MessageSenderInterface
{
    private LoggerInterface $logger;

    public function send(Message $message): void {
        foreach ($message-&gt;getConversation()-&gt;getUsers() as $user) {
            if (!$user-&gt;isOnline()) {
                $this-&gt;logger-&gt;warn(&#39;User is offline and cannot be messaged&#39;);
            }

            if ($user-&gt;equals($message-&gt;getAuthor())) {
                // continue; don&#39;t send messages to authors
            }
            
            $messageData = [
                &#39;to&#39; =&gt; $user-&gt;getToken(),
                &#39;from&#39; =&gt; $message-&gt;getAuthor()-&gt;getUsername(),
                &#39;text&#39; =&gt; $message-&gt;getText(),
            ];
            // send the message through some external API
        }
    }
}
</code></pre><p>Most of the work is done through the <code>MessageSender</code>, but I&#39;m wondering if the domain might be better encapsulated with something like this:</p><pre class="lang-php prettyprint-override"><code>class Message {
    public function getId(): int {}
    public function getText(): string {}

    public function __construct(int $id, string $text, Conversation $conversation) {}

    public function send(MessageSenderInterface $sender, LoggerInterface $logger) {
        ... send logic in here
    }
}

</code></pre><p>You can see that by moving the <code>send</code> functionality inside of the <code>Message</code> object we totally get rid of two exposed properties (<code>getConversation</code> and <code>getAuthor</code> are gone) and could effectively remove the service altogether. But as a result, the message object now knows about loggers and message senders, even if they are just interfaces.</p><p>What does DDD say about this? I tend to prefer exposing less data and like the encapsulation the second option provides.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>Some DDD practitioners suggest that it is ok to inject technology layers dynamically into your domain model. Modeled that way, your domain code will not be directly dependent on technology components and only talk through abstract interfaces.</p><p>But I would suggest that you keep only the domain related code in the domain model layer and organize all technology interactions (DB, Message Brokers, Loggers) in your service layer. These are typically Application Services and Command Handlers in the DDD/CQRS lingo.</p><p>Here are some reasons why placing code that interacts with technology components in the domain model is probably a bad practice:</p><ol><li>You use DDD to reduce complexity, but injecting technology aspects into your domain model will obscure your vision of real business logic. It will get lost in translation when most of your code handles technology concerns like loading and persisting data or sending messages.</li><li>Your domain model ends up having some knowledge about workflows in your technology components. It knows when to persist data, how to persist data, and when to send messages, among other stuff.</li><li>You will need a different layer anyway to perform validations spanning the aggregate collection (checking for uniqueness of email address, for example).</li><li>Your domain cannot be tested in isolation. You are always organizing technology components (or mocks) when you test domain logic.</li></ol><p>Mapping this thought process to your example, the logic to decide whether to send the message would be in the domain layer. The code to format the event data and dispatch to the message broker would be in the service layer.</p><p>On a separate note, one wouldn&#39;t organize these three components (User, Conversation, and Message) in this way in a DDD application. You would think about transaction boundaries and create <code>aggregates</code> around data objects.</p><p>A <code>User</code> would be an aggregate, with its own enclosed objects and behavior. A <code>Conversation</code> would be another aggregate and enclose <code>Message</code> objects within it, and all message related interactions would be via the Conversation aggregate.</p><p>Because they are separate aggregates, you would not embed <code>User</code> objects into a <code>Conversation</code> aggregate. You would only have references (user identifiers). You would have a read model that tracks which users are online in a Conversation and use it to dispatch messages.</p><p>I suggest you go through the <a href="https://eventsourcery.com/" rel="nofollow noreferrer">EventSourcery</a> course for a good understanding of these concepts. The code for the course is actually in PHP.</p><hr/><p>Update 1:</p><p>Your <code>Message</code> object is reaching back to the <code>Conversation</code> object to gather users to do its work, so it makes sense to enclose it within the <code>Conversation</code> object.</p><p>I will talk about two concepts that may not be part of your architecture right now but would help: <strong>Application Services</strong> and <strong>Domain Events</strong>.</p><p>You would introduce an intermediate &#34;Application Service&#34; layer between your controller and the Domain Layer.</p><p>The App Service will be responsible for invoking the (injected) infrastructure services, calling the domain layer, and persisting/loading necessary data. The Controller&#39;s responsibility is only to gather the request params (gather user input in your case), ensure authentication (if needed), and then make the call to the Application Service method.</p><p>Application Services are the direct clients of the domain model and act as intermediaries to coordinate between the external world and the domain layer. They are responsible for handling infrastructure concerns like ID Generation, Transaction Management, Encryption, etc. Such responsibilities are not concerns of the Controller layer either.</p><p>Let&#39;s assume <code>MessageSender</code> is transformed into an Application Service. Here is an example control flow:</p><ol><li>API sends the request with <code>conversation_id</code>, <code>user_id</code> (author), and <code>message</code>.</li><li>Application Service loads <code>Conversation</code> from the database. If the Conversation ID is valid, and the author can participate in this conversation (these are invariants), you invoke a <code>send</code> method on the <code>Conversation</code> object.</li><li>The Conversation object adds the message to its own data, runs its business logic, and decides which users to send the message.</li><li>The Conversation object raises <code>events</code>, to be dispatched into a message interface (these are collected in a temporary variable valid for that session) and returns. These events contain the entire data to reconstruct details of the message (timestamps, audit log, etc.), and don&#39;t just cater to what is pushed out to the receiver later.</li><li>The Application Service persists the updated Conversation object and dispatches all events raised during the recent processing.</li><li>A subscriber listening for the event gathers it, constructs the message in the right format (picking only the data it needs from the event), and performs the actual push to the receiver.</li></ol><p>With this structure, you have a good implementation of the Open-Closed Principle.</p><ol><li>Your Conversation object changes only if you are changing business logic (like who should receive the message).</li><li>Your Application service will seldom change because it simply loads and persists Conversation objects and publishes any raised events to the message broker.</li><li>Your Subscriber logic changes only if you are pushing additional data to the receiver.</li></ol><hr/><p>Update 2: Pseudocode</p><p>Application Service:</p><pre class="lang-py prettyprint-override"><code>class MessageSender(ApplicationService):
    def send_message(request):
        // Deconstruct request object and call method
        conversation = ConversationRepo.find_by_id(request.id)

        // Call a method on the aggregate that generates events and updates the aggregates state
        conversation.send_message(request.from_user_id, request.content)

        // Application Service saves the aggregate
        ConversationRepo.save(conversation)

        // Any events raised are dispatched once the conversation has been successfully saved
        for event in conversation.events:
            message_interface.dispatch(event)
        
</code></pre><p>Domain Model:</p><pre class="lang-py prettyprint-override"><code>class User(Aggregate):
    id: int
    username: str
    first_name: str
    last_name: str

    token: str
    is_online: bool

class Message(Entity):
    id: int
    author_id: int
    content: str
    sent_at: time

class Conversation(Aggregate):
    id: int
    users: list
    messages = list

    events = list // not persisted

    def send_message(from_user_id, content):
        for user in self.users:
            if not user.is_online:
                logger.warn(&#34;User is offline and cannot be messaged&#34;)
            
            if user.id == from_user_id:
                // continue; do not send messages to authors

            messages.append(Message(author_id=from_user_id, content=content, sent_at=datetime.utcnow()))
            self.events.add(SendMessageEvent(to=user.token, from=user.username, text=content))
</code></pre></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='https://free-tor-game.com/software/c-domain-driven-design-and-wcf-services-architecture/'>C# &#8211; Domain driven design and WCF services architecture</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/using-external-services-in-domain-driven-design/'>Using external services in domain driven design</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/domain-vs-entities-model-domain-driven-design-ddd/'>Domain vs Entities model? Domain-Driven-Design (DDD)</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='http://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="https://free-tor-game.com/wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>