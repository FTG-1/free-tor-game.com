<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>The &#8220;Free Monad + Interpreter&#8221; pattern &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1064870 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1064870" class="post-1064870 software type-software status-publish hentry category-software tag-design-patterns tag-dsl tag-functional-programming tag-haskell tag-monad"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">The &#8220;Free Monad + Interpreter&#8221; pattern</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">design-patterns</span><span class="mr-2 badge badge-info">dsl</span><span class="mr-2 badge badge-warning">functional programming</span><span class="mr-2 badge badge-primary">haskell</span><span class="mr-2 badge badge-danger">monad</span></p><div class="entry-content"><p>I&#39;ve seen people talking about <em>Free Monad with Interpreter</em>, particularly in the context of data-access. What is this pattern? When might I want to use it? How does it work, and how would I implement it?</p><p>I understand (from posts such as <a href="https://stackoverflow.com/questions/23766419/when-would-i-want-to-use-a-free-monad-interpreter-pattern">this</a>) that it&#39;s about separating model from data-access. How does it differ from the well-known Repository pattern? They appear to have the same motivation.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>The actual pattern is actually significantly more general than just data access. It&#39;s a lightweight way of creating a domain-specific language that gives you an AST, and then having one or more interpreters to &#34;execute&#34; the AST however you like.</p><p>The free monad part is just a handy way to get an AST that you can assemble using Haskell&#39;s standard monad facilities (like do-notation) without having to write lots of custom code. This also ensures that your DSL is <em>composable</em>: you can define it in parts and then put the parts together in a structured way, letting you take advantage of Haskell&#39;s normal abstractions like functions.</p><p>Using a free monad gives you the <em>structure</em> of a composable DSL; all you have to do is specify the pieces. You just write a data type that encompasses all of the actions in your DSL. These actions could be doing anything, not just data access. However, if you specified all your data accesses as actions, you would get an AST that specifies all the queries and commands to the data store. You could then interpret this however you like: run it against a live database, run it against a mock, just log the commands for debugging or even try optimizing the queries.</p><p>Lets look at a very simple example for, say, a key value store. For now, we&#39;ll just treat both keys and values as strings, but you could add types with a bit of effort.</p><pre><code>data DSL next = Get String (String -&gt; next)
              | Set String String next
              | End
</code></pre><p>The <code>next</code> parameter lets us combine actions. We can use this to write a program that gets &#34;foo&#34; and sets &#34;bar&#34; with that value:</p><pre><code>p1 = Get &#34;foo&#34; $ \ foo -&gt; Set &#34;bar&#34; foo End
</code></pre><p>Unfortunately, this is not enough for a meaningful DSL. Since we used <code>next</code> for composition, the type of <code>p1</code> is the same length as our program (ie 3 commands):</p><pre><code>p1 :: DSL (DSL (DSL next))
</code></pre><p>In this particular example, using <code>next</code> like this seems a little odd, but it&#39;s important if we want our actions to have different type variables. We might want a typed <code>get</code> and <code>set</code>, for example.</p><p>Note how the <code>next</code> field is different for each action. This hints that we can use it to make <code>DSL</code> a functor:</p><pre><code>instance Functor DSL where
  fmap f (Get name k)          = Get name (f . k)
  fmap f (Set name value next) = Set name value (f next)
  fmap f End                   = End
</code></pre><p>In fact, this is the <em>only</em> valid way to make it a Functor, so we can use <code>deriving</code> to create the instance automatically by enabling the <code>DeriveFunctor</code> extension.</p><p>The next step is the <code>Free</code> type itself. That&#39;s what we use to represent our AST <em>structure</em>, build on top of the <code>DSL</code> type. You can think of it like a list at the <em>type</em> level, where &#34;cons&#34; is just nesting a functor like <code>DSL</code>:</p><pre><code>-- compare the two types:
data Free f a = Free (f (Free f a)) | Return a
data List a   = Cons a (List a)     | Nil
</code></pre><p>So we can use <code>Free DSL next</code> to give programs of different sizes the same types:</p><pre><code>p2 = Free (Get &#34;foo&#34; $ \ foo -&gt; Free (Set &#34;bar&#34; foo (Free End)))
</code></pre><p>Which has the much nicer type:</p><pre><code>p2 :: Free DSL a
</code></pre><p>However, the actual expression with all of its constructors is still very awkward to use! This is where the monad part comes in. As the name &#34;free monad&#34; implies, <code>Free</code> is a monadâ€”as long as <code>f</code> (in this case <code>DSL</code>) is a functor:</p><pre><code>instance Functor f =&gt; Monad (Free f) where
  return         = Return
  Free a &gt;&gt;= f   = Free (fmap (&gt;&gt;= f) a)
  Return a &gt;&gt;= f = f a
</code></pre><p>Now we&#39;re getting somewhere: we can use <code>do</code> notation to make our DSL expressions nicer. The only question is what to put in for <code>next</code>? Well, the idea is to use the <code>Free</code> structure for composition, so we will just put <code>Return</code> for each next field and let the do-notation do all the plumbing:</p><pre><code>p3 = do foo &lt;- Free (Get &#34;foo&#34; Return)
        Free (Set &#34;bar&#34; foo (Return ()))
        Free End
</code></pre><p>This is better, but it&#39;s still a bit awkward. We have <code>Free</code> and <code>Return</code> all over the place. Happily, there&#39;s a pattern we can exploit: the way we &#34;lift&#34; a DSL action into <code>Free</code> is always the sameâ€”we wrap it in <code>Free</code> and apply <code>Return</code> for <code>next</code>:</p><pre><code>liftFree :: Functor f =&gt; f a -&gt; Free f a
liftFree action = Free (fmap Return action)
</code></pre><p>Now, using this, we can write nice versions of each of our commands and have a full DSL:</p><pre><code>get key       = liftFree (Get key id)
set key value = liftFree (Set key value ())
end           = liftFree End
</code></pre><p>Using this, here&#39;s how we can write our program:</p><pre><code>p4 :: Free DSL a
p4 = do foo &lt;- get &#34;foo&#34;
        set &#34;bar&#34; foo
        end
</code></pre><p>The neat trick is that while <code>p4</code> looks just like a little imperative program, it&#39;s actually an expression that has the value</p><pre><code>Free (Get &#34;foo&#34; $ \ foo -&gt; Free (Set &#34;bar&#34; foo (Free End)))
</code></pre><p>So, the free monad part of the pattern has gotten us a DSL that produces syntax trees with nice syntax. We can also write composable sub-trees by not using <code>End</code>; for example, we could have <code>follow</code> which takes a key, gets its value and then uses that as a key itself:</p><pre><code>follow :: String -&gt; Free DSL String
follow key = do key&#39; &lt;- get key
                get key&#39;
</code></pre><p>Now <code>follow</code> can be used in our programs just like <code>get</code> or <code>set</code>:</p><pre><code>p5 = do foo &lt;- follow &#34;foo&#34;
        set &#34;bar&#34; foo
        end
</code></pre><p>So we get some nice composition and abstraction for our DSL as well.</p><p>Now that we have a tree, we get to the second half of the pattern: the interpreter. We can interpret the tree however we like just by pattern-matching on it. This would let us write code against a real data store in <code>IO</code>, as well as other things. Here&#39;s an example against a hypothetical data store:</p><pre><code>runIO :: Free DSL a -&gt; IO ()
runIO (Free (Get key k)) =
  do res &lt;- getKey key
     runIO $ k res
runIO (Free (Set key value next)) =
  do setKey key value
     runIO next
runIO (Free End) = close
runIO (Return _) = return ()
</code></pre><p>This will happily evaluate any <code>DSL</code> fragment, even one that isn&#39;t ended with <code>end</code>. Happily, we can make a &#34;safe&#34; version of the function that only accepts programs closed with <code>end</code> by setting the input type signature to <code>(forall a. Free DSL a) -&gt; IO ()</code>. While the old signature accepts a <code>Free DSL a</code> for <em>any</em> <code>a</code> (like <code>Free DSL String</code>, <code>Free DSL Int</code> and so on), this version only accepts a <code>Free DSL a</code> that works for <em>every</em> possible <code>a</code>â€”which we can only create with <code>end</code>. This guarantees we won&#39;t forget to close the connection when we&#39;re done.</p><pre><code>safeRunIO :: (forall a. Free DSL a) -&gt; IO ()
safeRunIO = runIO
</code></pre><p>(We can&#39;t just start by giving <code>runIO</code> this type because it won&#39;t work properly for our recursive call. However, we could move the definition of <code>runIO</code> into a <code>where</code> block in <code>safeRunIO</code> and get the same effect without exposing both versions of the function.)</p><p>Running our code in <code>IO</code> is not the only thing we could do. For testing, we might want to run it against a pure <code>State Map</code> instead. Writing out that code is a good exercise.</p><p>So this is the free monad + interpreter pattern. We make a DSL, taking advantage of the free monad structure to do all the plumbing. We can use do-notation and the standard monad functions with our DSL. Then, to actually use it, we have to interpret it somehow; since the tree is ultimately just a data structure, we can interpret it however we like for different purposes.</p><p>When we use this to manage accesses to an external data store, it is indeed similar to the Repository pattern. It intermediates between our data store and our code, separating the two out. In some ways, though, it&#39;s more specific: the &#34;repository&#34; is always a DSL with an explicit AST which we can then use however we like.</p><p>However, the pattern itself is more general than that. It can be used for lots of things which do not necessarily involve external databases or storage. It makes sense wherever you want fine control of effects or multiple targets for a DSL.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../how-should-i-implement-the-repository-pattern-for-complex-object-models/'>How should I implement the repository pattern for complex object models</a></li><li class="list-group-item"><a href='../javascript-when-does-a-monad-become-a-hammer/'>Javascript &#8211; When does a Monad become a hammer</a></li><li class="list-group-item"><a href='../are-the-repository-pattern-and-active-record-pattern-compatible/'>Are the Repository Pattern and Active Record pattern compatible</a></li><li class="list-group-item"><a href='../a-comonad-and-how-are-they-useful/'>A Comonad and how are they useful</a></li><li class="list-group-item"><a href='../c-i-have-a-few-questions-about-the-mvp-pattern-in-a-winforms-project/'>C# &#8211; I have a few questions about the MVP pattern in a WinForms project</a></li><li class="list-group-item"><a href='../c-repository-pattern-and-database-queries/'>C# &#8211; Repository Pattern and database queries</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>