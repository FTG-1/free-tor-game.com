<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>C++ &#8211; AST processing and usefulness of visitor pattern &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1072335 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1072335" class="post-1072335 software type-software status-publish hentry category-software tag-c tag-compiler tag-design-patterns tag-visitor-pattern"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">C++ &#8211; AST processing and usefulness of visitor pattern</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">c</span><span class="mr-2 badge badge-info">compiler</span><span class="mr-2 badge badge-warning">design-patterns</span><span class="mr-2 badge badge-primary">visitor-pattern</span></p><div class="entry-content"><p>I know the visitor pattern is typically used to traverse a hierarchy of heterogeneous objects (inheriting a same abstract object) and dissociate the processing of these objects from the data within them. A classic use of the visitor pattern (often quoted), is the processing of an abstract syntax tree in a compiler. Indeed, the structure of the tree is only known at runtime (once the program is parsed), and one want to traverse the tree modifying the nodes according to semantic passes implemented as visitor. But the visitor pattern looked like an overkill to me since it allow a double (dynamic) dispatch as a function of the ASTNode type and the Visitor type, or one statically know the order of the visitor we will use to process the AST during the semantic phase. If I had to code this in C++ (done on the spot without compiling), I would do :</p><pre><code>struct AstNode
{
    //virtual void accept() = 0; //this won&#39;t work since template does not override virtual pure method
    virtual ~AstNode();
};

struct SpecificNode : public AstNode
{
    template &lt;class Visitor&gt;
    void accept(Visitor v)
    {
        v.visit(*this);
    }
};

//other AST nodes

class MyVisitor
{
    void visit(SpecificNode n) {/*...*/}

    //other visit methods for other AST nodes
};

//other visitors
</code></pre><p>There is no double dispatch here, that is not a true visitor. But I can figure out why I would need this double dispatch.</p><p>Notes :</p><p>This wikipedia pages list other uses of double dispatch but not AST : <a href="http://en.wikipedia.org/wiki/Double_dispatch#Examples" rel="noreferrer">http://en.wikipedia.org/wiki/Double_dispatch#Examples</a>.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>One thing the Visitor Pattern does that is often not talked about, is enabling to choose which side of the Expression Problem you want to tackle.</p><p>So, what is the Expression Problem? It refers to the basic problem of extensibility: our programs manipulate data types using operations. As our programs evolve, we need to extend them with new data types and new operations. And particularly, we want to be able to add new operations which work with the existing data types, and we want to add new data types which work with the existing operations. <em>And</em> we want this to be true <em>extension</em>, i.e. we don&#39;t want to modify the <em>existing</em> program, we want to respect the existing abstractions, we want our extensions to be separate modules, in separate namespaces, separately compiled, separately deployed, separately type checked. We want them to be type-safe.</p><p>The Expression Problem is, how do you actually provide such extensibility in a language?</p><p>It turns out that for typical naive implementations of procedural and/or functional programming, it is very easy to add new operations (procedures, functions), but very hard to add new data types, since basically the operations work with the data types using some sort of case discrimination (<code>switch</code>, <code>case</code>, pattern matching) and you need to add new cases to them, i.e. modify existing code:</p><pre><code>func print(node):
  case node of:
    AddOperator =&gt; print(node.left) + &#39;+&#39; + print(node.right)
    NotOperator =&gt; &#39;!&#39; + print(node)

func eval(node):
  case node of:
    AddOperator =&gt; eval(node.left) + eval(node.right)
    NotOperator =&gt; !eval(node)
</code></pre><p>Now, if you want to add a new operation, say, type-checking, that&#39;s easy, but if you want to add a new node type, you have to modify all the existing pattern matching expressions in all operations.</p><p>And for typical naive OO, you have the exact opposite problem: it is easy to add new data types which work with the existing operations (either by inheriting or overriding them), but it is hard to add new operations, since that basically means modifying existing classes/objects.</p><pre><code>class AddOperator(left: Node, right: Node) &lt; Node:
  meth print:
    left.print + &#39;+&#39; + right.print

  meth eval
    left.eval + right.eval

class NotOperator(expr: Node) &lt; Node:
  meth print:
    &#39;!&#39; + expr.print

  meth eval
    !expr.eval
</code></pre><p>Here, adding a new node type is easy, because you either inherit, override or implement all required operations, but adding a new operation is hard, because you need to add it either to all leaf classes or to a base class, thus modifying existing code.</p><p>Several languages have several constructs for solving the Expression Problem: Haskell has typeclasses, Scala has implicit arguments, Racket has Units, Go has Interfaces, CLOS and Clojure have Multimethods.</p><p>However, in an OO language that <em>doesn&#39;t</em> have a way of solving the Expression Problem (such as Java or C#), the Visitor Pattern at least allows you to &#34;pick your poison&#34;. What the pattern does, is turn your design 90Â° to the side: the <em>operations</em> become <em>classes</em> (<code>PrintVisitor</code>, <code>EvalVisitor</code>) and conversely, the <em>types</em> become <em>methods</em> (<code>visitAddOperator</code>, <code>visitNotOperator</code> (or just <code>visit</code>, if your language supports argument-based overloading)). This does <em>not</em> solve the Expression Problem (i.e. how to make it easy to add <em>both</em> types and operations), but it <em>does</em> allow you to choose <em>which one</em> to make easy.</p><p>So, if your language <em>does</em> support a way to solve the Expression Problem, then you don&#39;t need this workaround.</p><p>Note, however, this is not the only thing the Visitor Pattern does.</p><hr/><p>Note: you will note the conspicuous absence of any mention of C++, whatsoever. Unfortunately, I simply don&#39;t know enough about it. I suspect that between its overloading and argument-based dispatch, virtual inheritance, free functions, macros, and most importantly compile-time template metaprogramming, the Expression Problem <em>is</em> solved in C++, but I don&#39;t know for sure.</p><p>The problem is that once someone finds a solution for the Expression Problem, they redefine it to make it even harder so solve, so that new solutions are even more powerful and expressive. For example, the original formulation by the Haskell community did not require modular typechecking, but the Scala community proposed that the Expression Problem should not only include modular extension (separate compilation etc.) of types and operations, but also modular typechecking and type inference of those extensions, which at the moment is something only Scala&#39;s implicits can do and Haskell&#39;s typeclasses and ML&#39;s functors can&#39;t.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../c-using-visitor-pattern-with-large-object-hierarchy/'>C# &#8211; Using visitor pattern with large object hierarchy</a></li><li class="list-group-item"><a href='../implementing-the-visitor-pattern-for-an-abstract-syntax-tree/'>Implementing the Visitor Pattern for an Abstract Syntax Tree</a></li><li class="list-group-item"><a href='../homogeneous-vs-heterogeneous-ast-representation/'>Homogeneous vs. heterogeneous AST representation</a></li><li class="list-group-item"><a href='../design-how-do-we-keep-dependent-data-structures-up-to-date/'>Design &#8211; How do we keep dependent data structures up to date</a></li><li class="list-group-item"><a href='../c-traversing-an-ast-using-visitors/'>C++ &#8211; Traversing an AST using Visitors</a></li><li class="list-group-item"><a href='../c-expandable-alternative-to-visitor-pattern-for-tree-traversal/'>C++ &#8211; Expandable alternative to Visitor pattern for tree traversal</a></li><li class="list-group-item"><a href='../design-combining-composite-decorator-and-visitor-patterns/'>Design &#8211; Combining composite, decorator and visitor patterns</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>