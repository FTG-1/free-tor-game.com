<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="https://free-tor-game.com/wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Design &#8211; IoC/DI design for class library &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.min.js?ver=11.2.0' id='highlight-js'></script>     <script>( function( w, d, s, l, i ) {
				w[l] = w[l] || [];
				w[l].push( {'gtm.start': new Date().getTime(), event: 'gtm.js'} );
				var f = d.getElementsByTagName( s )[0],
					j = d.createElement( s ), dl = l != 'dataLayer' ? '&l=' + l : '';
				j.async = true;
				j.src = 'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
				f.parentNode.insertBefore( j, f );
			} )( window, document, 'script', 'dataLayer', ' ' );</script>      <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1077079 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="https://free-tor-game.com/3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="https://free-tor-game.com/contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1077079" class="post-1077079 software type-software status-publish hentry category-software tag-design tag-inversion-of-control"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Design &#8211; IoC/DI design for class library</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">design</span><span class="mr-2 badge badge-info">inversion-of-control</span></p><div class="entry-content"><p>I am refactoring and introducing unit tests in a large application.</p><p>It&#39;s currently a collection of static classes with static methods that return data, like such:</p><pre><code>// in data access project
public static class DataStock {
     public static Stock GetStock(int operation) { return my data; }
}

// in business layer project
public static class Stock {
     public static Stock GetStock(int operation) {
         var stock = DataStock.GetStock(operation);
         // do something with the data
         return stock;
     }
}

// in forms project
public class FrmDisplayStock {
     public void LoadStock() {
         var stock = Stock.GetStock(this.selectorOperation);
         // display the stock
     }
}
</code></pre><p>I am redesigning the app like this:</p><pre><code>// in data access project
public class DataStock : IDataStock {
     public Stock GetStock(int operation) { return my data; }
}

// in business layer project
public class Stock : IStock {
     private IDataStock data;

     public Stock() { this.data = new DataStock(); }
     public Stock(IDataStock data) { this.data = data; }

     public Stock GetStock(int operation) {
         var stock = data.GetStock(operation);
         // do something with the data
         return stock;
     }
}

// in forms project
public class FrmDisplayStock {
     private IStock stockbll;

     public FrmDisplayStock() { this.stockbll = new Stock(); }
     public FrmDisplayStock(IStock stockbll) { this.stockbll = stockbll; }

     public void LoadStock() {
         var stock = stockbll.GetStock(this.selectorOperation);
         // display the stock
     }
}
</code></pre><p>This allows me to write tests for the business and forms layers, mocking the underlying layer (I am not yet testing the data access layer, but it&#39;s both more complicated to test and less interesting).</p><p>I would like to use a IoC container so that I don&#39;t have to manually wire the interfaces to concrete types every time; with deep nesting and many tests to write, it&#39;s becoming quite annoying and error-prone.</p><p>The problem is that I don&#39;t grasp how to implement it, technically.</p><ul><li>Shall I write a bootstrapper for each project that wires the underlying layer ?</li><li>Shall I change my constructors to get the container&#39;s instance like such ? <code>public Stock() { this.data = myContainer.GetInstance&lt;IDataStock&gt;(); }</code></li><li>Is it working differently than I am assuming ?</li></ul></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>You want all dependencies to be injected from the absolute top layer, so you should have a dependency graph with a root, and the root has a reference to the concrete implementation of the deps at every node, registers that concretion for the interface in a container, and then grabs just the first level deps <em>it</em> needs from the container. But in doing so, that layer has deps the container constructs which has deps the container constructs...</p><p>Think of your dependency graph being constructed by the container like this:</p><pre><code>public void main()
{
    var frmDisplayStock = new FrmDisplayStock(
      new Stock(
        new DataStock()
      )
    );
}
</code></pre><p>Except instead of you manually constructing each dependency at each layer of the graph, you just register the types with a container (or however the container you choose requires you to register them). For example:</p><pre><code>public void main()
{
    var container = new SomeIocContainer();
    container.Register&lt;IDataStock&gt;(typeof(DataStock));
    container.Register&lt;IStock&gt;(typeof(Stock));
    container.Register&lt;IDataStock&gt;(typeof(DataStock));
    var frmDisplayStock = container.Get&lt;FrmDisplayStock&gt;();
}
</code></pre><p>In the above example, the final <code>.Get</code> call is going to use the types it knows about, and the container will presumably figure out what types are required to fulfill the whole dependency graph, identically so what was done in our previous example without a container.</p><hr/><p>So in conclusion, you want to go to the highest point in your stack you can and let it decide all the concretions. You don&#39;t want to have those default public constructors that <em>know</em> the concretions, because that causes tightly-coupled references between things when an interface would more than suffice. You never know when you&#39;ll want to use an <code>IDataStock</code> that works off a high performance cache, or 3rd party webservice, or local file, so don&#39;t presume <code>DataStock</code> is the only implementation you&#39;ll use. The key point of making this decision at the top layer is, if you do it below that, you&#39;ll find some layer of dependencies <em>above</em> that point and now you&#39;ll what- reference <em>up</em> the stack to define it?</p><p>Dependencies should be a directed graph with no loops (DAG) and a single root (tree), in a tree you never let peers know about each other, and you never let children know their parents. So where but at the root can you reference all dependencies without breaking the rules of a tree?</p><hr/><p>Another larger example that may make this all clearer since your example merely has 2 dependencies, not much of a sample for illustrating a concept.</p><pre><code>public void Main()
{
    var myWidgetsService = new WidgetService(
      new WidgetEventsProcessor(
        new MessageQueueSubscriber(ConfigurationManager.AppSettings[&#34;MQConnectionString&#34;])
      ),
      new WidgetInProcessCacheStore(),
      new WidgetSerializerService(
        new JsonSerializer()
      ),
      new WidgetAccessControlService(
        new AccessRightsProcessor(
          new AccessRightsServiceClient(ConfigurationManager.AppSettings[&#34;AccessRightsServiceUri&#34;])
        ),
        new AuthenticationProcessor(
          new WindowsAuthenticationChecker(ConfigurationManager.AppSettings[&#34;DomainController&#34;]),
          new EMailClient(ConfigurationManager.AppSettings[&#34;SMTPService&#34;]) // for auth failure warnings
        )
      )
    );
}
</code></pre><p>Given the above dependencies tree, you would just make the registrations, and let the container manage the construction (totally made-up IoC API, not a real or suggested IoC framework API):</p><pre><code>public void Main()
{
    var container = new SomeIocContainer();
    container.Register&lt;IWindowsAuthenticationChecker&gt;(typeof(WindowsAuthenticationChecker), ConfigurationManager.AppSettings[&#34;DomainController&#34;]);
    container.Register&lt;IEMailClient&gt;(typeof(EMailClient), ConfigurationManager.AppSettings[&#34;SMTPService&#34;]);
    container.Register&lt;IAuthenticationProcessor&gt;(typeof(AuthenticationProcessor));
    container.Register&lt;IAccessRightsServiceClient&gt;(typeof(AccessRightsServiceClient), ConfigurationManager.AppSettings[&#34;AccessRightsServiceUri&#34;]);
    container.Register&lt;IAccessRightsProcessor&gt;(typeof(AccessRightsProcessor));
    container.Register&lt;IWidgetAccessControlService&gt;(typeof(WidgetAccessControlService));
    container.Register&lt;IJsonSerializer&gt;(typeof(JsonSerializer));
    container.Register&lt;IWidgetSerializerService&gt;(typeof(WidgetSerializerService));
    container.Register&lt;IWidgetStore&gt;(typeof(WidgetInProcessCacheStore));
    container.Register&lt;IWidgetSerializerService&gt;(typeof(WidgetSerializerService));
    container.Register&lt;IMessageQueueSubscriber&gt;(typeof(MessageQueueSubscriber), ConfigurationManager.AppSettings[&#34;MQConnectionString&#34;]));
    container.Register&lt;IWidgetEventsProcessor&gt;(typeof(WidgetEventsProcessor));

    var myWidgetsService = container.Get&lt;WidgetService&gt;();
}
</code></pre></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='https://free-tor-game.com/software/java-object-oriented-class-design/'>Java &#8211; Object-Oriented Class Design</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/c-abstract-dal-use-interface-with-internal-class/'>C# &#8211; Abstract DAL &#8211; Use Interface with Internal Class</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/dependency-injection-ioc-container-practices-when-writing-frameworks/'>Dependency Injection/IoC container practices when writing frameworks</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/c-layered-architecture-using-entity-framework-with-different-class-libraries/'>C# &#8211; Layered architecture using Entity Framework with different class libraries</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/c-dependency-injection-for-a-library-with-internal-dependencies/'>C# &#8211; Dependency injection for a library with internal dependencies</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='http://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="https://free-tor-game.com/wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>