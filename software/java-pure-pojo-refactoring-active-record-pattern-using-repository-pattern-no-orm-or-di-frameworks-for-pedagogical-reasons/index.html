<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Java &#8211; Pure POJO refactoring Active Record Pattern using Repository Pattern, no ORM or DI frameworks for pedagogical reasons &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1084078 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1084078" class="post-1084078 software type-software status-publish hentry category-software tag-design-patterns tag-java tag-refactoring tag-repository"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Java &#8211; Pure POJO refactoring Active Record Pattern using Repository Pattern, no ORM or DI frameworks for pedagogical reasons</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">design-patterns</span><span class="mr-2 badge badge-info">java</span><span class="mr-2 badge badge-warning">refactoring</span><span class="mr-2 badge badge-primary">repository</span></p><div class="entry-content"><p>I taught a course years ago, and then I used some JDBC exercises using what I now know is the Active Record Pattern.</p><p>I would like to modernize the exercise by changing the Active Record Pattern so classes don&#39;t do their own persistence. But I would not like to use any persistence or ORM framework for teaching purposes.</p><p>A sample class is Vehicle:</p><ul><li>It receives a Connection and plate number in the constructor.</li><li>In the constructor it queries the database and populates the class members and a boolean member <code>existInDB</code> is set to true.</li><li>If the plate is not found in the DB, <code>existInDB</code> remains false.</li><li>You can change the state of the object with setters.</li><li>If you call <code>save()</code> it either inserts in the database if <code>existInDB</code> is false or updates a row in the database if <code>existInDB</code> is false.</li><li>After refactoring the class would not be a simple data transfer object because it has a <code>doSomeBusinessThing()</code> method that does some business thing.</li><li>All other classes like Maker, Owner, also use the Active Record Pattern, but we can leave them alone for now.</li></ul><p>This is not production code. It&#39;s Java SE course material. I don&#39;t want to introduce frameworks to people who are learning the language and/or OOP principles for the first time. One requirement of my question is that it must be POJO-based. Maybe using a design pattern but no external frameworks or ORM.</p><p><strong>I would like to read your advice on how to do such a refactoring.</strong></p><p>The vehicle class:</p><pre><code>import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;

public class Vehicle {

    private String plate;
    private Model model;
    private Owner owner;
    private String color;
    private String status;
    private int year;
    private boolean existInDB= false;
    private Connection conn;
    private ResultSet rs;

    public Vehicle(Connection con_,String plate_) throws SQLException {
        String sql=
        &#34;select \n&#34;+ 
        &#34;       v.plate, \n&#34; +
        &#34;       v.model_id, \n&#34;+
        &#34;       v.owner_id, \n&#34;+
        &#34;       v.color, \n&#34;+
        &#34;       v.status, \n&#34;+
        &#34;       v.year \n&#34;+
        &#34;from \n&#34;+
        &#34;     vehicle v \n&#34;+
        &#34;where \n&#34;+
        &#34;     v.plate = ? \n&#34;;

        PreparedStatement ps = con_.prepareStatement(sql,ResultSet.TYPE_SCROLL_INSENSITIVE,ResultSet.CONCUR_UPDATABLE);
        ps.setString(1, plate_);
        rs = ps.executeQuery();

        plate = plate_;
        conn = con_;

        if (rs.next()){         
            try {
                model = new Model(conn,rs.getString(&#34;model_id&#34;));
            } catch (UnknownMakerException e) {
                e.printStackTrace();
            } catch (UnknownModelException e) {
                e.printStackTrace();
            }
            try {
                owner = new Owner(conn,rs.getInt(&#34;owner_id&#34;));
            } catch (UnknownOwnerException e) {
                e.printStackTrace();
            }
            color = rs.getString(&#34;color&#34;);
            status = rs.getString(&#34;status&#34;);
            year = rs.getInt(&#34;year&#34;);
            existInDB = true;   
        }

    }

    public void save() throws SQLException{
        if (existsInDB()){
            rs.absolute(1);
            rs.updateString(&#34;plate&#34;,plate);
            rs.updateString(&#34;model_id&#34;, model.getID());
            rs.updateInt(&#34;owner_id&#34;, owner.getID());
            rs.updateString(&#34;color&#34;, color);
            rs.updateString(&#34;status&#34;, status);
            rs.updateInt(&#34;year&#34;, year);
            rs.updateRow();             
        } else {
            rs.moveToInsertRow();
            rs.updateString(&#34;plate&#34;, plate);
            rs.updateString(&#34;model_id&#34;, model.getID());
            rs.updateInt(&#34;owner_id&#34;, owner.getID());
            rs.updateString(&#34;color&#34;, color);
            rs.updateString(&#34;status&#34;, status);
            rs.updateInt(&#34;year&#34;, year);
            rs.insertRow();     
        }


    }

    public String getPlate() {
        return plate;
    }

    public Model getModel() {
        return model;
    }

    public Owner getOwner() {
        return owner;
    }

    public String getColor() {
        return color;
    }

    public String getStatus() {
        return status;
    }

    public int getYear() {
        return year;
    }

    public boolean existsInDB() {
        return existInDB;
    }

    public void setPlate(String plate) {
        this.plate = plate;
    }

    public void setModel(String  modelID_) throws SQLException, UnknownModelException {
        try {
            this.model = new Model(conn,modelID_);
        } catch (UnknownMakerException e) {
            e.printStackTrace();
        }
    }

    public void setOwner(int ownerID) throws SQLException, UnknownOwnerException {
        this.owner = new Owner(conn,ownerID);
    }

    public void setColor(String color) {
        this.color = color;
    }

    public void setStatus(String status) {
        this.status = status;
    }

    public void setYear(int year) {
        this.year = year;
    }

    protected void finalize() throws Throwable,  SQLException
    {
        try {
            PreparedStatement stmt = (PreparedStatement) rs.getStatement();
            rs.close();
            stmt.close();
            stmt = null;
        } finally {
            super.finalize();
        }
    }   

    public String getDescription(){
        return
        this.getModel().getMaker().getName() + &#34; &#34; +
        this.getModel().getName() + &#34; &#34; +
        this.getColor() + &#34; &#34; +
        this.getYear();

    }

    public String toString(){
        return
        &#34;\nVEHICLE&#34; +
        &#34;\nPlate: &#34; +this.getPlate() + 
        &#34;\nModel ID: &#34; +this.getModel().getID() + 
        &#34;\nOwner ID: &#34; +this.getOwner().getID() +
        &#34;\nColor: &#34; +this.getColor() +
        &#34;\nStatus: &#34; +this.getStatus() +
        &#34;\nYear: &#34; +this.getYear();
    }

    public void doSomeBusinessThing(){
        /* some important business logic just to clarify 
         * that this is not a simple data transfer object
         */

    }

}
</code></pre></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>Leaving as much of your original code as possible, I would refactor the Vehicle class so that it is constructed using a new Importer interface and saved using a new Exporter interface.</p><pre><code>public class Vehicle {

    // fields omitted

    public Vehicle(Importer importer) {
        plate = importer.plate();
        model = importer.model();
        owner = importer.owner();
        color = importer.color();
        status = importer.status();
        year = importer.year();
    }

    public interface Importer {
        String plate();
        Model model();
        Owner owner();
        String color();
        String status();
        int year();
    }

    public void save(Exporter exporter) {
        exporter.plateIs(plate)
                .modelIs(model)
                .ownerIs(owner)
                .colorIs(color)
                .statusIs(status)
                .yearIs(year)
                .export();
    }

    public interface Exporter {
        Exporter plateIs(String plate);
        Exporter modelIs(Model model);
        Exporter ownerIs(Owner owner);
        Exporter colorIs(String color);
        Exporter statusIs(String status);
        Exporter yearIs(int year);
        void export();
    }

    // rest of class unchanged
}
</code></pre><p>At this point the class no longer does its own persistence and we can write importers and exporters for various persistence technologies.
I would now write a SqlVehicleImporter (using your original SQL code)...</p><pre><code>public class SqlVehicleImporter implements Vehicle.Importer {

    private String plate;
    private Model model;
    private Owner owner;
    private String color;
    private String status;
    private int year;

    public SqlVehicleImporter(Connection con_, String plate_) throws SQLException {
        String sql=
                &#34;select \n&#34;+
                        &#34;       v.plate, \n&#34; +
                        &#34;       v.model_id, \n&#34;+
                        &#34;       v.owner_id, \n&#34;+
                        &#34;       v.color, \n&#34;+
                        &#34;       v.status, \n&#34;+
                        &#34;       v.year \n&#34;+
                        &#34;from \n&#34;+
                        &#34;     vehicle v \n&#34;+
                        &#34;where \n&#34;+
                        &#34;     v.plate = ? \n&#34;;

        PreparedStatement ps = con_.prepareStatement(sql, ResultSet.TYPE_SCROLL_INSENSITIVE,ResultSet.CONCUR_UPDATABLE);
        ps.setString(1, plate_);
        ResultSet rs;
        rs = ps.executeQuery();

        plate = plate_;

        if (rs.next()){
            try {
                model = new Model(con_,rs.getString(&#34;model_id&#34;));
            } catch (UnknownMakerException e) {
                e.printStackTrace();
            } catch (UnknownModelException e) {
                e.printStackTrace();
            }
            try {
                owner = new Owner(con_,rs.getInt(&#34;owner_id&#34;));
            } catch (UnknownOwnerException e) {
                e.printStackTrace();
            }
            color = rs.getString(&#34;color&#34;);
            status = rs.getString(&#34;status&#34;);
            year = rs.getInt(&#34;year&#34;);
        }

        rs.close();
        ps.close();
    }

    // interface implementation omitted
}
</code></pre><p>...and a SqlVehicleExporter.</p><pre><code>public class SqlVehicleExporter implements Vehicle.Exporter {

    private final Connection connection;

    // fields omitted

    public SqlVehicleExporter(Connection connection) {
        this.connection = connection;
    }

    public Vehicle.Exporter plateIs(String plate) {
        this.plate = plate;
        return this;
    }

    // repetitive interface methods omitted

    public void export() {
        String sql=
                &#34;select \n&#34;+
                        &#34;       v.plate, \n&#34; +
                        &#34;       v.model_id, \n&#34;+
                        &#34;       v.owner_id, \n&#34;+
                        &#34;       v.color, \n&#34;+
                        &#34;       v.status, \n&#34;+
                        &#34;       v.year \n&#34;+
                        &#34;from \n&#34;+
                        &#34;     vehicle v \n&#34;+
                        &#34;where \n&#34;+
                        &#34;     v.plate = ? \n&#34;;

        try {
            PreparedStatement ps = connection.prepareStatement(sql, ResultSet.TYPE_SCROLL_INSENSITIVE, ResultSet.CONCUR_UPDATABLE);
            ps.setString(1, plate);
            ResultSet rs = ps.executeQuery();
            boolean existsInDB = rs.next();

            if (existsInDB) {
                rs.absolute(1);
                rs.updateString(&#34;plate&#34;, plate);
                rs.updateString(&#34;model_id&#34;, model.getID());
                rs.updateInt(&#34;owner_id&#34;, owner.getID());
                rs.updateString(&#34;color&#34;, color);
                rs.updateString(&#34;status&#34;, status);
                rs.updateInt(&#34;year&#34;, year);
                rs.updateRow();
            } else {
                rs.moveToInsertRow();
                rs.updateString(&#34;plate&#34;, plate);
                rs.updateString(&#34;model_id&#34;, model.getID());
                rs.updateInt(&#34;owner_id&#34;, owner.getID());
                rs.updateString(&#34;color&#34;, color);
                rs.updateString(&#34;status&#34;, status);
                rs.updateInt(&#34;year&#34;, year);
                rs.insertRow();
            }
        } catch(SQLException error) {
            error.printStackTrace();
        }
    }
}
</code></pre><p>At this point there is code that is common between the importer and exporter so it might be a good idea to combine them.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../c-are-we-using-the-repository-pattern-right/'>C# &#8211; Are we using the repository pattern right</a></li><li class="list-group-item"><a href='../are-the-repository-pattern-and-active-record-pattern-compatible/'>Are the Repository Pattern and Active Record pattern compatible</a></li><li class="list-group-item"><a href='../object-oriented-what-data-type-should-gateway-return-in-repository-pattern-to-eliminate-refactoring-when-switching-persistence-mechanisms/'>Object-oriented &#8211; What data type should Gateway return in Repository Pattern to eliminate refactoring when switching persistence mechanisms</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>