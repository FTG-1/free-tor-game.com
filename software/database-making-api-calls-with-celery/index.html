<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Database &#8211; Making API calls with celery &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1078795 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1078795" class="post-1078795 software type-software status-publish hentry category-software tag-api tag-database tag-python tag-rabbitmq tag-scheduling"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Database &#8211; Making API calls with celery</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">api</span><span class="mr-2 badge badge-info">database</span><span class="mr-2 badge badge-warning">python</span><span class="mr-2 badge badge-primary">rabbitmq</span><span class="mr-2 badge badge-danger">scheduling</span></p><div class="entry-content"><p>I&#39;m designing a system for a client where the requirements are:</p><ul><li>they upload a JSON file (one object/line)</li><li>make a call to an API with the JSON object as the payload</li><li>record the state (success/failure) of each API call in a database</li><li>make one retry if there&#39;s a failure.</li></ul><p>I decided to build it out using celery and a sqlite database as the backend. The number of JSON lines is not large — perhaps a couple million at most — which will fit in memory. I have all the individual components working fine (can upload file, can read file, can call API, can write to db, etc.), but I am not sure about the overall architecture of dispatching tasks using celery.</p><p>Assuming there are N lines in the file, should I:</p><h3>Option A:</h3><ol><li>Create N objects in the database with a <code>result</code> column (initially null).</li><li>Create N celery tasks and pass the object id as the parameter and the payload</li><li>Make the subtask call the API and update the object&#39;s result field to success/failure.</li><li>Let celery&#39;s retry feature attempt to call the API again in case of failure.</li></ol><h3>Option B:</h3><ol><li>Create N objects in the database with a <code>result</code> column (initially null).</li><li>Create 1 celery task and pass the entire list of N object ids and N payloads</li><li>Loop through all N objects and update the database with the result at each step.</li><li>When the previous task finishes, it fires another one-time celery task that reads the database for all objects with failure result and retries them.</li></ol><p>I&#39;m favoring option A because of its simplicity but I don&#39;t know what the limits are on the number of celery tasks that can be scheduled and if the broker (RabbitMQ) will handle it. With option B, the big risk is that if the celery task were to get terminated for any reason at some line M, then all following objects will never be tried.</p><p>Any thoughts on these two or if there&#39;s a third better alternative?</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>Option A sounds like the way to go as you can set workers it the API independently instead of a huge tasks that only a single worker can manage.</p><p>I have a very similar scenario using kombu and Celery:</p><ul><li>We get a message posted to RMQ by some integration to a RMQ queue</li><li>We have a kombu consumer draining events</li><li>When event is received we execute the callback (post to local python queue)</li><li>celery gets the message sent over the python queue and process it</li><li>Once finished it returns the results and we relay the message to a kombu producer</li><li>The producer posts back to RMQ</li></ul><p>As you can see, we use basically the same approach as you. We have this in production handling around 2000 messages per hour with no problem.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../python-should-i-stick-with-or-abandon-python-to-deal-with-concurrency/'>Python &#8211; Should I stick with or abandon Python to deal with concurrency</a></li><li class="list-group-item"><a href='../rest-always-return-single-objects-in-an-array-for-rest-api-json-payloads/'>Rest &#8211; Always return single objects in an array for REST API JSON payloads</a></li><li class="list-group-item"><a href='../database-implementation-details-of-database-synchronisation-api/'>Database &#8211; Implementation details of database synchronisation API</a></li><li class="list-group-item"><a href='../database-is-it-better-to-make-database-calls-or-external-api-calls-first-in-the-context-of-a-single-web-request/'>Database &#8211; Is it better to make database calls or external API calls first in the context of a single Web request</a></li><li class="list-group-item"><a href='../python-options-to-handle-large-multi-gigabyte-file-uploads/'>Python &#8211; Options to handle large (multi-gigabyte) file uploads</a></li><li class="list-group-item"><a href='../javascript-rest-api-design-patterns/'>Javascript &#8211; REST Api Design Patterns</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>