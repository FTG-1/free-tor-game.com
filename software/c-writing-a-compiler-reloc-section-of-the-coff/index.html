<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>C# &#8211; Writing a Compiler &#8211; .reloc section of the COFF &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1087090 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1087090" class="post-1087090 software type-software status-publish hentry category-software tag-c tag-compiler tag-net"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">C# &#8211; Writing a Compiler &#8211; .reloc section of the COFF</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">c</span><span class="mr-2 badge badge-info">compiler</span><span class="mr-2 badge badge-warning">net</span></p><div class="entry-content"><p>I&#39;m looking for a little bit of direction in writing a compiler.  I&#39;ve written in <code>Common Intermediate Language</code>, <code>C#</code>, and various other .NET languages; I&#39;ve written my own Metadata Parser and now I&#39;m trying to understand the various aspects of the Portable Executable (<code>PE</code>) layout.  One thing that somewhat befuddles me is the <code>.reloc</code> section.</p><p>I have the Relocs parsing (or at least I think I do? ðŸ™‚ and I wanted to know, within .NET libraries they usually have a single Reloc block with a single HighLow (<code>IMAGE_REL_BASED_HIGHLOW</code>, or just <code>3</code>) reloc at a given offset that changes.  When I go to writing my own PE Header and COFF sections, how do I calculate the <code>Relative Virtual Address</code> of the block, and the <code>Offset</code> (lower 12 bits) on the <code>TypeOffset</code> entry that follows that block header?</p><p>I&#39;m currently using the pecoff_v83.docx (<strong>Microsoft Portable Executable and Common Object File Format Specification Revision 8.3</strong>) from Microsoft&#39;s website, but I think there&#39;s a step I&#39;m missing out on.</p><p>I&#39;ll link a relevant post: <a href="https://stackoverflow.com/questions/17436668/how-are-pe-base-relocations-build-up">How are PE Base Relocations build up?</a></p><p>^ That helped me parse the Reloc entries, but <strong>parsing</strong> them and <strong>generating</strong> the data that goes into them are different questions.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><blockquote><p>... how do I calculate the <code>Relative Virtual Address</code> of the block, and the Offset (lower 12 bits) on the <code>Type</code> <code>Offset</code> entry that follows that block header?</p></blockquote><p>Microsoft - <a href="https://docs.microsoft.com/en-us/windows/desktop/debug/pe-format#the-reloc-section-image-only" rel="nofollow noreferrer">PE Format</a> (05/30/2018):</p><blockquote><p>&#34;<strong>Base Relocation Block</strong></p><p>Each base relocation block starts with the following structure:</p><p>Offset Â Â Â Â  Size Â Â Â Â  Field Â Â Â Â  Description</p><hr/><p>Â Â Â 0   Â Â Â Â  Â Â Â Â  Â Â  4  Â Â Â Â  Â Â Â  RVA Â Â Â Â  The image base plus the page RVA is added to each   offset to create the VA where the base relocation must be applied.</p><p>Â Â Â 4  Â Â Â Â  Â Â Â Â  Â Â  4  Â Â Â Â  Â Â Â Â  BS Â Â Â Â Â Â Â  The total number of bytes in the base relocation<br/> block, including the Page RVA and Block Size fields and the Type/Offset fields that follow.</p><p>Â </p><p>The Block Size field is then followed by any number of Type or Offset field entries. Each entry is a WORD (2 bytes) and has the following structure:</p><p>Offset Â Â Â Â  Size Â Â Â Â  Field Â Â Â Â  Description</p><hr/><p>Â Â Â 0   Â Â Â Â  Â Â Â Â  Â  4b  Â Â  Â Â Â  Type Â Â Â Â  Stored in the high 4 bits of the WORD, a value that indicates the type of base relocation to be applied. For more information, see <a href="https://docs.microsoft.com/en-us/windows/desktop/debug/pe-format#base-relocation-types" rel="nofollow noreferrer">Base Relocation Types</a>.</p><p>Â Â Â 0   Â Â Â Â  Â Â Â Â Â  12b  Â Â Â Â Â  Type Â Â Â Â  Stored in the remaining 12 bits of the WORD, an offset from the starting address that was specified in the Page RVA field for the block. This offset specifies where the base relocation is to be applied.</p><p>...</p><p>&#34;.</p></blockquote><p>Example code is in <a href="https://www.gnu.org/software/binutils/" rel="nofollow noreferrer">BinUtils</a>.</p><p>You can find testing code in <a href="https://github.com/zeha/xc32/tree/master/src/binutils/ld/testsuite/ld-cygwin" rel="nofollow noreferrer"><code>binutils/ld/testsuite/ld-cygwin</code></a>.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../c-i-o-interface-for-portable-library/'>C# &#8211; I/O interface for portable library</a></li><li class="list-group-item"><a href='../c-log4net-roll-the-own-singleton-use-logimpl-etc/'>C# &#8211; log4net &#8211; roll the own singleton, use LogImpl, etC</a></li><li class="list-group-item"><a href='../should-i-use-a-source-to-source-or-a-traditional-compiler-in-order-to-develop-the-own-programming-language/'>Should I use a source-to-source or a traditional compiler in order to develop the own Programming Language</a></li><li class="list-group-item"><a href='../implementing-naive-register-allocation-for-x86-machines/'>Implementing naive register allocation for x86 machines</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>