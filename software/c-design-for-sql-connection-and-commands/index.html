<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>C# Design for SQL connection and commands &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1078040 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1078040" class="post-1078040 software type-software status-publish hentry category-software tag-c tag-design tag-multithreading tag-sql"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">C# Design for SQL connection and commands</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">c</span><span class="mr-2 badge badge-info">design</span><span class="mr-2 badge badge-warning">multithreading</span><span class="mr-2 badge badge-primary">sql</span></p><div class="entry-content"><p>Currently I&#39;m working on system that works with database, and I would like to have it done elegant way. So I have abstracted DBConnection into one class, DBCommands into another class. (DBCommands : DBConnection)</p><p>There is also a class SQLUsage in which I&#39;m creating new thread that works in a loop, it checks all the time if there&#39;s any object in BlockingCollection to take care of, if there is that thread is processing it, and it uses DBConnection and DBCommands for it. I am having a problem accesing DBCommands from SQLUsage, since the DBCommands object is created in DBConnection (I have to pass MySqlConnection object into DBCommands)</p><p>Is that good solution? Or I should change the design, I would like to use those classes in another app as well (part of same, bigger system).</p><p>I&#39;ll tell you bit more about this app. It is a server app that handles connections from multiple clients. Each client sends some info to server, that is stored in <code>BlockingCollection&lt;thatinfo&gt;</code>. Another thread is using items from <code>BlockingCollection&lt;thatinfo&gt;</code> to communicate with mysql server, and insert some data to it, according to <code>objects&lt;thatinfo&gt;</code>.</p><p>And I&#39;m having problem with design. So far I have a main class, class for handling TCP/IP connections, <code>thatinfo</code> class, SQLUsage, DBConnection and DBCommands class.</p><p>Since BlockingCollection is initiated in main class and it is passed to both TCP/IP handling class and SQL Handling class it is not a problem. My problem is to properly design SQLHandling classes. I want it to be done in elegant way.</p><p>So I figured out it would be good to abstract connection and commands from the class where I process the info. So I already have working SQLConnection class, I had some commands in it as well and it worked. But next step was to abstract commands in another class, since there will be many overloaded methods (for example Insert with 1 arg, Insert with 2 args etc.)</p><p>So my question is not about the code, I know how to create it, it&#39;s more about design. If abstracting sql commands in another class was good idea or not? Should both DBConnection and DBCommands inherit from SQLHandling class? or only DBConnection : DBCommands ?</p><p>And another question, probably easier to answer, is there more elegant way to do sql commands than just overloading methods? Like 1 universal INSERT method that handles all arguments?</p><p>For now having few overloaded insert methods seems to be a good idea since in this app I&#39;m working on, there will be only 2 different kinds of inserts (just different amount of arguments), but in another app I wanted use the same classes I could really use universal Insert method.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>I don&#39;t see a really answerable question in there anywhere, but I can at least address some general concerns here. Over the years I&#39;ve noticed a few common mistakes in this area. I&#39;ll list them below, in hopes of helping you avoid them:</p><ol><li><strong>Re-using the same SqlConnection object.</strong> It&#39;s counter-intuitive, but .Net is designed such that it&#39;s more effective in most cases to create a new DbConnection object for each call to the database. Of course there are exceptions, but if you find yourself wanting to keep re-using a single shared DbConnection, you&#39;ll have problems. It&#39;s worth noting that this is thanks to a connection pooling feature that is implemented by the <em>provider</em>, and that some providers may do this differently... however, most of the major providers do implement connection pooling, such that this does hold.</li><li><strong>Failing to properly close your database connections.</strong> Since we&#39;re now creating a new DbConnection object for each query, it&#39;s important that we also close all these connections. Failure to do so can result in locking the database for new access... effectively creating a denial of service situation. Often, someone will remember to call <code>.Close()</code> for each of their connections, but they will forget that if the <code>.Close()</code> is not correctly placed in a <code>finally</code> block, an exception could cause this call to never be executed. You <strong>must</strong> ensure your <code>.Close()</code> calls are placed within a <code>finally</code> block, and the easiest way to do this in .Net is with a <code>using</code> block.</li><li><strong>Methods that accept only sql command strings.</strong> Often there will be method somewhere that accepts an sql string, and returns a DataSet, DataTable, or even DbDataReader (fwiw, my preference is an <code>IEnumerable&lt;IDataRecord&gt;</code>). Perhaps this is paired with a similar method that updates the database. The problem with these methods is that, if they accept only an sql string as input, they practically force you to write code that will be horribly vulnerable to Sql Injection attacks. The idea of running all your sql through a common place is on the right track, but it&#39;s missing an important piece: these methods <strong>must</strong> also provide a way to accept sql parameter data that is separate from the sql command string. There are a number of ways to do this, so picking a particular best one is outside the scope of this post. The one piece of additional advice I can give is to avoid overloading the method to not require this if there really are no parameters for a query. That overload tends to get abused, resulting in security holes. IMO, it&#39;s better to force callers to explicitly pass some kind of construct with zero query parameters, and thus ensure at least some familiarity with the concept.</li><li><strong>Formatting a date string for a call to a database.</strong> If you&#39;re trying to format a date for use in an sql query, you&#39;re doing something wrong. Date values in the database should use a datetime type for the column. Sql Server has several available, including datetime, date, and datetime2, and these types are typical of other databases. When sending date information to the database as part of a query, make sure to use a <em>query parameter</em> that is <em>explicitly typed</em> to the matching type in the <code>SqlDbType</code> enumeration, and assign a .Net <code>DateTime</code> type to the parameter value. String dates should never enter into it. This leads nicely to the next item...</li><li><strong>Allowing .Net to try to guess your parameter types.</strong> I often see examples posted that demonstrate the <code>SqlParameterCollection.AddWithValue()</code> method, and I&#39;m not a fan. When you use this method, .Net will try to <em>infer</em> the type of your parameter. Frankly, there are several situations where it&#39;s just not very good. Using strings as dates is one example. Choosing NVarChar when it should choose VarChar is another. Choosing the wrong length for a VarChar/NVarChar is a third. Any of these can be overcome, and most of the time the query will still work... but it can also fail in unexpected places, and worse, those failures will be in production, rather than during testing. Additionally, sometimes a type mismatch can result in per-row conversions in computing a results set, which can slow things down considerably. Or a type mismatch can result in the database failing to use an obvious important index for a query, making the query take orders of magnitudes longer than it should. Better to favor the <code>SqlParameterCollection.Add()</code> method that asks you to give it an explicit parameter type. Again, this is provider-specific, but most providers make these two methods available.</li><li><strong>Public methods that ask for an sql command string.</strong> As I said earlier, forcing all database through a handful of methods is a good thing... but to make sure this is <em>enforced</em>, those methods need to be private. My data layers will typically have one method for data retrieval, one that only makes changes (insert, update, delete), and maybe one more that returns multiple result sets in the same call (SqlDataReader can do this, though it often isn&#39;t used). However, these methods should be <strong>private</strong>. What you want for the public-facing part of your data layer is one public method per query, and these many public methods then call into the few private methods to complete their tasks. Instead of asking for an sql command, the public methods ask for <em>typed</em> arguments that match the parameters that will be used with the query. These types should most-often be .Net basic types, like <code>int</code>, <code>string</code>, and <code>DateTime</code>, to avoid mixing data and business layers, though occasionally asking for a complicated business object may be <em>expedient</em>... not the purest design, but sometimes sullying the pure design can be okay in the name of less code, DRY, and YAGNI.</li></ol></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../java-proper-oo-design-for-state-and-command/'>Java &#8211; Proper OO design for State and Command</a></li><li class="list-group-item"><a href='../c-plagued-by-multithreaded-bugs/'>C++ &#8211; Plagued by multithreaded bugs</a></li><li class="list-group-item"><a href='../java-how-to-split-large-tightly-coupled-classes/'>Java &#8211; How to split large, tightly coupled classes</a></li><li class="list-group-item"><a href='../c-should-an-object-load-itself/'>C++ &#8211; Should an object load itself</a></li><li class="list-group-item"><a href='../c-windows-service-in-net-with-http-commands/'>C# &#8211; Windows service in .NET with http commands</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>