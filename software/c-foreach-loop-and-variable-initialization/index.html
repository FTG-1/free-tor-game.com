<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="https://free-tor-game.com/wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>C# &#8211; Foreach loop and variable initialization &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.min.js?ver=11.2.0' id='highlight-js'></script>     <script>( function( w, d, s, l, i ) {
				w[l] = w[l] || [];
				w[l].push( {'gtm.start': new Date().getTime(), event: 'gtm.js'} );
				var f = d.getElementsByTagName( s )[0],
					j = d.createElement( s ), dl = l != 'dataLayer' ? '&l=' + l : '';
				j.async = true;
				j.src = 'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
				f.parentNode.insertBefore( j, f );
			} )( window, document, 'script', 'dataLayer', ' ' );</script>      <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1065207 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="https://free-tor-game.com/3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="https://free-tor-game.com/contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1065207" class="post-1065207 software type-software status-publish hentry category-software tag-c tag-memory tag-performance"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">C# &#8211; Foreach loop and variable initialization</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">c</span><span class="mr-2 badge badge-info">memory</span><span class="mr-2 badge badge-warning">performance</span></p><div class="entry-content"><p>Is there a difference between these two versions of code?</p><pre><code>foreach (var thing in things)
{
    int i = thing.number;
    // code using &#39;i&#39;
    // pay no attention to the uselessness of &#39;i&#39;
}
</code></pre><hr/><pre><code>int i;
foreach (var thing in things)
{
    i = thing.number;
    // code using &#39;i&#39;
}
</code></pre><p>Or does the compiler not care? When I&#39;m speaking of difference I mean in terms of performance and memory usage. ..Or basically just any difference or do the two end up being the same code after compilation?</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p><em>TL;DR</em> - they&#39;re equivalent examples at the IL layer.</p><hr/><p><a href="https://dotnetfiddle.net/" rel="noreferrer">DotNetFiddle</a> makes this pretty to answer as it allows you to see the resulting IL.</p><p>I used a slightly different variation of your loop construct in order to make my testing quicker.  I used:</p><p><em>Variation 1:</em></p><pre><code>using System;
                    
public class Program
{
    public static void Main()
    {
        Console.WriteLine(&#34;Hello World&#34;);
        int x;
        int i;
        
        for(x=0; x&lt;=2; x++)
        {
            i = x;
            Console.WriteLine(i);
        }
    }
}
</code></pre><p><em>Variation 2:</em></p><pre><code>        Console.WriteLine(&#34;Hello World&#34;);
        int x;
        
        for(x=0; x&lt;=2; x++)
        {
            int i = x;
            Console.WriteLine(i);
        }
</code></pre><p>In both cases, the compiled IL output rendered the same.</p><pre><code>.class public auto ansi beforefieldinit Program
       extends [mscorlib]System.Object
{
  .method public hidebysig static void  Main() cil managed
  {
    // 
    .maxstack  2
    .locals init (int32 V_0,
             int32 V_1,
             bool V_2)
    IL_0000:  nop
    IL_0001:  ldstr      &#34;Hello World&#34;
    IL_0006:  call       void [mscorlib]System.Console::WriteLine(string)
    IL_000b:  nop
    IL_000c:  ldc.i4.0
    IL_000d:  stloc.0
    IL_000e:  br.s       IL_001f

    IL_0010:  nop
    IL_0011:  ldloc.0
    IL_0012:  stloc.1
    IL_0013:  ldloc.1
    IL_0014:  call       void [mscorlib]System.Console::WriteLine(int32)
    IL_0019:  nop
    IL_001a:  nop
    IL_001b:  ldloc.0
    IL_001c:  ldc.i4.1
    IL_001d:  add
    IL_001e:  stloc.0
    IL_001f:  ldloc.0
    IL_0020:  ldc.i4.2
    IL_0021:  cgt
    IL_0023:  ldc.i4.0
    IL_0024:  ceq
    IL_0026:  stloc.2
    IL_0027:  ldloc.2
    IL_0028:  brtrue.s   IL_0010

    IL_002a:  ret
  } // end of method Program::Main
</code></pre><hr/><p>So to answer your question: <strong>the compiler optimizes out the declaration of the variable, and renders the two variations equivalent.</strong></p><p>To my understanding, the .NET IL compiler moves all variable declarations to the beginning of the function but I couldn&#39;t find a good source that clearly stated that<sup>2</sup>. In this particular example, you see that it moved them up with this statement:</p><pre><code>    .locals init (int32 V_0,
             int32 V_1,
             bool V_2)
</code></pre><hr/><h3>Wherein we get a bit too obsessive in making comparisons....</h3><p><strong>Case A, do all variables get moved up?</strong></p><p>To dig into this a bit further, I tested the following function:</p><pre><code>public static void Main()
{
    Console.WriteLine(&#34;Hello World&#34;);
    int x=5;
    
    if (x % 2==0) 
    { 
        int i = x; 
        Console.WriteLine(i); 
    }
    else 
    { 
        string j = x.ToString(); 
        Console.WriteLine(j); 
    } 
}
</code></pre><p>The difference here is that we declare either an <code>int i</code> or a <code>string j</code> based upon the comparison.  Again, the compiler moves all the local variables to the top of the function<sup>2</sup> with:</p><pre><code>.locals init (int32 V_0,
         int32 V_1,
         string V_2,
         bool V_3)
</code></pre><p>I found it interesting to note that even though <code>int i</code> won&#39;t be declared in this example, the code to support it is still generated.</p><p><strong>Case B: What about <code>foreach</code> instead of <code>for</code>?</strong></p><p>It was pointed out that <code>foreach</code> has different behavior than <code>for</code> and that I wasn&#39;t checking the same thing that had been asked about.  So I put in these two sections of code to compare the resulting IL.</p><p><em><code>int</code> declaration outside of the loop:</em></p><pre><code>    Console.WriteLine(&#34;Hello World&#34;);
    List&lt;int&gt; things = new List&lt;int&gt;(){1, 2, 3, 4, 5};
    int i;

    foreach(var thing in things)
    {
        i = thing;
        Console.WriteLine(i);
    }
</code></pre><p><em><code>int</code> declaration inside of the loop:</em></p><pre><code>    Console.WriteLine(&#34;Hello World&#34;);
    List&lt;int&gt; things = new List&lt;int&gt;(){1, 2, 3, 4, 5};

    foreach(var thing in things)
    {
        int i = thing;
        Console.WriteLine(i);
    }
</code></pre><p>The resulting IL with the <code>foreach</code> loop was indeed different from the IL generated using the <code>for</code> loop.  Specifically, the init block and the loop section changed.</p><pre><code>.locals init (class [mscorlib]System.Collections.Generic.List`1&lt;int32&gt; V_0,
         int32 V_1,
         int32 V_2,
         class [mscorlib]System.Collections.Generic.List`1&lt;int32&gt; V_3,
         valuetype [mscorlib]System.Collections.Generic.List`1/Enumerator&lt;int32&gt; V_4,
         bool V_5)
...
.try
{
  IL_0045:  br.s       IL_005a

  IL_0047:  ldloca.s   V_4
  IL_0049:  call       instance !0 valuetype [mscorlib]System.Collections.Generic.List`1/Enumerator&lt;int32&gt;::get_Current()
  IL_004e:  stloc.1
  IL_004f:  nop
  IL_0050:  ldloc.1
  IL_0051:  stloc.2
  IL_0052:  ldloc.2
  IL_0053:  call       void [mscorlib]System.Console::WriteLine(int32)
  IL_0058:  nop
  IL_0059:  nop
  IL_005a:  ldloca.s   V_4
  IL_005c:  call       instance bool valuetype [mscorlib]System.Collections.Generic.List`1/Enumerator&lt;int32&gt;::MoveNext()
  IL_0061:  stloc.s    V_5
  IL_0063:  ldloc.s    V_5
  IL_0065:  brtrue.s   IL_0047

  IL_0067:  leave.s    IL_0078

}  // end .try
finally
{
  IL_0069:  ldloca.s   V_4
  IL_006b:  constrained. valuetype [mscorlib]System.Collections.Generic.List`1/Enumerator&lt;int32&gt;
  IL_0071:  callvirt   instance void [mscorlib]System.IDisposable::Dispose()
  IL_0076:  nop
  IL_0077:  endfinally
}  // end handler
</code></pre><p>The <code>foreach</code> approach generated more local variables and required some additional branching.  Essentially, on the first time in it jumps to the end of the loop to get the first iteration of the enumeration and then jumps back to almost the top of the loop to execute the loop code.  It then continues to loop through as you&#39;d expect.</p><p>But beyond the branching differences caused by using the <code>for</code> and <code>foreach</code> constructs, there was <strong>no</strong> difference in the IL based upon where the <code>int i</code> declaration was placed.  So we&#39;re still at the two approaches being equivalent.</p><p><strong>Case C: What about different compiler versions?</strong></p><p><a href="https://softwareengineering.stackexchange.com/questions/296803/foreach-loop-and-variable-initialization/296812#comment615312_296812">In a comment that was left</a><sup>1</sup>, there was a link to an <a href="https://stackoverflow.com/q/14907987/1345223">SO question regarding a warning about variable access with foreach and using closure</a>.  The part that really caught my eye in that question was that there may have been differences in how the .NET 4.5 compiler worked versus earlier versions of the compiler.</p><p>And that&#39;s where the DotNetFiddler site let me down - all they had available was .NET 4.5 and a version of the Roslyn compiler.  So I brought up a local instance of Visual Studio and started testing out the code.  To make sure I was comparing the same things, I compared locally built code at .NET 4.5 to the DotNetFiddler code.</p><p>The only difference that I noted was with the local init block and variable declaration.  The local compiler was a bit more specific in naming the variables.</p><pre><code>  .locals init ([0] class [mscorlib]System.Collections.Generic.List`1&lt;int32&gt; things,
           [1] int32 thing,
           [2] int32 i,
           [3] class [mscorlib]System.Collections.Generic.List`1&lt;int32&gt; &#39;&lt;&gt;g__initLocal0&#39;,
           [4] valuetype [mscorlib]System.Collections.Generic.List`1/Enumerator&lt;int32&gt; CS$5$0000,
           [5] bool CS$4$0001)
</code></pre><p>But with that minor difference, it was so far, so good.  I had equivalent IL output between the DotNetFiddler compiler and what my local VS instance was producing.</p><p>So I then rebuilt the project targeting .NET 4, .NET 3.5, and for good measure .NET 3.5 Release mode.</p><p>And in all three of those additional cases, the generated IL was equivalent.  The targeted .NET version had no effect on the IL that was generated in these samples.</p><hr/><p><strong>To summarize this adventure:</strong> I think we can confidently say that the compiler does not care where you declare the primitive type and that there is no effect upon memory or performance with either declaration method.  And that holds true regardless of using a <code>for</code> or <code>foreach</code> loop.</p><p>I considered running yet another case that incorporated a closure inside of the <code>foreach</code> loop.  But you had asked about the effects of where a primitive type variable was declared, so I figured I was delving too far beyond what you were interested in asking about.  The SO question I mentioned earlier has a <a href="https://stackoverflow.com/a/14917351/1345223">great answer</a> that provides a good overview about closure effects on foreach iteration variables.</p><p><sup>1</sup> <sub><em>Thank you to Andy for providing the original link to the SO question addressing closures within <code>foreach</code> loops.</em></sub></p><p><sup>2</sup> <sub><em>It&#39;s worth noting that <a href="http://www.ecma-international.org/publications/standards/Ecma-335.htm" rel="noreferrer">the ECMA-335 spec</a> addresses this with section I.12.3.2.2 &#39;Local variables and arguments&#39;. I had to see the resulting IL and then read the section for it to be clear regarding what was going on.  Thanks to ratchet freak for pointing that out in chat.</em></sub></p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='https://free-tor-game.com/software/java-how-to-significantly-improve-java-performance/'>Java &#8211; How to significantly improve Java performance</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/java-when-does-proper-programming-no-longer-matter/'>Java &#8211; When does &#8220;proper&#8221; programming no longer matter</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/c-do-immutable-objects-that-constantly-change-impact-memory-performance/'>C# &#8211; Do immutable objects that constantly change impact memory/performance</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/maintenance-cost-of-simd-programming-code-base/'>Maintenance cost of SIMD programming code base</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/c-what-can-go-wrong-in-context-of-functional-programming-if-the-object-is-mutable/'>C# &#8211; what can go wrong in context of functional programming if the object is mutable</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='http://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="https://free-tor-game.com/wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>