<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Git &#8211; How to structure commits when unit test requires refactoring &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1071143 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1071143" class="post-1071143 software type-software status-publish hentry category-software tag-architecture tag-design tag-design-patterns tag-git tag-version-control"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Git &#8211; How to structure commits when unit test requires refactoring</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">Architecture</span><span class="mr-2 badge badge-info">design</span><span class="mr-2 badge badge-warning">design-patterns</span><span class="mr-2 badge badge-primary">git</span><span class="mr-2 badge badge-danger">version control</span></p><div class="entry-content"><p>I&#39;m trying to get a review for my lists of pros/cons about how to structure commits that came out of a discussion at my work.</p><p>Here&#39;s the scenario:</p><ul><li>I have to add feature X to a legacy code base</li><li>The current code base has something I can&#39;t mock making unit testing feature X impossible</li><li>I can refactor to make unit testing possible, but it results in a very large code change touching many other non-test classes that have little in common with feature X</li></ul><p>My company has the following strictly enforced rules:</p><ul><li>Each and every commit must be stand alone (compiles, passes test, etc.) We have automation that makes it impossible to merge until these have proven to pass.</li><li>Only fast-forward merges are allowed (no branches, no merge commits, our origin repository only has a a single master branch and it is a perfectly straight line)</li></ul><p>So the question is how to structure the commits for these 3 things. (refactoring, feature X, and test for feature X) My colleague referred me to <a href="https://stackoverflow.com/questions/6228550/should-change-to-code-be-committed-separately-from-corresonding-change-to-test-s">this other article</a> but it doesn&#39;t seem to tackle the refactoring part. (I agree <strong>without</strong> the refactoring source and test should be in one commit)<br /> The article talks about &#34;breaking git bisect&#34; and &#34;making sure every commit compiles/passes&#34; but our strict rules already cover that.<br /> The main other argument they give is &#34;logically related code kept together&#34; which seems a bit to philosophical for me.</p><p>I see 3 ways to proceed. I&#39;m hoping that you can either a) add to it b) comment on why one of the existing pro/cons is not important and should be removed from the list.</p><p><strong>method 1 (one commit): includes feature X, test for feature X, and refactoring</strong></p><p>pros:</p><ul><li>&#34;Logically related code kept together&#34; (Not sure this is actually a &#34;reason&#34;. I would probably argue all 3 methods do this, but some may argue otherwise. However, no one can argue against it here).</li><li>If you cherry-pick / revert without merge conflict, it will probably always compile &amp; pass tests</li><li>There is never code not covered by test</li></ul><p>cons:</p><ul><li>Harder to code review. (Why is all this refactoring is done here despite not being related to feature X?)</li><li>You cannot cherry-pick without the refactoring. (You have to bring along the refactoring, increasing chance of merge conflict and time spent)</li></ul><p><strong>method 2 (two commits): one includes feature X, then two includes refactoring and test for feature X</strong></p><p>pros:</p><ul><li>Easier to code review both. (Refactoring done only for the sake of testing is kept with the test it is associated with)</li><li>You can cherry-pick just the feature. (e.g. for experiments or adding feature to old releases)</li><li>If you decide to revert the feature, you can keep the (hopefully) better structured code that came from the refactoring (However, revert will not be &#34;pure&#34;. See cons below)</li></ul><p>cons:</p><ul><li>There will be a commit without test coverage (even though it&#39;s added immediately after, philosophically bad?)</li><li>Having a commit without test coverage makes automated coverage enforcement hard/impossible for every commit (e.g. you need y% coverage to merge)</li><li>If you cherry-pick only the test, it will fail.</li><li>Adds load to people wanting to do revert. (They needed to either know to revert both commits or remove the test as part of the feature revert making the revert not &#34;pure&#34;)</li></ul><p><strong>method 3 (two commits): one includes refactoring, two includes feature X and test for feature X</strong></p><p>pros:</p><ul><li>Easier to code review the second commit. (Refactoring done only for the sake of testing is kept out of feature commit)</li><li>If you cherry-pick / revert either without merge conflict, it should compile &amp; pass tests</li><li>There is never code not covered by test (both philosophically good and also easier for automated coverage enforcement)</li></ul><p>cons:</p><ul><li>Harder to code review the first commit. (If the only value of the refactoring is for test, and the test are in a future commit, you need to go back and forth between the two to understand why it was done and if it could have been done better.)<ul><li>Arguably the worst of the 3 for &#34;logically related code kept together&#34; (but probably not that important???)</li></ul></li></ul><p>So based on all this, I&#39;m leaning towards 3. Having the automated test coverage is a big win (and it what started me down this rabbit hole in the first place). But maybe one of you has pros/cons I missed? Or maybe there&#39;s a 4th options?</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>When working on existing code, it&#39;s common that you need to refactor the code before you can implement your feature.</p><p>This is the mantra from Kent Beck: <strong>&#34;Make the change easy (warning: this may be hard), then make the easy change&#34;</strong></p><p>To do so, I usually recommend to do frequent little commits. Take baby steps. Refactor progressively:</p><p><a href="../../../i.stack.imgur.com/EPQiA.jpg" rel="noreferrer"><img src="../../../i.stack.imgur.com/EPQiA.jpg" alt="multiple many commits when working on Legacy Code"/></a></p><p>Each refactoring doesn&#39;t change the way the code works, but how it&#39;s implemented. It&#39;s not &#34;hard to review&#34; since both implementation are equally valid. But the new implementation will make it easier for the change to be made.</p><p>Finally, write the test and make it pass. It should be relatively short and to the point. That also makes the commit easier to read.</p><p><strong>Therefore I&#39;d go for the 3rd option too</strong>. Maybe I&#39;d even have multiple refactoring commits. Or I&#39;d squash them into one before pushing that for review, so there&#39;s only one. Or maybe I&#39;d do a first PR that&#39;s only refactoring, then a second that&#39;s only the feature. It really depends on how much refactoring is needed (keep your PRs short) and your team conventions!</p><blockquote><p>If the only value of the refactoring is for test, and the test are in a future commit, you need to go back and forth between the two to understand why it was done and if it could have been done better</p></blockquote><p>To solve this problem, you need to get your team comfortable in this approach: refactor first, then implement the feature.</p><p>I&#39;d suggest you to discuss it with your colleagues and try that out. I&#39;d also recommend you try to <strong>practice &#34;over-committing&#34; to get you in the habit of doing smaller commits</strong>. It&#39;s a useful skill to have when code is tricky, so it&#39;s a great exercise to do when code is not!</p><p>In any case, I think you&#39;ve healthy discussion with your colleagues. No doubt you&#39;ll find what works for your team!</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../git-strategy-for-code-review-before-merge-to-master-from-feature-branches/'>Git &#8211; Strategy for code review before merge to master from feature branches</a></li><li class="list-group-item"><a href='../git-why-arent-there-cherry-pick-requests/'>Git &#8211; Why aren&#8217;t there cherry-pick requests</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>