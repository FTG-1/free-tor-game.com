<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>How to avoid implementing the Event Sourced projections twice &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1083167 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1083167" class="post-1083167 software type-software status-publish hentry category-software tag-domain-driven-design tag-event-sourcing"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">How to avoid implementing the Event Sourced projections twice</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">domain-driven-design</span><span class="mr-2 badge badge-info">event-sourcing</span></p><div class="entry-content"><p>I&#39;m currently teaching myself event sourcing and have got the concept enough to start developing a dummy app in C# and EventStore. My app is an easy-to-understand bank account system.</p><p>If we model a bank account as a series of withdrawal and deposit events then we can easily calculate the account&#39;s current balance by adding up all the deposits and subtracting all the withdrawals, and EventStore gives us a way to implement this in the data store using <a href="https://eventstore.org/blog/20130212/projections-1-theory/" rel="noreferrer">projections</a>.</p><p>However, if we have a business rule that dictates that accounts can never go overdrawn (i.e. we must reject requests to withdraw from an account if the current balance is insufficient to cover the requested funds), then our BankAccount entity also needs to know its current balance.</p><p>Again, this is easy to calculate by running over the series of bank account events but I have a deep unease with the fact that I have had to implement my projection of &#34;balance&#34; twice: once in the data store and once in the domain.</p><p>Is this expected from Event Sourcing, and I shouldn&#39;t worry about it? Or am I going down the wrong path, and in fact the balance should not be calculated in the domain code and should instead be retrieved from the data store every time it is required? This means that a round trip to the data store would be required every time an entity is modified.</p><p>I&#39;ve seen in Greg Young&#39;s talks that it&#39;s supposed to be a natural fit for DDD so there shouldn&#39;t be an incompatibility there.</p><p>If I&#39;ve misunderstood any part of this set up then any help would be greatly appreciated.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>Your event log is your only source of truth. You cannot trust the data in the projections, because it is eventually consistent and does not have to be up-to-date. As you have mentioned, you can indeed get the latest state of your domain entity by reading all events related to that one specific entity and flatting them to your final representation.</p><p>So if an account can never be overdrawn, you need to know its balance, you need to calculate it in your domain object from the event stream. This is not only recommended but necessary.</p><p>Of course, if your projections are as simple as being the latest (eventually consistent) state representation of your entities, it might seem you are duplicating logic. However, the latest state of an entity is in most cases not <em>the only</em> representation of the entity, i.e. how you&#39;d like to view it the data.</p><p>For different purposes you may (and with large systems are likely to) have different projections. Some can be entities, but other projections may be entire aggregations. With these aggregations you could then use an <code>MoneyWasDeposited</code> event from all <code>BankAccount</code> entities to update a monthly cashflow to see how much money is actually flowing through your system.</p><p>The strength of projections comes at the time when you find out you need different representations of - internally - the same data. Thanks to projection pre-building, increasing complexity of the view does not slow down load times for end users.</p><hr/><p>To followup on VoiceOfUnreason&#39;s answer, while e.g. sharing the logic for balance calculation makes sense in terms of DRY principle (so that you don&#39;t repeat yourself), when actually practicing ES, I have learned it mostly does not.</p><p>An event might look like this:</p><pre><code>class MoneyWasDeposited: IEvent
{
    public BankAccountId ToBankAccountId;
    public Money Amount;
}
</code></pre><p>An event sourced aggregate then usually processed this event using a similar mechanism to this:</p><pre><code>class BankAccount
{
    private BankAccountId id;
    private Money currentBalance;

    public void ReplayFromEvents(List&lt;IEvent&gt; events)
    {
        for (var event in Events)
        {
            ApplyEvent(event);
        }
    }

    private void ApplyEvent(IEvent event)
    {
        if (event is MoneyWasDeposited)
        {
            currentBalance = currentBalance.Add(event.Amount);
        }
    }
}
</code></pre><p>while your projection is actually likely to look something like this:</p><pre><code>class BankAccountProjection
{
    private MySqlConnection database;

    public void HandleMoneyWasDeposited(MoneyWasDeposited event)
    {
        var statement = database.Prepare(&#34;
            UPDATE
                bank_accounts
            SET balance = balance + :depositedAmount
            WHERE id = :id
        &#34;);

        statement.BindValue(&#34;depositedAmount&#34;, event.Amount.Value);
        statement.BindValue(&#34;id&#34;, event.ToBankAccountId.ToString());

        statement.ExecuteNoResult();
    }
}
</code></pre><p>So while your aggregate calculates the value in code from the event, the projection usually applies the change directly to your read-model store and let&#39;s the storage engine take care of the data modification.</p><p>As you can see, there&#39;s really no way to reduce duplication with this anymore, because the aggregate and projection use vastly different mechanisms to achieve the desired result.</p><p>Now, I am not saying you couldn&#39;t pull out the entire projection from the read-model store, update the read-model in memory and dump it back for update, but it&#39;s usually not the way how it&#39;s done, as it adds one unnecessary <code>SELECT</code> and achieves virtually the same result anyway.</p><hr/><p><strong>You may ask:</strong> The balance calculation logic is not in a single place. So what if someone, by accident, makes the logic in the projection incorrect?</p><p>Consider the scenario that somebody wrote a minus sign to the projections&#39; balance update when money was deposited. This would mean that every time you deposited money to your account, you would suddenly have less.</p><p>You would then do the following steps:</p><ul><li>change the minus sign to a plus sign in the projection method,</li><li>push the change immediately to production, so that all changes from now on are ok,</li><li>create a new projection index in your read-model store, e.g. <code>bank_accounts_fixed</code>,</li><li>run another instance of bank account projection manager from the inception of your system and insert data into <code>bank_accounts_fixed</code> instead,</li><li>after the local projection finishes running, swap configuration on production to use the <code>bank_accounts_fixed</code> data in place of the <code>bank_accounts_fixed</code>,</li><li>delete the original <code>bank_accounts</code> index.</li></ul><p>And all your user&#39;s will suddenly see correct balances. You can do this because you know that the data in your event store is guaranteed to be correct (it should be).</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../architecture-event-sourcing-sagas-bus-and-eventual-consistency/'>Architecture &#8211; Event Sourcing , sagas, bus and eventual consistency</a></li><li class="list-group-item"><a href='../rewrite-events-in-eventstore/'>Rewrite Events in EventStore</a></li><li class="list-group-item"><a href='../event-sourcing-one-event-state-of-two-aggregates-changed/'>Event sourcing, one event, state of two aggregates changed</a></li><li class="list-group-item"><a href='../using-event-sourced-aggregate-roots-with-the-specification-pattern/'>Using Event Sourced Aggregate Roots with the Specification Pattern</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>