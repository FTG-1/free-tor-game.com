<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Immutable structures and deep composition hierarchy &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1078095 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1078095" class="post-1078095 software type-software status-publish hentry category-software tag-design-patterns tag-immutability"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Immutable structures and deep composition hierarchy</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">design-patterns</span><span class="mr-2 badge badge-info">immutability</span></p><div class="entry-content"><p>I&#39;m developing a GUI application, heavily working with graphics &#8211; you can think about it as a vector editor, for the sake of the example. It is very tempting to make all data structures immutable &#8211; so I could get undo/redo, copy/paste, and many other things almost without effort.</p><p>Fot the sake of simplicity, I will use the following example &#8211; application is used to edit polygonal shapes, so I have &#34;Polygon&#34; object, which is simply list of immutable points:</p><pre><code>Scene -&gt; Polygon -&gt; Point
</code></pre><p>And so I have only one mutable variable in my program &#8211; the one which holds current Scene object. The problem which I have starts when I try to implement point dragging &#8211; in mutable version, I simply grab a <code>Point</code> object and start modifying its coordinates. In immutable version &#8211; I am stuck. I could have stored indices of <code>Polygon</code> in current <code>Scene</code>, index of dragged point in <code>Polygon</code>, and replace it every time. But this approach does not scale &#8211; when composition levels go to 5 and further, boilerplate would become unbearable.</p><p>I&#39;m sure this problem can be solved &#8211; after all, there is Haskell with completely immutable structures and IO monad. But I just cannot find how.</p><p>Can you give me a hint?</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><blockquote><p>I could have stored indices of Polygon in current Scene, index of dragged point in Polygon, and replace it every time. But this approach does not scale - when composition levels go to 5 and further, boilerplate would become unbearable.</p></blockquote><p>You&#39;re absolutely right, this approach doesn&#39;t scale <em>if you can&#39;t get around the boilerplate</em>. Specifically, the boilerplate for creating a whole new Scene with a tiny subpart changed. However, many functional languages provide a construct for dealing with this sort of nested structure manipulation: lenses.</p><p>A lens is basically a getter and setter for immutable data. A lens has a <em>focus</em> on some small part of a larger structure. Given a lens, there are two things you can do with it - you can <em>view</em> the small part of a value of the larger structure, or you can <em>set</em> the small part of a value of a larger structure to a new value. For example, suppose you have a lens that focuses on the third item in a list:</p><pre><code>thirdItemLens :: Lens [a] a
</code></pre><p>That type means the larger structure is a list of things, and the small subpart is one of those things. Given this lens, you can view and set the third item in the list:</p><pre><code>&gt; view thirdItemLens [1, 2, 3, 4, 5]
3
&gt; set thirdItemLens 100 [1, 2, 3, 4, 5]
[1, 2, 100, 4, 5]
</code></pre><p>The reason lenses are useful is because they are <em>values</em> representing getters and setters, and you can abstract over them the same way you can other values. You can make functions that return lenses, for instance a <code>listItemLens</code> function which takes a number <code>n</code> and returns a lens viewing the <code>n</code>th item in a list. Additionally, lenses can be <em>composed</em>:</p><pre><code>&gt; firstLens = listItemLens 0
&gt; thirdLens = listItemLens 2
&gt; firstOfThirdLens = lensCompose firstLens thirdLens
&gt; view firstOfThirdLens [[1, 2], [3, 4], [5, 6], [7, 8]]
5
&gt; set firstOfThirdLens 100 [[1, 2], [3, 4], [5, 6], [7, 8]]
[[1, 2], [3, 4], [100, 6], [7, 8]]
</code></pre><p>Each lens encapsulates behavior for traversing one level of the data structure. By combining them, you can eliminate the boilerplate for traversing multiple levels of complex structures. For instance, supposing you have a <code>scenePolygonLens i</code> that views the <code>i</code>th Polygon in a Scene, and a <code>polygonPointLens n</code> that views the <code>nth</code> Point in a Polygon, you can make a lens constructor for focusing on just the specific point you care about in an entire scene like so:</p><pre><code>scenePointLens i n = lensCompose (polygonPointLens n) (scenePolygonLens i)
</code></pre><p>Now suppose a user clicks point 3 of polygon 14 and moves it 10 pixels right. You can update your scene like so:</p><pre><code>lens = scenePointLens 14 3
point = view lens currentScene
newPoint = movePoint 10 0 point
newScene = set lens newPoint currentScene
</code></pre><p>This nicely contains all the boilerplate for traversing and updating a Scene inside <code>lens</code>, all you have to care about is what you want to change the point to. You can further abstract this with a <code>lensTransform</code> function that accepts a lens, a target, and a <em>function</em> for updating the view of the target through the lens:</p><pre><code>lensTransform lens transformFunc target =
  current = view lens target
  new = transformFunc current
  set lens new target
</code></pre><p>This takes a function and turns it into an &#34;updater&#34; on a complicated data structure, applying the function to only the view and using it to construct a new view. So going back to the scenario of moving the 3rd point of the 14th polygon to the right 10 pixels, that can be expressed in terms of <code>lensTransform</code> like so:</p><pre><code>lens = scenePointLens 14 3
moveRightTen point = movePoint 10 0 point
newScene = lensTransform lens moveRightTen currentScene
</code></pre><p>And that&#39;s all you need to update the whole scene. This is a very powerful idea and works very well when you have some nice functions for constructing lenses viewing the pieces of your data you care about.</p><p>However this is all pretty out-there stuff currently, even in the functional programming community. It&#39;s difficult to find good library support for working with lenses, and even more difficult to explain how they work and what the benefits are to your coworkers. Take this approach with a grain of salt.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../do-immutable-objects-and-ddd-go-together/'>Do immutable objects and DDD go together</a></li><li class="list-group-item"><a href='../c-using-the-decorator-pattern-in-a-deep-class-hierarchy/'>C++ &#8211; Using the decorator pattern in a deep class hierarchy</a></li><li class="list-group-item"><a href='../difference-between-immutable-and-const/'>Difference between immutable and const</a></li><li class="list-group-item"><a href='../java-when-and-why-would-we-use-immutable-pointees/'>Java &#8211; When and why would we use immutable pointees</a></li><li class="list-group-item"><a href='../java-understanding-the-difference-between-mutable-and-immutable-classes/'>Java &#8211; Understanding the difference between mutable and immutable classes</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>