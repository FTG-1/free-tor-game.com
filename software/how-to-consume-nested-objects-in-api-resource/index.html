<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="https://free-tor-game.com/wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>How to consume nested objects in API resource &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.min.js?ver=11.2.0' id='highlight-js'></script>     <script>( function( w, d, s, l, i ) {
				w[l] = w[l] || [];
				w[l].push( {'gtm.start': new Date().getTime(), event: 'gtm.js'} );
				var f = d.getElementsByTagName( s )[0],
					j = d.createElement( s ), dl = l != 'dataLayer' ? '&l=' + l : '';
				j.async = true;
				j.src = 'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
				f.parentNode.insertBefore( j, f );
			} )( window, document, 'script', 'dataLayer', ' ' );</script>      <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1071763 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="https://free-tor-game.com/3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="https://free-tor-game.com/contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1071763" class="post-1071763 software type-software status-publish hentry category-software tag-angular2 tag-asp-net tag-web-api"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">How to consume nested objects in API resource</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">angular2</span><span class="mr-2 badge badge-info">asp.net</span><span class="mr-2 badge badge-warning">web-api</span></p><div class="entry-content"><p>I am building my first web application, it links to the serverside through RESTfull Web API (Angular on client side, ASP.Net Core and EF Core on serverside, Automapper to map API Resources to/from domain models).<br /> In the application I have two main models (simplified below as <code>Delivery</code> and <code>Order</code>) and each has its own API controller and endpoint (<code>api/deliveries</code> and <code>api/orders</code>).  The business rules are such that: 1. an <code>Order</code> can be created before <code>Delivery</code> exists, 2. <code>Delivery</code> can hold an array of <code>Order</code> that will be included in the delivery, 3. <code>Order</code> can be amended after being included in <code>Delivery</code>.</p><p>My domain models (API resources are close to identical):</p><pre class="lang-c prettyprint-override"><code>public class Delivery
{
    public int Id { get; set; }
    public Customer Customer { get; set; }
    public Address Address { get; set; }
    public DateTime EstimatedDelivery { get; set; }
    public DeliveryOrder[] Orders { get; set; }
}

public class Order
{
    public int Id { get; set; }
    public Product Product { get; set; }
    public int Quantity { get; set; }
}

public class DeliveryOrder
{
    public int DeliveryId { get; set; }
    public Delivery Delivery { get; set; }
    public int OrderId { get; set; }
    public Order Order { get; set; }
}
</code></pre><p>The client user interface has a view to create/amend <code>order</code> (instance of <code>Order</code>) and a view to create/amend <code>delivery</code> (instance of <code>Delivery</code>) which includes the ability to create/amend <code>orders</code>.<br /> As a result of the business rules, in the <code>delivery</code> view, I could update <code>order</code> individually and directly, or update <code>delivery.orders</code>.  I am struggling to come to a suitable implementation.</p><p>An example of what the <code>delivery</code> object looks like on client side, with the first <code>order</code> being an existing order and the second <code>order</code> being a  new order:</p><pre class="lang-js prettyprint-override"><code>{
    &#34;id&#34;: 5,
    &#34;customer&#34;: {
        &#34;id&#34;: 15,
        &#34;name&#34;: &#34;Jane&#34;
    },
    &#34;address&#34;: {
        &#34;street&#34;: &#34;Something Ave&#34;,
        &#34;number&#34;: &#34;145&#34;
    },
    &#34;estimatedDelivery&#34;: &#34;2019-05-21T13:28:06.419&#34;,
    &#34;orders&#34;: [
        {
            &#34;orderId&#34;: 6,
            &#34;order&#34;: {
                &#34;id&#34;: 6,
                &#34;product&#34;: {
                    &#34;id&#34;: 112,
                    &#34;categoryId&#34;: 36
                },
                &#34;quantity&#34;: 4
            }
        },
        {
            &#34;order&#34;: {
                &#34;product&#34;: {
                    &#34;id&#34;: 115,
                    &#34;categoryId&#34;: 36
                },
                &#34;quantity&#34;: 6
            }
        }
    ]
}
</code></pre><p>Solutions I have considered:</p><p><strong>First</strong>. In the view (Angular component) for <code>delivery</code> have two steps in a &#34;save&#34; action.  In this case I need to check if order has an <code>id</code> or not and either <code>put</code> an amended <code>order</code> or <code>post</code> a new <code>order</code> to my <code>api/orders</code>.  In this case my <code>Delivery</code> API (through Automapper profile) ignores <code>Delivery.Orders.Order</code> and only compares values of <code>Delivery.Orders.OrderId</code>.  My client action would look similar to:</p><pre class="lang-js prettyprint-override"><code>saveAction() {
    delivery.orders.forEach(o =&gt; {
        if (o.order.id) { this.httpClient.put(&#39;api/orders/&#39; + o.order.id, o.order).subscribe( ... ); } 
        else { this.httpClient.post(&#39;api/orders/&#39;, o.order).subscribe( ... ) });
    this.httpClient.put(&#39;api/deliveries&#39; + delivery.id, delivery).subscribe( ... );
}
</code></pre><p>Reading from other topics I understand it is <a href="https://stackoverflow.com/a/42334629">not recommended</a> to create multiple HTTP requests with a for loop to manage the number of subscriptions.  Perhaps this is less of an issue if the subscriptions are combined in a forkJoin?</p><p><strong>Second</strong>. Instead of deciding wether a specific <code>order</code> existed before the save action, send the whole <code>delivery.orders</code> to the api and let the serverside decide on whether instances of <code>Order</code> need to be created or amended.  In that case I would <code>patch</code> the whole array, as <a href="https://stackoverflow.com/a/28720881">discussed here</a>.  Again, my <code>Delivery</code> API (through Automapper profile) ignores <code>Delivery.Orders.Order</code> and only compares values of <code>Delivery.Orders.OrderId</code>.  The saving action would look something like:</p><pre class="lang-js prettyprint-override"><code>saveAction() {
    this.httpClient.patch(&#39;api/orders/&#39; delivery.orders).subscribe(data =&gt; {
            delivery.orders = data;
            this.httpClient.put(&#39;api/deliveries&#39; + delivery.id, delivery).subscribe( ... )
        });
}
</code></pre><p>Because this would require work on my serverside, I thought maybe it would be better to manage the whole thing on my serverside, which is the third solution I am considering.</p><p><strong>Third</strong>: Let the server side consume <code>Delivery.Orders</code> in full and do a custom mapping so that the members in <code>Delivery.Orders.Order</code> are correctly amended or created.  This could be done in either the <code>Delivery</code> controller or perhaps in a <code>MappingProfile</code>.  The data is then simply sent through:</p><pre class="lang-js prettyprint-override"><code>saveAction() {
    this.httpClient.put(&#39;api/deliveries&#39; + delivery.id, delivery).subscribe(data =&gt; delivery = data);
}
</code></pre><p><strong>Question(s)</strong>: I have never done this and I don&#39;t feel confident about any of my solutions.  Does my third solution make most sense, or should I not have <code>Delivery</code> API endpoint take responsibility of creating/amending the nested <code>Order</code>?  Is there a design pattern that is considered best practice or at least more commonly used than what I have thought of?</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>I am treating the <code>Delivery</code> which is a physical shipment as separate to the <code>DeliveryInstructions</code> which are the address, contact, time, etc...</p><p><strong>Does Order depend on Delivery?</strong></p><p>In your case it appears that an <code>Order</code> can be made independently of a <code>Delivery</code>.</p><p>There for <code>Order</code> should be its own API end-point.</p><p><strong>Is Delivery really delivering orders, or products on an Order?</strong></p><p>I know this is not what you asked, but there is a semantic lurking down there. Either:</p><ul><li>An order should not be altered when it is being delivered (how on earth are you going to add the plushie, or remove the socks when its on the truck?)</li><li>The individually ordered products are sent in a Delivery, and the order can only remove undelivered items, or add new items to the order (for subsequent and separate delivery).</li></ul><p>In the first case <code>Delivery</code> does not hold <code>Order</code> objects, simply a reference to them (like an identifier or a url).</p><p>In the second case the <code>Delivery</code> refers to a set of line items on an <code>Order</code>. Those Line items also refer to their order/delivery.</p><p><strong>Transactionality</strong></p><p>Who is responsible for transactionally updating a set of objects on the server?</p><p>You could make a workflow, which essentially performs a single update on a single url at a time. Each transform should always leave the system in a consistent state (even if its not the desired end state).</p><p>You could drive this workflow from the client:</p><ul><li>You run the risk of the client timing out</li><li>Customers might be a little upset if their order isn&#39;t actioned if you display that it has been on their UI.</li></ul><p>You could pass this workflow to the server, something like <code>/request</code>.</p><ul><li>You will need to provide an api for monitoring progress of the workflow.</li><li>You will need to provide several UI views for observing progress.</li><li>However once received the client can disconnect, and your service will still follow through.</li></ul><p>Of course if you are passing it directly to the server you could simply perform the request inline.</p><ul><li>No need to provide a progress UI.</li><li>The update can be done in a single SQL/NoSQL transaction.</li><li>The workflow cannot take too long as it will tie up WebServer Threads/Client Connections.</li></ul><p>Take your pick on what works best for you.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='https://free-tor-game.com/software/rest-api-resource-ownership/'>REST API: Resource Ownership</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/rest-designing-a-rest-api-with-resource-relationships/'>Rest &#8211; Designing a REST API with resource relationships</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='http://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="https://free-tor-game.com/wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>