<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Mvc &#8211; ASP.NET MVC: where to put data-entry logic which hits the database &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1086285 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1086285" class="post-1086285 software type-software status-publish hentry category-software tag-asp-net-mvc tag-mvc tag-validation"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Mvc &#8211; ASP.NET MVC: where to put data-entry logic which hits the database</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">asp.net-mvc</span><span class="mr-2 badge badge-info">mvc</span><span class="mr-2 badge badge-warning">validation</span></p><div class="entry-content"><p>We do simple data entry validation with attributes on the viewmodel. Think format of an email address, mandatory clientname, format of a date, the housenumber being numeric etc.</p><p>Now there are also more complex validations which will hit the database and external services: check if the id is a valid one (external service), see if the person (probably) already is present in the database based on name/address (database action), check the address/zip code combination (external service).</p><p>In my opinion this logic should not be in the controller but in a separate validation component / validation service (which gets DI&#39;d in the controller).</p><p>I would like your opinion on this.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p><strong>Disclaimer</strong>: The following is my approach and not holy scripture. I&#39;m at work so I wrote this swiftly and some code may not work/compile!</p><h1>Controllers</h1><p>They are components of the presentation layer so they shouldn&#39;t be concerned with business or database logic. Validation logic is a subset of business logic.</p><h1>Services</h1><p>I implement the Service Layer pattern which is basically a bunch of classes that are loosely associated with your domain models and act upon them. These service classes do all of the business logic. This includes the database stuff. If you&#39;re not too keen on putting database logic here you can implement the Repository pattern and inject the repository classes into your service classes.</p><p>So now the flow of things is becoming clear</p><pre><code>Controller -&gt; Service -&gt; Repository
</code></pre><p>and this equates to</p><pre><code>ViewModel to Model mapping -&gt; Validation and other business logic -&gt; CRUD operations
</code></pre><p>Every service class is described by an interface so now you can use DI to inject them into your Controllers like so:</p><pre class="lang-cs prettyprint-override"><code>readonly IClientService _clientService;

public ClientsController(IClientService clientService)
{
    _clientService = clientService;
}
</code></pre><p>It&#39;s now clear exactly what dependencies your Controller has since it&#39;s all there in the constructor. The Controllers are also cleaner since all of the business logic is in the service layer. Here&#39;s an insert example:</p><pre class="lang-cs prettyprint-override"><code>[HttpPost]
public ActionResult Insert(ClientViewModel viewModel)
{
    if (!ModelState.IsValid)
        return View(viewModel);

    var client = new Client();
    viewModel.MapTo(client);
    _clientService.Insert(client);

    return View(viewModel);
}
</code></pre><h1>Now the validation part</h1><p>The type of validation that constitutes checking the database is what I call deep validation. I put simple (shallow) validation in the ViewModel (like yourself) and deep validation in the business layer aka services.</p><p>So the deep validation that needs to take place when you insert a <code>Client</code> is found in the <code>Insert</code> method of the <code>ClientService</code>. All the database checks are done there, maybe by calling a repository or just directly in the service if you&#39;re not using repositories.</p><p>So if the <code>client</code> is invalid how do we return the validation errors back to the Controller?</p><p>We throw an exception since that&#39;s what exceptions are for. But it&#39;s going to be our own custom exception:</p><pre class="lang-cs prettyprint-override"><code>public class MyException : Exception
{
    public MyException()
    {
    }

    public MyException(string message)
        : base(message)
    {
    }

    public MyException(string message, Exception inner)
        : base(message, inner)
    {
    }
}
</code></pre><p>So when things are invalid (in our <code>ClientService</code>):</p><pre class="lang-cs prettyprint-override"><code>public void Insert(Client client)
{
    if (client == null)
    {
        throw new MyException(&#34;This thing&#39;s not right..&#34;);
    }
</code></pre><p>We&#39;ve made sure the insert failed at the soonest possible moment, which is good.</p><p>Now all that&#39;s left is to catch these custom exceptions in our Controller. You can do this many ways. One is to use <code>try/catch</code> clauses:</p><pre class="lang-cs prettyprint-override"><code>try
{
    _clientService.Insert(client);
}
catch (MyException e)
{
    // Add error to ModelState perhaps
}
</code></pre><p>but they will thoroughly litter your Controller.</p><p>The proper MVC approach is to catch all the errors in the <code>OnException</code> method of your Controller:</p><pre class="lang-cs prettyprint-override"><code>protected override void OnException(ExceptionContext exceptionContext)
{
    exceptionContext.ExceptionHandled = true;

    if (exceptionContext.Exception is MyException)
    {
        // Perhaps add to ModelState
    }
    else
    {
        // Add a generic error message to ModelState and log error
    }

    filterContext.Result = new ViewResult
    {
        ViewName = ...
    };
}
</code></pre><p>You can put this code in a <code>BaseController</code> from which all of your other Controllers will inherit in order to avoid code duplication.</p><hr/><p>That&#39;s the basic framework I work in. I hope I didn&#39;t make things too complicated or confusing.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../c-command-handlers-and-ddd/'>C# &#8211; Command handlers and DDD</a></li><li class="list-group-item"><a href='../c-best-way-of-validating-class-properties/'>C# &#8211; Best way of validating Class properties</a></li><li class="list-group-item"><a href='../where-to-put-format-validation-in-a-cqrs-stylish-domain-model/'>Where to put format validation in a CQRS “stylish” domain model</a></li><li class="list-group-item"><a href='../mvc-where-to-put-user-interface-domain-model-manipulation-logic-transferring-data-from-the-view-to-domain-model/'>Mvc &#8211; Where to put User Interface/Domain Model manipulation logic (transferring data from the view to Domain Model)</a></li><li class="list-group-item"><a href='../in-a-domain-driven-development-ddd-have-a-validation-on-a-dto-that-calls-a-external-service-is-wrong-if-yes-where-should-it-be/'>In a Domain Driven Development DDD, have a validation on a DTO that calls a external service is wrong, if yes, where should it be</a></li><li class="list-group-item"><a href='../mvc-in-mvc-soa-architecture-what-is-the-rationale-for-placing-business-logic-in-models/'>Mvc &#8211; In MVC + SOA Architecture, What is the Rationale for Placing Business Logic in Models</a></li><li class="list-group-item"><a href='../ddd-and-mediatr-where-the-validation-and-business-logic-go/'>DDD and MediatR &#8211; where the Validation and Business Logic go</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>