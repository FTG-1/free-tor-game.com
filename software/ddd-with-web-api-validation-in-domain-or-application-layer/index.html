<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>DDD with web api, validation in domain or application layer &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1084812 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1084812" class="post-1084812 software type-software status-publish hentry category-software tag-asp-net-core tag-asp-net-mvc tag-domain-driven-design"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">DDD with web api, validation in domain or application layer</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">asp.net-core</span><span class="mr-2 badge badge-info">asp.net-mvc</span><span class="mr-2 badge badge-warning">domain-driven-design</span></p><div class="entry-content"><p>I saw a lot of discussion, but I don&#39;t know how to do it in a real world.<br /> I understand that validation duplication in the client and server is needed.<br /> But how to elegantly validate in server and return friendly messages to client.</p><p>I have a value object like this, it has some business rules.</p><pre><code>public class OrderId : ValueObject&lt;OrderId&gt;
{
    public string Value { get; }

    public OrderId(string value)
    {
        if (string.IsNullOrWhiteSpace(value) || value.Length &gt; 50)
        {
            throw new ArgumentException(nameof(value), &#34;error message here&#34;);
        }

        Value = value;
    }
}
</code></pre><p>The command send by the client.</p><pre><code>public class CreateInvoiceCommand : IRequest
{
    public string OrderId { get; set; }
}
</code></pre><p>The application layer will create value object, but if command violates business rules, it will throw exception, this is not friendly to the client, imagine there are more business rules here, it will only return the first rule.</p><pre><code>public class CreateInvoiceCommandHandler : IRequestHandler&lt;CreateInvoiceCommand&gt;
{
    public Task&lt;Unit&gt; Handle(CreateInvoiceCommand command, CancellationToken cancellationToken)
    {
        var orderId = new OrderId(command.OrderId);

        return Task.FromResult(Unit.Value);
    }
}
</code></pre><p>So I validate the command when the request arrived. With FluentValidation, it can return friendly messages to client.</p><pre><code>public class CreateInvoiceCommandValidator : AbstractValidator&lt;CreateInvoiceCommand&gt;
{
    public CreateInvoiceCommandValidator()
    {
        RuleFor(c =&gt; c.OrderId).NotEmpty().MaximumLength(50);
        //Other rules...
    }
}
</code></pre><p>My question is, is there a way to solve the duplication and return friendly messages?</p><p>Should I remove the business rules in value object to avoid DRY, is this still DDD?</p><p><strong>UPDATE</strong></p><p>According to the <a href="https://softwareengineering.stackexchange.com/a/396335/343655">answer</a> and <a href="https://enterprisecraftsmanship.com/2016/09/13/validation-and-ddd/" rel="nofollow noreferrer">this</a>, I tried something.</p><p>Now, the value object looks like this</p><pre><code>public class OrderId : ValueObject&lt;OrderId&gt;
{
    public string Value { get; }

    public OrderId(string value)
    {
        if (!CanCreate(value, out var errorMessages))
        {
            throw new ArgumentException(nameof(value), string.Join(&#34;.&#34;, errorMessages));
        }

        Value = value;
    }

    public static bool CanCreate(string orderId, out List&lt;string&gt; errorMessages)
    {
        errorMessages = new List&lt;string&gt;();

        if (string.IsNullOrWhiteSpace(orderId))
        {
            errorMessages.Add(&#34;can not be null or empty&#34;);
        }

        if (orderId?.Length &gt; 50)
        {
            errorMessages.Add(&#34;should not be longer than 50 characters&#34;);
        }

        return errorMessages.Count == 0;
    }
}
</code></pre><p>The validator</p><pre><code>public class CreateInvoiceCommandValidator : AbstractValidator&lt;CreateInvoiceCommand&gt;
{
    public CreateInvoiceCommandValidator()
    {
        RuleFor(c =&gt; c.OrderId).IsOrderId();
    }
}

public static class ValidatorExtensions
{
    public static IRuleBuilderInitial&lt;T, string&gt; IsOrderId&lt;T&gt;(this IRuleBuilder&lt;T, string&gt; ruleBuilder)
    {
        return ruleBuilder.Custom((orderId, context) =&gt;
        {
            if (!OrderId.CanCreate(orderId, out var errorMessages))
            {
                foreach (var errorMessage in errorMessages)
                    context.AddFailure($&#34;&#39;{context.DisplayName}&#39; &#34; + errorMessage);
            }
        });
    }
}
</code></pre><p>This solves my problem, but it&#39;s just a simple example, I&#39;m not sure if this makes the value object too complicated when I have more business rules.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>Validations are definitely in the domain layer. All domain related validations are to be deeply embedded in Aggregates, Entities, and Value Objects. And raising Exceptions is generally considered a suitable mechanism for bubbling up errors (instead of custom messages or error codes).</p><p>However, you wouldn&#39;t want to let the exception bubble up to the client.</p><p>My solution in the past to this problem has been to <strong>return a <code>errors</code> hash.</strong></p><p>For example, say the Command Handler (or Application Service, as I would call it) invokes a method in the Aggregate, The Aggregate handles initialization of enclosed entities and value objects. Then the aggregate is the best place to catch exceptions and populate the <code>errors</code> hash.</p><p>The validations could be in constructors, custom validator classes, or can even be explicitly invoked. But after running all validations, the code checks if the <code>errors</code> hash is empty. If it is not, returns immediately to the callee with the hash.</p><p>The Application Service or Command Handler can then either return the errors as-is to the Controller to package and return to the client. Or it could even construct a custom domain-specific <code>Response</code> object with errors embedded.</p><p>Whichever you choose, the <code>errors</code> hash could be something like this:</p><pre><code>{
    &#39;email&#39;: [
        &#39;is required&#39;
    ],
    &#39;username&#39;: [
        &#39;can not be the same as email&#39;,
        &#39;should not be longer than 254 characters&#39;
    ],
    &#39;password&#39;: [
        &#39;should contain at least one number&#39;,
        &#39;should contain at least one special character&#39;,
        &#39;cannot be a dictionary word&#39;
    ]
}
</code></pre><p>This structure is the most basic format, but you can add complexity as necessary. For instance, you can embed error codes instead of English messages, if your application is a multi-lingual system.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../ddd-architecture-in-a-mvc-web-application/'>DDD Architecture in a MVC web application</a></li><li class="list-group-item"><a href='../in-ddd-is-validation-application-logic-or-domain-logic/'>In DDD, is validation application logic, or domain logic</a></li><li class="list-group-item"><a href='../c-how-to-avoid-double-data-validation-in-an-application-with-web-interface/'>C# &#8211; How to avoid double data validation in an application with web interface</a></li><li class="list-group-item"><a href='../c-clean-architecture-with-c-a-better-design-to-perform-validation-in-value-objects/'>C# &#8211; Clean architecture with C#: A better design to perform validation in Value Objects</a></li><li class="list-group-item"><a href='../ending-up-with-too-many-services-in-ddd/'>Ending up with too many services in DDD</a></li><li class="list-group-item"><a href='../ddd-and-mediatr-where-the-validation-and-business-logic-go/'>DDD and MediatR &#8211; where the Validation and Business Logic go</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>