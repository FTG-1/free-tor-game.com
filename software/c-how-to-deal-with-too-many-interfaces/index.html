<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>C# &#8211; How to deal with too many interfaces &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1080840 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1080840" class="post-1080840 software type-software status-publish hentry category-software tag-c tag-design tag-mvc"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">C# &#8211; How to deal with too many interfaces</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">c</span><span class="mr-2 badge badge-info">design</span><span class="mr-2 badge badge-warning">mvc</span></p><div class="entry-content"><p>I am looking at updating some of my companies existing code to allow unit tests to be implemented.  To be able to do this, all repositories are being interfaced to allow DI.  However, the existing code has a habit of creating 1 repository class per table in the database, meaning that one section of business logic may need to query 5 different repositories classes.</p><p>Passing in 5+ interfaces using DI seems messy and I am looking for help on how to redesign this.</p><p>This is all for an MVC 5 C# site, and an example of it is below (I have reduced the code size so that it is easier to read).</p><p>We have our controller for Account, which in this scenario manages the user sessions:</p><pre><code>public class AccountController : Controller
{
    private AccountLogic _accountLogic { get; set; }

    public AccountController(
        ISessionRepository sessionRepository, 
        ILoginRepository loginRepository)
    {
        _accountLogic = new AccountLogic(sessionRepository, loginRepository);
    }

    public IActionResult Index()
    {
        return View();
    }

    public IActionResult Login()
    {
        return View();
    }

    public IActionResult Login(LoginModel loginModel)
    {
        if (ModelState.IsValid)
        {
            if (_accountLogic.DoesUserExist(loginModel.Username))
            {
                var existingHash= _accountLogic.GetPassword(loginModel.Username);

                if (Hash.VerifyPassword(loginModel.Password, existingHash))
                {
                    // Set Auth Cookies

                    return RedirectToAction(&#34;Index&#34;, &#34;Home&#34;);
                }
                else
                {
                    ModelState.AddModelError(
                        &#34;Username&#34;, 
                        &#34;Sorry, we did not recognize &#34; +
                            &#34;either your username or password&#34;);
                }
            }
        }
        return View(loginModel);
    }
}
</code></pre><p>The Team tries to reduce the size of the controller by having a business class perform most of the actions.  What this actually means is that the business class is very large and has many responsibilities as it has to be passed an interface for all of the repositories it has to query.  In the example shown, we pass in both the Session and Login repositories, each of this is solely responsible for their corresponding tables in the database.</p><pre><code>public class AccountLogic
{
    private ISessionRepository _sessionRepository { get; set; }
    private ILoginRepository _loginRepository { get; set; }

    public AccountLogic(
        ISessionRepository sessionRepository, 
        ILoginRepository loginRepository)
    {
        _sessionRepository = sessionRepository;
        _loginRepository = loginRepository;
    }

    public Guid CreateSession(int loginID, string userAgent, string locale)
    {
        return _sessionRepository.CreateSession(loginID, userAgent, locale);
    }

    public Session GetSession(Guid sessionKey)
    {
        return _sessionRepository.GetSession(sessionKey);
    }

    public void EndSession(Guid sessionKey)
    {
        _sessionRepository.EndSession(sessionKey);
    }

    public bool DoesUserExist(string username)
    {
        return _loginRepository.DoesUserExist(username);
    }

    public string GetPassword(string username)
    {
        return _loginRepository.GetPassword(username);
    }
}
</code></pre><p>We then have the AccountLogic class, which handles all business logic.  In the example given, there is no complicated logic to be performed, so it becomes purely a chain call to the interface methods.</p><p>My question is, how do we make this easier to handle will also being testable on a larger scale?  If I had a controller which needs to query 10 different repositories, surely it is not manageable to pass 15 interfaces to the controller, and then to a relevant business class?  Do we need to change how repositories are handled so that there is not one class per table?</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>While not entirely in the style of C#, <a href="https://softwareengineering.stackexchange.com/questions/242795/what-is-the-free-monad-interpreter-pattern">free monad API</a> can help you here. Here&#39;s a <a href="https://gist.github.com/dadhi/026350db603dd348af6c0369a9a5bd0b" rel="nofollow noreferrer">C# example</a>.</p><p>In a free monad API, your interface is modeled as objects:</p><pre><code>// Static DSL for composing DbOp
public static class DB {
  public static class Session {
    public static DbOp&lt;Guid&gt; Create(int loginID, string userAgent, string locale) =&gt; new DbOp&lt;Guid&gt;.Session.Create(loginID, userAgent, locale, Return);
  }
  public static class Login {
    public static DbOp&lt;Boolean&gt; DoesUserExist(string username) =&gt; new DbOp&lt;Boolean&gt;.Login.DoesUserExist(username, Return);
  }
  public static DbOp&lt;A&gt; Return&lt;A&gt;(A value) =&gt; new DbOp&lt;A&gt;.Return(value);
}

// The classes that are created by the DSL. Holds the data of each operation
public abstract class DbOp&lt;A&gt; {
  public static class Session {
    public class Create : DbOp&lt;A&gt; {
      public readonly int LoginID;
      public readonly string UserAgent;
      public readonly string Locale;
      public readonly Func&lt;Unit, DbOp&lt;A&gt;&gt; Next;
      public Create(int loginID, string userAgent, string locale, Func&lt;Unit, DbOp&lt;A&gt;&gt; next) =&gt;
        (LoginID, UserAgent, Locale, Next) = (loginID, userAgent, locale, next);
    }
  }

  public static class Login {
    public class DoesUserExist {
      public readonly string Username;
      public readonly Func&lt;Unit, DbOp&lt;A&gt;&gt; Next;
      public DoesUserExist(string username, Func&lt;Unit, DbOp&lt;A&gt;&gt; next) =&gt;
        (Username, Next) = (username, next);
    }
  }

  public class Return : DbOp&lt;A&gt; {
    public readonly A Value;
    public Return(A value) =&gt; Value = value;
  }
}
</code></pre><p>This allows you to represent your entire data interface uniformly in a single file while allowing complete separation of the interface&#39;s implementation. You write programs by composing your interface objects in a free monad:</p><pre><code>public class BusinessLogic {
  private readonly IDbInterpreter dbInterpreter;
  public BusinessLogic(IDbInterpreter dbInterpreter) {
    this.dbInterpreter = dbInterpreter;
  }

  public Guid login(username) = {
    // Compose our program of DbOp
    DbOp&lt;Guid&gt; program = 
      from userExists     in DB.Login.DoesUserExist(username)
      from guid           in DB.Session.Create(...)
      select guid;

    // Interpret the program to get the result
    dbInterpreter.Interpret(program);
  }
}
</code></pre><p>Interpreters look like big switch statements (pseudocode):</p><pre><code>interface IDbInterpreter {
  A Interpret&lt;A&gt;(DbOp&lt;A&gt; ma);
}

public class DbInterpreter : IDbInterpreter {
    private readonly LoginRepository loginRepo;
    private readonly SessionRepository sessionRepo;
    DbInterpreter(LoginRepository loginRepo, 
                  SessionRepository sessionRepo) {
      this.loginRepo = loginRepo;
      this.sessionRepo = sessionRepo;
    }

    A IDbInterpreter.Interpret&lt;A&gt;(DbOp&lt;A&gt; ma) =&gt;
      ma is DbOp&lt;A&gt;.Return r                ? r.Value
      : ma is DbOp&lt;A&gt;.Session.Create c      ? Interpret(c.Next(sessionRepo.Create(c.LoginID, c.UserAgent, c.Locale)))
      : ma is DbOp&lt;A&gt;.Login.DoesUserExist d ? Interpret(d.Next(loginRepo.DoesUserExist(d.Username)))
      : throw new NotSupportedException();
}
</code></pre><p>One of the benefits of using this pattern is that you can separate your DB tables separately in the system, but you can interpret them all as one DSL. That means in test you can provide a single mock interpreter to handle all your expected DB calls (and throw an exception if an unexpected call is made) (pseudocode):</p><pre><code>class MockInterpreter : IDbInterpreter {
  A IDbInterpreter.Interpret(DbOp&lt;A&gt; ma) =&gt;
    ma is DbOp&lt;A&gt;.Return r                ? r.Value
    : ma is DbOp&lt;A&gt;.Session.Create c      ? throw new Exception(&#34;&#34;) // simulate exception being thrown on session create
    // we only need to implement the operations we expect to be called in the mock interpreter
    : throw new NotSupportedException(); 
}
BusinessLogic businessLogic = new BusinessLogic(mockInterpreter);
assert businessLogic.login(username) ...
</code></pre><p>Instead of providing numerous interface mocks.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../mvc-why-put-the-business-logic-in-the-model-what-happens-when-i-have-multiple-types-of-storage/'>Mvc &#8211; Why put the business logic in the model? What happens when I have multiple types of storage</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>