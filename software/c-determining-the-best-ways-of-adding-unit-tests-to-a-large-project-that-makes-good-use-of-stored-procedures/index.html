<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>C# &#8211; Determining the best way(s) of adding unit tests to a large project that makes good use of stored procedures &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1084633 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1084633" class="post-1084633 software type-software status-publish hentry category-software tag-c tag-entity-framework tag-sql-server tag-stored-procedures tag-unit-testing"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">C# &#8211; Determining the best way(s) of adding unit tests to a large project that makes good use of stored procedures</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">c</span><span class="mr-2 badge badge-info">entity-framework</span><span class="mr-2 badge badge-warning">sql server</span><span class="mr-2 badge badge-primary">stored-procedures</span><span class="mr-2 badge badge-danger">unit testing</span></p><div class="entry-content"><p>We work on a fairly large casino/gaming/wallet/lottery platform. It&#39;s a turn-key application that is currently in use by 4 clients, and soon to be much more. I&#39;ve made some bullet points regarding the architecture below:</p><ul><li>~130K LOC in just C# code</li><li>over 500 stored procs, in one of the 5 databases our system uses &#8211; because our code is used in regulated environments, the source code is &#34;locked&#34; for some clients until it is reviewed by a (very expensive) outside agency, so making changes via stored proc is a good balance of keeping both regulators and clients happy. The other databases are not near the complexity of the &#34;main&#34; database.</li><li>C# application code, spread out in Windows Forms, Xamarin Android, Windows services, web apps, SQL CLR library, class libraries and unit test projects</li><li>Uses EF6 for data layer, some ad-hoc, some stored procs</li></ul><p>While we have some unit tests in place, it&#39;s mostly for infrastructure-related stuff. There aren&#39;t many tests that test the business features. The other issue is that a lot of the heavy lifting is done in stored procedures. It&#39;s come time to add some unit tests in before we start refactoring some of the code, to prevent regressions. What I am looking for is a list of the different ways to go about this. This is what I have come up with so far:</p><ul><li><strong>We have a &#34;Test&#34; SQL Server instance that we could set up to clear and repopulate data when starting each test.</strong><ul><li>Pros<ul><li>The clear/reload data script can easily be modified when adding new tests</li></ul></li><li>Cons<ul><li>The clear/reload script could get huge</li><li>Testing could be slow because of clearing/reloading data on each test run</li></ul></li></ul></li><li><strong>We could use Moq to mock the EF6 data context as I have read on SO</strong><ul><li>Pros<ul><li>Testing would be fast as the data would come from C# code and be compiled</li></ul></li><li>Cons<ul><li>Adding test data in C# would take forever</li></ul></li></ul></li><li><strong>Use mstest to test C# procs that don&#39;t use stored procedures, and use Redgate&#39;s SQL test product to test SQL procedures by itself</strong><ul><li>Pros<ul><li>Unsure. While we own the developer suite of Redgate products, we haven&#39;t used SQL test before.</li></ul></li><li>Cons<ul><li>It&#39;s not a true test of the inner workings of the procs in my opinion</li></ul></li></ul></li><li><strong>Make a new override of the EF data context that forcibly loads the databases on the QA server, creates a new <code>SqlTransaction</code> on the connection, and when disposed of, calls <code>Rollback</code> to dispose of any changes made</strong><ul><li>Pros<ul><li>Doesn&#39;t require a lot of modifications to a lot of the internals of the existing code, or refactoring</li></ul></li><li>Cons<ul><li>Requires that we refactor a bunch of code to take in a database connection rather than allowing it to be created, e.g. make an IOC for getting the database connection</li></ul></li></ul></li></ul><p>The plan I have is to get a couple of good tests written, and if a lot of refactoring is not in the cards, have our QA guy learn programming by writing tests based on the examples made while getting it all set up.</p><p>How should I handle adding unit testing to a large project? How should I handle testing procedures that call stored procedures in a database? <strong>What I would like to know is the best way to shim unit tests in without a lot of refactoring. Refactoring this code base to decouple the data layer, for some spots, would not be hard, but in other spots, would be tough to do, so the method with the least amount of friction would be best.</strong></p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>A stored procedure and the C# code that uses it are different units, so a single unit test can not test them both. You&#39;ll need separate unit tests:</p><ul><li>Unit tests that mocks the stored procedure and verifies the C# code uses it correctly.</li><li>Unit tests that activate the stored procedure the same way the C# code would activate it(if you really want to you can say it mocks the C# code) and verifies the stored procedure does what it is supposed to do.</li></ul><p>Unit tests in both bullets assume the interface between the C# code and the stored procedures remain the same. But if you plan on refactoring, there is a good chance you&#39;ll want to refactor that interface! Unit tests will not protect you then: if the interface changes both mocks are out-of-date and the tests will need to be rewritten!</p><p>I suggest that instead of focusing on unit tests you should focus more on integration tests. This means a single test can test both the C# code and the stored procedure it uses. This also means you don&#39;t need to mock the database (only the data), so writing the tests will be much easier.</p><p>See if you can use transactions around each test. <code>BEGIN</code> the transaction before you start the test, and after the test <code>ROLLBACK</code> the transaction. That way you won&#39;t have to repopulate the database for each test - every test in the session will use the same initial database and the framework will clean up after it.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../unit-testing-unit-testing-internal-components/'>Unit-testing &#8211; Unit testing internal components</a></li><li class="list-group-item"><a href='../c-how-to-suggest-using-an-orm-instead-of-stored-procedures/'>C# &#8211; How to suggest using an ORM instead of stored procedures</a></li><li class="list-group-item"><a href='../database-am-i-unit-testing-or-integration-testing-the-stored-procedures/'>Database &#8211; Am I Unit Testing or Integration Testing the Stored Procedures</a></li><li class="list-group-item"><a href='../unit-testing-adding-unit-tests-to-a-legacy-plain-c-project/'>Unit-testing &#8211; Adding unit tests to a legacy, plain C project</a></li><li class="list-group-item"><a href='../c-how-to-make-unit-tests-to-make-sure-stored-procedure-is-deleting-row-from-the-database/'>C# &#8211; How to make Unit Tests to make sure stored procedure is deleting row from the database</a></li><li class="list-group-item"><a href='../design-when-should-i-use-stored-procedures/'>Design &#8211; When should I use stored procedures</a></li><li class="list-group-item"><a href='../c-entity-framework-vs-pure-ado-net-in-calling-stored-procedure-in-an-enterprise-project/'>C# &#8211; Entity framework vs pure ado .net in calling stored procedure in an enterprise project</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>