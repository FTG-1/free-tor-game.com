<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>A problem with understanding aggregates and aggregate roots in Domain Driven Design (DDD) &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1086556 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1086556" class="post-1086556 software type-software status-publish hentry category-software tag-aggregate tag-domain-driven-design"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">A problem with understanding aggregates and aggregate roots in Domain Driven Design (DDD)</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">aggregate</span><span class="mr-2 badge badge-info">domain-driven-design</span></p><div class="entry-content"><p>I&#39;ve stumbled upon a problem: &#34;I can&#39;t split my domain models into aggregate roots&#34;.</p><p>I&#39;m a junior developer and novice at DDD. I really want to understand it, but sometimes it&#39;s really confusing.</p><p>From this point I want to describe my domain briefly.</p><p>My poject dedicates to provide users opportunity to create any kind of documents by themselve. Users can create a new type of document. Each new type consists of its attributes. Then a user of this application can create a concrete document based on its type. User can also send the document for approval. An approval flow is different for each types.</p><p>So, we have the following models:</p><ol><li>DocumentType/ DocumentTemplate &#8211; acts as a template based on which<br /> concrete documents are created. It has one to many relationship with<br /> Document.</li><li>DocumentsAttribute &#8211; represents an attribute of document.<br /> It has many to many relationship with DocumentType.</li><li>AttributeValue &#8211; when a concrete document is created, It looks at<br /> its type and creates values for attributes, which has<br /> its type. Many to many relationship with Document and Attribute.</li><li>Document &#8211; represents a concrete document that is created by users.</li></ol><p>There are others models but I don&#39;t think that they make sense.</p><p>As you understand, here I apply Entity Attribute Value (EAV) pattern of data model. You can see a <a href="../../../i.stack.imgur.com/gwmqT.png" rel="nofollow noreferrer">diagram</a> that shows relationships in the database.</p><p>And my problems are:</p><p>I have a lot of entities in my model besides I have described.</p><p>I think that Document is definitely an aggregate root in my Domain. Because such things as ApprovalProcess which is aggregate cannot live out of it.</p><p>Here is the first question:</p><p>ApprovalProcess consists of its steps. Each step is an entity since it is mutable. A step has its state that can be changed. ApprvalProcess&#39;s state depends on its steps. Here we have a business invariant: &#34;ApprovalProcess can be approved only if all its steps is approved&#34;.</p><p>I think that it is an aggregate root because it has the business invariant and contains entities that cannot live out of it. And we don&#39;t want to allow to have direct access to its steps in order to keep ApprovalProcess consistent.</p><p><strong>Am I mistaken that ApprovalProcess is an aggregate root? May it is just an aggregate?<br /> Can one aggregate root exist within another one as it&#39;s part? Does it mean that ApprovalProcess is just aggregate because Document is responsible for access to its parts? But when ApprovalProcess&#39;s step is approved, Document delegates an operation to ApprovalProcess.</strong></p><p>For example:</p><pre><code>Document doc = new Document(...);
doc.SendForAooroval(); //ApprovalProcess is created.

doc.ApproveStep(int stepId); // Inside the method Document delegates responsibility for approvement to ApprovalProcess.
</code></pre><p>Or I should leave Document and ApprovalProcess separately. Hence Document is going to refer to ApprovalProcess by Identity. And we have the following scenario:</p><pre><code>Document doc = documentRepository.Get(docId);
doc.SendForAooroval();// A domain event &#34;DocumentCreatedEvent&#34; is raised.
</code></pre><p>DocumentCreatedEventHandler:</p><pre><code>ApprovalProcess approvalProcess = new ApprovalProcess(event.DocId); // ApprovalProcessCreatedEvent is raised

approvalProcessRepository.Add(approvalProcess);
approvalProcessRepositroy.UnitOfWork.Save(); //commit 
</code></pre><p>But if ApprovalProcess&#39;s state changes, Document&#39;s state also changes. ApprovalProcess is approved then Document is also approved. Another word ApprovalProcess is kind of part of Document&#39;s state. Only thanks to it we can know that Document is approved.</p><p>And the biggest problem that I&#39;m experiencing:</p><p>DocumentType is also an aggregate root. It consists of its attributes and ApprovalScheme. I haven&#39;t mentioned ApprovalScheme yet on purpose to keep my explanation as simple as possible. ApporvalScheme consists also from some entities. It&#39;s just an approval flow for DocumentType. ApprovalProcess is created according to ApprovalScheme of DocumentType which has Document. ApprovalScheme cannot exist without DocumentType. One to one relationship.</p><p><strong>Document refers by identity to its DocumentType. Is it correctly?</strong></p><p>At the begining of this task I thought that DocumentType should be a part of Document.</p><p>DocumentType has many Documents but in my domain It doesn&#39;t make sense. It doesn&#39;t represent the state of DocumentType. DocumentType can be marked as deleted but can&#39;t be deleted.</p><p><strong>Document and DocumentType are two different aggregate roots. Am I right?</strong></p><p>Thank you so much If you read it. Thank you a lot for you attention and help!<br /> Sorry for my terrible English.</p><p>==========================================================================================================================================================</p><h2>Problem â„–2</h2><p>Now I want to provide you more details about my Domain.</p><p>There are: users, documents, types of documents, attributes of documents.</p><p><strong>The documents in my application have dynamic fields. So I use EAV pattern.<br /> A type of the Document defines set of attributes and an approval flow that consists of steps. If a document is created, it is created all values of attributes that its type contains for the document.</strong></p><p><strong>If document is sent for approval, it is created a particular state for each step in an approval flow which is kept by the document type. This set of state relates to the document&#39;s approval process.</strong></p><p>There are two types of users: Employee and Amin. The Employee can have differen roles like: manager, accountant and so on.</p><p>Each employee can:</p><ul><li>Create a new document.</li><li>Send document for approval.</li><li>Edit document if it is not on approval.</li><li>Approve exactly one of the step of approval process that belongs to<br /> the document and user is responsible for.</li><li>Reject exactly one of the step of approval process that belongs to<br /> the document and user is responsible for.</li><li>Print it if it is approved.</li></ul><p>Each admin can:</p><ul><li>Create a new type of document.</li><li>Create new or set an existing attribute for the type of a document.</li><li>Create new or edit existing approval flow for the type of a document.</li></ul><p>If the approval process is rejected, the user who is a creator of the document must make some corrects to the document and send it for approval again.</p><p>I have to option how to implement it.<br /> The first option is I think that I have the following entities and Aggregates (I want to show their interface):</p><pre><code>interface User {
  Document CreateNewDocument(int docType);
  Document SendDocumentForApproval(int docId);
  Document EditDocument(document, List&lt;AttributesValues&gt; attributesValues); // list of only attributes that must be changed.
  Document Approve(document, stepId);
  Document Reject(document, stepId);
  Document Print(document);
}
</code></pre><p>And I&#39;m going to use it somehow like this:</p><p>CreateDocumentCommandHandler:</p><pre><code>User user = userRepository.GetUser(userId);

Document doc = user.CreateNewDocument(docTypeId);

documentRepository.Add(doc);
documentRepository.UnitOfWork.Save();
</code></pre><p>SendDocumentForApprovalCommandHandler:</p><pre><code>User user = userRepository.GetUser(userId);
Document doc = documentRepository.GetDocument(docId)

doc = user.SendDocumentForApproval(doc );

documentRepository.Update(doc);
documentRepository.UnitOfWork.Save();
</code></pre><p>But what is really tricky for me is what is hapenning inside SendDocumentForApproval method of the user:</p><pre><code>Document SendDocumentForApproval(document)
{
   if(document == null) throw new ArgumentNullException(nameof(document));

   // When document is sent for approval, it needs to initialize a new
   // approval process and all states for the approval scheme&#39;s steps.
   // So we need to get a type of the document and ask it to provide us
   // ApprovalProcess that is based on ApprovalScheme.
   document.SubmitApprove(); // DocumentSendForApprovalDomainEvent is raised
   return document;
}
</code></pre><p>DocumentSendForApprovalDomainEventHandler:</p><pre><code>Handle(dto)
{
   // It seems very stupid because either I need get one more time document
   // with the repository or I need to keep a reference to the instance of
   // the document as a field in the dto argument of this handler.
   Document doc = dto.Document;// looks terrible
   // or
   Document doc = documentRepository.GetDocument(dto.DocId);//looks also terrible because we have alredy used repository on this purpose in SendDocumentForApprovalCommandHandler

    DocType docType = docTypeRepositoty.GetDocType(doc.TypeId);

    ApprovalProcess approvalProcess = docType.InitNewApprovalProcessForDocument(doc.Id);


    doc.AssignApprovalProcess(approvalProcess)
}
</code></pre><p><strong>Could someone correct the ApprovalProcess that I&#39;ve modeled above please?<br /> Or tell me please that I&#39;m on the right way or not.</strong></p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>I think a lot of the confusion here is a result of focusing on data instead of behavior. The purpose of DDD is to model the <em>functional</em> requirements of a system to provide a useful abstract of your business domain. This means that we model according to <em>behavior</em> and let the data that supports our behavior become an implementation detail. So let&#39;s start there!</p><p>The system you are describing, in terms of behavior, is actually quite simple. Let&#39;s begin by listing your use-cases (gleaned from your question):</p><ul><li>Create new <code>Document</code></li><li>Change <code>Document</code> attribute value</li><li>Approve <code>Document</code></li></ul><p>With the above in mind, let us now create some command handlers:</p><p><strong>CreateDocumentHandler</strong></p><pre><code>DocumentType dt = documentTypes.Find( cmd.DocumentTypeId );
Document doc = dt.CreateEmptyDocument( cmd.UserId ); // factory method
documents.Add( doc );
</code></pre><p><strong>ChangeDocumentHandler</strong></p><pre><code>Document doc = documents.Find( cmd.DocumentId );
doc.ChangeAttribute( cmd.AttributeName, cmd.AttributeValue );
documents.Save( doc );
</code></pre><p><strong>ApproveDocumentHandler</strong></p><pre><code>Document doc = documents.Find( cmd.DocumentId );
doc.Approve(); // approval process is part of document
documents.Save( doc );
</code></pre><p>From here I think you can fill in the blanks.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../ddd-aggregate-roots-dealing-with-efficiency-and-concurrency/'>DDD &#8211; Aggregate Roots &#8211; Dealing with Efficiency and Concurrency</a></li><li class="list-group-item"><a href='../ddd-integrating-aggregate-root-with-open-host-service-ohs/'>DDD integrating aggregate root with open host service (OHS)</a></li><li class="list-group-item"><a href='../architecture-balance-between-aggregate-boundaries-and-domain-consistency-in-ddd/'>Architecture &#8211; Balance between aggregate boundaries and domain consistency in DDD</a></li><li class="list-group-item"><a href='../many-to-many-relations-in-domain-driven-design/'>Many to many relations in Domain Driven Design</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>