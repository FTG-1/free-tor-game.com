<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Designing events in an event-driven (event sourced) architecture and managing duplication &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1083861 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1083861" class="post-1083861 software type-software status-publish hentry category-software tag-cqrs tag-event tag-event-programming tag-event-sourcing"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Designing events in an event-driven (event sourced) architecture and managing duplication</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">cqrs</span><span class="mr-2 badge badge-info">event</span><span class="mr-2 badge badge-warning">event-programming</span><span class="mr-2 badge badge-primary">event-sourcing</span></p><div class="entry-content"><p>I have been creating a POC for a part of our system but I&#39;m finding some trouble communicating some of the ideas behind it. This takes ideas from Event Sourcing and Event Driven Architecture but trying to learn step by step.</p><p>I thought I had my reasons and motivations clear, but to be honest, I don&#39;t find good arguments for all the questions I&#39;m getting. I would greatly appreciate your opinions/comments/ideas and of course, any links or material that you may have.</p><p>In one part of our system, we needed to make sure that we would have a complete audit trail for the operations that were happening. We wanted to be able to see all the transitions that brought an object to some state and re-run them to verify that the result made sense. What I did envision was the following:</p><ul><li><p>A list of <strong>immutable events</strong> carefully crafted to express what was happening in the relevant entities. They all must have a defined set of fields that would work as a <strong>contract</strong>.</p></li><li><p>A set of aggregates (could be more than one) that would know how to reconstruct themselves reading partially this stream of events. This ability to build the current or past states, I understand, is basically <strong>event sourcing</strong>.</p></li><li><p>I also wanted to set the first stone towards <strong>a more event-driven architecture</strong>. So other parts of the application, even other systems, could maintain a pointer to the stream to read new changes that had just happened. These consumers could be interested only in part of the stream and they would rely only on the signature of the events (<strong>Interface segregation principle: no client should be forced to depend on methods it does not use</strong>) decoupling as much as possible themselves from the &#34;origin&#34; system.</p></li></ul><p>I have been getting several questions from this:</p><p><strong>1) Duplication</strong></p><p>I can&#39;t translate exactly our domain, so I hope this makes partial sense. Let&#39;s assume this stream of events for an app where we can create exams and users can take them:</p><pre><code>- Exam-question-created  (Id: Question1, Text: &#39;st&#39;)
- Exam-question-created  (Id: Question2, Text: &#39;st else&#39; )
- Exam-initiated         (Id: User1)
- Exam-question-answered (Question: Question1, User: User1, Text: &#39;st&#39;, Reply: &#39;One reply&#39;)
</code></pre><p>As you can see, I store the text of the question answered also in the <code>exam-question-answered</code> and this information was already there in the <code>exam-question-created</code> event. I must say that in this example it doesn&#39;t make much sense, but I wanted to tie the text that the user saw when answering the question. Even that I try to put just the minimal information that defines the business event, for me, this time has a business meaning. I also want to be able to have other systems that listen just to <code>exam-question-answered</code> and incorporate the text to the event. I don&#39;t know, let&#39;s imagine that we have a real-time dashboard that only shows questions as they are answered, and we want to show the text.</p><p>Is this duplication fundamentally wrong? (again, the example is a bit weak, bear with me). I understand that the events are the <strong>source of truth</strong>, but adding the text to the event does not make anything incorrect. And if I have an <code>Exam</code> aggregate, I understand it has the responsibility to, given the event name and the payloads, reconstruct its state making whatever use it needs from the payloads. This implementation belongs to the aggregate. This one would just discard (for example) the text property of <code>Exam-question-answered</code>. Am I wrong?. The ability to reconstruct its state is there, and we do not have any wrong data in the store.</p><p>Would it be better to store without duplication and hydrate the data with extra info when it is going to be given to consumers?</p><p><strong>2) The expectation to deep merge</strong></p><p>And this question is also connected with the previous one. At some point, it appeared the expectation in the team that the aggregates could be built replaying the events and merging the payloads.</p><p>So, again an example (although not very good), if we have an &#39;Exam-question-removed&#39; they expect to see a <code>{id: X, deleted: true}</code> in the payload. This property is already present in some parts of our system (they know it) and for some aggregations it makes sense. They expect to merge payloads for some of the events automatically in getting in return something that makes sense.</p><p>My interpretation is different. The fact that you have codified immutable business facts as events enable building different aggregations from them. If you are rebuilding an exam, for example, this payload can be convenient, but if you are building an analytics dashboard, just to put one example, maybe the <code>Exam-question-removed</code> means that you are going to reduce -1 from some counter. You don&#39;t need the &#39;deleted&#39; part of the payload. For me, what makes sense is to code the event with the minimal data that gives meaning to the business fact. If you know all that you need to know with:</p><p><code>name: exam-question-removed data: { id: 1 }</code></p><p>There is no need for more. The process replying events must be responsible to know what to do with each event towards the final state that it wants to rebuild, it&#39;s just a function:</p><p><code>f(current_state, event (name, payload)) =&gt; new_state</code></p><p>You must implement <code>f</code> by yourself.</p><p>Did I get this completely wrong?. Any indication to material about this or how to properly design events would be greatly appreciated.  If it supports what I say great, but really looking forward to find if this is incorrect.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><blockquote><p>A set of aggregates (could be more than one) that would know how to reconstruct themselves reading partially this stream of events. This ability to build the current or past states, I understand, is basically event sourcing.</p></blockquote><p>In Event sourcing it&#39;s not just you <em>can</em>, you <em>need</em> to reconstruct the  Aggregate&#39;s current state from the events. Aggregate snapshots don&#39;t count as they are just an optimisation and the system must work the same without them (indeed slower).</p><blockquote><p>As you can see, I store the text of the question answered also in the exam-question-answered and this information was already there in the exam-question-created event. I must say that in this example it doesn&#39;t make much sense, but I wanted to tie the text that the user saw when answering the question. Even that I try to put just the minimal information that defines the business event, for me, this time has a business meaning. I also want to be able to have other systems that listen just to  exam-question-answered and incorporate the text to the event. I don&#39;t know, let&#39;s imagine that we have a real-time dashboard that only shows questions as they are answered, and we want to show the text. Is this duplication fundamentally wrong?</p></blockquote><p>In general the domain events contain only the information that can&#39;t be derived from the past events and that is needed by the Aggregate to completely reconstruct its state. There are however cases when you may add redundant information to the events, for example when the Read-models would be a lot simpler.</p><blockquote><p>So, again an example (although not very good), if we have an &#39;Exam-question-removed&#39; they expect to see a {id: X, deleted: true} in the payload.</p></blockquote><p>This <code>deleted:true</code> is really redundant. The fact that the question is deleted comes from the event-type itself, <code>exam-question-removed</code>, there is no need for such a property. I suggest you to remove it as it makes one wonder why such a property was <em>needed</em>.</p><blockquote><p>Is there anything wrong with the idea that the same events could build different aggregates. Example: An stream of exam-question-created and exam-question-answered can be used to build an Exam aggregate but also a MonthlyAnsweredQuestions aggregate. I know the second sounds as a projection, but let&#39;s assume it has business meaning to and it makes sense to consider it as aggregate</p></blockquote><p>Yes, it would be very wrong. Aggregates should not depends on anything else but their own events. Maybe it is not an Aggregate but an event sourced Saga/Process manager (that would create/send commands based on previous events emitted by some Aggregates).</p><blockquote><p>You said: &#34;There are however cases when you may add redundant information to the events&#34;. So this is not strictly forbidden then, right?. Is it a design choice?. Should it be stored in an extra metadata field?</p></blockquote><p>Yes, it&#39;s not strictly forbidden and I don&#39;t think that it must be stored in a metadata field. The event represents facts that happened, it&#39;s not wrong to capture some context in which they happened.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../architecture-serverless-event-sourced-architecture-using-aws-offerings/'>Architecture &#8211; Serverless event-sourced architecture using AWS offerings</a></li><li class="list-group-item"><a href='../design-handle-failures-in-event-driven-architecture/'>Design &#8211; Handle failures in Event Driven Architecture</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>