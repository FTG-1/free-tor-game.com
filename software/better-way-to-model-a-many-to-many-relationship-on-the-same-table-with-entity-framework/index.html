<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Better way to model a many-to-many relationship on the same table with Entity Framework &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1068641 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1068641" class="post-1068641 software type-software status-publish hentry category-software tag-entity-framework tag-modeling"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Better way to model a many-to-many relationship on the same table with Entity Framework</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">entity-framework</span><span class="mr-2 badge badge-info">modeling</span></p><div class="entry-content"><h1>The context</h1><p>We&#39;re building a web application using Entity Framework 5.0. One of the requirements is that it should be possible for the administrators to link related products so that when someone browses to a product we can render a list &#34;<em>You might also like these products:</em>&#34;.</p><p>Since a product can be linked to many products we need a many-to-many relationship for this.</p><p>The table in the database could look something like this:</p><pre><code> _________________________
| LinkedProducts          |
|-------------------------|
| ProductId1 | ProductId2 |
|------------|------------|
|     1      |     2      |
|------------|------------|
|     1      |     3      |
|------------|------------|
|     2      |     4      |
|------------|------------|
</code></pre><p>An additional requirement is that the linking should be bidirectional. This means that with the sample data from the table above, when you browse to product 2, you should get product 1 and 4 in the list. So for a given <code>ProductId</code>, you should be able to get its linked products from column <code>ProductId1</code> and <code>ProductId2</code>.</p><h1>What I&#39;ve come up with</h1><p>The product entity:</p><pre><code>public class Product
{
    public int ProductId { get; set; }
    public string Name { get; set; }

    public virtual ICollection&lt;Product&gt; References { get; set; }
    public virtual ICollection&lt;Product&gt; ReferencedBy { get; set; }

    public Product()
    {
        References = new List&lt;Product&gt;();
        ReferencedBy = new List&lt;Product&gt;();
    }
}
</code></pre><p>The product mapping:</p><pre><code>public class ProductMapping : EntityTypeConfiguration&lt;Product&gt;
{
    public ProductMapping()
    {
        HasKey(t =&gt; t.ProductId);

        Property(t =&gt; t.Name).IsRequired().HasMaxLength(150);

        ToTable(&#34;Products&#34;);
        Property(t =&gt; t.ProductId).HasColumnName(&#34;ProductId&#34;);
        Property(t =&gt; t.Name).HasColumnName(&#34;Name&#34;);

        HasMany(x =&gt; x.References).WithMany(x =&gt; x.ReferencedBy).Map(map =&gt;
            {
                map.ToTable(&#34;LinkedProducts&#34;);
                map.MapLeftKey(&#34;ProductId1&#34;);
                map.MapRightKey(&#34;ProductId2&#34;);
            });
    }
}
</code></pre><p>This all works. To display the list of linked products for a certain product, I can just get the union of <code>References</code> and <code>ReferencedBy</code>:</p><pre><code>var product = db.Find(2);
var linkedProducts = product.References.Union(product.ReferencedBy);
</code></pre><h1>The problem</h1><p>As I said, this works, but I don&#39;t really like it and I was wondering if there is a better way to deal with a situation like this when working with Entity Framework.</p><h1>The solution</h1><p>I liked Ryathal&#39;s suggestion to add two records to the database when linking products. So, when linking product 1 to product 2, I now insert two records: <code>{ 1, 2 }</code> and <code>{ 2, 1 }</code>.</p><p>This also allows me to remove the <code>ReferencedBy</code> collection in the <code>Product</code> class so that only one collections remains: <code>References</code>.</p><p>To link to products:</p><pre><code>product1.References.Add(product2);
product2.References.Add(product1);
</code></pre><p>To remove the link between products:</p><pre><code>product1.References.Remove(product2);
product2.References.Remove(product1);
</code></pre><p>Here is my new <code>Product</code> class with the mapping:</p><pre><code>public class Product
{
    public int ProductId { get; set; }
    public string Name { get; set; }

    public virtual ICollection&lt;Product&gt; References { get; set; }

    public Product()
    {
        References = new List&lt;Product&gt;();
    }
}
</code></pre><p>The product mapping:</p><pre><code>public class ProductMapping : EntityTypeConfiguration&lt;Product&gt;
{
    public ProductMapping()
    {
        HasKey(t =&gt; t.ProductId);

        Property(t =&gt; t.Name).IsRequired().HasMaxLength(150);

        ToTable(&#34;Products&#34;);
        Property(t =&gt; t.ProductId).HasColumnName(&#34;ProductId&#34;);
        Property(t =&gt; t.Name).HasColumnName(&#34;Name&#34;);

        HasMany(x =&gt; x.References).WithMany().Map(map =&gt;
            {
                map.ToTable(&#34;LinkedProducts&#34;);
                map.MapLeftKey(&#34;ProductId1&#34;);
                map.MapRightKey(&#34;ProductId2&#34;);
            });
    }
}
</code></pre></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>Follow good database design and your problems will start getting easier, don&#39;t think about entity framework when designing your database structures. Create your Product table and create you related product table with source product and related product ids. The requirement for linking to be bi directional is just a business rule to be handled with the application on creating related products to always insert two rows into your mapping table. Everything stays nice and simple this way.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../is-entity-framework-the-way-to-go-for-our-situation/'>Is Entity Framework the way to go for our situation</a></li><li class="list-group-item"><a href='../possible-to-switch-table-at-runtime-using-entity-framework/'>Possible to switch table at runtime using Entity Framework</a></li><li class="list-group-item"><a href='../c-how-to-update-a-db-table-using-a-poco-class-bound-in-a-datagridview/'>C# &#8211; How to update a DB table using a POCO class bound in a DataGridView</a></li><li class="list-group-item"><a href='../c-entity-framework-with-no-direct-table-access/'>C# &#8211; Entity Framework with no direct table access</a></li><li class="list-group-item"><a href='../entity-framework-code-first-c-class-separation-and-eav/'>Entity Framework Code First, C# class separation and EAV</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>