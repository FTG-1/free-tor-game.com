<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>How do VMs implement function calling &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1078861 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1078861" class="post-1078861 software type-software status-publish hentry category-software tag-assembly tag-low-level tag-virtual-machine"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">How do VMs implement function calling</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">assembly</span><span class="mr-2 badge badge-info">low-level</span><span class="mr-2 badge badge-warning">virtual machine</span></p><div class="entry-content"><p>I&#39;m reading a compiler textbook that compiles to some form of assembly. Since I don&#39;t know this assembly language I decided to invent my own simple &#34;assembly language&#34;  and implement a basic &#34;virtual machine&#34; which will execute these instructions.</p><p>Currently I&#39;m thinking how I can implement function decleration and function calling in the language and VM.</p><p>I had the following idea, please tell me what you think:</p><p>Function declerations would look like simple labels. At the end of a function there&#39;s an <code>end</code> statement. The &#39;main program&#39; is a function by itself. For examle:</p><pre><code>main:
// some logic
CALL funcA
// more logic
END
funcA:
// .. some logic
END
</code></pre><p>However the difference between <code>call &lt;function&gt;</code> and <code>goto &lt;label&gt;</code> is this:</p><p><code>goto</code> simply sets the &#39;instruction pointer&#39; (the register that holds the number of the next line to be executed) to the line number of the label.</p><p><code>call</code> does what <code>goto</code> does, but <em>before jumping</em> it pushes the current line number (plus 1) onto a stack.</p><p>When <code>end</code> is reached, the VM pops the top of the stack and jumps to this line number. If there is nothing in the stack, the program terminates.</p><p>So for example, for the code above this is what happens:</p><pre><code>main: // this is where the VM starts
// some logic
CALL funcA // push onto the stack the number 4 (3+1), and jump to the label funcA
// more logic .. this is where we return to from funcA
END // pop the top of the stack and jump to this line number. nothing -&gt; terminate
funcA:
// .. some logic
END // pop the top of the stack (the number 4), and jump to this line number
</code></pre><p>What do you think of this approach?</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>It depends on the VM, to be honest.</p><p>It is a bit easier to write a VM in an OO language that operates on data structures kept in memory rather than on some form of linearized bytecode.  If you ever implement a toy programming language you might decide to do it this way, at least initially (I have done this before), in which case the VM is probably just a polymorphic &#34;run()&#34; method.  A lot of scripting languages work this way, because the code will be generated at the same time in which it is run, so there is no need to maintain the bytecode for later.</p><p>If you compile all the way to a linearized bytecode (like how Java compiles), the way you handle operation calls will depend on the language.  If you do not allow recursion (most old programming languages originally did not), you can simply inline the operation calls directly into the bytecode.  This causes code bloat but is &#34;safe&#34; otherwise.</p><p>If you compile all the way to a linearized bytecode, but you want to allow recursion, then you&#39;ll need to emulate a call stack.  Each frame of the stack will hold a reference to the location in the code segment where that operation was invoked (for operation-based frames).  It will also hold copies of all variables local to that frame.  Objects to which those variables refer may be held on the stack or in a separate heap segment, depending on the design of the programming language and (more likely) the code optimizer being used by the compiler.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../c-how-do-programmers-deal-with-low-level-software-development-in-high-level-languages/'>C# &#8211; How do programmers deal with low level software development in high level languages</a></li><li class="list-group-item"><a href='../which-are-the-alternatives-to-using-a-stack-to-represent-function-call-semantics/'>Which are the alternatives to using a stack to represent function call semantics</a></li><li class="list-group-item"><a href='../how-does-a-stack-vm-manage-with-only-one-stack/'>How does a stack VM manage with only one stack</a></li><li class="list-group-item"><a href='../architecture-developing-a-compiler-for-a-self-made-cpu-architecture/'>Architecture &#8211; Developing a compiler for a self made CPU Architecture</a></li><li class="list-group-item"><a href='../registers-and-stacks-in-nasm/'>Registers and Stacks in NASM</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>