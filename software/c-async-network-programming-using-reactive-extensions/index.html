<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>C# &#8211; Async network programming using Reactive Extensions &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1068105 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1068105" class="post-1068105 software type-software status-publish hentry category-software tag-c tag-net tag-tcp"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">C# &#8211; Async network programming using Reactive Extensions</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">c</span><span class="mr-2 badge badge-info">net</span><span class="mr-2 badge badge-warning">tcp</span></p><div class="entry-content"><p>After doing some (more-or-less) &#34;low-level&#34; async <code>socket</code> programming years ago (in an  Event-based Asynchronous Pattern <sup>(EAP)</sup> fashion) and recently moving &#34;up&#34; to a <code>TcpListener</code> (Asynchronous Programming Model <sup>(APM)</sup>) and then trying to move to <code>async/await</code> (Task-based Asynchronous Pattern <sup>(TAP)</sup>) I&#39;ve pretty much had it with keep having to bother with all this &#39;low level plumbing&#39;. So I was figuring; why not give <code>RX</code> a go (<a href="http://msdn.microsoft.com/en-us/data/gg577609.aspx">Reactive Extensions</a>) since it might fit more snugly to my problem domain.</p><p>A lot of code I write has to to with many clients connecting over Tcp to my application which then start a two-way (async) communication. The client <em>or</em> server may at any point decide a message needs to be sent and do so, so this is not your classic <code>request/response</code> setup but more of a real-time, two-way, &#34;line&#34; open to both parties to send whatever they want, whenever they want. (If anyone has a decent name to describe this I&#39;d be glad to hear it!).</p><p>The &#34;protocol&#34; differs per application (and isn&#39;t really relevant to my question). I do, however have an initial question:</p><ol><li>Given that only one &#34;server&#34; is running, but it has to keep track of many (usually thousands) of connections (e.g. clients) each having (for lack of a better description) their own &#34;state machine&#34; to keep track of their internal states etc, which approach would you prefer? EAP/TAP/APM? Would RX even be considered an option? If not, why?</li></ol><p>So, I need to work Async since a) it&#39;s not a request/response protocol so I cannot have a thread/client in a &#34;waiting for message&#34;-blocking call or &#34;sending message&#34;-blocking call (however, if the send is blocking for that client only I could live with it) and b) I need to handle many concurrent connections. I see no way of doing this (reliably) using blocking calls.</p><p>Most of my applications are VoiP related; be it SIP messages from SIP cients or PBX (related) messaging from applications like <a href="http://www.freeswitch.org/">FreeSwitch</a> / <a href="http://www.opensips.org/">OpenSIPS</a> etc. but you can, in it&#39;s simplest form, try to imagine a &#34;chat&#34;server trying to handle many &#34;chat&#34;clients. Most protocols are text based (ASCII).</p><p>So, after having implemented many different permutations of aforementioned techniques I would like to simplify my work by creating an object that I can simply instantiate, tell it on which <code>IPEndpoint</code> to listen and have it tell me whenever something of interest is going on (which I usually use events for, so some EAP is usually mixed with the other two techniques). The class should not bother trying to &#39;understand&#39; the protocol; it should merely handle incoming/outgoing strings. And thus, having my eye on RX hoping that would (in the end) simplify the work, I created a new &#34;fiddle&#34; from scratch:</p><pre><code>using System;
using System.Collections.Concurrent;
using System.Net;
using System.Net.Sockets;
using System.Reactive.Linq;
using System.Text;

class Program
{
    static void Main(string[] args)
    {
        var f = new FiddleServer(new IPEndPoint(IPAddress.Any, 8084));
        f.Start();
        Console.ReadKey();
        f.Stop();
        Console.ReadKey();
    }
}

public class FiddleServer
{
    private TcpListener _listener;
    private ConcurrentDictionary&lt;ulong, FiddleClient&gt; _clients;
    private ulong _currentid = 0;

    public IPEndPoint LocalEP { get; private set; }

    public FiddleServer(IPEndPoint localEP)
    {
        this.LocalEP = localEP;
        _clients = new ConcurrentDictionary&lt;ulong, FiddleClient&gt;();
    }

    public void Start()
    {
        _listener = new TcpListener(this.LocalEP);
        _listener.Start();
        Observable.While(() =&gt; true, Observable.FromAsync(_listener.AcceptTcpClientAsync)).Subscribe(
            //OnNext
            tcpclient =&gt;
            {
                //Create new FSClient with unique ID
                var fsclient = new FiddleClient(_currentid++, tcpclient);
                //Keep track of clients
                _clients.TryAdd(fsclient.ClientId, fsclient);
                //Initialize connection
                fsclient.Send(&#34;connect\n\n&#34;);

                Console.WriteLine(&#34;Client {0} accepted&#34;, fsclient.ClientId);
            },
            //OnError
            ex =&gt;
            {

            },
            //OnComplete
            () =&gt;
            {
                Console.WriteLine(&#34;Client connection initialized&#34;);
                //Accept new connections
                _listener.AcceptTcpClientAsync();
            }
        );
        Console.WriteLine(&#34;Started&#34;);
    }

    public void Stop()
    {
        _listener.Stop();
        Console.WriteLine(&#34;Stopped&#34;);
    }

    public void Send(ulong clientid, string rawmessage)
    {
        FiddleClient fsclient;
        if (_clients.TryGetValue(clientid, out fsclient))
        {
            fsclient.Send(rawmessage);
        }
    }
}

public class FiddleClient
{
    private TcpClient _tcpclient;

    public ulong ClientId { get; private set; }

    public FiddleClient(ulong id, TcpClient tcpclient)
    {
        this.ClientId = id;
        _tcpclient = tcpclient;
    }

    public void Send(string rawmessage)
    {
        Console.WriteLine(&#34;Sending {0}&#34;, rawmessage);
        var data = Encoding.ASCII.GetBytes(rawmessage);
        _tcpclient.GetStream().WriteAsync(data, 0, data.Length);    //Write vs WriteAsync?
    }
}
</code></pre><p><sub><sup>I am aware that, in this &#34;fiddle&#34;, there is a little implementation specific detail; in this case I&#39;m working with <a href="http://wiki.freeswitch.org/wiki/Event_Socket_Library">FreeSwitch ESL</a> so the <code>&#34;connect\n\n&#34;</code> in the fiddle should, when refactoring to a more generic approach, be removed.</sup></sub></p><p><sub><sup>I am also aware that I need to refactor the anonymous methods to private instance methods on the Server class; I&#39;m just not sure what convention (e.g. &#34;<code>OnSomething</code>&#34; for example) to use for their method-names?</sup></sub></p><p>This is my basis/starting-point/foundation (which needs some &#34;tweaking&#34;). I have some questions about this:</p><ol><li>See above question &#34;1&#34;</li><li>Am I on the right track? Or are my &#34;design&#34; decisions unjust?</li><li>Concurrency-wise: would this cope with thousands of clients (parsing/handling the actual messages aside)</li><li>On exceptions: I&#39;m not sure how to get exceptions raised within clients &#34;up&#34; to the server (&#34;RX-wise&#34;); what would be a good way?</li><li>I can now get any connected client from my server class (using it&#39;s <code>ClientId</code>), assuming I expose the clients in one way or another, and call methods on them directly. I can also call methods via the Server class (for example, the <code>Send(clientId, rawmessage)</code> method (whereas the latter approach would be a &#34;convenience&#34; method for quickly getting a message to the other side).</li><li>I am not quite sure where (and how) to go from here:<ul><li>a) I need to handle incoming messages; how would I set this up? I can get the stream ofcourse, but <em>where</em> would I handle retrieving the received bytes? I think I need some kind of &#34;ObservableStream&#34;-something I can subscribe to? Would I put this in the <code>FiddleClient</code> or <code>FiddleServer</code>?</li><li>b) Assuming I want to avoid using event until these <code>FiddleClient</code>/<code>FiddleServer</code> classes are implemented more specifically to tailor their application specific protocol handling etc. using more specific <code>FooClient</code>/<code>FooServer</code> classes: how would I go from getting the data in the underlying &#39;Fiddle&#39;-classes to their more specific counterparts?</li></ul></li></ol><p>Articles/links I already read / skimmed / used for reference:</p><ul><li><a href="http://www.silverlightplayground.org/post/2011/06/29/Consume-a-Socket-using-Reactive-Extension.aspx">Consume a Socket using Reactive Extension</a></li><li><a href="http://msdn.microsoft.com/en-us/library/hh242977(v=vs.103).aspx">Creating and Subscribing to Simple Observable Sequences</a></li><li><a href="http://social.msdn.microsoft.com/Forums/en-US/5ac78229-d63b-4652-8eb2-af2d49f47433/how-to-add-or-associate-context-to-each-observabletcplistener-connectionsession?forum=rx">How to add or associate context to each ObservableTcpListener Connection/Session</a></li><li><a href="http://bvanderveen.com/a/async-with-rx-and-the-tpl-part-1/">Asynchronous Programming with the Reactive Framework and the Task Parallel Library â€” Part 1</a>, <a href="http://bvanderveen.com/a/async-with-rx-and-the-tpl-part-2/">2</a> and <a href="http://bvanderveen.com/a/async-with-rx-and-the-tpl-part-3/">3</a>.</li><li><a href="http://go4answers.webhost4life.com/Example/reactive-extensions-rx-socket-12875.aspx">Using Reactive Extensions (Rx) for socket programming practical?</a></li><li><a href="http://allampersandall.blogspot.nl/2012/05/net-rx-tcp-tutorial.html">A .NET Rx Driven Web Server</a> and <a href="http://allampersandall.blogspot.nl/2012/05/net-rx-driven-web-server-take-2.html">.NET Rx Driven Web Server, Take 2</a></li><li>Some <a href="http://msdn.microsoft.com/en-us/data/gg577611.aspx">Rx tutorials</a></li></ul></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><blockquote><p>...I would like to simplify my work by creating an object that I can simply instantiate, tell it on which IPEndpoint to listen and have it tell me whenever something of interest is going on...</p></blockquote><p>After reading that statement I immediately thought &#34;actors&#34;. Actors are very similar to objects except they only have a single input where you pass it the message (instead of directly calling the object&#39;s methods) and they operate asynchronously. In a very simplified example... you would create the actor and send it a message with the IPEndpoint and the address of the actor to send the result to. It goes off and does it work in the background. You only hear back from it when &#34;something of interest&#34; happens. You can instantiate as many actors as you need to handle the load.</p><p>I am not familiar with any actors libraries in .Net although I know there are some. I am familiar with the TPL Dataflow library (there will be a section covering it in my book <a href="http://dataflowbook.com/" rel="nofollow">http://DataflowBook.com</a>) and it should be easy to implement a simple actor model with that library.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../c-is-there-such-a-thing-as-too-much-asynchronous-code/'>C# &#8211; Is there such a thing as too much asynchronous code</a></li><li class="list-group-item"><a href='../will-net-4-5-make-the-reactive-extensions-obsolete/'>Will .NET 4.5 Make the Reactive Extensions Obsolete</a></li><li class="list-group-item"><a href='../c-do-reactive-extensions-and-etl-go-together/'>C# &#8211; Do reactive extensions and ETL go together</a></li><li class="list-group-item"><a href='../rest-mixing-rest-and-websocket-in-the-same-api/'>Rest &#8211; Mixing REST and websocket in the same API</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>