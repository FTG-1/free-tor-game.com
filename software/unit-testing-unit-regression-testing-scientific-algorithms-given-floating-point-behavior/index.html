<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Unit-testing &#8211; Unit (regression) testing scientific algorithms given floating point behavior &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1088015 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1088015" class="post-1088015 software type-software status-publish hentry category-software tag-algorithms tag-floating-point tag-test-automation tag-unit-testing"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Unit-testing &#8211; Unit (regression) testing scientific algorithms given floating point behavior</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">algorithms</span><span class="mr-2 badge badge-info">floating point</span><span class="mr-2 badge badge-warning">test-automation</span><span class="mr-2 badge badge-primary">unit testing</span></p><div class="entry-content"><p>I have been working on a project and running into a very difficult problem.<br /> The problem can be stated simply as how to unit-test numerical algorithms.<br /> However if you just took this simple statement you would get the standard set of answer isolation of input, random processes, mocking, tolerancing, etc.<br /> The answer (if there is one) does not reside with these.</p><p>Also, as a note, I am not concerned with testing the correctness of the algorithm.  That is done with very different methods and it is assumed that the algorithm is correct.  What I am using unit-testing for is to make sure that changes in other parts of the system/support algorithms do not change the output of the algorithm under test.</p><p>So, for a description of the problem:<br /> We have an algorithm which takes Gigabits of data, processing it, and generates an image with a corresponding map of which pixels are good and which ones are not.  It is this map which I need to verify does not change and pixels which are not valid are not to be used in any way other than the fact that they invalid.</p><p>If this was all that was given I would have many possible solutions and in fact the method have been using for years is to look at the number of valid pixels, the average, standard deviation, peak and valley of the image.  This has proven very sensitive detector for changes.</p><p>But, this year has added complications which is causing issues with this approach.</p><ul><li>The number of threads being used has increased causing changes in the floating point behavior.  In the past the smaller number of thread was accounted for in the tolerances used.</li><li>We have been using floating point (as compared to double) to increase throughput.  This has caused the rounding behavior to change even more and combined with the number of threads makes it worse.  This has also been made worse as we move to using SIMD processing like GPU and/or AVX instructions sets.</li><li>We have been enhancing the algorithms used to recover more of the pixels which would have been marked as invalid in the past are not valid.  This combined with 1 and 2 above is resulting in some pixels being included on some machine and not on others.  Since these are on the edge of useability these difference are handled by the algorithms with use this image and are not of concern for the system as a whole, but are causing problems with unit testing the algorithms.</li><li>We have also recently ran into the problem that two numbers (internal to the calculation) are the same and because of the rounding behavior one or the other is picked resulting in different outputs.  .  Again this is not a problem of the system as a whole, only with unit testing to flag for differences.</li><li>As a minor side example, we also have other non-linear algorithms with due to rounding behavior can give different outputs.  Since these algorithms are self correcting the final solution is good, but has a higher variability than easily accounted for unless the tolerances are opened larger than desired.</li></ul><p>So, my questions is how to account for these issue in unit testing.<br /> I strongly need unit testing because we have a team of programmers working on the system and we need the ability to detect when someone makes a change which unknowingly impacts other algorithms.  Yes this has happened in the past and the method being used at the time caught the change before it reached the final product.  As the primary algorithm developer I can use your help.  I have had many ideas, but they don’t work for all cases and it’s not clear when to use one of the different methods.</p><p><strong>Edit:</strong> I now that this is frequently called regression testing but I also know that many time it is also generically called unit testing by many people, even if it&#39;s not completely correct.</p><p>I am not necessarily looking for a magic bullet (that would be nice) but I do need a way of handling these issues in a way which can be handled by others in the group which may not be as knowledgeable on the details.  If that is a “pick” one of these methods that is fine if it the rule are clear.  We do adjust the parameters when we change the algorithms, but once it is fixed the floating point behavior is still causing differences.  When we see differences we always investigate why and in general we try to adjust the algorithm to reduce the difference, but there are times where these is not possible because of the additional computation time.  If we stayed away from the limits this would not be an issue (as in the past) but to advance the technology we need to push the limits giving rise to the issues described.</p><p>You can see this in a simple example. Calculating an average of many numbers.  If you stay with number which are close to each other, there are simple methods to make sure the results are accurate.  Now when you allow for numbers which have large (orders of mag) difference, with threading, float compared to double, etc you can get very different results. Yes I know there are algorithms which can be used to fix these issue but they can be very computation expensive. While averaging is not my problem you could imagine that the difference don’t impact downstream processing but you still want to write a test to monitor the calculation.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>First of all, it is not very clear if you compare floating point
numbers with exact values in your unit tests.  If you do so, this is
wrong and you should rely on approximate comparison of floating point
numbers [1].</p><p>That being said, if your computations are sensitive to factors such as
the number of threads involved, the precision of numbers used and the
other things you describe, then you should question the <em>stability</em> of
your numerical procedures.  If you are lucky, you can rewrite some
calculations to improve the stability without significantly change the
number of operations required.  But it might also happen, that writing
better procedures involves more calculations, so that you will have to
find an acceptable trade-off between time and precision.</p><p>[1] For instance, you can start here: <a href="http://www.gnu.org/software/gsl/manual/html_node/Approximate-Comparison-of-Floating-Point-Numbers.html" rel="nofollow">http://www.gnu.org/software/gsl/manual/html_node/Approximate-Comparison-of-Floating-Point-Numbers.html</a></p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../what-causes-floating-point-rounding-errors/'>What causes floating point rounding errors</a></li><li class="list-group-item"><a href='../unit-testing-of-inherently-random-non-deterministic-algorithms/'>Unit-testing of inherently random/non-deterministic algorithms</a></li><li class="list-group-item"><a href='../c-unit-testing-for-a-scientific-computing-library/'>C# &#8211; Unit testing for a scientific computing library</a></li><li class="list-group-item"><a href='../solutions-for-floating-point-rounding-errors/'>Solutions for floating point rounding errors</a></li><li class="list-group-item"><a href='../java-floating-point-calculation-being-too-exact/'>Java &#8211; Floating point calculation being too exact</a></li><li class="list-group-item"><a href='../c-unit-test-a-generic-floating-point-equality-function/'>C++ &#8211; Unit test a generic floating point equality function</a></li><li class="list-group-item"><a href='../unit-testing-is-testing-behavior-of-many-classes-in-one-test-still-unit-testing/'>Unit-testing &#8211; Is testing behavior of many classes in one test still unit testing</a></li><li class="list-group-item"><a href='../c-which-is-preferred-subclass-double-or-create-extension-methods-to-test-relative-equality-due-to-floating-point-differences/'>C# &#8211; Which is preferred: subclass double or create extension methods to test (relative) equality due to floating point differences</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>