<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Internal Mutation of Persistent Data Structures &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1082338 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1082338" class="post-1082338 software type-software status-publish hentry category-software tag-data-structures tag-functional-programming tag-immutability tag-multithreading"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Internal Mutation of Persistent Data Structures</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">data structures</span><span class="mr-2 badge badge-info">functional programming</span><span class="mr-2 badge badge-warning">immutability</span><span class="mr-2 badge badge-primary">multithreading</span></p><div class="entry-content"><p>To clarify, when I mean use the terms <em>persistent</em> and <em>immutable</em> on a data structure, I mean that:</p><ol><li>The state of the data structure remains unchanged for its lifetime. It always holds the same data, and the same operations always produce the same results.</li><li>The data structure allows <code>Add</code>, <code>Remove</code>, and similar methods that return new objects of its kind, modified as instructed, that may or may not share some of the data of the original object.</li></ol><p>However, while a data structure may seem to the user as persistent, it may do other things under the hood. To be sure, all data structures are, internally, at least somewhere, based on mutable storage.</p><p>If I were to base a persistent vector on an array, and copy it whenever <code>Add</code> is invoked, it would still be persistent, as long as I modify only locally created arrays.</p><p>However, sometimes, you can greatly increase performance by mutating a data structure under the hood. In more, say, insidious, dangerous, and destructive ways. Ways that might leave the abstraction untouched, not letting the user know anything has changed about the data structure, but being critical in the implementation level.</p><p>For example, let&#39;s say that we have a class called <code>ArrayVector</code> implemented using an array. Whenever you invoke <code>Add</code>, you get a <code>ArrayVector</code> build on top of a newly allocated array that has an additional item. A sequence of such updates will involve <code>n</code> array copies and allocations.</p><p>Here is an illustration:<br /> <img src="../../../i.stack.imgur.com/ywLvk.png" alt="enter image description here"/><br /> However, let&#39;s say we implement a lazy mechanism that stores all sorts of updates &#8212; such as <code>Add</code>, <code>Set</code>, and others in a queue. In this case, each update requires constant time (adding an item to a queue), and no array allocation is involved.</p><p>When a user tries to get an item in the array, all the queued modifications are applied under the hood, requiring a single array allocation and copy (since we know exactly what data the final array will hold, and how big it will be). Future get operations will be performed on an empty cache, so they will take a single operation. But in order to implement this, we need to &#39;switch&#39; or mutate the internal array to the new one, and empty the cache &#8212; a very dangerous action.</p><p>However, considering that in many circumstances (most updates are going to occur in sequence, after all), this can save a lot of time and memory, it might be worth it &#8212; you will need to ensure exclusive access to the internal state, of course.</p><p>This isn&#39;t a question about the efficacy of such a data structure. It&#39;s a more general question. Is it ever acceptable to mutate the internal state of a supposedly <em>persistent</em> or <em>immutable</em> object in destructive and dangerous ways? Does performance justify it? Would you still be able to call it immutable?</p><p>Oh, and could you implement this sort of laziness <em>without</em> mutating the data structure in the specified fashion?</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>I would be very loath to call a data structure &#34;immutable&#34; unless, once it was exposed to the outside world, unless all changes that are made to its internal state continue at all times to leave the object in the same observable state, and unless the state of the object would be valid with any arbitrary combination of those changes either happening or not happening.</p><p>An example of a reasonably-good &#34;immutable&#34; object which obeys this principle is the Java <code>string</code> type.  It includes a hash-code field which is initially zero, but which is used to memoize the result of querying the hash code.  The state of a <code>string</code> with a zero hash-code field is semantically the same as that of a string where the hash-code field is filled in.  If two threads simultaneously attempt to query the hash code, it&#39;s possible that both may end up performing the computation and storing the result, but it doesn&#39;t matter because neither store will affect the observable state of the object.  If a third thread comes along and queries the hash code, it might or might not see the stores from the first two, but the returned hash code will be the same regardless.</p><p>(BTW, my one quibble with Java&#39;s string-hashing method is that it&#39;s possible for the hash function to return zero for a non-null string.  I would have thought it better to have the hash function test for zero and substitute something else.  For example, if the hashing step is such that adding a single character to a string whose hash is zero will always yield a non-zero hash, simply return the hash of the string minus the last character.  Otherwise the worst-case time to hash a long string thousands of times may be much worse than the normal-case time.)</p><p>The big things to beware of are (1) sequences of operations which change the state of an object and then change it back, or (2) substitution of objects that appear to have the same state, but don&#39;t.  Ironically, Microsoft&#39;s fixing of what it regarded as bug in its default <code>Struct.Equals</code> method makes #2 harder to protect against.  If one has a number of immutable objects which hold references to what appear to be identical immutable objects, replacing all those references with references to one of those immutable objects should be safe.  Unfortunately, the <code>Equals</code> overrides for system types <code>Decimal</code>, <code>Double</code>, and <code>Float</code> will sometimes report <code>true</code> even when comparing slightly-different values.  It used to be that wrapping one of those types in a struct and calling <code>Equals</code> on that struct would test for true equivalence, but Microsoft changed things so a struct will report <code>Equals</code> if its members do, even if those members hold non-equivalent values of the aforementioned types.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../when-programmers-talk-about-data-structures-what-are-they-referring-to/'>When programmers talk about &#8220;data structures&#8221;, what are they referring to</a></li><li class="list-group-item"><a href='../uses-of-persistent-data-structures-in-non-functional-languages/'>Uses of persistent data structures in non-functional languages</a></li><li class="list-group-item"><a href='../workaround-for-implementing-operations-on-doubly-linked-or-circular-data-structures-in-languages-with-immutable-data/'>Workaround for implementing operations on doubly linked or circular data structures in languages with immutable data</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>