<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>C# &#8211;  fork a server program as an &#8220;C&#8221; child process in order for correct interprocess communication to take place &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1084772 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1084772" class="post-1084772 software type-software status-publish hentry category-software tag-c tag-linux tag-multithreading tag-pointers"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">C# &#8211;  fork a server program as an &#8220;C&#8221; child process in order for correct interprocess communication to take place</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">c</span><span class="mr-2 badge badge-info">linux</span><span class="mr-2 badge badge-warning">multithreading</span><span class="mr-2 badge badge-primary">pointers</span></p><div class="entry-content"><p>I would like to implement interprocess communication between an Ubuntu Linux 15.10 mono 4.1.2 C# recorder client and Ubuntu Linux 15.10 mono 4.1.2 C# video server using a C++ mutex  class and C++ event class  which harnesses pthreads, shm_open and mmap.</p><p>The recorder client and video server reside on the same Ubuntu Linux machine. In addition, a Windows 7 C# client running on a separate machine communicates with an Ubuntu Linux 15.10 C# client-server program using TCP/IP sockets.</p><p>In <em>Advanced Programming in the UNIX Environment Second Edition</em> by W. Richard Stevens and Stephen A. Rago, I read page  489 which states</p><blockquote><p>A memory-mapped region is inherited by a child across a fork (since it&#39;s part of the parent&#39;s address space) , but for the same reason, is not inherited by the new program across  an  exec</p></blockquote><p>I need to know if I have to fork the video server program as an &#34;C&#34; child process in order for interprocess communication to take place by casting the mmap return value to a pthread_mutex_t pointer . I want to share pthread mutex and pthread condition variable between the video server process and recorder client process.</p><p>Have I confused threads with processes?</p><p>Boost wrote an interesting article about this topic which  I have extracted an excerpt from shown below,</p><p><a href="http://www.boost.org/doc/libs/1_37_0/doc/html/interprocess/sharedmemorybetweenprocesses.html#interprocess.sharedmemorybetweenprocesses.mapped_region_object_limitations" rel="nofollow">http://www.boost.org/doc/libs/1_37_0/doc/html/interprocess/sharedmemorybetweenprocesses.html#interprocess.sharedmemorybetweenprocesses.mapped_region_object_limitations</a></p><p>Limitations When Constructing Objects In Mapped Regions<br /> Offset pointers instead of raw pointers</p><p>When two processes create a mapped region of the same mappable object, two processes can communicate writing and reading that memory. A process could construct a C++ object in that memory so that the second process can use it. However, a mapped region shared by multiple processes, can&#39;t hold any C++ object, because not every class is ready to be a process-shared object, specially, if the mapped region is mapped in different address in each process.</p><p>When placing objects in a mapped region and mapping that region in different address in every process, raw pointers are a problem since they are only valid for the process that placed them there. To solve this, Boost.Interprocess offers a special smart pointer that can be used instead of a raw pointer. So user classes containing raw pointers (or Boost smart pointers, that internally own a raw pointer) can&#39;t be safely placed in a process shared mapped region. These pointers must be replaced with offset pointers, and these pointers must point only to objects placed in the same mapped region if you want to use these shared objects from different processes.</p><p>Of course, a pointer placed in a mapped region shared between processes should only point to an object of that mapped region. Otherwise, the pointer would point to an address that it&#39;s only valid one process and other processes may crash when accessing to that address.</p><p>Basile Starynkevitch wrote on April 21 2016, &#34;The point is won&#39;t use pthread mutex and condition variable like you dream of. Be creative too&#8230;&#34; , in response to my question about how to emulate a Windows event in Linux.<br /> So, I found the pdf, Implementing Condition Variables with Semaphores , <a href="http://research.microsoft.com/pubs/64242/implementingcvs.pdf" rel="nofollow">http://research.microsoft.com/pubs/64242/implementingcvs.pdf</a>, written by Microsoft researcher , Andrew D. Birrell . Below . I show an excerpt from this article ,</p><pre><code>class Lock {
 Semaphore sm;
public Lock() { // constructor
 sm = new Semaphore(); sm.count =1; sm.limit = 1;
 }
public void Acquire() { sm.P(); }
public void Release() { sm.V(); }
}
You can come quite close to implementing a condition variable in a similar way:
class CV {
 Semaphore s;
 Lock m;
public CV(Lock m) { // Constructor
 this.m = m;
 s = new Semaphore(); s.count = 0; s.limit = 1;
 }
public void Wait() { // Pre-condition: this thread holds “m”
 m.Release();
 s.P();
 m.Acquire();
 }
public void Signal() {
 s.V();
 }
}
</code></pre><p>Could I  harness Andrew D. Birrell&#39;s research to emulate a Windows event with a class like this:</p><pre><code>class Event {
    Lock theLock;
    CV   theCV;
    bool triggered;

    Event* MakeEvent(string Name);
    Event* OpenEvent(string Name);
    void   CloseEvent(string Name, Event* anEvent);
    void   NukeEvent(string Name, Event* anEvent);
    void   SetEvent(Event* anEvent);
    void   ResetEvent(Event* anEvent);
    int    WaitForSingleObject(Event* anEvent, int millisecond);
}
</code></pre><p>?</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>Don&#39;t use Pthread mutexes to synchronize between <em>processes</em>, at least on Linux. (I am not sure that Linux is implementing <a href="http://pubs.opengroup.org/onlinepubs/9699919799/functions/pthread_mutexattr_getpshared.html" rel="nofollow">pthread_mutexattr_setpshared</a> correctly and efficiently, at least <a href="https://fossies.org/diffs/glibc/2.21_vs_2.22/nptl/pthread_mutexattr_setpshared.c-diff.html" rel="nofollow">not in GNU glibc 2.21</a>).</p><p>Use POSIX semaphores, see <a href="http://man7.org/linux/man-pages/man7/sem_overview.7.html" rel="nofollow">sem_overview(7)</a>. Or consider the Linux specific <a href="http://man7.org/linux/man-pages/man2/eventfd.2.html" rel="nofollow">eventfd(2)</a> probably with <a href="http://man7.org/linux/man-pages/man2/poll.2.html" rel="nofollow">poll(2)</a> &amp; <a href="http://man7.org/linux/man-pages/man2/read.2.html" rel="nofollow">read(2)</a> &amp; <a href="http://man7.org/linux/man-pages/man2/write.2.html" rel="nofollow">write(2)</a>. Both (semaphores &amp; <code>eventfd</code>-s) are alternative synchronization mechanisms (to mutex between <em>processes</em>).</p><p>You might also study the source code of your C# implementation (both Mono and Microsoft CLR are today free software). And you might also use <a href="http://man7.org/linux/man-pages/man1/strace.1.html" rel="nofollow">strace(1)</a> or <a href="http://man7.org/linux/man-pages/man1/ltrace.1.html" rel="nofollow">ltrace(1)</a> to understand what your C# program is doing.</p><p>The point is that you won&#39;t use pthread mutex &amp; condvar like you dream of. You need to be creative. If using <code>eventfd</code>, you might have some additional thread polling it, and then broadcast a condvar ... If using semaphores, be creative too...</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../c-debugging-memory-corruption/'>C++ &#8211; Debugging memory corruption</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>