<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>C++: Should class own or observe its dependencies &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1072450 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1072450" class="post-1072450 software type-software status-publish hentry category-software tag-c tag-dependency-injection tag-smart-pointer"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">C++: Should class own or observe its dependencies</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">c</span><span class="mr-2 badge badge-info">dependency-injection</span><span class="mr-2 badge badge-warning">smart-pointer</span></p><div class="entry-content"><p>Say I have a class <code>Foobar</code> that uses (depends on) class <code>Widget</code>. In good ol&#39; days, <code>Widget</code> wolud be declared as a field in <code>Foobar</code>, or maybe as a smart pointer if polymorphic behavior was needed, and it would be initialized in constructor:</p><pre><code>class Foobar {
    Widget widget;
    public:
    Foobar() : widget(blah blah blah) {}
    // or
    std::unique_ptr&lt;Widget&gt; widget;
    public:
    Foobar() : widget(std::make_unique&lt;Widget&gt;(blah blah blah)) {}
    (…)
};
</code></pre><p>And we&#39;d be all set and done. Unfortunately, today, Java kids will laugh at us once they see it, and rightfully, as it couples <code>Foobar</code> and <code>Widget</code> together. The solution is seemingly simple: apply Dependency Injection to take construction of dependencies out of <code>Foobar</code> class. But then, C++ forces us to think about ownership of dependencies. Three solutions come to mind:</p><h2>Unique pointer</h2><pre><code>class Foobar {
    std::unique_ptr&lt;Widget&gt; widget;
    public:
    Foobar(std::unique_ptr&lt;Widget&gt; &amp;&amp;w) : widget(w) {}
    (…)
}
</code></pre><p><code>Foobar</code> claims sole ownership of <code>Widget</code> that is passed to it. This has following advantages:</p><ol><li>Impact on performance is negligible.</li><li>It&#39;s safe, as <code>Foobar</code> controls lifetime od its <code>Widget</code>, so it makes sure that <code>Widget</code> doesn&#39;t suddenly disappear.</li><li>It&#39;s safe that <code>Widget</code> won&#39;t leak and will be properly destructed when no longer needed.</li></ol><p>However, this comes at a cost:</p><ol><li>It places restrictions on how <code>Widget</code> instances can be used, e.g. no stack-allocated <code>Widgets</code> can be used, no <code>Widget</code> can be shared.</li></ol><h2>Shared pointer</h2><pre><code>class Foobar {
    std::shared_ptr&lt;Widget&gt; widget;
    public:
    Foobar(const std::shared_ptr&lt;Widget&gt; &amp;w) : widget(w) {}
    (…)
}
</code></pre><p>This is probably closest equivalent ot Java and other garbage collected languages. Advantages:</p><ol><li>More universal, as it allows sharing dependencies.</li><li>Maintains safety (points 2 and 3) of <code>unique_ptr</code> solution.</li></ol><p>Disadvantages:</p><ol><li>Wastes resources when no sharing is involved.</li><li>Still requires heap allocation and disallows stack-allocated objects.</li></ol><h2>Plain ol&#39; observing pointer</h2><pre><code>class Foobar {
    Widget *widget;
    public:
    Foobar(Widget *w) : widget(w) {}
    (…)
}
</code></pre><p>Place raw pointer inside class and shift the burden of ownership to someone else. Pros:</p><ol><li>As simple as it can get.</li><li>Universal, accepts just any <code>Widget</code>.</li></ol><p>Cons:</p><ol><li>Not safe anymore.</li><li>Introduces another entity that is responsible for ownership of both <code>Foobar</code> and <code>Widget</code>.</li></ol><h2>Some crazy template metaprogramming</h2><p>The only advantage I can think of is that I&#39;d be able to read all those books I didn&#39;t find time for while my software is builing;)</p><p>I lean towards the third solution, as it is most universal, something has to manage <code>Foobars</code> anyway, so managing <code>Widgets</code> is simple change. However, using raw pointers bothers me, on the other hand smart pointer solution feel wrong to me, as they make consumer of dependency restrict how that dependency is created.</p><p>Am I missing something? Or is just Dependency Injection in C++ not trivial? Should class own its dependencies or just observe them?</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p><strong>I meant to write this as a comment, but it turned out to be too long.</strong></p><blockquote><p>How I know that <code>Foobar</code> is the only owner? In the old case it&#39;s simple. But the problem with DI, as I see it, is as it decouples class from construction of its dependencies, it also decouples it from ownership of those dependencies (as ownership is tied to construction). In garbage collected environments such as Java, that&#39;s not a problem. In C++, this is.</p></blockquote><p>Whether you should use <code>std::unique_ptr&lt;Widget&gt;</code> or <code>std::shared_ptr&lt;Widget&gt;</code>, that is up to you to decide and comes from your functionality.</p><p>Let&#39;s assume you have a <code>Utilities::Factory</code>, which is responsible for the creation of your blocks, such as <code>Foobar</code>. Following the DI principle, you will need the <code>Widget</code> instance, to inject it using <code>Foobar</code>&#39;s constructor, meaning inside one of the <code>Utilities::Factory</code>&#39;s method, for example <code>createWidget(const std::vector&lt;std::string&gt;&amp; params)</code>, you create the Widget and inject it into the <code>Foobar</code> object.</p><p>Now you have a <code>Utilities::Factory</code> method, which created the <code>Widget</code> object. Does it mean, the method should me responsible for its deletion? Of course not. It is only there to make you the instance.</p><hr/><p>Let&#39;s imagine, you are developing an application, which will have multiple windows. Each window is represented using the <code>Foobar</code> class, so in fact the <code>Foobar</code> acts like a controller.</p><p>The controller will probably make use of some of your <code>Widget</code>s and you have to ask yourself:</p><p><em>If I go on this specific window in my application, I will need these Widgets. Are these widgets shared among other application windows? If so, I shouldn&#39;t be probably creating them all over again, because they will always look the same, because they are shared.</em></p><p><code>std::shared_ptr&lt;Widget&gt;</code> is the way to go.</p><p>You also have an application window, where there is a <code>Widget</code> specifically tied to this one window only, meaning it won&#39;t be displayed anywhere else. So if you close the window, you don&#39;t need the <code>Widget</code> anywhere in your application anymore, or at least its instance.</p><p>That&#39;s where <code>std::unique_ptr&lt;Widget&gt;</code> comes to claim its throne.</p><hr/><p><strong>Update:</strong></p><p>I don&#39;t really agree with <em>@DominicMcDonnell</em>, about the lifetime issue. Calling <code>std::move</code> on <code>std::unique_ptr</code> completely transfers the ownership, so even if you create an <code>object A</code> in a method and pass it to another <code>object B</code> as a dependency, the <code>object B</code> will now be responsible for the resource of <code>object A</code> and will correctly delete it, when <code>object B</code> goes out of scope.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../is-it-ok-to-have-many-dependencies-in-a-class-that-just-delegates-work/'>Is it ok to have many dependencies in a class that just delegates work</a></li><li class="list-group-item"><a href='../c-dependency-injection-should-i-create-a-car-class-to-hold-all-of-its-parts/'>C++ &#8211; Dependency Injection: Should I create a Car class to hold all of its parts</a></li><li class="list-group-item"><a href='../c-should-i-use-a-unique_ptr-with-an-array-type-or-a-vector/'>C++ &#8211; Should I use a unique_ptr with an array type, or a vector</a></li><li class="list-group-item"><a href='../c-should-net-core-class-libraries-register-their-own-implementations/'>C# &#8211; Should .NET Core class libraries register their own implementations</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>