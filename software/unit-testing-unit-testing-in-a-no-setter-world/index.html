<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Unit-testing &#8211; Unit Testing in a &#8220;no setter&#8221; world &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1069533 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1069533" class="post-1069533 software type-software status-publish hentry category-software tag-domain-driven-design tag-unit-testing"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Unit-testing &#8211; Unit Testing in a &#8220;no setter&#8221; world</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">domain-driven-design</span><span class="mr-2 badge badge-info">unit testing</span></p><div class="entry-content"><p>I do not consider myself a DDD expert but, as a solution architect, do try to apply best practices whenever possible.  I know there is a lot of discussion around the pro&#39;s and con&#39;s of the no (public) setter &#34;style&#34; in DDD and I can see both sides of the argument.  My problem is that I work on a team with a wide diversity in skills, knowledge and experience meaning that I cannot trust that every developer will do things the &#34;right&#34; way.  For instance, if our domain objects are designed so that changes to the object&#39;s internal state is performed by a method but provide public property setters, someone will inevitable set the property instead of calling the method.  Use this example:</p><pre><code>public class MyClass
{
    public Boolean IsPublished
    {
        get { return PublishDate != null; }
    }

    public DateTime? PublishDate { get; set; }

    public void Publish()
    {
        if (IsPublished)
            throw new InvalidOperationException(&#34;Already published.&#34;);

        PublishDate = DateTime.Today;

        Raise(new PublishedEvent());
    }
}
</code></pre><p>My solution has been to make property setters private which is possible because the ORM we are using to hydrate the objects uses reflection so it is able to access private setters.  However, this presents a problem when trying to write unit tests.  For example, when I want to write a unit test that verifies the requirement that we can&#39;t re-publish, I need to indicate that the object has already been published.  I can certainly do this by calling Publish twice, but then my test is assuming that Publish is implemented correctly for the first call. That seems a little smelly.</p><p>Let&#39;s make the scenario a little more real-world with the following code:</p><pre><code>public class Document
{
    public Document(String title)
    {
        if (String.IsNullOrWhiteSpace(title))
            throw new ArgumentException(&#34;title&#34;);

        Title = title;
    }

    public String ApprovedBy { get; private set; }
    public DateTime? ApprovedOn { get; private set; }
    public Boolean IsApproved { get; private set; }
    public Boolean IsPublished { get; private set; }
    public String PublishedBy { get; private set; }
    public DateTime? PublishedOn { get; private set; }
    public String Title { get; private set; }

    public void Approve(String by)
    {
        if (IsApproved)
            throw new InvalidOperationException(&#34;Already approved.&#34;);

        ApprovedBy = by;
        ApprovedOn = DateTime.Today;
        IsApproved = true;

        Raise(new ApprovedEvent(Title));
    }

    public void Publish(String by)
    {
        if (IsPublished)
            throw new InvalidOperationException(&#34;Already published.&#34;);

        if (!IsApproved)
            throw new InvalidOperationException(&#34;Cannot publish until approved.&#34;);

        PublishedBy = by;
        PublishedOn = DateTime.Today;
        IsPublished = true;

        Raise(new PublishedEvent(Title));
    }
}
</code></pre><p>I want to write unit tests that verify:</p><ul><li>I cannot publish unless the Document has been approved</li><li>I cannot re-publish a Document</li><li>When published, the PublishedBy and PublishedOn values are properly<br /> set</li><li>When publised, the PublishedEvent is raised</li></ul><p>Without access to the setters, I cannot put the object into the state needed to perform the tests.  Opening access to the setters defeats the purpose of preventing access.</p><p>How do(have) you solve(d) this problem?</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><blockquote><p>I cannot put the object into the state needed to perform the tests.</p></blockquote><p>If you cannot put the object into the state needed to perform a test, then you cannot put the object into the state in production code, so there&#39;s no need to test <strong>that</strong> state. Obviously, this isn&#39;t true in your case, you <strong>can</strong> put your object into the needed state, just call Approve.</p><ul><li><p>I cannot publish unless the Document has been approved: write a test that calling publish before calling approve causes the right error without changing the object state.</p><pre><code>void testPublishBeforeApprove() {
    doc = new Document(&#34;Doc&#34;);
    AssertRaises(doc.publish, ..., NotApprovedException);
}
</code></pre></li><li><p>I cannot re-publish a Document: write a test that approves an object, then calling publish once succeed, but second time causes the right error without changing the object state.</p><pre><code>void testRePublish() {
    doc = new Document(&#34;Doc&#34;);
    doc.approve();
    doc.publish();
    AssertRaises(doc.publish, ..., RepublishException);
}
</code></pre></li><li><p>When published, the PublishedBy and PublishedOn values are properly set: write a test that calls approve then call publish, assert that the object state changes correctly</p><pre><code>void testPublish() {
    doc = new Document(&#34;Doc&#34;);
    doc.approve();
    doc.publish();
    Assert(doc.PublishedBy, ...);
    ...
}
</code></pre></li><li><p>When publised, the PublishedEvent is raised: hook to the event system and set a flag to make sure it&#39;s called</p></li></ul><p>You also need to write test for approve.</p><p>In other word, don&#39;t test the relation between internal fields and IsPublished and IsApproved, your test would be quite fragile if you do that since changing your field would mean changing your tests code, so the test would be quite pointless. Instead you should test the relationship between calls of public methods, this way, even if you modify the fields you wouldn&#39;t need to modify the test.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../c-interfacing-application-code-with-unit-tests/'>C++ &#8211; Interfacing application code with unit tests</a></li><li class="list-group-item"><a href='../architecture-domain-model-design-best-practices-for-robust-fluency-encapsulation-and-extensibility/'>Architecture &#8211; Domain Model Design &#8211; Best Practices for Robust Fluency, Encapsulation, and Extensibility</a></li><li class="list-group-item"><a href='../php-how-to-pass-a-mock-object-into-a-class-for-unit-tests/'>Php &#8211; How to pass a mock object into a class for unit tests</a></li><li class="list-group-item"><a href='../a-problem-with-understanding-aggregates-and-aggregate-roots-in-domain-driven-design-ddd/'>A problem with understanding aggregates and aggregate roots in Domain Driven Design (DDD)</a></li><li class="list-group-item"><a href='../unit-testing-how-should-i-unit-test-a-data-transfer-object/'>Unit-testing &#8211; How Should I Unit Test A Data Transfer Object</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>