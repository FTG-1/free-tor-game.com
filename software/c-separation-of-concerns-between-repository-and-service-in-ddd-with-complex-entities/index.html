<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>C# &#8211; Separation of concerns between repository and service in DDD with complex entities &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1079142 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1079142" class="post-1079142 software type-software status-publish hentry category-software tag-asp-net-mvc tag-c tag-domain-driven-design tag-sql"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">C# &#8211; Separation of concerns between repository and service in DDD with complex entities</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">asp.net-mvc</span><span class="mr-2 badge badge-info">c</span><span class="mr-2 badge badge-warning">domain-driven-design</span><span class="mr-2 badge badge-primary">sql</span></p><div class="entry-content"><p>This probably seems as an example of opinion-based question, but I&#39;m actually looking for rationale on how to decide correctly, I believe there is a correct solution that can be backed by solid arguments (that&#39;s why I chose SO and hope is really not only opinion based, but I can be wrong; if you&#39;d feel so, please leave a note in a comment). I can&#39;t decode how far to go with SoC in DDD and whether is ok to have mostly empty domain objects.</p><p>We have .NET, DDD, mainly use EF as our ORM in repositories, our application lives in Azure. For complex queries, we use stored procedures that return multisets (because of Azure SQL) &#8211; so one query = one round trip to the server (is&#39;s worth it, the query is performed usually on &gt; 10 separate tables, no joins, so it would require many round trips).</p><p>For simplicity, imagine domain object called NavigationItem, that have multiple titles (in different languages), items are stored in one table, localized titles are stored in another table, where foreign key is the item title contains culture id.</p><p>The navigation object might look like this:</p><pre><code>public class NavigationItem
{
    public int FileRecordId { get; set; }

    public int? ParentId { get; set; }

...

    public Dictionary&lt;int, string&gt; Title { get; set; }
}
</code></pre><p>So the domain object, returned by repository, is constructed (in repository) this way:</p><pre><code>// load list of navigation items
var reader = command.ExecuteReader();
navigation.Items = ((IObjectContextAdapter)_context).ObjectContext.Translate&lt;NavigationItem&gt;(reader).ToList();

// process localized titles
reader.NextResult();
var titles = ((IObjectContextAdapter)_context).ObjectContext.Translate&lt;TitleInfo&gt;(reader).ToList();

// associate titles, so the whole NavigationItem is constructed
foreach (var item in navigation.Items)
{
    item.Title = titles.Where(t =&gt; t.FileRecordId == item.FileRecordId).ToDictionary(key =&gt; key.CultureId, value =&gt; value.Title);
}
</code></pre><p>This is simple example, just to get the point &#8211; my question is, wouldn&#39;t it be better to return just list of navigation items (where I should omit the Title property) and list of titles and combine that in a service layer, when creating DTD object? Repository is responsible for persistence and retrieving persisted data, and I&#39;m not sure, whether this is simply &#34;too much&#34;. On the other hand, the requirement on repository might be just &#34;give me whole entity with titles&#34;. Separation of concerns is naturally a good way, but I&#39;m not sure if this is still concern of the repository.</p><p>Please take this just as a simple example, my question is more general &#8211; in this example, each domain object NavigationItem contains Title, so it feels it&#39;s OK to do this in repository. But when we have more complex etities, there is another problem &#8211; e.g., each File has common properties, like Name. Some files have image properties, same have also pdf document properties, some have localized titles&#8230; some don&#39;t. In this case, it seems much more &#34;natural&#34; to have one entity (common File), and return List, List, List, &#8230; from repository and combine it in the service. Or on the other hand, do all the translation in repository, but it would mean that domain object (aggregate root) File will contain entities like ImageInfo, TitleInfo, etc., which will be in most cases null.</p><p>What approach &#8211; and mainly, why &#8211; would you recommend?</p><p>EDIT: To be more specific &#8211; from DDD perspective, is it ok keep Entity partially empty and sometimes in repository just retrieve few properties (or sometimes all of them), or is better approach to separate such entity to smaller ones and return one entity that aggregates lists of all possible entities? I believe that there can be reasonable answer, typically &#34;yes, partly initialized entity is ok&#34;, or &#34;no, it&#39;s wrong and you should always use as granular entities as possible&#34;, etc.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>Sounds like you are using domain entities for both domain operations (commands, which modify application state) and queries (which don&#39;t modify application state, but return data for the user). The problems you describe are a direct result of trying to get that single domain entity to do both jobs, which don&#39;t mix very well.</p><p>My recommendation is to read on CQRS (Command Query Responsibility Segragation) e.g. <a href="http://martinfowler.com/bliki/CQRS.html" rel="nofollow">CQRS by Martin Fowler</a> and try to limit your domain entities to only retrieve what data they need to complete the domain operation. Even though the amount of classes and interfaces will grow, your application will become much more simple and more maintainable due to more adherence to the <a href="http://code.tutsplus.com/tutorials/solid-part-1-the-single-responsibility-principle--net-36074" rel="nofollow">Single Responsibility Principle</a>.</p><p>Also, your choice of domain objects and especially Aggregate roots leads me to question the validity of your domain model. Is a File really such an entity, that it&#39;s of dire meaning to the business people? What kind of operations do you do on the file, and what&#39;s their value to the business? The whole idea in Domain Driven Design is to identify the actual business entities on which you should act, as if you wouldn&#39;t have a computer at all. An Order is a common example. Operations on that Aggragate root would be &#34;Submit&#34;, &#34;Cancel&#34; etc. File is just an infrastructural concern, which most often has no value or place in the domain logic.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../c-entity-framework-and-eager-loading-and-enterprise-application-with-ddd-aproach/'>C# &#8211; Entity framework and Eager loading and enterprise application with DDD aproach</a></li><li class="list-group-item"><a href='../object-oriented-relations-between-entities-in-ddd/'>Object-oriented &#8211; Relations between entities in DDD</a></li><li class="list-group-item"><a href='../ddd-how-to-avoid-breaking-encapsulation-and-leaking-technical-concerns-to-the-domain-during-model-rehydration/'>DDD: How to avoid breaking encapsulation and leaking technical concerns to the domain during model rehydration</a></li><li class="list-group-item"><a href='../c-is-it-normal-for-a-domain-model-not-to-have-an-id/'>C# &#8211; Is it normal for a Domain Model not to have an ID</a></li><li class="list-group-item"><a href='../ddd-is-an-aggregate-root-responsible-for-deleting-its-child-entities-from-their-repository/'>DDD: Is an aggregate root responsible for deleting its child entities from their repository</a></li><li class="list-group-item"><a href='../c-domain-driven-design-navigation-properties-and-aggregate/'>C# &#8211; Domain Driven Design // Navigation Properties and Aggregate</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>