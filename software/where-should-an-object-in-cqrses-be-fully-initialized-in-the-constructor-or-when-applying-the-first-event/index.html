<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Where should an object in CQRS+ES be fully initialized: in the constructor, or when applying the first event &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1079613 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1079613" class="post-1079613 software type-software status-publish hentry category-software tag-constructors tag-cqrs tag-event-sourcing tag-initialization"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Where should an object in CQRS+ES be fully initialized: in the constructor, or when applying the first event</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">constructors</span><span class="mr-2 badge badge-info">cqrs</span><span class="mr-2 badge badge-warning">event-sourcing</span><span class="mr-2 badge badge-primary">initialization</span></p><div class="entry-content"><p>There appears to be widespread agreement in the OOP community that the class constructor should not leave an object partly or even fully uninitialized.</p><blockquote><p><sub><strong>What do I mean by &#34;initialization&#34;?</strong> Roughly speaking, the <em>atomic</em> process that brings a newly created object into a state where all of its class invariants hold. It should be the first thing that happens to an object, (it should only run once per object,) and nothing should be permitted to get hold of an un-initialized object. (Thus the frequent advice to perform object initialization right in the class constructor. For the same reason, <code>Initialize</code> methods are often frowned upon, as these break apart the atomicity and make it possible to get hold of, and use, an object that is not yet in a well-defined state.)</sub></p></blockquote><p><strong>Problem:</strong> When CQRS is combined with event sourcing (CQRS+ES), where all state changes of an object are caught in an ordered series of events (event stream), I am left wondering when an object actually reaches a fully-initialized state: At the end of the class constructor, or after the very first event has been applied to the object?</p><blockquote><p><sub><strong>Note:</strong> I&#39;m refraining from using the term &#34;aggregate root&#34;. If you prefer, substitute it whenever you read &#34;object&#34;.</sub></p></blockquote><p><strong>Example for discussion:</strong> Assume that each object is uniquely identified by some opaque <code>Id</code> value (think GUID). An event stream representing that object&#39;s state changes can be identified in the event store by the same <code>Id</code> value: (Let&#39;s not worry about correct event order.)</p><pre class="lang-cs prettyprint-override"><code>interface IEventStore
{
    IEnumerable&lt;IEvent&gt; GetEventsOfObject(Id objectId); 
}
</code></pre><p>Assume further that there are two object types <code>Customer</code> and <code>ShoppingCart</code>. Let&#39;s focus on <code>ShoppingCart</code>: When created, shopping carts are empty and must be associated with exactly one customer. That last bit is a class invariant: A <code>ShoppingCart</code> object that is not associated to a <code>Customer</code> is in an invalid state.</p><p>In traditional OOP, one might model this in the constructor:</p><pre class="lang-cs prettyprint-override"><code>partial class ShoppingCart
{
    public Id Id { get; private set; }
    public Customer Customer { get; private set; }

    public ShoppingCart(Id id, Customer customer)
    {
        this.Id = id;
        this.Customer = customer;
    }
}
</code></pre><p>I am however at a loss how to model this in CQRS+ES without ending up with deferred initialization. Since this simple bit of initialization is effectively a state change, wouldn&#39;t it have to be modelled as an event?:</p><pre class="lang-cs prettyprint-override"><code>partial class CreatedEmptyShoppingCart
{
    public ShoppingCartId { get; private set; }
    public CustomerId { get; private set; }
}
// Note: `ShoppingCartId` is not actually required, since that Id must be
// known in advance in order to fetch the event stream from the event store.
</code></pre><p>This would obviously have to be the very first event in any <code>ShoppingCart</code> object&#39;s event stream, and that object would only be initialized once the event were applied to it.</p><p>So if initialization becomes part of the event stream &#34;playback&#34; (which is a very generic process that would likely work the same, whether for a <code>Customer</code> object or a <code>ShoppingCart</code> object or any other object type for that matter)…</p><ul><li>Should the constructor be parameter-less and do nothing, leaving all work to some <code>void Apply(CreatedEmptyShoppingCart)</code> method (which is much the same as the frowned-upon <code>Initialize()</code>)?</li><li>Or should the constructor receive an event stream and play it back (which makes initialization atomic again, but means that each class&#39; constructor contains the same generic &#34;play back &amp; apply&#34; logic, i.e. unwanted code duplication)?</li><li>Or should there be both a traditional OOP constructor (as shown above) that properly initializes the object, and <em>then</em> all events but the first are <code>void Apply(…)</code>-ied to it?</li></ul><p>I do not expect of answer to provide a fully working demo implementation; I&#39;d already be very happy if someone could explain where my reasoning is flawed, or whether object initialization really <em>is</em> a &#34;pain point&#34; in most CQRS+ES implementations.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>When doing CQRS+ES I prefer not having public constructors at all. Creating my aggregate roots should be done via a factory (for simple enough constructions such as this) or a builder (for more complicated aggregate roots).</p><p>How to then actually initialize the object is an implementation detail. The OOP &#34;Don&#39;t use initialize&#34;-advice is imho about <em>public interfaces</em>. You should not expect that anyone that uses your code knows that they must call SecretInitializeMethod42(bool,int,string) - that&#39;s bad public API design. However if your class does not provide any public constructor but instead there is a ShoppingCartFactory with the method CreateNewShoppingCart(string) then the implementation of that factory may very well hide any kind of initialization/constructor magic which your user then don&#39;t need to know about (thus providing a nice public API, but allowing you to do more advanced object creation behind the scenes).</p><p>Factories get a bad rep from people thinking there&#39;s too many of them, but used correctly they can hide away a lot of complexity behind a nice easy-to-understand public API. Don&#39;t be afraid to use them, they&#39;re a powerful tool which can help you make complex object construction much easier - as long as you can live with some more lines of code.</p><p>It&#39;s not a race to see who can solve the problem with the least lines of code - it is however an ongoing competition as to who can make the nicest public API&#39;s! ;)</p><p>Edit: Adding some examples on how applying these patterns could look</p><p>If you just have an &#34;easy&#34; aggregate constructor that has a couple of required parameters you can go with just a very basic factory implementation, something along these lines</p><pre><code>public class FooAggregate {
     internal FooAggregate() { }

     public int A { get; private set; }
     public int B { get; private set; }

     internal Handle(FooCreatedEvent evt) {
         this.A = a;
         this.B = b;
     }
}

public class FooFactory {
    public FooAggregate Create(int a, int b) {
        var evt = new FooCreatedEvent(a, b);
        var result = new FooAggregate();
        result.Handle(evt);
        DomainEvents.Register(result, evt);
        return result;
    }
}
</code></pre><p>Of course, exactly how you divide creating the FooCreatedEvent is in this case up to you. One could also make a case for having a FooAggregate(FooCreatedEvent) constructor, or having a FooAggregate(int, int) constructor that creates the event. Exactly how you choose to divide the responsibility here is up to what you think is the cleanest and how you have implemented your domain event registration. I often choose to have the factory create the event - but it&#39;s up to you since event creation is now an internal implementation detail that you can change and refactor at any time without changing your external interface. An important detail here is that the aggregate does not have a public constructor and that all the setters are private. You don&#39;t want anyone to use them externally.</p><p>This pattern works fine when you&#39;re just more or less replacing constructors, but if you have more advanced object construction this may become way too complex to use. In this case I usually forego the factory pattern and turn to a builder pattern instead - often with a more fluent syntax.</p><p>This example is a bit forced since the class it builds isn&#39;t very complex, but you can hopefully grasp the idea and see how it would ease more complex construction tasks</p><pre><code>public class FooBuilder {
    private int a;
    private int b;   

    public FooBuilder WithA(int a) {
         this.a = a;
         return this;
    }

    public FooBuilder WithB(int b) {
         this.b = b;
         return this;
    }

    public FooAggregate Build() {
         if(!someChecksThatWeHaveAllState()) {
              throw new OmgException();
         }

         // Some hairy logic on how to create a FooAggregate and the creation events from our state
         var foo = new FooAggregate(....);
         foo.PlentyOfHairyInitialization(...);
         DomainEvents.Register(....);

         return foo;
    }
}
</code></pre><p>And then you use it like</p><pre><code>var foo = new FooBuilder().WithA(1).Build();
</code></pre><p>And of course, generally when I turn to the builder pattern it&#39;s not just two ints, it may contain lists of some value objects or dictionaries of some kind of maybe some other more hairy things. It is however also quite useful if you have many combinations of optional parameters.</p><p>The important takeaways for going this way is:</p><ul><li>Your main objective is being able to abstract object construction so that the external user doesn&#39;t have to know about your event system.</li><li>It&#39;s not that important where or who registers the creation event, the important part is that it gets registered and that you can guarantee that - apart from that, it&#39;s an internal implementation detail. Do what fits your code the best, don&#39;t follow my example as some sort of &#34;this is the right way&#34;-thing.</li><li>If you want to, by going this way you could have your factories/repositories return interfaces instead of concrete classes - making them easier to mock for unit tests!</li><li>This is a lot of extra code sometimes, which makes many people shy away from it. But it&#39;s often quite easy code compared to the alternatives and it does provide value when you do sooner or later need to change stuff. There&#39;s a reason that Eric Evans talks about factories/repositories in his DDD-book as important parts of DDD - they are <em>necessary</em> abstractions to not leak certain implementation details to the user. And leaky abstractions are bad.</li></ul><p>Hope that helps a bit more, just ask for clarifications in comments otherwise :)</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../architecture-separation-of-construction-and-initialization/'>Architecture &#8211; Separation of construction and initialization</a></li><li class="list-group-item"><a href='../c-how-complex-a-constructor-should-be/'>C# &#8211; how complex a constructor should be</a></li><li class="list-group-item"><a href='../how-add-create-commands-should-be-handled-in-cqrs-event-sourcing-architecture/'>How Add/Create* commands should be handled in CQRS + Event Sourcing architecture</a></li><li class="list-group-item"><a href='../should-internal-entities-in-an-aggregate-respond-to-domain-events-directly/'>Should internal entities in an aggregate respond to domain events directly</a></li><li class="list-group-item"><a href='../java-when-to-call-the-constructor-and-when-to-call-the-method-in-java/'>Java &#8211; When to call the constructor and when to call the method in Java</a></li><li class="list-group-item"><a href='../what-are-the-problems-with-command-handlers-returning-data-in-cqrs/'>What are the problems with command handlers returning data in CQRS</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>