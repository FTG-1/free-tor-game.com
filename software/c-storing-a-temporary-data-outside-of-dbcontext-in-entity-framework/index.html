<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>C# &#8211; Storing a temporary data outside of DbContext in Entity Framework &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1078961 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1078961" class="post-1078961 software type-software status-publish hentry category-software tag-c tag-data-structures tag-design-patterns tag-entity-framework tag-net"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">C# &#8211; Storing a temporary data outside of DbContext in Entity Framework</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">c</span><span class="mr-2 badge badge-info">data structures</span><span class="mr-2 badge badge-warning">design-patterns</span><span class="mr-2 badge badge-primary">entity-framework</span><span class="mr-2 badge badge-danger">net</span></p><div class="entry-content"><p>I have a performance issue with a few methods in my Service Layer. Methods that are causing me troubles have some logic, but it&#39;s db connection that takes over 95% exec time. The problem is unfortunately hardware, the machine is just slow. But, let me explain the software problem first:</p><p>The scenario goes like this (simplified):<br /> Company sells cars, there&#39;s <code>Car</code> entity and <code>PurchaseOrder</code> entity. In the application, there is a <code>Car</code> view with all <code>PurchaseOrders</code>. There is a function to determine <code>PurchaseOrdersStatus</code>. It wouldn&#39;t be slow, but it must query the &#34;slow&#34; database a few times. Queries are very simple, like:</p><p><em>&#34;Check if <code>FooId</code> exists in <code>bar</code> table&#34;.</em></p><p>If the car has a few purchase orders &#8211; the query is veeery fast. But when the car has hundreds of orders &#8211; it&#39;s getting very slow. Cause this query must be performed many many times. I came up with the solution:</p><ol><li>Query all <code>FooId</code>s from <code>bar</code> table</li><li>Store this list of ids in the memory</li><li>In those hundreds of calls I&#39;m checking if the id exists in the memory, which makes it way faster.</li></ol><p>My question is, <strong>is there a pattern of &#34;prequering&#34; data from database, putting it into memory?</strong></p><p>In my data persistence classes, like <code>CarData</code> I literally have &#34;Initialization&#34; method and member lists with ids. But I&#39;m not sure if this is the right way to do it.</p><p><strong>EDIT:</strong></p><p>I&#39;m doing one big query in the fast database, it&#39;s really fast even for a lot of records. To get &#34;the status&#34; I need to do a few more queries, that are in tables totally not connected to each other, some of which are in very slow db (btw. The db architecture is really terrible, but it&#39;s a legacy db, so all I can do is complain). It&#39;s possible to do the cross-database one query (built of subqueries, like <code>... WHERE carId IN (select cardId from ...</code> &#8211; but it&#39;s really slow.</p><p><strong>EDIT2: My proposed solution</strong></p><p>In my project I have a few <code>FooData</code> classes, some of them have corresponding <code>FooCache</code> class. Cache looks similar to Data, it has DataContext, Collections (cached list of ids or whatever I need) and one method <code>Initialize</code>. I inject <code>FooCache</code> into <code>FooData</code> via IoC (so every time <code>FooData</code> is created), <strong>BUT</strong> I don&#39;t initialize it. Only in methods where I need caching I call <code>FooCache.Initialize();</code> at the beginning. <code>FooData</code> before going to the database, checks if FooCache is initialized. If it isn&#39;t, it goes to the db.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><blockquote><p>is there a pattern of &#34;prequering&#34; data from database, putting it into memory?</p></blockquote><p><strong>Yes</strong>, it&#39;s commonly called &#34;caching&#34; and it&#39;s used for this purpose.</p><blockquote><p>when the car has hundreds of orders ... this query must be performed many many times.</p></blockquote><p>You are running into possibly the most common performance problem encountered by programmers using an Object-Relational Mapper like Entity Framework, called <a href="https://stackoverflow.com/questions/97197/what-is-n1-select-query-issue">SELECT N+1</a>.  In short: this is when the number of queries your application executes grows linearly relative to the number of records in your database (or some subset of it).</p><p>The best way to avoid SELECT N+1 problems is to produce better SQL, either by directly writing a view or stored procedure in the database, or by changing how you&#39;re using the ORM so it generates better SQL.</p><p>In Entity Framework, navigation properties make it difficult to fully appreciate when the code is hitting the database.  My personal preference is to <strong>never use navigation properties in Entity Framework</strong>.  They introduce loads of issues and this is one of them.  I want my ORM to be a way to <em>think</em> in SQL while <em>writing</em> in C#, but navigation properties seem specifically designed to hide away all that &#34;scary&#34; SQL and keep you thinking in C#, which makes it very hard to contain problems like SELECT N+1.  Instead of using navigation properties, compose your <code>IQueryable</code> objects as needed in LINQ.</p><p>If you are committed to navigation properties, then your next best bet is to <strong>use <code>Include</code> to eagerly load related entities</strong> into properties you know you&#39;re about to traverse, as explained <a href="https://msdn.microsoft.com/en-us/library/jj574232(v=vs.113).aspx" rel="nofollow noreferrer">on MSDN</a>.</p><p>What you are proposing is <strong>in-memory caching</strong>, which may or may not be a great solution depending on your constraints.  The main issues to consider with caching are:</p><ol><li><p>Keeping the data fresh.  Make sure your cache is expiring more frequently than your data is changing, or you can end up using outdated data. If you&#39;re caching in preparation for one data processing cycle and then throwing the cache away, this is no problem.  If your data is unlikely to change during application runtime (e.g. unit conversion rules), you can get away with a long expiry.  If this is primary data that your users are continually editing, this is probably not the right solution.</p></li><li><p>Not querying more than you need.  It&#39;s generally very hard to restrict the query that populates the cache to only the data you need, without directly tying it into the primary query (and then why not solve the problem with LINQ?), especially if you&#39;re trying to re-use the cache.  If the amount of possible data you&#39;ll ever get at once is reasonably small compared to your memory, that is no problem, but <em>make sure you aren&#39;t just guessing about that</em>.</p></li></ol><p>As long as you&#39;ve considered the above points, using a cache is certainly better than tolerating SELECT N+1s.  As common as they are, I&#39;ve never seen a situation where a SELECT N+1 couldn&#39;t be refactored into some constant number of queries relative to the number of records in the database.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../c-writing-a-spell-checker-similar-to-did-you-mean/'>C# &#8211; Writing a spell checker similar to &#8220;did you mean&#8221;</a></li><li class="list-group-item"><a href='../entity-framework-in-n-tier-application-confusion/'>Entity Framework in n-tier application confusion</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>