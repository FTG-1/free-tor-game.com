<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Should I use the repository in the Domain Object or push the Domain Object back to the Service Layer &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1072964 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1072964" class="post-1072964 software type-software status-publish hentry category-software tag-domain-driven-design"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Should I use the repository in the Domain Object or push the Domain Object back to the Service Layer</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">domain-driven-design</span></p><div class="entry-content"><p>I have come from a transaction script world and I am just starting to take a look at DDD. I am unsure of the correct way to integrate a DDD design with database persistence. This is what I have:</p><p>A service class called OrganisationService whose interface contains methods for retrieving and saving away instances of Organisation domain objects. Organisation is an aggregate root and has other data related to it: Members and Licenses. EF6 database first DBContext is used within the OrganisationService to retrieve OrganisationDB entities and the related MemberDB and LicenseDB entities. These all get transformed into their domain object class equivalents when retrieved by the OrganisationService and loaded into the Organisation domain object. This object looks like so:</p><pre><code>public class Organisation
{
    public IList&lt;Member&gt; Members { get; set; }
    public IList&lt;License&gt; Licenses { get; set; }
}
</code></pre><p>I am not using the Repository pattern in the OrganisationService&#8230;I am using EF itself as the Repository as it seems that EF6 has largely made repository redundant now.</p><p>At this point in the design the Organisation domain object is anaemic: it looks like the EF POCO Organisation class. The OrganisationService class looks a lot like a Repository!</p><p>Now I need to start adding logic. This logic includes managing an Organisations Licenses and Members. Now in the transaction script days I would add methods into the OrganisationService for handling these operations and call into a Repository to interact with the DB, but with DDD I believe this logic should be encapsulated within the Organisation domain object itself&#8230;</p><p>This is where I am unsure of what I should be doing: I will need to persist this data back to the database as part of the logic. Does this mean I should use DbContext within the Organisation domain object to do this? Is using the repository/EF within the domain object bad practice? If so, where does this persistence belong?</p><pre><code>public class Organisation
{
    public IList&lt;Member&gt; Members { get; set; }
    public IList&lt;License&gt; Licenses { get; set; }

    public void AddLicensesToOrganisation(IList&lt;License&gt; licensesToAdd)
    {
        // Do validation/other stuff/

        // And now Save to the DB???
        using(var context = new EFContext())
        {
            context.Licenses.Add(...
        }

        // Add to the Licenses collection in Memory
        Licenses.AddRange(licensesToAdd);
    }
}
</code></pre><p>Should I instead just be mutating the Organisation domain object in memory and then pushing it back to the OrganisationService for persistence? Then I have to track what actually changed on the object (which is what EF does to its own POCOs! I am kind of coming to feel that EF isn&#39;t just a repository replacement, but also could be the domain layer!)</p><p>Any guidance here is appreciated.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>You can take either approach and have it work well - there are, of course, pros and cons.</p><p>Entity Framework is definitely <em>intended</em> to suffuse your domain entities. It does work well when your domain entities and data entities are the same classes. It&#39;s much nicer if you can rely on EF to keep track of the changes for you, and just call <code>context.SaveChanges()</code> when you&#39;re finished with your transactional work. It also means that your validation attributes don&#39;t have to be set twice, once on your domain models and once on your persisted entities - things like <code>[Required]</code> or <code>[StringLength(x)]</code> can be checked <em>in your business logic</em>, allowing you to catch invalid data states before you try to do a DB transaction and get an <code>EntityValidationException</code>. Finally, it&#39;s quick to code - you don&#39;t need to write a mapping layer or repository, but can instead work directly with the EF context. It&#39;s already a repository and a unit of work, so extra layers of abstraction don&#39;t accomplish anything.</p><p>A downside to combining your domain and persisted entities is that you end up with a bunch of <code>[NotMapped]</code> attributes scattered throughout your properties. Often, you will want domain-specific properties which are either get-only filters on persisted data, or are set later in your business logic and not persisted back into your database. Some times, you&#39;ll want to express your data in your domain models in a way that doesn&#39;t work very well with a database - for example, when using enums, Entity will map these to an <code>int</code> column - but perhaps you want to map them to a human-readable <code>string</code>, so you don&#39;t need to consult a lookup when examining the database. Then you end up with a <code>string</code> property which is mapped, an <code>enum</code> property which isn&#39;t (but gets the string and maps to the enum), and an API which exposes both! Similarly, if you want to combine complex types (tables) across contexts, you may wind up with a <code>mapped</code> OtherTableId and an unmapped <code>ComplexType</code> property, both of which are exposed as public on your class. This can be confusing for someone who isn&#39;t familiar with the project, and unnecessarily bloats your domain models.</p><p>The more complex my business logic/domain, the more restrictive or cumbersome I find combining my domain and persisted entities to be. For projects with short deadlines, or that don&#39;t express a complex business layer, I feel that using EF entities for both purposes is appropriate, and there&#39;s no need to abstract your domain away from your persistence. For projects which need maximum ease-of-extension, or that need to express very complicated logic, I think you&#39;re better off separating the two and dealing with the extra persistence complexity.</p><p>One trick to avoiding the trouble of manually tracking your entity changes is to store the corresponding persisted entity ID in your domain model. This can be filled automatically by your mapping layer. Then, when you need to persist a change back to EF, retrieve the relevant persistent entity <em>before</em> doing any mapping. Then when  you map the changes, EF will detect them automatically, and you can call <code>context.SaveChanges()</code> without having to track them by hand.</p><pre><code>public class OrganisationService
{
    public void PersistLicenses(IList&lt;DomainLicenses&gt; licenses) 
    {
        using (var context = new EFContext()) 
        {
            foreach (DomainLicense license in licenses) 
            {
                var persistedLicense = context.Licenses.Find(pl =&gt; pl.Id == license.PersistedId);
                MappingService.Map(persistedLicense, license); //Right-left mapping
                context.Update(persistedLicense);
            }
            context.SaveChanges();
        }
    }
}
</code></pre></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../should-a-domain-object-wrap-contain-a-dto-interface/'>Should a domain object wrap/contain a DTO interface</a></li><li class="list-group-item"><a href='../is-ddd-not-appropriate-for-the-website-or-should-i-introduce-a-query-layer/'>Is DDD not appropriate for the website or should I introduce a Query Layer</a></li><li class="list-group-item"><a href='../a-filtering-logic-should-be-in-a-repository-or-in-a-service/'>A filtering logic should be in a repository or in a service</a></li><li class="list-group-item"><a href='../c-return-domain-objects-from-the-repository/'>C# &#8211; Return domain objects from the repository</a></li><li class="list-group-item"><a href='../how-domain-repository-and-service-layers-works-vs-original-dao-pattern/'>How Domain, repository and service layers works VS original DAO pattern</a></li><li class="list-group-item"><a href='../ddd-delegate-business-rule-of-domain-object-to-external-service/'>DDD &#8211; delegate business rule of domain object to external service</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>