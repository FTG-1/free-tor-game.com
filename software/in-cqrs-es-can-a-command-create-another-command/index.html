<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>In CQRS/ES, can a command create another command &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1066798 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1066798" class="post-1066798 software type-software status-publish hentry category-software tag-command-message tag-cqrs tag-domain-driven-design tag-event-sourcing"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">In CQRS/ES, can a command create another command</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">command-message</span><span class="mr-2 badge badge-info">cqrs</span><span class="mr-2 badge badge-warning">domain-driven-design</span><span class="mr-2 badge badge-primary">event-sourcing</span></p><div class="entry-content"><p>In CQRS/ES, a command is sent from the client to the server and routed to the appropriate command handler. That command handler loads an aggregate from its repository, and calls some method on it, and saves it back to the repository. Events are generated. An event handler/saga/process manager can listen to these events in order to issue commands.</p><p>So, commands (input) produce events (output), which can then feed back into the system more commands (input). Now, is it common practice for a command to not emit any events, but rather to enqueue another command? Such an approach could be used to force execution in an external process.</p><p>EDIT:</p><p>The specific use case that I have in mind is the processing of payment details. The client submits a <code>PayInvoice</code> command, whose payload includes the user&#39;s credit card details. The <code>PayInvoiceHandler</code> passes a <code>MakeInvoicePayment</code> command to a separate process, which is responsible for interacting with the payment gateway. If the payment is successful, an <code>InvoicePaid</code> event is generated. If for some reason the system crashes after the <code>PayInvoice</code> command is persisted but before the <code>MakeInvoicePayment</code> command is persisted, we can track this manually (no payment will have gone through). If the system crashes after the <code>MakeInvoicePayment</code> command is persisted but before the <code>InvoicePaid</code> event is persisted, we may have a situation where the user&#39;s credit card is charged but the invoice is not flagged as having been paid. In that case, the situation would have to be manually investigated and the invoice manually marked as paid.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>In retrospect, I think I was complicating the issue.</p><p>In general, commands should either throw an exception or raise one or more events.</p><p>If I could summarise the architecture of Event Sourcing it would be as follows:</p><ul><li>Commands are inputs representing instructions to do something.</li><li>Events are outputs representing historical facts of what was done.</li><li>Event handlers can listen events in order to issue commands, helping coordinate the different parts of the system.</li></ul><p>Having one command create another command causes ambiguity in the general meaning of commands and events: if one command &#34;triggers&#34; another command, it is implying that a command is &#34;an historical fact of what was done&#34;. This contradicts the intent of these two types of messages, and could become a slippery path, in that other developers could trigger events from events, which could lead to corrupt data and eventual <em>inconsistency</em>.</p><p>In regards to the specific scenario I posed, the complicating factor was that I didn&#39;t want the main thread to interact with the payment gateway, as (being a persistent, single-threaded process), this would not allow other commands to be processed. The simple solution here is to spawn another thread/process to handle the payment.</p><p>To illustrate, the client sends a <code>PayInvoice</code> command. The <code>PayInvoiceHandler</code> starts a new process and passes it the payment details. The new process communicates with the payment gateway. If the payment was successful, it calls <code>invoice.markAsPaid()</code> with the receipt number (which produces the <code>InvoicePaid</code> event). If the payment was unsuccessful, it calls <code>invoice.paymentFailed()</code> with passes a reference code for further investigation (which produces the <code>InvoicePaymentFailed</code> event). So despite the fact that a separate process/thread is involved, the pattern remains <code>Command -&gt; Event</code>.</p><p>In regards to failure, there are three scenarios, the system could crash after the <code>PayInvoice</code> command is persisted but before the <code>InvoicePaid</code> or <code>InvoicePaymentFailed</code> events are persisted. In this case, we don&#39;t know if the user&#39;s credit card was charged. In such a case, the user will notice the charge on their credit card and make a complaint, in which case a member of staff can investigate the issue and manually mark the invoice as paid.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../cqrs-event-sourcing-is-it-correct-that-commands-are-generally-communicated-point-to-point-while-domain-events-are-communicated-through-pub-sub/'>CQRS + Event Sourcing: (is it correct that) Commands are generally communicated point-to-point, while Domain Events are communicated through pub/sub</a></li><li class="list-group-item"><a href='../how-to-implement-a-process-manager-in-event-sourcing/'>How to implement a process manager in event sourcing</a></li><li class="list-group-item"><a href='../design-command-handling-fail-feedback-with-cqrs/'>Design &#8211; Command handling fail feedback with CQRS</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>