<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Prevent duplicate event handling &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1074268 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1074268" class="post-1074268 software type-software status-publish hentry category-software tag-design-patterns tag-error-handling tag-event-sourcing"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Prevent duplicate event handling</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">design-patterns</span><span class="mr-2 badge badge-info">error handling</span><span class="mr-2 badge badge-warning">event-sourcing</span></p><div class="entry-content"><p>What is the best way of preventing of events from being handled more than once?</p><p>Imagine a system where customers can place orders and when successful an <code>OrderCreated</code> event is raised. There are some separate processes which listen to events on a message bus.</p><p>One process is to send an email to the customer, assume there is a requirement that the customer MUST be sent an email.</p><p>I imagine the email sending process would work in the following way:</p><ol><li>Send email</li><li>Persist handled id</li><li>Acknowledge the message bus</li></ol><p>But if persisting the handled id fails the customer would get multiple emails.</p><p>The only other solution I thought of was to do the following:</p><ol><li>Persist attempt to handle event id</li><li>Send email</li><li>Persist handled event id</li><li>Acknowledge the message bus</li></ol><p>This would allow me to check whether the event was attempted to be handled before, and if so raise some error and ask a human whether to try and resend.</p><p>Are there any better ways to handle problems like these? I feel like this sort of thing would be a common problem but I can&#39;t find a robust solution.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><blockquote><p>What is the best way of preventing of events from being handled more than once?</p></blockquote><p>The best way: write your domain model such that <em>at most once</em> handling is built into the business logic.</p><p>Marc de Graauw, from <a href="https://www.infoq.com/articles/no-reliable-messaging" rel="nofollow noreferrer">Nobody Needs Reliable Messaging</a>:</p><blockquote><p>Stating that it is important on the business level that every message is received exactly once, like it is in order processing, means that every message constitutes a unique business transaction....  if every message is a unique business transaction, clearly there must be a unique id on the business level.... if we need such a unique token on the business level, the business level should assert it&#39;s uniqueness. Uniqueness on the business level should not be dependent on the transient uniqueness on the message level, but must be a persistent feature of the business message, and business semantics must guarantee it.</p></blockquote><p>But that&#39;s not the sort of example you are considering;</p><blockquote><p>One process is to send an email to the customer, assume there is a requirement that the customer MUST be sent an email.</p></blockquote><p>In a situation where MUST; I&#39;d normally look for at-least-once handling of the event.  The process keeps track of both which emails are required, and which have been acknowledged.</p><p>For example, the process subscribing to <code>OrderCreated</code>, <code>EmailSent</code>, and <code>EmailTimedOut</code>.  On &#34;order created&#34;, we dispatch a command to send the email, and another to publish the timeout event.  Upon receiving the timeout, we check to see if the EmailSent message has appeared -- if not, we <em>resend</em>.</p><blockquote><p>Are there any better ways to handle problems like these?</p></blockquote><p>Review in detail the cost to the business of the different failure modes.  If you MUST send the email, then you need the ack to know you have done so.  If the ack can get lost, then you need to resend -- what&#39;s the cost to the business of sending that email more than once?  Don&#39;t sign up for expensive perfection when failure is rare and low cost.</p><blockquote><p>I feel like this sort of thing would be a common problem but I can&#39;t find a robust solution.</p></blockquote><p>Jonathan Oliver: <a href="http://blog.jonathanoliver.com/messaging-at-least-once-delivery/" rel="nofollow noreferrer">Messaging: At Least Once Delivery</a></p><blockquote><p>One of the primary reasons, if not the primary reason, that messaging systems offer at-least-once delivery rather than exactly-once delivery is that we run into limitations as expressed in the CAP theorem—all “nodes” cannot possibly have a globally consistent snapshot and be available and partition tolerant.  There is no unfailing “global brain”.</p></blockquote><p>See also: <a href="https://stackoverflow.com/q/416551/54734">https://stackoverflow.com/q/416551/54734</a></p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../ddd-saga-event-sourcing-can-a-compensate-action-simply-be-a-delete-on-the-event-store/'>DDD, Saga &#038; Event-sourcing: Can a Compensate Action simply be a delete on the event store</a></li><li class="list-group-item"><a href='../how-to-implement-a-process-manager-in-event-sourcing/'>How to implement a process manager in event sourcing</a></li><li class="list-group-item"><a href='../cqrs-event-sourcing-how-to-process-events-in-the-expected-order-inside-the-read-model/'>CQRS-Event Sourcing: how to process events in the expected order inside the read model</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>