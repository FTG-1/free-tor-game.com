<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="https://free-tor-game.com/wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Java &#8211; Threaded batching algorithm &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.min.js?ver=11.2.0' id='highlight-js'></script>     <script>( function( w, d, s, l, i ) {
				w[l] = w[l] || [];
				w[l].push( {'gtm.start': new Date().getTime(), event: 'gtm.js'} );
				var f = d.getElementsByTagName( s )[0],
					j = d.createElement( s ), dl = l != 'dataLayer' ? '&l=' + l : '';
				j.async = true;
				j.src = 'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
				f.parentNode.insertBefore( j, f );
			} )( window, document, 'script', 'dataLayer', ' ' );</script>      <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1082246 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="https://free-tor-game.com/3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="https://free-tor-game.com/contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1082246" class="post-1082246 software type-software status-publish hentry category-software tag-java tag-multithreading"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Java &#8211; Threaded batching algorithm</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">java</span><span class="mr-2 badge badge-info">multithreading</span></p><div class="entry-content"><p>Ok, I&#39;m working on DynamoDb-based caching. We have an API where each call costs us real money and the information retrieved is &#34;fresh&#34; for 2-3 weeks, so it makes sense to cache it.<br /> There&#39;s no problem with calling <code>dynamoDbClient.get(apiUrl)</code> and retrieving the stored JSON response. They have batches &#8211; 25 batch items for PUT and 100 batch items for GET. So it means if we need get JSON response for 100 items we do one call instead of 100.</p><p>The question I have is how to organize this in the best way for threading.</p><p>Here&#39;s general idea and I&#39;m open to suggestions.</p><p>Assuming we have a batch call with 100 items, we can use a <code>BlockingQueue&lt;String&gt;</code> to store the keys which we can use later.  We would use <code>blockingQueue.put()</code> method, to make other threads wait if 150 threads arrived into method having a batch of only 100 available.</p><p>So thread that enters method, gets his place in batch queue, needs some &#34;locking&#34; mechanism to wait until response arrives and &#34;wake him up&#34; that his response is available.</p><pre><code>pseudoCodeMethod(String resourceUrl) {
  blockingQueue.put(resourceUrl); // sleep if no place
  LockableResponse lockableResponse = getLockableResponse();
  lockableResponse.setKey(resourceUrl);
  lockableResponse.getSemaphore().acquire();

  String jsonApiResponse = lockableResponse.getJsonApiResponse();
  lockableResponse.clean();

  return jsonApiResponse;
}

LockableResponse{
  String resourceUrl;
  String jsonApiResponse;
  Semaphore semaphore = new Semaphore(0);

  public void clean(){
     resourceUrl = null;
     jsonApiResponse = null;         
  } 
}
</code></pre><p>My though is that we would associate a resourceUrl for each dynamodb response with a data structure that has semaphore to await for api response which arrives for ~100 items in one batch call.</p><p>A separate thread performs the call and then iterates through response, assigns <code>jsonApiResponse</code> to proper <code>resourceUrl</code> [<code>concurrentMap</code> for that?? ] and then calls <code>lockableResponse.release()</code> to wake up thread, so thread takes <code>resourceUrl</code> and exists the method.</p><p>The <code>clean()</code> method could be added to allow reuse of the same structure. I&#39;m thinking about array of lockable resource according to batch capacity. So they could be cleared and reused for other batch GET call.</p><p>Thoughts? Suggestions?</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>Here is a reactive approach to your problem. RxJava allows you to manage resources, especially threads, in a style similar to that used in Java streams.</p><p>The request queue for GETs is a <code>SerializedSubject</code> which is where requests are sent. <code>SerializedSubject</code> is thread safe, and allows requests to be made from any thread.</p><pre><code>SerializedSubject&lt;Pair&lt;Observable&lt;JsonResponse&gt;, String&gt; requestGetQueue =
  PublishSubject.&lt;Pair&lt;Observable&lt;JsonResponse&gt;, String&gt;create().toSerial();
</code></pre><p>Once the subject is declared, set up processing of the queued requests. The <code>observeOn()</code> operator tells the observer chain to perform processing on a particular scheduler, which then selects a thread from its pool to perform all the operations on. RxJava takes of the thread-hopping to go from the calling thread to the thread that handles the requests.</p><pre><code>requestGetQueue
  .observeOn( Schedulers.io() )
  .buffer( 100 )  // batch size
  .subscribe( requestList -&gt; processRequestList( requestList ),
    error -&gt; log.error( error ) );
</code></pre><p>The <code>buffer()</code> operator batches up a set of requests into a list. The batch size is 100, per the original posting. The <code>buffer()</code> operator can take an additional parameter to set a timeout, so that eventually a lone group of requests will be handled and nothing gets stuck. That&#39;s a business decision whether you want to handle less than 100 requests at any time.</p><pre><code>Observable&lt;JsonResponse&gt; getApiValue( String url ) {
  BehaviorSubject&lt;JsonResponse&gt; responseFromApi = BehaviorSubject.create();
  requestQueue.onNext( new Pair&lt;&gt;(responseFromApi, url) );
  return responseFromApi;
}
</code></pre><p>The API request for clients is very simple. What the caller gets back is the equivalent of a future. The client makes the request and establishes a call-back using the <code>subscribe()</code> step to handle the <code>JsonResponse</code> that will eventually come through. An error handler is also required, since ... well, errors happen. The <code>observeOn()</code> operator is used to move the response handling back on to another thread. More on that in a bit.</p><pre><code>getApiValue( apiUrlString )
  .observeOn( clientScheduler )
  .subscribe( jsonResponse -&gt; { ... },
    error -&gt; { ... } );
</code></pre><p>Handling the request is simply batching up the list of URLs, waiting for the list of responses to come back and pairing up the responses to the requests. The code below assumes all responses come back in order. The response is emitted to the client by using <code>onNext()</code> followed by <code>onCompleted()</code>.</p><pre><code>void processRequestList( List&lt;Pair&lt;Observable&lt;JsonResponse&gt;,String&gt;&gt; requestList ) {
  List&lt;String&gt; uriList = new ArrayList&lt;&gt;();
  for ( int s = 0; s &lt; requestList.size(); s++ ) {
    uriList.add( requestList.getSecond() );
  }
  List&lt;JsonResponse&gt; results = sendBatchRequest( uriList );
  for ( int i = 0; i &lt; requestList.size(); i++ ) {
    requestList.get(i).getFirst().onNext( results.get(i) );
    requestList.get(i).getFirst().onCompleted();
  }
}
</code></pre><p>I mentioned earlier that the client needs to use a scheduler to move processing back to its own thread. How you do this depends on how client threads are set up. You can create the client scheduler from an executor service:</p><pre><code>clientScheduler = Schedulers.from( executorService );
</code></pre><p>and using <code>observeOn( clientScheduler )</code> will cause subsequent operations to move on to the client thread.</p><p><strong>Summary</strong></p><p>RxJava, and similar reactive platforms, manage almost all of the details of threads, locks, semaphores, mutexes, blocking queues, timers, responses, etc, for you. You still have to understand what things are needed for thread safety, and when processing is performed on particular threads, but almost of the finicky, tricky stuff is kept behind the scenes.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='https://free-tor-game.com/software/sleeping-barber-problem-with-multiple-barbers/'>Sleeping Barber Problem (with multiple barbers)</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/java-how-to-make-a-universal-construction-more-efficient/'>Java &#8211; How to make a universal construction more efficient</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/c-would-this-be-a-proper-use-of-threading/'>C# &#8211; Would this be a proper use of threading</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/java-recommended-value-to-pass-instead-of-string-parameter-for-a-method-in-java/'>Java &#8211; Recommended value to pass instead of String parameter for a method in java</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='http://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="https://free-tor-game.com/wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>