<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Repository Pattern and custom queries/REST API. Is it the right approach &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1087472 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1087472" class="post-1087472 software type-software status-publish hentry category-software tag-design-patterns tag-domain-driven-design tag-repository"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Repository Pattern and custom queries/REST API. Is it the right approach</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">design-patterns</span><span class="mr-2 badge badge-info">domain-driven-design</span><span class="mr-2 badge badge-warning">repository</span></p><div class="entry-content"><p>I&#39;m in the early stages of working on an application that is using the Repository Pattern to provide a data access abstraction. This application will have some form of a simple REST API but I&#39;m not sure how to approach this using repositories. To illustrate this, a typical (very simplified) example of a repository is something like this:</p><pre class="lang-php prettyprint-override"><code>&lt;?php
$repo = new PostRepository(); // this would be resolved from an IoC container
$post = $repo-&gt;getByEmail(&#39;foo@wherever.com&#39;);
</code></pre><p>or maybe a little less rigid, like this:</p><pre class="lang-php prettyprint-override"><code>$post = $repo-&gt;getBy(&#39;first_name&#39;, &#39;Bob&#39;);
</code></pre><p>But the pattern doesn&#39;t seem suited to anything more complicated like, say, the query from this url:</p><pre class="lang-php prettyprint-override"><code>api.example.com/posts?firstName=Bob&amp;lastName=Doe&amp;email=foo@example.com&amp;with=comments
</code></pre><p>It seems like to handle stuff like that (let alone any much more complicated queries that many APIs support) you would pretty much end up having to reimplement the underlying ORM, or create a very leaky abstraction, neither of which seems ideal. Am I going about this wrong?</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>A way to find instances by variable criteria, <a href="https://en.wikipedia.org/wiki/Disjunctive_normal_form" rel="nofollow">as suggested by scriptin&#39;s anwer</a> is the right way. However, you don&#39;t necessarily need the full weight of the frameworks mentioned.</p><p>I have recently programmed exactly what you described. The repository needs meta-information about the fields ob the object you are requesting - a config class is a good option, and a way to check whether a request is valid for an object (a way to validate criteria - based on the meta-information).</p><p>In my implementation, I unified the repository pattern with the identity-map pattern. The repository holds a collection of entities, initially empty. An incoming <code>selectByCriteria</code>-request will first check the collection, and, if no entity is found, will have the criteria passed to a method for transformation into a db-query and executed. Returned rows are stored as entities in the repository-collection and then returned to the caller of the method as their own &#39;sub-collection&#39;. Potential future requests to those resources in the lifetime of the application will then be fulfilled from the collection held in memory.</p><p>You need a way to normalize selection-criteria. The kind of requests a REST API has to fulfill can usually easily be normalized to <a href="https://en.wikipedia.org/wiki/Disjunctive_normal_form" rel="nofollow">Disjunctive Normal Form (DNF)</a> or <a href="https://en.wikipedia.org/wiki/Conjunctive_normal_form" rel="nofollow">Conjunctive Normal Form (CNF)</a>. For simplicity of code and logic, I chose DNF for my implementation - lightweight, as a simple depth-3 array.</p><p>A set of selection criteria would then look like this:</p><pre><code>array(                                               
    array(                                           
        array(&#39;fieldName&#39;,&#39;comparator&#39;,&#39;fieldValue&#39;),
        **AND**                                      
        array(&#39;fieldName&#39;,&#39;comparator&#39;,&#39;fieldValue&#39;) 
        ...                                          
    ),                                               
    **OR**                                           
    array(                                           
        array(&#39;fieldName&#39;,&#39;comparator&#39;,&#39;fieldValue&#39;),
        **AND**                                      
        array(&#39;fieldName&#39;,&#39;comparator&#39;,&#39;fieldValue&#39;) 
        ...                                          
    )                                                
    ...                                              
)                                                    
</code></pre><p>(The comparators don&#39;t have to be strings, they can be class-constants - the values don&#39;t have to be strings either - indeed it&#39;s more transparent to use the types they are being compared to - especially if we need to construct a DB-Query later on)</p><p>A service-object first validates a set of criteria against a config-object for a data-class, by checking the structure of the array, if field-names exist, if the comparators are allowed and if the field-types can be meaningfully compared with the given values and comparators. If the criteria-array is valid, it is checked with foreach-loops against the collection. The advantage of DNF here is that a loop can terminate checking each disjunct once the first conjunct in it is found to be invalid, and it can terminate the entire outer loop (over the disjuncts) once the first disjunct is found to be valid - simplifying the code.</p><p>Selecting from a collection is implemented like this:</p><pre><code>    $resultCollection  = $this-&gt;getEmptyCollection;

    if(!$this-&gt;criteriaValidationService-&gt;validateCriteria($dataObjectConfig,$criteria)) {
        return $resultCollection;
    }

    foreach ($this-&gt;elements as $instance) {                                                           
        foreach ($criteria as $disjunctCriteria) {                                                     
            $isValidDisjunct = TRUE;                                                                   
            foreach ($disjunctCriteria as $conjunctCriterion) {                                        
                $fieldName    = $conjunctCriterion[0];                                                 
                $comparator   = $conjunctCriterion[1];                                                 
                if(isset($conjunctCriterion[2])) {                                                          
                    $compareValue = $conjunctCriterion[2];                                             
                }                                                                                      

                if ($comparator == &#39;IS NULL&#39;) {                                                        
                    if(!(is_null($instance-&gt;$fieldName))) {                                            
                        $isValidDisjunct = FALSE;                                                      
                        break;                                                                         
                    }                                                                                  
                } elseif ($comparator == &#39;IS NOT NULL&#39;) {                                              
                    if(is_null($instance-&gt;$fieldName)) {                                               
                        $isValidDisjunct = FALSE;                                                      
                        break;                                                                         
                    }                                                                                  
                } elseif ($comparator == &#39;=&#39;) {                                                        
                    if (!(isset($instance-&gt;$fieldName) &amp;&amp; $instance-&gt;$fieldName == $compareValue)) {   
                        $isValidDisjunct = FALSE;                                                      
                        break;                                                                         
                    }                                                                                  
                } elseif ($comparator == &#39;!=&#39;) {                                                       
                    if (!($instance-&gt;$fieldName != $compareValue)) {                                   
                        $isValidDisjunct = FALSE;                                                      
                        break;                                                                         
                    }                                                                                  
                } elseif ($comparator == &#39;&gt;&#39;) {                                                        
                    if (!(isset($instance-&gt;$fieldName) &amp;&amp; ($instance-&gt;$fieldName &gt; $compareValue))) {  
                        $isValidDisjunct = FALSE;                                                      
                        break;                                                                         
                    }                                                                                  
                } elseif ($comparator == &#39;&lt;&#39;) {                                                        
                    if (!(isset($instance-&gt;$fieldName) &amp;&amp; ($instance-&gt;$fieldName &lt; $compareValue))) {  
                        $isValidDisjunct = FALSE;                                                      
                        break;                                                                         
                    }                                                                                  
                } elseif ($comparator == &#39;&lt;=&#39;) {                                                       
                    if (!(isset($instance-&gt;$fieldName) &amp;&amp; !($instance-&gt;$fieldName &lt;= $compareValue))) {
                        $isValidDisjunct = FALSE;                                                      
                        break;                                                                         
                    }                                                                                  
                } elseif ($comparator == &#39;&gt;=&#39;) {                                                       
                    if (!(isset($instance-&gt;$fieldName) || ($instance-&gt;$fieldName &gt;= $compareValue))) { 
                        $isValidDisjunct = FALSE;                                                      
                        break;                                                                         
                    }                                                                                  
                } elseif ($comparator == &#39;IN&#39;) {                                                       
                    if (!(in_array($instance-&gt;$fieldName, $compareValue))) {                           
                        $isValidDisjunct = FALSE;                                                      
                        break;                                                                         
                    }                                                                                  
                } elseif ($comparator == &#39;LIKE&#39;) {                                                     
                    //Replace SQL-Wildcard with fnmatch-wildcard                                     
                    $compareValue = preg_replace(&#39;/(?&lt;!\\\\)%/&#39;, &#39;*&#39;, $compareValue);                              
                    if (!(fnmatch($compareValue, $instance-&gt;$fieldName))) {                            
                        $isValidDisjunct = FALSE;                                                      
                        break;                                                                         
                    }                                                                                  
                }                                                                                      
            }                                                                                          
            if ($isValidDisjunct) {                                                                    
                $resultCollection-&gt;add($instance, TRUE);
                break;                                               
            }                                                                                          
        }                                                                                              
    }                                                                                                  
    return $resultCollection;                                                                          
</code></pre></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../c-are-we-using-the-repository-pattern-right/'>C# &#8211; Are we using the repository pattern right</a></li><li class="list-group-item"><a href='../the-difference-between-repository-pattern-and-facades-pattern/'>The difference between Repository Pattern and Facades Pattern</a></li><li class="list-group-item"><a href='../object-oriented-repository-pattern-implementation-that-knows-nothing-about-the-database-table-and-column-names/'>Object-oriented &#8211; Repository pattern implementation that knows nothing about the database table and column names</a></li><li class="list-group-item"><a href='../c-ioc-as-service-locator/'>C# &#8211; IoC as service locator</a></li><li class="list-group-item"><a href='../design-how-to-describe-the-repository-pattern/'>Design &#8211; How to describe the Repository pattern</a></li><li class="list-group-item"><a href='../c-repository-pattern-and-database-queries/'>C# &#8211; Repository Pattern and database queries</a></li><li class="list-group-item"><a href='../c-generic-repository-pattern-ef-and-unit-of-work/'>C# &#8211; Generic repository pattern +EF and unit of work</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>