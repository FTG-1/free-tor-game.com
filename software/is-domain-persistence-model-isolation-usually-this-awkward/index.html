<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Is domain/persistence model isolation usually this awkward &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1076252 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1076252" class="post-1076252 software type-software status-publish hentry category-software tag-domain-driven-design tag-domain-model tag-persistence"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Is domain/persistence model isolation usually this awkward</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">domain-driven-design</span><span class="mr-2 badge badge-info">domain-model</span><span class="mr-2 badge badge-warning">persistence</span></p><div class="entry-content"><p>I&#39;m diving into the concepts to Domain-Driven Design (DDD) and found some principles strange, especially regarding the isolation of domain and persistence model. Here is my basic understanding:</p><ol><li>A service on the application layer (providing a feature set) requests domain objects from a repository it needs to carry out its function.</li><li>The concrete implementation of this repository fetches data from the storage it was implemented for</li><li>The service tells the domain object, which encapsulates business logic, to perform certain tasks which modifies its state.</li><li>The service tells the repository to persist the modified domain object.</li><li>The repository needs to map the domain object back to the corresponding representation in storage.</li></ol><p><a href="../../../i.stack.imgur.com/Cj4aD.png" rel="noreferrer"><img src="../../../i.stack.imgur.com/Cj4aD.png" alt="Flow Illustration"/></a></p><p>Now, given the above assumptions, the following seems awkward:</p><p><strong>Ad 2.:</strong></p><p>The domain model seems to load the entire domain object (including all fields and references), even if they are not needed for the function that requested it. Loading entirely might not even be possible if other domain objects are referenced, unless you load those domain objects as well and all the objects they reference in turn, and so on and so forth. Lazy loading comes to mind, which however means that you start querying your domain objects which should be the responsibility of the repository in the first place.</p><p>Given this problem, the &#34;correct&#34; way of loading domain objects seems to be having a dedicated loading function for each use case. These dedicated functions would then only load the data required by the use case they were designed for. Here&#39;s where the awkwardness comes into play: First, I would have to maintain a considerable amount of loading functions for each implementation of the repository, and domain objects would end up in incomplete states carrying <code>null</code> in their fields. The latter should <em>technically</em> not be a problem because if a value was not loaded, it should not be required by the functionality that requested it anyway. Still it&#39;s awkward and a potential hazard.</p><p><strong>Ad 3.:</strong></p><p>How would a domain object verify uniqueness constrains upon construction if it does not have any notion of the repository? For instance, if I wanted to create a new <code>User</code> with a unique social security number (which is given), the earliest conflict would occur upon asking the repository to save the object, only if there is a uniqueness constraint defined on the database. Otherwise, I could look for a <code>User</code> with the given social security and report an error in case it exists, before creating a new one. <strike>But then the constraint checks would live in the service and not in the domain object where they belong.</strike> I just realised that the domain objects are very well allowed to use (injected) repositories for validation.</p><p><strong>Ad 5.:</strong></p><p>I perceive the mapping of domain objects to a storage backend as a work-intensive process in comparison to having the domain objects modify the underlaying data directly. It is, of course, an essential prerequisite to decouple the concrete storage implementation from the domain code. However, does it indeed come at such a high cost?</p><p>You apparently have the option to use ORM tools to do the mapping for you. These would often require you to design the domain model according to the ORM&#39;s restrictions, however, or even introduce a dependency from the domain to infrastructure layer (by using ORM annotations in the domain objects, for instance). Also I&#39;ve read that ORMs introduce a considerable computational overhead.</p><p>In the case of NoSQL databases, for which hardly any ORM-like concepts exist, how do you keep track of which properties changed in the domain models upon <code>save()</code>?</p><p><em>Edit</em>: Also, in order for a repository to access the domain object&#39;s state (i.e. the value of each field), the domain object needs to reveal its internal state which breaks encapsulation.</p><p><strong>In general:</strong></p><ul><li>Where would transactional logic go? This is certainly persistence<br /> specific. Some storage infrastructure might not even support<br /> transactions at all (like in-memory mock repositories).</li><li>For bulk operations that modify multiple objects, would I have to load, modify and store each object individually in order to go through the object&#39;s encapsulated validation logic? That is opposed to executing a single query directly onto the database.</li></ul><p>I would appreciate some clarification on this topic. Are my assumptions correct? If not, what is the correct way of tackling these problems?</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>Your basic understanding is correct and the architecture you sketch out is good and works well.</p><p>Reading between the lines it seems like you are coming from a more database-centric active record style of programming? To get to a working implementation I would say you need to</p><p><strong>1:</strong> Domain objects don&#39;t have to include the whole object graph. For example I could have:</p><pre><code>public class Customer
{
    public string AddressId {get;set;}
    public string Name {get;set;}
}

public class Address
{
    public string Id {get;set;}
    public string HouseNumber {get;set;
}
</code></pre><p>Address and Customer need only be part of the same aggregate if you have some logic such as, &#34;the customer name can only start with the same letter as the housename&#34;. You are right to avoid lazy loading and &#39;Lite&#39; versions of objects.</p><p><strong>2:</strong> Uniqueness constraints generally are the purview of the repository not the domain object. Don&#39;t inject repositories into Domain Objects, that&#39;s a move back to active record, simply error when the service attempts to save.</p><p>The business rule isn&#39;t &#34;No two instances of User with the same SocialSecurityNumber can exist at the same time ever&#34;</p><p>It&#39;s that they cant exist on the same repository.</p><p><strong>3:</strong> It&#39;s not hard to write repositories rather than individual property update methods. In fact, you&#39;ll find that you have pretty much the same code either way. Its just which class you put it in.</p><p>ORMs these days are easy and have no extra constraints on your code. Having said that, personally I prefer to simply hand crank the SQL. It&#39;s not that hard, you never run into any issues with ORM features and you can optimise where required.</p><p>There really is no need to keep track of which properties changed when you saved. Keep your Domain Objects small and simply overwrite the old version.</p><p><strong>General Questions</strong></p><ol><li><p>Transaction logic goes in the repository. But you shouldn&#39;t have much if any of it. Sure you need some if you have child tables in which you are putting the child objects of the aggregate, but that will be entirely encapsulated within the SaveMyObject repository method.</p></li><li><p>Bulk updates. Yes you should individually alter each object then just add a SaveMyObjects(List objects) method to your repository, to do the bulk update.</p><p>You want the Domain Object or Domain Service to contain the logic. <em>Not</em> the database. That means you can&#39;t just do &#34;update customer set name=x where y&#34;, because for all you know the Customer object, or CustomerUpdateService does 20 odd other things when you change the name.</p></li></ol></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../are-persistence-ignorant-objects-able-to-implement-lazy-loading/'>Are Persistence-Ignorant objects able to implement lazy loading</a></li><li class="list-group-item"><a href='../domain-model-and-querying/'>Domain Model and Querying</a></li><li class="list-group-item"><a href='../do-we-achieve-100-persistence-ignorance-solution-if-were-not-using-orms-poco-objects-to-model-the-domain/'>Do we achieve 100% Persistence Ignorance solution if we&#8217;re not using ORM&#8217;s POCO objects to model the Domain</a></li><li class="list-group-item"><a href='../architecture-validation-and-data-persistence-in-a-domain-model/'>Architecture &#8211; Validation and data persistence in a domain model</a></li><li class="list-group-item"><a href='../n-elegant-way-to-check-unique-contraints-on-domain-object-attributes-without-moving-business-logic-into-service-layer/'>N elegant way to check unique contraints on domain object attributes without moving business logic into service layer</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>