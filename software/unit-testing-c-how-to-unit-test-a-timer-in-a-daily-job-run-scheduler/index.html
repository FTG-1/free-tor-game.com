<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Unit-testing &#8211; C# | How to Unit test a Timer (in a daily job run scheduler) &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1084933 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1084933" class="post-1084933 software type-software status-publish hentry category-software tag-clean-code tag-unit-testing"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Unit-testing &#8211; C# | How to Unit test a Timer (in a daily job run scheduler)</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">clean code</span><span class="mr-2 badge badge-info">unit testing</span></p><div class="entry-content"><p>I wrote this class:</p><pre><code>using System;
using System.Threading;
using System.Threading.Tasks;

    public interface IJobScheduler {
        void RunDaily(Task task, int hour, int minutes );
    }

    public class JobScheduler : IJobScheduler, IDisposable
    {
        Timer timer;

        /// &lt;summary&gt;
        /// Run the provided task every day at the defined time.
        /// &lt;/summary&gt;
        /// &lt;param name=&#34;task&#34;&gt;Action to execute&lt;/param&gt;
        /// &lt;param name=&#34;hour&#34;&gt;At what time (hour) the task have to be executed. LOCAL time.&lt;/param&gt;
        /// &lt;param name=&#34;minutes&#34;&gt;At what time (minutes) the task have to be executed. LOCAL time.&lt;/param&gt;
        public void RunDaily(Task task, int hour, int minutes)
        {
            var todayRun = DateTime.Today.Add(new TimeSpan(hour, minutes, 0));

            var timeToGo = todayRun &gt; DateTime.Now ?
                (todayRun - DateTime.Now) :          // run today
                todayRun.AddDays(1) - DateTime.Now;  // run tomorrow

            timer = new Timer(x =&gt; { if (isEnabled) task.RunSynchronously(); },
                state: null,
                dueTime: (int)timeToGo.TotalMilliseconds,
                period: 24 * 60 * 60 * 1000 /* 24h */);
        }

        public void Dispose()
        {
            try { timer?.Dispose(); } catch { }
        }
    }
</code></pre><p>Now, this is the initial test I wrote:</p><pre><code>        [Test, Category(&#34;long_test&#34;)]
        public void TaskScheduler_RunDaily__should__execute_at_the_specified_time() {

            // scheduler has a precision of 1 minute so...
            var runAt = DateTime.Now.AddMinutes(1);

            var runCounter = 0;
            Task task = new Task(
                () =&gt; runCounter++
                );

            int hours = runAt.Hour;
            int minutes = runAt.Minute;
            var scheduler = new JobScheduler();
            scheduler.RunDaily(task, hours, minutes);

            // scheduler has a precision of 1 minute so...
            Thread.Sleep(TimeSpan.FromSeconds(60+2));

            runCounter.Should().Be(1);
        }

</code></pre><p>It can be improved to exit as soon as the Task is executed or, introducing <em>seconds</em> as parameter (with default zero) maybe I&#39;ll be able to reduce the test time to 1 or 2 seconds.</p><p>But my real quetion is this:<br /> How can I check that the Scheduler has a Timer set to 24 hours (= it will run the task after 24 hours) ?</p><p>I started thinking to verify the internal Timer&#8230;</p><pre><code>        [Test]
        public void TaskScheduler_RunDaily__should__have_an_internal_timer_et_to_24_hours()
        {
            // scheduler has precision of 1 minute so...
            var runAt = DateTime.Now.AddMinutes(1);

            var runCounter = 0;
            Task task = new Task(
                () =&gt; runCounter++
                );

            int hours = runAt.Hour;
            int minutes = runAt.Minute;
            var scheduler = new JobScheduler();
            scheduler.RunDaily(task, hours, minutes);

            // use reflection to get the check internal Timer
            var timerField = typeof(JobScheduler).GetField(&#34;timer&#34;,
                System.Reflection.BindingFlags.NonPublic | System.Reflection.BindingFlags.Instance);

            if (timerField == null) Assert.Fail(&#34;Cannot read the Timer field&#34;);

            var timer = timerField.As&lt;System.Threading.Timer&gt;();

            // what can I test here ?  
            timer.&lt;internal &#34;enabled&#34;&gt; Should().Be(true);           
            timer.&lt;internal &#34;interval&#34;&gt; Should().Be(24_HOURS);
        }
</code></pre><p>and I think it is ok to use reflection and check some internal implementation of MY code, but it is not acceptable to verify the internal implementation of <em>Timer</em> itself.</p><p>The real behavior to test here is the fact that the task run after 24 hours.<br /> I can think of &#34;expose&#34; that 24 hours so to mock it but I really don&#39;t like the idea: <em><strong>Daily</strong>Run</em> means 24 hours, why should I expose this value as parameter.<br /> The other kind of rule I like to follow is this: &#34;Don&#39;t make the code ugly just because it has to be testable, prefer simplicity.&#34;<br /> To be clear, the <em>RunDaily</em> method is 10 lines of code and it get only the needed input, I don&#39;t want to change it because there is no practical way to unit test it as it is.</p><p>[Update]<br /> It is worth to explain why I&#39;m so reluctant to change a simple implementation with &#8230; something else.<br /> This is the current implementation I found in a project:<br /> <a href="../../../i.stack.imgur.com/bsfr8.png" rel="nofollow noreferrer"><img src="../../../i.stack.imgur.com/bsfr8.png" alt="enter image description here"/></a></p><p>and this is <em>CurrentTimeProvider</em>:</p><pre><code>    public class CurrentDateTimeProvider : ICurrentDateTimeProvider
    {
        public DateTime GetNow()
        {
            return DateTime.Now;
        }
    }
</code></pre><p>and <em>SchedulerTimeProvider</em>:</p><pre><code>    public class SchedulerTimeProvider : ISchedulerTimeProvider
    {
        #region Fields

        private readonly ICurrentDateTimeProvider _currentDateTimeProvider;

        #endregion

        #region Constructor

        public SchedulerTimeProvider(ICurrentDateTimeProvider currentDateTimeProvider)
        {
            _currentDateTimeProvider = currentDateTimeProvider;
        }

        #endregion

        #region Public Methods

        public ISchedulerTimeInfo GetSchedulerTimeInfo(string scheduledTime)
        {
            var defaultSchedulerTime = scheduledTime.Split(&#34;:&#34;);
            var defaultSchedulerHour = int.Parse(defaultSchedulerTime[0]);
            var defaultSchedulerMinute = int.Parse(defaultSchedulerTime[1]);

            TimeSpan due;
            TimeSpan period;


            var now = _currentDateTimeProvider.GetNow();

            DateTime dueDateTime = new DateTime(now.Year, now.Month, now.Day, defaultSchedulerHour,
                defaultSchedulerMinute, 0);


            if (now &gt; dueDateTime)
            {
                var tomorrowsDate = now.AddDays(1);
                var tomorrowsScheduleDateTime = new DateTime(tomorrowsDate.Year, tomorrowsDate.Month, tomorrowsDate.Day, defaultSchedulerHour, defaultSchedulerMinute, 0);
                due = tomorrowsScheduleDateTime.Subtract(now);
                dueDateTime = tomorrowsScheduleDateTime;
            }
            else
            {
                dueDateTime = new DateTime(now.Year, now.Month, now.Day, defaultSchedulerHour, defaultSchedulerMinute,
                    0);
                due = dueDateTime
                    .Subtract(now);
            }


            period = due.Add(new TimeSpan(1, 0, 0, 0));
            //period = due.Add(new TimeSpan(0, 0, 2, 0));


            return new SchedulerTimeInfo(due, period, dueDateTime);
        }

        #endregion

    }
</code></pre><p>(just 2 of the 6 interfaces/classes as example)</p><p>Now, that scheduler is used/started in this way:</p><pre><code>private void StartProcess()
        {
            if (_scheduleTimer == null)
                _scheduleTimer = new Timer(ExecuteExporterProcess);

            var schedulerTimeInfo = _schedulerTimeProvider.GetSchedulerTimeInfo(_config.RegistrationsSchedulerTime);

            var due = schedulerTimeInfo.Due;
            var period = schedulerTimeInfo.Period;

            _scheduleTimer.Change(due, period);
        }
</code></pre><p>The <em>ExecuteExporterProcess</em> method does something and then call again <em>StartProcess</em>.</p><p><strong>I spent some time to understand it</strong> and I wrote my simple implementation.<br /> The current scheduler code is not tested in this solution/project because it is copied from another project and I strongly suspect there are no tests also there (I knew the developer that wrote it).<br /> Also the class that coontains StartProcess is not testd, so the timer itself is not tested at all.<br /> I put my simple implementation in a common package but before making it available to everyone I want to fully test it; because I put the Timer &#34;logic&#34; inside the new implementation I want to test it too.</p><p>As you can see the current implementation is a little bit &#34;verbose&#34; and I think I&#39;m able to introduce some interface to make it testable but less complicated.<br /> But, I hope, you can see WHY I&#39;m reluctant/scared to go on the direction to write so &#34;verbose&#34; code.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>I have dealt with the same problem in the past, and I came up with a solution which on one hand is uncompromising in its perfection, but on the other hand it is, unfortunately, quite a bit involved.</p><p>The solution starts with abstracting everything related to time, timers, tasks, and asynchronous events, and rewriting all of our code to use this abstraction instead of the untestable functionality provided by dotnet out of the box.</p><p>So, we introduce an interface which describes an event-driven system, with its time-query function, and its tick function, and its timer factory function, and what not, and we provide two implementations for it: one which is going to be our fake system that we are going to be using for testing, and one which delegates to the underlying dotnet system, so it reads the true system time, (which should never be used by testing code,) and it creates those <code>System.Threading.Timer</code> objects (which are completely untestable.)</p><p>The idea behind the fake event-driven system is that of course it has a fake notion of time, but more importantly than that, it has a highly non-linear notion of <strong><em>the passage of time</em></strong>. Instead of advancing time at the rate of &#34;real&#34; (wall clock) time, it advances time at the fastest possible rate so as to service the events at the time that they are supposed to happen.</p><p>So, in order to determine at any given moment by how much it should advance the current time, the fake event-driven system looks at all registered timers, sorts them by the order by which the next firing event will be, and picks the one which is going to fire at the earliest time.  The time at which this timer will fire becomes the new &#34;current time&#34;, and the system then proceeds with firing that timer.</p><p>What this means is that you may register a timer to fire in 24 hours from now, and under test conditions it will actually fire immediately, but the time reported by the system at that moment will be as if 24 hours have actually passed, so everything will look normal!</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../unit-testing-how-to-write-unit-test-cases/'>Unit-testing &#8211; How to write unit test cases</a></li><li class="list-group-item"><a href='../unit-testing-how-to-unit-test-an-encoder/'>Unit-testing &#8211; How to unit test an encoder</a></li><li class="list-group-item"><a href='../unit-testing-unit-test-express-controllers/'>Unit-testing &#8211; Unit test express controllers</a></li><li class="list-group-item"><a href='../java-how-to-unit-test-custom-classloader/'>Java &#8211; How to unit test custom ClassLoader</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>