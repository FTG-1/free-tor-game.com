<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="https://free-tor-game.com/wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>Design &#8211; How to handle backpressure in message queue &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.min.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.min.js?ver=11.2.0' id='highlight-js'></script>     <script>( function( w, d, s, l, i ) {
				w[l] = w[l] || [];
				w[l].push( {'gtm.start': new Date().getTime(), event: 'gtm.js'} );
				var f = d.getElementsByTagName( s )[0],
					j = d.createElement( s ), dl = l != 'dataLayer' ? '&l=' + l : '';
				j.async = true;
				j.src = 'https://www.googletagmanager.com/gtm.js?id=' + i + dl;
				f.parentNode.insertBefore( j, f );
			} )( window, document, 'script', 'dataLayer', ' ' );</script>      <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1077200 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="https://free-tor-game.com/3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="https://free-tor-game.com/contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1077200" class="post-1077200 software type-software status-publish hentry category-software tag-aws tag-design tag-serverless"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">Design &#8211; How to handle backpressure in message queue</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">aws</span><span class="mr-2 badge badge-info">design</span><span class="mr-2 badge badge-warning">serverless</span></p><div class="entry-content"><p>I am designing a AWS web service which is going to get 1000 TPS from devices(Android) and it has dependency on multiple downstream services. The usecase is to hit this service periodically from device, get a piece of data and cache it in the device memory. Since device does not require the data immediately, I designed this way</p><pre><code>Device: puts a request in queue (SQS)
Service: polls messages from SQS, process the requests and publish the result to devices via FCM
</code></pre><p>The Problem is service takes at max 2 seconds to process the request and downstream services would not scale as much as service. In short, I can only process fraction of incoming requests per second (Lets say 200 requests, 20% of actual TPS). This leads to backpressure build up in the request queue. Reading through Internet, I found that general strategies to handle backpressure are</p><ol><li>make queue bounded, throttle the producer when it exceeds its size and make producer retry after some delay</li><li>Increase number of consumers. (In this case, This is not an option due to downstream bottleneck)</li></ol><p><strong>Questions:</strong></p><ol><li><p>How throttling helps to solve backpressure problem? If the TPS is consistent, Wouldn&#39;t it create the same problem even when producer retry after delay? At the end some producers will exhaust retries and requests go unprocessed.</p></li><li><p>Initially I wasn&#39;t aware of backpressure and was thinking storing messages in queue will aid asynchronous processing but now I am starting to feel queue is creating more problems than It helps. Is queue even relevant for this usecase ?</p></li><li><p>What are the real benefits of having a queue in front of service?</p></li></ol><p>Appreciate any help!!</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>A good analogy here is to think of a dam on a river.  The river corresponds to the incoming data, and the dam to your consumer.  There are three possibilities at any given point:</p><ol><li>The incoming river&#39;s flow is greater than the dam&#39;s outflow</li><li>The incoming river&#39;s flow is less than the dam&#39;s outflow</li><li>The incoming river&#39;s flow is the same as the dam&#39;s outflow</li></ol><p>In situation 1, a lake grows behind the dam.  This corresponds to your queue.  In scenario 2, the lake shrinks.  In scenario 3, the lake&#39;s volume doesn&#39;t change.  A big part of why we have dams is to make the downstream flow more consistent.  That is, when there&#39;s a heavy rain, the lake will get larger but the flow out can be limited.  When there is a drought, the lake&#39;s reserves are drawn down to keep the outflow higher than it would be otherwise.</p><p>So the volume of the lake is equivalent to the total inflow minus the outflow.  There is a limit, however, to the amount of water the lake can hold.  When the lake is full, you either need to release more water or somehow divert the incoming water.</p><p>This corresponds to the iron law of queuing: the depth of the queue is the number of messages received minus the number of messages processed (or removed.)  There&#39;s no magic.  If you don&#39;t, on average, pull as many messages as you are putting on the queue, it will grow and eventually hit some sort of size limitation.  Queues don&#39;t allow you to process more messages; they act as a buffer to help even out the flow and prevent failures when the incoming volume spikes.  They also help with distributing the messages to multiple consumers efficiently.  Alternately, they can be used as a &#39;holding area&#39; for batch processing as noted by &#39;supercat&#39; in the comments.  But the law still holds: your overall processing rate must accommodate the incoming rate or your queue will grow.</p><p>The upshot: to resolve this issue, you need to either send less to the queue or process them faster.  There is no other solution.  Backpressure is actually a good thing in a lot of scenarios.  It allows the producers to know when the queue is filling up so they can react.</p><p>It sounds to me that your issue is the &#39;downstream bottleneck&#39;.  You will never be able to process the volumes that you have coming in until you resolve that.  A queue will simply delay how long it takes until you can no longer accept the incoming data.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='https://free-tor-game.com/software/c-designing-a-scalable-and-robust-retry-mechanism/'>C# &#8211; Designing a scalable and robust retry mechanism</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/messaging-between-microservices-on-aws/'>Messaging between microservices on AWS</a></li><li class="list-group-item"><a href='https://free-tor-game.com/software/python-how-to-create-a-python-microservice-on-aws-that-both-accepts-rest-connections-and-processes-sqs-messages/'>Python &#8211; How to create a Python microservice on AWS that both accepts REST connections and processes SQS messages</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='http://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="https://free-tor-game.com/wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>