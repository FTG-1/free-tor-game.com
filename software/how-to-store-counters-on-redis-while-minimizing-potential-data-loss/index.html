<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>How to store counters on Redis while minimizing potential data loss &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1083978 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1083978" class="post-1083978 software type-software status-publish hentry category-software tag-caching tag-redis"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">How to store counters on Redis while minimizing potential data loss</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">caching</span><span class="mr-2 badge badge-info">redis</span></p><div class="entry-content"><p>The application I&#39;m working on has a need to create a counter representing the number of times each piece of content has been viewed.</p><p>There are two goals here:</p><ol><li>Update the counter in real time</li><li>Minimize load on MySQL</li></ol><p>Currently what we do, is make a cache key in Redis for each piece of content that contains the view count. When a view event happens, we increment the view count. If there is no value yet at the key when a read or write happens, we calculate the all-time views count using a separate data source (Influxdb).</p><p>The problem is, our existing approach won&#39;t&#39; be feasible anymore because of the way we&#39;re restructuring our InfluxDB data. It is no longer adequately performant to calculate the all time views count for a card using Influx data, for reasons I won&#39;t get into here (feel free to ask).</p><p>Essentially, we no longer have a way to calculate the all time views count &#39;from scratch&#39;. We will need to rely on the existing counter values and only increment them (never completely re-calculate them).</p><p>I have the following idea to do this:</p><ol><li>Calculate all-time views on each content and store in MySQL (this can be done once to seed the data)</li><li>When a read/write happens for the first time, look it up in MySQL and store it in Redis</li><li>Whenever a write happens, increment the count on Redis</li><li>In a background job, once per hour or so, update the views count in the MySQL database using the data in Redis.</li></ol><p>This will produce at maximum one hour of data loss, if Redis drops all the keys one minute 59 right before the background job happens.</p><p>Does this approach make sense? If there a better way to do it?</p><p><strong>edit</strong></p><p>Now that I think about it a little more, the concept of a background job that updates all the cards is a little problematic. If we have millions keys stored in the cache, how should the application know which had activity and should have their Redis counts copied to MySQL?</p><p>So, I&#39;m thinking that there can be a special key on Redis which stores a queue of all the card ids that have had updates. Then the background job can see the unqiue card ids in this list, and request only that data for the update.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>One technique that can be helpful is to use probabilistic techniques instead of fixed schedules. Whenever a process updates the cache they can roll the dice to determine whether that key (or a range of keys) should be synced. If you make the syncing probability dependent on the rate of writes to each key (like p=1/n for n recent modifications) that can help you maintain a consistent syncing rate across all keys. In contrast, a fixed schedule could lead to load spikes to your databases, or could be mismatched with the rate of change (such as syncing keys that have not changed). The difficult part for this solution is keeping track of the rate of modifications.</p><p>You may also want to evict unused keys from the cache. You can perhaps subscribe to eviction events so that you can persist them before they are removed.</p><p>It might also be worth considering whether trying to synchronize two databases is a sensible solution (in particular, whether your performance requirements warrant all this complexity). Alternatives:</p><ul><li>You might want to use a persistent key-value store just for these counters, not within you main database. Redis itself can do that, with some restrictions. However, separating your data will make some queries more complicated, e.g. sorting by counter value.</li><li>The likely simplest solution would be to scale your primary database so that it can handle the load directly, possibly using a cache to soften the read load.</li><li>In order to reduce the write load of high-rate events it may be sufficient to hold and aggregate these events in a short queue. The queue is regularly committed as a batch update (e.g. every 1s). If multiple changes to the same counter arrive within a sampling window, they can be combined. This is similar to your idea of a cache, but since the queue only holds items that have been modified, it is not necessary to scan a huge keyspace during syncing. A disadvantage is that this queue becomes a single point of failure.</li></ul><p>Of course, aspects of these solutions can be combined as necessary. I&#39;d consider a cache that is written to as in your question, but route all persistent writes through a queue that can coalesce the writes. E.g. some event would update both the queue and the cache, but there would be no service that scans the cache for keys that have to be updated.</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../database-whats-the-best-way-to-cache-a-growing-database-table-for-html-generation/'>Database &#8211; What&#8217;s the best way to cache a growing database table for html generation</a></li><li class="list-group-item"><a href='../architecture-using-memcached-is-it-good-practice-to-update-the-cache-when-updating-the-database/'>Architecture &#8211; Using Memcached: is it good practice to update the cache when updating the database</a></li><li class="list-group-item"><a href='../cache-concurrency-ensuring-latest-version-in-cache/'>Cache concurrency: ensuring latest version in cache</a></li><li class="list-group-item"><a href='../redis-strategy-for-cache-item-dependency/'>Redis strategy for cache item dependency</a></li><li class="list-group-item"><a href='../design-redis-write-through-cache-vs-write-behind-cache-message-queue/'>Design &#8211; Redis write-through cache vs write-behind cache (message queue?)</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>