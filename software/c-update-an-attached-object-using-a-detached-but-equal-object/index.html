<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>C# &#8211;  update an attached object using a detached but equal object &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1064736 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1064736" class="post-1064736 software type-software status-publish hentry category-software tag-c tag-entity-framework"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">C# &#8211;  update an attached object using a detached but equal object</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">c</span><span class="mr-2 badge badge-info">entity-framework</span></p><div class="entry-content"><p>I retrieve movie data from an external API. In a first phase I will scrape each movie and insert it into my own database. In a second phase I will periodically update my database by using the API&#39;s &#34;Changes&#34; API which I can query to see what movies have had their information changed.</p><p>My ORM layer is Entity-Framework. The Movie class looks like this:</p><pre><code>class Movie
{
    public virtual ICollection&lt;Language&gt; SpokenLanguages { get; set; }
    public virtual ICollection&lt;Genre&gt; Genres { get; set; }
    public virtual ICollection&lt;Keyword&gt; Keywords { get; set; }
}
</code></pre><p>The problem arises when I have a movie that needs to be updated: my database will think of the object being tracked and the new one that I receive from the update API call as different objects, disregarding <code>.Equals()</code>.</p><p>This causes a problem because when I now try to update the database with the updated movie, it will insert it instead of updating the existing Movie.</p><p><a href="https://stackoverflow.com/a/28563960/1864167">I had this issue before</a> with the languages and my solution was to search for the attached language objects, detach them from the context, move their PK to the updated object and attach that to the context. When <code>SaveChanges()</code> is now executed, it will essentially replace it.</p><p>This is a rather smelly approach because if I continue this approach to my <code>Movie</code> object, it means I&#39;ll have to detach the movie, the languages, the genres and the keywords, look up each one in the database, transfer their IDs and insert the new objects.</p><p>Is there a way to do this more elegantly? Ideally I just want to pass in the updated movie to the context and have that select the correct movie to update based on the <code>Equals()</code> method, update all its fields and for each complex object: use the existing record again based on its own <code>Equals()</code> method and insert if it doesn&#39;t exist yet.</p><p>I can skip the detaching/attaching by providing <code>.Update()</code> methods on each complex object which I can use in combination of retrieving all the attached objects but this will still require me to retrieve every single existing object to then update it.</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>I didn&#39;t find what I was hoping for but I did find an improvement over the existing select-detach-update-attach sequence.</p><p>The extension method <a href="https://msdn.microsoft.com/en-us/library/system.data.entity.migrations.idbsetextensions.addorupdate(v=vs.103).aspx" rel="noreferrer"><code>AddOrUpdate(this DbSet)</code></a> allows you to do exactly what I want to do: Insert if it&#39;s not there and update if it found an existing value. I didn&#39;t realize using this sooner since I&#39;ve really only seen it be used in the <code>seed()</code> method in combination with Migrations. If there is any reason I shouldn&#39;t use this, let me know.</p><p>Something useful to note: There is an overload available which allows you to specifically select how equality should be determined. Here I could have used my <code>TMDbId</code> but I instead opted to simply disregard my own ID altogether and instead use a PK on TMDbId combined with <code>DatabaseGeneratedOption.None</code>. I use this approach on each subcollection as well, where appropriate.</p><p>Interesting part of <a href="https://entityframework.codeplex.com/SourceControl/latest#src/EntityFramework/Migrations/DbSetMigrationsExtensions.cs" rel="noreferrer">the source</a>:</p><pre><code>internalSet.InternalContext.Owner.Entry(existing).CurrentValues.SetValues(entity);
</code></pre><p>which is how the data is actually updated under the hood.</p><p>All that is left is calling <code>AddOrUpdate</code> on each object that I want to be affected by this:</p><pre><code>public void InsertOrUpdate(Movie movie)
{
    _context.Movies.AddOrUpdate(movie);
    _context.Languages.AddOrUpdate(movie.SpokenLanguages.ToArray());
    // Other objects/collections
    _context.SaveChanges();
}
</code></pre><p>It isn&#39;t as clean as I hoped since I have to manually specify each piece of my object that needs to be updated but it&#39;s about as close as it will get.</p><p>Related reading: <a href="https://stackoverflow.com/questions/15336248/entity-framework-5-updating-a-record">https://stackoverflow.com/questions/15336248/entity-framework-5-updating-a-record</a></p><hr/><p>Update:</p><p>It turns out my tests weren&#39;t rigorous enough. After using this technique I noticed that while the new language was added, it wasn&#39;t connected to the movie. in the many-to-many table. This is <a href="https://entityframework.codeplex.com/workitem/2128" rel="noreferrer">a known but seemingly low-priority issue</a> and hasn&#39;t been fixed as far as I know.</p><p>In the end I decided to go for the approach where I have <code>Update(T)</code> methods on each type and follow this sequence of events:</p><ul><li>Loop over collections in new object</li><li>For each entry in each collection, look it up in the database</li><li>If it exists, use the <code>Update()</code> method to update it with the new values</li><li>If it doesn&#39;t exist, add it to the appropriate DbSet</li><li>Return the attached objects and replace the collections in the root object with the collections of the attached objects</li><li>Find and update the root object</li></ul><p>It&#39;s a lot of manual work and it&#39;s ugly so it&#39;ll go through a few more refactorings but now my tests indicate it should work for more rigorous scenarios.</p><hr/><p>After cleaning it up further I now use this method:</p><pre><code>private IEnumerable&lt;T&gt; InsertOrUpdate&lt;T, TKey&gt;(IEnumerable&lt;T&gt; entities, Func&lt;T, TKey&gt; idExpression) where T : class
{
    foreach (var entity in entities)
    {
        var existingEntity = _context.Set&lt;T&gt;().Find(idExpression(entity));
        if (existingEntity != null)
        {
            _context.Entry(existingEntity).CurrentValues.SetValues(entity);
            yield return existingEntity;
        }
        else
        {
            _context.Set&lt;T&gt;().Add(entity);
            yield return entity;
        }
    }
    _context.SaveChanges();
}
</code></pre><p>This allows me to call it like this and insert/update the underlying collections:</p><pre><code>movie.Genres = new List&lt;Genre&gt;(InsertOrUpdate(movie.Genres, x =&gt; x.TmdbId));
</code></pre><p>Notice how I reassign the retrieved value to the original root object: now it is connected to each attached object. Updating the root object (the movie) is done the same way:</p><pre><code>var localMovie = _context.Movies.SingleOrDefault(x =&gt; x.TmdbId == movie.TmdbId);
if (localMovie == null)
{
    _context.Movies.Add(movie);
} 
else
{
    _context.Entry(localMovie).CurrentValues.SetValues(movie);
}
</code></pre></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../c-how-far-should-an-entity-take-care-of-its-properties-values-by-itself/'>C# &#8211; How far should an entity take care of its properties values by itself</a></li><li class="list-group-item"><a href='../c-entity-framework-and-distributed-systems/'>C# &#8211; Entity Framework and distributed Systems</a></li><li class="list-group-item"><a href='../what-are-the-disconnected-scenarios-in-entity-framework/'>What are the disconnected scenarios in Entity Framework</a></li><li class="list-group-item"><a href='../c-force-derived-class-to-implement-static-method-c/'>C# &#8211; Force Derived Class to Implement Static Method C#</a></li><li class="list-group-item"><a href='../c-implementing-unit-of-work-for-multiple-storage-types/'>C# &#8211; Implementing unit-of-work for multiple storage types</a></li><li class="list-group-item"><a href='../c-updating-sub-properties-via-entity-framework/'>C# &#8211; Updating sub-properties via Entity Framework</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>