<!doctype html><html lang="en-US"><!--  --><meta http-equiv="content-type" content="text/html;charset=UTF-8" /><!-- / -->
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1">  <link media="all" href="../../wp-content/cache/autoptimize/4/css/autoptimize_dc56928889f08ceb40a4520f8ece953b.css" rel="stylesheet" /><title>C API in C++ with RAII, two alternatives to implement error handling (Exceptions) &#8211; free-tor-game.com</title> <script>MathJax = {
  tex: {
    inlineMath: [['$','$'],['\\(','\\)']], 
    processEscapes: true
  },
  options: {
    ignoreHtmlClass: 'tex2jax_ignore|editor-rich-text'
  }
};</script> <link rel='dns-prefetch' href='http://cdn.jsdelivr.net/' /><link rel='dns-prefetch' href='http://cdnjs.cloudflare.com/' /><link rel='dns-prefetch' href='http://stackpath.bootstrapcdn.com/' /><link rel='dns-prefetch' href='http://s.w.org/' /><link rel='stylesheet' id='highlight-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/styles/vs2015.min40df.css?ver=5.6' type='text/css' media='all' /><link rel='stylesheet' id='bootstrap-css'  href='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.1.3/css/bootstrap.mina352.css?ver=4.1.3' type='text/css' media='all' /><link rel='stylesheet' id='icons-css'  href='../../../stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min40df.css?ver=5.6' type='text/css' media='all' /> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.minb8ff.js?ver=1.12.4' id='jquery-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/highlight.js/11.2.0/highlight.minc9a3.js?ver=11.2.0' id='highlight-js'></script>            <script>hljs.highlightAll();</script> <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1731162805004860" crossorigin="anonymous"></script></head><body class="software-template-default single single-software postid-1084124 no-sidebar"><div id="page" class="site"> <a class="skip-link screen-reader-text" href="#content">Skip to content</a><header id="topnav" class="sticky-top"><nav class="navbar navbar-expand-md navbar-light bg-light" role="navigation"> <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-primary" aria-controls="navbar-primary" aria-expanded="false" aria-label="Toggle navigation"> <span class="navbar-toggler-icon"></span> </button> <a class="navbar-brand" href="#">free-tor-game.com</a><div id="navbar-primary" class="collapse navbar-collapse"><ul id="menu-primary-top-menu" class="nav navbar-nav"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-192" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children dropdown menu-item-192 nav-item"><a title="Tools" href="#" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" class="dropdown-toggle nav-link" id="menu-item-dropdown-192">Tools</a><ul class="dropdown-menu" aria-labelledby="menu-item-dropdown-192" role="menu"><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-193" class="menu-item menu-item-type-post_type menu-item-object-post menu-item-193 nav-item"><a title="ARFCN-Frequency Converter" href="../../3gpp-arfcn-frequency-converter/" class="dropdown-item">ARFCN-Frequency Converter</a></li></ul></li><li itemscope="itemscope" itemtype="https://www.schema.org/SiteNavigationElement" id="menu-item-2301" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-2301 nav-item"><a title="Contact Us" href="../../contact/" class="nav-link">Contact Us</a></li></ul></div></nav></header><div id="content" class="site-content"><div id="primary" class="content-area"><main id="main" class="site-main"><div id="main-container" class="container"><div id="main-row" class="row"><div id="main-col" class="col-12"><article id="post-1084124" class="post-1084124 software type-software status-publish hentry category-software tag-api-design tag-c tag-c11 tag-exceptions tag-raii"><div class="row"><div class="col-12 col-md-8"><header class="entry-header"><h1 class="entry-title text-danger">C API in C++ with RAII, two alternatives to implement error handling (Exceptions)</h1></header><p style='font-size:1.2em'><span class="mr-2 badge badge-success">api-design</span><span class="mr-2 badge badge-info">c</span><span class="mr-2 badge badge-warning">c++11</span><span class="mr-2 badge badge-primary">exceptions</span><span class="mr-2 badge badge-danger">raii</span></p><div class="entry-content"><p>I have an API written in C, which produces a result by returning a pointer to allocated memory.<br /> For using it with C++ (C++11) I&#39;ve wrapped the function calls in objects, which keep the result in a <code>std::shared_ptr</code>. So far so good.</p><p>However, the C library features <em>two</em> functions for every operation. One produces possibly an error, the other never. Let&#39;s call them<br /> <code>some_pod * do_it_with_error(Parameter ..., Error **)</code><br /> and<br /> <code>some_pod * do_it_without_error(Parameter ...)</code></p><p>I can pass in the address of an <code>Error *</code> pointer to the first function and if there&#39;s an error it won&#39;t be <code>NULL</code> afterwards.</p><p>For solving this I thought of two different implementations.<br /> First, I could SFINAE for choosing between the <code>with_error</code> and <code>without_error</code> functions, like so:</p><pre><code>template&lt;typename NoThrow = void&gt;
struct do_it {
  public:
    void operator()(...)
    {
      Error * error = NULL;
      m_result = std::shared_ptr&lt;some_pod&gt;(do_it_with_error(..., &amp;error));
      if (error) {
        throw(MyExceptionWithError(error));
      }
    }
  private:
    std::shared_ptr&lt;some_pod&gt; m_result;
};

template&lt;&gt;
class do_it&lt;std::nothrow_t&gt; {
  public:
    void operator()(...) noexcept
    {
      if (! m_result) {
        m_result = std::shared_ptr&lt;some_pod&gt;(do_it_without_error(...));
      }
    }
  private:
    std::shared_ptr&lt;some_pod&gt; m_result;
};
</code></pre><p>Usage:</p><pre><code>do_it&lt;&gt; di_error;
try {
  di_error(...); // might throw
} catch (...) {}

do_it&lt;std::nothrow_t&gt; di_no_error;
di_no_error(...); // won&#39;t throw for sure
</code></pre><p>However, since the result is wrapped in a <code>std::shared_ptr</code> there will also be<br /> a <code>get()</code> method:</p><pre><code>const std::shared_ptr&lt;some_pod&gt; &amp; get(void) { return m_result; }
</code></pre><p>For error checking I could just implement a another method <code>check</code>.<br /> The default implementation would now look like this:</p><pre><code>struct do_it {
  public:
    // will never throw
    const std::shared_ptr&lt;some_pod&gt; &amp;
    get(void) noexcept
    {
      if (! m_result) {
        m_result = std::shared_ptr&lt;some_pod&gt;(do_it_without_error(...));
      }
      return m_result;
    }

    // might throw
    do_it &amp;
    check(void)
    {
      if (! m_result) {
        Error * error = NULL;
        m_result = std::shared_ptr&lt;some_pod&gt;(do_it_with_error(..., &amp;error));
        if (error) {
          throw ...;
        }
      }
      return *this;
    }

  private:
    std::shared_ptr&lt;some_pod&gt; m_result;
};
</code></pre><p>Usage:</p><pre><code>do_it di_error;
try {
  auto result = di_error.check().get();
} catch (...) {}
do_it di_no_error;
di_no_error.get();
</code></pre><p>So, both implementations seem to be equally good (or bad) to me.<br /> How could I decide which one to use.<br /> What are the Pros and Cons?</p></div>     <div id="comments" class="comments-area"><div class="row"><div class="col-12"><div class="mt-3 border-bottom border-success"><h4 class="text-success"><i class='fa fa-check-circle text-success mr-3'></i><span>Best Answer</span></h4></div><div class='bg-transparent mb-3'><p>Too complicated - wrap them both as if either could throw an error, that the 2nd fn will never throw only means the compiler will never have to call the error handling routines (and might even optimise it out entirely) - either way your code will perform just as well thanks to C++s design.</p><p>Your code will also be much easier to understand, even with this redundant error handling (that one day might be used for other, unexpected errors)</p></div></div><div class="col-4"></div></div></div></div><div class="col-12 col-md-4"> <ins class="adsbygoogle"
 style="display:block"
 data-ad-client="ca-pub-1731162805004860"
 data-ad-slot="1340983829"
 data-ad-format="auto"
 data-full-width-responsive="true"></ins>   <div class='mt-3 ml-4 border-bottom border-success'><h6><span>Related Question</span></h6></div><ul class='list-group list-group-flush'><li class="list-group-item"><a href='../exceptions-or-error-codes/'>Exceptions or Error codes</a></li><li class="list-group-item"><a href='../java-why-cant-java-c-implement-raii/'>Java &#8211; Why can&#8217;t Java/C# implement RAII</a></li><li class="list-group-item"><a href='../c-is-the-raii-wrapper-a-good-idea-for-this-c-transactions-api-or-should-i-stick-to-the-c-style/'>C++ &#8211; Is the RAII wrapper a good idea for this C transactions API or should I stick to the C style</a></li><li class="list-group-item"><a href='../c-error-handling-considerations/'>C++ &#8211; Error handling considerations</a></li></ul></div></div><footer class="entry-footer"></footer></article></div></div></div></main></div></div><footer id="colophon" class="site-footer"><div class="site-info"></div></footer></div>    <script type='text/javascript' src='../../../cdn.jsdelivr.net/npm/mathjax%403/es5/tex-chtml40df.js?ver=5.6' id='mathjax-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/esm/popper.min43d3.js?ver=1.14.7' id='popper-js'></script> <script type='text/javascript' src='../../../cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min5b31.js?ver=4.3.1' id='bootstrap4-js'></script> <script type='text/javascript' id='itectec-common-js-extra'>var globalObject = {"homeUrl":"https:\/\/free-tor-game.com\/"};</script> <script defer src="../../wp-content/cache/autoptimize/4/js/autoptimize_63b39f43631847816e6b0e70ea726624.js"></script></body></html>